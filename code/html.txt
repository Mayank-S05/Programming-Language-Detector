<div class="muck-up">
  <div class="overlay"></div>
  <div class="top">
    <div class="nav">
      <span class="ion-android-menu"></span>
      <p>Timeline</p>
      <span class="ion-ios-more-outline"></span>
    </div>
    <div class="user-profile">
      <img src="https://raw.githubusercontent.com/arjunamgain/FilterMenu/master/images/profile.jpg">
      <div class="user-details">
        <h4>Arjun Amgain</h4>
        <p>Web/Front-end Designer</p>
      </div>
    </div>
  </div>
  <div class="clearfix"></div>
  <div class="filter-btn">
    <a id="one" href="#"><i class="ion-ios-checkmark-outline"></i></a>
    <a id="two" href="#"><i class="ion-ios-alarm-outline"></i></a>
    <a id="three" href="#"><i class="ion-ios-heart-outline"></i></a>
    <a id="all" href="#"><i class="ion-ios-star-outline"></i></a>
    <span class="toggle-btn ion-android-funnel"></span>
  </div>
  <div class="clearfix"></div>
  <div class="bottom">
    <div class="title">
      <h3>My Tasks</h3>
      <small>February 8,2015</small>
    </div>
    <ul class="tasks">
      <li class="one red">
        <span class="task-title">Make New Icon</span>
        <span class="task-time">5pm</span>
        <span class="task-cat">Web App</span>

      </li>
      <li class="one red">
        <span class="task-title">Catch up with Brian</span>
        <span class="task-time">3pm</span>
        <span class="task-cat">Mobile Project</span>

      </li>
      <li class="two green">
        <span class="task-title">Design Explorations</span>
        <span class="task-time">2pm</span>
        <span class="task-cat">Company Web site</span>

      </li>
      </li>
      <li class="tow green hang">
        <span class="task-title">Team Meeting</span>
        <span class="task-time">2pm</span>
        <span class="task-cat">Hangouts</span>
        <img src="https://raw.githubusercontent.com/arjunamgain/FilterMenu/master/images/2.jpg">
        <img src="https://raw.githubusercontent.com/arjunamgain/FilterMenu/master/images/3.jpg">
        <img src="https://raw.githubusercontent.com/arjunamgain/FilterMenu/master/images/profile.jpg">
      </li>
      <li class="three yellow">
        <span class="task-title">New Projects</span>
        <span class="task-time">2pm</span>
        <span class="task-cat">Starting</span>


      </li>

      <li class="three yellow">
        <span class="task-title">Lunch with Mary</span>
        <span class="task-time">2pm</span>
        <span class="task-cat">Grill House</span>
      </li>
      <li class="three yellow">
        <span class="task-title">Team Meeting</span>
        <span class="task-time">2pm</span>
        <span class="task-cat">Hangouts</span>
      </li>

    </ul>
  </div>
</div>
<!DOCTYPE html>
<html lang="en" class="no-js">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rain Effect Experiments | Demo 1 | Codrops</title>
  <meta name="description" content="Some WebGL experiments with raindrop effects" />
  <meta name="keywords" content="webgl, raindrops, effect, rain, web, video, background" />
  <meta name="author" content="Lucas Bebber for Codrops" />
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="stylesheet" type="text/css" href="css/normalize.css" />
  <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,700,500,900' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="css/demo.css" />
  <link rel="stylesheet" type="text/css" href="css/style1.css" />
  <!--[if IE]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

<body class="demo-1">
  <div class="image-preload">
    <img src="img/drop-color.png" alt="">
    <img src="img/drop-alpha.png" alt="">
    <img src="img/weather/texture-rain-fg.png" />
    <img src="img/weather/texture-rain-bg.png" />
    <img src="img/weather/texture-sun-fg.png" />
    <img src="img/weather/texture-sun-bg.png" />
    <img src="img/weather/texture-fallout-fg.png" />
    <img src="img/weather/texture-fallout-bg.png" />
    <img src="img/weather/texture-drizzle-fg.png" />
    <img src="img/weather/texture-drizzle-bg.png" />
  </div>
  <div class="container">
    <header class="codrops-header">
      <div class="codrops-links">
        <a class="codrops-icon codrops-icon--prev" href="http://tympanus.net/Development/CardStackEffects/" title="Previous Demo"><span>Previous Demo</span></a>
        <a class="codrops-icon codrops-icon--drop" href="http://tympanus.net/codrops/?p=25417" title="Back to the article"><span>Back to the Codrops article</span></a>
      </div>
      <h1>Rain &amp; Water Effects</h1>
      <nav class="codrops-demos">
        <a class="current-demo" href="index.html">Weather</a>
        <a href="index2.html">Water</a>
        <a href="index3.html">Video</a>
      </nav>
    </header>
    <div class="slideshow">
      <canvas width="1" height="1" id="container" style="position:absolute"></canvas>
      <!-- Heavy Rain -->
      <div class="slide" id="slide-1" data-weather="rain">
        <div class="slide__element slide__element--date">Sunday, 24<sup>th</sup> of October 2043</div>
        <div class="slide__element slide__element--temp">12°<small>C</small></div>
      </div>
      <!-- Drizzle -->
      <div class="slide" id="slide-2" data-weather="drizzle">
        <div class="slide__element slide__element--date">Saturday, 25<sup>th</sup> of October 2043</div>
        <div class="slide__element slide__element--temp">18°<small>C</small></div>
      </div>
      <!-- Sunny -->
      <div class="slide" id="slide-3" data-weather="sunny">
        <div class="slide__element slide__element--date">Monday, 26<sup>th</sup> of October 2043</div>
        <div class="slide__element slide__element--temp">25°<small>C</small></div>
      </div>
      <!-- Heavy rain -->
      <div class="slide" id="slide-5" data-weather="storm">
        <div class="slide__element slide__element--date">Wednesday, 28<sup>th</sup> of October 2043</div>
        <div class="slide__element slide__element--temp">20°<small>C</small></div>
      </div>
      <!-- Fallout (greenish overlay with slightly greenish/yellowish drops) -->
      <div class="slide" id="slide-4" data-weather="fallout">
        <div class="slide__element slide__element--date">Tuesday, 27<sup>th</sup> of October 2043</div>
        <div class="slide__element slide__element--temp">34°<small>C</small></div>
      </div>
      <nav class="slideshow__nav">
        <a class="nav-item" href="#slide-1"><i class="icon icon--rainy"></i><span>10/24</span></a>
        <a class="nav-item" href="#slide-2"><i class="icon icon--drizzle"></i><span>10/25</span></a>
        <a class="nav-item" href="#slide-3"><i class="icon icon--sun"></i><span>10/26</span></a>
        <a class="nav-item" href="#slide-5"><i class="icon icon--storm"></i><span>10/28</span></a>
        <a class="nav-item" href="#slide-4"><i class="icon icon--radioactive"></i><span>10/27</span></a>
      </nav>
    </div>
    <p class="nosupport">Sorry, but your browser does not support WebGL!</p>
  </div>
  <!-- /container -->
  <script src="js/index.min.js"></script>
</body>

</html>
<!DOCTYPE html>
<html lang="en" class="no-js">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rain Effect Experiments | Demo 2 | Codrops</title>
  <meta name="description" content="Some WebGL experiments with raindrop effects" />
  <meta name="keywords" content="webgl, raindrops, effect, rain, web, video, background" />
  <meta name="author" content="Lucas Bebber for Codrops" />
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="stylesheet" type="text/css" href="css/normalize.css" />
  <link rel="stylesheet" type="text/css" href="css/demo.css" />
  <link rel="stylesheet" type="text/css" href="css/style2.css" />
  <!--[if IE]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

<body class="demo-2">
  <div class="container">
    <header class="codrops-header">
      <div class="codrops-links">
        <a class="codrops-icon codrops-icon--prev" href="http://tympanus.net/Development/CardStackEffects/" title="Previous Demo"><span>Previous Demo</span></a>
        <a class="codrops-icon codrops-icon--drop" href="http://tympanus.net/codrops/?p=25417" title="Back to the article"><span>Back to the Codrops article</span></a>
      </div>
      <h1>Rain &amp; Water Effects</h1>
      <nav class="codrops-demos">
        <a href="index.html">Weather</a>
        <a class="current-demo" href="index2.html">Water</a>
        <a href="index3.html">Video</a>
      </nav>
      <p class="info">Based on the <a href="https://dribbble.com/shots/2257687-Water-introduction-mobile-Experiment">Dribbble shot</a> by Bilal</p>
    </header>
    <div class="content">
      <img class="device" src="img/iphone.svg" alt="iPhone" />
      <div class="app">
        <canvas id="container" width="261" height="463" style="position:absolute;top:0;left:0;width:100%;height:100%"></canvas>
        <div class="app-content">
          <button class="app__button-menu"><i class="fa fa-navicon"></i></button>
          <h2 class="app__title">water</h2>
          <p class="app__info">The wettest thing on planet Earth.</p>
          <button class="app__button">Learn more</button>
          <p class="app__info app__info--small">I'm not thirsty</p>
        </div>
      </div>
    </div>
    <p class="nosupport">Sorry, but your browser does not support WebGL!</p>
  </div>
  <!-- /container -->
  <script src="js/index2.min.js"></script>
</body>

</html>
<!DOCTYPE html>
<html lang="en" class="no-js">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rain Effect Experiments | Demo 3 | Codrops</title>
  <meta name="description" content="Some WebGL experiments with raindrop effects" />
  <meta name="keywords" content="webgl, raindrops, effect, rain, web, video, background" />
  <meta name="author" content="Lucas Bebber for Codrops" />
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="stylesheet" type="text/css" href="css/normalize.css" />
  <link rel="stylesheet" type="text/css" href="css/demo.css" />
  <link rel="stylesheet" type="text/css" href="css/style3.css" />
  <!--[if IE]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

<body class="demo-3">
  <video class="videobg" src="media/video.mp4" poster="media/video.jpg" autoplay loop muted>
    <source src="media/video.webm" type="video/web">
    <source src="media/video.mp4" type="video/mp4">
  </video>
  <canvas id="container" width="1" height="1" style="position:absolute"></canvas>
  <div class="container">
    <header class="codrops-header">
      <div class="codrops-links">
        <a class="codrops-icon codrops-icon--prev" href="http://tympanus.net/Development/CardStackEffects/" title="Previous Demo"><span>Previous Demo</span></a>
        <a class="codrops-icon codrops-icon--drop" href="http://tympanus.net/codrops/?p=25417" title="Back to the article"><span>Back to the Codrops article</span></a>
      </div>
      <h1>Rain &amp; Water Effects</h1>
      <nav class="codrops-demos">
        <a href="index.html">Weather</a>
        <a href="index2.html">Water</a>
        <a class="current-demo" href="index3.html">Video</a>
      </nav>
    </header>
    <img class="logo-img" src="img/logo.svg" alt="logo" />
    <p class="nosupport">Sorry, but your browser does not support WebGL!</p>
  </div>
  <!-- /container -->
  <script src="js/index3.min.js"></script>
</body>

</html>
<h1>Gooey Menu</h1>
<h2>Using CSS and SVG Filters</h2>
<h3>By <a href="https://codepen.io/lbebber">Lucas Bebber</a></h3>
<h4><a href="https://codepen.io/lbebber/pen/LELBEo" target="_blank">Version 1</a> - <a href="https://codepen.io/lbebber/pen/RNgBPP" target="_blank">Version 2</a> - <a href="https://codepen.io/lbebber/pen/pvwZJp" target="_blank">Version 3</a> - Version 4</h4>
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

<nav class="menu">
  <input type="checkbox" href="#" class="menu-open" name="menu-open" id="menu-open"/>
  <label class="menu-open-button" for="menu-open">
    <span class="hamburger hamburger-1"></span>
    <span class="hamburger hamburger-2"></span>
    <span class="hamburger hamburger-3"></span>
  </label>
  
  <a href="#" class="menu-item"> <i class="fa fa-bar-chart"></i> </a>
  <a href="#" class="menu-item"> <i class="fa fa-plus"></i> </a>
  <a href="#" class="menu-item"> <i class="fa fa-heart"></i> </a>
  <a href="#" class="menu-item"> <i class="fa fa-envelope"></i> </a>
  
  
</nav>


<!-- filters -->
<svg xmlns="http://www.w3.org/2000/svg" version="1.1">
    <defs>
      <filter id="shadowed-goo">
          
          <feGaussianBlur in="SourceGraphic" result="blur" stdDeviation="10" />
          <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="goo" />
          <feGaussianBlur in="goo" stdDeviation="3" result="shadow" />
          <feColorMatrix in="shadow" mode="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 1 -0.2" result="shadow" />
          <feOffset in="shadow" dx="1" dy="1" result="shadow" />
          <feComposite in2="shadow" in="goo" result="goo" />
          <feComposite in2="goo" in="SourceGraphic" result="mix" />
      </filter>
      <filter id="goo">
          <feGaussianBlur in="SourceGraphic" result="blur" stdDeviation="10" />
          <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="goo" />
          <feComposite in2="goo" in="SourceGraphic" result="mix" />
      </filter>
    </defs>
</svg>
<h1>Gooey Menu</h1>
<h2>Using CSS and SVG Filters</h2>
<h3>By <a href="https://codepen.io/lbebber">Lucas Bebber</a></h3>
<h4><a href="https://codepen.io/lbebber/pen/LELBEo" target="_blank">Version 1</a> - Version 2 - <a href="https://codepen.io/lbebber/pen/pvwZJp" target="_blank">Version 3</a> - <a href="https://codepen.io/lbebber/pen/rawQKR" target="_blank">Version 4</a></h4>
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

<nav class="menu">
  <input type="checkbox" href="#" class="menu-open" name="menu-open" id="menu-open"/>
  <label class="menu-open-button" for="menu-open">
    <span class="hamburger hamburger-1"></span>
    <span class="hamburger hamburger-2"></span>
    <span class="hamburger hamburger-3"></span>
  </label>
  
  <a href="#" class="menu-item"> <i class="fa fa-bar-chart"></i> </a>
  <a href="#" class="menu-item"> <i class="fa fa-plus"></i> </a>
  <a href="#" class="menu-item"> <i class="fa fa-heart"></i> </a>
  <a href="#" class="menu-item"> <i class="fa fa-envelope"></i> </a>
  <a href="#" class="menu-item"> <i class="fa fa-cog"></i> </a>
  <a href="#" class="menu-item"> <i class="fa fa-ellipsis-h"></i> </a>
  
</nav>


<!-- filters -->
<svg xmlns="http://www.w3.org/2000/svg" version="1.1">
    <defs>
      <filter id="shadowed-goo">
          
          <feGaussianBlur in="SourceGraphic" result="blur" stdDeviation="10" />
          <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="goo" />
          <feGaussianBlur in="goo" stdDeviation="3" result="shadow" />
          <feColorMatrix in="shadow" mode="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 1 -0.2" result="shadow" />
          <feOffset in="shadow" dx="1" dy="1" result="shadow" />
          <feComposite in2="shadow" in="goo" result="goo" />
          <feComposite in2="goo" in="SourceGraphic" result="mix" />
      </filter>
      <filter id="goo">
          <feGaussianBlur in="SourceGraphic" result="blur" stdDeviation="10" />
          <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="goo" />
          <feComposite in2="goo" in="SourceGraphic" result="mix" />
      </filter>
    </defs>
</svg>
<h1>Gooey Menu</h1>
<h2>Using CSS and SVG Filters</h2>
<h3>By <a href="https://codepen.io/lbebber">Lucas Bebber</a></h3>
<h4>Version 1 - <a href="https://codepen.io/lbebber/pen/RNgBPP" target="_blank">Version 2</a> - <a href="https://codepen.io/lbebber/pen/pvwZJp" target="_blank">Version 3</a> - <a href="https://codepen.io/lbebber/pen/rawQKR" target="_blank">Version 4</a></h4>
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

<nav class="menu">
  <input type="checkbox" href="#" class="menu-open" name="menu-open" id="menu-open"/>
  <label class="menu-open-button" for="menu-open">
    <span class="hamburger hamburger-1"></span>
    <span class="hamburger hamburger-2"></span>
    <span class="hamburger hamburger-3"></span>
  </label>
  
  <a href="#" class="menu-item"> <i class="fa fa-bar-chart"></i> </a>
  <a href="#" class="menu-item"> <i class="fa fa-plus"></i> </a>
  <a href="#" class="menu-item"> <i class="fa fa-heart"></i> </a>
  <a href="#" class="menu-item"> <i class="fa fa-envelope"></i> </a>
  <a href="#" class="menu-item"> <i class="fa fa-cog"></i> </a>

</nav>


<!-- filters -->
<svg xmlns="http://www.w3.org/2000/svg" version="1.1">
    <defs>
      <filter id="shadowed-goo">
          
          <feGaussianBlur in="SourceGraphic" result="blur" stdDeviation="10" />
          <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="goo" />
          <feGaussianBlur in="goo" stdDeviation="3" result="shadow" />
          <feColorMatrix in="shadow" mode="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 1 -0.2" result="shadow" />
          <feOffset in="shadow" dx="1" dy="1" result="shadow" />
          <feBlend in2="shadow" in="goo" result="goo" />
          <feBlend in2="goo" in="SourceGraphic" result="mix" />
      </filter>
      <filter id="goo">
          <feGaussianBlur in="SourceGraphic" result="blur" stdDeviation="10" />
          <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="goo" />
          <feBlend in2="goo" in="SourceGraphic" result="mix" />
      </filter>
    </defs>
</svg>
<div class="nav-right visible-xs">
  <div class="button" id="btn">
    <div class="bar top"></div>
    <div class="bar middle"></div>
    <div class="bar bottom"></div>
  </div>
</div>
<!-- nav-right -->
<main>


  <nav>
    <div class="nav-right hidden-xs">
      <div class="button" id="btn">
        <div class="bar top"></div>
        <div class="bar middle"></div>
        <div class="bar bottom"></div>
      </div>
    </div>
    <!-- nav-right -->
  </nav>

  <a href="https://codepen.io/tonkec/" class="ua" target="_blank">
    <i class="fa fa-user"></i>
  </a>
</main>

<div class="sidebar">
  <ul class="sidebar-list">
    <li class="sidebar-item"><a href="#" class="sidebar-anchor">Item 1</a></li>
    <li class="sidebar-item"><a href="#" class="sidebar-anchor">Item 2</a></li>
    <li class="sidebar-item"><a href="#" class="sidebar-anchor">Item 3</a></li>
    <li class="sidebar-item"><a href="#" class="sidebar-anchor">Item 4</a></li>
  </ul>
</div>
.back
.registration-form
  header
    h1 Sign Up
    p Fill in all informations
  form
    .input-section.email-section
      input(type="email" placeholder="ENTER YOUR E-MAIL HERE" autocomplete="off").email
      .animated-button
        span.icon-paper-plane
          i.fa.fa-envelope-o
        span.next-button.email
          i.fa.fa-arrow-up
    .input-section.password-section.folded
      input(type="password" placeholder="ENTER YOUR PASSWORD HERE").password
      .animated-button
        span.icon-lock
          i.fa.fa-lock
        span.next-button.password
          i.fa.fa-arrow-up
    .input-section.repeat-password-section.folded
      input(type="password" placeholder="REPEAT YOUR PASSWORD HERE").repeat-password
      .animated-button
        span.icon-repeat-lock
          i.fa.fa-lock
        span.next-button.repeat-password
          i.fa.fa-paper-plane
    .success 
      p ACCOUNT CREATED
    
    <form>
  <input id="input-1" type="text" placeholder="John Doe" required autofocus />
  <label for="input-1">
    <span class="label-text">Full Name</span>
    <span class="nav-dot"></span>
    <div class="signup-button-trigger">Sign Up</div>
  </label>
  <input id="input-2" type="text" placeholder="john" required />
  <label for="input-2">
    <span class="label-text">Username</span>
    <span class="nav-dot"></span>
  </label>
  <input id="input-3" type="email" placeholder="email@address.com" required />
  <label for="input-3">
    <span class="label-text">Email</span>
    <span class="nav-dot"></span>
  </label>
  <input id="input-4" type="text" placeholder="&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;" required />
  <label for="input-4">
    <span class="label-text">Password</span>
    <span class="nav-dot"></span>
  </label>
  <input id="input-5" type="text" placeholder="&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;" required />
  <label for="input-5">
    <span class="label-text">Confirm Password</span>
    <span class="nav-dot"></span>
  </label>
  <button type="submit">Create Your Account</button>
  <p class="tip">Press Tab</p>
  <div class="signup-button">Sign Up</div>
</form>
<div class="wrap">
  <h1>Hover card</h1>
  <div class="task">
    <div class="abstract">
      <h3>Abstract</h3>
      <p>This is what you see by default.</p>
    </div>
    <div class="details">
      <div class="details__inner">
        <h3>Details</h3>
        <p>This additional content gets revealed on hover.</p>
      </div>
    </div>
  </div>
</div>
%nav
  .mini
    %p.products Empty
    %p.names
    %p.miniprice
  %ul
    %li Home
    %li Webshop
    %li Contact
  .cart.icon-basket
    %span.number 1
.container
  -15.times do
    %div.product
      %img(src='https://placeimg.com/200/100')
      %h2.header Product Name
      %p.description Nullam posuere turpis vel lacinia luctus. Donec in efficitur neque. Curabitur consectetur non ipsum in eleifend. Praesent id velit in nisi maximus porta nec vitae odio. Proin vitae magna a massa accumsan venenatis. Donec semper, sem in ullamcorper bibendum, mauris sem imperdiet lorem, tempor aliquet ligula lorem sit amet nibh. Suspendisse potenti.
      %p.price 231,-
      .btn Add to cart
      .quickview Quickview
.quickviewContainer
  .close
  %h2.headline
  %p.description
  %img(src='https://placeimg.com/100/100')
  %img(src='https://placeimg.com/100/100')
  %img(src='https://placeimg.com/100/100')

  <div class="main">
  <header>
    <ul>
      <li><a href="#">Home</a></li>
      <li><a href="#">Shop</a></li>
      <li><a href="#">Accessories</a></li>
      <li><h1>Ecommerce</h1></li>
      <li><a href="#">Collections</a></li>
      <li><a href="#">Brands</a></li>
      <li><a href="#">Contact</a></li>
    </ul>
  </header>
  
  <div class="cd-slider">
    <ul>
      <li>
        <div class="image" style="background-image:url(https://images.unsplash.com/photo-1421809313281-48f03fa45e9f?crop=entropy&fit=crop&fm=jpg&h=675&ixjsv=2.1.0&ixlib=rb-0.3.5&q=80&w=1000);"></div>
        <div class="content">
          <h2>Jackets Collection 2017</h2>
          <a href="#">View Gallery</a>
        </div>
      </li>
      <li>
        <div class="image" style="background-image:url(https://images.unsplash.com/uploads/1411724908903377d4696/2e9b0cb2?crop=entropy&fit=crop&fm=jpg&h=675&ixjsv=2.1.0&ixlib=rb-0.3.5&q=80&w=1000);"></div>
        <div class="content">
          <h2>Accessories</h2>
          <a href="#">View Gallery</a>
        </div>
      </li>
      <li>
        <div class="image" style="background-image:url(https://images.unsplash.com/photo-1416838375725-e834a83f62b7?crop=entropy&fit=crop&fm=jpg&h=675&ixjsv=2.1.0&ixlib=rb-0.3.5&q=80&w=1000);"></div>
        <div class="content">
          <h2>Winter Shoes</h2>
          <a href="#">View Gallery</a>
        </div>
      </li>
      <li>
        <div class="image" style="background-image:url(https://images.unsplash.com/35/JOd4DPGLThifgf38Lpgj_IMG.jpg?crop=entropy&fit=crop&fm=jpg&h=675&ixjsv=2.1.0&ixlib=rb-0.3.5&q=80&w=1000);"></div>
        <div class="content">
          <h2>Winter Collection 2017</h2>
          <a href="#">View Gallery</a>
        </div>
      </li>
      <li>
        <div class="image" style="background-image:url(https://images.unsplash.com/photo-1453974336165-b5c58464f1ed?crop=entropy&fit=crop&fm=jpg&h=675&ixjsv=2.1.0&ixlib=rb-0.3.5&q=80&w=1000);"></div>
        <div class="content">
          <h2>Summer Collection</h2>
          <a href="#">View Gallery</a>
        </div>
      </li>      
    </ul>
  </div> <!--/.cd-slider-->
  
  <div class="text">
    <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Vero qui error, nesciunt quam laborum nihil cupiditate delectus pariatur facilis odio suscipit provident blanditiis, quod. Blanditiis dolorem quo illum voluptatem maiores.</p>
    <p>Nihil adipisci quo velit totam, voluptatum voluptas vero voluptatem odio sit ipsam quis quibusdam quasi voluptatibus dolorum fuga vel corrupti facere voluptates, unde officiis. Enim nobis ipsam veritatis qui a?</p>
    <p>Esse in, architecto est eius. Quia dicta modi magni, non labore, iusto accusantium assumenda soluta ab quis suscipit vero doloremque quos. Dicta tempore aliquam saepe distinctio optio veritatis iure minima.</p>
    <p>Sapiente impedit ea deserunt architecto ipsa qui modi, nemo iste adipisci, nihil quidem, non tenetur. Esse dolorem aperiam quaerat sequi, nostrum voluptate eveniet blanditiis voluptatum soluta error sapiente fugit! Quae.</p>
    <p>Voluptate mollitia ipsum consequatur dolor eaque nesciunt. Provident eveniet ratione, alias ad aliquam totam! Illo cum nostrum, adipisci porro quisquam ipsum autem enim iusto eius, optio dolorem, voluptates iure voluptate.</p>
    <p>Ducimus mollitia cumque quia, natus sint beatae impedit ad. Libero doloribus nostrum perspiciatis, officiis provident quidem, in ratione aut id enim necessitatibus sit modi. Quidem, tempora ipsum nulla dicta voluptatum?</p>
    <p>Nisi recusandae rem culpa, doloribus est perspiciatis atque possimus explicabo, ipsum corrupti dolore officia eius vitae ipsam iste. Dignissimos quasi sunt dolor, at commodi nemo quae vitae? Hic, temporibus, amet?</p>
    <p>Aspernatur a accusantium incidunt sit excepturi? Blanditiis ratione ex, repellendus? Repellat, eius officiis mollitia, ad quia, quam nihil voluptates aperiam rem sit modi voluptatum alias. Optio, at perferendis. Cumque, commodi!</p>
    <p>Nostrum sit facere ad voluptate et a voluptates, ea, perspiciatis consequuntur, fugiat animi nesciunt eligendi quidem temporibus veritatis quis, dolore illo sunt excepturi pariatur tenetur. Quasi laboriosam similique explicabo voluptas!</p>
    <p>Ducimus labore quas, quae non quaerat molestias excepturi fugiat cum obcaecati minima deserunt a, voluptates inventore error similique, molestiae rem placeat aliquid, distinctio dicta dolores. Aperiam, cupiditate, omnis! Ipsum, beatae.</p>
  </div>
  
</div>
<div id="all">
  <div id="allcontent">
      <div id="maincontent">
          <div class="portfolio">
              <img src="http://www.claudiogomboli.com/lab/gallery/imgs/ecomm.jpg" alt="Portfolio img"><br>
              <span class="txt">eCommerce . iOS Icon.</span>
              <div class="ombra"></div>
          </div>
          <div class="portfolio">
              <img src="http://www.claudiogomboli.com/lab/gallery/imgs/speaker.jpg" alt="Portfolio img"><br>
              <span class="txt">Speaker . iOS Icon.</span>
              <div class="ombra"></div>
          </div>
          <div class="portfolio">
              <img src="http://www.claudiogomboli.com/lab/gallery/imgs/graph01.jpg" alt="Portfolio img"><br>
              <span class="txt">Poster . Laperquisa Cinema . <a href="http://cargocollective.com/gomboli/Laperquisa-Cinema-Screening-Posters" target="_blank" title="see more">see more</a>.</span>
              <div class="ombra"></div>
          </div>
          <div class="portfolio">
              <img src="http://www.claudiogomboli.com/lab/gallery/imgs/web01.jpg" alt="Portfolio img"><br>
              <span class="txt">Alfa Romeo <a href="http://www.alfaromeo.com/carconfigurator/IT/159/index.html" target="_blank" title="Alfa Romeo">Car Configurator</a> . <a href="http://wedoo.it" target="_blank" title="WEDOO">@Wedoo</a>.</span>
              <div class="ombra"></div>
          </div>
          <div class="portfolio">
              <img src="http://www.claudiogomboli.com/lab/gallery/imgs/illu01.jpg" alt="Portfolio img"><br>
              <span class="txt">Mac Book Air . Keynote Illustration</span>
              <div class="ombra"></div>
          </div>
      </div>
      <div id="navi"></div>
    <div class="footer"><a href="http://theeggs.biz" alt="home">c.gomboli</a> / <a href="http://lab.theeggs.biz" alt="lab">lab</a></div>
  </div>
</div>
<main>
  <header>
    <h1>Fancy<strong>Meter</strong></h1>
  </header>
  <article class="flex-item">
    <header>
      <h2>A cool effect for charts</h2>
      <p>SVG + Sass</p>
    </header>
    <input id="change-values" type="checkbox" aria-hidden="true">
    <div class="fancy-meter">
      <svg class="fancy-meter_svg">
            <defs>
              <linearGradient id="gradient" x1="0" y1="0" x2="100%" y2="100%">
                <stop offset="0" stop-color="white" stop-opacity=".1"></stop>
                <stop offset="50%" stop-color="white" stop-opacity=".4"></stop>
                <stop offset="100%" stop-color="white" stop-opacity=".1"></stop>
              </linearGradient>
              <pattern id="image" x="0" y="0" patternUnits="userSpaceOnUse" height="100%" width="100%">
                <image x="0" y="0" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://s32.postimg.org/n2r26eis1/gradient.png" height="100%" width="100%"></image>
              </pattern>
            </defs>
            <circle r="4.2em" cx="50%" cy="50%" fill="none" stroke="url(#gradient)" stroke-width=".65em"></circle>
            <circle r="4.2em" cx="50%" cy="50%" fill="none" stroke="url(#image)" stroke-width=".45em" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" class="fancy-meter_svg-element"></circle>
            <circle r="4.2em" cx="50%" cy="50%" fill="none" stroke-width=".5em" stroke="url(#gradient)" class="fancy-meter_svg-wheel marks"></circle>
            <circle r="2.65em" cx="50%" cy="50%" fill="none" stroke="url(#gradient)" stroke-width=".08em" class="fancy-meter_svg-wheel"></circle>
            <circle r=".25em" cx="50%" cy="50%" stroke="url(#gradient)" stroke-width=".1em" class="marker"></circle>
          </svg>
    </div>
    <div class="fancy-meter_shadow">
      <svg class="fancy-meter_svg">
            <defs>
              <filter id="blur">
                <feGaussianBlur in="SourceGraphic" stdDeviation="1"></feGaussianBlur>
              </filter>
              <linearGradient id="fadeGrad" x1="50%" y1="0" x2="50%" y2="100%">
                <stop offset="0" stop-color="black" stop-opacity="0"></stop>
                <stop offset="1" stop-color="white" stop-opacity=".5"></stop>
              </linearGradient>
              <mask id="fade" maskContentUnits="userSpaceOnUse">
                <rect width="100%" height="100%" fill="url(#fadeGrad)"></rect>
              </mask>
            </defs>
            <g mask="url(#fade)" filter="url(#blur)">
              <circle r="4.2em" cx="50%" cy="50%" fill="none" stroke="url(#gradient)" stroke-width=".65em"></circle>
              <circle r="4.2em" cx="50%" cy="50%" fill="none" stroke="url(#image)" stroke-width=".45em" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" class="fancy-meter_svg-element"></circle>
              <circle r="4.2em" cx="50%" cy="50%" fill="none" stroke-width=".5em" stroke="url(#gradient)" class="fancy-meter_svg-wheel marks"></circle>
              <circle r="2.65em" cx="50%" cy="50%" fill="none" stroke="url(#gradient)" stroke-width=".08em" class="fancy-meter_svg-wheel"></circle>
              <circle r=".25em" cx="50%" cy="50%" stroke="url(#gradient)" stroke-width=".1em" class="marker"></circle>
            </g>
          </svg>
    </div>
    <div>
      <label role="button" for="change-values" id="change-values">Change value</label>
    </div>
  </article>
</main>
<section class="sivir">
  <div class="button-cont">
    <button href="#" class="button-sivir"><span class="txt">Acquista<span></button>
    <svg id="loader-g" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 93.34 93.34">
      <circle id="loader" cx="46.67" cy="46.67" r="43.67"></circle>
            <path id="sent" d="M431.57,279.88a3,3,0,0,1-2.12-.88l-10.76-10.76a3,3,0,0,1,4.24-4.24l8.64,8.64,20.34-20.34a3,3,0,1,1,4.24,4.24L433.69,279A3,3,0,0,1,431.57,279.88Z"/>
            <path id="error" d="M441.66,266l9.11-9.11a3,3,0,1,0-4.24-4.24l-9.11,9.11-9.11-9.11a3,3,0,1,0-4.24,4.24l9.11,9.11-9.11,9.11a3,3,0,1,0,4.24,4.24l9.11-9.11,9.11,9.11a3,3,0,0,0,4.24-4.24Z" transform="translate(-390.75 -219.31)" />
    </svg>
  </div>
</section>

<section class="singed">
  <div class="button-singed">
<svg class="singed-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 117.44 117.44">
    <circle class="bsinged" cx="58.72" cy="58.72" r="58.72"/>
    <path id="tick" d="M191.69,238.38a57.11,57.11,0,1,1-57.11,57.11s-0.71-18.53,11.17-33.94,33-6,19.75,16.2c-12,20.06,25.33,39.15,25.33,39.15l12.4-11.07" transform="translate(-132.97 -236.76)"/>
    <path class="shopper" d="M219.88,291.45a10.56,10.56,0,0,0-8.35-3.62h-3.67V282a15.29,15.29,0,0,0-15.06-15.48h-2.23A15.29,15.29,0,0,0,175.5,282v4.19s0,0.06,0,.1v1.52h-3.65a10.56,10.56,0,0,0-8.35,3.62,7.63,7.63,0,0,0-1.17,6.67l5.45,16.79c1,4.08,3.14,9.49,9.54,9.49h28.74c6.4,0,8.51-5.42,9.52-9.4l5.51-17A7.56,7.56,0,0,0,219.88,291.45Zm-41.64-5.35V282a12.51,12.51,0,0,1,12.33-12.66h2.23A12.51,12.51,0,0,1,205.12,282v4.18a0.8,0.8,0,0,0,0,.11v1.52H178.24V286.1Zm40.21,11.13-5.5,17c-1.31,5.18-3.37,7.39-6.89,7.39H177.31c-3.57,0-5.56-2.14-6.92-7.48l-5.45-16.77a4.74,4.74,0,0,1,.69-4.16,8,8,0,0,1,6.19-2.54h3.65v2.09a3.36,3.36,0,0,0-1.93,3,3.28,3.28,0,1,0,6.56,0,3.36,3.36,0,0,0-1.89-3v-2.11H205.1v2.14a3.25,3.25,0,1,0,2.74-.08v-2.06h3.7a8,8,0,0,1,6.19,2.54A4.68,4.68,0,0,1,218.45,297.24Z" transform="translate(-132.97 -236.76)"/>
</svg>
  </div>
</section>
input.message(placeholder='How can we help?')
.container
  .tear
    | <span> <i class="fa fa-life-ring"></i></span>
<!-- Demo page craeted by https://github.com/petr-goca -->
<header role="banner" aria-label="Heading">
  <div class="header">
    <div class="_cont">
      <div class="shadow">
        <a class="logo" title="Home" href='https://github.com/greenwoodents/quickbeam.js'>Quickbeam.js Demo</a>
      </div>
      <div class="mobile-menu">
        <form action="/search" method="get" id="find">
          <div>
            <input type="text" name="q" id="find-input" class="find-input" placeholder="Search..." value="">
            <button type="submit" title="Search" id="find-btn">Search</button>
          </div>
        </form>
        <a id="customer_login_link">Sign In</a>
        <nav role="navigation" aria-label="Catalog">
          <ul>
            <li class="nc nav-li-category">
              <a class="nc nav-category" data-subcategories="1">Women</a>
              <ul class="nc">
              </ul>
            </li>
            <li class="nc nav-li-category">
              <a class="nc nav-category" data-subcategories="1">Men</a>
              <ul class="nc">
              </ul>
            </li>
          </ul>
        </nav>
      </div>
      <span id="nav-icon"></span>
    </div>
  </div>
  <div class="breadcrumb" role="navigation" aria-label="Breadcrumbs">
    <div class="_cont">
      <ol>
        <li><a title="Back to the frontpage">Home</a></li>
        <li><a title="">Men</a></li>
        <li>Tony Hunfinger T-Shirt New York</li>
      </ol>
    </div>
  </div>
</header>
<section aria-label="Main content" role="main" class="product-detail">
  <div itemscope itemtype="http://schema.org/Product">
    <meta itemprop="url" content="http://html-koder-test.myshopify.com/products/tommy-hilfiger-t-shirt-new-york">
    <meta itemprop="image" content="//cdn.shopify.com/s/files/1/1047/6452/products/product_grande.png?v=1446769025">
    <div class="shadow">
      <div class="_cont detail-top">
        <div class="cols">
          <div class="left-col">
            <div class="thumbs">
              <a class="thumb-image active" href="//cdn.shopify.com/s/files/1/1047/6452/products/product_1024x1024.png?v=1446769025" data-index="0">
                <span><img src="//cdn.shopify.com/s/files/1/1047/6452/products/product_150x150.png?v=1446769025" alt="Tommy Hilfiger T-Shirt New York"></span>
              </a>
              <a class="thumb-image" href="//cdn.shopify.com/s/files/1/1047/6452/products/tricko1_1024x1024.jpg?v=1447104179" data-index="1">
                <span><img src="//cdn.shopify.com/s/files/1/1047/6452/products/tricko1_150x150.jpg?v=1447104179" alt="Tommy Hilfiger T-Shirt New York"></span>
              </a>
              <a class="thumb-image" href="//cdn.shopify.com/s/files/1/1047/6452/products/tricko2_1024x1024.jpg?v=1447104180" data-index="2">
                <span><img src="//cdn.shopify.com/s/files/1/1047/6452/products/tricko2_150x150.jpg?v=1447104180" alt="Tommy Hilfiger T-Shirt New York"></span>
              </a>
              <a class="thumb-image" href="//cdn.shopify.com/s/files/1/1047/6452/products/tricko3_1024x1024.jpg?v=1447104182" data-index="3">
                <span><img src="//cdn.shopify.com/s/files/1/1047/6452/products/tricko3_150x150.jpg?v=1447104182" alt="Tommy Hilfiger T-Shirt New York"></span>
              </a>
            </div>
            <div class="big">
              <span id="big-image" class="img" quickbeam="image" style="background-image: url('//cdn.shopify.com/s/files/1/1047/6452/products/product_1024x1024.png?v=1446769025')" data-src="//cdn.shopify.com/s/files/1/1047/6452/products/product_1024x1024.png?v=1446769025"></span>
              <div id="banner-gallery" class="swipe">
                <div class="swipe-wrap">
                  <div style="background-image: url('//cdn.shopify.com/s/files/1/1047/6452/products/product_large.png?v=1446769025')"></div>
                  <div style="background-image: url('//cdn.shopify.com/s/files/1/1047/6452/products/tricko1_large.jpg?v=1447104179')"></div>
                  <div style="background-image: url('//cdn.shopify.com/s/files/1/1047/6452/products/tricko2_large.jpg?v=1447104180')"></div>
                  <div style="background-image: url('//cdn.shopify.com/s/files/1/1047/6452/products/tricko3_large.jpg?v=1447104182')"></div>
                </div>
              </div>
              <div class="detail-socials">
                <div class="social-sharing" data-permalink="http://html-koder-test.myshopify.com/products/tommy-hilfiger-t-shirt-new-york">
                  <a target="_blank"  class="share-facebook" title="Share"></a>
                  <a target="_blank"  class="share-twitter" title="Tweet"></a>
                  <a target="_blank"  class="share-pinterest" title="Pin it"></a>
                </div>
              </div>
            </div>
          </div>
          <div class="right-col">
            <h1 itemprop="name">Tony Hunfinger T-Shirt New York</h1>
            <div itemprop="offers" itemscope itemtype="http://schema.org/Offer">
              <meta itemprop="priceCurrency" content="USD">
              <link itemprop="availability" href="http://schema.org/InStock">
              <div class="price-shipping">
                <div class="price" id="price-preview" quickbeam="price" quickbeam-price="800">
                  $800.00
                </div>
                <a>Free shipping</a>
              </div>
              <div class="swatches">
                <div class="swatch clearfix" data-option-index="0">
                  <div class="header">Size</div>
                  <div data-value="M" class="swatch-element plain m available">
                    <input id="swatch-0-m" type="radio" name="option-0" value="M" checked  />
                    <label for="swatch-0-m">
                      M
                      <img class="crossed-out" src="//cdn.shopify.com/s/files/1/1047/6452/t/1/assets/soldout.png?10994296540668815886" />
                    </label>
                  </div>
                  <div data-value="L" class="swatch-element plain l available">
                    <input id="swatch-0-l" type="radio" name="option-0" value="L"  />
                    <label for="swatch-0-l">
                      L
                      <img class="crossed-out" src="//cdn.shopify.com/s/files/1/1047/6452/t/1/assets/soldout.png?10994296540668815886" />
                    </label>
                  </div>
                  <div data-value="XL" class="swatch-element plain xl available">
                    <input id="swatch-0-xl" type="radio" name="option-0" value="XL"  />
                    <label for="swatch-0-xl">
                      XL
                      <img class="crossed-out" src="//cdn.shopify.com/s/files/1/1047/6452/t/1/assets/soldout.png?10994296540668815886" />
                    </label>
                  </div>
                  <div data-value="XXL" class="swatch-element plain xxl available">
                    <input id="swatch-0-xxl" type="radio" name="option-0" value="XXL"  />
                    <label for="swatch-0-xxl">
                      XXL
                      <img class="crossed-out" src="//cdn.shopify.com/s/files/1/1047/6452/t/1/assets/soldout.png?10994296540668815886" />
                    </label>
                  </div>
                </div>
                <div class="swatch clearfix" data-option-index="1">
                  <div class="header">Color</div>
                  <div data-value="Blue" class="swatch-element color blue available">
                    <div class="tooltip">Blue</div>
                    <input quickbeam="color" id="swatch-1-blue" type="radio" name="option-1" value="Blue" checked  />
                    <label for="swatch-1-blue" style="border-color: blue;">
                      <img class="crossed-out" src="//cdn.shopify.com/s/files/1/1047/6452/t/1/assets/soldout.png?10994296540668815886" />
                      <span style="background-color: blue;"></span>
                    </label>
                  </div>
                  <div data-value="Red" class="swatch-element color red available">
                    <div class="tooltip">Red</div>
                    <input quickbeam="color" id="swatch-1-red" type="radio" name="option-1" value="Red"  />
                    <label for="swatch-1-red" style="border-color: red;">
                      <img class="crossed-out" src="//cdn.shopify.com/s/files/1/1047/6452/t/1/assets/soldout.png?10994296540668815886" />
                      <span style="background-color: red;"></span>
                    </label>
                  </div>
                  <div data-value="Yellow" class="swatch-element color yellow available">
                    <div class="tooltip">Yellow</div>
                    <input quickbeam="color" id="swatch-1-yellow" type="radio" name="option-1" value="Yellow"  />
                    <label for="swatch-1-yellow" style="border-color: yellow;">
                      <img class="crossed-out" src="//cdn.shopify.com/s/files/1/1047/6452/t/1/assets/soldout.png?10994296540668815886" />
                      <span style="background-color: yellow;"></span>
                    </label>
                  </div>
                </div>
                <div class="guide">
                  <a>Size guide</a>
                </div>
              </div>
              <!-- <form method="post" enctype="multipart/form-data" id="AddToCartForm"> -->
              <form id="AddToCartForm">
                <select name="id" id="productSelect" quickbeam="product" class="product-single__variants">
                  <option  selected="selected"  data-sku="" value="7924994501">
                    M / Blue - $800.00 USD
                  </option>
                  <option  data-sku="" value="7924995077">
                    M / Red - $850.00 USD
                  </option>
                  <option  data-sku="" value="7924994437">
                    L / Blue - $850.00 USD
                  </option>
                  <option  data-sku="" value="7924994693">
                    L / Yellow - $850.00 USD
                  </option>
                  <option  data-sku="" value="7924995013">
                    L / Red - $850.00 USD
                  </option>
                  <option  data-sku="" value="7924994373">
                    XL / Blue - $900.00 USD
                  </option>
                  <option  data-sku="" value="7924994629">
                    XL / Yellow - $850.00 USD
                  </option>
                  <option  data-sku="" value="7924830021">
                    XXL / Blue - $950.00 USD
                  </option>
                  <option  data-sku="" value="7924994885">
                    XXL / Red - $850.00 USD
                  </option>
                </select>
                <div class="btn-and-quantity-wrap">
                  <div class="btn-and-quantity">
                    <div class="spinner">
                      <span class="btn minus" data-id="2721888517"></span>
                      <input type="text" id="updates_2721888517" name="quantity" value="1" class="quantity-selector">
                      <input type="hidden" id="product_id" name="product_id" value="2721888517">
                      <span class="q">Qty.</span>
                      <span class="btn plus" data-id="2721888517"></span>
                    </div>
                    <div id="AddToCart" quickbeam="add-to-cart">
                      <span id="AddToCartText">Add to Cart</span>
                    </div>
                  </div>
                </div>
              </form>
              <div class="tabs">
                <div class="tab-labels">
                  <span data-id="1" class="active">Info</span>
                  <span data-id="2">Brand</span>
                </div>
                <div class="tab-slides">
                  <div id="tab-slide-1" itemprop="description"  class="slide active">
                    We open source it for you https://github.com/greenwoodents/quickbeam.js if you want to use it on your ecommerce.
                  </div>
                  <div id="tab-slide-2" class="slide">
                    Tony Hunfinger
                  </div>
                </div>
              </div>
              <div class="social-sharing-btn-wrapper">
                <span id="social_sharing_btn">Share</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <aside class="related">
      <div class="_cont">
        <h2>You might also like</h2>
        <div class="collection-list cols-4" id="collection-list" data-products-per-page="4">
          <a class="product-box">
            <span class="img">
              <span style="background-image: url('//cdn.shopify.com/s/files/1/1047/6452/products/tricko1_70d2887b-ec6a-4bcb-a93b-7fd1783e6445_grande.jpg?v=1447530130')" class="i first"></span>
              <span class="i second" style="background-image: url('//cdn.shopify.com/s/files/1/1047/6452/products/product_030f9fc5-f253-4dca-a43a-fe2b719d0704_grande.png?v=1447530130')"></span>
            </span>
            <span class="text">
              <strong>Tony Hunfinger T-Shirt New York 2</strong>
              <span>
                From $800.00
              </span>
              <div class="variants">
                <div class="variant">
                  <div class="var m available">
                    <div class="t">M</div>
                  </div>
                  <div class="var l available">
                    <div class="t">L</div>
                  </div>
                  <div class="var xl available">
                    <div class="t">XL</div>
                  </div>
                  <div class="var xxl available">
                    <div class="t">XXL</div>
                  </div>
                </div>
                <div class="variant">
                  <div class="var color blue available">
                    <div class="c" style="background-color: blue;"></div>
                  </div>
                  <div class="var color red available">
                    <div class="c" style="background-color: red;"></div>
                  </div>
                  <div class="var color yellow available">
                    <div class="c" style="background-color: yellow;"></div>
                  </div>
                </div>
              </div>
            </span>
          </a>
          <a class="product-box">
            <span class="img">
              <span style="background-image: url('//cdn.shopify.com/s/files/1/1047/6452/products/tricko2_357767df-d7ff-4b58-b705-edde76bb32b7_grande.jpg?v=1447530150')" class="i first"></span>
              <span class="i second" style="background-image: url('//cdn.shopify.com/s/files/1/1047/6452/products/tricko1_613d5776-ea61-4f9b-abef-0ce847c63a67_grande.jpg?v=1447530150')"></span>
            </span>
            <span class="text">
              <strong>Tony Hunfinger T-Shirt New York 3</strong>
              <span>
                From $800.00
              </span>
              <div class="variants">
                <div class="variant">
                  <div class="var m available">
                    <div class="t">M</div>
                  </div>
                  <div class="var l available">
                    <div class="t">L</div>
                  </div>
                  <div class="var xl available">
                    <div class="t">XL</div>
                  </div>
                  <div class="var xxl available">
                    <div class="t">XXL</div>
                  </div>
                </div>
                <div class="variant">
                  <div class="var color blue available">
                    <div class="c" style="background-color: blue;"></div>
                  </div>
                  <div class="var color red available">
                    <div class="c" style="background-color: red;"></div>
                  </div>
                  <div class="var color yellow available">
                    <div class="c" style="background-color: yellow;"></div>
                  </div>
                </div>
              </div>
            </span>
          </a>
          <a href="/collections/men/products/copy-of-copy-of-copy-of-tommy-hilfiger-t-shirt-new-york-4" class="product-box">
            <span class="img">
              <span style="background-image: url('//cdn.shopify.com/s/files/1/1047/6452/products/tricko3_0e98498a-123c-4305-9d94-d8280bb46416_grande.jpg?v=1447530164')" class="i first"></span>
              <span class="i second" style="background-image: url('//cdn.shopify.com/s/files/1/1047/6452/products/tricko2_6c949188-dba0-4789-9434-c0821b92f3f4_grande.jpg?v=1447530164')"></span>
            </span>
            <span class="text">
              <strong>Tony Hunfinger T-Shirt New York 4</strong>
              <span>
                From $800.00
              </span>
              <div class="variants">
                <div class="variant">
                  <div class="var m available">
                    <div class="t">M</div>
                  </div>
                  <div class="var l available">
                    <div class="t">L</div>
                  </div>
                  <div class="var xl available">
                    <div class="t">XL</div>
                  </div>
                  <div class="var xxl available">
                    <div class="t">XXL</div>
                  </div>
                </div>
                <div class="variant">
                  <div class="var color blue available">
                    <div class="c" style="background-color: blue;"></div>
                  </div>
                  <div class="var color red available">
                    <div class="c" style="background-color: red;"></div>
                  </div>
                  <div class="var color yellow available">
                    <div class="c" style="background-color: yellow;"></div>
                  </div>
                </div>
              </div>
            </span>
          </a>
          <a class="product-box">
            <span class="img">
              <span style="background-image: url('//cdn.shopify.com/s/files/1/1047/6452/products/product_7d606126-1b60-4738-99b3-062810f2db8b_grande.png?v=1447530674')" class="i first"></span>
              <span class="i second" style="background-image: url('//cdn.shopify.com/s/files/1/1047/6452/products/tricko3_fd08d231-654c-4304-81b2-9191e6fd141e_grande.jpg?v=1447530674')"></span>
            </span>
            <span class="text">
              <strong>Tony Hunfinger T-Shirt New York 5</strong>
              <span>
                From $800.00
              </span>
              <div class="variants">
                <div class="variant">
                  <div class="var m available">
                    <div class="t">M</div>
                  </div>
                  <div class="var l available">
                    <div class="t">L</div>
                  </div>
                  <div class="var xl available">
                    <div class="t">XL</div>
                  </div>
                  <div class="var xxl available">
                    <div class="t">XXL</div>
                  </div>
                </div>
                <div class="variant">
                  <div class="var color blue available">
                    <div class="c" style="background-color: blue;"></div>
                  </div>
                  <div class="var color red available">
                    <div class="c" style="background-color: red;"></div>
                  </div>
                  <div class="var color yellow available">
                    <div class="c" style="background-color: yellow;"></div>
                  </div>
                </div>
              </div>
            </span>
          </a>
          <a class="product-box hidden">
            <span class="img">
              <span style="background-image: url('//cdn.shopify.com/s/files/1/1047/6452/products/tricko1_bba77d82-7f85-47af-9a45-f4700bcc04ad_grande.jpg?v=1447530689')" class="i first"></span>
              <span class="i second" style="background-image: url('//cdn.shopify.com/s/files/1/1047/6452/products/product_f065e961-d296-48a8-8a67-a3532200e257_grande.png?v=1447530689')"></span>
            </span>
            <span class="text">
              <strong>Tony Hunfinger T-Shirt New York 6</strong>
              <span>
                From $800.00
              </span>
              <div class="variants">
                <div class="variant">
                  <div class="var m available">
                    <div class="t">M</div>
                  </div>
                  <div class="var l available">
                    <div class="t">L</div>
                  </div>
                  <div class="var xl available">
                    <div class="t">XL</div>
                  </div>
                  <div class="var xxl available">
                    <div class="t">XXL</div>
                  </div>
                </div>
                <div class="variant">
                  <div class="var color blue available">
                    <div class="c" style="background-color: blue;"></div>
                  </div>
                  <div class="var color red available">
                    <div class="c" style="background-color: red;"></div>
                  </div>
                  <div class="var color yellow available">
                    <div class="c" style="background-color: yellow;"></div>
                  </div>
                </div>
              </div>
            </span>
          </a>
          <a class="product-box hidden">
            <span class="img">
              <span style="background-image: url('//cdn.shopify.com/s/files/1/1047/6452/products/tricko2_bf59c7f2-7c1f-4822-9494-6a984598a56c_grande.jpg?v=1447530706')" class="i first"></span>
              <span class="i second" style="background-image: url('//cdn.shopify.com/s/files/1/1047/6452/products/tricko1_c6fa0fc1-99a0-4bd0-a1d8-0270127977fc_grande.jpg?v=1447530706')"></span>
            </span>
            <span class="text">
              <strong>Tony Hunfinger T-Shirt New York 7</strong>
              <span>
                From $800.00
              </span>
              <div class="variants">
                <div class="variant">
                  <div class="var m available">
                    <div class="t">M</div>
                  </div>
                  <div class="var l available">
                    <div class="t">L</div>
                  </div>
                  <div class="var xl available">
                    <div class="t">XL</div>
                  </div>
                  <div class="var xxl available">
                    <div class="t">XXL</div>
                  </div>
                </div>
                <div class="variant">
                  <div class="var color blue available">
                    <div class="c" style="background-color: blue;"></div>
                  </div>
                  <div class="var color red available">
                    <div class="c" style="background-color: red;"></div>
                  </div>
                  <div class="var color yellow available">
                    <div class="c" style="background-color: yellow;"></div>
                  </div>
                </div>
              </div>
            </span>
          </a>
        </div>
        <div class="more-products" id="more-products-wrap">
          <span id="more-products" data-rows_per_page="1">More products</span>
        </div>
      </div>
    </aside>
  </div>

</section>
<footer role="contentinfo" aria-label="Footer">
  <div class="_cont">
    <div class="socials">
      <strong>follow us:</strong>
      <ul>
        <li><a  title="html-koder / test on Twitter" class="tw" target="_blank">Twitter</a></li>
        <li><a  title="html-koder / test on Facebook" class="fb" target="_blank">Facebook</a></li>
        <li><a  title="html-koder / test on Instagram" class="in" target="_blank">Instagram</a></li>
        <li><a  title="html-koder / test on Pinterest" class="pi" target="_blank">Pinterest</a></li>
      </ul>
    </div>
    <div class="top">
      <div class="right">
        <form method="post" action="/contact" class="contact-form" accept-charset="UTF-8">
          <input type="hidden" value="customer" name="form_type" /><input type="hidden" name="utf8" value="✓" />
          <div>
            <input type="hidden" id="contact_tags" name="contact[tags]" value="newsletter"/>
            <input type="text" id="contact_email" name="contact[email]" placeholder="Submit e-mail for special offers...">
            <button type="submit" title="Newsletter Signup">OK</button>
          </div>
        </form>
      </div>
      <div class="left">
        <span class="phone">+420 123 456 789</span>
        <a class="mail" href="mailto:email.from@settings.com">email.from@settings.com</a>
      </div>
    </div>
    <div class="bottom">
      <div class="left">
        <nav role="navigation" aria-label="Service menu">
          <ul>
            <li><a >Lorem ipsum</a></li>
            <li><a >About Us</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</footer>

<!-- Quickbeam cart-->

<div id="quick-cart" quickbeam="cart">
  <a id="quick-cart-pay" quickbeam="cart-pay" class="cart-ico">
    <span>
      <strong class="quick-cart-text">Pay<br></strong>
      <span id="quick-cart-price">0</span>
      <span id="quick-cart-pay-total-count">0</span>
    </span>
  </a>
</div>

<!-- Quickbeam cart end -->
<div class='container'>
  <div class='background-element' id='background-element'>
  </div>
  <div class='highlight-window' id='product-img'><div class='highlight-overlay' id='highlight-overlay'></div></div>
  <div class='window'>
    <div class='main-content'>
      <h2>Tiger of Sweden</h2>
      <h1>LEONARD COAT</h1>
      <h3>MINIMALISTIC COAT IN COTTON-BLEND</h3>
  <div class='description' id='description'>
  Men's minimalistic overcoat in cotton-blend. Features a stand-up collar, concealed front closure and single back vent. Slim fit with clean, straight shape. Above-knee length.</div>
      <div class='highlight-window  mobile' id='product-img'><div class='highlight-overlay' id='highlight-overlay-mobile'></div></div>
      <div class='options'>
        <div class='color-options'>
          Color:
      <div class='color-picker'>
        <div class='color overlay' id='color-overlay'><div class='check'></div></div>
        <div class='color color-a' id='color-a'></div>
        <div class='color color-b' id='color-b'></div>
      </div>
                  <span class='small' style='color:#457'>COLOR: <span id='color-name'>BLUES / 2V5</span></span>
        </div>
        <div class='size-picker'>
         Size:
  <div class='range-picker' id='range-picker'>
    <div>44</div><div>46</div><div>48</div><div class='active'>50</div><div>52</div><div>54</div>
  </div>
          <a class='small align-right' href='#'>VIEW SIZE-CHART</a>
        </div>  
    </div>
            <div class='divider'></div>

          <div class='purchase-info'>
      <div class='price'>£399.00</div>
            <button>ADD TO CART</button>
    </div>
    </div>
  </div>
</div>
<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<body>
<div id="wrap">
  <div id="product_layout_3">
    <div class="product_image">
      <div class="main_image">
        <img src="https://i.imgur.com/YwqxBXc.jpg"/>
      </div>
    </div>
    <div class="product_desc">
      <h1>Cherry Bikini</h1>
      <span class="price">$75</span>
      <span class="sale_price">$50</span>
      <span class="stars"><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star-half"></i></span>
      <div class="product_options">
        <div class="select">
                 <select id="size">
                   <option value = "1">Small</option>
                   <option value = "2">Medium</option>
                   <option value = "3">Large</option>
                   <option value = "4">X-Large</option>
                 </select>
                 </div>
          </div>
          <div class="buying">
                 <div class="quantity">
                   <label for="quantity">QTY:</label>
                   <input type="text">
                 </div>
                 <div class="cart">
                   <a href="#" class="add">Add to Cart <i class="fa fa-shopping-cart fa-lg"></i></a>
                 </div>
          </div>
          <div class="other_options">
          <span class="SKU">SKU:12345</span>
          <span class="QTY">QTY:35</span>
          </div>
          <div class="description">
            <p>Excuse me. I'll call you tonight. Right. Yeah, I think maybe you do. Wait a minute, wait a minute, Doc, are you telling me that you built a time machine out of a delorean.</P>
            <p>Um, well it's a delorean, right? Yeah okay. Wow, ah Red, you look great. Everything looks great. 1:24, I still got time. Oh my god. No, no not again, c'mon, c'mon. Hey. Libyans. Yeah, well uh, lets keep this brain melting stuff to ourselves, okay? Yeah, yeah what are you wearing, Dave.</p>
            <p>Hey c'mon, I had to change, you think I'm going back in that zoot suit? The old man really came through it worked. You'll find out in thirty years. Can't be. This is nuts. Aw, c'mon. Hey guys, you gotta get back in there and finish the dance. Right, and where am I gonna be?</p>
        </div>
          <div class="social">
                   <span class="share">Share This:</span><span class="buttons"><img src="https://i.imgur.com/M8D8rr8.jpg"/></span>
           </div>
      </div>
      <div class="tabular">
        <ul class="tabs group">
          <li><a href="#/one">More Info</a></li>
          <li><a href="#/two">Reviews</a></li>
          <li><a class="active" href="#/three">Details</a></li>
        </ul>
          <div id="content">
            <aside id="one">
              <p>Excuse me. I'll call you tonight. Right. Yeah, I think maybe you do. Wait a minute, wait a minute, Doc, are you telling me that you built a time machine out of a delorean.</p>
              <p>Um, well it's a delorean, right? Yeah okay. Wow, ah Red, you look great. Everything looks great. 1:24, I still got time. Oh my god. No, no not again, c'mon, c'mon. Hey. Libyans. Yeah, well uh, lets keep this brain melting stuff to ourselves, okay? Yeah, yeah what are you wearing, Dave.</p>
               <p>Excuse me. I'll call you tonight. Right. Yeah, I think maybe you do. Wait a minute, wait a minute, Doc, are you telling me that you built a time machine out of a delorean.</p>
              <p>Um, well it's a delorean, right? Yeah okay. Wow, ah Red, you look great. Everything looks great. 1:24, I still got time. Oh my god. No, no not again, c'mon, c'mon. Hey. Libyans. Yeah, well uh, lets keep this brain melting stuff to ourselves, okay? Yeah, yeah what are you wearing, Dave.</p>
              <p>Excuse me. I'll call you tonight. Right. Yeah, I think maybe you do. Wait a minute, wait a minute, Doc, are you telling me that you built a time machine out of a delorean.</p>
              <p>Um, well it's a delorean, right? Yeah okay. Wow, ah Red, you look great. Everything looks great. 1:24, I still got time. Oh my god. No, no not again, c'mon, c'mon. Hey. Libyans. Yeah, well uh, lets keep this brain melting stuff to ourselves, okay? Yeah, yeah what are you wearing, Dave.</p>
            </aside>
            <aside id="two">
              <span class="author">Marty Mcfly</span><span class="stars"><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star-half"></i></span><p>"Excuse me. I'll call you tonight. Right. Yeah, I think maybe you do. Wait a minute, wait a minute, Doc, are you telling me that you built a time machine out of a delorean.</p>
              <p>Um, well it's a delorean, right? Yeah okay. Wow, ah Red, you look great. Everything looks great. 1:24, I still got time. Oh my god. No, no not again, c'mon, c'mon. Hey. Libyans. Yeah, well uh, lets keep this brain melting stuff to ourselves, okay? Yeah, yeah what are you wearing, Dave.</p>
              <p>Hey c'mon, I had to change, you think I'm going back in that zoot suit? The old man really came through it worked. You'll find out in thirty years. Can't be. This is nuts. Aw, c'mon. Hey guys, you gotta get back in there and finish the dance. Right, and where am I gonna be?"</p>
              <span class="full_review"><a href="#">Read The Full Review</a></span>
              <span class="write_review"><a href="#">Write Your Own Review</a></span>
            </aside>
            <aside id="three">
              <div class="images">
                <img src="https://i.imgur.com/U28rUlR.jpg"/>
                <img src="https://i.imgur.com/NK3026a.jpg"/>
                <img src="https://i.imgur.com/w1sfKNd.jpg"/>
                <img src="https://i.imgur.com/xeDUcdP.jpg"/>
              </div>
              <div class="details">
              <p>Excuse me. I'll call you tonight. Right. Yeah, I think maybe you do. Wait a minute, wait a minute, Doc, are you telling me that you built a time machine out of a delorean.</p>
              <p>Um, well it's a delorean, right? Yeah okay. Wow, ah Red, you look great. Everything looks great. 1:24, I still got time. Oh my god. No, no not again, c'mon, c'mon. Hey. Libyans. Yeah, well uh, lets keep this brain melting stuff to ourselves, okay? Yeah, yeah what are you wearing, Dave</p>
              </div>
              </aside>
          </div>
      </div>
    </div>
  </div>
</div>
  <main role="main">
  <article class="card-60 social">
    <figure>
      <a class="ribbon-buy popular" href="#" title="Popular">
      Hot
    </a>
      <img src="https://source.unsplash.com/ZFQh_gS5TJc/800x600" alt="La Sagrada Familia">
    </figure>
    <!-- end figure-->
    <div class="flex-content">
      <header>
        <p class="user">
           <a class="button follow" href="#" title="Follow">
          Follow
        </a>
          <img class="avatar-32" src="http://jlantunez.com/imgs/avatar.jpg" alt="Avatar">
          <strong>
          <a title="Full Name" href="#">
            username
          </a>
        </strong>
          <span>8 mins ago &middot; Barcelona</span>
        </p>
      </header>
      <h2>
Sagrada Familia .card-60
    </h2>
      <p>
        Figure 60%. Content 40%. Excerpt. 2-3 lines recommended. The style of la Sagrada Família is variously likened to Spanish Late Gothic, Catalan Modernism and to Art Nouveau or Catalan Noucentisme.
      </p>
      <footer>
        <p>
          <a class="bt-love" title="Love" href="#">
          Love
        </a>
          <a class="bt-comment" title="Comment" href="#">
          Comment
        </a>
        </p>
      </footer>
    </div>
    <!-- end .flex-content-->
  </article>
  <article class="card-50">
    <figure>
      <a href="" title="Buy">
      <span class="ribbon-buy">
      -20%
    </span>
      <img src="https://source.unsplash.com/GgEtIbD0hVo/800x600" alt="Nike Shoes">
      </a>
    </figure>
    <!-- end figure-->
    <div class="flex-content">
       <h2>
Nike RedPlus .card50 odd even
    </h2>
       <p class="user">
          <a class="button" href="#" title="Buy">
          Buy $90
        </a>
          <img class="avatar-32" src="http://jlantunez.com/imgs/avatar.jpg" alt="Avatar">
          <strong>
          <a title="Full Name" href="#">
            username
          </a>
        </strong>
          <span>16 mins ago &middot; Nike</span>
        </p>
      <ul>
        <li>
          <strong title="Type">Type:</strong>
            Soccer
        </li>
                <li><strong title="availability">Color:</strong> Red/Orange/Black/Blue</li>
                <li><strong title="Shipping">Shipping:</strong> Free</li>
              </ul>
       <p>
        Built for the ultimate playmaker, textured Flyknit fabric enables precise ball control. 
Dynamic Fit collar fits over the ankle
for a seamless, sock-like feel. Conical stud pattern delivers 360
degrees of rotational traction.

      </p>
      <footer>
        <p>
          <a class="bt-love" title="Love" href="">
          Love
        </a>
          <a class="bt-share" title="Share" href="#">
          Share
        </a>
          <a class="bt-comment" title="Comment" href="">
          Comment
        </a>
        </p>
      </footer>
    </div>
    <!-- end .flex-content-->
  </article>
  <article class="card-50">
    <figure>
      <a href="" title="Buy">
      <span class="ribbon-buy">
      -20%
    </span>
        
      </a>
       
         <img src="https://source.unsplash.com/XPvhzVIeETM/800x600" alt="Tapas"> 
    </figure>
    <!-- end figure-->
    <div class="flex-content">
       <h2>
Tapas Deluxe .card50 odd even
    </h2>
       <p class="subinfo">
         <a class="button" href="#" title="Book a table">
          Book a table
        </a>
            <a class="location" title="Location" href="">
          Cromwell Rd, London SW7 5BD.
      </a>
  
        </p>
      <ul>
        <li>
          <strong title="Type">Type:</strong>
          Spanish
        </li>
                <li><strong title="Rating">Rating:</strong> 8/10</li>
                <li><strong title="Price">Price:</strong> $30 and under</li>
              </ul>
       <p>
        Tapas are a wide variety of appetizers, or snacks, in Spanish cuisine. They may be cold (such as mixed olives and cheese) or hot (such as chopitos, which are battered, fried baby squid). In select bars in Spain, tapas have evolved into an entire, sophisticated cuisine.

      </p>

      
    </div>
    <!-- end .flex-content-->
  </article>
  <article class="card-40 social">
    <figure>
      <a class="ribbon-buy popular" href="#" title="Popular">
      Hot
    </a>
      <a href="/news/international/japan"><img src="https://source.unsplash.com/2TlAsvhqiL0/800x600" alt="Woman waiting metro"></a>
    </figure>
    <!-- end figure-->
    <div class="flex-content">
      <header>
        <p class="user">
          <a class="button" href="#" title="Share">
          Share
        </a>
          <img class="avatar-32" src="http://jlantunez.com/imgs/avatar.jpg" alt="Avatar">
          <strong>
          <a title="Full Name" href="#">
            username
          </a>
        </strong>
          <span><a href="" title="Permalink">8 mins ago</a> &middot; <a href="" title="258 comments">258 comments</a></span>
        </p>
      </header>
      <a href=""><h2>
        The Tokyo Mistery .card-40
    </h2>
      <p>
         Excerpt. 2-3 lines recommended. Police are investigating the theft of hundreds of straps used by standing passengers on the Tokyo Metro system, it's been reported. Tokyo Metro Co. is providing a free smartphone application to help foreigners navigate the capital's subway system.
      </p></a>
    </div>
    <!-- end .flex-content-->
  </article>
  <article class="card-60 social">
    <figure>
      <a class="ribbon-buy popular" href="#" title="Popular">
      Hot
    </a>
      <img src="https://source.unsplash.com/yvx7LSZSzeo/800x600" alt="Woman playing guitar">
    </figure>
    <!-- end figure-->
    <div class="flex-content">
      <header>
        <p class="user">
          <a class="button followed" href="#">
          Followed
        </a>
          <img class="avatar-32" src="http://jlantunez.com/imgs/avatar.jpg" alt="Avatar">
          <strong>
          <a title="Full Name" href="#">
            username
          </a>
        </strong>
          <span>32 mins ago &middot; London</span>
        </p>
      </header>
      <h2>
      Card-60 Fender Stratocaster
    </h2>
      <p>
        2-3 lines recommended. The culture within an organization is an essential part for success. The Fender Stratocaster is a model of electric guitar designed in 1954 by Leo Fender, Bill Carson, George Fullerton, and Freddie Tavares.
      </p>
      <footer>
        <p>
          <a class="bt-love" title="Love" href="#">
          Love
        </a>

          <a class="bt-comment" title="Comment" href="#">
          Comment
        </a>
        </p>
      </footer>
    </div>
    <!-- end .flex-content-->
  </article>
  <p>Photos: <a href="https://source.unsplash.com/">Unsplash</a>.</p>
</main>
<div class="wrapper">
  <div class="desc">
    <h1>Ecommerce product list/grid</h1>
    <p>Simple html/css  ecommerce product grid with a hover effect.</p>

    <div class="todo">
      <span>TODO list:</span>
      <ul>
        <li>Make it responsive folk!</li>
      </ul>
    </div>
  </div>

  <div class="content">
    <!-- content here -->
    <div class="product-grid product-grid--flexbox">
      <div class="product-grid__wrapper">
        <!-- Product list start here -->

        <!-- Single product -->
        <div class="product-grid__product-wrapper">
          <div class="product-grid__product">
            <div class="product-grid__img-wrapper">     
              <img src="https://images.apple.com/euro/macbook/a/screens/specs/images/finish_silver_large.jpg" alt="Img" class="product-grid__img" />
            </div>
            <span class="product-grid__title">Product title</span>
            <span class="product-grid__price">1.399€</span>
            <div class="product-grid__extend-wrapper">
              <div class="product-grid__extend">
                <p class="product-grid__description">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Perferendis velit itaque odit.</p>
                <span class="product-grid__btn product-grid__add-to-cart"><i class="fa fa-cart-arrow-down"></i> Add to cart</span>        
                <span class="product-grid__btn product-grid__view"><i class="fa fa-eye"></i> View more</span>
              </div>
            </div>
          </div>
        </div>
        <!-- end Single product -->

        <div class="product-grid__product-wrapper">
          <div class="product-grid__product">
            <div class="product-grid__img-wrapper">     
              <img src="https://images.apple.com/euro/macbook/a/screens/specs/images/finish_silver_large.jpg" alt="Img" class="product-grid__img" />
            </div>
            <span class="product-grid__title">Product title</span>
            <span class="product-grid__price">1.399€</span>
            <div class="product-grid__extend-wrapper">
              <div class="product-grid__extend">
                <p class="product-grid__description">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Perferendis velit itaque odit.</p>
                <span class="product-grid__btn product-grid__add-to-cart"><i class="fa fa-cart-arrow-down"></i> Add to cart</span>        
                <span class="product-grid__btn product-grid__view"><i class="fa fa-eye"></i> View more</span>
              </div>
            </div>
          </div>
        </div>

        <div class="product-grid__product-wrapper">
          <div class="product-grid__product">
            <div class="product-grid__img-wrapper">     
              <img src="https://images.apple.com/euro/macbook/a/screens/specs/images/finish_silver_large.jpg" alt="Img" class="product-grid__img" />
            </div>
            <span class="product-grid__title">Product title</span>
            <span class="product-grid__price">1.399€</span>
            <div class="product-grid__extend-wrapper">
              <div class="product-grid__extend">
                <p class="product-grid__description">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Perferendis velit itaque odit.</p>
                <span class="product-grid__btn product-grid__add-to-cart"><i class="fa fa-cart-arrow-down"></i> Add to cart</span>        
                <span class="product-grid__btn product-grid__view"><i class="fa fa-eye"></i> View more</span>
              </div>
            </div>
          </div>
        </div>

        <div class="product-grid__product-wrapper">
          <div class="product-grid__product">
            <div class="product-grid__img-wrapper">     
              <img src="https://images.apple.com/euro/macbook/a/screens/specs/images/finish_silver_large.jpg" alt="Img" class="product-grid__img" />
            </div>
            <span class="product-grid__title">Product title</span>
            <span class="product-grid__price">1.399€</span>
            <div class="product-grid__extend-wrapper">
              <div class="product-grid__extend">
                <p class="product-grid__description">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Perferendis velit itaque odit.</p>
                <span class="product-grid__btn product-grid__add-to-cart"><i class="fa fa-cart-arrow-down"></i> Add to cart</span>        
                <span class="product-grid__btn product-grid__view"><i class="fa fa-eye"></i> View more</span>
              </div>
            </div>
          </div>
        </div>

        <div class="product-grid__product-wrapper">
          <div class="product-grid__product">
            <div class="product-grid__img-wrapper">     
              <img src="https://images.apple.com/euro/macbook/a/screens/specs/images/finish_silver_large.jpg" alt="Img" class="product-grid__img" />
            </div>
            <span class="product-grid__title">Product title</span>
            <span class="product-grid__price">1.399€</span>
            <div class="product-grid__extend-wrapper">
              <div class="product-grid__extend">
                <p class="product-grid__description">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Perferendis velit itaque odit.</p>
                <span class="product-grid__btn product-grid__add-to-cart"><i class="fa fa-cart-arrow-down"></i> Add to cart</span>        
                <span class="product-grid__btn product-grid__view"><i class="fa fa-eye"></i> View more</span>
              </div>
            </div>
          </div>
        </div>

        <div class="product-grid__product-wrapper">
          <div class="product-grid__product">
            <div class="product-grid__img-wrapper">     
              <img src="https://images.apple.com/euro/macbook/a/screens/specs/images/finish_silver_large.jpg" alt="Img" class="product-grid__img" />
            </div>
            <span class="product-grid__title">Product title</span>
            <span class="product-grid__price">1.399€</span>
            <div class="product-grid__extend-wrapper">
              <div class="product-grid__extend">
                <p class="product-grid__description">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Perferendis velit itaque odit.</p>
                <span class="product-grid__btn product-grid__add-to-cart"><i class="fa fa-cart-arrow-down"></i> Add to cart</span>        
                <span class="product-grid__btn product-grid__view"><i class="fa fa-eye"></i> View more</span>
              </div>
            </div>
          </div>
        </div>

        <div class="product-grid__product-wrapper">
          <div class="product-grid__product">
            <div class="product-grid__img-wrapper">     
              <img src="https://images.apple.com/euro/macbook/a/screens/specs/images/finish_silver_large.jpg" alt="Img" class="product-grid__img" />
            </div>
            <span class="product-grid__title">Product title</span>
            <span class="product-grid__price">1.399€</span>
            <div class="product-grid__extend-wrapper">
              <div class="product-grid__extend">
                <p class="product-grid__description">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Perferendis velit itaque odit.</p>
                <span class="product-grid__btn product-grid__add-to-cart"><i class="fa fa-cart-arrow-down"></i> Add to cart</span>        
                <span class="product-grid__btn product-grid__view"><i class="fa fa-eye"></i> View more</span>
              </div>
            </div>
          </div>
        </div>

        <div class="product-grid__product-wrapper">
          <div class="product-grid__product">
            <div class="product-grid__img-wrapper">     
              <img src="https://images.apple.com/euro/macbook/a/screens/specs/images/finish_silver_large.jpg" alt="Img" class="product-grid__img" />
            </div>
            <span class="product-grid__title">Product title</span>
            <span class="product-grid__price">1.399€</span>
            <div class="product-grid__extend-wrapper">
              <div class="product-grid__extend">
                <p class="product-grid__description">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Perferendis velit itaque odit.</p>
                <span class="product-grid__btn product-grid__add-to-cart"><i class="fa fa-cart-arrow-down"></i> Add to cart</span>        
                <span class="product-grid__btn product-grid__view"><i class="fa fa-eye"></i> View more</span>
              </div>
            </div>
          </div>
        </div>

        <div class="product-grid__product-wrapper">
          <div class="product-grid__product">
            <div class="product-grid__img-wrapper">     
              <img src="https://images.apple.com/euro/macbook/a/screens/specs/images/finish_silver_large.jpg" alt="Img" class="product-grid__img" />
            </div>
            <span class="product-grid__title">Product title</span>
            <span class="product-grid__price">1.399€</span>
            <div class="product-grid__extend-wrapper">
              <div class="product-grid__extend">
                <p class="product-grid__description">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Perferendis velit itaque odit.</p>
                <span class="product-grid__btn product-grid__add-to-cart"><i class="fa fa-cart-arrow-down"></i> Add to cart</span>        
                <span class="product-grid__btn product-grid__view"><i class="fa fa-eye"></i> View more</span>
              </div>
            </div>
          </div>
        </div>
      </div>    
    </div>
  </div>

  <footer>
    <a target="_blank" href="https://twitter.com/ricardpanades">@ricardpanades</a>
  </footer>
</div>
<div class="wrap">
  <ul class="grid grid-sm-2 grid-lg-4">
      <li>
      <div class="cat-item">
        <div class="item-header">
          <a href="" class="item-img">
            <img src="http://placehold.it/242x242" alt="" />
          </a>
          <a href="" class="item-img-zoom btn btn-secondary btn-circle"  title="Zoom In">
            <span class="fa fa-search-plus"></span>
          </a>
        </div>
        <div class="item-body">
          <h4 class="item-title">Original Mini Rawhide Chew Bones</h4>
          <div class="item-size">24 Pack</div>
          <div class="item-rating rating">
            <ul class="item-stars rating-stars">
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star-half-o"></span></li>
              <li><span class="fa fa-star-o"></span></li>
            </ul>
            <span class="item-rating-no rating-no small">300</span>
          </div>
          <div class="item-price h4">
            $10.99 - $12.99
          </div>
        </div>
        <a href="" class="btn btn-primary btn-expanded">Buy Now</a>
      </div> 
      </li>
      <li>
      <div class="cat-item">
        <div class="item-header">
          <a href="" class="item-img">
            <img src="http://placehold.it/242x242" alt="" />
          </a>
          <a href="" class="item-img-zoom btn btn-secondary btn-circle"  title="Zoom In">
            <span class="fa fa-search-plus"></span>
          </a>
        </div>
        <div class="item-body">
          <h4 class="item-title">Original Mini Rawhide Chew Bones</h4>
          <div class="item-size">24 Pack</div>
          <div class="item-rating rating">
            <ul class="item-stars rating-stars">
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star-half-o"></span></li>
              <li><span class="fa fa-star-o"></span></li>
            </ul>
            <span class="item-rating-no rating-no small">300</span>
          </div>
          <div class="item-price h4">
            $10.99 - $12.99
          </div>
        </div>
        <a href="" class="btn btn-primary btn-expanded">Buy Now</a>
      </div> 
      </li>
      <li>
      <div class="cat-item">
        <div class="item-header">
          <a href="" class="item-img">
            <img src="http://placehold.it/242x242" alt="" />
          </a>
          <a href="" class="item-img-zoom btn btn-secondary btn-circle"  title="Zoom In">
            <span class="fa fa-search-plus"></span>
          </a>
        </div>
        <div class="item-body">
          <h4 class="item-title">Original Mini Rawhide Chew Bones</h4>
          <div class="item-size">24 Pack</div>
          <div class="item-rating rating">
            <ul class="item-stars rating-stars">
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star-half-o"></span></li>
              <li><span class="fa fa-star-o"></span></li>
            </ul>
            <span class="item-rating-no rating-no small">300</span>
          </div>
          <div class="item-price h4">
            $10.99 - $12.99
          </div>
        </div>
        <a href="" class="btn btn-primary btn-expanded">Buy Now</a>
      </div> 
      </li>
      <li>
      <div class="cat-item">
        <div class="item-header">
          <a href="" class="item-img">
            <img src="http://placehold.it/242x242" alt="" />
          </a>
          <a href="" class="item-img-zoom btn btn-secondary btn-circle"  title="Zoom In">
            <span class="fa fa-search-plus"></span>
          </a>
        </div>
        <div class="item-body">
          <h4 class="item-title">Original Mini Rawhide Chew Bones</h4>
          <div class="item-size">24 Pack</div>
          <div class="item-rating rating">
            <ul class="item-stars rating-stars">
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star-half-o"></span></li>
              <li><span class="fa fa-star-o"></span></li>
            </ul>
            <span class="item-rating-no rating-no small">300</span>
          </div>
          <div class="item-price h4">
            $10.99 - $12.99
          </div>
        </div>
        <a href="" class="btn btn-primary btn-expanded">Buy Now</a>
      </div> 
      </li>
      <li>
      <div class="cat-item">
        <div class="item-header">
          <a href="" class="item-img">
            <img src="http://placehold.it/242x242" alt="" />
          </a>
          <a href="" class="item-img-zoom btn btn-secondary btn-circle"  title="Zoom In">
            <span class="fa fa-search-plus"></span>
          </a>
        </div>
        <div class="item-body">
          <h4 class="item-title">Original Mini Rawhide Chew Bones</h4>
          <div class="item-size">24 Pack</div>
          <div class="item-rating rating">
            <ul class="item-stars rating-stars">
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star-half-o"></span></li>
              <li><span class="fa fa-star-o"></span></li>
            </ul>
            <span class="item-rating-no rating-no small">300</span>
          </div>
          <div class="item-price h4">
            $10.99 - $12.99
          </div>
        </div>
        <a href="" class="btn btn-primary btn-expanded">Buy Now</a>
      </div> 
      </li>
      <li>
      <div class="cat-item">
        <div class="item-header">
          <a href="" class="item-img">
            <img src="http://placehold.it/242x242" alt="" />
          </a>
          <a href="" class="item-img-zoom btn btn-secondary btn-circle"  title="Zoom In">
            <span class="fa fa-search-plus"></span>
          </a>
        </div>
        <div class="item-body">
          <h4 class="item-title">Original Mini Rawhide Chew Bones</h4>
          <div class="item-size">24 Pack</div>
          <div class="item-rating rating">
            <ul class="item-stars rating-stars">
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star"></span></li>
              <li><span class="fa fa-star-half-o"></span></li>
              <li><span class="fa fa-star-o"></span></li>
            </ul>
            <span class="item-rating-no rating-no small">300</span>
          </div>
          <div class="item-price h4">
            $10.99 - $12.99
          </div>
        </div>
        <a href="" class="btn btn-primary btn-expanded">Buy Now</a>
      </div> 
      </li>
  </ul>
  
  <div class="overlay-bg"></div>
  <div class="overlay-wrap">
    <a href="" class="btn btn-secondary btn-circle overlay-close">
      <span class="fa fa-times-circle-o"></span>
    </a>
    <div class="overlay item-preview">
      <div class="preview-img">
        <div class="slider">
            <div><img src="http://placehold.it/327x350/227dd5/fff" alt="" /></div>
            <div><img src="http://placehold.it/327x350/22d57b/fff" alt="" /></div>
            <div><img src="http://placehold.it/327x350/3e22d5/fff" alt="" /></div>
            <div><img src="http://placehold.it/327x350/d57922/fff" alt="" /></div>
          </div>
      </div>
      <div class="preview-body">
        <h4 class="preview-title">Original Mini Rawhide Chew Bones</h4>
        <div class="preview-rating rating">
          <ul class="preview-stars rating-stars">
            <li><span class="fa fa-star"></span></li>
            <li><span class="fa fa-star"></span></li>
            <li><span class="fa fa-star"></span></li>
            <li><span class="fa fa-star-half-o"></span></li>
            <li><span class="fa fa-star-o"></span></li>
          </ul>
          <span class="preview-rating-no rating-no small">300</span>
        </div>
        <div class="preview-price h4">
          $10.99 - $12.99
        </div>
        <div class="row">
          <div class="col col-lg-3-4">
            <label for="size">Size</label>
            <select name="size" id="size">
              <option value="single">Individual</option>
              <option value="case">Full Case (6 units)</option>
            </select>
          </div>
          <div class="col col-lg-1-4">
            <label for="qty">Quantity</label>
            <input type="number" min="0" max="25" name="qty"/>
          </div>
        </div>
        <a href="" class="btn btn-primary">Add to Cart</a>
      </div>
    </div>
  </div>
</div>
<section id="screen1">

  <p>Scroll down</p>

  <nav>
     <ul>
   <li><a href="#">Home</a></li>
        <li><a href="#">About</a></li>
        <li><a href="#">Services</a></li>
        <li><a href="#">Team</a></li>
        <li><a href="#">Contact</a></li>
     </ul>
  </nav>

</section>

<section id="screen2"></section>
<section id="screen3"></section>
<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<body>
  <div id="wrap">
    <div id="cart_layout_1">
      <h1>Shopping Cart</h1>
      <div class="cart_info">
        <div class="product">
          <img src="https://i.imgur.com/b59w7Io.jpg"/>
        </div>
        <div class="product_info">
          <div class="center">
            <span>Skull Shirt</span><span>Yellow</span><span>Small</span>
          </div>
        </div>
        <div class="details">
          <div class="qty">
            <div class="center">
            <span>QTY:</span><input type="text"></input>
          </div>
          </div>
          <div class="price">
            <div class="center">
            <span>$24.99</span>
            </div>
          </div>
          <div class="remove">
            <div class="center">
              <span class="hidden">Remove</span><i class="fa fa-times-circle fa-4"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="complete_cart">
        <div class="updated">
        <div class="shipping">
          <h2>Shipping Estimate</h2>
          <div class="state">
            <select id="state">
                   <option value = "1">Alabama</option>
                   <option value = "2">Alaska</option>
                   <option value = "3">Arizona</option>
                   <option value = "4">Etc.</option>
                 </select>
          </div>
          <div class="zip">
            <input type="text"></input>
          </div>
          <div class="calc">
            <a class="button" href="#">Calculate</a>
          </div>
        </div>
        <div class="coupon">
          <h2>Coupon Code</h2>
          <input id="code"></input>
        <a class="button update">Update Cart</a>
        </div>
        </div>
        <div class="checkout">
          <div class="total">
          <h2>Subtotal:</h2>
          <span class="sub">
            <small>Excluding Tax and Shipping</small>
          </span>
          </div>
          <span class="subtotal">
            $24.99
          </span>
          <div class="bfb">
            <a class="button" href="#">Checkout</a>
          </div>
        </div>
         <div class="updated mobile">
        <div class="shipping">
          <h2>Shipping Estimate</h2>
          <div class="state">
            <select id="state">
                   <option value = "1">Alabama</option>
                   <option value = "2">Alaska</option>
                   <option value = "3">Arizona</option>
                   <option value = "4">Etc.</option>
                 </select>
          </div>
          <div class="zip">
            <input type="text"></input>
          </div>
          <div class="calc">
            <a class="button" href="#">Calculate</a>
          </div>
        </div>
        <div class="coupon">
          <h2>Coupon Code</h2>
          <input id="code"></input>
        <a class="button update">Update Cart</a>
        </div>
        </div>
        </div>
      </div>
    </div>
  </div>
</body>
<!DOCTYPE html>
<html>
<head> 
    <title>Coder</title>
    <meta charset="utf-8">
    <!-- Standard Coder Includes -->
    <script>
        var appname = "{{app_name}}"; //app name (id) of this app
        var appurl = "{{&app_url}}";
        var staticurl = "{{&static_url}}"; //base path to your static files /static/apps/yourapp
    </script>
    <link href="/static/apps/coderlib/css/index.css" media="screen" rel="stylesheet" type="text/css"/>
    <script src="/static/common/js/jquery.min.js"></script>
    <script src="/static/common/ace-min/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="/static/apps/coderlib/js/index.js"></script>
    <script>
        Coder.addBasicNav();
    </script>
    <!-- End Coder Includes -->

    <!-- This app's includes -->
    <link href="{{&static_url}}/css/index.css" media="screen" rel="stylesheet" type="text/css"/>
    <script src="{{&static_url}}/js/index.js"></script>
    <!-- End apps includes -->
</head>
<body class="">
    <div class="pagecontent">
        <h1>The Perfect PB&amp;J</h1>
        <hr />
        <img src="/static/apps/the_perfect_sandwich/media/the_perfect_pbj.jpg" height="400px" width="700px"  />
        <hr />
        <h2>Description</h2>
        <p>This peanut butter and jelly sandwich is my favorite sandwich. It has the perfect balance of ingredients and looks great when made right.</p>
        <hr />
        <h2>Ingredients</h2>
        <ul>
            <li>2 slices of white bread</li>
            <li>1 jar of grape jelly</li>
            <li>1 jar of creamy peanut butter</li>
            <li>A butter knife</li>
            <li>A sharp knife</li>
            <li>A cutting board</li>
        </ul>
        <hr />
        <h2>Directions</h2>
        <ol>
            <li>Lay both slices of bread next to each other on a cutting board.</li>
            <li>With the butter knife, spread a 1/8 inch layer of peanut butter on the left side</li>
            <li>On the right side, spread a 1/8 inch layer of jelly.</li>
            <li>Carefully place the two halves together so that the jelly is on top.</li>
            <li>With the sharp knife, carefully cut the sandwich in half.</li>
            <li>Enjoy the PB&amp;J!</li>
        </ol>
    </div>
</body>
</html>
<!DOCTYPE html>
<html>
<head> 
    <title>Coder</title>
    <meta charset="utf-8">
    <!-- Standard Coder Includes -->
    <script>
        var appname = "{{app_name}}"; //app name (id) of this app
        var appurl = "{{&app_url}}";
        var staticurl = "{{&static_url}}"; //base path to your static files /static/apps/yourapp
    </script>
    <link href="/static/apps/coderlib/css/index.css" media="screen" rel="stylesheet" type="text/css"/>
    <script src="/static/common/js/jquery.min.js"></script>
    <script src="/static/common/ace-min/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="/static/apps/coderlib/js/index.js"></script>
    <script>
        Coder.addBasicNav();
    </script>
    <!-- End Coder Includes -->

    <!-- This app's includes -->
    <link href="{{&static_url}}/css/index.css" media="screen" rel="stylesheet" type="text/css"/>
    <script src="{{&static_url}}/js/index.js"></script>
    <!-- End apps includes -->
</head>
<body>
    <div id="page">
        <div id="titleblock">
            <h1>Operation Windmill</h1>
            <h2>Words by John Q. Public, Pictures from the Smithsonian Institution Archives</h2>
        </div>
        <div id="panel1">
            <div class="narration top left infront">Captian’s Log, Dec 15, 1947:<br>It’s cold here in the Antartic. </div>
            <div class="bigtext bottom right infront">BRRRRRRRR</div>
            <img src= "/static/apps/comic_complete/media/landscape.jpg" id="image1" class="inback">
        </div>
      
        <div id="panel2">
            <div class="narration bottom left infront">The cool sleds we wanted <br> finally came.</div>
            <div class="bigtext top left infront">RAD SLEDS!</div>
            <img src= "/static/apps/comic_complete/media/sleds.jpg" id="image2"  class ="inback">
        </div>
        <div id="panel3">
            <div class="narration top right infront">Everyone was really excited and started <br> fighting to see who would ride first.</div>
            <div class="bigtext bottom left inmiddle">ME FIRST!<br>ME FIRST!<br>ME FIRST!<br>ME FIRST!<br>ME FIRST!<br>ME FIRST!<br>ME FIRST!<br>ME FIRST!</div>
            <img src= "/static/apps/comic_complete/media/running.jpg" id="image3" class ="inback">
        </div>
        <div id="panel4">
            <div class="narration bottom left infront">Fortunantly, this cool penguin <br> showed up and calmed us down.</div>
            <div class="bigtext top left infront">CHILL OUT, GUYS…</div>
            <img src= "/static/apps/comic_complete/media/penguin.jpg" id="image4" class ="inback">
        </div>
        <div id="panel5">
            <div class="narration top left infront">She introduced us <br> to her new baby.</div>
            <div class="narration bottom right infront">The End!</div>
            <img src= "/static/apps/comic_complete/media/baby.jpg" id="image5" class ="inback">
        </div>
    </div>
</body>
</html>
<!DOCTYPE html>
<html>
<head> 
    <title>Coder</title>
    <meta charset="utf-8">
    <!-- Standard Coder Includes -->
    <script>
        var appname = "{{app_name}}"; //app name (id) of this app
        var appurl = "{{&app_url}}";
        var staticurl = "{{&static_url}}"; //base path to your static files /static/apps/yourapp
    </script>
    <link href="/static/apps/coderlib/css/index.css" media="screen" rel="stylesheet" type="text/css"/>
    <script src="/static/common/js/jquery.min.js"></script>
    <script src="/static/common/ace-min/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="/static/apps/coderlib/js/index.js"></script>
    <script>
        Coder.addBasicNav();
    </script>
    <!-- End Coder Includes -->

    <!-- This app's includes -->
    <link href="{{&static_url}}/css/index.css" media="screen" rel="stylesheet" type="text/css"/>
    <script src="{{&static_url}}/js/index.js"></script>
    <!-- End apps includes -->
</head>
<body>
    <div id= "orb" class= "sun">
        <div id= "moonspot1"></div>
        <div id= "moonspot2"></div>
        <div id= "moonspot3"></div>
    </div>
    <div id= "sky" class= "day"></div>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
<title>Contacts Widget: Shadow DOM Example</title>
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:700|Droid+Sans+Mono|Ovo" type="text/css">
<link rel="stylesheet" href="../assets/styles/main.css" type="text/css">
<link rel="stylesheet" href="../assets/styles/prettify.css" type="text/css" />
<script src="../assets/scripts/bug-assist.js"></script>
<script src="../assets/scripts/prettify.js"></script>
<meta name="bug.blocked" content="14956">
<meta name="bug.short_desc" content="[Samples]: ">
<meta name="bug.product" content="WebAppsWG">
<meta name="bug.component" content="Component Model">
</head>
<body>
<header>
<ul>
    <li><a href="../samples/index.html">Samples</a></li>
    <li><a href="../explainer/index.html">Explainer</a></li>
    <li><a href="../spec/shadow/index.html">Shadow DOM Spec</a></li>
    <li><a href="../spec/templates/index.html">HTML Templates</a></li>
</ul>
<h1>Contacts Widget</h1>
</header>
<p>Rajesh is sad. It's the third time this month that he had to fix the continuous build of their company's flagship product, the <em>Socia1eet</em>, and all for the same reason: the spurious tweaking of the contacts widget. It certainly appears that some of his coworkers are unable to learn a simple rule: <strong>don't change the DOM of the contacts widget outside of the widget's code</strong>.</p>
<p>Never mind the unit tests. Never mind constant nagging. Whenever Rajesh, whether fixing a bug or adding a feature, pushes an update for the widget, things break. Last time it was Howard, who&mdash;in his theming code&mdash;thought he could add an extra class on each userpic in the widget. Before then it was Amy, who decided to grab contents of a label in the widget by traversing DOM (!) in the initialization code (!!). Whosoever it is, touching the widget DOM structure is somewhat like opening a box of chocolate. <q>Except instead of chocolate, it's landmines</q>, remarks Rajesh bitterly. <q>Tiny, chocolate-covered landmines</q>.</p>
<p>&hellip; And then he remembers reading something about the <a href="../spec/shadow/index.html">Shadow DOM</a>, the Web platform capability that enables functional encapsulation. Rajesh races forward with the idea. He realizes that, in fact, his widget is really a self-contained unit of DOM, and treating it as a single element would be a much saner point of view for his colleagues. Moreover, since only the widget code can construct this unit of DOM, making changes to the widget's structure would <em>require</em> them to be done from the widget code. <q>This is going to be fun</q>, thinks Raj.</p>
<p>The current code in <code>/src/ui/widgets/contacts.js</code> looks like this (some parts skipped for clarity):</p>

<pre class="prettyprint"><code>
var ui = ui || {};
ui.widgets = ui.widgets || {};

(function() {
    var MAX_USERS = 8;

    function Contacts()
    {
        this.element = document.createElement('div');
        this.element.className = 'contacts widget';
        var users = this.element.appendChild(document.createElement('ul'));
        this.loadUsers(MAX_USERS, function(user) {
            var li = document.createElement('li');
            // Populate [li] with data from the [user] object.
            // &hellip;
        });
    }

    // &hellip;

    // Asynchronously loads users from server and invokes [callback] for each user loaded
    Contacts.prototype.loadUsers = function(userCount, callback)
    {
        // &hellip;
    }

    // &hellip;

    ui.widgets.Contacts = Contacts;

})();
</code></pre>

<p>At runtime, the widget is instantiated as <code>new ui.widgets.Contacts()</code>, and produces the following DOM structure, shown here as HTML markup:

<pre class="prettyprint"><code>
&lt;div class=&quot;contacts widget&quot;&gt;
    &lt;ul&gt;
        &lt;li&gt;&hellip;&lt;/li&gt;
        &hellip;
    &lt;/ul&gt;
&lt;/div&gt;
</code></pre>

<p>What Rajesh wants is a clear line between the <code class="prettyprint">&lt;div class=&quot;contacts widget&quot;&gt;</code> and the <code class="prettyprint">&lt;ul&gt;</code>, which stops Amys and Howards from mucking with the enclosed structure outside of <code>/src/ui/widgets/contacts.js</code>:</p>

<pre class="prettyprint"><code>
&lt;div class=&quot;contacts widget&quot;&gt;
    &lt;#they-shall-not-pass&gt;
        &lt;ul&gt;
            &lt;li&gt;&hellip;&lt;/li&gt;
            &hellip;
        &lt;/ul&gt;
    &lt;#they-shall-not-pass&gt;
&lt;/div&gt;
</code></pre>

<p>Here, Rajesh recognizes a near-perfect description of the <a href="../spec/shadow/index.html">shadow DOM subtree</a>. <q>So, all I need to do is create a <code>ShadowRoot</code> with <code>this.element</code> as its host and append UI elements to it, instead of <code>this.element</code></q>, he summarizes, fingers dancing on the keyboard. The actual change is just a handful of characters:</p>

<pre class="prettyprint"><code>

function Contacts()
{
    this.element = document.createElement('div');
    this.element.className = 'contacts widget';
    <ins>var shadow = new ShadowRoot(this.element);</ins>
    var users = <del>this.element</del><ins>shadow</ins>.appendChild(document.createElement('ul'));
    this.loadUsers(MAX_USERS, function(user) {
        var li = document.createElement('li');
        // Populate [li] with data from the [user] object.
        // &hellip;
    });
}
</code></pre>

<p>To keep theme engine's stylesheets working, Raj flips the <a href="../spec/shadow/index.html#api-shadow-root-apply-author-styles"><code>applyAuthorStyles</code></a> flag, thus letting the document stylesheets apply in the shadow DOM:</p>

<pre class="prettyprint"><code>

    this.element.className = 'contacts widget';
    var shadow = new ShadowRoot(this.element);
    <ins>shadow.applyAuthorStyles = true;</ins>
    var users = shadow.appendChild(document.createElement('ul'));

</code></pre>

<p>Checking the DOM tree reveals that <em>now</em> the contacts widget looks and acts as a single DOM element in a document tree:</p>

<pre class="prettyprint"><code>
&lt;div class=&quot;contacts widget&quot;&gt;&lt;/div&gt;
</code></pre>

<p>The widget UI code is safely tucked away in a shadow DOM subtree, making it brittle no more. You can create and add the widget to the document, you can move it around, but to make changes to widget DOM structure, you <em>have to</em> make them in <code>/src/ui/widgets/contacts.js</code>. And, thanks to the new code owners management tooling, any code changes to that file will need Raj's nod before landing.</p>

<p>Sensing undeniable win, Rajesh decides to join his friends for dinner. It's Pizza Thursday, and nothing punctuates a win better than a slice of italian pie.</p>


</body>
</html>
<!DOCTYPE html>
<html>
<head>
<title>Web Components Examples: Entry Helper</title>
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:700|Droid+Sans+Mono|Ovo" type="text/css">
<link rel="stylesheet" href="../assets/styles/main.css" type="text/css">
<link rel="stylesheet" href="../assets/styles/prettify.css" type="text/css" />
<script src="../assets/scripts/bug-assist.js"></script>
<script src="../assets/scripts/prettify.js"></script>
<meta name="bug.blocked" content="14956">
<meta name="bug.short_desc" content="[Samples]: ">
<meta name="bug.product" content="WebAppsWG">
<meta name="bug.component" content="Component Model">
</head>
<body>
<header>
<ul>
    <li><a href="../samples/index.html">Samples</a></li>
    <li><a href="../explainer/index.html">Explainer</a></li>
    <li><a href="../spec/shadow/index.html">Shadow DOM Spec</a></li>
    <li><a href="../spec/templates/index.html">HTML Templates</a></li>
</ul>
<h2>Web Components Example</h2>
<h1>Entry Helper</h1>
</header>
<pre class="prettyprint"><code>
&lt;element extends=&quot;input&quot; name=&quot;x-entry-helper&quot;&gt;
    &lt;script&gt;
        this.lifecycle({
            create: function(shadowRoot) {
                if (this.type != &#x27;text&#x27;)
                    return;
                this._options = shadowRoot.querySelector(&#x27;ul&#x27;);
                this.setAttribute(&#x27;autocomplete&#x27;, &#x27;off&#x27;);
                document.addEventListemer(&#x27;keydown&#x27;, this._handleKeyDownEvent);
                document.addEventListener(&#x27;mouseup&#x27;, this._handleMouseUpEvent);
            }
        });

        var Helper = this.generatedConstructor;
        Helper.prototype._handleKeyDownEvent = function(evt)
        {
            if (evt.currentTarget.parentNode == this._options) {
                this._selectOption(evt.currentTarget);
            } else if (evt.currentTarget == this) {
                if (!this._open)
                    this.open();
                this.populate();
            // ...
            } else {
                this.close();
            }
        }

        Helper.prototype._handleMouseUpEvent = function(evt)
        {
            if (evt.currentTarget == this) {
            // ...
            } else {
                this.close();
            }
        }

        Helper.prototype._settingsChanged = function()
        {
            if (!this._open)
                return;

            this.populate();
        }

        Helper.prototype.clear = function()
        {
            // clear helper window&#x27;s contents.
        }

        Helper.prototype.populate = function()
        {
            this.clear();
            // populate helper window using current settings.
        }

        Helper.prototype.open = function()
        {
            if (this._open)
                return;
            else
                this._options.style.display = &#x27;&#x27;;

            // Show entry helper window and attempt completion match.
            // ..

            this._open = true;
            this.dispatchEvent(new Event(&#x27;helperopen&#x27;));
        }

        Helper.prototype.close = function()
        {
            // close entry helper.
        }

        this.reflectAttribute(&#x27;x-highlight-matches&#x27;, &#x27;highlightMatches&#x27;, Helper.prototype._settingsChanged);
        this.reflectAttribute(&#x27;list&#x27;, &#x27;list&#x27;, Helper.prototype._settingsChanged);
        this.setupEvent(&#x27;helperopen&#x27;);
    &lt;/script&gt;
    &lt;template&gt;
        &lt;style scoped&gt;
            ul {
                width: 200px;
                height: 200px;
                position: absolute;
                /* ... */
            }
            /* ... */
        &lt;/style&gt;
        &lt;div&gt;
            &lt;shadow&gt;&lt;/shadow&gt;
            &lt;ul&gt;&lt;/ul&gt;
        &lt;/div&gt;
    &lt;/template&gt;
&lt;/element&gt;
</code></pre>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
<title>Web Components Examples</title>
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:700|Droid+Sans+Mono|Ovo" type="text/css">
<link rel="stylesheet" href="../assets/styles/main.css" type="text/css">
<link rel="stylesheet" href="../assets/styles/prettify.css" type="text/css" />
<script src="../assets/scripts/bug-assist.js"></script>
<meta name="bug.blocked" content="14956">
<meta name="bug.short_desc" content="[Samples]: ">
<meta name="bug.product" content="WebAppsWG">
<meta name="bug.component" content="Component Model">
</head>
<body>
<header>
<ul>
    <li><a href="../samples/index.html">Samples</a></li>
    <li><a href="../explainer/index.html">Explainer</a></li>
    <li><a href="../spec/shadow/index.html">Shadow DOM Spec</a></li>
    <li><a href="../spec/templates/index.html">HTML Templates</a></li>
</ul>
<h1>Web Components Examples</h1>
</header>
<p>This is a collection of code samples for Web Components.</p>

<h2>Component Model Use Case Implementations</h2>

<p>Here are the <a href="http://www.w3.org/2008/webapps/wiki/Component_Model_Use_Cases">Component Model Use Cases</a>, implemented using Web Components:</p>
<ul>
<!--    <li><a href="contacts-widget-custom-element.html">Contacts Widget Custom Element</a>, for the <a href="http://www.w3.org/2008/webapps/wiki/Component_Model_Use_Cases#Contacts_Widget">Contacts Widget</a> use case</li> -->
    <li><a href="table-chart.html">Table-based Charts Custom Element</a>, for the <a href="http://www.w3.org/2008/webapps/wiki/Component_Model_Use_Cases#Table-based_Charts">Table-based Charts</a> use case</li>
    <li><a href="timezone-map-custom-element.html">Timezone Map Custom Element</a>, for the <a href="http://www.w3.org/2008/webapps/wiki/Component_Model_Use_Cases#Timezone_selection_via_Image">Timezone selection via Image</a> use case</li>
    <li><a href="entry-helper.html">Entry Helper Custom Element</a>, for the <a href="http://www.w3.org/2008/webapps/wiki/Component_Model_Use_Cases#Entry-helper">Entry Helper</a> use case</li>
</ul>

<h2>Shadow DOM Code Samples</h2>

<p>It all begins with a basic recipe for making a well-encapsulated <a href="contacts-widget.html">Contacts Widget</a>.</p>

<p>A more advanced recipe shows how <a href="http://dev.w3.org/csswg/css-variables/">CSS Variables</a> could be used to attenuate styling of shadow DOM for things like <a href="widget-theming.html">theming</a>.</p>

<p>The <a href="replay-extension.html">DOM replay extension</a> example/recipe illustrates a technique that can be used to inject new user interface into an existing document without disturbing document's structure.</p>

<p>There's a fairly involved <a href="../spec/shadow/index.html#shadow-dom-example">example</a> in the <a href="../spec/shadow/index.html">Shadow DOM</a> specification.</p>

</body>
</html>
<!DOCTYPE html>
<html>
<head>
<title>Widget Theming: Shadow DOM Example</title>
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:700|Droid+Sans+Mono|Ovo" type="text/css">
<link rel="stylesheet" href="../assets/styles/main.css" type="text/css">
<link rel="stylesheet" href="../assets/styles/prettify.css" type="text/css" />
<script src="../assets/scripts/bug-assist.js"></script>
<script src="../assets/scripts/prettify.js"></script>
<meta name="bug.blocked" content="14956">
<meta name="bug.short_desc" content="[Samples]: ">
<meta name="bug.product" content="WebAppsWG">
<meta name="bug.component" content="Component Model">
</head>
<body>
<header>
<ul>
    <li><a href="../samples/index.html">Samples</a></li>
    <li><a href="../explainer/index.html">Explainer</a></li>
    <li><a href="../spec/shadow/index.html">Shadow DOM Spec</a></li>
    <li><a href="../spec/templates/index.html">HTML Templates</a></li>
</ul>
<h1>Widget Theming</h1>
</header>

<p>After Raj's <a href="contacts-widget.html">discovery of Shadow DOM</a> triggered company-wide conversion to properly incapsulated widgets, Howard&mdash;not to be outdone&mdash;gleans another great opportunity in this change. He realizes that with the help of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#attr-style-scoped">scoped stylesheets</a> and <a href="../spec/shadow/index.html">shadow DOM</a>, he can separate the general framing of the widgets from the theming code. For years now, it's been bugging him that whenever the widget's author wanted to tweak the general layout of their widgets, they would have edit the <code>/src/ui/layout/widgets.css</code> stylesheet and muck with their gubbins of code there, creating a waterfall of lines that looks like this:<p>
<pre class="prettyprint"><code>

/* General Widget properties */

.widget { &hellip; }

/* Contacts Widget layout. All rules must start with .contacts.widget  */

.contacts.widget ul {
    margin: 0;
    list-style: none;
    &hellip;
}

.contacts.widget ul li { &hellip; }

.contacts.widget ul li img.photo { &hellip; }

.contacts.widget ul li span.n { &hellip; }

&hellip;

/* Activity Stream Widget layout. All rules must start with .activity.widget */

.activity.widget ul { &hellip; }

.activity.widget li { &hellip; }

.activity.widget li.shared { &hellip; }

&hellip;

</code></pre>

<p>Then, a separate stylesheet in the <code>/src/ui/themes/</code> directory is used to apply colors, backgrounds, and all those wonderful barnacles that typically comprise a theme. Despite strictly enforced naming conventions, the structure is somewhat brittle and, on occasion, one rule clobbers another, subtly breaking the beautiful house of cards, causing users grief&mdash;and throwing Howard into panic mode. Panic mode gets old quickly.</p>

<p>Moving widget layout styles to <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#attr-style-scoped">scoped stylesheets</a> next to respective widgets goes a long way to make layout less brittle. Further, putting these scoped styles <em>inside</em> each widget's shadow DOM subtree ensures that the these styles are <strong>contained</strong> to the widgets. Sure, it's a bit of a refactoring, but that beats arguing with mom. Howard goes to work. An hour later, the <code>/src/ui/layout/widgets.css</code> stylesheet is drained and all widgets look like this (<code>/src/ui/widgets/contacts.js</code>, for example):</p>

<pre class="prettyprint"><code>
var ui = ui || {};
ui.widgets = ui.widgets || {};

(function() {
    var MAX_USERS = 8;

    function Contacts()
    {
        this.element = document.createElement('div');
        this.element.className = 'contacts widget';
        var shadow = new ShadowRoot(this.element);
        shadow.applyAuthorStyles = true;
        <ins>var style = document.createElement('style');</ins>
        <ins>style.scoped = true;</ins>
        <ins>style.textContent = this.scopedStyleText;</ins>
        <ins>shadow.appendChild(style);</ins>
        var users = shadow.appendChild(document.createElement('ul'));
        this.loadUsers(MAX_USERS, function(user) {
            var li = document.createElement('li');
            // Populate [li] with data from the [user] object.
            // &hellip;
        });
    }

    // &hellip;

    <ins>// Styles moved from /src/ui/layout/widgets.css, minus ".contacts.widget" selector.</ins>
    <ins>// Quasi-literals are awesome! (<a href="http://wiki.ecmascript.org/doku.php?id=harmony:quasis">http://wiki.ecmascript.org/doku.php?id=harmony:quasis</a>)</ins>
    <ins>Contacts.prototype.scopedStyleText = `ul {</ins>
        <ins>margin: 0;</ins>
        <ins>list-style: none;</ins>
        <ins>&hellip;</ins>
        <ins>}</ins>
        <ins>ul li { &hellip; }</ins>
        <ins>ul li img.photo { &hellip; }</ins>
        <ins>ul li span.n { &hellip; }</ins>
        <ins>&hellip;`;</ins>

    // &hellip;

    ui.widgets.Contacts = Contacts;

})();
</code></pre>

<p>Whoa!&mdash;Howard sees another way to improve robustness of the layout system. The <a href="../spec/shadow/index.html#api-shadow-root-apply-author-styles"><code>applyAuthorStyles</code></a> flag (which is <code>false</code> by default) controls whether document stylesheets apply in the shadow DOM subtrees. Thus removing a line of code ensures that the widget's styles are never messed with:</p>

<pre class="prettyprint"><code>
this.element.className = 'contacts widget';
var shadow = new ShadowRoot(this.element);
<del>shadow.applyAuthorStyles = true;</del>
var users = shadow.appendChild(document.createElement('ul'));
</code></pre>

<p>The celebration is cut short as Howard notices that the stylesheets from <code>/src/ui/themes/</code> directory were <em>also</em> part of the document stylesheet. As it stands, there is no way to apply theming styles to the widgets&hellip;</p>

<p>Or maybe there is. <a href="http://dev.w3.org/csswg/css-variables/">CSS Variables</a> to the rescue! Upon reading the spec, Howard does a little dance. Not only they allow widget theming, the <em>method</em> is such that you can specify <strong>precise</strong> and <strong>named</strong> points where theming is allowed. Digging into the Contacts widget, Howard documents the following theming points:</p>
<ul>
    <li><strong>font</strong> -- font and size of text</li>
    <li><strong>color</strong> -- color, used for text and border of the user pic</li>
    <li><strong>background</strong> -- style of the widget background</li>
</ul>
<p>Howard mixes the variables into the <code>scopedStyleText</code> string:</p>

<pre class="prettyprint"><code>
// Styles moved from /src/ui/layout/widgets.css, minus ".contacts.widget" selector.
// Quasi-literals are awesome! (<a href="http://wiki.ecmascript.org/doku.php?id=harmony:quasis">http://wiki.ecmascript.org/doku.php?id=harmony:quasis</a>)
Contacts.prototype.scopedStyleText = `ul {
    margin: 0;
    list-style: none;
    <ins>font: data(font);</ins>
    <ins>color: data(color);</ins>
    <ins>background: data(background);</ins>
    &hellip;
    }
    ul li {  &hellip; }
    ul li img.photo {
    border: 1px solid<ins> data(color)</ins>;
    &hellip;';

</code></pre>

<p>Now to tweak the actual themes, starting with <code>/src/ui/themes/purple-and-black.css</code>:</p>

<pre class="prettyprint"><code>

&hellip;

/* Contacts Widget Theme  */

<del>.contacts.widget ul {</del>
    <del>color: black;</del>
    <del>background: purple;</del>
<del>}</del>

<del>.contacts.widget ul li img.photo {</del>
    <del>border-color: black;</del>
<del>}</del>

<ins>.contacts.widget {</ins>
    <ins>data-color: black;</ins>
    <ins>data-background: purple;</ins>
<ins>}</ins>

&hellip;

</code></pre>

<p>Whoohoo! No more reaching into widgets to style them! No more breakages when widget authors change their widgets and forget to update the theme! After all themes are converted, the <em>Socia1eet</em> looks and works same as before. But on the inside, the brittle layout and theming system has been replaced with a flexible, elegant, and robust solution.</p>

</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>HTML Imports</title>
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common' async class='remove'></script>
    <script class='remove'>
      var respecConfig = {
          specStatus: "ED",
          shortName: "html-imports",
          useExperimentalStyles: true,
          editors: [
          { name: "Dimitri Glazkov", url: "mailto:dglazkov@chromium.org", company: "Google, Inc.", w3cid: 40456 },
          { name: "Hajime Morrita", url: "mailto:morrita@chromium.org", company: "Google, Inc.", w3cid: 50024 }],
          wg: "Web Platform Working Group",
          wgURI: "http://www.w3.org/WebPlatform/WG/",
          wgPublicList: "public-webapps",
          subjectPrefix: "[html-imports]",
          wgPatentURI: "http://www.w3.org/2004/01/pp-impl/83482/status",
          license: "w3c-software-doc",
          edDraftURI: "https://w3c.github.io/webcomponents/spec/imports/",
          issueBase: "https://github.com/w3c/webcomponents/issues/",
          otherLinks: [
              {
                  key: "Participate",
                  data: [
                    {value:"We are on Github", href:"https://github.com/w3c/webcomponents/labels/html-imports"},
                    {value:"Discuss on public-webapps@w3.org", href:"http://lists.w3.org/Archives/Public/public-webapps/"},
                    {value:"Web Platform Working Group", href:"http://www.w3.org/WebPlatform/WG/"}
                    ]
              },
              {
                  key: "Revision history",
                  href: "https://github.com/w3c/webcomponents/commits/gh-pages/spec/imports/"
              },
              {
                  key: "Bugs filed",
                  href: "https://github.com/w3c/webcomponents/labels/html-imports"
              },{
                 key: 'Implementation',
                 data: [{
                   value: 'Can I use HTML Imports?',
                   href: 'http://caniuse.com/#feat=imports'
              }, {
                   value: 'Test Suite',
                   href: 'http://w3c-test.org/html-imports/'
              }, {
                   value: 'Test Suite repository',
                   href: 'https://github.com/w3c/web-platform-tests/tree/master/html-imports'
      }]
    }
          ]
      };
    </script>
    <style>
div.algorithm {
    padding: 0 0 0 20px;
    border-left: 5px solid #EAF7F9;
}
var {
    font-size: 0.8em;
    color: #005A9C;
    font-style: normal;
}
</style>
</head>

<body>
<section id='abstract'>
  <p>HTML Imports are a way to include and reuse HTML documents in other HTML documents [[!HTML]].</p>
</section>

<section id='sotd'>
</section>

<section id="conformance">

<p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="https://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence">processing equivalence</dfn> is a constraint imposed on the algorithm implementers, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>
</section>

<section id="terminology">
<h2>Terminology</h2>

<p>HTML Imports, or just <dfn id="dfn-import" data-lt='import'>imports</dfn> from here on, are <a href="https://html.spec.whatwg.org/multipage/syntax.html">HTML documents</a> [[!HTML]] that are <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element">linked</a> as <a href="https://html.spec.whatwg.org/multipage/semantics.html#external-resource-link">external resources</a> from another <a href="https://html.spec.whatwg.org/multipage/syntax.html">HTML document</a>. The document that links to an <a>import</a> is called an <dfn id="dfn-import-referrer">import referrer</dfn>. For any given <a>import</a>, an <dfn id="dfn-import-referrer-ancestor">import referrer ancestor</dfn> is its <a>import referrer</a> or any <a>import referrer ancestor</a> of its <a>import referrer</a>. There are one or more <a data-lt="import referrer">import referrers</a> and <a data-lt="import referrer ancestor">import referrer ancestors</a> for each import because same import can be referred from multiple <a data-lt="import referrer">import referrers</a>.</p>

<p>An <a>import referrer</a> that is not an <a>import</a>, thus is not associated with any <a>import referrer</a>, is called a <dfn id="dfn-master-document">master document</dfn>. Each <a>import</a> is associated with one <a>master document</a>: if the <a data-lt="import referrer">referrer</a> of the <a>import</a> is a <a>master document</a>, it is the <a>master document</a> of the <a>import</a>. Otherwise, the <a>master document</a> of the <a>import referrer</a> is the <a>master document</a> of the <a>import</a>.</p>

<p>The <a href="https://dom.spec.whatwg.org/#concept-document-url">URL</a> of an <a>import</a> is called the <dfn id="dfn-import-location">import location</dfn><!--, and the <a href="https://html.spec.whatwg.org/multipage/origin-0.html#origin">origin</a> of the <a>import location</a> is called <dfn id="dfn-import-origin">import origin</dfn>-->.</p>

<p>In each <a>import referrer</a>, an <a>import</a> is represented as a <a href="https://dom.spec.whatwg.org/#interface-document"><code>Document</code></a> [[!WHATWG-DOM]], called the <dfn id="dfn-imported-document">imported document</dfn>.<p>

<p class='issue' data-number='197'>The <a data-lt="imported document">imported documents</a> don't have <a href="https://html.spec.whatwg.org/multipage/browsers.html#browsing-context">browsing context</a>.</p>

<p>The set of all <a data-lt="import">import</a> associated with the <a>master document</a> forms an <dfn id="dfn-import-map">import map</dfn> of the <a>master document</a>. The maps stores <a data-lt="import">import</a> as its items with their <a data-lt="import location">import locations</a> as keys. The import map is empty at beginning. New items are added to the map as <a data-lt="import fetching">import fetching algorithm</a> specifies.</p>

<section id="import-dependent">
<h3>Import Dependent</h3>

<p>To track <a href="#requesting-import">requested</a> imports, each document has an <dfn id="dfn-import-link-list">import link list</dfn>. Each of its item consists of <dfn id="dfn-import-link-link">link</dfn>, a <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element">link</a></code> element and <dfn id="import-link-list-location">location</dfn>, a URL.
Also, the item is optionally <dfn id="dfn-import-link-list-branch">marked as branch</dfn>.
The list is initially empty, and items are added to it as specified by the <a>import request</a> algorithm.</p>

<p>Each <a>imported document</a> has an <a>import parent</a>: If the <a>import link list</a> of document <var>A</var> contains a <a data-lt='marked as branch'>branch</a> item whose <a>location</a> points document <var>B</var>, <var>A</var> is an <dfn id="dfn-import-parent">import parent</dfn> of <var>B</var>.</a></p>

<p>Each <a>imported document</a> also has one or more <dfn id="dfn-import-ancestor" data-lt='import ancestor'>import ancestors</dfn>: Document <var>A</var> is an <a>import ancestor</a> of another document <var>B</var> if <var>A</var> is <a>import parent</a> of <var>B</var>. Being an <a data-lt="import ancestor">import ancestor</a> is transitive: If <var>A</var> is an <a>import parent</a> of <var>B</var> and <var>B</var> is an <a>import parent</a> of <var>C</var>, <var>A</var> is an <a>import parent</a> of <var>C</var> as well.</p>

<p>An <a>imported document</a> also has one or more <dfn id="dfn-import-predecessor" data-lt='import predecessor'>import predecessors</dfn>. An <a>import predecessor</a> is a document. If the URL of document <var>A</var> is located before the URL of document <var>B</var> in the <a>import link list</a> of <var>B</var>'s <a>import parent</a>, and the located <a>link</a> is marked as a <a data-lt='marked as branch'>branch</a>, then <var>A</var> is <a>import predecessor</a> of <var>B</var>.</p>

<p>The <dfn id="dfn-import-ancestor-predecessor" data-lt='import ancestor predecessor'>import ancestor predecessors</dfn> of document <var>A</var> is defined as follows: If document <var>B</var> is an <a>import predecessor</a> of document <var>C</var>, and <var>C</var> is an <a>import ancestor</a> of <var>A</var>, <var>B</var> is an <a>import ancestor predecessors</a> of <var>A</var>.</p>

<p>The <a href="https://html.spec.whatwg.org/multipage/dom.html#document"><code>Document</code></a> that is in either <a>import ancestor predecessors</a> or <a>import predecessors</a> of document <var>A</var>, or is linked from <a data-lt='marked as branch'>branch</a> item of <var>A</var>'s <a>import link list</a>, is the <dfn id="dfn-import-dependent">import dependent</dfn> of <var>A</var>.</p>

<div class="informative">
<p>The <a>import link list</a> and the <a>import dependent</a> constrains the order of script execution in imports. It is intend to give a deterministic order of script execution which is defined by the order of <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> element in each import. The edges of each node is ordered in terms of <a>import link list</a>. The <a>import predecessors</a> selection is aware of the order.</p>

<p>The linking structure of <a data-lt="import link list">import link lists</a> forms a directed graph. Each node of the graph is a document and its edge is a <a>link</a>. <a data-lt='marked as branch'>Branches</a> are intended to form a spanning tree of the graph. This tree gives the deterministic order of the script execution.</p>

<figure id="fig-import-list">
  <img src="import-link-list.png">
  <figcaption>An example of import link lists</figcaption>
</figure>

<p>
In <a href='#fig-import-list'></a>,
</p>
<ul>
  <li>The document <var>A</var> has an <a>import link list</a> which contains a link to <var>B</var> and another link to <var>C</var>.
  <li>The document <var>D</var> has a couple of <a>import ancestors</a> that are <var>A</var> and <var>B</var>.
  <li>As <var>B</var> is a <a>import ancestor</a> of <var>D</var>, one of <var>D</var>'s list item that points <var>B</var> is not marked as a <a data-lt='marked as branch'>branch</a>.
  <li>Even though the document <var>D</var> is linked from two documents <var>B</var> and <var>C</var>, its <a>import parent</a> is <var>B</var> because <var>B</var> has a <a>link</a> to <var>D</var> which is marked as a <a data-lt='marked as branch'>branch</a>.
  <li>Look at <var>E</var>:
    <ul>
      <li><var>E</var> doesn't have any <a>import predecessors</a>. The link to <var>D</var> from <var>C</var> is not marked as <a data-lt='marked as branch'>branch</a>, and the link to <var>G</var> isn't located before one to <var>E</var>.</li>
      <li><var>E</var>'s <a>import ancestors</a> are <var>A</var> and <var>C</var>.
      <li><var>E</var>'s <a>import ancestor predecessor</a> is <var>B</var> because <a>import predecessors</a> of <var>C</var> is <var>B</var> and <var>A</var> has no <a>import predecessors</a>.
      <li><var>E</var>'s <a>import link list</a> contains <var>H</var> which is marked as a <a data-lt='marked as branch'>branch</a>.</li>
      <li>Thus <var>E</var>'s <a data-lt="import dependent">import dependents</a> are <var>B</var>, an <a>import ancestor predecessor</a>, and <var>H</var>, an item of an <a>import link list</a>.</li>
    </ul>
  </li>
  <li>Look at <var>G</var>:
    <ul>
      <li><var>G</var>'s <a>import predecessors</a> is <var>E</var>.</li>
      <li><var>G</var>'s <a>import ancestor predecessor</a> is same as <var>E</var>'s, which is <var>B</var>.</li>
      <li><var>G</var>'s <a>import link list</a> is empty.</li>
      <li>Thus <var>G</var>'s <a data-lt="import dependent">import dependents</a> are <var>B</var>, an <a>import ancestor predecessor</a>, and <var>E</var>, an <a>import predecessors</a>.</li>
    </ul>
  </li>
</ul>

<p>The difference between the <a>import referrer</a> and the <a>import parent</a> is that <a>import referrer</a> reflects the state of the <a href="http://www.w3.org/TR/dom/#node-tree">node tree</a> and that the <a>import parent</a> is built by the algorithm described in this document.</p>

</div>
</section>
</section>

<section id="link-type-import">
<h2>Link Type "<code>import</code>"</h2>

<p>To enable declaring <a data-lt="import">import</a> in HTML, a new link type is added to <a href="https://html.spec.whatwg.org/multipage/semantics.html#linkTypes">HTML link types</a>:</p>

<section class="monkeypatch">
<p>The <a id="#link-type-import"><code>import</code></a> keyword may be used with <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> elements. This keyword creates an <a href="https://html.spec.whatwg.org/multipage/semantics.html#external-resource-link">external resource link</a> to an <a>import</a>.</p>

<p>The default type for resources given by the <a href="#link-type-import"><code>import</code></a> keyword is <code>text/html</code>.</p>

<p>The <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> element may have an <dfn id="dfn-import-async-attribute">async</dfn> attribute. The <a><code>async</code></a> attribute is a <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#boolean-attributes">boolean attribute</a>.

<p>The appropriate time to <dfn id="dfn-obtaining-import" data-lt="obtaining import">fetch</dfn> the resource is when the <a href="https://html.spec.whatwg.org/multipage/semantics.html#external-resource-link">external resource link</a> is created or when its element is <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#insert-an-element-into-a-document">inserted into a document</a>, whichever happens last.</p>

<p>The import is fetched and applied regardless of the <a href="https://html.spec.whatwg.org/multipage/semantics.html#attr-link-media"><code>media</code></a> attribute of the <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> matches the environment or not.</p>

</section>

<aside class="example" id='hearts-example'>
<p>The following document has one import, located at <code>/imports/heart.html</code>:</p>

<pre class="highlight">
&lt;!DOCTYPE html&gt;
&lt;html lang="en-US"&gt;
    &lt;head&gt;
        &lt;title&gt;Human Being&lt;/title&gt;
        &lt;link rel="import" href="/imports/heart.html"&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;p&gt;What is a body without a heart?&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre>
</aside>
</section>

<section id="interface-import">
<h2>Extensions to <code>HTMLLinkElement</code> Interface</h2>

<pre class="idl">
partial interface HTMLLinkElement {
    readonly attribute Document? import;
};
</pre>

<p>On getting, the <dfn for="HTMLLinkElement">import</dfn> attribute MUST return <strong>null</strong>, if:</p>
<ul>
        <li>The <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> does not <a href="https://html.spec.whatwg.org/multipage/dom.html#represents">represent</a> an <a>import</a></li>
    <li>the <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> element is not <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-a-document">in a <code>Document</code></a></li>
</ul>
<p>Otherwise, the attribute MUST return the <a>imported document</a> for the <a>import</a>, represented by the <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> element.</p>

<p>The same object MUST be returned each time.</p>

<aside class="example" id='import-dom-access'>
<p>Here's how one could access the imported document, mentioned in <a href='#hearts-example'>previous example</a>:</p>
<pre class="highlight">
var link = document.querySelector('link[rel=import]');
var heart = link.import;
// Access DOM of the document in /imports/heart.html
var pulse = heart.querySelector('div.pulse');
</pre>
</aside>

<p>An <a>import</a> in the context of the <a href="https://html.spec.whatwg.org/multipage/dom.html#document"><code>Document</code></a> of an <a href="https://html.spec.whatwg.org/multipage/syntax.html#html-parser">HTML parser</a> or <a href="https://html.spec.whatwg.org/multipage/xhtml.html#xml-parser">XML Parser</a> is said to be <dfn id="dfn-an-import-that-is-blocking-scripts">an import that is blocking scripts</dfn> if the <a href="https://dom.spec.whatwg.org/#concept-element">element</a> was created by that <a href="https://html.spec.whatwg.org/multipage/dom.html#document"><code>Document</code></a>'s parser, or and the <a href="https://dom.spec.whatwg.org/#concept-element">element</a> is a <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> of type <a href="#link-type-import"><code>import</code></a> when the <a href="https://dom.spec.whatwg.org/#concept-element">element</a> was created by the parser, and the <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> is not <a data-lt="async">marked as async</a>, and the the import is yet to be <a href="https://html.spec.whatwg.org/multipage/syntax.html#completely-loaded">completely loaded</a>, and, the last time the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loop">event loop</a> has reached step 1, the <a href="https://dom.spec.whatwg.org/#concept-element">element</a> was <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-a-document">in that <code>Document</code></a>, and the user agent hasn't given up on that <a>import</a> yet. A user agent MAY give up on an <a>import</a> at any time.</p>


<p class='note'>
Giving up an import before it loads, even if the import eventually does still load, means that the script might end up operating with incorrect information. For example, if an import registers a custom element and a script relies on the availability of this element, the script will find that this element is unavailable if the user agent gives up early. Implementers have to balance the likelihood of a script using incorrect information with the performance impact of doing nothing while waiting for a slow network request to finish.
</p>

<p>A <a href="https://html.spec.whatwg.org/multipage/dom.html#document"><code>Document</code></a> <dfn id="dfn-has-an-import-that-is-blocking-scripts">has an import that is blocking scripts</dfn> if there is <a>an import that is blocking scripts</a> in the <a href="https://html.spec.whatwg.org/multipage/dom.html#document"><code>Document</code></a>'s <a>import dependent</a>.
A <a href="https://html.spec.whatwg.org/multipage/dom.html#document"><code>Document</code></a> <dfn id="dfn-has-no-import-that-is-blocking-scripts">has no import that is blocking scripts</dfn> if it does not <a data-lt='has an import that is blocking scripts'>have an import that is blocking scripts</a> as defined in the previous paragraph.</p>

<p class='note'>The state of "<a>has an import that is blocking scripts</a>" can change each time an existing import is completely loaded or new import loading is started. HTML parser has changes to unblock it for each of such timings.</p>
</p>
</section>

<section id="interface-document">
<h2>Extensions to <code>Document</code> Interface</h2>

<section id="additions-to-document-open">
<h3>Additions to <code>document.open()</code> method</h3>

<p>Add following step as the first step of the definition:</p>

<div class="monkeypatch">
<ol>
  <li>Throws an <code><a href="https://html.spec.whatwg.org/multipage/infrastructure.html#invalidstateerror">InvalidStateError</a></code> exception if the <a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a> is an <a>import</a>.</li>
</ol>
</div>
</section>
<section id="additions-to-document-write">
<h3>Additions to <code>document.write()</code> method</h3>

<p>Add following step as the first step of the definition:</p>

<div class="monkeypatch">
<ol>
  <li>Throws an <code><a href="https://html.spec.whatwg.org/multipage/infrastructure.html#invalidstateerror">InvalidStateError</a></code> exception if the <a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a> is an <a>import</a>.</li>
</ol>
</div>
</section>
<section id="additions-to-document-close">
<h3>Additions to <code>document.close()</code> method</h3>

<p>Add following step as the first step of the definition:</p>

<div class="monkeypatch">
<ol>
  <li>Throws an <code><a href="https://html.spec.whatwg.org/multipage/infrastructure.html#invalidstateerror">InvalidStateError</a></code> exception if the <a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a> is an <a>import</a>.</li>
</ol>
</div>

</section>
</section>

<section id="loading-imports">
<h2>Loading Imports</h2>

<section id="updateing-branch">
<h3>Updating Branch</h3>

<p>After a <a>link</a> is added to the <a>import link list</a>, the <dfn id="dfn-update-marking">update marking</dfn> algorithm MUST be run with the <a>master document</a>. which is <a data-lt="processing equivalence">equivalent</a> to running these steps:</p>

<dl>
<dt>Input</dt>
<dd><var>DOCUMENT</var>, the <a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a></dd>
</dl>

<ol>
  <li>If the <var>DOCUMENT</var> is the <a>master document</a>, unmark <a data-lt='marked as branch'>branch</a> of all the <a data-lt="link">links</a> in the <a>import link list</a> of <var>DOCUMENT</var> and every <a data-lt="imported document">import</a> that is associated to <var>DOCUMENT</var>.</li>
  <li>Let <var>LIST</var> be an <a>import link list</a> of <var>DOCUMENT</var>.</li>
  <li>For each <var>ITEM</var> in the <var>LIST</var>:</li>
  <li><ol>
    <li>Let <var>LOCATION</var> be a <a>location</a> of <var>ITEM</var>.</li>
    <li>Let <var>IMPORT</var> be an <a>import</a> whose URL is same as <var>LOCATION</var>.</li>
    <li>If there is no other <a>link</a> whose <a>location</a> is same as <var>LOCATION</var> and which is marked as a <a data-lt='marked as branch'>branch</a>, mark <var>ITEM</var> as a <a data-lt='marked as branch'>branch</a>.</li>
    <li>If <var>ITEM</var> is marked as a <a data-lt='marked as branch'>branch</a> and <var>IMPORT</var> is not <strong>null</strong>, invoke <a>update marking</a> algorithm with <var>IMPORT</var>.</li>
  </ol></li>
</ol>

</section>

<section id="requesting-import">
<h3>Requesting Import</h3>

<p>When user agents attempt to <a data-lt="obtaining import">obtain</a> a linked import, they MUST also run the <dfn id="dfn-import-request">import request</dfn> algorithm, which is <a data-lt="processing equivalence">equivalent</a> to running these steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
<dd><var>LINK</var>, the <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> element that creates an <a href="https://html.spec.whatwg.org/multipage/semantics.html#external-resource-link">external resource link</a> to the import.</dd>
<dd><var>LOCATION</var>, the <a href="https://dom.spec.whatwg.org/#concept-document-url">URL</a> of the linked resource.</dd>
</dl>
<ol class='algorithm'>
  <li>If the <a>async</a> attribute of <var>LINK</var> is true, mark <var>LINK</var> as <a>async</a>.
  <li>Let <var>DOCUMENT</var> be a document of <var>LINK</var>.
  <li>Let <var>LIST</var> be an <a>import link list</a> of <var>DOCUMENT</var>.
  <li>Let <var>ITEM</var> be <var>LINK</var> and <var>LOCATION</var>:</li>
  <li><ol>
    <li>Add <var>ITEM</var> at the end of <var>LIST</var>.
    <li>Invoke <a>update marking</a> algorithm with the <a>master document</a>.
  </ol></li>
</ol>
</div>

</section>

<section id="fetching-import">
<h3>Fetching Import</h3>

<p>All <a data-lt="import">import</a> linked from documents that is the <a>master document</a> or the one in the <a>import map</a> MUST be fetched using the <a data-lt="import fetching">import fetching algorithm</a> described below, instead of the one that HTML specifies to <a href="https://html.spec.whatwg.org/multipage/semantics.html#concept-link-obtain">obtain a linked resouce</a>.</a></p>

<p>The <dfn id="dfn-import-fetching">import fetching</dfn> algorithm MUST be <a data-lt="processing equivalence">equivalent</a> to running these steps:</p>
<div class="algorithm">
<dl>
<dt>Input</dt>
<dd><var>LINK</var>, a <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> element which makes the <a href="https://html.spec.whatwg.org/multipage/semantics.html#external-resource-link">external resource link</a> to the import.</dd>
<dd><var>LOCATION</var>, the <a>import location</a></dd>
<dt>Output</dt>
<dd><var>IMPORT</var>, the <a>imported document</a>.</dd>
</dl>
<ol class='algorithm'>
    <li>If <var>LOCATION</var> is already in the <a>import map</a>:
    <ol>
      <li>Let <var>IMPORT</var> be the <a>imported document</a> for <var>LOCATION</var> and <strong>stop</strong>.</li>
    </ol></li>
    <li><a href="https://fetch.spec.whatwg.org/#concept-fetch">Fetch a resource</a>  [[!Fetch]] from <var>LOCATION</var> with <a href="https://fetch.spec.whatwg.org/#concept-request-origin">request's origin</a> set to the <a href="https://html.spec.whatwg.org/multipage/browsers.html#origin">origin</a> of the <a>master document</a>, the <a href="https://fetch.spec.whatwg.org/#concept-request-mode">mode</a> to <i>CORS</i> and the <a href="https://fetch.spec.whatwg.org/#concept-request-credentials-mode">credentials mode</a> to <i>same-origin</i>.
    <ol>
        <li>If fetched <a href="https://fetch.spec.whatwg.org/#concept-response-type">response type</a> is <i>error</i> or the response has a <a href="https://fetch.spec.whatwg.org/#concept-header">header</a> whose name is <code>Content-Disposition</code>:
        <ul>
          <li>Add <var>LOCATION</var> and <strong>null</strong> to the <a>import map</a> and <strong>stop</strong>.
        </ul></li>
        <li>Let <var>IMPORT</var> be a new <a href="https://dom.spec.whatwg.org/#document"><code>Document</code></a>, <a href="https://html.spec.whatwg.org/multipage/dom.html#the-document's-address">the document's address</a> of which is <var>LOCATION</var></li>
        <li>Let <var>PARSER</var> be a new <a href="https://html.spec.whatwg.org/multipage/syntax.html#html-parser">HTML parser</a>, associated with <var>IMPORT</var></li>
        <li>Add <var>LOCATION</var> and <var>IMPORT</var> to the <a>import map</a>.</li>
        <li>For each <a href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-task">task</a> that the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-task">networking task source</a> places on the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#task-queue">task queue</a> while fetching:
        <ol>
            <li>Fill <var>PARSER</var>'s <a href="https://html.spec.whatwg.org/multipage/syntax.html#the-input-byte-stream">input byte stream</a> with the fetched bytes</li>
            <li>Let <var>PARSER</var> process the <a href="https://html.spec.whatwg.org/multipage/syntax.html#the-input-byte-stream">input byte stream</a> with <a href="https://encoding.spec.whatwg.org/#utf-8">utf-8</a> [[!WHATWG-ENCODING]] as <a href="https://html.spec.whatwg.org/multipage/syntax.html#a-known-definite-encoding">a known definite encoding</a></li>
        </ol></li>
        <li>When no more bytes are available:
        <ol>
            <li><a href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task">Queue a task</a> from the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source">networking task source</a> for <var>PARSER</var> to process implied <code>EOF</code> character</li>
        </ol>
    </ol></li>
</ol>
</div>

<p class="note">
All of loaded imports and imports under loading are in the <a>import link list</a>, thus every <a>import</a> which is linked from imports in the list will also be loaded using the <a>import fetching</a> algorithm, with  <var>LOCATION</var> be the <a>import location</a> of the import.
</p>

<p>
The loading attempt MUST be considered successful if <var>IMPORT</var> is not null on the algorithm completion, and failed otherwise.
</p>

<p>Every import that is not <a data-lt="async">marked as async</a> <a href="https://html.spec.whatwg.org/multipage/syntax.html#delay-the-load-event">delays the load event in the Document</a>.

<div class="note">
<p>The <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> element <a href="https://html.spec.whatwg.org/multipage/webappapis.html#fire-a-simple-event">fires a simple event</a> called <code>load</code>
for successful loading attempt. For failed attempt, it <a href="https://html.spec.whatwg.org/multipage/webappapis.html#fire-a-simple-event">fires a simple event</a> named <code>error</code>.</p>
<p>As an import delays the load event, the <a href="https://dom.spec.whatwg.org/#document"><code>Document</code></a> isn't <a href="https://html.spec.whatwg.org/multipage/syntax.html#completely-loaded">completely loaded</a> until loading attempts of all of its linked imports are finished.</p>
</div>

</section>

<section id="imports-and-csp">
<h3>Imports and Content Security Policy</h3>

<p>
<a href="http://w3c.github.io/webappsec-csp/">Content Security Policy</a> [[!CSP3]] MUST restrict import loading through the <a href="http://w3c.github.io/webappsec-csp/#script-src">script-src</a> directive.
</p>

<p>
Each import MUST be restricted by the Content Security Policy of the <a>master document</a>.
For example, if <a href="http://w3c.github.io/webappsec-csp/#csp-header">Content Security Header Field</a> is sent to an import, the user agent MUST <a href="http://w3c.github.io/webappsec-csp/#enforced">enforce</a> the policy of the <a>master document</a> to the imported document.
</p>

</section>
</section>

<section id="parsing-imports">
<h2>Parsing Imports</h2>

<p>Parsing behaviour of <a data-lt="import">import</a> is defined as a set of changes to the <a href="https://html.spec.whatwg.org/multipage/syntax.html#parsing">HTML Parsing</a>.</p>

<section id="additions-to-prepare-a-script-algorithm">
<h3>Additions to Prepare A Script Algorithm</h3>

<p>In step 15 of <a href="https://html.spec.whatwg.org/multipage/scripting.html#prepare-a-script">prepare a script</a> algorithm, modify the last part of condition which begins with <em>If element does not have a <code>src</code> attribute</em> to read:</p>
<section class="monkeypatch">
<p>... and the <a href="https://html.spec.whatwg.org/multipage/dom.html#document"><code>Document</code></a> of the <a href="https://html.spec.whatwg.org/multipage/syntax.html#html-parser">HTML parser</a> or <a href="https://html.spec.whatwg.org/multipage/xhtml.html#xml-parser">XML parser</a> that created the <a href="https://html.spec.whatwg.org/multipage/scripting.html#the-script-element"><code>script</code></a> element <a href="https://html.spec.whatwg.org/multipage/semantics.html#has-a-style-sheet-that-is-blocking-scripts">has a style sheet that is blocking scripts</a> or <a>has an import that is blocking scripts</a></p>
</section>

</section>

<section id="additions-to-tree-construction-algorithm">
<h3>Additions to Tree Construction Algorithm</h3>

<p>At the DOCTYPE part of section <a href="https://html.spec.whatwg.org/multipage/syntax.html#the-initial-insertion-mode">12.2.5.4.1 The "initial" insertion mode</a>, modify text <q>if the document is not an iframe srcdoc document...</q> as follows</a>

<section class="monkeypatch">
<p>if the document is not an iframe src document nor an <a>import</a>...</p>
</section>

<p>In sub-condition named <em>Otherwise</em> of condition <em>An end tag whose name is "script"</em> in <a href="https://html.spec.whatwg.org/multipage/syntax.html#parsing-main-incdata">"text" insertion mode</a>, modify step 3 to read:</p>
<section class="monkeypatch">
<ol start="3">
    <li>If the parser's <code><a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a></code> <a href="https://html.spec.whatwg.org/multipage/semantics.html#has-a-style-sheet-that-is-blocking-scripts">has a style sheet that is blocking scripts</a> or <a>has an import that is blocking scripts</a> or <em>the script</em>'s <a href="https://html.spec.whatwg.org/multipage/scripting.html#ready-to-be-parser-executed">"ready to be parser-executed"</a> flag is not set: <a href="https://html.spec.whatwg.org/multipage/webappapis.html#spin-the-event-loop">spin the event loop</a> until the parser's <code><a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a></code> <a href="https://html.spec.whatwg.org/multipage/semantics.html#has-no-style-sheet-that-is-blocking-scripts">has no style sheet that is blocking scripts</a> and <a>has no import that is blocking scripts</a> and the script's <a href="https://html.spec.whatwg.org/multipage/scripting.html#ready-to-be-parser-executed">"ready to be parser-executed"</a> flag is set.</li>
</ol>
</section>

</section>

<section id="additions-to-parsing-xhtml-documents">
<h3>Additions to Parsing XHTML Documents</h3>

<p>Modify step 3 of steps that run following <a href="https://html.spec.whatwg.org/multipage/scripting.html#prepare-a-script">preparing</a> the <a href="https://html.spec.whatwg.org/multipage/scripting.html#the-script-element"><code>script</code></a> element to read:</p>
<section class="monkeypatch">
<ol start="3">
    <li><p><a href="https://html.spec.whatwg.org/multipage/webappapis.html#spin-the-event-loop">Spin the event loop</a> until the parser's <code><a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a></code> <a href="https://html.spec.whatwg.org/multipage/semantics.html#has-no-style-sheet-that-is-blocking-scripts">has no style sheet that is blocking scripts</a> and <a>has no import that is blocking scripts</a> and the <a href="https://html.spec.whatwg.org/multipage/scripting.html#pending-parsing-blocking-script">pending parsing-blocking script</a>'s <a href="https://html.spec.whatwg.org/multipage/scripting.html#ready-to-be-parser-executed">"ready to be parser-executed"</a> flag is set.</p></li>
</ol>
</section>

</section>
</section>

<section id="scripts-imports">
<h2>Scripting in Imports</h2>

<section id="additions-to-script-enabling-criteria">
<h3>Additions to Script Enabling Criteria</h3>

<p>Add following condition to the list of <a href="https://html.spec.whatwg.org/multipage/webappapis.html#enabling-and-disabling-scripting">Enabling and disabling scripting</a> criteria:</p>

<section class="monkeypatch">
<ul>
  <li>Scripting is enabled for a <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#node">node</a> if the <a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a> object of the node is in the <a>import map</a>.</li>
</ul>
</section>

</section>

<section id="additions-to-dom-document-currentscript">
<h3>Additions to document.currentScript</h3>

<p>
Modify the definition of <a href="https://html.spec.whatwg.org/multipage/dom.html#dom-document-currentscript"><code>document.currentScript</code></a>
as follows:
</p>
<section class="monkeypatch">
The <dfn id="dom-document-currentscript" data-lt="document.currentScript"><code>currentScript</code></dfn> attribute, on getting,
MUST return the value to which it was most recently initialized in the document or the <a>import map</a> of the document.
When the Document is created, the <code>currentScript</code> MUST be initialized to null.
If the Document is an <a>imported document</a>, its <code>currentScript</code> is always null.
</section>

</section>
</section>

<section id="style-imports">
<h2>Style processing with Imports</h2>

<p>The contents of the <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-style-element">style</a></code> elements and
the external resources of the <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element">link</a></code> elements in <a data-lt="import">import</a> MUST be considered as input sources of the <a href="http://www.w3.org/TR/CSS21/intro.html#processing-model">style processing model</a> [[!CSS2]] of the <a>master document</a>.</p>

<section id="import-link-tree">
<h3>Import Link Tree</h3>

<p>A set of imports that are associated with a <a>master document</a> forms an <dfn id="dfn-import-link-tree">import link tree</dfn>, a <a data-lt="master document">tree</a> structure. Following <dfn id="dfn-import-link-tree-forming">import link tree forming</dfn> algorithm, being applied with <code>null</code> as <var>PARENT</var>, <a>master document</a> as <var>TREE</var> and all of its imports as <var>POOL</var>, defines the <a>import link tree</a>:</p>

<section class="algorithm">
<dl>
<dt>Input</dt>
<dd><var>PARENT</var>, a document tree node</dd>
<dd><var>CURRENT</var>, a document</dd>
<dd><var>POOL</var>, a list of document</dd>
<dt>Output</dt>
<dd><var>TREE</var>, a tree of document</dd>
</dl>

<ol>
  <li>Let <var>TREE</var> be a tree node.</li>
  <li>Let <var>TREE</var>'s value be <var>CURRENT</var>
  <li>Let <var>TREE</var>'s <a href="https://dom.spec.whatwg.org/#concept-tree-parent">parent</a> be <var>PARENT</var>.</li>
  <li>Make <var>TREE</var>'s <a href="https://dom.spec.whatwg.org/#concept-tree-child">child</a> list empty.</li>
  <li>For each <var>LINK</var>, a <code>link</code> element of an import in <var>CURRENT</var>, in document order:
  <ol>
    <li>Let <var>IMPORT</var> be the import of <var>LINK</var>.</li>
    <li>If <var>IMPORT</var> is not in <var>POOL</var>, try next.</li>
    <li>Remove <var>LINK</var> from <var>POOL</var>.</li>
    <li>Invoke the <a>import link tree forming</a> algorithm with <var>TREE</var> as <var>PARENT</var>, <var>IMPORT</var> as <var>CURRENT</var> and <var>POOL</var> as <var>POOL</var>, let the result be <var>CHILD</var>.
    <li>Append <var>CHILD</var> to <var>TREE</var>'s <a href="https://dom.spec.whatwg.org/#concept-tree-child">child</a> list.</li>
  </ol></li>
  <li><strong>stop</strong>.</li>
</ol>
</section>

<p class='note'>
The <a>import link tree</a> algorithm defines a order of imports using a depth first traversal. This <a>import link tree</a> is different from the one formed by <a>import link list</a>. The former is based on the document tree of each import. The later is built through <a href="#loading-imports">import loading process</a> and isn't affected by document tree mutation.
</p>

</section>

<section id="order-of-appearances">
<h3>Order of Appearances and Imports</h3>

<p>The <a href="https://www.w3.org/TR/css3-cascade/#cascade-order">order of appearances</a> of declarations [[!CSS-CASCADE-3]] which come from different documents are determined by the <a>import link tree</a>. If <a href="https://dom.spec.whatwg.org/#concept-node-document">node documents</a> of two declarations differ, compare the <a href="https://dom.spec.whatwg.org/#concept-tree-order">tree order</a> of these documents in the <a>import link tree</a>. The last one wins.</p>

</section>
</section>

<section id="events-imports">
<h2>Events in Imports</h2>

<p>Events in <a data-lt="import">import</a> is defined as a set of changes to the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#events">HTML Events</a>.</p>

<section id="additions-to-event-handlers">
<h3>Additions to Event Handlers</h3>

<p>
Modify the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-content-attributes">event handler content attribute</a>'s
script creation criteria by expanding the first paragraph:

<div class="monkeypatch">
<p>When an event handler content attribute is set, if the element is owned by a <a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a> that is in a <a href="https://html.spec.whatwg.org/multipage/browsers.html#browsing-context">browsing context</a> or
in an <a>import map</a>, &hellip;</p>
</div>

</section>
</section>

<section id="custom-elements">
<h2>Custom Element Processing</h2>

<p>This specification redefines <dfn id="dfn-custom-element-order">custom element order</dfn> to be the sum of [[!CUSTOM-ELEMENTS]]'s <a href="https://w3c.github.io/webcomponents/spec/custom/index.html#dfn-custom-element-order">custom element order</a> and <a>import tree order</a>, in which the <a>import tree order</a> is scaled so that its lowest value is always larger than the highest possible value of [[!CUSTOM-ELEMENTS]]'s <a href="https://w3c.github.io/webcomponents/spec/custom/index.html#dfn-custom-element-order">custom element order</a>.</p>

<p>The <dfn id="dfn-import-tree-order">import tree order</dfn> of a given <a href="https://w3c.github.io/webcomponents/spec/custom/index.html#dfn-custom-element">custom element</a> of an <a href="#dfn-import-link-tree">import link tree</a> is determined by <a href="https://dom.spec.whatwg.org/#concept-tree-order">tree order</a> in an <a href="#dfn-import-link-tree">import link tree</a> that was flattened by replacing every <a href="#dfn-import">import</a> <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> with the content of its <a href="#dfn-imported-document">imported document</a>.</p>

<p>The <dfn id="dfn-highest-stable-order">highest stable order</dfn> is the value that is immediately preceding the <a href="https://w3c.github.io/webcomponents/spec/custom/index.html#dfn-custom-element-order">custom element order</a> of an <a data-lt="custom element">element</a> in the first encountered <a href="#dfn-import">import</a>, in <a href="https://dom.spec.whatwg.org/#concept-tree-order">tree order</a>, that has not yet <a href="https://html.spec.whatwg.org/multipage/syntax.html#completely-loaded">completely loaded</a>. If there is no such <a href="https://w3c.github.io/webcomponents/spec/custom/index.html#dfn-custom-element">element</a>, the <a>highest stable order</a> is the highest custom element order in the flattened <a href="#dfn-import-link-tree">import link tree</a>. When processing the base element queue, user agents should only invoke callbacks up to the <a>highest stable order</a>, inclusively.</p>


<div class="note">
<p>Because imports load asynchronously, we need to divide a sorted element queue into the part where things have settled down (all imports have loaded), and the part where the loading is still happening, and thus the actual sorting order is not yet determined. For example, suppose you have the following document structure:</p>

<div id='document-structure'>
<p>index.html:</p>
<pre class='highlight'>
&lt;link rel="import" href="import.html">
...
&lt;me-second>&lt;/me-second>
...
</pre>

<p>import.html:</p>
<pre class='highlight'>&lt;me-first>&lt;/me-first></pre>
</div>

<p>The order of custom elements in the flattened import link tree is <code>me-first</code> (1), <code>me-second</code> (2). However, it's very likely that the parser will find out about <code>me-second</code> sooner than <code>me-first</code>, since the latter requires loading the <code>import.html</code>. While the network stack is doing its job, the highest stable order stays at the beginning position. When <code>import.html</code> is ready, the order jumps all the way to <code>me-second</code> (2).</p>

</div>

</section>

<section class="appendix">
<h2>Acknowledgments</h2>

<p><span class="vcard">David Hyatt</span> developed <a href="http://dev.w3.org/2006/xbl2/">XBL 1.0</a>, and <span class="vcard">Ian Hickson</span> co-wrote <a href="http://dev.w3.org/2006/xbl2/">XBL 2.0</a>. These documents provided tremendous insight into the problem of behavior attachment and greatly influenced this specification.</p>

<p><span class="vcard">Alex Russell</span> and his considerable forethought triggered a new wave of enthusiasm around the subject of behavior attachment and how it can be applied practically on the Web.</p>

<p><span class="vcard">Dominic Cooney</span> and <span class="vcard">Roland Steiner</span> worked tirelessly to scope the problem within the confines of the Web platform and provided a solid foundation for this document.</p>

<p>The editor would also like to thank <span class="vcard">Alex Komoroske</span>, <span class="vcard">Angelina Fabbro</span>, <span class="vcard">Anne van Kesteren</span>, <span class="vcard">Boris Zbarsky</span>, <span class="vcard">Brian Kardell</span>, <span class="vcard">Daniel Buchner</span>, <span class="vcard">Edward O'Connor</span>, <span class="vcard">Eric Bidelman</span>, <span class="vcard">Erik Arvidsson</span>, <span class="vcard">Elliott Sprehn</span>, <span class="vcard">Gabor Krizsanits</span>, <span class="vcard">Hayato Ito</span>, <span class="vcard">James Simonsen</span>, <span class="vcard">Jonas Sicking</span>, <span class="vcard">Ken Shirriff</span>, <span class="vcard">Neel Goyal</span>, <span class="vcard">Olli Pettay</span>, <span class="vcard">Rafael Weinstein</span>, <span class="vcard">Scott Miles</span>, <span class="vcard">Steve Orvell</span>, <span class="vcard">Tab Atkins</span>, <span class="vcard">William Chan</span>, and <span class="vcard">William Chen</span> for their comments and contributions to this specification.</p>

<p>This list is too short. There's a lot of work left to do. Please contribute by reviewing and filing bugs&mdash;and don't forget to ask the editor to add your name into this section.</p>

</section>
</body>
</html>
<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'/>
    <title>Shadow DOM</title>
    <script src='./autolink-config.js' class='remove'></script>
    <script src='../../assets/scripts/autolink.js' class='remove'></script>
    <link rel="stylesheet" href="respec-complement.css" type="text/css" />
    <script src='//www.w3.org/Tools/respec/respec-w3c-common' async class='remove'></script>
    <script src='//resources.whatwg.org/dfn.js' defer class='remove'></script>
    <script class='remove'>
      function resolveBacklink() {
          // For dfn.js
          if (window.initDfn) {
              initDfn();
          }
      }
      var respecConfig = {
          specStatus: "ED",
          shortName: "shadow-dom",
          useExperimentalStyles: true,
          editors: [{ name: "Hayato Ito", url: "mailto:hayato@google.com", company: "Google, Inc.", w3cid: 49814 }],
          wg: "Web Platform Working Group",
          wgURI: "https://www.w3.org/WebPlatform/WG/",
          wgPublicList: "public-webapps",
          wgPatentURI: "https://www.w3.org/2004/01/pp-impl/83482/status",
          license: "w3c-software-doc",
          edDraftURI: "https://w3c.github.io/webcomponents/spec/shadow/",
          otherLinks: [
              {
                  key: "Revision history",
                  href: "https://github.com/w3c/webcomponents/commits/gh-pages/spec/shadow/"
              },
              {
                  key: "Bugs filed",
                  href: "https://github.com/w3c/webcomponents/labels/shadow-dom"
              },
              {
                  key: 'Implementation',
                  data: [
                      {
                          value: 'Can I use Shadow DOM?',
                          href: 'http://caniuse.com/#feat=shadowdomv1'
                      },
                      {
                          value: 'Test Suite',
                          href: 'http://w3c-test.org/shadow-dom/'
                      },
                      {
                          value: 'Test Suite repository',
                          href: 'https://github.com/w3c/web-platform-tests/tree/master/shadow-dom'
                      }
                  ]
              }
          ],
          preProcess: [resolveAutolink],
          postProcess: [resolveBacklink],
          localBiblio: {
              "EDITING": {
                  title: "HTML Editing APIs",
                  href: "https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html",
                  authors:  ["Aryeh Gregor"]
              }
          }
      };
    </script>
  </head>
  <body>
    <section id='abstract'>
      <p>
        This specification describes a method of combining multiple DOM trees into one hierarchy and how these trees interact with each other within a document, thus
        enabling better composition of the DOM.
      </p>

      <p class="warning">
        Shadow DOM specification is being upstreamed to DOM Standard [[WHATWG-DOM]], HTML Standard [[HTML]], CSS Scoping Module Level 1 [[css-scoping-1]],
        UI Events specification [[uievents]], and other relevant specifications.
        This specification may not accurately reflect the latest conclusion.
        See <a href="https://github.com/w3c/webcomponents/issues/377">Issue #377</a> for details.
      </p>
    </section>

    <section id='sotd'>
    </section>

    <section>
      <h2>Conformance</h2>

      <p>All diagrams, examples, notes, are non-normative, as well as sections explicitly marked as non-normative. Everything else in this specification is normative.</p>

      <p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in the normative parts of this document are to be interpreted as described in [[!RFC2119]]. For readability, these words do not appear in all uppercase letters in this specification.</p>

      <p>To help with layering and to avoid circular dependencies between various parts of specification, this document consists of three consecutive narratives:</p>
      <ol>
        <li>setting up the stage for the specification,</li>
        <li>explaining of the conceptual model and algorithms behind it, and</li>
        <li>expressing this model with DOM interfaces and HTML elements.</li>
      </ol>

      <p>In a sense, these parts can be viewed as <em>math</em>, which sets up the reasoning environment, <em>physics</em>, which is the theoretical reasoning about the concept, and <em>mechanics</em>, which is the practical application of this reasoning.</p>

      <p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="http://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn>processing equivalence</dfn> is a constraint imposed on the algorithm implementors, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>
    </section>

    <section>
      <h2>Shadow Tree</h2>

      <p class="warning">
        This section is a copy of <a href="https://dom.spec.whatwg.org/#shadow-trees">Shadow tree</a> in [[WHATWG-DOM]]. This section is expected to be synced with that periodically.
      </p>

   <p>A <dfn data-dfn-type="dfn" data-export="" id="concept-shadow-tree">shadow tree<a class="self-link" href="#concept-shadow-tree"></a></dfn> is a <a data-link-type="dfn" href="#concept-node-tree">node tree</a> whose <a data-link-type="dfn" href="#concept-tree-root">root</a> is a <a data-link-type="dfn" href="#concept-shadow-root">shadow root</a>. </p>
   <p>A <a data-link-type="dfn" href="#concept-shadow-root">shadow root</a> is always attached to another <a data-link-type="dfn" href="#concept-node-tree">node tree</a> through its <a data-link-type="dfn" href="#concept-documentfragment-host">host</a>. A <a data-link-type="dfn" href="#concept-shadow-tree">shadow tree</a> is therefore never alone. The <a data-link-type="dfn" href="#concept-node-tree">node tree</a> of a <a data-link-type="dfn" href="#concept-shadow-root">shadow root</a>’s <a data-link-type="dfn" href="#concept-documentfragment-host">host</a> is sometimes
referred to as the <dfn data-dfn-type="dfn" data-export="" id="concept-light-tree">light tree<a class="self-link" href="#concept-light-tree"></a></dfn>.</p>
   <p class="note" role="note">A <a data-link-type="dfn" href="#concept-shadow-tree">shadow tree</a>’s corresponding <a data-link-type="dfn" href="#concept-light-tree">light tree</a> can be a <a data-link-type="dfn" href="#concept-shadow-tree">shadow tree</a> itself.</p>
   <p id="in-a-shadow-including-document">An <a data-link-type="dfn" href="#concept-element">element</a> is <dfn data-dfn-type="dfn" data-export="" id="connected">connected<a class="self-link" href="#connected"></a></dfn> if its <a data-link-type="dfn" href="#concept-shadow-including-root">shadow-including root</a> is a <a data-link-type="dfn" href="#concept-document">document</a>. </p>

   <section>
   <h3 class="heading settled" data-level="4.2.2.1" id="shadow-tree-slots"><span class="content">Slots</span></h3>
   <p>A <a data-link-type="dfn" href="#concept-shadow-tree">shadow tree</a> contains zero or more <a data-link-type="dfn" href="#concept-element">elements</a> that are <dfn data-dfn-type="dfn" data-export="" data-lt="slot" id="concept-slot">slots<a class="self-link" href="#concept-slot"></a></dfn>.</p>
   <p class="note" role="note">A <a data-link-type="dfn" href="#concept-slot">slot</a> can only be created through HTML’s <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/scripting.html#the-slot-element">slot</a></code> element.</p>
   <p>A <a data-link-type="dfn" href="#concept-slot">slot</a> has an associated <dfn data-dfn-for="slot" data-dfn-type="dfn" data-export="" id="slot-name">name<a class="self-link" href="#slot-name"></a></dfn> (a string). Unless stated
otherwise it is the empty string.</p>
   <p>Use these <a data-link-type="dfn" href="#concept-element-attributes-change-ext">attribute change steps</a> to update a <a data-link-type="dfn" href="#concept-slot">slot</a>’s <a data-link-type="dfn" href="#slot-name">name</a>: </p>
   <ol>
    <li>
     <p>If <var>element</var> is a <a data-link-type="dfn" href="#concept-slot">slot</a>, <var>localName</var> is <code>name</code>, and <var>namespace</var> is null, then: </p>
     <ol>
      <li>
       <p>If <var>value</var> is <var>oldValue</var>, then return. </p>
      <li>
       <p>If <var>value</var> is null and <var>oldValue</var> is the empty string, then return. </p>
      <li>
       <p>If <var>value</var> is the empty string and <var>oldValue</var> is null, then return. </p>
      <li>
       <p>If <var>value</var> is null or the empty string, then set <var>element</var>’s <a data-link-type="dfn" href="#slot-name">name</a> to the empty string. </p>
      <li>
       <p>Otherwise, set <var>element</var>’s <a data-link-type="dfn" href="#slot-name">name</a> to <var>value</var>. </p>
      <li>
       <p>Run <a data-link-type="dfn" href="#assign-slotables-for-a-tree">assign slotables for a tree</a> with <var>element</var>’s <a data-link-type="dfn" href="#concept-tree">tree</a>. </p>
     </ol>
   </ol>
   <p class="note" role="note">The first <a data-link-type="dfn" href="#concept-slot">slot</a> in a <a data-link-type="dfn" href="#concept-shadow-tree">shadow tree</a>, in <a data-link-type="dfn" href="#concept-tree-order">tree order</a>, whose <a data-link-type="dfn" href="#slot-name">name</a> is the empty string, is sometimes known as the "default slot".</p>
   <p>A <a data-link-type="dfn" href="#concept-slot">slot</a> has an associated <dfn data-dfn-for="slot" data-dfn-type="dfn" data-export="" id="slot-assigned-nodes">assigned nodes<a class="self-link" href="#slot-assigned-nodes"></a></dfn> (a list of <a data-link-type="dfn" href="#concept-slotable">slotables</a>). Unless stated otherwise it is empty.</p>
   </section>

   <section>
   <h3 class="heading settled" data-level="4.2.2.2" id="light-tree-slotables"><span class="content">Slotables</span></h3>
   <p><code><a data-link-type="idl" href="#element">Element</a></code> and <code><a data-link-type="idl" href="#text">Text</a></code> <a data-link-type="dfn" href="#concept-node">nodes</a> are <dfn data-dfn-type="dfn" data-export="" data-lt="slotable" id="concept-slotable">slotables<a class="self-link" href="#concept-slotable"></a></dfn>.</p>
   <p class="note" role="note">A <a data-link-type="dfn" href="#concept-slot">slot</a> can be a <a data-link-type="dfn" href="#concept-slotable">slotable</a>. </p>
   <p>A <a data-link-type="dfn" href="#concept-slotable">slotable</a> has an associated <dfn data-dfn-for="slotable" data-dfn-type="dfn" data-export="" id="slotable-name">name<a class="self-link" href="#slotable-name"></a></dfn> (a string). Unless stated
otherwise it is the empty string.</p>
   <p>Use these <a data-link-type="dfn" href="#concept-element-attributes-change-ext">attribute change steps</a> to update a <a data-link-type="dfn" href="#concept-slotable">slotable</a>’s <a data-link-type="dfn" href="#slotable-name">name</a>: </p>
   <ol>
    <li>
     <p>If <var>localName</var> is <code>slot</code> and <var>namespace</var> is null, then: </p>
     <ol>
      <li>
       <p>If <var>value</var> is <var>oldValue</var>, then return. </p>
      <li>
       <p>If <var>value</var> is null and <var>oldValue</var> is the empty string, then return. </p>
      <li>
       <p>If <var>value</var> is the empty string and <var>oldValue</var> is null, then return. </p>
      <li>
       <p>If <var>value</var> is null or the empty string, then set <var>element</var>’s <a data-link-type="dfn" href="#slotable-name">name</a> to the empty string. </p>
      <li>
       <p>Otherwise, set <var>element</var>’s <a data-link-type="dfn" href="#slotable-name">name</a> to <var>value</var>. </p>
      <li>
       <p>If <var>element</var> is <a data-link-type="dfn" href="#slotable-assigned">assigned</a>, then run <a data-link-type="dfn" href="#assign-slotables">assign slotables</a> for <var>element</var>’s <a data-link-type="dfn" href="#slotable-assigned-slot">assigned slot</a>. </p>
      <li>
       <p>Run <a data-link-type="dfn" href="#assign-a-slot">assign a slot</a> for <var>element</var>. </p>
     </ol>
   </ol>
   <p>A <a data-link-type="dfn" href="#concept-slotable">slotable</a> has an associated <dfn data-dfn-for="slotable" data-dfn-type="dfn" data-export="" id="slotable-assigned-slot">assigned slot<a class="self-link" href="#slotable-assigned-slot"></a></dfn> (null or a <a data-link-type="dfn" href="#concept-slot">slot</a>). Unless stated otherwise it is null. A <a data-link-type="dfn" href="#concept-slotable">slotable</a> is <dfn data-dfn-for="slotable" data-dfn-type="dfn" data-export="" id="slotable-assigned">assigned<a class="self-link" href="#slotable-assigned"></a></dfn> if its <a data-link-type="dfn" href="#slotable-assigned-slot">assigned slot</a> is non-null.</p>
   </section>

   <section>
   <h3 class="heading settled" data-level="4.2.2.3" id="finding-slots-and-slotables"><span class="content">Finding slots and slotables</span></h3>
   <p>To <dfn data-dfn-type="dfn" data-export="" data-lt="find a slot|finding a slot" id="find-a-slot">find a slot<a class="self-link" href="#find-a-slot"></a></dfn> for a given <a data-link-type="dfn" href="#concept-slotable">slotable</a> <var>slotable</var> and an optional <i>open flag</i> (unset unless stated otherwise), run these
steps:</p>
   <ol>
    <li>
     <p>If <var>slotable</var>’s <a data-link-type="dfn" href="#concept-tree-parent">parent</a> is null, then return null.</p>
    <li>
     <p>Let <var>shadow</var> be <var>slotable</var>’s <a data-link-type="dfn" href="#concept-tree-parent">parent</a>’s <a data-link-type="dfn" href="#concept-element-shadow-root">shadow root</a>.</p>
    <li>
     <p>If <var>shadow</var> is null, then return null.</p>
    <li>
     <p>If the <i>open flag</i> is set and <var>shadow</var>’s <a data-link-type="dfn" href="#shadowroot-mode">mode</a> is <em>not</em> "<code>open</code>", then return null.</p>
    <li>
     <p>Return the first <a data-link-type="dfn" href="#concept-slot">slot</a> in <var>shadow</var>’s <a data-link-type="dfn" href="#concept-tree">tree</a> whose <a data-link-type="dfn" href="#slot-name">name</a> is <var>slotable</var>’s <a data-link-type="dfn" href="#slotable-name">name</a>, if any, and null otherwise.</p>
   </ol>
   <p>To <dfn data-dfn-type="dfn" data-export="" data-lt="find slotables|finding slotables" id="find-slotables">find slotables<a class="self-link" href="#find-slotables"></a></dfn> for a given <a data-link-type="dfn" href="#concept-slot">slot</a> <var>slot</var>, run these steps:</p>
   <ol>
    <li>
     <p>Let <var>result</var> be an empty list.</p>
    <li>
     <p>If <var>slot</var>’s <a data-link-type="dfn" href="#concept-tree-root">root</a> is not a <a data-link-type="dfn" href="#concept-shadow-root">shadow root</a>, then return <var>result</var>.</p>
    <li>
     <p>Let <var>host</var> be <var>slot</var>’s <a data-link-type="dfn" href="#concept-tree-root">root</a>’s <a data-link-type="dfn" href="#concept-documentfragment-host">host</a>.</p>
    <li>
     <p>For each <a data-link-type="dfn" href="#concept-slotable">slotable</a> <a data-link-type="dfn" href="#concept-tree-child">child</a> of <var>host</var>, <var>slotable</var>, in <a data-link-type="dfn" href="#concept-tree-order">tree order</a>, run these substeps:</p>
     <ol>
      <li>
       <p>Let <var>foundSlot</var> be the result of <a data-link-type="dfn" href="#find-a-slot">finding a slot</a> given <var>slotable</var>.</p>
      <li>
       <p>If <var>foundSlot</var> is <var>slot</var>, then append <var>slotable</var> to <var>result</var>.</p>
     </ol>
    <li>
     <p>Return <var>result</var>.</p>
   </ol>
   <p>To <dfn data-dfn-type="dfn" data-export="" data-lt="find flattened slotables|finding flattened slotables" id="find-flattened-slotables">find flattened slotables<a class="self-link" href="#find-flattened-slotables"></a></dfn> for a given <a data-link-type="dfn" href="#concept-slot">slot</a> <var>slot</var>, run these steps:</p>
   <ol>
    <li>
     <p>Let <var>result</var> be an empty list.</p>
    <li>
     <p>Let <var>slotables</var> be the result of <a data-link-type="dfn" href="#find-slotables">finding slotables</a> given <var>slot</var>.</p>
    <li>
     <p>If <var>slotables</var> is the empty list, then append each <a data-link-type="dfn" href="#concept-slotable">slotable</a> <a data-link-type="dfn" href="#concept-tree-child">child</a> of <var>slot</var>, in <a data-link-type="dfn" href="#concept-tree-order">tree order</a>, to <var>slotables</var>.</p>
    <li>
     <p>For each <var>node</var> in <var>slotables</var>, run these substeps:</p>
     <ol>
      <li>
       <p>If <var>node</var> is a <a data-link-type="dfn" href="#concept-slot">slot</a>, run these subsubsteps:</p>
       <ol>
        <li>
         <p>Let <var>temporaryResult</var> be the result of <a data-link-type="dfn" href="#find-flattened-slotables">finding flattened slotables</a> given <var>node</var>.</p>
        <li>
         <p>Append each <a data-link-type="dfn" href="#concept-slotable">slotable</a> in <var>temporaryResult</var>, in order, to <var>result</var>.</p>
       </ol>
      <li>
       <p>Otherwise, append <var>node</var> to <var>result</var>.</p>
     </ol>
    <li>
     <p>Return <var>result</var>.</p>
   </ol>
   </section>

   <section>
   <h3 class="heading settled" data-level="4.2.2.4" id="assigning-slotables-and-slots"><span class="content">Assigning slotables and slots</span></h3>
   <p>To <dfn data-dfn-type="dfn" data-noexport="" id="assign-slotables">assign slotables<a class="self-link" href="#assign-slotables"></a></dfn>, for a <a data-link-type="dfn" href="#concept-slot">slot</a> <var>slot</var> with an optional <var>suppress signaling flag</var> (unset unless stated otherwise), run these steps: </p>
   <ol>
    <li>
     <p>Let <var>slotables</var> be the result of <a data-link-type="dfn" href="#find-slotables">finding slotables</a> for <var>slot</var>. </p>
    <li>
     <p>If <var>suppress signaling flag</var> is unset, and <var>slotables</var> and <var>slot</var>’s <a data-link-type="dfn" href="#slot-assigned-nodes">assigned nodes</a> are not identical, then run <a data-link-type="dfn" href="#signal-a-slot-change">signal a slot change</a> for <var>slot</var>. </p>
    <li>
     <p>Set <var>slot</var>’s <a data-link-type="dfn" href="#slot-assigned-nodes">assigned nodes</a> to <var>slotables</var>. </p>
    <li>
     <p>For each <var>slotable</var> in <var>slotables</var>, set <var>slotable</var>’s <a data-link-type="dfn" href="#slotable-assigned-slot">assigned slot</a> to <var>slot</var>. </p>
   </ol>
   <p>To <dfn data-dfn-type="dfn" data-noexport="" id="assign-slotables-for-a-tree">assign slotables for a tree<a class="self-link" href="#assign-slotables-for-a-tree"></a></dfn>, given a <a data-link-type="dfn" href="#concept-tree">tree</a> <var>tree</var> and an
optional set of <a data-link-type="dfn" href="#concept-slot">slots</a> <var>noSignalSlots</var> (empty unless stated otherwise), run these
steps for each <a data-link-type="dfn" href="#concept-slot">slot</a> <var>slot</var> in <var>tree</var>, in <a data-link-type="dfn" href="#concept-tree-order">tree order</a>: </p>
   <ol>
    <li>
     <p>Let <var>suppress signaling flag</var> be set, if <var>slot</var> is in <var>noSignalSlots</var>, and unset otherwise.</p>
    <li>
     <p>Run <a data-link-type="dfn" href="#assign-slotables">assign slotables</a> for <var>slot</var> with <var>suppress signaling flag</var>. </p>
   </ol>
   <p>To <dfn data-dfn-type="dfn" data-noexport="" id="assign-a-slot">assign a slot<a class="self-link" href="#assign-a-slot"></a></dfn>, given a <a data-link-type="dfn" href="#concept-slotable">slotable</a> <var>slotable</var>, run these
steps: </p>
   <ol>
    <li>
     <p>Let <var>slot</var> be the result of <a data-link-type="dfn" href="#find-a-slot">finding a slot</a> with <var>slotable</var>. </p>
    <li>
     <p>If <var>slot</var> is non-null, then run <a data-link-type="dfn" href="#assign-slotables">assign slotables</a> for <var>slot</var>. </p>
   </ol>
   </section>

   <section>
   <h3 class="heading settled" data-level="4.2.2.5" id="signaling-slot-change"><span class="content">Signaling slot change</span></h3>
   <p>Each <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts">unit of related similar-origin browsing contexts</a> has a <dfn data-dfn-type="dfn" data-export="" id="signal-slot-list">signal slot list<a class="self-link" href="#signal-slot-list"></a></dfn> (a list of <a data-link-type="dfn" href="#concept-slot">slots</a>). Unless stated otherwise it is empty. <a data-link-type="biblio" href="#biblio-html">[HTML]</a> </p>
   <p>To <dfn data-dfn-type="dfn" data-noexport="" id="signal-a-slot-change">signal a slot change<a class="self-link" href="#signal-a-slot-change"></a></dfn>, for a <a data-link-type="dfn" href="#concept-slot">slot</a> <var>slot</var>, run these steps: </p>
   <ol>
    <li>
     <p>If <var>slot</var> is not in <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts">unit of related similar-origin browsing contexts</a>' <a data-link-type="dfn" href="#signal-slot-list">signal slot list</a>, append <var>slot</var> to <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts">unit of related similar-origin browsing contexts</a>' <a data-link-type="dfn" href="#signal-slot-list">signal slot list</a>. </p>
    <li>
     <p><a data-link-type="dfn" href="#queue-a-mutation-observer-compound-microtask">Queue a mutation observer compound microtask</a>. </p>
   </ol>
   </section>

   </section>

   <section>
   <h2 class="heading settled" data-level="4.2.3" id="mutation-algorithms"><span class="content">Mutation algorithms</span></h2>

   <p class="warning">
     This section is a copy of <a href="https://dom.spec.whatwg.org/#mutation-algorithms">Mutation algorithms</a> in [[WHATWG-DOM]]. This section is expected to be synced with that periodically.
   </p>

   <p>To <dfn data-dfn-for="Node" data-dfn-type="dfn" data-export="" id="concept-node-ensure-pre-insertion-validity">ensure pre-insertion validity<a class="self-link" href="#concept-node-ensure-pre-insertion-validity"></a></dfn> of a <var>node</var> into a <var>parent</var> before a <var>child</var>, run these steps: </p>
   <ol>
    <li>If <var>parent</var> is not a <code><a data-link-type="idl" href="#document">Document</a></code>, <code><a data-link-type="idl" href="#documentfragment">DocumentFragment</a></code>, or <code><a data-link-type="idl" href="#element">Element</a></code> <a data-link-type="dfn" href="#concept-node">node</a>, <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a data-link-type="idl" href="https://heycam.github.io/webidl/#hierarchyrequesterror">HierarchyRequestError</a></code>.
    <li>If <var>node</var> is a <a data-link-type="dfn" href="#concept-tree-host-including-inclusive-ancestor">host-including inclusive ancestor</a> of <var>parent</var>, <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a data-link-type="idl" href="https://heycam.github.io/webidl/#hierarchyrequesterror">HierarchyRequestError</a></code>.
    <li>If <var>child</var> is not null and its <a data-link-type="dfn" href="#concept-tree-parent">parent</a> is not <var>parent</var>, then <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a data-link-type="idl" href="https://heycam.github.io/webidl/#notfounderror">NotFoundError</a></code>.
    <li>If <var>node</var> is not a <code><a data-link-type="idl" href="#documentfragment">DocumentFragment</a></code>, <code><a data-link-type="idl" href="#documenttype">DocumentType</a></code>, <code><a data-link-type="idl" href="#element">Element</a></code>, <code><a data-link-type="idl" href="#text">Text</a></code>, <code><a data-link-type="idl" href="#processinginstruction">ProcessingInstruction</a></code>, or <code><a data-link-type="idl" href="#comment">Comment</a></code> <a data-link-type="dfn" href="#concept-node">node</a>, <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a data-link-type="idl" href="https://heycam.github.io/webidl/#hierarchyrequesterror">HierarchyRequestError</a></code>.
    <li>If either <var>node</var> is a <code><a data-link-type="idl" href="#text">Text</a></code> <a data-link-type="dfn" href="#concept-node">node</a> and <var>parent</var> is a <a data-link-type="dfn" href="#concept-document">document</a>, or <var>node</var> is a <a data-link-type="dfn" href="#concept-doctype">doctype</a> and <var>parent</var> is
 not a <a data-link-type="dfn" href="#concept-document">document</a>, <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a data-link-type="idl" href="https://heycam.github.io/webidl/#hierarchyrequesterror">HierarchyRequestError</a></code>.
    <li>
      If <var>parent</var> is a <a data-link-type="dfn" href="#concept-document">document</a>, and any of the statements below, switched
  on <var>node</var>, are true, <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a data-link-type="idl" href="https://heycam.github.io/webidl/#hierarchyrequesterror">HierarchyRequestError</a></code>.
     <dl class="switch">
      <dt><code><a data-link-type="idl" href="#documentfragment">DocumentFragment</a></code> <a data-link-type="dfn" href="#concept-node">node</a>
      <dd>
        If <var>node</var> has more than one <a data-link-type="dfn" href="#concept-element">element</a> <a data-link-type="dfn" href="#concept-tree-child">child</a> or has a <code><a data-link-type="idl" href="#text">Text</a></code> <a data-link-type="dfn" href="#concept-node">node</a> <a data-link-type="dfn" href="#concept-tree-child">child</a>.
       <p>Otherwise, if <var>node</var> has one <a data-link-type="dfn" href="#concept-element">element</a> <a data-link-type="dfn" href="#concept-tree-child">child</a> and either <var>parent</var> has an <a data-link-type="dfn" href="#concept-element">element</a> <a data-link-type="dfn" href="#concept-tree-child">child</a>, <var>child</var> is a <a data-link-type="dfn" href="#concept-doctype">doctype</a>, or <var>child</var> is not null and
    a <a data-link-type="dfn" href="#concept-doctype">doctype</a> is <a data-link-type="dfn" href="#concept-tree-following">following</a> <var>child</var>.</p>
      <dt><a data-link-type="dfn" href="#concept-element">element</a>
      <dd><var>parent</var> has an <a data-link-type="dfn" href="#concept-element">element</a> <a data-link-type="dfn" href="#concept-tree-child">child</a>, <var>child</var> is a <a data-link-type="dfn" href="#concept-doctype">doctype</a>, or <var>child</var> is not null and a <a data-link-type="dfn" href="#concept-doctype">doctype</a> is <a data-link-type="dfn" href="#concept-tree-following">following</a> <var>child</var>.
      <dt><a data-link-type="dfn" href="#concept-doctype">doctype</a>
      <dd><var>parent</var> has a <a data-link-type="dfn" href="#concept-doctype">doctype</a> <a data-link-type="dfn" href="#concept-tree-child">child</a>, <var>child</var> is non-null and an <a data-link-type="dfn" href="#concept-element">element</a> is <a data-link-type="dfn" href="#concept-tree-preceding">preceding</a> <var>child</var>,
   or <var>child</var> is null and <var>parent</var> has an <a data-link-type="dfn" href="#concept-element">element</a> <a data-link-type="dfn" href="#concept-tree-child">child</a>.
     </dl>
   </ol>
   <p>To <dfn data-dfn-type="dfn" data-export="" id="concept-node-pre-insert">pre-insert<a class="self-link" href="#concept-node-pre-insert"></a></dfn> a <var>node</var> into a <var>parent</var> before a <var>child</var>, run these steps: </p>
   <ol>
    <li><a data-link-type="dfn" href="#concept-node-ensure-pre-insertion-validity">Ensure pre-insertion validity</a> of <var>node</var> into <var>parent</var> before <var>child</var>.
    <li>Let <var>reference child</var> be <var>child</var>.
    <li>If <var>reference child</var> is <var>node</var>, set it
 to <var>node</var>’s <a data-link-type="dfn" href="#concept-tree-next-sibling">next sibling</a>.
    <li><a data-link-type="dfn" href="#concept-node-adopt">Adopt</a> <var>node</var> into <var>parent</var>’s <a data-link-type="dfn" href="#concept-node-document">node document</a>.
    <li><a data-link-type="dfn" href="#concept-node-insert">Insert</a> <var>node</var> into <var>parent</var> before <var>reference child</var>.
    <li>Return <var>node</var>.
   </ol>
   <p><a data-link-type="dfn" href="#other-applicable-specifications">Specifications</a> may define <dfn data-dfn-type="dfn" data-export="" id="concept-node-insert-ext">insertion steps<a class="self-link" href="#concept-node-insert-ext"></a></dfn> for all or some <a data-link-type="dfn" href="#concept-node">nodes</a>.
The algorithm is passed <var>insertedNode</var>, as indicated in the <a data-link-type="dfn" href="#concept-node-insert">insert</a> algorithm below. </p>
   <p>To <dfn data-dfn-type="dfn" data-export="" id="concept-node-insert">insert<a class="self-link" href="#concept-node-insert"></a></dfn> a <var>node</var> into a <var>parent</var> before a <var>child</var>, with an optional <i>suppress observers flag</i>, run these steps: </p>
   <ol>
    <li>Let <var>count</var> be the number of <a data-link-type="dfn" href="#concept-tree-child">children</a> of <var>node</var> if
 it is a <code><a data-link-type="idl" href="#documentfragment">DocumentFragment</a></code> <a data-link-type="dfn" href="#concept-node">node</a>,
 and one otherwise.
    <li>
      If <var>child</var> is non-null, run these substeps:
     <ol>
      <li>For each <a data-link-type="dfn" href="#concept-range">range</a> whose <a data-link-type="dfn" href="#concept-range-start-node">start node</a> is <var>parent</var> and <a data-link-type="dfn" href="#concept-range-start-offset">start offset</a> is greater than <var>child</var>’s <a data-link-type="dfn" href="#concept-tree-index">index</a>,
   increase its <a data-link-type="dfn" href="#concept-range-start-offset">start offset</a> by <var>count</var>.
      <li>For each <a data-link-type="dfn" href="#concept-range">range</a> whose <a data-link-type="dfn" href="#concept-range-end-node">end node</a> is <var>parent</var> and <a data-link-type="dfn" href="#concept-range-end-offset">end offset</a> is greater than <var>child</var>’s <a data-link-type="dfn" href="#concept-tree-index">index</a>,
   increase its <a data-link-type="dfn" href="#concept-range-end-offset">end offset</a> by <var>count</var>.
     </ol>
    <li>Let <var>nodes</var> be <var>node</var>’s <a data-link-type="dfn" href="#concept-tree-child">children</a> if <var>node</var> is
 a <code><a data-link-type="idl" href="#documentfragment">DocumentFragment</a></code> <a data-link-type="dfn" href="#concept-node">node</a>, and a
 list containing solely <var>node</var> otherwise.
    <li>If <var>node</var> is a <code><a data-link-type="idl" href="#documentfragment">DocumentFragment</a></code> <a data-link-type="dfn" href="#concept-node">node</a>, <a data-link-type="dfn" href="#concept-node-remove">remove</a> its <a data-link-type="dfn" href="#concept-tree-child">children</a> with the <i>suppress observers flag</i> set.
    <li>
      If <var>node</var> is a <code><a data-link-type="idl" href="#documentfragment">DocumentFragment</a></code> <a data-link-type="dfn" href="#concept-node">node</a>, <a data-link-type="dfn" href="#queue-a-mutation-record">queue a mutation record</a> of "<code>childList</code>" for <var>node</var> with removedNodes <var>nodes</var>.
     <p class="note no-backref" role="note">This step intentionally does not pay attention to the <i>suppress observers flag</i>. </p>
    <li>
     <p>For each <var>node</var> in <var>nodes</var>, in <a data-link-type="dfn" href="#concept-tree-order">tree order</a>, run these substeps: </p>
     <ol>
      <li>
       <p>Insert <var>node</var> into <var>parent</var> before <var>child</var> or at the end of <var>parent</var> if <var>child</var> is null. </p>
      <li>
       <p>If <var>parent</var> is a <a data-link-type="dfn" href="#element-shadow-host">shadow host</a> and <var>node</var> is a <a data-link-type="dfn" href="#concept-slotable">slotable</a>, then <a data-link-type="dfn" href="#assign-a-slot">assign a slot</a> for <var>node</var>. </p>
      <li>
       <p>If <var>parent</var> is a <a data-link-type="dfn" href="#concept-slot">slot</a> whose <a data-link-type="dfn" href="#slot-assigned-nodes">assigned nodes</a> is the empty
   list, then run <a data-link-type="dfn" href="#signal-a-slot-change">signal a slot change</a> for <var>parent</var>. </p>
      <li>
       <p>Run <a data-link-type="dfn" href="#assign-slotables-for-a-tree">assign slotables for a tree</a> with <var>node</var>’s <a data-link-type="dfn" href="#concept-tree">tree</a> and a set
   containing each <a data-link-type="dfn" href="#concept-tree-inclusive-descendant">inclusive descendant</a> of <var>node</var> that is a <a data-link-type="dfn" href="#concept-slot">slot</a>. </p>
      <li>
       <p>For each <a data-link-type="dfn" href="#concept-shadow-including-inclusive-descendant">shadow-including inclusive descendant</a> <var>inclusiveDescendant</var> of <var>node</var>, in <a data-link-type="dfn" href="#concept-shadow-including-tree-order">shadow-including tree order</a>, run these subsubsteps: </p>
       <ol>
        <li>
         <p>Run the <a data-link-type="dfn" href="#concept-node-insert-ext">insertion steps</a> with <var>inclusiveDescendant</var>. </p>
        <li>
         <p>If <var>inclusiveDescendant</var> is <a data-link-type="dfn" href="#connected">connected</a>, then: </p>
         <ol>
          <li>
           <p>If <var>inclusiveDescendant</var> is <a data-link-type="dfn" href="#concept-element-custom">custom</a>, then <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/scripting.html#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>inclusiveDescendant</var>,
       callback name "<code>connectedCallback</code>", and an empty argument list. </p>
          <li>
           <p>Otherwise, <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/scripting.html#concept-try-upgrade">try to upgrade</a> <var>inclusiveDescendant</var>. </p>
           <p class="note" role="note">If this successfully upgrades <var>inclusiveDescendant</var>, its <code>connectedCallback</code> will be enqueued automatically during the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/scripting.html#concept-upgrade-an-element">upgrade an element</a> algorithm. </p>
         </ol>
       </ol>
     </ol>
    <li>If <i>suppress observers flag</i> is unset, <a data-link-type="dfn" href="#queue-a-mutation-record">queue a mutation record</a> of "<code>childList</code>" for <var>parent</var> with addedNodes <var>nodes</var>, nextSibling <var>child</var>, and previousSibling <var>child</var>’s <a data-link-type="dfn" href="#concept-tree-previous-sibling">previous sibling</a> or <var>parent</var>’s <a data-link-type="dfn" href="#concept-tree-last-child">last child</a> if <var>child</var> is null.
   </ol>
   <p>To <dfn data-dfn-type="dfn" data-export="" id="concept-node-append">append<a class="self-link" href="#concept-node-append"></a></dfn> a <var>node</var> to a <var>parent</var>, <a data-link-type="dfn" href="#concept-node-pre-insert">pre-insert</a> <var>node</var> into <var>parent</var> before null. </p>
   <p>To <dfn data-dfn-type="dfn" data-export="" id="concept-node-replace">replace<a class="self-link" href="#concept-node-replace"></a></dfn> a <var>child</var> with <var>node</var> within a <var>parent</var>, run these steps: </p>
   <ol>
    <li>If <var>parent</var> is not a <code><a data-link-type="idl" href="#document">Document</a></code>, <code><a data-link-type="idl" href="#documentfragment">DocumentFragment</a></code>, or <code><a data-link-type="idl" href="#element">Element</a></code> <a data-link-type="dfn" href="#concept-node">node</a>, <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a data-link-type="idl" href="https://heycam.github.io/webidl/#hierarchyrequesterror">HierarchyRequestError</a></code>.
    <li>If <var>node</var> is a <a data-link-type="dfn" href="#concept-tree-host-including-inclusive-ancestor">host-including inclusive ancestor</a> of <var>parent</var>, <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a data-link-type="idl" href="https://heycam.github.io/webidl/#hierarchyrequesterror">HierarchyRequestError</a></code>.
    <li>If <var>child</var>’s <a data-link-type="dfn" href="#concept-tree-parent">parent</a> is not <var>parent</var>, then <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a data-link-type="idl" href="https://heycam.github.io/webidl/#notfounderror">NotFoundError</a></code>.
    <li>If <var>node</var> is not a <code><a data-link-type="idl" href="#documentfragment">DocumentFragment</a></code>, <code><a data-link-type="idl" href="#documenttype">DocumentType</a></code>, <code><a data-link-type="idl" href="#element">Element</a></code>, <code><a data-link-type="idl" href="#text">Text</a></code>, <code><a data-link-type="idl" href="#processinginstruction">ProcessingInstruction</a></code>, or <code><a data-link-type="idl" href="#comment">Comment</a></code> <a data-link-type="dfn" href="#concept-node">node</a>, <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a data-link-type="idl" href="https://heycam.github.io/webidl/#hierarchyrequesterror">HierarchyRequestError</a></code>.
    <li>If either <var>node</var> is a <code><a data-link-type="idl" href="#text">Text</a></code> <a data-link-type="dfn" href="#concept-node">node</a> and <var>parent</var> is a <a data-link-type="dfn" href="#concept-document">document</a>, or <var>node</var> is a <a data-link-type="dfn" href="#concept-doctype">doctype</a> and <var>parent</var> is
 not a <a data-link-type="dfn" href="#concept-document">document</a>, <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a data-link-type="idl" href="https://heycam.github.io/webidl/#hierarchyrequesterror">HierarchyRequestError</a></code>.
    <li>
      If <var>parent</var> is a <a data-link-type="dfn" href="#concept-document">document</a>, and any of the statements below, switched
  on <var>node</var>, are true, <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a data-link-type="idl" href="https://heycam.github.io/webidl/#hierarchyrequesterror">HierarchyRequestError</a></code>.
     <dl class="switch">
      <dt><code><a data-link-type="idl" href="#documentfragment">DocumentFragment</a></code> <a data-link-type="dfn" href="#concept-node">node</a>
      <dd>
        If <var>node</var> has more than one <a data-link-type="dfn" href="#concept-element">element</a> <a data-link-type="dfn" href="#concept-tree-child">child</a> or has a <code><a data-link-type="idl" href="#text">Text</a></code> <a data-link-type="dfn" href="#concept-node">node</a> <a data-link-type="dfn" href="#concept-tree-child">child</a>.
       <p>Otherwise, if <var>node</var> has one <a data-link-type="dfn" href="#concept-element">element</a> <a data-link-type="dfn" href="#concept-tree-child">child</a> and either <var>parent</var> has an <a data-link-type="dfn" href="#concept-element">element</a> <a data-link-type="dfn" href="#concept-tree-child">child</a> that is not <var>child</var> or a <a data-link-type="dfn" href="#concept-doctype">doctype</a> is <a data-link-type="dfn" href="#concept-tree-following">following</a> <var>child</var>.</p>
      <dt><a data-link-type="dfn" href="#concept-element">element</a>
      <dd><var>parent</var> has an <a data-link-type="dfn" href="#concept-element">element</a> <a data-link-type="dfn" href="#concept-tree-child">child</a> that is not <var>child</var> or a <a data-link-type="dfn" href="#concept-doctype">doctype</a> is <a data-link-type="dfn" href="#concept-tree-following">following</a> <var>child</var>.
      <dt><a data-link-type="dfn" href="#concept-doctype">doctype</a>
      <dd><var>parent</var> has a <a data-link-type="dfn" href="#concept-doctype">doctype</a> <a data-link-type="dfn" href="#concept-tree-child">child</a> that is not <var>child</var>, or an <a data-link-type="dfn" href="#concept-element">element</a> is <a data-link-type="dfn" href="#concept-tree-preceding">preceding</a> <var>child</var>.
     </dl>
     <p class="note no-backref" role="note">The above statements differ from the <a data-link-type="dfn" href="#concept-node-pre-insert">pre-insert</a> algorithm. </p>
    <li>Let <var>reference child</var> be <var>child</var>’s <a data-link-type="dfn" href="#concept-tree-next-sibling">next sibling</a>.
    <li>If <var>reference child</var> is <var>node</var>, set it
 to <var>node</var>’s <a data-link-type="dfn" href="#concept-tree-next-sibling">next sibling</a>.
    <li>
     <p>Let <var>previousSibling</var> be <var>child</var>’s <a data-link-type="dfn" href="#concept-tree-previous-sibling">previous sibling</a>. </p>
    <li><a data-link-type="dfn" href="#concept-node-adopt">Adopt</a> <var>node</var> into <var>parent</var>’s <a data-link-type="dfn" href="#concept-node-document">node document</a>.
    <li>Let <var>removedNodes</var> be the empty list.
    <li>
     <p>If <var>child</var>’s <a data-link-type="dfn" href="#concept-tree-parent">parent</a> is not null, run these substeps: </p>
     <ol>
      <li>
       <p>Set <var>removedNodes</var> to a list solely containing <var>child</var>. </p>
      <li>
       <p><a data-link-type="dfn" href="#concept-node-remove">Remove</a> <var>child</var> from its <var>parent</var> with the <i>suppress observers flag</i> set. </p>
     </ol>
     <p class="note no-backref" role="note">The above can only be false if <var>child</var> is <var>node</var>. </p>
    <li>Let <var>nodes</var> be <var>node</var>’s <a data-link-type="dfn" href="#concept-tree-child">children</a> if <var>node</var> is a <code><a data-link-type="idl" href="#documentfragment">DocumentFragment</a></code> <a data-link-type="dfn" href="#concept-node">node</a>, and a list containing solely <var>node</var> otherwise.
    <li><a data-link-type="dfn" href="#concept-node-insert">Insert</a> <var>node</var> into <var>parent</var> before <var>reference child</var> with
 the <i>suppress observers flag</i> set.
    <li><a data-link-type="dfn" href="#queue-a-mutation-record">Queue a mutation record</a> of "<code>childList</code>" for target <var>parent</var> with addedNodes <var>nodes</var>, removedNodes <var>removedNodes</var>,
 nextSibling <var>reference child</var>, and previousSibling <var>previousSibling</var>.
    <li>Return <var>child</var>.
   </ol>
   <p>To <dfn data-dfn-for="Node" data-dfn-type="dfn" data-export="" id="concept-node-replace-all">replace all<a class="self-link" href="#concept-node-replace-all"></a></dfn> with a <var>node</var> within a <var>parent</var>, run these steps:</p>
   <ol>
    <li>If <var>node</var> is not null, <a data-link-type="dfn" href="#concept-node-adopt">adopt</a> <var>node</var> into <var>parent</var>’s <a data-link-type="dfn" href="#concept-node-document">node document</a>.
    <li>Let <var>removedNodes</var> be <var>parent</var>’s <a data-link-type="dfn" href="#concept-tree-child">children</a>.
    <li>Let <var>addedNodes</var> be the empty list if <var>node</var> is
 null, <var>node</var>’s <a data-link-type="dfn" href="#concept-tree-child">children</a> if <var>node</var> is a <code><a data-link-type="idl" href="#documentfragment">DocumentFragment</a></code> <a data-link-type="dfn" href="#concept-node">node</a>, and a list containing <var>node</var> otherwise.
    <li><a data-link-type="dfn" href="#concept-node-remove">Remove</a> all <var>parent</var>’s <a data-link-type="dfn" href="#concept-tree-child">children</a>, in <a data-link-type="dfn" href="#concept-tree-order">tree order</a>, with the <i>suppress observers flag</i> set.
    <li>If <var>node</var> is not null, <a data-link-type="dfn" href="#concept-node-insert">insert</a> <var>node</var> into <var>parent</var> before null with the <i>suppress observers flag</i> set.
    <li><a data-link-type="dfn" href="#queue-a-mutation-record">Queue a mutation record</a> of "<code>childList</code>" for <var>parent</var> with addedNodes <var>addedNodes</var> and
 removedNodes <var>removedNodes</var>.
   </ol>
   <p class="note no-backref" role="note">This algorithm does not make any checks with regards to the <a data-link-type="dfn" href="#concept-node-tree">node tree</a> constraints. Specification authors need to use it wisely. </p>
   <p>To <dfn data-dfn-type="dfn" data-export="" id="concept-node-pre-remove">pre-remove<a class="self-link" href="#concept-node-pre-remove"></a></dfn> a <var>child</var> from a <var>parent</var>, run these steps:</p>
   <ol>
    <li>If <var>child</var>’s <a data-link-type="dfn" href="#concept-tree-parent">parent</a> is not <var>parent</var>, then <a data-link-type="dfn" href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a data-link-type="idl" href="https://heycam.github.io/webidl/#notfounderror">NotFoundError</a></code>.
    <li><a data-link-type="dfn" href="#concept-node-remove">Remove</a> <var>child</var> from <var>parent</var>.
    <li>Return <var>child</var>.
   </ol>
   <p><a data-link-type="dfn" href="#other-applicable-specifications">Specifications</a> may define <dfn data-dfn-type="dfn" data-export="" id="concept-node-remove-ext">removing steps<a class="self-link" href="#concept-node-remove-ext"></a></dfn> for all or some <a data-link-type="dfn" href="#concept-node">nodes</a>. The
algorithm is passed <var>removedNode</var>, and optionally <var>oldParent</var>, as indicated in the <a data-link-type="dfn" href="#concept-node-remove">remove</a> algorithm below. </p>
   <p>To <dfn data-dfn-type="dfn" data-export="" id="concept-node-remove">remove<a class="self-link" href="#concept-node-remove"></a></dfn> a <var>node</var> from a <var>parent</var>,
with an optional <i>suppress observers flag</i>, run these steps: </p>
   <ol>
    <li>Let <var>index</var> be <var>node</var>’s <a data-link-type="dfn" href="#concept-tree-index">index</a>.
    <li>For each <a data-link-type="dfn" href="#concept-range">range</a> whose <a data-link-type="dfn" href="#concept-range-start-node">start node</a> is an <a data-link-type="dfn" href="#concept-tree-inclusive-descendant">inclusive descendant</a> of <var>node</var>, set its <a data-link-type="dfn" href="#concept-range-start">start</a> to
 (<var>parent</var>, <var>index</var>).
    <li>For each <a data-link-type="dfn" href="#concept-range">range</a> whose <a data-link-type="dfn" href="#concept-range-end-node">end node</a> is an <a data-link-type="dfn" href="#concept-tree-inclusive-descendant">inclusive descendant</a> of <var>node</var>, set its <a data-link-type="dfn" href="#concept-range-end">end</a> to
 (<var>parent</var>, <var>index</var>).
    <li>For each <a data-link-type="dfn" href="#concept-range">range</a> whose <a data-link-type="dfn" href="#concept-range-start-node">start node</a> is <var>parent</var> and <a data-link-type="dfn" href="#concept-range-start-offset">start offset</a> is greater than <var>index</var>, decrease its <a data-link-type="dfn" href="#concept-range-start-offset">start offset</a> by one.
    <li>For each <a data-link-type="dfn" href="#concept-range">range</a> whose <a data-link-type="dfn" href="#concept-range-end-node">end node</a> is <var>parent</var> and <a data-link-type="dfn" href="#concept-range-end-offset">end offset</a> is greater than <var>index</var>, decrease its <a data-link-type="dfn" href="#concept-range-end-offset">end offset</a> by one.
    <li>
     <p>For each <code><a data-link-type="idl" href="#nodeiterator">NodeIterator</a></code> object <var>iterator</var> whose <a data-link-type="dfn" href="#concept-traversal-root">root</a>’s <a data-link-type="dfn" href="#concept-node-document">node document</a> is <var>node</var>’s <a data-link-type="dfn" href="#concept-node-document">node document</a>, run the <a data-link-type="dfn" href="#nodeiterator-pre-removing-steps"><code>NodeIterator</code> pre-removing steps</a> given <var>node</var> and <var>iterator</var>. </p>
    <li>Let <var>oldPreviousSibling</var> be <var>node</var>’s <a data-link-type="dfn" href="#concept-tree-previous-sibling">previous sibling</a>.
    <li>Let <var>oldNextSibling</var> be <var>node</var>’s <a data-link-type="dfn" href="#concept-tree-next-sibling">next sibling</a>.
    <li>Remove <var>node</var> from its <var>parent</var>.
    <li>
     <p>If <var>node</var> is <a data-link-type="dfn" href="#slotable-assigned">assigned</a>, then run <a data-link-type="dfn" href="#assign-slotables">assign slotables</a> for <var>node</var>’s <a data-link-type="dfn" href="#slotable-assigned-slot">assigned slot</a>. </p>
    <li>
     <p>If <var>parent</var> is a <a data-link-type="dfn" href="#concept-slot">slot</a> whose <a data-link-type="dfn" href="#slot-assigned-nodes">assigned nodes</a> is the empty
 list, then run <a data-link-type="dfn" href="#signal-a-slot-change">signal a slot change</a> for <var>parent</var>. </p>
    <li>
     <p>If <var>node</var> has an <a data-link-type="dfn" href="#concept-tree-inclusive-descendant">inclusive descendant</a> that is a <a data-link-type="dfn" href="#concept-slot">slot</a>, then: </p>
     <ol>
      <li>
       <p>Run <a data-link-type="dfn" href="#assign-slotables-for-a-tree">assign slotables for a tree</a> with <var>parent</var>’s <a data-link-type="dfn" href="#concept-tree">tree</a>. </p>
      <li>
       <p>Run <a data-link-type="dfn" href="#assign-slotables-for-a-tree">assign slotables for a tree</a> with <var>node</var>’s <a data-link-type="dfn" href="#concept-tree">tree</a> and a set
   containing each <a data-link-type="dfn" href="#concept-tree-inclusive-descendant">inclusive descendant</a> of <var>node</var> that is a <a data-link-type="dfn" href="#concept-slot">slot</a>. </p>
     </ol>
    <li>
     <p>Run the <a data-link-type="dfn" href="#concept-node-remove-ext">removing steps</a> with <var>node</var> and <var>parent</var>. </p>
    <li>
     <p>If <var>node</var> is <a data-link-type="dfn" href="#concept-element-custom">custom</a>, then <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/scripting.html#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>node</var>, callback name
  "<code>disconnectedCallback</code>", and an empty argument list. </p>
     <p class="note" role="note">It is intentional for now that <a data-link-type="dfn" href="#concept-element-custom">custom</a> <a data-link-type="dfn" href="#concept-element">elements</a> do
  not get <var>parent</var> passed. This might change in the future if there is a need. </p>
    <li>
     <p>For each <a data-link-type="dfn" href="#concept-shadow-including-descendant">shadow-including descendant</a> <var>descendant</var> of <var>node</var>, in <a data-link-type="dfn" href="#concept-shadow-including-tree-order">shadow-including tree order</a>, run these substeps: </p>
     <ol>
      <li>
       <p>Run the <a data-link-type="dfn" href="#concept-node-remove-ext">removing steps</a> with <var>descendant</var>. </p>
      <li>
       <p>If <var>descendant</var> is <a data-link-type="dfn" href="#concept-element-custom">custom</a>, then <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/scripting.html#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>descendant</var>, callback name
   "<code>disconnectedCallback</code>", and an empty argument list. </p>
     </ol>
    <li>For each <a data-link-type="dfn" href="#concept-tree-inclusive-ancestor">inclusive ancestor</a> <var>inclusiveAncestor</var> of <var>parent</var>, if <var>inclusiveAncestor</var> has any <a data-link-type="dfn" href="#registered-observer">registered observers</a> whose <b>options</b>' <code><a data-link-type="idl" href="#dom-mutationobserverinit-subtree">subtree</a></code> is true, then for each
 such <a data-link-type="dfn" href="#registered-observer">registered observer</a> <var>registered</var>, append a <a data-link-type="dfn" href="#transient-registered-observer">transient registered observer</a> whose <b>observer</b> and <b>options</b> are identical to those of <var>registered</var> and <b>source</b> which is <var>registered</var> to <var>node</var>’s list of <a data-link-type="dfn" href="#registered-observer">registered observers</a>.
    <li>If <i>suppress observers flag</i> is unset, <a data-link-type="dfn" href="#queue-a-mutation-record">queue a mutation record</a> of "<code>childList</code>" for <var>parent</var> with removedNodes a list solely containing <var>node</var>,
 nextSibling <var>oldNextSibling</var>, and previousSibling <var>oldPreviousSibling</var>.
   </ol>

   </section>

    <section>
      <h2>Events</h2>

   <p class="warning">
     This section is a copy of <a href="https://dom.spec.whatwg.org/#dispatching-events">Dispatching events</a> section in [[WHATWG-DOM]]. This section is expected to be synced with that periodically.
   </p>

   <section>
   <h3 class="heading settled" data-level="3.8" id="dispatching-events"><span class="content">Dispatching events</span></h3>
   <p>To <dfn data-dfn-type="dfn" data-export="" id="concept-event-dispatch">dispatch<a class="self-link" href="#concept-event-dispatch"></a></dfn> an <var>event</var> to a <var>target</var>, with an optional <var>legacy target override flag</var>, run these steps: </p>
   <ol>
    <li>
     <p>Set <var>event</var>’s <a data-link-type="dfn" href="#dispatch-flag">dispatch flag</a>. </p>
    <li>
     <p>Let <var>targetOverride</var> be <var>target</var>, if <var>legacy target override flag</var> is not given, and <var>target</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-document-window">associated <code>Document</code></a> otherwise. <a data-link-type="biblio" href="#biblio-html">[HTML]</a> </p>
     <p class="note" role="note"><var>legacy target override flag</var> is only used by HTML and only when <var>target</var> is a <code><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/browsers.html#window">Window</a></code> object. </p>
    <li>Let <var>relatedTarget</var> be the result of <a data-link-type="dfn" href="#retarget">retargeting</a> <var>event</var>’s <a data-link-type="dfn" href="#event-relatedtarget">relatedTarget</a> against <var>target</var> if <var>event</var>’s <a data-link-type="dfn" href="#event-relatedtarget">relatedTarget</a> is
 non-null, and null otherwise.
    <li>
     <p>If <var>target</var> is <var>relatedTarget</var> and <var>target</var> is not <var>event</var>’s <a data-link-type="dfn" href="#event-relatedtarget">relatedTarget</a>, then return true. </p>
    <li>
     <p>Append (<var>target</var>, <var>targetOverride</var>, <var>relatedTarget</var>) to <var>event</var>’s <a data-link-type="dfn" href="#event-path">path</a>. </p>
    <li>
     <p>Let <var>isActivationEvent</var> be true, if <var>event</var> is a <code><a data-link-type="idl" href="https://w3c.github.io/uievents/#interface-mouseevent">MouseEvent</a></code> object and <var>event</var>’s <code><a data-link-type="idl" href="#dom-event-type">type</a></code> attribute is "<code>click</code>", and false otherwise. </p>
    <li>
     <p>Let <var>activationTarget</var> be <var>target</var>, if <var>isActivationEvent</var> is
 true and <var>target</var> has <a data-link-type="dfn" href="#eventtarget-activation-behavior">activation behavior</a>, and null otherwise. </p>
    <li>
     <p>Let <var>parent</var> be the result of invoking <var>target</var>’s <a data-link-type="dfn" href="#get-the-parent">get the parent</a> with <var>event</var>. </p>
    <li>
     <p>While <var>parent</var> is non-null:</p>
     <ol>
      <li>
       <p>Let <var>relatedTarget</var> be the result of <a data-link-type="dfn" href="#retarget">retargeting</a> <var>event</var>’s <a data-link-type="dfn" href="#event-relatedtarget">relatedTarget</a> against <var>parent</var> if <var>event</var>’s <a data-link-type="dfn" href="#event-relatedtarget">relatedTarget</a> is
   non-null, and null otherwise. </p>
      <li>
       <p>If <var>target</var>’s <a data-link-type="dfn" href="#concept-tree-root">root</a> is a <a data-link-type="dfn" href="#concept-shadow-including-inclusive-ancestor">shadow-including inclusive ancestor</a> of <var>parent</var>, then: </p>
       <ol>
        <li>
         <p>If <var>isActivationEvent</var> is true, <var>event</var>’s <code><a data-link-type="idl" href="#dom-event-bubbles">bubbles</a></code> attribute
     is true, <var>activationTarget</var> is null, and <var>parent</var> has <a data-link-type="dfn" href="#eventtarget-activation-behavior">activation behavior</a>, then set <var>activationTarget</var> to <var>parent</var>. </p>
        <li>
         <p>Append (<var>parent</var>, null, <var>relatedTarget</var>) to <var>event</var>’s <a data-link-type="dfn" href="#event-path">path</a>. </p>
       </ol>
      <li>
       <p>Otherwise, if <var>parent</var> and <var>relatedTarget</var> are identical, then set <var>parent</var> to null. </p>
      <li>
       <p>Otherwise, set <var>target</var> to <var>parent</var> and then: </p>
       <ol>
        <li>
         <p>If <var>isActivationEvent</var> is true, <var>activationTarget</var> is null, and <var>target</var> has <a data-link-type="dfn" href="#eventtarget-activation-behavior">activation behavior</a>, then set <var>activationTarget</var> to <var>target</var>. </p>
        <li>
         <p>Append (<var>parent</var>, <var>target</var>, <var>relatedTarget</var>) to <var>event</var>’s <a data-link-type="dfn" href="#event-path">path</a>. </p>
       </ol>
      <li>
       <p>If <var>parent</var> is non-null, then set <var>parent</var> to the result of invoking <var>parent</var>’s <a data-link-type="dfn" href="#get-the-parent">get the parent</a> with <var>event</var>. </p>
     </ol>
    <li>
     <p>Set <var>event</var>’s <code><a data-link-type="idl" href="#dom-event-eventphase">eventPhase</a></code> attribute to <code><a data-link-type="idl" href="#dom-event-capturing_phase">CAPTURING_PHASE</a></code>. </p>
    <li>
     <p>If <var>activationTarget</var> is non-null and <var>activationTarget</var> has <a data-link-type="dfn" href="#eventtarget-legacy-pre-activation-behavior">legacy-pre-activation behavior</a>, then run <var>activationTarget</var>’s <a data-link-type="dfn" href="#eventtarget-legacy-pre-activation-behavior">legacy-pre-activation behavior</a>. </p>
    <li>
     <p>For each <var>tuple</var> in <var>event</var>’s <a data-link-type="dfn" href="#event-path">path</a>, in reverse order: </p>
     <ol>
      <li>
       <p>Set <var>event</var>’s <code><a data-link-type="idl" href="#dom-event-target">target</a></code> attribute to the <b>target</b> of the last tuple
   in <var>event</var>’s <a data-link-type="dfn" href="#event-path">path</a>, that is either <var>tuple</var> or preceding <var>tuple</var>, whose <b>target</b> is non-null. </p>
      <li>
       <p>Set <var>event</var>’s <a data-link-type="dfn" href="#event-relatedtarget">relatedTarget</a> to <var>tuple</var>’s <b>relatedTarget</b>. </p>
      <li>
       <p>Run the <a data-link-type="dfn" href="#event-retargeting-steps">retargeting steps</a> with <var>event</var>. </p>
      <li>
       <p>If <var>tuple</var>’s <b>target</b> is null, then <a data-link-type="dfn" href="#concept-event-listener-invoke">invoke</a> <var>tuple</var>’s <b>item</b> with <var>event</var>. </p>
     </ol>
    <li>
     <p>For each <var>tuple</var> in <var>event</var>’s <a data-link-type="dfn" href="#event-path">path</a>, in order: </p>
     <ol>
      <li>
       <p>Set <var>event</var>’s <code><a data-link-type="idl" href="#dom-event-target">target</a></code> attribute to the <b>target</b> of the last tuple
   in <var>event</var>’s <a data-link-type="dfn" href="#event-path">path</a>, that is either <var>tuple</var> or preceding <var>tuple</var>, whose <b>target</b> is non-null. </p>
      <li>
       <p>Set <var>event</var>’s <a data-link-type="dfn" href="#event-relatedtarget">relatedTarget</a> to <var>tuple</var>’s <b>relatedTarget</b>. </p>
      <li>
       <p>Run the <a data-link-type="dfn" href="#event-retargeting-steps">retargeting steps</a> with <var>event</var>. </p>
      <li>
       <p>If <var>tuple</var>’s <b>target</b> is non-null, then set <var>event</var>’s <code><a data-link-type="idl" href="#dom-event-eventphase">eventPhase</a></code> attribute to <code><a data-link-type="idl" href="#dom-event-at_target">AT_TARGET</a></code>. </p>
      <li>
       <p>Otherwise, set <var>event</var>’s <code><a data-link-type="idl" href="#dom-event-eventphase">eventPhase</a></code> attribute to <code><a data-link-type="idl" href="#dom-event-bubbling_phase">BUBBLING_PHASE</a></code>. </p>
      <li>
       <p>If either <var>event</var>’s <code><a data-link-type="idl" href="#dom-event-eventphase">eventPhase</a></code> attribute is <code><a data-link-type="idl" href="#dom-event-bubbling_phase">BUBBLING_PHASE</a></code> and <var>event</var>’s <code><a data-link-type="idl" href="#dom-event-bubbles">bubbles</a></code> attribute is true or <var>event</var>’s <code><a data-link-type="idl" href="#dom-event-eventphase">eventPhase</a></code> attribute is <code><a data-link-type="idl" href="#dom-event-at_target">AT_TARGET</a></code>, then <a data-link-type="dfn" href="#concept-event-listener-invoke">invoke</a> <var>tuple</var>’s <b>item</b> with <var>event</var>. </p>
     </ol>
    <li>
     <p>Unset <var>event</var>’s <a data-link-type="dfn" href="#dispatch-flag">dispatch flag</a>, <a data-link-type="dfn" href="#stop-propagation-flag">stop propagation flag</a>, and <a data-link-type="dfn" href="#stop-immediate-propagation-flag">stop immediate propagation flag</a>. </p>
    <li>
     <p>Set <var>event</var>’s <code><a data-link-type="idl" href="#dom-event-eventphase">eventPhase</a></code> attribute to <code><a data-link-type="idl" href="#dom-event-none">NONE</a></code>. </p>
    <li>
     <p>Set <var>event</var>’s <code><a data-link-type="idl" href="#dom-event-currenttarget">currentTarget</a></code> attribute to null. </p>
    <li>
     <p>Set <var>event</var>’s <a data-link-type="dfn" href="#event-path">path</a> to the empty list. </p>
    <li>
     <p>If <var>activationTarget</var> is non-null, then: </p>
     <ol>
      <li>
       <p>If <var>event</var>’s <a data-link-type="dfn" href="#canceled-flag">canceled flag</a> is unset, then run <var>activationTarget</var>’s <a data-link-type="dfn" href="#eventtarget-activation-behavior">activation behavior</a> with <var>event</var>. </p>
      <li>
       <p>Otherwise, if <var>activationTarget</var> has <a data-link-type="dfn" href="#eventtarget-legacy-canceled-activation-behavior">legacy-canceled-activation behavior</a>, then run <var>activationTarget</var>’s <a data-link-type="dfn" href="#eventtarget-legacy-canceled-activation-behavior">legacy-canceled-activation behavior</a>. </p>
     </ol>
    <li>
     <p>Return false if <var>event</var>’s <a data-link-type="dfn" href="#canceled-flag">canceled flag</a> is set, and true otherwise. </p>
   </ol>
    </section>

    </section>

    <section>
      <h2>User Interaction</h2>

      <section class="informative">
        <h3>Ranges and Selections</h3>

        <p>
          <a>Selection</a> [[!EDITING]] is not defined. Implementation should do their best to do what's best for them. Here's one possible, admittedly naive way:
        </p>

        <p>Since <a data-lt="node">nodes</a> which are in the different <a data-lt="node tree">node trees</a> never have the same <a>root</a>, there may never exist a valid <a data-lt="range">DOM range</a> that spans multiple <a data-lt="node tree">node trees</a>.</p>

        <p>Accordingly, <a data-lt="selection">selections</a> may only exist within one <a>node tree</a>, because they are defined by a single <a>range</a>. The <a>selection</a>, returned by the <a><code>window.getSelection()</code></a> method never returns a <a>selection</a> within a <a>shadow tree</a>.</p>

        <p>The <code>getSelection()</code> method of the <a>shadow root</a> object returns the current <a>selection</a> in this <a>shadow tree</a>.</p>
      </section>

      <section>
        <h3>Focus</h3>
      <p>A <a>shadow host</a> can delegate focus to its <a>shadow root</a> by assigning a boolean <a href="#widl-ShadowRootInit-delegatesFocus">delegatesFocus</a> flag to be true in <a href="#idl-def-ShadowRootInit">ShadowRootInit</a> dictionary. If omitted, a <a>shadow host</a> does not delegate focus to its shadow root, and the shadow host itself can be focusable.</p>
        <p>When a shadow host <var>HOST</var> <dfn>delegates focus</dfn>, user agent <strong>must</strong> behave as follows.
          <ol>
            <li>In <a>sequential focus navigation</a>, <var>HOST</var> itself will be skipped. See the next section for the formal definition.</li>
            <li>When <var>HOST</var> is focused by <code>focus()</code> method or <code>autofocus</code> attribute: The first <a>focusable area</a> in focus navigation order of <var>HOST</var>'s <a>shadow root</a>'s <a>focus navigation scope</a> gets focus. See the next section for the formal definition of the ordering.</li>
            <li>When mouse is clicked on a node in <var>HOST</var>'s <a>shadow tree</a> and the node is not a <a>focusable area</a>: The first <a>focusable area</a> in focus navigation order of <var>HOST</var>'s <a>shadow root</a>'s <a>focus navigation scope</a> gets focus. See the next section for the formal definition of the ordering.</li>
            <li>When any element in <var>HOST</var>'s <a>shadow tree</a> has focus, <code>:focus</code> pseudo-class applies to <var>HOST</var> in addition to the focused element itself.</li>
      <li>If <code>:focus</code> pseudo-class applies to <var>HOST</var>, and <var>HOST</var> is in a <a>shadow root</a> of another <a>shadow host</a> <var>HOST2</var> which also <a>delegates focus</a>, <code>:focus</code> pseudo-class applies to <var>HOST2</var> as well.</li>
          </ol>
        </p>
      </section>

      <section>
        <h3>Sequential Focus Navigation</h3>

        <p><dfn>focus navigation scope</dfn> is a set of elements <a>in a shadow-including document</a>. An element belongs to at most one <a>focus navigation scope</a>.</p>

        <p><dfn>focus navigation scope owner</dfn> is a node that owns a <a>focus navigation scope</a>. A document, a <a>shadow root</a>, or a <a>slot element</a> can be a <a>focus navigation scope owner</a>.</p>

        <p><dfn>document sequential focus navigation order</dfn> is an order of all of the <a data-lt="focusable area">focusable areas</a> <a>in a shadow-including document</a>, reachable by <a>sequential focus navigation</a>.</p>

        <p>When a shadow-including document is given, the <a>document sequential focus navigation order</a> is determined by the following steps:</p>

        <p>Step 1.</p>
        <div class="algorithm">
          <dl>
            <dt>INPUT</dt>
            <dd><var>DOCUMENT</var>, a composed document</dd>
            <dt>OUTPUT</dt>
            <dd><var>OWNERS</var>, a set of <a>focus navigation scope owner</a> nodes</dd>
          </dl>
          <ol>
            <li>Let <var>OWNERS</var> be an empty set.</li>
            <li>For each node tree <var>TREE</var> in <var>DOCUMENT</var>:
              <ol>
                <li>For each node <var>NODE</var> in <var>TREE</var>, in tree order:
                  <ol>
                    <li>If <var>NODE</var> is a document, a <a>shadow root</a>, or a <a>slot element</a>, append it to <var>OWNERS</var>.</li>
                  </ol>
                </li>
              </ol>
            </li>
          </ol>
        </div>

        <p>Step 2.</p>
        <div class="algorithm">
          <dl>
            <dt>INPUT</dt>
            <dd><var>DOCUMENT</var>, a composed document</dd>
            <dd><var>OWNERS</var>, a set of <a>focus navigation scope owner</a> nodes from Step 1</dd>
            <dt>OUTPUT</dt>
            <dd><var>SCOPE</var>s, a set of <a data-lt="focus navigation scope">focus navigation scopes</a> each of which is an ordered list of elements</dd>
            <dd><var>SCOPE-MAP</var>, a map from each <a>focus navigation scope owner</a> to its corresponding <a>focus navigation scope</a>
          </dl>
          <ol>
            <li>For each owner <var>OWNER</var> in <var>OWNERS</var>:
              <ol>
                <li>Let <var>SCOPE</var> be empty list.</li>
                <li>Append <var>SCOPE</var> to <var>SCOPE-MAP[OWNER]</var>.</li>
              </ol>
            </li>
            <li>For each node tree <var>TREE</var> in <var>DOCUMENT</var>, in <a>shadow-including tree order</a>:
              <ol>
                <li>For each <var>ELEMENT</var> in <var>TREE</var>:
                  <ol>
                    <li>Let <var>CURRENT</var> be <var>ELEMENT</var>.</li>
                    <li>Repeat the following steps until the algorithm stops.</li>
                    <li>If <var>CURRENT</var> is a child of a <a>shadow host</a>:
                      <ol>
                        <li>If <var>CURRENT</var> is assigned to any <a>slot</a> <var>SLOT</var>, append <var>ELEMENT</var> to <var>SCOPE-MAP[SLOT]</var>.</li>
                        <li>Otherwise do not append <var>ELEMENT</var> to any scope.</li>
                        <li>Stop this algorithm.</li>
                      </ol>
                    </li>
                    <li>If <var>CURRENT</var> is a <a>slot element</a> and not equal to <var>ELEMENT</var>:
                      <ol>
                        <li>If <var>CURRENT</var> has any <a>assigned nodes</a>, do not append <var>ELEMENT</var> to any scope.</li>
                        <li>Otherwise append <var>ELEMENT</var> to <var>SCOPE-MAP[CURRENT]</var>.</li>
                        <li>Stop this algorithm.</li>
                      </ol>
                    </li>
                    <li>If <var>CURRENT</var> is a child of a root node (a <a>shadow root</a> or document) <var>ROOT</var>:
                      <ol>
                        <li>Append <var>ELEMENT</var> to <var>SCOPE-MAP[ROOT]</var>.</li>
                        <li>Stop this algorithm.</li>
                      </ol>
                    </li>
                    <li>Otherwise:
                      <ol>
                        <li>Set <var>CURRENT</var> to the parent element of <var>CURRENT</var>.</li>
                      </ol>
                    </li>
                  </ol>
                </li>
              </ol>
            </li>
          </ol>
        </div>

        <p>Step 3.</p>
        <div class="algorithm">
          <dl>
            <dt>INPUT</dt>
            <dd><var>SCOPE</var>, a <a>focus navigation scope</a></dd>
            <dt>OUTPUT</dt>
            <dd><var>NAVIGATION-ORDER</var>, an ordered list of elements which should be visited.</dd>
          </dl>
          <ol>
            <li>For each scope SCOPE:
              <ol>
                <li>Let <var>NAVIGATION-ORDER</var> be an empty list.</li>
                <li>For each element <var>ELEMENT</var> in a <a>focus navigation scope</a> <var>SCOPE</var>,
                  <ol>
                    <li>if <var>ELEMENT</var> is focusable, a <a>shadow host</a>, or a <a>slot element</a>, append <var>ELEMENT</var> to <var>NAVIGATION-ORDER</var>.</li>
                  </ol>
                <li>Reorder <var>NAVIGATION-ORDER</var> according to the <a>tabindex</a> value attached to each node. In this step, an element whose <a>tabindex</a> value is negative <strong>must</strong> not be appended to <var>NAVIGATION-ORDER</var>.</li>
              </ol>
            </li>
          </ol>
        </div>

        <p>Step 4.</p>
        <p>Apply the following <dfn>focus navigation order merging algorithm</dfn> with document’s focus navigation order as input. The result is the <a>document sequential focus navigation order</a>.</p>

        <div class="algorithm">
          <dl>
            <dt>INPUT</dt>
            <dd><var>NAVIGATION-ORDER</var>, an ordered list of elements.</dd>
            <dt>OUTPUT</dt>
            <dd><var>MERGED-NAVIGATION-ORDER</var>, an ordered list of elements.</dd>
          </dl>
          <ol>
            <li>Let <var>MERGED-NAVIGATION-ORDER</var> be an empty list.</li>
            <li>For each element <var>ELEMENT</var> in <var>NAVIGATION-ORDER</var>:
              <ol>
                <li>If <var>ELEMENT</var> is a shadow host:
                  <ol>
                    <li>Unless its shadow root’s delegatesFocus flag is set, append<var> ELEMENT</var> to <var>MERGED-NAVIGATION-ORDER</var>.</li>
                    <li>Apply the <a>focus navigation order merging algorithm</a> with the focus navigation order owned by its <a>shadow root</a> as input, then append the result to <var>MERGED-NAVIGATION-ORDER</var>.</li>
                  </ol>
                </li>
                <li>If <var>ELEMENT</var> is a slot element:
                  <ol>
                    <li>Apply the <a>focus navigation order merging algorithm</a> with the focus navigation order owned by the <a>slot element</a> as input, then append the result to <var>MERGED-NAVIGATION-ORDER</var>.</li>
                  </ol>
                </li>
                <li>Otherwise:
                  <ol>
                    <li>Append <var>ELEMENT</var> to <var>MERGED-NAVIGATION-ORDER</var>.</li>
                  </ol>
                </li>
                <li>Return <var>MERGED-NAVIGATION-ORDER</var>.</li>
              </ol>
            </li>
          </ol>
        </div>

        <p>For <a>directional focus navigation</a> [[!CSS3-UI]], it is up to the user agent to integrate the <a data-lt="shadow tree">shadow trees</a> into the document's <a>directional focus navigation</a>.
      </section>

      <section>
        <h3>Active Element</h3>

        <p>
          <a>DocumentOrShadowRoot</a> object's <a>activeElement</a> <strong>must</strong> be the result of
          the <a>retargeting algorithm</a> with the <a>context object</a> and the focused element as input,
          if the result and the <a>context object</a> are in the same tree. Otherwise, null.
        </p>
      </section>

      <section>
        <h3>Editing</h3>

        <p>The value of the <a><code>contenteditable</code></a> attribute <strong>must not</strong> propagate from <a>shadow host</a> to its <a data-lt="shadow tree">shadow trees</a>.</p>
      </section>

      <section>
        <h3>Assistive Technology</h3>

        <p>User agents with assistive technology traverse the <a>flat tree</a>, and thus enable full use of WAI-ARIA [[!WAI-ARIA]] semantics in the <a data-lt="shadow tree">shadow trees</a>.</p>

      </section>

      <section>
        <h3>Hit Testing</h3>

        <p>
          When a text node is a child node of a shadow root, a hit testing <strong>must</strong> target the shadow host if the text node is the result of the hit testing.
        </p>
        <p>
          User-agent mouse events <strong>must</strong> be targeted to the parent node in the <a>flat tree</a> of a text node if the <a>topmost event target</a> is the text node.
        </p>
        <p class="note">
          This section eventually needs to be part of some general hit testing specification.
        </p>
      </section>

    </section>

    <section>
      <h2>HTML Elements in Shadow Trees</h2>

      <section>
        <h3>Inertness of HTML Elements in a shadow tree</h3>

        <p>Comparatively, a <a>shadow tree</a> can be seen as somewhere between <em>just part of a <a>document</a></em> and itself being a <a data-lt="interface DocumentFragment">document fragment</a>. Since it is rendered, a <a>shadow tree</a> aims to retain the traits of a typical <a>tree</a> in a <a>document</a>. At the same time, it is an encapsulation abstraction, so it has to avoid affecting the <a>document tree</a>. Thus, the <a>HTML elements</a> <strong>must</strong> behave as specified [[!HTML]] in the <a data-lt="shadow tree">shadow trees</a>, with a few exceptions.</p>

        <p class="note">
          According to the [[!HTML]], some HTML Elements would have different behavior if they participate in a <a>shadow tree</a>, instead of a document tree,
          because their definitions require the elements to be <a>in a document</a> as a necessary condition for them to work.
          In other words, they shouldn't work if they participate in a <a>shadow tree</a>, even when they are <a>in a shadow-including document</a>.
          We must fill this gap because we expect that most of HTML Elements behave in the same way as <a>in a document</a>, as long as they are <a>in a shadow-including document</a>.
          See W3C <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=26365">Bug 26365</a> and <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=27406">Bug 27406</a> for the details.
          The following is the tentative summary of the discussions in the W3C bugs. We, however, haven't covered all HTML Elements and their behaviors here yet.
          For HTML Elements which are not explicitly stated here, they should *work* even in a shadow tree.
          We are trying to update [[!HTML]] itself, instead of having monkey patches here.
          If [[!HTML]] explains an element's behavior explicitly, it should be honored, instead of this section.
        </p>
        <p>
          Some HTML Elements are classified into the following categories:
        </p>
        <ul>
          <li>
            <p>
              <dfn>Inert in a shadow tree</dfn>:
            </p>
            <p>
              A subset of <a>HTML elements</a> which <strong>must</strong> behave as <a>inert</a>, or not part of the <a>document tree</a>, if they participate in a <a>shadow tree</a>.
              This is consistent how the <a>HTML elements</a> would behave in a <a data-lt="interface DocumentFragment">document fragment</a>.
            </p>
            <p>
              The following HTML elements <strong>must</strong> be classified to this category:
            </p>
            <ul>
              <li><a data-lt="base element"><code>base</code></a></li>
              <li><a data-lt="link element"><code>link</code></a></li>

              <li><code>meta</code></li>
            </ul>
            <p class="note">
              &lt;link rel="stylesheet"&gt; is now supported in a shadow tree (<a href="https://github.com/whatwg/html/commit/43c57866c2bbc20dc0deb15a721a28cbaad2140c">HTML Standard</a>).
              For other cases, the discussion is on-going at <a href="https://github.com/w3c/webcomponents/issues/628">Issue #628</a>.
            </p>
          </li>
          <li>
            <p>
              <dfn>Inert unless being rendered</dfn>:
            </p>
            <p>
              A subset of <a>HTML elements</a> which <strong>must</strong> behave as <a>inert</a>, or not part of the <a>document tree</a>,
              unless they are <a>being rendered</a>.
              In other words, if they don't participate in a <a>document flat tree</a>, they <strong>must</strong> behave as <a>inert</a>.
            </p>
            <p>
              The following HTML elements <strong>must</strong> be classified to this category:
            </p>
            <ul>
              <li><code>applet</code></li>
              <li><code>embed</code></li>
              <li><code>object</code></li>
            </ul>
            <p class="note">
              For example, suppose that an <code>object</code> element is a child node of a shadow host, but the <code>object</code> element is not assigned to a slot.
              In this case, according to the <a>flat tree children calculation algorithm</a>,
              this element never participate in a <a>document flat tree</a>.
              Therefore, this element is <a>inert</a> because this element is not <a>being rendered</a>. .
            </p>
          </li>
        </ul>
      </section>

      <section>
        <h3>Attributes</h3>

        <p>When [[!HTML]] defines the processing algorithms to traverse trees for the following attributes, they <strong>must</strong> use the <a>flat tree</a>.
        <ul>
          <li><code>dir</code></li>
          <li><code>draggable</code></li>
          <li><code>dropzone</code></li>
          <li><code>hidden</code></li>
          <li><code>lang</code> and <code>xml:lang</code></li>
          <li><code>spellcheck</code></li>
          <li><code>title</code></li>
        </ul>

        <div class="note">
          <p>
            This list does not include attributes that are defined elsewhere in this specification. Such attributes include:
          </p>
          <ul>
            <li><code>tabindex</code> is defined in <a href="#focus-navigation">Focus Navigation</a>.</li>
            <li><code>role</code> and <code>ARIA</code> are defined in <a href="#assistive-technology">Assistive Technology</a>.</li>
          </ul>
        </div>
      </section>

      <section>
        <h3>Other Clarifications</h3>

        <p class="note">
          This section is used to state what needs to be clarified.
          Each clarification will be upstreamed to the HTML Standard or other specifications, eventually, if required.
        </p>

        <p>
          <code>Document.currentScript</code> <strong>must</strong> return null if the <code>script</code> element is in a <a>shadow tree</a>.
          See <a href="https://github.com/w3c/webcomponents/issues/477">Issue #477</a>.
        </p>

        <p>
          Style elements inside a <a>shadow tree</a> <strong>must</strong> not be able to set the preferred style sheet set for the <a>document tree</a>.
          Style elements inside a <a>shadow tree</a> should still be applied if it has a <code>title</code> attribute not matching the preferred style sheet set
          of the <a>document tree</a>.
          See <a href="https://github.com/w3c/webcomponents/issues/391">Issue #391</a>.
        </p>

        <p>
          An iframe in a <a>shadow tree</a> <strong>must</strong> not have any effect on <code>window.history</code> neither <code>window.frames</code>.
          See <a href="https://github.com/w3c/webcomponents/issues/184">Issue #184</a>.
        </p>

        <p>
          <code>:root</code> pseudo class does not match any element if the rule is used in a <a>shadow tree</a>.
        </p>
      </section>

    </section>

    <section>
      <h2>Elements and DOM interfaces</h2>

      <section>
        <h3>Extensions to the <code><a href="https://dom.spec.whatwg.org/#documentorshadowroot">DocumentOrShadowRoot</a></code> Mixin</h3>

        <pre class='idl'>
          partial interface DocumentOrShadowRoot {
            Selection? getSelection ();
            Element? elementFromPoint(double x, double y);
            sequence&lt;Element&gt; elementsFromPoint(double x, double y);
            CaretPosition? caretPositionFromPoint(double x, double y);
            readonly attribute Element? activeElement;
            readonly attribute StyleSheetList styleSheets;
          };
        </pre>

        <ul class="note">
          <li>
            Except for <code>activeElement</code>, these methods and attributes are defined in the similar way as currently defined in Document,
            considering only the current node tree.
          </li>
          <li>
            Regarding <code>elementFromPoint</code> and <code>elementsFromPoints</code>, they should return the result of running the <a>retargeting algorithm</a> with <a>context object</a> and the original result as input.
          </li>
          <li>
            Regarding <code>styleSheets</code>, it should return an empty <a>StyleSheetList</a> if the context object is not <a>in a shadow-including document</a>.
          </li>
          <li>
            We should remove these methods and attributes from Document when this section is upstreamed to DOM Standard.
          </li>
        </ul>
      </section>

      <section>

   <h3 class="heading settled" data-level="3.8" id="interface-shadowroot"><span class="secno"></span><span class="content">Interface <code class="idl"><a data-link-type="idl" href="#shadowroot">ShadowRoot</a></code></span></h3>

   <p class="warning">
     This section is a copy of <a href="https://dom.spec.whatwg.org/#interface-shadowroot">Interface ShadowRoot</a> section in [[WHATWG-DOM]]. This section is expected to be synced with that periodically.
     </p>

<pre class="idl highlight def">[<a class="nv idl-code" data-link-type="extended-attribute" href="https://heycam.github.io/webidl/#Exposed">Exposed</a>=<span class="n">Window</span>]
<span class="kt">interface</span> <dfn class="nv idl-code" data-dfn-type="interface" data-export="" id="shadowroot">ShadowRoot<a class="self-link" href="#shadowroot"></a></dfn> : <a class="n" data-link-type="idl-name" href="#documentfragment">DocumentFragment</a> {
  <span class="kt">readonly</span> <span class="kt">attribute</span> <a class="n" data-link-type="idl-name" href="#enumdef-shadowrootmode">ShadowRootMode</a> <a class="nv idl-code" data-link-type="attribute" data-readonly="" data-type="ShadowRootMode" href="#dom-shadowroot-mode">mode</a>;
  <span class="kt">readonly</span> <span class="kt">attribute</span> <a class="n" data-link-type="idl-name" href="#element">Element</a> <a class="nv idl-code" data-link-type="attribute" data-readonly="" data-type="Element" href="#dom-shadowroot-host">host</a>;
};

<span class="kt">enum</span> <dfn class="nv idl-code" data-dfn-type="enum" data-export="" id="enumdef-shadowrootmode">ShadowRootMode<a class="self-link" href="#enumdef-shadowrootmode"></a></dfn> { <dfn class="s idl-code" data-dfn-for="ShadowRootMode" data-dfn-type="enum-value" data-export="" data-lt="&quot;open&quot;|open" id="dom-shadowrootmode-open">"open"<a class="self-link" href="#dom-shadowrootmode-open"></a></dfn>, <dfn class="s idl-code" data-dfn-for="ShadowRootMode" data-dfn-type="enum-value" data-export="" data-lt="&quot;closed&quot;|closed" id="dom-shadowrootmode-closed">"closed"<a class="self-link" href="#dom-shadowrootmode-closed"></a></dfn> };
</pre>
   <p><code class="idl"><a data-link-type="idl" href="#shadowroot">ShadowRoot</a></code> <a data-link-type="dfn" href="#concept-node">nodes</a> are simply known as <dfn data-dfn-type="dfn" data-export="" data-lt="shadow root" id="concept-shadow-root">shadow roots<a class="self-link" href="#concept-shadow-root"></a></dfn>. </p>
   <p><a data-link-type="dfn" href="#concept-shadow-root">Shadow roots</a> have an associated <dfn data-dfn-for="ShadowRoot" data-dfn-type="dfn" data-noexport="" id="shadowroot-mode">mode<a class="self-link" href="#shadowroot-mode"></a></dfn> ("<code>open</code>"
or "<code>closed</code>").</p>
   <p><a data-link-type="dfn" href="#concept-shadow-root">Shadow roots</a>’s associated <a data-link-type="dfn" href="#concept-documentfragment-host">host</a> is never null.</p>
   <p>A <a data-link-type="dfn" href="#concept-shadow-root">shadow root</a>’s <a data-link-type="dfn" href="#get-the-parent">get the parent</a> algorithm, given an <var>event</var>, returns
null if <var>event</var>’s <a data-link-type="dfn" href="#composed-flag">composed flag</a> is unset and <a data-link-type="dfn" href="#concept-shadow-root">shadow root</a> is the <a data-link-type="dfn" href="#concept-tree-root">root</a> of <var>event</var>’s <a data-link-type="dfn" href="#event-path">path</a>’s first tuple’s <b>item</b>, and <a data-link-type="dfn" href="#concept-shadow-root">shadow root</a>’s <a data-link-type="dfn" href="#concept-documentfragment-host">host</a> otherwise. </p>
   <p>The <code>mode</code><a class="self-link" href="#dom-shadowroot-mode"></a> attribute’s getter must return the <a data-link-type="dfn" href="#context-object">context object</a>’s <a data-link-type="dfn" href="#shadowroot-mode">mode</a>.</p>
   <p>The <dfn class="idl-code" data-dfn-for="ShadowRoot" data-dfn-type="attribute" data-export="" id="dom-shadowroot-host"><code>host</code><a class="self-link" href="#dom-shadowroot-host"></a></dfn> attribute’s getter must return the <a data-link-type="dfn" href="#context-object">context object</a>’s <a data-link-type="dfn" href="#concept-documentfragment-host">host</a>. </p>
   <hr>
   <p>In <dfn data-dfn-type="dfn" data-export="" id="concept-shadow-including-tree-order">shadow-including tree order<a class="self-link" href="#concept-shadow-including-tree-order"></a></dfn>, is <a data-link-type="dfn" href="#shadow-including-preorder-depth-first-traversal">shadow-including preorder, depth-first traversal</a> of a <a data-link-type="dfn" href="#concept-node-tree">node tree</a>. <dfn data-dfn-type="dfn" data-noexport="" id="shadow-including-preorder-depth-first-traversal">shadow-including preorder, depth-first traversal<a class="self-link" href="#shadow-including-preorder-depth-first-traversal"></a></dfn> of a <a data-link-type="dfn" href="#concept-node-tree">node tree</a> <var>tree</var> is preorder, depth-first traversal of <var>tree</var>, with for each <a data-link-type="dfn" href="#element-shadow-host">shadow host</a> encountered in <var>tree</var>, <a data-link-type="dfn" href="#shadow-including-preorder-depth-first-traversal">shadow-including preorder, depth-first traversal</a> of that <a data-link-type="dfn" href="#concept-element">element</a>’s <a data-link-type="dfn" href="#concept-element-shadow-root">shadow root</a>’s <a data-link-type="dfn" href="#concept-node-tree">node tree</a> just after it is encountered. </p>
   <p>The <dfn data-dfn-type="dfn" data-export="" id="concept-shadow-including-root">shadow-including root<a class="self-link" href="#concept-shadow-including-root"></a></dfn> of an object is its <a data-link-type="dfn" href="#concept-tree-root">root</a>’s <a data-link-type="dfn" href="#concept-documentfragment-host">host</a>’s <a data-link-type="dfn" href="#concept-shadow-including-root">shadow-including root</a>, if the
object’s <a data-link-type="dfn" href="#concept-tree-root">root</a> is a <a data-link-type="dfn" href="#concept-shadow-root">shadow root</a>, and its <a data-link-type="dfn" href="#concept-tree-root">root</a> otherwise.</p>
   <p>An object <var>A</var> is a <dfn data-dfn-type="dfn" data-export="" id="concept-shadow-including-descendant">shadow-including descendant<a class="self-link" href="#concept-shadow-including-descendant"></a></dfn> of an object <var>B</var>, if <var>A</var> is a <a data-link-type="dfn" href="#concept-tree-descendant">descendant</a> of <var>B</var>, or <var>A</var>’s <a data-link-type="dfn" href="#concept-tree-root">root</a> is a <a data-link-type="dfn" href="#concept-shadow-root">shadow root</a> and <var>A</var>’s <a data-link-type="dfn" href="#concept-tree-root">root</a>’s <a data-link-type="dfn" href="#concept-documentfragment-host">host</a> is a <a data-link-type="dfn" href="#concept-shadow-including-inclusive-descendant">shadow-including inclusive descendant</a> of <var>B</var>. </p>
   <p>A <dfn data-dfn-type="dfn" data-export="" id="concept-shadow-including-inclusive-descendant">shadow-including inclusive descendant<a class="self-link" href="#concept-shadow-including-inclusive-descendant"></a></dfn> is an object or one of its <a data-link-type="dfn" href="#concept-shadow-including-descendant">shadow-including descendants</a>. </p>
   <p>An object <var>A</var> is a <dfn data-dfn-type="dfn" data-export="" id="concept-shadow-including-ancestor">shadow-including ancestor<a class="self-link" href="#concept-shadow-including-ancestor"></a></dfn> of an object <var>B</var>, if and only if <var>B</var> is a <a data-link-type="dfn" href="#concept-shadow-including-descendant">shadow-including descendant</a> of <var>A</var>. </p>
   <p>A <dfn data-dfn-type="dfn" data-export="" id="concept-shadow-including-inclusive-ancestor">shadow-including inclusive ancestor<a class="self-link" href="#concept-shadow-including-inclusive-ancestor"></a></dfn> is an object or one of its <a data-link-type="dfn" href="#concept-shadow-including-ancestor">shadow-including ancestors</a>. </p>
   <p>A <a data-link-type="dfn" href="#concept-node">node</a> <var>A</var> is <dfn data-dfn-type="dfn" data-export="" id="concept-closed-shadow-hidden">closed-shadow-hidden<a class="self-link" href="#concept-closed-shadow-hidden"></a></dfn> from a <a data-link-type="dfn" href="#concept-node">node</a> <var>B</var> if all of the following conditions are true: </p>
   <ul>
    <li>
     <p><var>A</var>’s <a data-link-type="dfn" href="#concept-tree-root">root</a> is a <a data-link-type="dfn" href="#concept-shadow-root">shadow root</a>. </p>
    <li>
     <p><var>A</var>’s <a data-link-type="dfn" href="#concept-tree-root">root</a> is not a <a data-link-type="dfn" href="#concept-shadow-including-inclusive-ancestor">shadow-including inclusive ancestor</a> of <var>B</var>. </p>
    <li>
     <p><var>A</var>’s <a data-link-type="dfn" href="#concept-tree-root">root</a> is a <a data-link-type="dfn" href="#concept-shadow-root">shadow root</a> whose <a data-link-type="dfn" href="#shadowroot-mode">mode</a> is "<code>closed</code>" or <var>A</var>’s <a data-link-type="dfn" href="#concept-tree-root">root</a>’s <a data-link-type="dfn" href="#concept-documentfragment-host">host</a> is <a data-link-type="dfn" href="#concept-closed-shadow-hidden">closed-shadow-hidden</a> from <var>B</var>. </p>
   </ul>
   <p>To <dfn data-dfn-type="dfn" data-export="" data-lt="retarget|retargeting" id="retarget">retarget<a class="self-link" href="#retarget"></a></dfn> an object <var>A</var> against an object <var>B</var>, repeat these steps until they return an object:</p>
   <ol>
    <li>
     <p>If <var>A</var>’s <a data-link-type="dfn" href="#concept-tree-root">root</a> is not a <a data-link-type="dfn" href="#concept-shadow-root">shadow root</a>, or <var>A</var>’s <a data-link-type="dfn" href="#concept-tree-root">root</a> is a <a data-link-type="dfn" href="#concept-shadow-including-inclusive-ancestor">shadow-including inclusive ancestor</a> of <var>B</var>, then return <var>A</var>. </p>
    <li>
     <p>Set <var>A</var> to <var>A</var>’s <a data-link-type="dfn" href="#concept-tree-root">root</a>’s <a data-link-type="dfn" href="#concept-documentfragment-host">host</a>. </p>
   </ol>
      </section>

    </section>

    <section>
      <h2>Shadow DOM Example</h2>

      <p>Bob was asked to turn a simple list of links into a News Widget, which has links organized into two categories: breaking news and just news. The current document markup for the stories looks like this:</p>
      <pre class="example highlight">
&lt;ul class="stories"&gt;
    &lt;li&gt;&lt;a href="//example.com/stories/1"&gt;A story&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href="//example.com/stories/2"&gt;Another story&lt;/a&gt;&lt;/li&gt;
    &lt;li class="breaking" slot="breaking"&gt;&lt;a href="//example.com/stories/3"&gt;Also a story&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href="//example.com/stories/4"&gt;Yet another story&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href="//example.com/stories/5"&gt;Awesome story&lt;/a&gt;&lt;/li&gt;
    &lt;li class="breaking" slot="breaking"&gt;&lt;a href="//example.com/stories/6"&gt;Horrible story&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
      </pre>

      <p class="issue">
       It's weird that there are slot attributes in this markup because Bob has not decided to use Shadow DOM yet.
      </p>

      <p>To organize the stories, Bob decides to use <strong>shadow DOM</strong>. Doing so will allow Bob to keep the document markup uncluttered, and harnessing the power of insertion point makes sorting stories by class name a very simple task. After getting another cup of <a href="http://en.wikipedia.org/wiki/List_of_coffee_beverages#Green_Eye">Green Eye</a>, he quickly mocks up the following shadow tree, to be hosted by the <code>ul</code> element:</p>
      <pre class="example highlight">
&lt;div class="breaking"&gt;
    &lt;ul&gt;
        &lt;slot name="breaking"&gt;&lt;/slot&gt; &lt;!-- slot for breaking news --&gt;
    &lt;/ul&gt;
&lt;/div&gt;
&lt;div class="other"&gt;
    &lt;ul&gt;
        &lt;slot&gt;&lt;/slot&gt; &lt;!-- slot for the rest of the news --&gt;
    &lt;/ul&gt;
&lt;/div&gt;
      </pre>
      <p>Bob then styles the newborn widget according to comps from the designer by adding this to the shadow tree mockup:</p>
      <pre class="example highlight">
&lt;style&gt;
    div.breaking {
        color: Red;
        font-size: 20px;
        border: 1px dashed Purple;
    }
    div.other {
        padding: 2px 0 0 0;
        border: 1px solid Cyan;
    }
&lt;/style&gt;
      </pre>
      <p>While pondering if his company should start looking for a new designer, Bob converts the mockup to code:</p>
      <pre class="example highlight">
function createStoryGroup(className, slotName)
{
    var group = document.createElement('div');
    group.className = className;
    // Empty string in slot name attribute or absence thereof work the same, so no need for special handling.
    group.innerHTML = '&lt;ul&gt;&lt;slot name="' + slotName + '"&gt;&lt;/slot&gt;&lt;/ul&gt;';
    return group;
}

function createStyle()
{
    var style = document.createElement('style');
    style.textContent = 'div.breaking { color: Red;font-size: 20px; border: 1px dashed Purple; }' +
        'div.other { padding: 2px 0 0 0; border: 1px solid Cyan; }';
    return style;
}

function makeShadowTree(storyList)
{
    var root = storyList.attachShadow({mode: 'open'});
    root.appendChild(createStyle());
    root.appendChild(createStoryGroup('breaking', 'breaking'));
    root.appendChild(createStoryGroup('other', ''));
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('ul.stories').forEach(makeShadowTree);
});
      </pre>

      <p>Well done, Bob! With the cup of coffee still half-full, the work is complete. Recognizing his awesomeness, Bob returns to teaching n00bs the ways of <a href="https://en.wikipedia.org/wiki/Splatoon">Splatoon</a>.</p>
    </section>

    <section class="appendix">
      <h2>Acknowledgments</h2>

      <p><span class="vcard">David Hyatt</span> developed <a href="http://dev.w3.org/2006/xbl2/">XBL 1.0</a>, and <span class="vcard">Ian Hickson</span> co-wrote <a href="http://dev.w3.org/2006/xbl2/">XBL 2.0</a>. These documents provided tremendous insight into the problem of functional encapsulation and greatly influenced this specification.</p>

      <p><span class="vcard">Alex Russell</span> and his considerable forethought triggered a new wave of enthusiasm around the subject of shadow DOM and how it can be applied practically on the Web.</p>

      <p><span class="vcard">Dominic Cooney</span>, <span class="vcard">Hajime Morrita</span>, and <span class="vcard">Roland Steiner</span> worked tirelessly to scope the problem of functional encapsulation within the confines of the Web platform and provided a solid foundation for this document.</p>

      <p>The editor would also like to thank <span class="vcard">Alex Komoroske</span>, <span class="vcard">Anne van Kesteren</span>, <span class="vcard">Brandon Payton</span>, <span class="vcard">Brian Kardell</span>, <span class="vcard">Darin Fisher</span>, <span class="vcard">Eric Bidelman</span>, <span class="vcard">Deepak Sherveghar</span>, <span class="vcard">Edward O'Connor</span>, <span class="vcard">Elisée Maurer</span>, <span class="vcard">Elliott Sprehn</span>, <span class="vcard">Erik Arvidsson</span>, <span class="vcard">Glenn Adams</span>, <span class="vcard">Jonas Sicking</span>, <span class="vcard">Koji Ishii</span>, <span class="vcard">Malte Ubl</span>, <span class="vcard">Mike Taylor</span>, <span class="vcard">Oliver Nightingale</span>, <span class="vcard">Olli Pettay</span>, <span class="vcard">Rafael Weinstein</span>, <span class="vcard">Richard Bradshaw</span>, <span class="vcard">Ruud Steltenpool</span>, <span class="vcard">Sam Dutton</span>, <span class="vcard">Sergey G. Grekhov</span>, <span class="vcard">Shinya Kawanaka</span>, <span class="vcard">Tab Atkins</span>, <span class="vcard">Takashi Sakamoto</span>, and <span class="vcard">Yoshinori Sano</span> for their comments and contributions to this specification.</p>

      <p>This list is too short. There's a lot of work left to do. Please contribute by reviewing and filing bugs&mdash;and don't forget to ask the editor to add your name into this section.</p>
    </section>

  </body>
</html>
<!DOCTYPE html>
<html lang="en"><head>
<title>HTML Imports</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<link rel="stylesheet" href="spec.css" type="text/css">
<link rel="stylesheet" href="prettify.css" type="text/css">
<link rel="stylesheet" href="http://www.w3.org/StyleSheets/TR/W3C-WD" type="text/css">
</head>

<body>

<div class="head">

<div class="logo">
    <a href="http://www.w3.org/"><img width="72" height="48" src="http://www.w3.org/Icons/w3c_home" alt="W3C"></a>
</div>

<h1>HTML Imports</h1>
<h2 id="editors-draft">W3C First Public Working Draft 14 May 2013</h2>
<dl>
<dt>This version</dt>
    <dd><a href="http://www.w3.org/TR/2013/WD-html-imports-20130514/">http://www.w3.org/TR/2013/WD-html-imports-20130514/</a></dd>
<dt>Latest version</dt>
    <dd><a href="http://www.w3.org/TR/html-imports/">http://www.w3.org/TR/html-imports/</a></dd>
<dt>Latest editor's draft</dt>
    <dd><a href="https://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/imports/index.html">https://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/imports/index.html</a></dd>
<dt>Previous version</dt>
    <dd>none</dd>
<dt>Revision history</dt>
    <dd><a id="log" href="https://dvcs.w3.org/hg/webcomponents/log/tip/spec/imports/index.html">https://dvcs.w3.org/hg/webcomponents/log/tip/spec/imports/index.html</a></dd>
<dt>Participate</dt>
    <dd>Discuss on <a href="http://lists.w3.org/Archives/Public/public-webapps/">public-webapps@w3.org</a> (<a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a>)</dd>
    <dd><a href="https://www.w3.org/Bugs/Public/enter_bug.cgi?comment=&amp;blocked=20683&amp;short_desc=%5Bimports%5D%3A%20&amp;product=WebAppsWG&amp;import=import%20Model">File bugs</a> (w3.org's <a href="https://www.w3.org/Bugs/Public/">Bugzilla</a>)</dd>
<dt>Editor</dt>
    <dd class="vcard"><span class="fn">Dimitri Glazkov</span>, <span class="org">Google</span>, &lt;<a class="email" href="mailto:dglazkov@chromium.org">dglazkov@chromium.org</a>&gt;</dd>
</dl>

<p class="copyright"><a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © 2013 <a href="http://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>®</sup> (<a href="http://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>, <a href="http://www.ercim.eu/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>, <a href="http://www.keio.ac.jp/">Keio</a>, <a href="http://ev.buaa.edu.cn/">Beihang</a>), All Rights Reserved. W3C <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>, <a href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and <a href="http://www.w3.org/Consortium/Legal/copyright-documents">document use</a> rules apply.</p>

<hr>

<h2 id="abstract">Abstract</h2>

<p>HTML Imports are a way to include and reuse HTML documents in other HTML documents.</p>

<h2 id="status">Status of This Document</h2>

<p><em>This section describes the status of this document at the time of its publication. Other documents may supersede this document. A list of current W3C publications and the latest revision of this technical report can be found in the <a href="http://www.w3.org/TR/">W3C technical reports index</a> at http://www.w3.org/TR/.</em></p>

<p>Publication as a First Public Working Draft does not imply endorsement by the W3C Membership. This is a draft document and may be updated, replaced or obsoleted by other documents at any time. It is inappropriate to cite this document as other than work in progress.</p>

<p>This document was published by the <a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a> as an Editor's Draft. If you wish to make comments regarding this document, please send them to <a href="mailto:public-webapps@w3.org">public-webapps@w3.org</a> (<a href="mailto:public-webapps-request@w3.org?subject=subscribe">subscribe</a>, <a href="http://lists.w3.org/Archives/Public/public-webapps/">archives</a>). All feedback is welcome.</p><p>Publication as an Editor's Draft does not imply endorsement by the <abbr title="World Wide Web Consortium">W3C</abbr> Membership. This is a draft document and may be updated, replaced or obsoleted by other documents at any time. It is inappropriate to cite this document as other than work in progress.</p>

<p>This document was produced by a group operating under the <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004 <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>. <abbr title="World Wide Web Consortium">W3C</abbr> maintains a <a href="http://www.w3.org/2004/01/pp-impl/42538/status" rel="disclosure">public list of any patent disclosures</a> made in connection with the deliverables of the group; that page also includes instructions for disclosing a patent. An individual who has actual knowledge of a patent which the individual believes contains <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential Claim(s)</a> must disclose the information in accordance with <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section 6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>.</p>

</div>

<section class="toc">
<h2 id="toc">Table of Contents</h2>
<ol>
    <li><a href="#about"><span class="section">1</span> About this Document</a></li>
    <li><a href="#dependencies"><span class="section">2</span> Dependencies</a></li>
    <li><a href="#terminology"><span class="section">3</span> Terminology</a></li>
    <li><a href="#link-type-import"><span class="section">4</span> Link Type "<code>import</code>"</a></li>
    <li><a href="#interface-import"><span class="section">5</span> Interface <code>import</code></a></li>
    <li><a href="#loading-imports"><span class="section">6</span> Loading Imports</a></li>
    <li><a href="#parsing-imports"><span class="section">7</span> Parsing Imports</a>
    <ol>
        <li><a href="#additions-to-prepare-a-script-algorithm"><span class="section">7.1</span> Additions to Prepare A Script Algorithm</a></li>
        <li><a href="#additions-to-tree-construction-algorithm"><span class="section">7.2</span> Additions to Tree Construction Algorithm</a></li>
        <li><a href="#additions-to-parsing-xhtml-documents"><span class="section">7.3</span> Additions to Parsing XHTML Documents</a></li>
    </ol></li>
    <li><a href="#acknowledgements">Acknowledgements</a></li>
</ol>
</section>

<section class="spec">
<h2 id="about">About this Document</h2>

<p>All diagrams, examples, notes, are non-normative, as well as sections explicitly marked as non-normative. Everything else in this specification is normative.</p>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in the normative parts of this document are to be interpreted as described in <a href="http://dev.w3.org/2006/xbl2/#refsRFC2119">RFC2119</a>. For readability, these words do not appear in all uppercase letters in this specification.</p>

<p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="http://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence">processing equivalence</dfn> is a constraint imposed on the algorithm implementors, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>

<h2 id="dependencies">Dependencies</h2>

<p>This document relies on the following specifications:</p>

<ul>
<!--     <li><a href="http://www.w3.org/TR/CSS2/">CSS Level 2 Revision 1</a></li>
    <li><a href="http://dev.w3.org/csswg/cssom/">CSSOM</a></li>
    <li><a href="http://www.w3.org/TR/DOM-Level-3-Events/">DOM Level 3 Events</a></li> -->
    <li><a href="http://dom.spec.whatwg.org/">DOM4 (DOM Core)</a></li>
    <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/">HTML</a></li>
    <li><a href="http://html5.org/specs/dom-parsing.html">DOM Parsing and Serialization</a></li>
    <li><a href="http://ecma-international.org/ecma-262/5.1/">ECMAScript Language Specification</a></li>
    <li><a href="http://url.spec.whatwg.org/">URL</a></li>
<!--     <li><a href="http://www.w3.org/TR/selectors/">Selectors Level 3</a></li>
    <li><a href="http://dev.w3.org/2006/webapi/selectors-api/">Selectors API Level 1</a></li>
    <li><a href="http://www.w3.org/TR/shadow-dom/">Shadow DOM</a></li>
    <li><a href="http://www.w3.org/TR/WebIDL/">Web IDL</a></li> -->
</ul>

<h2 id="terminology">Terminology</h2>

<p>HTML Imports, or just <dfn id="dfn-import">imports</dfn> from here on, are <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/syntax.html">HTML documents</a> that are <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-link-element">linked</a> as <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/links.html#external-resource-link">external resources</a> from another <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/syntax.html">HTML document</a>. The document that links to an <a href="#dfn-import">import</a> is called a <dfn id="dfn-master-document">master document</dfn>.</p>

<p>The <a href="http://dom.spec.whatwg.org/#concept-document">document</a> that represents an <a href="#dfn-import">import</a> is called the <dfn id="dfn-imported-document">imported document</dfn>, and the <a href="http://dom.spec.whatwg.org/#concept-document-url">URL</a> of the <a href="#dfn-imported-document">imported document</a> is called the <dfn id="dfn-import-location">import location</dfn>.</p>

<h2 id="link-type-import">Link Type "<code>import</code>"</h2>

<p>To enable declaring <a href="#dfn-import">imports</a> in HTML, a new link type is added to <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/links.html#linkTypes">HTML link types</a>:</p>

<div class="monkeypatch">
<p>The <a href="#link-type-import"><code>import</code></a> keyword may be used with <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-link-element"><code>link</code></a> elements. This keyword creates an <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/links.html#external-resource-link">external resource link</a> to a <a href="#dfn-import">import</a>.</p>

<p>The default type for resources given by the <a href="#link-type-import"><code>import</code></a> keyword is <code>text/html</code>.</p>

<p>The appropriate time to <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#concept-link-obtain">obtain</a> the resource is when the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/links.html#external-resource-link">external resource link</a> is created or when its element is <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#insert-an-element-into-a-document">inserted into a document</a>, whichever happens last.</p>
</div>

<div class="informative">
<p>The following document has one import, located at <kbd>/imports/heart.html</kbd>:</p>

<pre><code class="prettyprint">
&lt;!DOCTYPE html&gt;
&lt;html lang="en-US"&gt;
    &lt;head&gt;
        &lt;title&gt;Human Being&lt;/title&gt;
        &lt;link rel="import" href="/imports/heart.html"&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;p&gt;What is a body without a heart?&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
</div>

<h2 id="interface-import">Interface <code>Import</code></h2>

<p>The <a href="#api-import"><code>Import</code></a> interface represents an <a href="#dfn-import">import</a> in a <a href="#dfn-master-document">master document</a>:</p>

<pre><code>
interface <dfn id="api-import">Import</dfn> {
    readonly attribute DOMString? <a href="#dfn-import-href">href</a>;
    readonly attribute Node <a href="#dfn-import-owner-node">ownerNode</a>;
    readonly attribute <a href="http://dom.spec.whatwg.org/#document">Document</a> <a href="#dfn-import-content">content</a>;
};
</code></pre>

<p>The <dfn id="dfn-import-href"><code>href</code></dfn> attribute <strong>must</strong> return the <a href="#dfn-import-location">import location</a> or <strong>null</strong> if none.</p>

<p>The <dfn id="dfn-import-owner-node"><code>ownerNode</code></dfn> attribute <strong>must</strong> return the <a href="http://dom.spec.whatwg.org/#concept-node">node</a> that links <a href="#dfn-master-document">master document</a> to the <a href="#dfn-import">import</a>.</p>

<p>The <dfn id="dfn-import-content"><code>content</code></dfn> attribute <strong>must</strong> return the <a href="#dfn-imported-document">imported document</a>.</p>

<p>The <a href="#api-link-import"><code>LinkImport</code></a> interface provides access to a <a href="#dfn-import">import</a> from <a href="#dfn-master-document">master document</a>:</p>

<pre><code>
[NoInterfaceObject]
interface <dfn id="api-link-import">LinkImport</dfn> {
    readonly attribute <a href="#api-import">Import?</a> <a href="#dfn-link-import-import">import</a>;
}
</code></pre>

<p>The <dfn id="dfn-link-import-import"><code>import</code></dfn> attribute must return the <a href="#api-import"><code>import</code></a> for the <a href="http://dom.spec.whatwg.org/#concept-node">node</a> that implements this interface.</p>

<div class="monkeypatch" id="html-link-monkeypatch">
<p>The <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-link-element"><code>link</code></a> element implements <a href="#api-link-import"><code>LinkImport</code></a> interface:</p>
<pre><code>
<a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#htmllinkelement">HTMLLinkElement</a> implements <a href="#api-link-import">LinkImport</a>;
</code></pre>

<p>For <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-link-element"><code>link</code></a> elements that do not represent <a href="#dfn-import">imports</a>, the <a href="#dfn-link-import-import"><code>import</code></a> attribute of the <a href="#api-link-import"><code>LinkImport</code></a> interface <strong>must</strong> return <strong>null</strong>. Similarly, if the user agent does not support <a href="#dfn-import">imports</a>, or whose resource is <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/fetching-resources.html#cors-cross-origin">CORS-cross-origin</a>, the <a href="#dfn-link-import-import"><code>import</code></a> attribute of the <a href="#api-link-import"><code>LinkImport</code></a> interface <strong>must</strong> return <strong>null</strong>.</p>

<p>Otherwise, the <a href="#api-link-import"><code>LinkImport</code></a> interface's <a href="#dfn-link-import-import"><code>import</code></a> attribute <strong>must</strong> return <strong>null</strong> if the corresponding element is not <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#in-a-document">in a <code>Document</code></a>, and otherwise <strong>must</strong> return a <a href="#api-import"><code>Import</code></a> object with the following properties:</p>

<dl>
<dt>import location</dt>
<dd>The <a href="#dfn-import-location">import location</a> <strong>must</strong> be the result of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/urls.html#resolve-a-url">resolving</a> the <a href="http://url.spec.whatwg.org/#concept-url">URL</a> given by <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-link-element"><code>link</code></a> element's <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#attr-link-href"><code>href</code></a> content attribute, relative to the element, or empty string if that fails.
</dd><dt>owner node</dt>
<dd>The owner node value <strong>must</strong> be the the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-link-element"><code>link</code></a> element.</dd>
</dl>

<p>The same object <strong>must</strong> be returned each time.</p>

<p><a href="#dfn-import">imports</a> have an <dfn id="dfn-import-ready-flag">import ready flag</dfn>, which is initially unset. When an import is ready to be used, its <a href="#dfn-import-ready-flag">import ready flag</a> <strong>must</strong> be set.</p>

<p>A <a href="#dfn-import">import</a> in the context of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document"><code>Document</code></a> of an <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#html-parser">HTML parser</a> or <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-xhtml-syntax.html#xml-parser">XML Parser</a> is said to be <dfn id="dfn-an-import-that-is-blocking-scripts">an import that is blocking scripts</dfn> if the <a href="http://dom.spec.whatwg.org/#concept-element">element</a> was created by that <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document"><code>Document</code></a>'s parser, and the <a href="http://dom.spec.whatwg.org/#concept-element">element</a> is a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-link-element"><code>link</code></a> of type <a href="#link-type-import"><code>import</code></a> when the <a href="http://dom.spec.whatwg.org/#concept-element">element</a> was created by the parser, and the <a href="http://dom.spec.whatwg.org/#concept-element">element</a>'s <a href="#dfn-import-ready-flag">import ready flag</a> is not yet set, and, the last time the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-loop">event loop</a> has reached step 1, the <a href="http://dom.spec.whatwg.org/#concept-element">element</a> was <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#in-a-document">in that <code>Document</code></a>, and the user agent hasn't given up on that <a href="#dfn-import">import</a> yet. A user agent may give up on a <a href="#dfn-import">import</a> at any time.</p>

</div>
<div class="informative">
<p>
Giving up an import before it loads, even if the import eventually does still load, means that the script might end up operating with incorrect information. For example, if an import registers a custom element and a script relies on the availability of this element, the script will find that this element is unavailable if the user agent gives up early. Implementors have to balance the likelihood of a script using incorrect information with the performance impact of doing nothing while waiting for a slow network request to finish.
</p>
</div>

<div class="monkeypatch">
<p>A <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document"><code>Document</code></a> <dfn id="dfn-has-an-import-that-is-blocking-scripts">has an import that is blocking scripts</dfn> if there is either a <a href="#dfn-an-import-that-is-blocking-scripts">an import that is blocking scripts</a> in the context of that <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document"><code>Document</code></a>, or if that <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document"><code>Document</code></a> is in a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#browsing-context">browsing context</a> that has a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#parent-browsing-context">parent browsing context</a>, and the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#active-document">active document</a> of that <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#parent-browsing-context">parent browsing context</a> itself <a href="#dfn-has-an-import-that-is-blocking-scripts">has an import that is blocking scripts</a>.</p>

<p>A <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document"><code>Document</code></a> <dfn id="dfn-has-no-import-that-is-blocking-scripts">has no import that is blocking scripts</dfn> if it does not <a href="#dfn-has-no-import-that-is-blocking-scripts">have an import that is blocking scripts</a> as defined in the previous paragraph.</p>

</div>

<h2 id="loading-imports">Loading Imports</h2>

<p>The list of all <a href="#dfn-import">imports</a> that have been loaded by the <a href="#dfn-master-document">master document</a> is kept in the <dfn id="dfn-loaded-import-list">loaded import list</dfn>, an ordered list of <a href="#dfn-import-location">import location</a> and <a href="#dfn-imported-document">imported document</a> pairs. New items are added to the bottom of the list.</p>

<p>When a <a href="#dfn-import">import</a> is <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/fetching-resources.html#fetch">fetched</a>, the user agent <strong>must</strong> run the <dfn id="dfn-import-fetching">import fetching</dfn> algorithm, which <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to running these steps:</p>
<div class="algorithm">
<dl>
<dt>Input</dt>
<dd><var>LOCATION</var>, the <a href="#dfn-import-location">import location</a></dd>
<dt>Output</dt>
<dd><var>DOCUMENT</var>, the <a href="#dfn-imported-document">imported document</a></dd>
</dl>
<ol>
    <li>If <var>LOCATION</var> is already in the <a href="#dfn-loaded-import-list">loaded import list</a>, let <var>DOCUMENT</var> be the <a href="#dfn-imported-document">imported document</a> for <var>LOCATION</var> and <strong>stop</strong>.</li>
    <li>Let <var>DOCUMENT</var> be a new <a href="http://dom.spec.whatwg.org/#concept-document">Document</a> that is an <a href="http://dom.spec.whatwg.org/#html-document">HTML document</a> with no <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#browsing-context">browsing context</a></li>
    <li>Set <var>DOCUMENT</var>'s <a href="http://dom.spec.whatwg.org/#concept-document-content-type">content type</a> to "<code>text/html</code>".</li>
    <li>Set <var>DOCUMENT</var>'s <a href="http://dom.spec.whatwg.org/#concept-document-url">URL</a> to <var>LOCATION</var></li>
    <li>Let <var>PARSER</var> be a new <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#html-parser">HTML parser</a>, associated with <var>DOCUMENT</var></li>
    <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/fetching-resources.html#fetch">Fetch a resource</a> from <var>LOCATION</var>, with <var>DOCUMENT</var> as <em>override referrer source</em> and <em>block cookies</em> flag set:
    <ol>
        <li>For each <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#concept-task">task</a> that the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#concept-task">networking task source</a> places on the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#task-queue">task queue</a> while fetching:
        <ol>
            <li>Fill <var>PARSER</var>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#the-input-byte-stream">input byte stream</a> with the fetched bytes</li>
            <li>Let <var>PARSER</var> process the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#the-input-byte-stream">input byte stream</a></li>
        </ol></li>
        <li>When no more bytes are available:
        <ol>
            <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#queue-a-task">Queue a task</a> from the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#networking-task-source">networking task source</a> for <var>PARSER</var> to process implied <code>EOF</code> character</li>
            <li>Add <var>LOCATION</var> and <var>DOCUMENT</var> to the <a href="#dfn-loaded-import-list">loaded import list</a></li>
            <li><a href="#dfn-sub-import-processing">Process sub-imports</a>.</li>
    </ol></li>
</ol>
</li></ol></div>

<p>Each loaded <a href="#dfn-import">import</a> may also contain <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-link-element">links</a> to other <a href="#dfn-import">imports</a>, called <dfn id="dfn-sub-import">sub-imports</dfn>.</p>

<p>The <a href="#dfn-sub-import">sub-imports</a> are discovered and processed with the <dfn id="dfn-sub-import-processing">sub-import processing</dfn> algorithm, which <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to these steps:</p>
<div class="algorithm">
<dl>
<dt>Input</dt>
<dd><var>DOCUMENT</var> the <a href="#dfn-import">import</a> document</dd>
</dl>
<ol>
    <li>For each <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-link-element"><code>link</code></a> element in the <a href="#dfn-import">import</a>'s <a href="http://dom.spec.whatwg.org/#concept-document">document</a>, in <a href="http://dom.spec.whatwg.org/#concept-tree-order">tree order</a>:
    <ol>
        <li>Let <var>LINK</var> be this <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-link-element"><code>link</code></a> element</li>
        <li>If <var>LINK</var>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/links.html#linkTypes">type</a> is <a href="#link-type-import"><code>import</code></a>:
        <ol>
            <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#concept-link-obtain">Obtain</a> the <a href="#dfn-import">import</a> resources using <var>LINK</var> and <a href="#dfn-import-fetching">import fetching</a> algorithm</li>
        </ol></li>
    </ol></li>
</ol>
</div>

<h2 id="parsing-imports">Parsing Imports</h2>

<p>The parsing of <a href="#dfn-import">imports</a> is defined as a set of changes to the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#parsing">HTML Parsing</a>.</p>

<h3 id="additions-to-prepare-a-script-algorithm">Additions to Prepare A Script Algorithm</h3>

<p>In step 15 of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#prepare-a-script">prepare a script</a> algorithm, modify the last part of condition which begins with <em>If element does not have a <code>src</code> attribute</em> to read:</p>
<div class="monkeypatch">
<p>... and the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document"><code>Document</code> of the </a><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#html-parser">HTML parser</a> or <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-xhtml-syntax.html#xml-parser">XML parser</a> that created the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#the-script-element"><code>script</code></a> element <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#has-a-style-sheet-that-is-blocking-scripts">has a style sheet that is blocking scripts</a> or <a href="#dfn-has-an-import-that-is-blocking-scripts">has an import that is blocking scripts</a></p>
</div>

<h3 id="additions-to-tree-construction-algorithm">Additions to Tree Construction Algorithm</h3>

<p>In sub-condition named <em>Otherwise</em> of condition <em>An end tag whose name is "script"</em> in <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/tree-construction.html#parsing-main-incdata">"text" insertion mode</a>, modify step 3 to read:</p>
<div class="monkeypatch">
<ol start="3">
    <li>If the parser's <code><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document">Document</a></code> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#has-a-style-sheet-that-is-blocking-scripts">has a style sheet that is blocking scripts</a> or <a href="#dfn-has-an-import-that-is-blocking-scripts">has an import that is blocking scripts</a> or <em>the script</em>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#ready-to-be-parser-executed">"ready to be parser-executed"</a> flag is not set: <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#spin-the-event-loop">spin the event loop</a> until the parser's <code><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document">Document</a></code> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#has-no-style-sheet-that-is-blocking-scripts">has no style sheet that is blocking scripts</a> and <a href="#dfn-has-no-import-that-is-blocking-scripts">has no import that is blocking scripts</a> and the script's <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#ready-to-be-parser-executed">"ready to be parser-executed"</a> flag is set.</li>
</ol>
</div>

<p>Modify sub-step 1 of step 3 of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-end.html#the-end">the end</a> to read:</p>
<div class="monkeypatch">
<ol>
    <li><p><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#spin-the-event-loop">Spin the event loop</a> until the first <code><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#the-script-element">script</a></code> in the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing">list of scripts that will execute when the document has finished parsing</a> has its <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#ready-to-be-parser-executed">"ready to be parser-executed"</a> flag set <em>and</em> the parser's <code><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document">Document</a></code> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#has-no-style-sheet-that-is-blocking-scripts">has no style sheet that is blocking scripts</a> <em>and</em> has <a href="#dfn-has-no-import-that-is-blocking-scripts">has no import that is blocking scripts</a>.</p></li>    
</ol>
</div>

<h3 id="additions-to-parsing-xhtml-documents">Additions to Parsing XHTML Documents</h3>

<p>Modify step 3 of steps that run following <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#prepare-a-script">preparing</a> the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#the-script-element"><code>script</code></a> element to read:</p>
<div class="monkeypatch">
<ol start="3">
    <li><p><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#spin-the-event-loop">Spin the event loop</a> until the parser's <code><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document">Document</a></code> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#has-no-style-sheet-that-is-blocking-scripts">has no style sheet that is blocking scripts</a> and <a href="#dfn-has-no-import-that-is-blocking-scripts">has no import that is blocking scripts</a> and the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#pending-parsing-blocking-script">pending parsing-blocking script</a>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#ready-to-be-parser-executed">"ready to be parser-executed"</a> flag is set.</p></li>
</ol>
</div>

<h2 id="acknowledgements">Acknowledgements</h2>

<p><span class="vcard">David Hyatt</span> developed <a href="http://dev.w3.org/2006/xbl2/">XBL 1.0</a>, and <span class="vcard">Ian Hickson</span> co-wrote <a href="http://dev.w3.org/2006/xbl2/">XBL 2.0</a>. These documents provided tremendous insight into the problem of behavior attachment and greatly influenced this specification.</p>

<p><span class="vcard">Alex Russell</span> and his considerable forethought triggered a new wave of enthusiasm around the subject of behavior attachment and how it can be applied practically on the Web.</p>

<p><span class="vcard">Dominic Cooney</span>, <span class="vcard">Hajime Morrita</span>, and <span class="vcard">Roland Steiner</span> worked tirelessly to scope the problem within the confines of the Web platform and provided a solid foundation for this document.</p>

<p>The editor would also like to thank <span class="vcard">Alex Komoroske</span>, <span class="vcard">Angelina Fabbro</span>, <span class="vcard">Anne van Kesteren</span>, <span class="vcard">Boris Zbarsky</span>, <span class="vcard">Brian Kardell</span>, <span class="vcard">Daniel Buchner</span>, <span class="vcard">Edward O'Connor</span>, <span class="vcard">Eric Bidelman</span>, <span class="vcard">Erik Arvidsson</span>, <span class="vcard">Elliott Sprehn</span>, <span class="vcard">Hayato Ito</span>, <span class="vcard">James Simonsen</span>, <span class="vcard">Jonas Sicking</span>, <span class="vcard">Neel Goyal</span>, <span class="vcard">Olli Pettay</span>, <span class="vcard">Rafael Weinstein</span>, <span class="vcard">Scott Miles</span>, <span class="vcard">Steve Orvell</span>, <span class="vcard">Tab Atkins</span>, <span class="vcard">William Chan</span>, and <span class="vcard">William Chen</span> for their comments and contributions to this specification.</p>

<p>This list is too short. There's a lot of work left to do. Please contribute by reviewing and filing bugs—and don't forget to ask the editor to add your name into this section.</p>

</section>

</body></html>
body {
    line-height: 1.4em;
}

code {
    background-color: #eee;
    font-family: 'Droid Sans Mono', monospace;
}

body>pre.prettyprint, body>section pre {
    background-color: #eee;
    padding: 0 2em 1em 2em;
    margin: 0;
    border: none;
}

object {
    margin: 0 auto;
    display: block;
}

section.toc ol {
    list-style: none;
}

span.shadow-boundary {
    color: Gray;
}

span.event-ancestor, span.first-divergent-boundary {
    color: DarkRed;
}

span.event-ancestor > em {
    background-color: DarkRed;
    color: White;
    font-style: normal;
    border-radius: 1em;
    padding: 0 0.35em;
}

span.lowest-common-boundary {
    color: Green;
}


.fixme {
    display: block;
    padding: 10px 0 0 20px;
    border-left: 5px solid #E05252;
}


.fixme:before {
    content: 'Informative';
    float: right;
    display: block;
    padding: 2px 10px;
    background-image: -webkit-linear-gradient(top left, #FFFFFF 0%, #FBE9E9 100%);
    background-image: linear-gradient(to bottom right, #FFFFFF 0%, #FBE9E9 100%);
    font-size: 0.9em;
}

.note {
    color: green;
    font-weight: bold;
    font-style: italic;
    padding-left: 2em;
}

.note:before {
    content: "Note: ";
}

dfn {
    font-style: normal;
    font-weight: bold;
    background-color: #f9f9f9;
    padding: 0 2px;
    border: 1px solid #eee;
}

dfn:target {
    background-color: #FFFF91;
}

a {
    text-decoration: none;
    border-bottom: 1px solid #666;
}

a[href*=dfn-] {
    border-bottom: 1px dotted #ccc;
}

div.logo>a {
    border-bottom: none;
}

var {
    font-size: 0.8em;
    color: #005A9C;
    font-style: normal;
}

table {
    border: 1px solid #ccc;
}

table code {
    background-color: transparent;
}

td, th {
    padding: 0.5em;
    vertical-align: top;
}

td {
    border-bottom: 1px solid #ddd;
}

tr:last-of-type td {
    border-bottom: none;
}

th {
    text-align: left;
    background-color: #eee;
}

dt {
    font-weight: bold;
}

dd {
    padding-bottom: 7px;
}

div.algorithm {
    padding: 0 0 0 20px;
    border-left: 5px solid #EAF7F9;
}

div.informative:before {
    content: 'Informative';
    float: right;
    display: block;
    padding: 2px 10px;
    background-image: -webkit-linear-gradient(top left, #FFFFFF 0%, #D3EEDF 100%);
    background-image: linear-gradient(to bottom right, #FFFFFF 0%, #D3EEDF 100%);
    font-size: 0.9em;
}

div.informative {
    padding: 10px 0 0 20px;
    border-left: 5px solid #D3EEDF;
}

div.monkeypatch:before {
    content: 'Monkeypatch';
    float: right;
    display: block;
    padding: 2px 10px;
    background-image: -webkit-linear-gradient(top left, #FFFFFF 0%, #D3EEDF 100%);
    background-image: linear-gradient(to bottom right, #FFFFFF 0%, #D3EEDF 100%);
    font-size: 0.9em;
}

div.monkeypatch {
    padding: 10px 0 0 20px;
    border-left: 5px solid #EEE5D3;
}
<!DOCTYPE html>
<html lang="en"><head>
<title>Shadow DOM</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<link rel="stylesheet" href="spec.css" type="text/css">
<link rel="stylesheet" href="prettify.css" type="text/css">
<link rel="stylesheet" href="http://www.w3.org/StyleSheets/TR/W3C-WD" type="text/css">
</head>

<body>

<div class="head">

<div class="logo">
    <a href="http://www.w3.org/"><img width="72" height="48" src="http://www.w3.org/Icons/w3c_home" alt="W3C"></a>
</div>

<h1>Shadow DOM</h1>
<h2 id="working-draft">W3C Working Draft 22 May 2012</h2>
<dl>
<dt>This version</dt>
    <dd><a href="http://www.w3.org/TR/2012/WD-shadow-dom-20120522/">http://www.w3.org/TR/2012/WD-shadow-dom-20120522/</a></dd>
<dt>Latest version</dt>
    <dd><a href="http://www.w3.org/TR/shadow-dom/">http://www.w3.org/TR/shadow-dom/</a></dd>
<dt>Latest editor's draft</dt>
    <dd><a href="http://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/shadow/index.html">http://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/shadow/index.html</a></dd>
<dt>Previous version</dt>
    <dd><a href="http://www.w3.org/TR/2012/WD-shadow-dom-20120522/">http://www.w3.org/TR/2012/WD-shadow-dom-20120522/</a></dd>
<dt>Revision history</dt>
    <dd><a href="http://dvcs.w3.org/hg/webcomponents/log/tip/spec/shadow/index.html">http://dvcs.w3.org/hg/webcomponents/log/tip/spec/shadow/index.html</a></dd>
<dt>Participate</dt>
    <dd>Discuss on <a href="http://lists.w3.org/Archives/Public/public-webapps/">public-webapps@w3.org</a> (<a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a>)</dd>
    <dd><a href="https://www.w3.org/Bugs/Public/enter_bug.cgi?comment=&amp;blocked=14978&amp;short_desc=%5BShadow%5D%3A%20&amp;product=WebAppsWG&amp;component=Component%20Model">File bugs</a> (w3.org's <a href="https://www.w3.org/Bugs/Public/">Bugzilla</a>)</dd>
<dt>Editor</dt>
    <dd class="vcard"><span class="fn">Dimitri Glazkov</span>, <span class="org">Google</span>, &lt;<a class="email" href="mailto:dglazkov@chromium.org">dglazkov@chromium.org</a>&gt;</dd>
</dl>

<p class="copyright"><a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © 2012 <a href="http://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>®</sup> (<a href="http://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>, <a href="http://www.ercim.eu/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>, <a href="http://www.keio.ac.jp/">Keio</a>), All Rights Reserved. W3C <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>, <a href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and <a href="http://www.w3.org/Consortium/Legal/copyright-documents">document use</a> rules apply.</p>

<hr>

<h2 id="abstract">Abstract</h2>

<p>This specification describes a method of establishing and maintaining functional boundaries between DOM subtrees and how these subtrees interact with each other within a document tree, thus enabling better functional encapsulation within DOM.</p>

<h2 id="status">Status of This Document</h2>

<p><em>This section describes the status of this document at the time of its publication. Other documents may supersede this document. A list of current <abbr title="World Wide Web Consortium">W3C</abbr> publications and the latest revision of this technical report can be found in the <a href="http://www.w3.org/TR/"><abbr title="World Wide Web Consortium">W3C</abbr> technical reports index</a> at http://www.w3.org/TR/.</em></p>

<p>This document was published by the <a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a> as a First Public Working Draft. If you wish to make comments regarding this document, please send them to <a href="mailto:public-webapps@w3.org">public-webapps@w3.org</a> (<a href="mailto:public-webapps-request@w3.org?subject=subscribe">subscribe</a>, <a href="http://lists.w3.org/Archives/Public/public-webapps/">archives</a>). All feedback is welcome.</p><p>Publication as a Working Draft does not imply endorsement by the <abbr title="World Wide Web Consortium">W3C</abbr> Membership. This is a draft document and may be updated, replaced or obsoleted by other documents at any time. It is inappropriate to cite this document as other than work in progress.</p>

<p>This document was produced by a group operating under the <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004 <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>. <abbr title="World Wide Web Consortium">W3C</abbr> maintains a <a href="http://www.w3.org/2004/01/pp-impl/42538/status" rel="disclosure">public list of any patent disclosures</a> made in connection with the deliverables of the group; that page also includes instructions for disclosing a patent. An individual who has actual knowledge of a patent which the individual believes contains <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential Claim(s)</a> must disclose the information in accordance with <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section 6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>.</p>

</div>

<section class="toc">
<h2 id="toc">Table of Contents</h2>
<ol>
    <li><a href="#about"><span class="section">1</span> About this Document</a></li>
    <li><a href="#dependencies"><span class="section">2</span> Dependencies</a></li>
    <li><a href="#terminology"><span class="section">3</span> Terminology</a></li>
    <li><a href="#introduction"><span class="section">4</span> Introduction</a>
    <ol>
        <li><a href="#functional-encapsulation-example"><span class="section">4.1</span> Functional Encapsulation Example</a></li>
    </ol></li>
    <li><a href="#shadow-dom-subtrees"><span class="section">5</span> Shadow DOM Subtrees</a>
    <ol>
        <li><a href="#upper-boundary-encapsulation"><span class="section">5.1</span> Upper-boundary Encapsulation</a></li>
        <li><a href="#lower-boundary-encapsulation"><span class="section">5.2</span> Lower-boundary Encapsulation</a></li>
        <li><a href="#matching-insertion-points"><span class="section">5.3</span> Matching Insertion Points</a></li>
        <li><a href="#selecting-nodes-distributed-to-insertion-points"><span class="section">5.4</span> Matching Host and Children, Distributed To Insertion Points</a></li>
        <li><a href="#multiple-shadow-subtrees"><span class="section">5.5</span> Hosting Multiple Shadow Subtrees</a></li>
        <li><a href="#nested-shadow-subtrees"><span class="section">5.6</span> Nested Shadow Subtrees</a></li>
        <li><a href="#rendering-shadow-subtrees"><span class="section">5.7</span> Rendering Shadow Subtrees</a></li>
    </ol></li>
    <li><a href="#events"><span class="section">6</span> Events</a>
    <ol>
        <li><a href="#event-retargeting"><span class="section">6.1</span> Event Retargeting</a></li>
        <li><a href="#retargeting-related-target"><span class="section">6.2</span> Retargeting <code>relatedTarget</code></a></li>
        <li><a href="#retargeting-focus-events"><span class="section">6.3</span> Retargeting Focus Events</a></li>
        <li><a href="#events-that-are-always-stopped"><span class="section">6.4</span> Events that are Always Stopped</a></li>
        <li><a href="#event-dispatch"><span class="section">6.5</span> Event Dispatch</a></li>
        <li><a href="#event-retargeting-example"><span class="section">6.6</span> Event Retargeting Example</a></li>
    </ol></li>
    <li><a href="#styles"><span class="section">7</span> Styles</a>
    <ol>
        <li><a href="#css-variables"><span class="section">7.1</span> CSS Variables</a></li>
        <li><a href="#text-decoration-property"><span class="section">7.2</span> <code>text-decoration</code> Property</a></li>
    </ol></li>
    <li><a href="#user-interaction"><span class="section">8</span> User Interaction</a>
    <ol>
        <li><a href="#ranges-and-selection"><span class="section">8.1</span> Ranges and Selections</a></li>
        <li><a href="#focus-navigation"><span class="section">8.2</span> Focus Navigation</a></li>
        <li><a href="#active-element"><span class="section">8.3</span> Active Element</a></li>
        <li><a href="#editing"><span class="section">8.4</span> Editing</a></li>
        <li><a href="#assistive-technology"><span class="section">8.5</span> Assistive Technology</a></li>
    </ol>
    </li>
    <li><a href="#html-elements"><span class="section">9</span> HTML Elements in Shadow DOM Subtrees</a>
    <ol>
        <li><a href="#inert-html-elements"><span class="section">9.1</span> Inert HTML Elements</a></li>
        <li><a href="#html-forms"><span class="section">9.2</span> HTML Forms</a></li>
    </ol></li>
    <li><a href="#html-elements-and-their-shadow-dom-subtrees"><span class="section">10</span> HTML Elements and Their Shadow DOM subtrees</a>
    </li><li><a href="#elements-and-dom-objects"><span class="section">11</span> Elements and DOM Objects</a>
    <ol>
        <li><a href="#shadow-root-object"><span class="section">11.1</span> <code>ShadowRoot</code> Object</a>
        <ol>
            <li><a href="#shadow-root-attributes"><span class="section">11.1.1</span> <code>ShadowRoot</code> Attributes</a></li>
            <li><a href="#shadow-root-methods"><span class="section">11.1.2</span> <code>ShadowRoot</code> Methods</a></li>
        </ol></li>
        <li><a href="#content-element"><span class="section">11.2</span> The <code>content</code> HTML element</a></li>
        <li><a href="#shadow-element"><span class="section">11.3</span> The <code>shadow</code> HTML element</a></li>
    </ol></li>
    <li><a href="#shadow-dom-example"><span class="section">12</span> Shadow DOM Example</a></li>
    <li><a href="#acknowledgements">Acknowledgements</a></li>
</ol>

</section>

<section class="math">

<h2 id="about"><span class="section">1</span> About this Document</h2>

<p>All diagrams, examples, notes, are non-normative, as well as sections explicitly marked as non-normative. Everything else in this specification is normative.</p>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in the normative parts of this document are to be interpreted as described in <a href="http://dev.w3.org/2006/xbl2/#refsRFC2119">RFC2119</a>. For readability, these words do not appear in all uppercase letters in this specification.</p>

<p>To help with layering and to avoid circular dependencies between various parts of specification, this document consists of three consecutive narratives:
</p><ol>
    <li>setting up the stage for the specification,</li>
    <li>explaining of the conceptual model and algorithms behind it, and</li>
    <li>expressing this model with DOM interfaces and HTML elements.</li>
</ol>
<p>In a sense, these parts can be viewed as <em>math</em>, which sets up the reasoning environment, <em>physics</em>, which is the theoretical reasoning about the concept, and <em>mechanics</em>, which is the is the practical application of this reasoning.</p>

<p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="http://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence">processing equivalence</dfn> is a constraint imposed on the algorithm implementors, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>

<h2 id="dependencies"><span class="section">2</span> Dependencies</h2>

<p>This document relies on the following specifications:</p>

<ul>
    <li><a href="http://www.w3.org/TR/CSS2/">CSS Level 2 Revision 1</a></li>
    <li><a href="http://dev.w3.org/csswg/cssom/">CSSOM</a></li>
    <li><a href="http://www.w3.org/TR/DOM-Level-3-Events/">DOM Level 3 Events</a></li>
    <li><a href="http://www.w3.org/TR/domcore/">DOM4 (DOM Core)</a></li>
    <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/">HTML</a></li>
    <li><a href="http://html5.org/specs/dom-parsing.html">DOM Parsing and Serialization</a></li>
    <li><a href="http://www.w3.org/TR/selectors/">Selectors Level 3</a></li>
    <li><a href="http://dev.w3.org/2006/webapi/selectors-api/">Selectors API Level 1</a></li>
</ul>

<h2 id="terminology"><span class="section">3</span> Terminology</h2>

<p>The following terms are used throughout the specification:

</p><dl>
<dt>DOM</dt>
    <dd>The <a href="http://www.w3.org/TR/domcore/">document object model</a></dd>
<dt>document</dt>
    <dd>The Document Object Model's underlying document</dd>
<dt>node</dt>
    <dd>Any DOM object that <a href="http://www.w3.org/TR/domcore/#concept-tree-participate">participates in a tree</a></dd>
<dt>element</dt>
    <dd>A DOM object that implements the <a href="http://www.w3.org/TR/domcore/#interface-element">Element</a> interface</dd>
<dt>DOM tree</dt>
    <dd>Any <a href="http://www.w3.org/TR/domcore/#trees">tree</a>, composed of DOM objects</dd>
<dt>DOM structure</dt>
    <dd>A DOM tree or fragment of a DOM tree</dd>
</dl>

</section>

<section class="physics">

<h2 id="introduction"><span class="section">4</span> Introduction</h2>

<p>Web application developers often encounter the need to provide <dfn id="dfn-encapsulation">encapsulation</dfn> of a DOM structure. Despite being part of one document tree, there are typically many functional fragments of DOM (or <dfn id="dfn-dom-subtree">DOM subtrees</dfn>), as well as assumptions about these fragments operating independently. This type of encapsulation is called <dfn id="dfn-functional-encapsulation">functional encapsulation</dfn>, as opposed to <dfn id="dfn-trust-encapsulation">trust encapsulation</dfn>, which deals with limiting information flow based on trust and ensuring security of data and state within an application.</p>

<p><a href="#dfn-functional-encapsulation">Functional encapsulation</a> is primarily concerned with establishing functional boundaries in a document tree. A functional boundary (or just <dfn id="dfn-boundary">boundary</dfn> hereon) is a delineation of functional concerns between two loosely coupled units of functionality.</p>

<h3 id="functional-encapsulation-example"><span class="section">4.1</span> Functional Encapsulation Example</h3>

<p>A Web application user interface is commonly composed of several user interface elements (or <dfn id="dfn-widget">widgets</dfn>), each a DOM subtree. In cases where a widget is tasked with hosting other widgets, the need arises for the widget to understand where its DOM subtree ends and another widget's DOM subtree begins.</p>

<object data="functional-encapsulation-example.svg" width="800" height="500"></object>

<p>This need for observing the functional <a href="#dfn-boundary">boundaries</a> in a document tree is even larger when a <a href="#dfn-widget">widget</a> is operated on—added, moved, or removed in the document tree—by an outside actor, such as the Web application that consumes these widgets. Unless the widget consumer knows exactly how a widget's DOM structure is designed, it is impossible for the consumer to reasonably operate on the widget. A typical workaround has been providing alternative means of operation by the widget developer, which, in striving for API consistency quickly extrapolates into a complete set of widget-specific, DOM-like APIs.</p>

<h2 id="shadow-dom-subtrees"><span class="section">5</span> Shadow DOM Subtrees</h2>

<p>To solve this problem at its core, a new abstraction is introduced. The <dfn id="dfn-shadow-dom">shadow DOM</dfn> allows multiple DOM subtrees (in addition to the document tree) to be composed into one larger tree when rendered. The existence of multiple DOM subtrees is enabled by letting any element in the document tree to host one or more additional DOM subtrees. These <dfn id="dfn-shadow-dom-subtree">shadow DOM subtrees</dfn> are governed by a set of rules that establish encapsulation <a href="#dfn-boundary">boundaries</a> while retaining the standard DOM composability semantics.</p>

<p>The encapsulation <a href="#dfn-boundary">boundaries</a> between shadow DOM subtrees are called <dfn id="dfn-shadow-boundary">shadow boundaries</dfn>. The elements that host shadow DOM subtrees are called <dfn id="dfn-shadow-host">shadow hosts</dfn>, and the root nodes of the shadow DOM subtrees are called <dfn id="dfn-shadow-root">shadow roots</dfn>.</p>

<object data="shadow-dom-subtrees.svg" width="800" height="430"></object>

<p>When rendered, the shadow DOM subtree takes place of the <a href="#dfn-shadow-host">shadow host</a>'s content.</p>

<object data="shadow-rendering.svg" width="450" height="400"></object>

<p>To enable composition of <a href="#dfn-shadow-host">shadow host</a>'s children and the shadow DOM subtree, a notion of insertion points is added to the abstraction. An <dfn id="dfn-insertion-point">insertion point</dfn> is a defined location in the shadow DOM subtree, to which the <a href="#dfn-shadow-host">shadow host</a>'s children are transposed when rendering.</p>

<object data="insertion-points.svg" width="800" height="900"></object>

<p>Thus, the encapsulation of a shadow DOM subtree can be viewed as a two-fold problem:
</p><ol>
    <li>the <dfn id="dfn-upper-boundary-encapsulation">upper-boundary encapsulation</dfn>, or governing the boundary between the shadow root and the shadow host; and</li>
    <li>the <dfn id="dfn-lower-boundary-encapsulation">lower-boundary encapsulation</dfn>, or governing the boundary between the insertion points and the shadow host's children.</li>
</ol>

<h3 id="upper-boundary-encapsulation"><span class="section">5.1</span> Upper-boundary Encapsulation</h3>

<p>To maintain the upper-boundary encapsulation, the following <dfn id="dfn-scoping-constraints">scoping constraints</dfn> must apply to all nodes in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>:</p>
<ul>
    <li>The <a href="http://www.w3.org/TR/domcore/#dom-node-ownerdocument"><code>ownerDocument</code></a> property refers to the document of the <a href="#dfn-shadow-host">shadow host</a></li>
    <li>The nodes and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-document-nameditem-filter">named elements</a> <strong>are not</strong> accessible using <a href="#dfn-shadow-host">shadow host</a>'s document <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-tree-accessors">DOM tree accessors</a> or with <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#window">Window</a> object <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#named-access-on-the-window-object">named properties</a></li>
    <li>The nodes <strong>are not</strong> present in any of the document's <a href="http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#interface-nodelist"><code>NodeList</code></a> or <a href="http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#interface-htmlcollection"><code>HTMLCollection</code></a> instances</li>
    <li>The nodes with a unique <a href="http://www.w3.org/TR/domcore/#concept-id">id</a> and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-document-nameditem-filter">named elements</a> <strong>are not</strong> addressable from any attributes of elements in <a href="#dfn-shadow-host">shadow host</a>'s document</li>
    <li>The stylesheets, represented by the nodes <strong>are not</strong> accessible using <a href="#dfn-shadow-host">shadow host</a> document's <a href="http://dev.w3.org/csswg/cssom/#extensions-to-the-document-interface">CSSOM extensions</a></li>
    <li>The nodes <strong>are</strong> accessible using <a href="#dfn-shadow-root">shadow root</a>'s DOM tree accessor methods</li>
    <li>The nodes with a unique <a href="http://www.w3.org/TR/domcore/#concept-id">id</a> and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-document-nameditem-filter">named elements</a> <strong>are</strong> addressable from any attributes of elements in the same <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a></li>
    <li>The <a href="http://www.w3.org/TR/selectors/">selectors</a> <strong>must not</strong> cross the <a href="#dfn-shadow-boundary">shadow boundary</a> from the document tree into the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a></li>
</ul>
<p>For convenience, the <a href="#dfn-shadow-root">shadow root</a> provides its own set of DOM tree accessor methods. No nodes other than <a href="#dfn-shadow-root">shadow root</a> descendants are accessible with these methods.</p>

<p>The <a href="http://dvcs.w3.org/hg/domcore/raw-file/tip/dom-core.html#dom-node-parentnode"><code>parentNode</code></a> and <a href="http://dvcs.w3.org/hg/domcore/raw-file/tip/dom-core.html#dom-node-parentelement"><code>parentElement</code></a> attributes of the <a href="#dfn-shadow-root">shadow root</a> object must always return <code>null</code>.</p>

<h3 id="lower-boundary-encapsulation"><span class="section">5.2</span> Lower-boundary Encapsulation</h3>

<p>To maintain the lower-boundary encapsulation, the distribution of child nodes of the <a href="#dfn-shadow-host">shadow host</a> among the <a href="#dfn-insertion-point">insertion points</a> in the associated <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> must have the following traits:</p>
<ul>
    <li>The distribution does not affect the state of the document DOM tree or shadow DOM subtrees</li>
    <li>Each insertion point participates in distribution by providing a matching criteria for the child nodes. The <dfn id="dfn-matching-criteria">matching criteria</dfn> determines whether a given node could be distributed to a given insertion point</li>
    <li>The distribution is a result of executing a stable algorithm</li>
    <li>The distribution itself does not change the variables affecting the distribution</li>
    <li>The distribution reoccurs whenever any variable affecting it is changed</li>
</ul>

<p>An <a href="#dfn-insertion-point">insertion point</a> may be <strong>active</strong> or <strong>inactive</strong>. An <dfn id="dfn-active-insertion-point">active</dfn> insertion point participates in the distribution process, whereas the <dfn id="dfn-inactive-insertion-point">inactive</dfn> insertion does not. If not specifically set to be inactive, the insertion point must be considered <strong>active</strong>.</p>

<p>If an <a href="#dfn-insertion-point">insertion point</a> is not in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, it <strong>must</strong> have the same rendering behavior as the <a href="http://www.whatwg.org/specs/web-apps/current-work/#htmlunknownelement"><code>HTMLUnknownElement</code></a>.</p>

<p>The <dfn id="dfn-distribution-algorithm">distribution algorithm</dfn> must produce an outcome that is <a href="#dfn-processing-equivalence">equivalent</a> of the outcome of processing these steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>TREE</var>, a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a></dd>
    <dd><var>POOL</var>, a list of DOM nodes</dd>
<dt>Output</dt>
    <dd>The nodes in <var>POOL</var> are distributed among <a href="#dfn-insertion-point">insertion points</a> in <var>TREE</var>.</dd>
</dl>

<ol>
    <li><dfn id="algo-distribution-repeat-outer">Repeat</dfn> for each <a href="#dfn-active-insertion-point">active</a> <a href="#dfn-insertion-point">insertion point</a> in <var>TREE</var>, in <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#tree-order">tree order</a>:
    <ol>
        <li>Let <var>POINT</var> be the current insertion point</li>
        <li><dfn id="algo-distribution-repeat">Repeat</dfn> for each node in <var>POOL</var>:
        <ol>
            <li>Let <var>NODE</var> be the current node</li>
            <li>If the <var>NODE</var> matches <var>POINT</var>'s <a href="#dfn-matching-criteria">matching criteria</a>:
                <ol>
                    <li>Distribute the <var>NODE</var> to <var>POINT</var></li>
                    <li>Remove <var>NODE</var> from the <var>POOL</var></li>
                </ol></li>
            <li>Otherwise, continue to <a href="#algo-distribution-repeat">repeat</a></li>
        </ol></li>
        <li>Continue to <a href="#algo-distribution-repeat-outer">repeat</a></li>
    </ol></li>
</ol>
</div>

<h3 id="matching-insertion-points"><span class="section">5.3</span> Matching Insertion Points</h3>

<p>The <a href="#dfn-matching-criteria">matching criteria</a> for <a href="#dfn-insertion-point">insertion point</a> is defined as a set of selector fragments. Each <dfn id="dfn-selector-fragment">selector fragment</dfn> is indeed a fragment in the <a href="http://www.w3.org/TR/css3-selectors">selector</a> <code>(shadow-host)&gt;(fragment)</code>, where <code>(shadow-host)</code> is a selector that uniquely identifies the <a href="#dfn-shadow-host">shadow host</a>, and <code>(fragment)</code> is the <a href="#dfn-selector-fragment">selector fragment</a>.</p>

<p>A <dfn id="dfn-valid-selector-fragment">valid selector fragment</dfn> may contain:</p>

<ul>
    <li>A <a href="http://www.w3.org/TR/css3-selectors/#type-selectors">type selector</a> or a <a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a></li>
    <li><a href="http://www.w3.org/TR/css3-selectors/#class-html">class selector(s)</a></li>
    <li>An <a href="http://www.w3.org/TR/css3-selectors/#id-selectors">ID selector</a></li>
    <li><a href="http://www.w3.org/TR/css3-selectors/#attribute-selectors">attribute selector(s)</a></li>
    <li>the following <a href="http://www.w3.org/TR/css3-selectors/#pseudo-classes">pseudo-class selector(s)</a>:
        <ul>
            <li><code>:link</code></li>
            <li><code>:visited</code></li>
            <li><code>:target</code></li>
            <li><code>:enabled</code></li>
            <li><code>:disabled</code></li>
            <li><code>:checked</code></li>
            <li><code>:indeterminate</code></li>
            <li><code>:nth-child()</code></li>
            <li><code>:nth-last-child()</code></li>
            <li><code>:nth-of-type()</code></li>
            <li><code>:nth-last-of-type()</code></li>
            <li><code>:first-child</code></li>
            <li><code>:last-child</code></li>
            <li><code>:first-of-type</code></li>
            <li><code>:last-of-type</code></li>
            <li><code>:only-of-type</code></li>
        </ul>
    </li>
</ul>

<p>If any other types of selectors are present in the <a href="#dfn-selector-fragment">selector fragment</a>, the fragment must be considered invalid.</p>

<p>A conforming UAs must consider a node as <dfn id="#dfn-content-matching">matching</dfn> a set of <a href="#dfn-selector-fragment">selector fragments</a> in the context of a given <a href="#dfn-shadow-host">shadow host</a>, if it:
</p><ol>
    <li>is a child node of the shadow host; and</li>
    <li>all <a href="#dfn-selector-fragment">selector fragments</a> in the set are <a href="#dfn-valid-selector-fragment">valid</a>; and</li>
    <li>child node matches at least one selector fragment in the set or the set is empty.</li>
</ol>

<h3 id="selecting-nodes-distributed-to-insertion-points"><span class="section">5.4</span> Matching Host and Children, Distributed To Insertion Points</h3>

<p>Two kinds of <a href="http://www.w3.org/TR/selectors/">selectors</a>, declared in <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a> <strong>must</strong> match elements outside of the tree in which they are declared:</p>
<ul>
    <li>The <code>:host</code> pseudoclass, which matches the <a href="#dfn-shadow-host">shadow host</a> of a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a></li>
    <li>The <code>select</code> <a href="http://dev.w3.org/csswg/selectors4/#idref-combinators">reference combinator</a>, which matches the nodes, currently distributed to an <a href="#dfn-insertion-point">insertion point</a>
</li></ul>

<p>The <code>:host</code> pseudoclass represents the <a href="#dfn-shadow-host">shadow host</a> of a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>. If the <a href="http://www.w3.org/TR/selectors4/#contextual-reference-element-set">contextual reference element set</a> is empty or includes elements outside of a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, <code>:host</code> matches northing.</p>

<p><a href="http://dev.w3.org/csswg/selectors4/#idref-combinators">Reference combinators</a> match the children of a <a href="#dfn-shadow-host">shadow host</a>, distributed to the <a href="#dfn-insertion-point">insertion points</a> within a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>. To match, all of these conditions <strong>must</strong> apply:</p>
<ul>
    <li>The combinator value must be <code>select</code></li>
    <li>The first compound selector of the combinator must match an <a href="#dfn-insertion-point">insertion point</a></li>
    <li>The second compound selector must match an element, distributed to this <a href="#dfn-insertion-point">insertion point</a></li>
</ul>
<p>For example, <code class="prettify">.some-insertion-point /select/ div.special</code> will match all <code>div</code> elements that have <code>class</code> attribute set to <code>special</code> and have been distributed to an insertion point that has a class attribute set to <code>some-insertion-point</code>.</p>

<p>All other types of selectors <strong>must not</strong> cross the <a href="#dfn-shadow-boundary">shadow boundary</a> from a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> to the tree of its <a href="#dfn-shadow-host">shadow host</a>.</p>


<h3 id="multiple-shadow-subtrees"><span class="section">5.5</span> Hosting Multiple Shadow Subtrees</h3>

<p>A <a href="#dfn-shadow-host">shadow host</a> may host more than one <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>. In such cases, the subtrees are stacked in the order they were added the the host, starting with the subtree added most recently. This set of trees is called a <dfn id="dfn-tree-stack">tree stack</dfn>. The more recently added subtree is called the <dfn id="dfn-younger-tree">younger tree</dfn>, and the less recently added subtree is called the <dfn id="dfn-older-tree">older tree</dfn>. The most recently added subtree is called the <dfn id="dfn-youngest-tree">youngest tree</dfn>.</p>

<p>To facilitate composing multiple shadow subtrees of the same host, a special kind of <a href="#dfn-insertion-point">insertion point</a> is defined. The <dfn id="dfn-shadow-insertion-point">shadow insertion point</dfn> designates a place in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, where an <a href="#dfn-older-tree">older tree</a> is inserted.</p>

<p>Just like other <a href="#dfn-insertion-point">insertion points</a>, the <a href="#dfn-shadow-insertion-point">shadow insertion points</a> can be <a href="#dfn-active-insertion-point">active</a> or <a href="#dfn-inactive-insertion-point">inactive</a>.</p>

<p>The composition is performed with the <dfn id="dfn-tree-composition">tree composition algorithm</dfn>, which must be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:

</p><div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>HOST</var>, a <a href="#dfn-shadow-host">shadow host</a></dd>
<dt>Output</dt>
    <dd>All <a href="#dfn-insertion-point">insertion points</a> and <a href="#dfn-shadow-insertion-point">shadow insertion points</a> are populated.</dd>
</dl>

<ol>
    <li>Let <var>TREE</var> be the <a href="#dfn-youngest-tree">youngest tree</a> in the <var>HOST</var>'s <a href="#dfn-tree-stack">tree stack</a>
    </li><li>Let <var>POOL</var> be the list of nodes</li>
    <li>Populate <var>POOL</var> with child nodes of the <var>HOST</var></li>
    <li><dfn id="algo-composition-repeat">Repeat</dfn> while <var>TREE</var> exists:
    <ol>
        <li>Let <var>POINT</var> be the first encountered <a href="#dfn-active-insertion-point">active</a> <a href="#dfn-shadow-insertion-point">shadow insertion point</a> in <var>TREE</var>, in <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#tree-order">tree order</a>
        </li><li>Run the <a href="#dfn-distribution-algorithm">distribution algorithm</a>, supplying <var>POOL</var> and <var>TREE</var> as input</li>
        <li>If <var>POINT</var> exists:
        <ol>
            <li>Find the next older tree, relative to <var>TREE</var> in the <var>HOST</var>'s <a href="#dfn-tree-stack">tree stack</a>
            <ol>
                <li>If there is no older tree:
                <ol>
                    <li>Distribute remaining nodes in <var>POOL</var>, if any, to <var>POINT</var></li>
                    <li><strong>stop</strong>.</li>
                </ol></li>
                <li>Otherwise:
                <ol>
                    <li>Set <var>TREE</var> to be this older tree</li>
                    <li><dfn id="dfn-assign-older-tree">Assign</dfn> <var>TREE</var> to the <var>POINT</var></li>
                    <li>Continue to <a href="#algo-composition-repeat">repeat</a></li>
                </ol></li>
            </ol></li>
        </ol></li>
        <li>Otherwise, <strong>stop</strong>.
    </li></ol></li>
</ol>
</div>

<p>When an <a href="#dfn-insertion-point">insertion point</a> or a <a href="#dfn-shadow-insertion-point">shadow insertion point</a> has nothing <a href="#dfn-assign-older-tree">assigned</a> or <a href="#dfn-distribution-algorithm">distributed</a> to them, the fallback content must be used instead when rendering. The <dfn id="dfn-fallback-content">fallback content</dfn> is all descendants of the DOM element that represents the insertion point. The <a href="#dfn-insertion-point">insertion points</a> or <a href="#dfn-shadow-insertion-point">shadow insertion points</a> in fallback content must be considered <a href="#dfn-inactive-insertion-point">inactive</a>.</p>

<h3 id="nested-shadow-subtrees"><span class="section">5.6</span> Nested Shadow Subtrees</h3>

<p>Any element in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> can be a <a href="#dfn-shadow-host">shadow host</a>, thus producing nested shadow DOM subtrees. A shadow DOM subtree is <dfn id="dfn-nested-subtree">nested</dfn> when its <a href="#dfn-shadow-host">shadow host</a> is itself a part of a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</p>

<p>A <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> is <dfn id="dfn-enclosed-subtree">enclosed</dfn> by another <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> when the enclosing subtree nests the enclosed subtree through one or more levels of nesting.</p>

<h3 id="rendering-shadow-subtrees"><span class="section">5.7</span> Rendering Shadow DOM Subtrees</h3>

<p><dfn id="dfn-rendering">Rendering</dfn> of <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>, or presenting them visually, is defined as a specialization of rendering <strong>any DOM subtree</strong>, and must happen as these steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>HOST</var>, a <a href="#dfn-shadow-host">shadow host</a></dd>
<dt>Output</dt>
    <dd>Rendering of the <var>HOST</var>, including its <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a></dd>
</dl>

<ol>
    <li>Run <a href="#dfn-tree-composition">tree composition algorithm</a> for the given <a href="#dfn-shadow-host">shadow host</a></li>
    <li>As content of the <a href="#dfn-shadow-host">shadow host</a>, render the <a href="#dfn-youngest-tree">youngest tree</a> as a <strong>any DOM subtree</strong>, with the following <dfn id="dfn-shadow-rendering">shadow rendering</dfn> exceptions:
    <ul>
        <li>Each element that is a <a href="#dfn-shadow-host">shadow host</a> must be <a href="#dfn-rendering">rendered</a> accordingly</li>
        <li>In place of each <a href="#dfn-insertion-point">insertion point</a>, process the following <dfn id="dfn-insertion-point-rendering">insertion point rendering</dfn> steps:
        <ol>
            <li>If there are child nodes <a href="#dfn-distribution-algorithm">distributed</a> to this insertion point, for each child node and in the order they were distributed:
            <ol>
                <li>Let <var>CHILD</var> be the child node being rendered</li>
                <li>If <var>CHILD</var> is itself an <a href="#dfn-insertion-point">insertion point</a>, and the tree being rendered is <a href="#dfn-nested-subtree">nested</a>, render them using <a href="#dfn-insertion-point-rendering">insertion point rendering</a> steps</li>
                <li>Otherwise, render <var>CHILD</var> as <strong>any DOM subtree</strong>
            </li></ol></li>
            <li>Otherwise, render <a href="#dfn-fallback-content">fallback content</a> as <strong>any DOM subtree</strong></li>
        </ol></li>
        <li>In place of each <a href="#dfn-shadow-insertion-point">shadow insertion point</a>:
        <ol>
            <li>If there is an <a href="#dfn-older-tree">older tree</a>, <a href="#dfn-assign-older-tree">assigned</a> to this shadow insertion point, render it as <strong>any DOM subtree</strong>, but with the same <a href="#dfn-shadow-rendering">shadow rendering</a> exceptions.</li>
            <li>Otherwise, render <a href="#dfn-fallback-content">fallback content</a> as <strong>any DOM subtree</strong></li>
        </ol></li>
    </ul></li>
</ol>
</div>

<p>This process of <a href="#dfn-rendering">rendering</a> produces a structure that is a composition of several DOM subtrees, including the document tree. The term "<dfn id="dfn-as-rendered">as rendered</dfn>" is used to refer to this structure.</p>

<h2 id="events"><span class="section">6</span> Events</h2>

<p>When an <a href="http://www.w3.org/TR/domcore/#events">event</a> is <a href="http://www.w3.org/TR/domcore/#dispatching-events">dispatched</a> in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, its path either crosses the <a href="#dfn-shadow-boundary">shadow boundary</a> or is terminated at the <a href="#dfn-shadow-boundary">shadow boundary</a>. One exception are the mutation events. The <a href="http://www.w3.org/TR/DOM-Level-2-Events/events.html#Events-eventgroupings-mutationevents">mutation event types</a> <strong>must</strong> never be dispatched in a shadow DOM subtree.</p>

<p>For event path to cross the <a href="#dfn-shadow-boundary">shadow boundary</a>, it <strong>must</strong> be populated with <dfn id="dfn-adjusted-parent">adjusted parents</dfn>, or nodes that appear as parents <a href="#dfn-as-rendered">as rendered</a>. The <dfn id="dfn-parent-calculation-algorithm">parent calculation algorithm</dfn> is used to determine the <a href="#dfn-adjusted-parent">adjusted parent</a> of any given node and create the list of ancestors for event dispatch. This algorithm must be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>NODE</var>, a DOM node</dd>
    <dd><var>IGNORE UPPER BOUNDARY</var>, a flag, initialized to <strong>false</strong></dd>
<dt>Output</dt>
    <dd><var>PARENT</var>, a DOM node's <a href="#dfn-adjusted-parent">adjusted parent</a></dd>
</dl>
<ol>
    <li>If <var>NODE</var> is a <a href="#dfn-shadow-root">shadow root</a>:
    <ol>
        <li>If <var>NODE</var> is currently <a href="#dfn-assign-older-tree">assigned</a> to a <a href="#dfn-shadow-insertion-point">shadow insertion point</a>:
        <ol>
            <li>Let the <var>PARENT</var> be the <a href="#dfn-shadow-insertion-point">shadow insertion point</a> to which <var>NODE</var> is <a href="#dfn-assign-older-tree">assigned</a> to</li>
        </ol></li>
        <li>Otherwise, let the <var>PARENT</var> be the <a href="#dfn-shadow-host">shadow host</a> of the <var>NODE</var>
    </li></ol></li>
    <li>If <var>NODE</var> is currently distributed to an <a href="#dfn-insertion-point">insertion point</a> in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, <strong>and</strong> the <var>IGNORE UPPER BOUNDARY</var> flag is set to <strong>false</strong>
    <ol>
        <li>Let the <var>PARENT</var> be the <a href="#dfn-insertion-point">insertion point</a> to which the <var>NODE</var> is distributed to</li>
    </ol></li>
    <li>Otherwise, let <var>PARENT</var> be the node's parent node.</li>
</ol>
</div>

<h3 id="event-retargeting"><span class="section">6.1</span> Event Retargeting</h3>

<p>In the cases where events cross the <a href="#dfn-shadow-boundary">shadow boundaries</a>, the event's information about the target of the event is adjusted in order to maintain <a href="#dfn-upper-boundary-encapsulation">upper boundary encapsulation</a>. Event <dfn id="dfn-retargeting">retargeting</dfn> is a process of computing relative targets for each ancestor of the node at which the event is dispatched. A <dfn id="dfn-relative-target">relative target</dfn> is a DOM node that most accurately represents the target of a dispatched event at a given ancestor while maintaining the <a href="#dfn-upper-boundary-encapsulation">upper boundary encapsulation</a>.

</p><p>The <dfn id="dfn-retargeting-algorithm">retargeting algorithm</dfn> is used to determine relative targets, and it must be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>NODE</var>, a DOM node</dd>
<dt>Output</dt>
    <dd><var>TARGETS</var>, a list of tuples, each containing <var>NODE</var>'s ancestor and its relative target</dd>
</dl>
<ol>
    <li>Let <var>BOUNDARY</var> be a flag, initialized to <strong>false</strong></li>
    <li>Let <var>STACK</var> be a stack of DOM nodes</li>
    <li>Let <var>ANCESTOR</var> be <var>NODE</var></li>
    <li><dfn id="algo-reatargeting-repeat">Repeat</dfn> while <var>ANCESTOR</var> exists:
    <ol>
        <li>If <var>ANCESTOR</var> <strong>is</strong> a <a href="#dfn-shadow-root">shadow root</a>, set <var>BOUNDARY</var> to <strong>true</strong></li>
        <li>If <var>ANCESTOR</var> <strong>is</strong> an <a href="#dfn-insertion-point">insertion point</a>, push <var>ANCESTOR</var> into <var>STACK</var></li>
        <li>If <var>BOUNDARY</var> is set to <strong>true</strong>
        <ol>
            <li>Pop <var>STACK</var> if <var>STACK</var> is not empty</li>
            <li>Set <var>BOUNDARY</var> to <strong>false</strong> state</li>
        </ol></li>
        <li>If <var>STACK</var> is empty, push <var>ANCESTOR</var> into <var>STACK</var></li>
        <li>Let <var>TARGET</var> be the DOM node at the top of <var>STACK</var></li>
        <li>Add (<var>TARGET</var>, <var>ANCESTOR</var>) tuple to <var>TARGETS</var></li>
        <li>Set <var>ANCESTOR</var> to be the result of <a href="#dfn-parent-calculation-algorithm">parent calculation algorithm</a>, given <var>ANCESTOR</var> as input</li>
    </ol></li>
</ol>
</div>

<p>The retargeting process must occur prior to dispatch of an event.</p>

<h3 id="retargeting-related-target"><span class="section">6.2</span> Retargeting <code>relatedTarget</code></h3>

<p>Some events have a <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> property, which holds a node that's not the event's target, but is related to the event.</p>

<p>For instance, a <code>mouseover</code> event's <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> may hold the node from which the mouse has moved to event's <code>target</code>. In the case where <code>relatedTarget</code> is in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, the conforming UAs must not leak its actual value outside of this subtree. In cases where both <code>relatedTarget</code> and <code>target</code> are part of the same <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, the conforming UAs must <em>stop</em> events at the <a href="#dfn-shadow-boundary">shadow boundary</a> to avoid the appearance of spurious <code>mouseover</code> and <code>mouseout</code> events firing from the same node.</p>

<p>Thus, if an event has a <code>relatedTarget</code>, its value and extent of event dispatch must be adjusted. In general:</p>
<ol>
    <li>For a given DOM node, the <code>relatedTarget</code> <strong>must</strong> be changed to its ancestor (or self) that is in the same <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> as the node</li>
    <li>Event listeners <strong>must not</strong> be invoked on a DOM node for which the <code>target</code> and <code>relatedTarget</code> are the same.</li>
</ol>

<p>The <dfn id="dfn-related-target-algorithm">related target resolution</dfn> algorithm <strong>must</strong> be used to determine the value of the <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> property and <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>NODE</var>, the DOM node on which event listeners would be invoked</dd>
    <dd><var>RELATED</var>, the related target for the event</dd>
<dt>Output</dt>
    <dd><var>ADJUSTED</var>, the <dfn id="dfn-adjusted-related-target">adjusted related target</dfn> for <var>NODE</var></dd>
</dl>
<ol>
    <li>Let <var>CANDIDATES</var> be an empty list</li>
    <li>Let <var>ANCESTOR</var> be <var>RELATED</var></li>
    <li><dfn id="algo-candidates-repeat">Repeat</dfn> while <var>ANCESTOR</var> exists:
    <ol>
        <li>If a node from the same subtree as <var>ANCESTOR</var> already exists in <var>CANDIDATES</var>, <a href="#algo-candidates-repeat">continue</a></li>
        <li>Add <var>ANCESTOR</var> to <var>CANDIDATES</var></li>
        <li>Let <var>ANCESTOR</var> be the result of <a href="#dfn-parent-calculation-algorithm">parent calculation algorithm</a>, given <var>ANCESTOR</var> as input</li>
    </ol></li>
    <li>Let <var>TARGET</var> be <var>NODE</var></li>
    <li>Let <var>ADJUSTED</var> be <strong>undefined</strong></li>
    <li><dfn id="algo-related-repeat">Repeat</dfn> while <var>ADJUSTED</var> is <strong>undefined</strong>:
    <ol>
        <li>If there is a DOM node that is a member of <var>CANDIDATES</var> and is in the same subtree as <var>TARGET</var>,  let <var>ADJUSTED</var> be this DOM node</li>
        <li>Otherwise:
        <ol>
            <li>If <var>TARGET</var> is a <a href="#dfn-shadow-root">shadow root</a>, let <var>TARGET</var> be the <a href="#dfn-shadow-host">shadow host</a> of <var>TARGET</var></li>
            <li>Otherwise, let <var>TARGET</var> be <var>TARGET</var>'s parent node</li>
        </ol></li>
    </ol></li>
</ol>
</div>

<h3 id="retargeting-focus-events"><span class="section">6.3</span> Retargeting Focus Events</h3>

<p>The <code>focus</code>, <code>DOMFocusIn</code>, <code>blur</code>, and <code>DOMFocusOut</code> events must be treated in the same way as events with a <code>relatedTarget</code>, where the corresponding node that is losing focus as a result of <code>target</code> gaining focus or the node that is gaining focus, and thus causing the blurring of <code>target</code> acts as the related target.</p>

<h3 id="events-that-are-always-stopped"><span class="section">6.4</span> Events that are Always Stopped</h3>

<p>The following events <strong>must</strong> always be stopped at the nearest <a href="#dfn-shadow-boundary">shadow boundary</a>:</p>
<ul>
    <li><code>abort</code></li>
    <li><code>select</code></li>
    <li><code>change</code></li>
    <li><code>reset</code></li>
    <li><code>resize</code></li>
    <li><code>scroll</code></li>
    <li><code>selectstart</code></li>
</ul>

<h3 id="event-dispatch"><span class="section">6.5</span> Event Dispatch</h3>

<p>At the time of event dispatch:</p>
<ul>
    <li>The <a href="http://www.w3.org/TR/domcore/#event"><code>Event</code></a> <a href="http://www.w3.org/TR/domcore/#dom-event-target"><code>target</code></a> and <a href="http://www.w3.org/TR/domcore/#dom-event-currenttarget"><code>currentTarget</code></a> attributes <strong>must</strong> return the <a href="#dfn-relative-target">relative target</a> for the node on which event listeners are <a href="http://www.w3.org/TR/domcore/#concept-event-listener-invoke">invoked</a></li>
    <li>The <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-UIEvent"><code>UIEvent</code></a> <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> attribute <strong>must</strong> return the <a href="#dfn-adjusted-related-target">adjusted related target</a></li>
    <li>If the <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> and <a href="http://www.w3.org/TR/domcore/#dom-event-target"><code>target</code></a> are the same for a given node, its the event listeners <strong>must not</strong> be invoked</li>
    <li>When <em>capturing</em>, which entails processing step 3 of the <a href="http://www.w3.org/TR/domcore/#dispatching-events">event dispatch algorithm</a>, the <a href="http://www.w3.org/TR/domcore/#event"><code>Event</code></a> <a href="http://www.w3.org/TR/domcore/#dom-event-eventphase">eventPhase</a> attribute <strong>must</strong> return <a href="http://www.w3.org/TR/domcore/#dom-event-at_target">AT_TARGET</a> <strong>if</strong> the <a href="#dfn-relative-target">relative target</a> is same as the node on which event listeners are <a href="http://www.w3.org/TR/domcore/#concept-event-listener-invoke">invoked</a></li>
    <li>When <em>bubbling</em>, which entails processing step 6 of the <a href="http://www.w3.org/TR/domcore/#dispatching-events">event dispatch algorithm</a>, the event listeners <strong>must not</strong> be <a href="http://www.w3.org/TR/domcore/#concept-event-listener-invoke">invoked</a> on a node <strong>if</strong> it is the same as its <a href="#dfn-relative-target">relative target</a></li>
</ul>

<p>Upon completion of the event dispatch, the <a href="http://www.w3.org/TR/domcore/#event"><code>Event</code></a> object's <a href="http://www.w3.org/TR/domcore/#dom-event-target"><code>target</code></a> and <a href="http://www.w3.org/TR/domcore/#dom-event-currenttarget"><code>currentTarget</code></a> <strong>must</strong> be to the highest ancestor's <a href="#dfn-relative-target">relative target</a>. Since it is possible for a script to hold on to the <code>Event</code> object past the scope of event dispatch, this step is necessary to avoid revealing the nodes in <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>.</p>

<h3 id="event-retargeting-example"><span class="section">6.6</span> Event Retargeting Example</h3>

<p>Suppose we have a user interface for a media controller, represented by this DOM tree, composed of both document and the <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>. In this example, we will assume that selectors are allowed to cross the shadow boundaries and we will use these selectors to identify the elements. Also, we will invent a fictional <code>shadow-boundary</code> element to demarcate the <a href="#dfn-shadow-boundary">shadow boundaries</a>:</p>
<pre><code>
&lt;div id="player"&gt;
    <span class="shadow-boundary">&lt;shadow-boundary&gt;</span>
        &lt;div class="controls"&gt;
            &lt;button class="play-button"&gt;
            &lt;input type="range" class="timeline"&gt;
                <span class="shadow-boundary">&lt;shadow-boundary&gt;</span>
                    &lt;div class="slider-thumb"&gt;&lt;/div&gt;
                <span class="shadow-boundary">&lt;/shadow-boundary&gt;</span>
            &lt;/input&gt;
            &lt;div class="volume-slider-container"&gt;
                &lt;input type="range" class="volume-slider"&gt;
                    <span class="shadow-boundary">&lt;shadow-boundary&gt;</span>
                        &lt;div class="slider-thumb"&gt;&lt;/div&gt;
                    <span class="shadow-boundary">&lt;/shadow-boundary&gt;</span>
                &lt;/input&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    <span class="shadow-boundary">&lt;/shadow-boundary&gt;</span>
&lt;/div&gt;
</code></pre>

<p>Let's have a user position their pointing device over the volume slider's thumb (<code>#player .volume-slider .slider-thumb</code>), thus triggering a <code>mouseover</code> event on that node. For this event, let's pretend it has no associated <code>relatedTarget</code>.</p>

<p>Just before the event is dispatched, we perform <a href="#dfn-retargeting">retargeting</a>:</p>
<ol>
    <li>We set the <a href="#dfn-relative-target">relative target</a> of the thumb node to itself.</li>
    <li>Walking up, we find a <a href="#dfn-shadow-boundary">shadow boundary</a> and skip it.</li>
    <li>Next up is an input (<code>#player .volume-slider</code>), and we set its relative target to itself, since the previous ancestor was a shadow boundary.</li>
    <li>We then walk up to the containing div (<code>#player .volume-slider-container</code>), and use previous ancestor's target -- the input element.</li>
    <li>Walking up one more, we reach the controls panel (<code>#player .controls</code>), and again use input element as relative target per <a href="#dfn-retargeting-algorithm">retargeting algorithm</a>.</li>
    <li>Next, we reach another <a href="#dfn-shadow-boundary">shadow boundary</a> and skip it.</li>
    <li>Finally we walk up to the player element (<code>#player</code>) and set its relative target to itself.</li>
</ol>

<pre class="example html"><code>
<span class="event-ancestor">&lt;div id="player"&gt; <em>7</em></span>
    <span class="shadow-boundary event-ancestor">&lt;shadow-boundary&gt; <em>6</em></span>
        <span class="event-ancestor">&lt;div class="controls"&gt; <em>5</em></span>
            &lt;button class="play-button"&gt;
            &lt;input type="range" class="timeline"&gt;
                <span class="shadow-boundary">&lt;shadow-boundary&gt;</span>
                    &lt;div class="slider-thumb"&gt;&lt;/div&gt;
                <span class="shadow-boundary">&lt;/shadow-boundary&gt;</span>
            &lt;/input&gt;
            <span class="event-ancestor">&lt;div class="volume-slider-container"&gt; <em>4</em></span>
                <span class="event-ancestor">&lt;input type="range" class="volume-slider"&gt; <em>3</em></span>
                    <span class="shadow-boundary event-ancestor">&lt;shadow-boundary&gt; <em>2</em></span>
                        <span class="event-ancestor">&lt;div class="slider-thumb"&gt;&lt;/div&gt; <em>1</em></span>
                    <span class="shadow-boundary">&lt;/shadow-boundary&gt;</span>
                &lt;/input&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    <span class="shadow-boundary">&lt;/shadow-boundary&gt;</span>
&lt;/div&gt;
</code></pre>

<p>
At the end of this process, we should have the following set of ancestors and relative targets:
</p>
<table>
<thead>
<tr>
    <th>Ancestor</th>
    <th>Relative Target</th>
</tr>
</thead>
<tbody>
<tr>
    <td><code>...</code></td>
    <td><code>div#player</code></td>
</tr>
<tr>
    <td><code>div#player</code></td>
    <td><code><strong>div#player</strong></code></td>
</tr>
<tr>
    <td><code>div#player .controls</code></td>
    <td><code>div#player .controls .volume-slider</code></td>
</tr>
<tr>
    <td><code>div#player .volume-slider-container</code></td>
    <td><code>div#player .controls .volume-slider</code></td>
</tr>
<tr>
    <td><code>div#player .controls .volume-slider</code></td>
    <td><code><strong>div#player .controls .volume-slider</strong></code></td>
</tr>
<tr>
    <td><code>div#player .controls .volume-slider .slider-thumb</code></td>
    <td><code><strong>div#player .controls .volume-slider .slider-thumb</strong></code></td>
</tr>
</tbody>
</table>

<p>After we dispatch the <code>mouseover</code> event using these newly computed relative targets, the user decides to move their pointing device over the thumb of the timeline
(<code>#player .timeline .slider-thumb</code>). This triggers both a <code>mouseout</code> event for the volume slider thumb and the <code>mouseover</code> event for the timeline thumb.</p>

<p>Let's study how the <code>relatedTarget</code> value of the volume thumb's <code>mouseout</code> event is affected and whether event crosses the <a href="#dfn-shadow-boundary">shadow boundary</a>. For this event, the <code>relatedTarget</code> is the timeline thumb (<code>#player .timeline .slider-thumb</code>).</p>

<ol>
    <li>We find lowest common ancestor of timeline thumb and volume slider thumb: the controls panel (<code>#player .controls</code>).</li>
    <li>Walking up, we look for a <a href="#dfn-shadow-boundary">shadow boundary</a>, and find one just above. This is the lowest common boundary.</li>
    <li>Given that the lowest common boundary exists, we limit event dispatch to the descendants of this boundary.</li>
    <li>Starting from the lowest common boundary, we walk down the ancestors of the timeline thumb, looking for a <a href="#dfn-shadow-boundary">shadow boundary</a>. We find it just below the timeline (<code>#player .timeline</code>). This is the first divergent boundary.</li>
    <li>We adjust <code>relatedTarget</code> to be the parent of the first divergent boundary, the timeline (<code>#player .timeline</code>). We are now ready to dispatch this event.</li>
</ol>

<pre class="example html"><code>
&lt;div id="player"&gt;
    <span class="shadow-boundary lowest-common-boundary">&lt;shadow-boundary&gt;<em> — lowest common boundary</em></span>
        &lt;div class="controls"&gt;
            &lt;button class="play-button"&gt;
            &lt;input type="range" class="timeline"&gt;
                <span class="shadow-boundary first-divergent-boundary">&lt;shadow-boundary&gt;<em>  — first divergent boundary</em></span>
                    &lt;div class="slider-thumb"&gt;&lt;/div&gt;
                <span class="shadow-boundary first-divergent-boundary">&lt;/shadow-boundary&gt;</span>
            &lt;/input&gt;
            &lt;div class="volume-slider-container"&gt;
                &lt;input type="range" class="volume-slider"&gt;
                    <span class="shadow-boundary">&lt;shadow-boundary&gt;</span>
                        &lt;div class="slider-thumb"&gt;&lt;/div&gt;
                    <span class="shadow-boundary">&lt;/shadow-boundary&gt;</span>
                &lt;/input&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    <span class="shadow-boundary lowest-common-boundary">&lt;/shadow-boundary&gt;</span>
&lt;/div&gt;
</code></pre>

<h2 id="styles"><span class="section">7</span> Styles</h2>

<p>To enforce <a href="#dfn-upper-boundary-encapsulation">upper-boundary encapsulation</a>, <a href="http://www.w3.org/TR/CSS2/syndata.html#rule-sets">CSS rules</a> declared by the document <strong>must not</strong> apply in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, unless the <dfn id="dfn-apply-author-styles">apply-author-styles</dfn> flag is set for this subtree. The flag signals that document CSS rules are applicable in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.

</p><p>Conversely, to enforce <a href="#dfn-lower-boundary-encapsulation">lower-boundary encapsulation</a>, <a href="http://www.w3.org/TR/CSS2/syndata.html#rule-sets">CSS rules</a> declared in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> <strong>must not</strong> apply in the document tree.</p>

<p>The <dfn id="dfn-rule-applicability-algorithm">rule applicability algorithm</dfn> is used to determine whether any given rule is applicable to any DOM tree, and it <strong>must</strong> be equivalent to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
<dd><var>RULE</var>, a CSS rule whose applicability is being determined</dd>
<dd><var>TREE</var>, the document tree or <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a></dd>
<dt>Output</dt>
<dd>Whether <var>RULE</var> is applicable in <var>TREE</var>.</dd>
</dl>
<ol>
    <li>If <var>RULE</var> is not an <a href="http://www.w3.org/TR/CSS2/cascade.html">author style</a>, the rule <strong>is</strong> applicable in <var>TREE</var>.</li>
    <li>Otherwise, if <var>TREE</var> is a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>:
    <ol>
        <li>If <var>TREE</var> has <a href="#dfn-apply-author-styles">apply-author-styles</a> flag set and <var>RULE</var> is declared in the document tree, <var>RULE</var> <strong>is</strong> applicable in <var>TREE</var>.</li>
        <li>Otherwise, if <var>RULE</var> is declared with a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-style-element"><code>style</code></a> element:
        <ol>
            <li>Let <var>STYLE</var> be this style element</li>
            <li>If <var>STYLE</var> is in <var>TREE</var>, then <var>RULE</var> <strong>is</strong> applicable in <var>TREE</var>.</li>
            <li>If <var>TREE</var> has <a href="#dfn-apply-author-styles">apply-author-styles</a> flag set and <var>RULE</var> is declared in an <a href="#dfn-enclosed-subtree">enclosing</a> <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>
            <ol>
                <li>Let <var>TOP</var> be this tree</li>
                <li>If each <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> that both <a href="#dfn-enclosed-subtree">encloses</a> <var>TREE</var> and is <a href="#dfn-enclosed-subtree">enclosed</a> by <var>TOP</var> has <a href="#dfn-apply-author-styles">apply-author-styles</a> set, the <var>RULE</var> <strong>is</strong> applicable in <var>TREE</var>.</li>
            </ol></li>
        </ol></li>
        <li>Otherwise, <var>RULE</var> <strong>is not</strong> applicable in <var>TREE</var>.</li>
    </ol></li>
    <li>Otherwise, if <var>TREE</var> is a document tree and <var>RULE</var> is declared in <var>TREE</var>, the rule <strong>is</strong> applicable in <var>TREE</var>.</li>
    <li>Otherwise, <var>RULE</var> <strong>is not</strong> applicable in <var>TREE</var>.</li>
</ol>
</div>

<p>In a document that contains <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>, the CSS properties <strong>must</strong> be inherited from parent nodes, produced using <a href="#dfn-parent-calculation-algorithm">parent calculation algorithm</a>. This requirement has the following effects:</p>
<ul>
    <li>the styles of the <a href="#dfn-shadow-host">shadow host</a> are inherited by the children of the <a href="#dfn-shadow-root">shadow root</a></li>
    <li>the styles of the <a href="#dfn-insertion-point">insertion point</a> node are inherited by those child nodes of the <a href="#dfn-shadow-host">shadow host</a> that are <a href="#dfn-assign-older-tree">assigned</a> to this <a href="#dfn-insertion-point">insertion point</a></li>
    <li>the styles of the <a href="#dfn-shadow-insertion-point">shadow insertion point</a> node are inherited by the child nodes of the <a href="#dfn-shadow-root">shadow root</a> of the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, distributed to this <a href="#dfn-shadow-insertion-point">shadow insertion point</a></li>
</ul>

<p>If the <dfn id="dfn-reset-style-inheritance">reset-style-inheritance</dfn> flag is set for a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, all <a href="http://www.w3.org/TR/2005/WD-css3-cascade-20051215/#inheritance">inheritable</a> CSS properties <strong>must</strong> behave as if they were explicitly set to the <a href="http://www.w3.org/TR/2005/WD-css3-cascade-20051215/#initial0">initial value</a> at the upper boundary of the subtree.</p>

<h3 id="css-variables"><span class="section">7.1</span> CSS Variables</h3>

<p>The <a href="#dfn-shadow-host">shadow host</a> styles being inherited by the children of the <a href="#dfn-shadow-root">shadow root</a> must also apply to <a href="http://dev.w3.org/csswg/css-variables/">CSS Variables</a>. This provides a way for document DOM tree styles to send signals into the <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>, and for the <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a> to receive these signals with the use of the <a href="http://dev.w3.org/csswg/css-variables/#using-variables"><code>var()</code></a> function.</p>

<h3 id="text-decoration-property"><span class="section">7.2</span> <code>text-decoration</code> Property</h3>

<p>The text decorations, specified by the <a href="http://www.w3.org/TR/CSS2/text.html#lining-striking-props"><code>text-decoration</code></a> property <strong>must not</strong> be propagated from <a href="#dfn-shadow-host">shadow hosts</a> to <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>.</p>

<section class="mechanics">

<h2 id="user-interaction"><span class="section">8</span> User Interaction</h2>

<h3 id="ranges-and-selection"><span class="section">8.1</span> Ranges and Selections</h3>

<p>Since a DOM node in a document tree and a DOM node in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> never have the same <a href="http://www.w3.org/TR/domcore/#concept-tree-root">root</a>, there may never exist a valid <a href="http://www.w3.org/TR/domcore/#range">DOM range</a> that spans either both a document tree and a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, or multiple <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>.</p>

<p>Accordingly, <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selections</a> may only exist within one tree, because they are defined by a single <a href="http://www.w3.org/TR/domcore/#range">range</a>. To maintain <a href="#dfn-upper-boundary-encapsulation">upper boundary encapsulation</a>, the selection, returned by the <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#dom-window-getselection"><code>window.getSelection()</code></a> method <strong>must</strong> never return a selection within a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</p>

<p>The <code>getSelection()</code> method of the <a href="#dfn-shadow-root">shadow root</a> object <strong>must</strong> return the current <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selection</a> in this <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</p>

<h3 id="focus-navigation"><span class="section">8.2</span> Focus Navigation</h3>

<p><a href="#dfn-shadow-dom-subtree">Shadow DOM subtrees</a> participate in <a href="http://www.w3.org/TR/css3-ui/#keyboard">sequential</a> or <a href="http://www.w3.org/TR/css3-ui/#keyboard">directional</a> focus navigation as part of the document tree. The <a href="http://www.w3.org/TR/css3-ui/#keyboard">navigation order</a> within the <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a> must be determined using the <a href="#dfn-as-rendered">as-rendered</a> structure and is called <dfn id="dfn-shadow-dom-navigation-order">shadow DOM navigation order</dfn>.</p>

<p>For <a href="http://www.w3.org/TR/css3-ui/#keyboard">sequential focus navigation</a>, the <a href="#dfn-shadow-dom-navigation-order">shadow DOM navigation order</a> sequence must be inserted into the document <a href="http://www.w3.org/TR/css3-ui/#keyboard">navigation order</a>:</p>
<ol>
    <li>immediately after the <a href="#dfn-shadow-host">shadow host</a>, if the shadow host is <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#focusable">focusable</a>; or</li>
    <li>in place of the <a href="#dfn-shadow-host">shadow host</a> as if the shadow host were assigned the value of <a href="http://www.w3.org/TR/css3-ui/#keyboard"><code>auto</code></a> for determining its position.</li>
</ol>

<p>For <a href="http://www.w3.org/TR/css3-ui/#keyboard">directional focus navigation</a>, it is up to the user agent to integrate the <a href="#dfn-shadow-dom-navigation-order">shadow DOM navigation order</a> into the document <a href="http://www.w3.org/TR/css3-ui/#keyboard">navigation order</a>.</p>

<h3 id="active-element"><span class="section">8.3</span> Active Element</h3>

<p>To maintain <a href="#dfn-upper-boundary-encapsulation">upper-boundary encapsulation</a>, the value of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document">Document</a> object's focus API property <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement">activeElement</a> <strong>must</strong> be adjusted. To prevent loss of information when adjusting this value, each <a href="#dfn-shadow-root">shadow root</a> <strong>must</strong> also have an <code>activeElement</code> property to store the value of the focused element in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</p>

<p>The <dfn id="active-element-adjustment-algorithm">active element adjustment algorithm</dfn> is used to determine the values of the respective <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement">activeElement</a> properties, and it <strong>must</strong> be equivalent to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>ELEMENT</var>, the focused element</dd>
<dt>Output</dt>
    <dd>Adjusted values of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement">activeElement</a> properties.</dd>
</dl>
<ol>
    <li>Run the <a href="#dfn-retargeting-algorithm">retargeting algorithm</a> with <var>ELEMENT</var> as input</li>
    <li>For each <var>TUPLE</var> in the resulting list of tuples:
    <ol>
        <li>Let <var>ADJUSTED</var> be the first value of the <var>TUPLE</var></li>
        <li>Let <var>NODE</var> be the second value of the <var>TUPLE</var></li>
        <li>If <var>NODE</var> is a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document">Document</a> or a <a href="#dfn-shadow-root">shadow root</a>, set the value of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement">activeElement</a> to <var>ADJUSTED</var>.</li>
    </ol>
    </li>
</ol>
</div>

<h3 id="editing"><span class="section">8.4</span> Editing</h3>

<p>The value of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#attr-contenteditable"><code>contenteditable</code></a> attribute must not propagate from <a href="#dfn-shadow-host">shadow host</a> to its <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>.</p>

<h3 id="assistive-technology"><span class="section">8.5</span> Assistive Technology</h3>

<p>User agents with assistive technology traverse the document tree <a href="#dfn-as-rendered">as rendered</a>, and thus enable full use of of <a href="http://www.w3.org/WAI/PF/aria/">WAI-ARIA</a> semantics in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>.</p>

<h2 id="html-elements"><span class="section">9</span> HTML Elements in Shadow DOM Subtrees</h2>

<p>Comparatively, a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> can be seen as somewhere between <em>just a DOM subtree in a document</em> and a <a href="http://www.w3.org/TR/domcore/#interface-documentfragment">document fragment</a>. Since it is rendered, a shadow DOM subtree aims to retain the traits of a typical DOM subtree in a document. At the same time, it is an encapsulation abstraction, so it has to avoid affecting the document DOM tree. Thus, the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> <strong>must</strong> behave <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/">as specified</a> in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>, with a few exceptions.</p>

<h3 id="inert-html-elements"><span class="section">9.1</span> Inert HTML Elements</h3>

<p>A subset of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> <strong>must</strong> behave as <dfn id="dfn-inert">inert</dfn>, or not part of the document tree. This is consistent how the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> would behave in a <a href="http://www.w3.org/TR/domcore/#interface-documentfragment">document fragment</a>. These elements are:</p>
<ul>
    <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-base-element"><code>base</code></a></li>
    <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-link-element"><code>link</code></a></li>
</ul>

<p>All other <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a> <strong>must</strong> behave as if they were part of the document tree, though <a href="#dfn-scoping-constraints">scoped</a> to their subtrees.</p>

<h3 id="html-forms"><span class="section">9.2</span> HTML Forms</h3>

<p>The <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#forms">forms</a> in HTML are scoped at the document level. That is, all <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#the-form-element"><code>form</code></a> elements and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#form-associated-element">form-associated elements</a> are accessible using the document <a href="http://www.w3.org/TR/domcore/#interface-document">DOM object</a>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-tree-accessors">tree accessors</a>. Per <a href="#dfn-scoping-constraints">scoping constraints</a>, this <strong>must</strong> exclude elements in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>.</p>

<p>Instead, each <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> <strong>must</strong> scope its <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#the-form-element"><code>form</code></a> elements and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#form-associated-element">form-associated elements</a>. Because the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#the-form-element"><code>form</code></a>'s <a href="http://www.w3.org/TR/domcore/#dom-node-ownerdocument"><code>ownerDocument</code></a> is the <a href="#dfn-shadow-host">shadow host</a>'s document, the form submission <strong>must</strong> continue to work <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/association-of-controls-and-forms.html#form-submission">as specified</a>.</p>

<h2 id="html-elements-and-their-shadow-dom-subtrees"><span class="section">10</span> HTML Elements and Their Shadow DOM Subtrees</h2>

<p>Per <a href="http://www.whatwg.org/specs/web-apps/current-work/">specification</a>, some <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> are designed to either not render their contents or have special requirements in regard to contents rendering. In order to reconcile these differences in rendering behavior with the shadow DOM <a href="#dfn-tree-composition">tree composition</a>, all <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> <strong>must</strong> have an <a href="#dfn-processing-equivalence">equivalent</a> of a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> that is created and populated at the time of element instantiation. It is up to a user agent to define the content of these subtrees. However, all conforming user agents <strong>must</strong> satisfy the following requirements:</p>

<table>
<thead>
    <tr>
        <th style="width: 30%">HTML Element</th>
        <th>Shadow DOM Subtree Requirements</th>
    </tr>
</thead>
<tbody>
    <tr>
        <td><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/embedded-content-1.html#the-img-element"><code>img</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-iframe-element"><code>iframe</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-embed-element"><code>embed</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-object-element"><code>object</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-video-element.html#the-video-element"><code>video</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-video-element.html#the-audio-element"><code>audio</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-canvas-element.html#the-canvas-element"><code>canvas</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-map-element.html#the-map-element"><code>map</code></a>. <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-input-element.html#the-input-element"><code>input</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-textarea-element"><code>textarea</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-progress-element"><code>progress</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-meter-element"><code>meter</code></a></td>
        <td>Contains no <a href="#dfn-insertion-point">insertion points</a></td>
    </tr>
    <tr>
        <td><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#the-fieldset-element"><code>fieldset</code></a></td>
        <td>Contains two <a href="#dfn-insertion-point">insertion points</a> with the following <a href="#dfn-matching-criteria">matching criteria</a>:
        <ol>
            <li><code>legend:first-of-type</code></li>
            <li><a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a></li>
        </ol>
        </td>
    </tr>
    <tr>
        <td><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/interactive-elements.html#the-details-element"><code>details</code></a></td>
        <td>Contains two <a href="#dfn-insertion-point">insertion points</a> with the following <a href="#dfn-matching-criteria">matching criteria</a>:
        <ol>
            <li><code>summary:first-of-type</code></li>
            <li><a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a></li>
        </ol>
        </td>
    </tr>
    <tr>
        <td>All other elements</td>
        <td>Contains one <a href="#dfn-insertion-point">insertion point</a> with the <a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a> as the <a href="#dfn-matching-criteria">matching criteria</a></td>
    </tr>
</tbody>
</table>

<h2 id="elements-and-dom-objects"><span class="section">11</span> Elements and DOM Objects</h2>

<h3 id="shadow-root-object"><span class="section">11.1</span> <code>ShadowRoot</code> Object</h3>

<p>The <code>ShadowRoot</code> object represents the <a href="#dfn-shadow-root">shadow root</a>.</p>

<pre><code>
[Constructor(in <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#htmlelement">HTMLElement</a> host) raises (DOMException)]
interface <dfn id="api-shadow-root">ShadowRoot</dfn> : <a href="http://www.w3.org/TR/domcore/#interface-documentfragment">DocumentFragment</a> {
    <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#htmlelement">HTMLElement</a> <a href="#api-shadow-root-get-element-by-id">getElementById</a>(in DOMString elementId);
    <a href="http://www.w3.org/TR/domcore/#nodelist">NodeList</a> <a href="#api-shadow-root-get-elements-by-class-name">getElementsByClassName</a>(in DOMString tagName);
    <a href="http://www.w3.org/TR/domcore/#nodelist">NodeList</a> <a href="#api-shadow-root-get-elements-by-tag-name">getElementsByTagName</a>(in DOMString className);
    <a href="http://www.w3.org/TR/domcore/#nodelist">NodeList</a> <a href="#api-shadow-root-get-elements-by-tag-name-ns">getElementsByTagNameNS</a>(DOMString namespace, DOMString localName);
    <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#selection">Selection</a> <a href="#api-shadow-root-selection">getSelection</a>();
    attribute bool <a href="#api-shadow-root-apply-author-styles">applyAuthorStyles</a>;
    attribute bool <a href="#api-shadow-root-reset-style-inheritance">resetStyleInheritance</a>;
    readonly attribute Element <a href="#api-shadow-root-active-element">activeElement</a>;
    attribute DOMString <a href="#api-shadow-root-inner-html">innerHTML</a>;
}
ShadowRoot implements <a href="http://dev.w3.org/2006/webapi/selectors-api/#nodeselector">NodeSelector</a>;
</code></pre>

<h4 id="shadow-root-attributes"><span class="section">11.1.1</span> <code>ShadowRoot</code> Attributes</h4>

<dl>
<dt id="api-shadow-root-apply-author-styles"><code>applyAuthorStyles</code> of type <code>bool</code></dt>
<dd>Represents the <a href="#dfn-apply-author-styles">apply-author-styles</a> flag and indicates whether or not the rules in <a href="http://www.w3.org/TR/CSS2/cascade.html">author styles</a> associated with the element's document apply to the shadow DOM subtree. If <code>false</code> (default value), the author styles <strong>are not</strong> applied to the shadow DOM subtree. If <code>true</code>, the author styles <strong>are</strong> applied.</dd>
<dd>On getting, the attribute <strong>must</strong> return the current value of the <a href="#dfn-apply-author-styles">apply-author-styles</a> flag for the <a href="#dfn-shadow-host">shadow host</a>'s subtree.</dd>
<dd>On setting, the attribute <strong>must</strong> set the value of the <a href="#dfn-apply-author-styles">apply-author-styles</a> flag for the <a href="#dfn-shadow-host">shadow host</a>'s subtree to specified value.</dd>
<dt id="api-shadow-root-reset-style-inheritance"><code>resetStyleInheritance</code> of type <code>bool</code></dt>
<dd>Represents the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag and indicates whether or not the inheritable CSS properties are set to the initial value at the shadow boundary. If <code>false</code> (default value), the properties continue to inherit. If <code>true</code>, the properties are set to initial value.</dd>
<dd>On getting, the attribute <strong>must</strong> return the current value of the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag for the <a href="#dfn-shadow-host">shadow host</a>'s subtree.</dd>
<dd>On setting, the attribute <strong>must</strong> set the value of the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag for the <a href="#dfn-shadow-host">shadow host</a>'s subtree to specified value.</dd>
<dt id="api-shadow-root-active-element"><code>activeElement</code> of type <code>Element</code>, readonly</dt>
<dd>Represents the currently focused element in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</dd>
<dd>On getting, the attribute <strong>must</strong> return the currently focused element in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> or <code>null</code>, if there is none.</dd>
<dt id="api-shadow-root-inner-html"><code>innerHTML</code> of type <code>DOMString</code></dt>
<dd>represents the markup of <a href="#api-shadow-root"><code>ShadowRoot</code></a>'s contents.</dd>
<dd>On getting, the atribute <strong>must</strong> return the result of runnig the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-end.html#html-fragment-serialization-algorithm">HTML fragment serialization algorithm</a> with the <a href="http://html5.org/specs/dom-parsing.html#context-object">context object</a> as <a href="#dfn-shadow-host"><code>shadow host</code></a>.</dd>
</dl>

<p>The <a href="http://www.w3.org/TR/domcore/#dom-node-nodetype"><code>nodeType</code></a> attribute of a <a href="#api-shadow-root"><code>ShadowRoot</code></a> instance <strong>must</strong> return <a href="http://www.w3.org/TR/domcore/#dom-node-document_fragment_node"><code>DOCUMENT_FRAGMENT_NODE</code></a>. Accordingly, the <a href="http://www.w3.org/TR/domcore/#dom-node-nodename"><code>nodeName</code></a> attribute of a <a href="#api-shadow-root"><code>ShadowRoot</code></a> instance must return <code>"#document-fragment"</code>.</p>

<h4 id="shadow-root-methods"><span class="section">11.1.2</span> <code>ShadowRoot</code> Methods</h4>

<dl>
<dt><code>constructor</code></dt>
<dd>
    <table>
        <thead>
            <tr>
                <th>Parameter</th>
                <th>Type</th>
                <th>Nullable</th>
                <th>Optional</th>
                <th>Description</th>
            </tr>
        </thead>
            <tbody><tr>
                <td><dfn id="api-shadow-root-constructor-element"><code>element</code></dfn></td>
                <td><a href="http://www.w3.org/TR/domcore/#element"><code>Element</code></a></td>
                <td>No</td>
                <td>No</td>
                <td>Element that will be the <a href="#dfn-shadow-host">shadow host</a> of the newly created <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</td>
            </tr>
        </tbody><tbody>
        </tbody>
    </table>
    <div>
        <em>Exceptions:</em>
        <dl>
            <dt><a href="http://www.w3.org/TR/domcore/#dom-domexception-hierarchy_request_err"><code>HIERARCHY_REQUEST_ERR</code></a></dt>
            <dd>This exception <strong>must</strong> be thrown when the <code>element</code> parameter is not a valid <a href="http://www.w3.org/TR/domcore/#element"><code>Element</code></a>.
        </dd></dl>
    </div>
    <p>When invoked, the <code>ShadowRoot()</code> constructor <strong>must</strong> run these steps:</p>
    <ol>
        <li>Create a new instance of the <code>ShadowRoot</code> object</li>
        <li>Establish element, supplied as <code>element</code> argument as the <a href="#dfn-shadow-host">shadow host</a> for the <code>ShadowRoot</code> object</li>
        <li>Return <code>ShadowRoot</code> object</li>
    </ol>
</dd>
<dt id="api-shadow-root-get-element-by-id"><code>getElementById</code></dt>
<dd><strong>Must</strong> behave exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementbyid">document.getElementById</a>, except <a href="#dfn-scoping-constraints">scoped</a> to the shadow DOM subtree.</dd>
<dt id="api-shadow-root-get-elements-by-class-name"><code>getElementsByClassName</code></dt>
<dd><strong>Must</strong> behave exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementsbyclassname">document.getElementsByClassName</a>, except <a href="#dfn-scoping-constraints">scoped</a> to the shadow DOM subtree.</dd>
<dt id="api-shadow-root-get-elements-by-tag-name"><code>getElementsByTagName</code></dt>
<dd><strong>Must</strong> behave exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementsbytagname">document.getElementsByTagName</a>, except <a href="#dfn-scoping-constraints">scoped</a> to the shadow DOM subtree.</dd>
<dt id="api-shadow-root-get-elements-by-tag-name-ns"><code>getElementsByTagNameNS</code></dt>
<dd><strong>Must</strong> behave exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementsbytagnamens">document.getElementsByTagNameNS</a>, except <a href="#dfn-scoping-constraints">scoped</a> to the shadow DOM subtree.</dd>
<dt id="api-shadow-root-selection"><code>getSelection</code></dt><dt>
</dt><dd>Returns the current selection in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</dd>
<dd>When invoked, it <strong>must</strong> return <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selection</a> in <a href="#dfn-shadow-host">shadow host</a>'s subtree.</dd>
</dl>

<p>Invoking the <a href="http://www.w3.org/TR/domcore/#dom-node-clonenode"><code>cloneNode()</code></a> method on a <a href="#api-shadow-root"><code>ShadowRoot</code></a> instance <strong>must</strong> always throw a <a href="http://www.w3.org/TR/domcore/#dom-domexception-data_clone_err"><code>DATA_CLONE_ERR</code></a> exception.</p>


<h3 id="content-element"><span class="section">11.2</span> The <code>content</code> HTML element</h3>

<p>The <dfn id="dfn-content-element"><code>content</code></dfn> HTML element represents an <a href="#dfn-insertion-point">insertion point</a> in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</p>

<dl>
<dt>Context</dt>
<dd>Where <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#flow-content-0">flow content</a> is expected.</dd>
<dt>Content model</dt>
<dd><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#transparent">Transparent</a></dd>
<dt>Children</dt>
<dd>Anything as <a href="#dfn-fallback-content">fallback content</a></dd>
<dt>Content attributes</dt>
<dd><a href="http://dev.w3.org/html5/spec/Overview.html#global-attributes">Global attributes</a></dd>
<dd>
    <dl>
<!--    <dt id="markup-content-apply-shadow-styles"><code>apply-shadow-styles</code>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#boolean-attribute">boolean attribute</a></dt>
    <dd>indicates whether or not the rules in the scoped styles, defined in shadow DOM subtree are applied to the <a href="#dfn-shadow-host">shadow host</a>'s children that are inserted in place of this <code>content</code> element. If present, the styles are applied.</dd> -->
    <dt id="markup-content-select"><code>select</code>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#comma-separated-tokens">set of comma-separated tokens</a></dt>
    <dd>
        defines the <a href="#dfn-matching-criteria">matching criteria</a> for distributing child nodes of the <a href="#dfn-shadow-host">shadow host</a>. Each token must be a valid <a href="#dfn-selector-fragment">selector fragment</a>. If any token is invalid, the entire value of the <code>select</code> attribute is considered invalid.
    </dd>
    </dl>
</dd>
<dt>DOM Interface</dt>
<dd>
    <pre><code>
interface <dfn id="api-html-content-element">HTMLContentElement</dfn> : <a href="http://dev.w3.org/html5/spec/Overview.html#htmlelement">HTMLElement</a> {<!--    attribute bool <a href="#api-html-content-element-apply-shadow-styles">applyShadowStyles</a>; -->
    attribute DOMString <a href="#api-html-content-element-select">select</a>;
}
    </code></pre>
    <dl>
    <dt>Attributes</dt>
    <dd>
    <dl>
<!--        <dt id="api-html-content-element-apply-shadow-styles"><code>applyShadowStyles</code> of type <code>bool</code></dt>
        <dd>Must <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the <a href="#markup-content-apply-shadow-styles">apply-shadow-styles</a> attribute.</dd> -->
        <dt id="api-html-content-element-select"><code>select</code> of type <code>DOMString</code></dt>
        <dd>Must <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the <a href="#markup-content-select">select</a> attribute.</dd>
    </dl>
    </dd>
    </dl>
</dd>
</dl>


<h3 id="shadow-element"><span class="section">11.3</span> The <code>shadow</code> HTML element</h3>

<p>The <dfn id="dfn-shadow-element"><code>shadow</code></dfn> HTML element represents an <a href="#dfn-shadow-insertion-point">shadow insertion point</a> in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</p>

<dl>
<dt>Context</dt>
<dd>Where <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#flow-content-0">flow content</a> is expected.</dd>
<dt>Content model</dt>
<dd><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#transparent">Transparent</a></dd>
<dt>Children</dt>
<dd>Anything as <a href="#dfn-fallback-content">fallback content</a></dd>
<dt>Content attributes</dt>
<dd><a href="http://dev.w3.org/html5/spec/Overview.html#global-attributes">Global attributes</a></dd>
<dt>DOM Interface</dt>
<dd>
    <pre><code>
interface <dfn id="api-html-shadow-element">HTMLShadowElement</dfn> : <a href="http://dev.w3.org/html5/spec/Overview.html#htmlelement">HTMLElement</a> {
}
    </code></pre>
</dd></dl>

</section>

<h2 id="shadow-dom-example"><span class="section">12</span> Shadow DOM Example</h2>

<p>Bob was asked to turn a simple list of links into a News Widget, which has links organized into two categories: breaking news and just news. The current document markup for the stories looks like this:</p>
<pre class="prettyprint"><code><span class="pln">
</span><span class="tag">&lt;ul</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"stories"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/1"</span><span class="tag">&gt;</span><span class="pln">A story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/2"</span><span class="tag">&gt;</span><span class="pln">Another story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/3"</span><span class="tag">&gt;</span><span class="pln">Also a story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/4"</span><span class="tag">&gt;</span><span class="pln">Yet another story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/4"</span><span class="tag">&gt;</span><span class="pln">Awesome story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/5"</span><span class="tag">&gt;</span><span class="pln">Horrible story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
</span><span class="tag">&lt;/ul&gt;</span></code></pre>

<p>To organize the stories, Bob decides to use <strong>shadow DOM</strong>. Doing so will allow Bob to keep the document markup uncluttered, and harnessing the power of insertion point makes sorting stories by class name a very simple task. After getting another cup of <a href="http://en.wikipedia.org/wiki/List_of_coffee_beverages#Green_Eye">Green Eye</a>, he quickly mocks up the following shadow DOM subtree, to be hosted by the <code>ul</code> element:</p>
<pre class="prettyprint"><code><span class="pln">
</span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;ul&gt;</span><span class="pln">
        </span><span class="tag">&lt;content</span><span class="pln"> </span><span class="atn">select</span><span class="pun">=</span><span class="atv">".breaking"</span><span class="tag">&gt;&lt;/content&gt;</span><span class="pln"> </span><span class="com">&lt;!-- insertion point for breaking news --&gt;</span><span class="pln">
    </span><span class="tag">&lt;/ul&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span><span class="pln">
</span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"other"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;ul&gt;</span><span class="pln">
        </span><span class="tag">&lt;content&gt;&lt;/content&gt;</span><span class="pln"> </span><span class="com">&lt;!-- insertion point for the rest of the news --&gt;</span><span class="pln">
    </span><span class="tag">&lt;/ul&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span></code></pre>
<p>Bob then styles the newborn widget according to comps from the designer by adding this to the shadow DOM subtree mockup:</p>
<pre class="prettyprint"><code><span class="pln">
</span><span class="tag">&lt;style</span><span class="pln"> </span><span class="atn">scoped</span><span class="tag">&gt;</span><span class="pln">
    div</span><span class="pun">.</span><span class="pln">breaking </span><span class="pun">{</span><span class="pln">
        color</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Red</span><span class="pun">;</span><span class="pln">
        font</span><span class="pun">-</span><span class="pln">size</span><span class="pun">:</span><span class="pln"> </span><span class="lit">20px</span><span class="pun">;</span><span class="pln">
        border</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1px</span><span class="pln"> dashed </span><span class="typ">Purple</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
    div</span><span class="pun">.</span><span class="pln">other </span><span class="pun">{</span><span class="pln">
        padding</span><span class="pun">:</span><span class="pln"> </span><span class="lit">2px</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln">
        border</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1px</span><span class="pln"> solid </span><span class="typ">Cyan</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
</span><span class="tag">&lt;/style&gt;</span></code></pre>
<p>While pondering if his company should start looking for a new designer, Bob converts the mockup to code:</p>
<pre class="prettyprint"><code><span class="pln">
</span><span class="kwd">function</span><span class="pln"> createStoryGroup</span><span class="pun">(</span><span class="pln">className</span><span class="pun">,</span><span class="pln"> contentSelector</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> </span><span class="kwd">group</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'div'</span><span class="pun">);</span><span class="pln">
    </span><span class="kwd">group</span><span class="pun">.</span><span class="pln">className </span><span class="pun">=</span><span class="pln"> className</span><span class="pun">;</span><span class="pln">
    </span><span class="com">// Empty string in select attribute or absence thereof work the same, so no need for special handling.</span><span class="pln">
    </span><span class="kwd">group</span><span class="pun">.</span><span class="pln">innerHTML </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;ul&gt;&lt;content select="'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> contentSelector </span><span class="pun">+</span><span class="pln"> </span><span class="str">'"&gt;&lt;/content&gt;&lt;/ul&gt;'</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">group</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> createStyle</span><span class="pun">()</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> style </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'style'</span><span class="pun">);</span><span class="pln">
    style</span><span class="pun">.</span><span class="pln">scoped </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span><span class="pln">
    style</span><span class="pun">.</span><span class="pln">textContent </span><span class="pun">=</span><span class="pln"> </span><span class="str">'div.breaking { color: Red;font-size: 20px; border: 1px dashed Purple; }'</span><span class="pln"> </span><span class="pun">+</span><span class="pln">
        </span><span class="str">'div.other { padding: 2px 0 0 0; border: 1px solid Cyan; }'</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> style</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> makeShadowSubtree</span><span class="pun">(</span><span class="pln">storyList</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> root </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ShadowRoot</span><span class="pun">(</span><span class="pln">storyList</span><span class="pun">);</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStyle</span><span class="pun">());</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStoryGroup</span><span class="pun">(</span><span class="str">'breaking'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'.breaking'</span><span class="pun">));</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStoryGroup</span><span class="pun">(</span><span class="str">'other'</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">));</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

document</span><span class="pun">.</span><span class="pln">addEventListener</span><span class="pun">(</span><span class="str">'DOMContentLoaded'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="pun">[].</span><span class="pln">forEach</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="pln">document</span><span class="pun">.</span><span class="pln">querySelectorAll</span><span class="pun">(</span><span class="str">'ul.stories'</span><span class="pun">),</span><span class="pln"> makeShadowSubtree</span><span class="pun">);</span><span class="pln">
</span><span class="pun">});</span></code></pre>

<p>Well done, Bob! With the cup of coffee still half-full, the work is complete. Recognizing his awesomeness, Bob returns to teaching n00bs the ways of <a href="http://en.wikipedia.org/wiki/World_of_Warcraft">WoW</a>.</p>

<p>A few months pass.</p>

<p>It's election time. With Bob at his annual conference, Alice is charged with adding <strong>another</strong>, temporary box to the news widget, filled with election-related stories. Alice studies Bob's code, reads up on the shadow DOM spec and realizes that, thanks to multiple shadow DOM subtree support, she doesn't have to touch his code. As usual, her solution is elegant and simple, fitting neatly right under Bob's code:</p>
<pre class="prettyprint"><code><span class="pln">
</span><span class="com">// TODO(alice): BEGIN -- DELETE THIS CODE AFTER ELECTIONS ARE OVER.</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> ELECTION_BOX_REMOVAL_DEADLINE </span><span class="pun">=</span><span class="pln"> </span><span class="pun">...;</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> createElectionStyle</span><span class="pun">()</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> style </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'style'</span><span class="pun">);</span><span class="pln">
    style</span><span class="pun">.</span><span class="pln">scoped </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span><span class="pln">
    </span><span class="com">// TODO(alice): Check designer's desk for hallucinogens.</span><span class="pln">
    style</span><span class="pun">.</span><span class="pln">textContent </span><span class="pun">=</span><span class="pln"> </span><span class="str">'div.election { color: Magenta;font-size: 24px; border: 2px dotted Fuchsia; }'</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> style</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> makeElectionShadowSubtree</span><span class="pun">(</span><span class="pln">storyList</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> root </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ShadowRoot</span><span class="pun">(</span><span class="pln">storyList</span><span class="pun">);</span><span class="pln">
    </span><span class="com">// Add and style election story box.</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createElectionStyle</span><span class="pun">());</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStoryGroup</span><span class="pun">(</span><span class="str">'election'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'.election'</span><span class="pun">));</span><span class="pln">
    </span><span class="com">// Insert Bob's shadow tree under the election story box.</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'shadow'</span><span class="pun">));</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Date</span><span class="pun">.</span><span class="pln">now</span><span class="pun">()</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> ELECTION_BOX_REMOVAL_DEADLINE</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    document</span><span class="pun">.</span><span class="pln">addEventListener</span><span class="pun">(</span><span class="str">'DOMContentLoaded'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="pun">[].</span><span class="pln">forEach</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="pln">document</span><span class="pun">.</span><span class="pln">querySelectorAll</span><span class="pun">(</span><span class="str">'ul.stories'</span><span class="pun">),</span><span class="pln"> makeElectionShadowSubtree</span><span class="pun">);</span><span class="pln">
    </span><span class="pun">});</span><span class="pln">
</span><span class="pun">}</span><span class="pln">
</span><span class="com">// TODO(alice): END -- DELETE THIS CODE AFTER ELECTIONS ARE OVER.</span></code></pre>
<p>Using the <code>shadow</code> element allows Alice to compose Bob's widget <strong>inside</strong> of hers—without having to change a line of production code. Smiling to herself, Alice realizes that Bob may have come up with a way to keep the document markup clean, but <strong>she</strong> is the one who takes the cake for using shadow DOM subtree composition in such a cool way.</p>

</section>


<h2 id="acknowledgements">Acknowledgements</h2>

<p><span class="vcard">David Hyatt</span> developed <a href="http://dev.w3.org/2006/xbl2/">XBL 1.0</a>, and <span class="vcard">Ian Hickson</span> co-wrote <a href="http://dev.w3.org/2006/xbl2/">XBL 2.0</a>. These documents provided tremendous insight into the problem of functional encapsulation and greatly influenced this specification.</p>

<p><span class="vcard">Alex Russell</span> and his considerable forethought triggered a new wave of enthusiasm around the subject of shadow DOM and how it can be applied practically on the Web.</p>

<p><span class="vcard">Dominic Cooney</span>, <span class="vcard">Hajime Morrita</span>, and <span class="vcard">Roland Steiner</span> worked tirelessly to scope the problem of functional encapsulation within the confines of the Web platform and provided a solid foundation for this document.</p>

<p>The editor would also like to thank <span class="vcard">Alex Komoroske</span>, <span class="vcard">Anne van Kesteren</span>, <span class="vcard">Brian Kardell</span>, <span class="vcard">Darin Fisher</span>, <span class="vcard">Deepak Sherveghar</span>, <span class="vcard">Edward O'Connor</span>, <span class="vcard">Elisée Maurer</span>, <span class="vcard">Erik Arvidsson</span>, <span class="vcard">Hayato Ito</span>, <span class="vcard">Jonas Sicking</span>, <span class="vcard">Malte Ubl</span>, <span class="vcard">Oliver Nightingale</span>, <span class="vcard">Olli Pettay</span>, <span class="vcard">Rafael Weinstein</span>, <span class="vcard">Sam Dutton</span>, <span class="vcard">Shinya Kawanaka</span>, and <span class="vcard">Tab Atkins</span> for their comments and contributions to this specification.</p>

<p>This list is too short. There's a lot of work left to do. Please contribute by reviewing and filing bugs—and don't forget to ask the editor to add your name into this section.</p>



</body></html>
<!DOCTYPE html>
<html lang="en"><head>
<title>Shadow DOM</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<link rel="stylesheet" href="spec.css" type="text/css">
<link rel="stylesheet" href="prettify.css" type="text/css">
<link rel="stylesheet" href="http://www.w3.org/StyleSheets/TR/W3C-WD" type="text/css">
</head>

<body>

<div class="head">

<div class="logo">
    <a href="http://www.w3.org/"><img width="72" height="48" src="http://www.w3.org/Icons/w3c_home" alt="W3C"></a>
</div>

<h1>Shadow DOM</h1>
<h2 id="working-draft">W3C Working Draft 16 October 2012</h2>
<dl>
<dt>This version</dt>
    <dd><a href="http://www.w3.org/TR/2012/WD-shadow-dom-20121016/">http://www.w3.org/TR/2012/WD-shadow-dom-20121016/</a></dd>
<dt>Latest version</dt>
    <dd><a href="http://www.w3.org/TR/shadow-dom/">http://www.w3.org/TR/shadow-dom/</a></dd>
<dt>Latest editor's draft</dt>
    <dd><a href="http://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/shadow/index.html">http://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/shadow/index.html</a></dd>
<dt>Previous version</dt>
    <dd><a href="http://www.w3.org/TR/2012/WD-shadow-dom-20120522/">http://www.w3.org/TR/2012/WD-shadow-dom-20120522/</a></dd>
<dt>Revision history</dt>
    <dd><a href="http://dvcs.w3.org/hg/webcomponents/log/tip/spec/shadow/index.html">http://dvcs.w3.org/hg/webcomponents/log/tip/spec/shadow/index.html</a></dd>
<dt>Participate</dt>
    <dd>Discuss on <a href="http://lists.w3.org/Archives/Public/public-webapps/">public-webapps@w3.org</a> (<a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a>)</dd>
    <dd><a href="https://www.w3.org/Bugs/Public/enter_bug.cgi?comment=&amp;blocked=14978&amp;short_desc=%5BShadow%5D%3A%20&amp;product=WebAppsWG&amp;component=Component%20Model">File bugs</a> (w3.org's <a href="https://www.w3.org/Bugs/Public/">Bugzilla</a>)</dd>
<dt>Editor</dt>
    <dd class="vcard"><span class="fn">Dimitri Glazkov</span>, <span class="org">Google</span>, &lt;<a class="email" href="mailto:dglazkov@chromium.org">dglazkov@chromium.org</a>&gt;</dd>
</dl>

<p class="copyright"><a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © 2012 <a href="http://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>®</sup> (<a href="http://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>, <a href="http://www.ercim.eu/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>, <a href="http://www.keio.ac.jp/">Keio</a>), All Rights Reserved. W3C <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>, <a href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and <a href="http://www.w3.org/Consortium/Legal/copyright-documents">document use</a> rules apply.</p>

<hr>

<h2 id="abstract">Abstract</h2>

<p>This specification describes a method of establishing and maintaining functional boundaries between DOM subtrees and how these subtrees interact with each other within a document tree, thus enabling better functional encapsulation within DOM.</p>

<h2 id="status">Status of This Document</h2>

<p><em>This section describes the status of this document at the time of its publication. Other documents may supersede this document. A list of current <abbr title="World Wide Web Consortium">W3C</abbr> publications and the latest revision of this technical report can be found in the <a href="http://www.w3.org/TR/"><abbr title="World Wide Web Consortium">W3C</abbr> technical reports index</a> at http://www.w3.org/TR/.</em></p>

<p>This document was published by the <a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a> as a Working Draft. If you wish to make comments regarding this document, please send them to <a href="mailto:public-webapps@w3.org">public-webapps@w3.org</a> (<a href="mailto:public-webapps-request@w3.org?subject=subscribe">subscribe</a>, <a href="http://lists.w3.org/Archives/Public/public-webapps/">archives</a>). All feedback is welcome.</p><p>Publication as a Working Draft does not imply endorsement by the <abbr title="World Wide Web Consortium">W3C</abbr> Membership. This is a draft document and may be updated, replaced or obsoleted by other documents at any time. It is inappropriate to cite this document as other than work in progress.</p>

<p>This document was produced by a group operating under the <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004 <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>. <abbr title="World Wide Web Consortium">W3C</abbr> maintains a <a href="http://www.w3.org/2004/01/pp-impl/42538/status" rel="disclosure">public list of any patent disclosures</a> made in connection with the deliverables of the group; that page also includes instructions for disclosing a patent. An individual who has actual knowledge of a patent which the individual believes contains <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential Claim(s)</a> must disclose the information in accordance with <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section 6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>.</p>

</div>

<section class="toc">
<h2 id="toc">Table of Contents</h2>
<ol>
    <li><a href="#about"><span class="section">1</span> About this Document</a></li>
    <li><a href="#dependencies"><span class="section">2</span> Dependencies</a></li>
    <li><a href="#terminology"><span class="section">3</span> Terminology</a></li>
    <li><a href="#introduction"><span class="section">4</span> Introduction</a>
    <ol>
        <li><a href="#functional-encapsulation-example"><span class="section">4.1</span> Functional Encapsulation Example</a></li>
    </ol></li>
    <li><a href="#shadow-dom-subtrees"><span class="section">5</span> Shadow DOM Subtrees</a>
    <ol>
        <li><a href="#upper-boundary-encapsulation"><span class="section">5.1</span> Upper-boundary Encapsulation</a></li>
        <li><a href="#lower-boundary-encapsulation"><span class="section">5.2</span> Lower-boundary Encapsulation</a></li>
        <li><a href="#matching-insertion-points"><span class="section">5.3</span> Matching Insertion Points</a></li>
        <li><a href="#selecting-nodes-distributed-to-insertion-points"><span class="section">5.4</span> Matching Children, Distributed To Insertion Points</a></li>
        <li><a href="#multiple-shadow-subtrees"><span class="section">5.5</span> Hosting Multiple Shadow Subtrees</a></li>
        <li><a href="#nested-shadow-subtrees"><span class="section">5.6</span> Nested Shadow Subtrees</a></li>
        <li><a href="#rendering-shadow-subtrees"><span class="section">5.7</span> Rendering Shadow Subtrees</a></li>
    </ol></li>
    <li><a href="#events"><span class="section">6</span> Events</a>
    <ol>
        <li><a href="#event-retargeting"><span class="section">6.1</span> Event Retargeting</a></li>
        <li><a href="#retargeting-related-target"><span class="section">6.2</span> Retargeting <code>relatedTarget</code></a></li>
        <li><a href="#retargeting-focus-events"><span class="section">6.3</span> Retargeting Focus Events</a></li>
        <li><a href="#events-that-are-always-stopped"><span class="section">6.4</span> Events that are Always Stopped</a></li>
        <li><a href="#event-dispatch"><span class="section">6.5</span> Event Dispatch</a></li>
        <li><a href="#event-retargeting-example"><span class="section">6.6</span> Event Retargeting Example</a></li>
    </ol></li>
    <li><a href="#styles"><span class="section">7</span> Styles</a>
    <ol>
        <li><a href="#css-variables"><span class="section">7.1</span> CSS Variables</a></li>
        <li><a href="#text-decoration-property"><span class="section">7.2</span> <code>text-decoration</code> Property</a></li>
        <li><a href="#host-at-rule"><span class="section">7.3</span> <code>@host</code> @-rule</a></li>
    </ol></li>
    <li><a href="#user-interaction"><span class="section">8</span> User Interaction</a>
    <ol>
        <li><a href="#ranges-and-selection"><span class="section">8.1</span> Ranges and Selections</a></li>
        <li><a href="#focus-navigation"><span class="section">8.2</span> Focus Navigation</a></li>
        <li><a href="#active-element"><span class="section">8.3</span> Active Element</a></li>
        <li><a href="#editing"><span class="section">8.4</span> Editing</a></li>
        <li><a href="#assistive-technology"><span class="section">8.5</span> Assistive Technology</a></li>
    </ol>
    </li>
    <li><a href="#html-elements"><span class="section">9</span> HTML Elements in Shadow DOM Subtrees</a>
    <ol>
        <li><a href="#inert-html-elements"><span class="section">9.1</span> Inert HTML Elements</a></li>
        <li><a href="#html-forms"><span class="section">9.2</span> HTML Forms</a></li>
    </ol></li>
    <li><a href="#html-elements-and-their-shadow-dom-subtrees"><span class="section">10</span> HTML Elements and Their Shadow DOM subtrees</a>
    </li><li><a href="#elements-and-dom-objects"><span class="section">11</span> Elements and DOM Objects</a>
    <ol>
        <li><a href="#shadow-root-object"><span class="section">11.1</span> <code>ShadowRoot</code> Object</a>
        <ol>
            <li><a href="#shadow-root-attributes"><span class="section">11.1.1</span> <code>ShadowRoot</code> Attributes</a></li>
            <li><a href="#shadow-root-methods"><span class="section">11.1.2</span> <code>ShadowRoot</code> Methods</a></li>
        </ol></li>
        <li><a href="#content-element"><span class="section">11.2</span> The <code>content</code> HTML element</a></li>
        <li><a href="#shadow-element"><span class="section">11.3</span> The <code>shadow</code> HTML element</a></li>
    </ol></li>
    <li><a href="#shadow-dom-example"><span class="section">12</span> Shadow DOM Example</a></li>
    <li><a href="#acknowledgements">Acknowledgements</a></li>
</ol>

</section>

<section class="math">

<h2 id="about"><span class="section">1</span> About this Document</h2>

<p>All diagrams, examples, notes, are non-normative, as well as sections explicitly marked as non-normative. Everything else in this specification is normative.</p>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in the normative parts of this document are to be interpreted as described in <a href="http://dev.w3.org/2006/xbl2/#refsRFC2119">RFC2119</a>. For readability, these words do not appear in all uppercase letters in this specification.</p>

<p>To help with layering and to avoid circular dependencies between various parts of specification, this document consists of three consecutive narratives:
</p><ol>
    <li>setting up the stage for the specification,</li>
    <li>explaining of the conceptual model and algorithms behind it, and</li>
    <li>expressing this model with DOM interfaces and HTML elements.</li>
</ol>
<p>In a sense, these parts can be viewed as <em>math</em>, which sets up the reasoning environment, <em>physics</em>, which is the theoretical reasoning about the concept, and <em>mechanics</em>, which is the practical application of this reasoning.</p>

<p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="http://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence">processing equivalence</dfn> is a constraint imposed on the algorithm implementors, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>

<h2 id="dependencies"><span class="section">2</span> Dependencies</h2>

<p>This document relies on the following specifications:</p>

<ul>
    <li><a href="http://www.w3.org/TR/CSS2/">CSS Level 2 Revision 1</a></li>
    <li><a href="http://www.w3.org/TR/cssom/">CSSOM</a></li>
    <li><a href="http://www.w3.org/TR/DOM-Level-3-Events/">DOM Level 3 Events</a></li>
    <li><a href="http://www.w3.org/TR/domcore/">DOM4 (DOM Core)</a></li>
    <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/">HTML</a></li>
    <li><a href="http://html5.org/specs/dom-parsing.html">DOM Parsing and Serialization</a></li>
    <li><a href="http://www.w3.org/TR/selectors/">Selectors Level 3</a></li>
    <li><a href="http://dev.w3.org/2006/webapi/selectors-api/">Selectors API Level 1</a></li>
</ul>

<h2 id="terminology"><span class="section">3</span> Terminology</h2>

<p>The following terms are used throughout the specification:

</p><dl>
<dt>DOM</dt>
    <dd>The <a href="http://www.w3.org/TR/domcore/">document object model</a></dd>
<dt>document</dt>
    <dd>The Document Object Model's underlying document</dd>
<dt>node</dt>
    <dd>Any DOM object that <a href="http://www.w3.org/TR/domcore/#concept-tree-participate">participates in a tree</a></dd>
<dt>element</dt>
    <dd>A DOM object that implements the <a href="http://www.w3.org/TR/domcore/#interface-element">Element</a> interface</dd>
<dt>DOM tree</dt>
    <dd>Any <a href="http://www.w3.org/TR/domcore/#trees">tree</a>, composed of DOM objects</dd>
<dt>DOM structure</dt>
    <dd>A DOM tree or fragment of a DOM tree</dd>
</dl>

</section>

<section class="physics">

<h2 id="introduction"><span class="section">4</span> Introduction</h2>

<p>Web application developers often encounter the need to provide <dfn id="dfn-encapsulation">encapsulation</dfn> of a DOM structure. Despite being part of one document tree, there are typically many functional fragments of DOM (or <dfn id="dfn-dom-subtree">DOM subtrees</dfn>), as well as assumptions about these fragments operating independently. This type of encapsulation is called <dfn id="dfn-functional-encapsulation">functional encapsulation</dfn>, as opposed to <dfn id="dfn-trust-encapsulation">trust encapsulation</dfn>, which deals with limiting information flow based on trust and ensuring security of data and state within an application.</p>

<p><a href="#dfn-functional-encapsulation">Functional encapsulation</a> is primarily concerned with establishing functional boundaries in a document tree. A functional boundary (or just <dfn id="dfn-boundary">boundary</dfn> hereon) is a delineation of functional concerns between two loosely coupled units of functionality.</p>

<h3 id="functional-encapsulation-example"><span class="section">4.1</span> Functional Encapsulation Example</h3>

<p>A Web application user interface is commonly composed of several user interface elements (or <dfn id="dfn-widget">widgets</dfn>), each a DOM subtree. In cases where a widget is tasked with hosting other widgets, the need arises for the widget to understand where its DOM subtree ends and another widget's DOM subtree begins.</p>

<object data="functional-encapsulation-example.svg" width="800" height="500"></object>

<p>This need for observing the functional <a href="#dfn-boundary">boundaries</a> in a document tree is even larger when a <a href="#dfn-widget">widget</a> is operated on—added, moved, or removed in the document tree—by an outside actor, such as the Web application that consumes these widgets. Unless the widget consumer knows exactly how a widget's DOM structure is designed, it is impossible for the consumer to reasonably operate on the widget. A typical workaround has been providing alternative means of operation by the widget developer, which, in striving for API consistency quickly extrapolates into a complete set of widget-specific, DOM-like APIs.</p>

<h2 id="shadow-dom-subtrees"><span class="section">5</span> Shadow DOM Subtrees</h2>

<p>To solve this problem at its core, a new abstraction is introduced. The <dfn id="dfn-shadow-dom">shadow DOM</dfn> allows multiple DOM subtrees (in addition to the document tree) to be composed into one larger tree when rendered. The existence of multiple DOM subtrees is enabled by letting any element in the document tree to host one or more additional DOM subtrees. These <dfn id="dfn-shadow-dom-subtree">shadow DOM subtrees</dfn> are governed by a set of rules that establish encapsulation <a href="#dfn-boundary">boundaries</a> while retaining the standard DOM composability semantics.</p>

<p>The encapsulation <a href="#dfn-boundary">boundaries</a> between shadow DOM subtrees are called <dfn id="dfn-shadow-boundary">shadow boundaries</dfn>. The elements that host shadow DOM subtrees are called <dfn id="dfn-shadow-host">shadow hosts</dfn>, and the root nodes of the shadow DOM subtrees are called <dfn id="dfn-shadow-root">shadow roots</dfn>.</p>

<object data="shadow-dom-subtrees.svg" width="800" height="430"></object>

<p>When rendered, the shadow DOM subtree takes place of the <a href="#dfn-shadow-host">shadow host</a>'s content.</p>

<object data="shadow-rendering.svg" width="450" height="400"></object>

<p>To enable composition of <a href="#dfn-shadow-host">shadow host</a>'s children and the shadow DOM subtree, a notion of insertion points is added to the abstraction. An <dfn id="dfn-insertion-point">insertion point</dfn> is a defined location in the shadow DOM subtree, to which the <a href="#dfn-shadow-host">shadow host</a>'s children are transposed when rendering. The mechanism that determines which <a href="#dfn-shadow-host">shadow host</a>'s children are transposed into which <a href="#dfn-insertion-point">insertion points</a> is called <dfn id="dfn-distribution">distribution</dfn>.</p>

<object data="insertion-points.svg" width="800" height="900"></object>

<p>Thus, the encapsulation of a shadow DOM subtree can be viewed as a two-fold problem:
</p><ol>
    <li>the <dfn id="dfn-upper-boundary-encapsulation">upper-boundary encapsulation</dfn>, or governing the boundary between the shadow root and the shadow host; and</li>
    <li>the <dfn id="dfn-lower-boundary-encapsulation">lower-boundary encapsulation</dfn>, or governing the boundary between the insertion points and the shadow host's children.</li>
</ol>

<h3 id="upper-boundary-encapsulation"><span class="section">5.1</span> Upper-boundary Encapsulation</h3>

<p>To maintain the upper-boundary encapsulation, the following <dfn id="dfn-scoping-constraints">scoping constraints</dfn> <strong>must</strong> apply to all nodes in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>:</p>
<ul>
    <li>The <a href="http://www.w3.org/TR/domcore/#dom-node-ownerdocument"><code>ownerDocument</code></a> property refers to the document of the <a href="#dfn-shadow-host">shadow host</a></li>
    <li>The nodes and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-document-nameditem-filter">named elements</a> <strong>are not</strong> accessible using <a href="#dfn-shadow-host">shadow host</a>'s document <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-tree-accessors">DOM tree accessors</a> or with <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#window">Window</a> object <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#named-access-on-the-window-object">named properties</a></li>
    <li>The nodes <strong>are not</strong> present in any of the document's <a href="http://www.w3.org/TR/dom/#interface-nodelist"><code>NodeList</code></a>, <a href="http://www.w3.org/TR/dom/#interface-htmlcollection"><code>HTMLCollection</code></a>, or <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#domelementmap-0"><code>DOMElementMap</code></a> instances</li>
    <li>The nodes with a unique <a href="http://www.w3.org/TR/domcore/#concept-id">id</a> and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-document-nameditem-filter">named elements</a> <strong>are not</strong> addressable from any attributes of elements in <a href="#dfn-shadow-host">shadow host</a>'s document</li>
    <li>The style sheets, represented by the nodes <strong>are not</strong> accessible using <a href="#dfn-shadow-host">shadow host</a> document's <a href="http://www.w3.org/TR/cssom/#extensions-to-the-document-interface">CSSOM extensions</a></li>
    <li>The nodes <strong>are</strong> accessible using <a href="#dfn-shadow-root">shadow root</a>'s DOM tree accessor methods</li>
    <li>The nodes with a unique <a href="http://www.w3.org/TR/domcore/#concept-id">id</a> and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-document-nameditem-filter">named elements</a> <strong>are</strong> addressable from any attributes of elements in the same <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a></li>
    <li>The <a href="http://www.w3.org/TR/selectors/">selectors</a> <strong>must not</strong> cross the <a href="#dfn-shadow-boundary">shadow boundary</a> from the document tree into the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a></li>
</ul>
<p>For convenience, the <a href="#dfn-shadow-root">shadow root</a> provides its own set of DOM tree accessor methods. No nodes other than <a href="#dfn-shadow-root">shadow root</a> descendants are accessible with these methods.</p>

<p>The <a href="http://www.w3.org/TR/dom/#dom-node-parentnode"><code>parentNode</code></a> and <a href="http://www.w3.org/TR/dom/#dom-node-parentelement"><code>parentElement</code></a> attributes of the <a href="#dfn-shadow-root">shadow root</a> object <strong>must</strong> always return <code>null</code>.</p>

<h3 id="lower-boundary-encapsulation"><span class="section">5.2</span> Lower-boundary Encapsulation</h3>

<p>To maintain the lower-boundary encapsulation, the <a href="#dfn-distribution">distribution</a> of child nodes of the <a href="#dfn-shadow-host">shadow host</a> among the <a href="#dfn-insertion-point">insertion points</a> in the associated <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> <strong>must</strong> have the following traits:</p>
<ul>
    <li>The <a href="#dfn-distribution">distribution</a> does not affect the state of the document DOM tree or shadow DOM subtrees</li>
    <li>Each insertion point participates in <a href="#dfn-distribution">distribution</a> by providing a matching criteria for the child nodes. The <dfn id="dfn-matching-criteria">matching criteria</dfn> determines whether a given node could be <a href="#dfn-distribution">distributed</a> to a given insertion point</li>
    <li>The <a href="#dfn-distribution">distribution</a> is a result of executing a stable algorithm</li>
    <li>The <a href="#dfn-distribution">distribution</a> itself does not change the variables affecting the <a href="#dfn-distribution">distribution</a></li>
    <li>The <a href="#dfn-distribution">distribution</a> reoccurs whenever any variable affecting it is changed</li>
</ul>

<p>An <a href="#dfn-insertion-point">insertion point</a> may be <strong>active</strong> or <strong>inactive</strong>. An <dfn id="dfn-active-insertion-point">active</dfn> insertion point participates in the <a href="#dfn-distribution">distribution</a> process, whereas the <dfn id="dfn-inactive-insertion-point">inactive</dfn> insertion does not. If not specifically set to be inactive, the insertion point <strong>must</strong> be considered <strong>active</strong>.</p>

<p>If an <a href="#dfn-insertion-point">insertion point</a> is not in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, it <strong>must</strong> have the same rendering behavior as the <a href="http://www.whatwg.org/specs/web-apps/current-work/#htmlunknownelement"><code>HTMLUnknownElement</code></a>.</p>

<p>The <dfn id="dfn-distribution-algorithm">distribution algorithm</dfn> <strong>must</strong> produce an outcome that is <a href="#dfn-processing-equivalence">equivalent</a> of the outcome of processing these steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>TREE</var>, a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a></dd>
    <dd><var>POOL</var>, a list of DOM nodes</dd>
<dt>Output</dt>
    <dd>The nodes in <var>POOL</var> are <a href="#dfn-distribution">distributed</a> among <a href="#dfn-insertion-point">insertion points</a> in <var>TREE</var>.</dd>
</dl>

<ol>
    <li><dfn id="algo-distribution-repeat-outer">Repeat</dfn> for each <a href="#dfn-active-insertion-point">active</a> <a href="#dfn-insertion-point">insertion point</a> in <var>TREE</var>, in <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#tree-order">tree order</a>:
    <ol>
        <li>Let <var>POINT</var> be the current insertion point</li>
        <li><dfn id="algo-distribution-repeat">Repeat</dfn> for each node in <var>POOL</var>:
        <ol>
            <li>Let <var>NODE</var> be the current node</li>
            <li>If the <var>NODE</var> matches <var>POINT</var>'s <a href="#dfn-matching-criteria">matching criteria</a>:
                <ol>
                    <li><a href="#dfn-distribution">Distribute</a> the <var>NODE</var> to <var>POINT</var></li>
                    <li>Remove <var>NODE</var> from the <var>POOL</var></li>
                </ol></li>
            <li>Otherwise, continue to <a href="#algo-distribution-repeat">repeat</a></li>
        </ol></li>
        <li>Continue to <a href="#algo-distribution-repeat-outer">repeat</a></li>
    </ol></li>
</ol>
</div>

<h3 id="matching-insertion-points"><span class="section">5.3</span> Matching Insertion Points</h3>

<p>The <a href="#dfn-matching-criteria">matching criteria</a> for <a href="#dfn-insertion-point">insertion point</a> is defined as a set of selector fragments. Each <dfn id="dfn-selector-fragment">selector fragment</dfn> is indeed a fragment in the <a href="http://www.w3.org/TR/css3-selectors">selector</a> <code>(shadow-host)&gt;(fragment)</code>, where <code>(shadow-host)</code> is a selector that uniquely identifies the <a href="#dfn-shadow-host">shadow host</a>, and <code>(fragment)</code> is the <a href="#dfn-selector-fragment">selector fragment</a>.</p>

<p>A <dfn id="dfn-valid-selector-fragment">valid selector fragment</dfn> may contain:</p>

<ul>
    <li>A <a href="http://www.w3.org/TR/css3-selectors/#type-selectors">type selector</a> or a <a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a></li>
    <li><a href="http://www.w3.org/TR/css3-selectors/#class-html">class selector(s)</a></li>
    <li>An <a href="http://www.w3.org/TR/css3-selectors/#id-selectors">ID selector</a></li>
    <li><a href="http://www.w3.org/TR/css3-selectors/#attribute-selectors">attribute selector(s)</a></li>
    <li>the following <a href="http://www.w3.org/TR/css3-selectors/#pseudo-classes">pseudo-class selector(s)</a>:
        <ul>
            <li><code>:link</code></li>
            <li><code>:visited</code></li>
            <li><code>:target</code></li>
            <li><code>:enabled</code></li>
            <li><code>:disabled</code></li>
            <li><code>:checked</code></li>
            <li><code>:indeterminate</code></li>
            <li><code>:nth-child()</code></li>
            <li><code>:nth-last-child()</code></li>
            <li><code>:nth-of-type()</code></li>
            <li><code>:nth-last-of-type()</code></li>
            <li><code>:first-child</code></li>
            <li><code>:last-child</code></li>
            <li><code>:first-of-type</code></li>
            <li><code>:last-of-type</code></li>
            <li><code>:only-of-type</code></li>
        </ul>
    </li>
</ul>

<p>If any other types of selectors are present in the <a href="#dfn-selector-fragment">selector fragment</a>, the fragment <strong>must</strong> be considered invalid.</p>

<p>A conforming UAs <strong>must</strong> consider a node as <dfn id="#dfn-content-matching">matching</dfn> a set of <a href="#dfn-selector-fragment">selector fragments</a> in the context of a given <a href="#dfn-shadow-host">shadow host</a>, if it:
</p><ol>
    <li>is a child node of the shadow host; and</li>
    <li>all <a href="#dfn-selector-fragment">selector fragments</a> in the set are <a href="#dfn-valid-selector-fragment">valid</a>; and</li>
    <li>child node matches at least one selector fragment in the set or the set is empty.</li>
</ol>

<h3 id="selecting-nodes-distributed-to-insertion-points"><span class="section">5.4</span> Matching Children, Distributed To Insertion Points</h3>

<p><a href="http://dev.w3.org/csswg/selectors4/#idref-combinators">Reference combinators</a> match the children of a <a href="#dfn-shadow-host">shadow host</a>, <a href="#dfn-distribution">distributed</a> to the <a href="#dfn-insertion-point">insertion points</a> within a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>. To match, all of these conditions <strong>must</strong> apply:</p>
<ul>
    <li>The combinator value <strong>must</strong> be <code>select</code></li>
    <li>The first compound selector of the combinator <strong>must</strong> match an <a href="#dfn-insertion-point">insertion point</a></li>
    <li>The second compound selector <strong>must</strong> match an element, <a href="#dfn-distribution">distributed</a> to this <a href="#dfn-insertion-point">insertion point</a></li>
</ul>
<p>For example, <code class="prettify">.some-insertion-point /select/ div.special</code> will match all <code>div</code> elements that have <code>class</code> attribute set to <code>special</code> and have been <a href="#dfn-distribution">distributed</a> to an insertion point that has a class attribute set to <code>some-insertion-point</code>.</p>

<p>All other types of selectors <strong>must not</strong> cross the <a href="#dfn-shadow-boundary">shadow boundary</a> from a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> to the tree of its <a href="#dfn-shadow-host">shadow host</a>.</p>


<h3 id="multiple-shadow-subtrees"><span class="section">5.5</span> Hosting Multiple Shadow Subtrees</h3>

<p>A <a href="#dfn-shadow-host">shadow host</a> may host more than one <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>. In such cases, the subtrees are stacked in the order they were added the host, starting with the subtree added most recently. This set of trees is called a <dfn id="dfn-tree-stack">tree stack</dfn>. The more recently added subtree is called the <dfn id="dfn-younger-tree">younger tree</dfn>, and the less recently added subtree is called the <dfn id="dfn-older-tree">older tree</dfn>. The most recently added subtree is called the <dfn id="dfn-youngest-tree">youngest tree</dfn>.</p>

<p>To facilitate composing multiple shadow subtrees of the same host, a special kind of <a href="#dfn-insertion-point">insertion point</a> is defined. The <dfn id="dfn-shadow-insertion-point">shadow insertion point</dfn> designates a place in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, where an <a href="#dfn-older-tree">older tree</a> is inserted when rendering. If multiple <a href="#dfn-shadow-insertion-point">shadow insertion points</a> exist in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, only the first, in <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#tree-order">tree order</a>, is recognized. It is said that the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> is <dfn id="dfn-assigned">assigned</dfn> to a <a href="#dfn-shadow-insertion-point">shadow insertion point</a> if the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> is rendered in place of this <a href="#dfn-shadow-insertion-point">shadow insertion point</a>.</p>

<p>Just like other <a href="#dfn-insertion-point">insertion points</a>, the <a href="#dfn-shadow-insertion-point">shadow insertion points</a> can be <a href="#dfn-active-insertion-point">active</a> or <a href="#dfn-inactive-insertion-point">inactive</a>.</p>

<p>The composition is performed with the <dfn id="dfn-tree-composition">tree composition algorithm</dfn>, which <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:

</p><div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>HOST</var>, a <a href="#dfn-shadow-host">shadow host</a></dd>
<dt>Output</dt>
    <dd>All <a href="#dfn-insertion-point">insertion points</a> and <a href="#dfn-shadow-insertion-point">shadow insertion points</a> are populated.</dd>
</dl>

<ol>
    <li>Let <var>TREE</var> be the <a href="#dfn-youngest-tree">youngest tree</a> in the <var>HOST</var>'s <a href="#dfn-tree-stack">tree stack</a>
    </li><li>Let <var>POOL</var> be the list of nodes</li>
    <li>Populate <var>POOL</var> with child nodes of the <var>HOST</var></li>
    <li><dfn id="algo-composition-repeat">Repeat</dfn> while <var>TREE</var> exists:
    <ol>
        <li>Let <var>POINT</var> be the first encountered <a href="#dfn-active-insertion-point">active</a> <a href="#dfn-shadow-insertion-point">shadow insertion point</a> in <var>TREE</var>, in <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#tree-order">tree order</a>
        </li><li>Run the <a href="#dfn-distribution-algorithm">distribution algorithm</a>, supplying <var>POOL</var> and <var>TREE</var> as input</li>
        <li>If <var>POINT</var> exists:
        <ol>
            <li>Find the next older tree, relative to <var>TREE</var> in the <var>HOST</var>'s <a href="#dfn-tree-stack">tree stack</a>
            <ol>
                <li>If there is no older tree:
                <ol>
                    <li><a href="#dfn-distribution">Distribute</a> remaining nodes in <var>POOL</var>, if any, to <var>POINT</var></li>
                    <li><strong>stop</strong>.</li>
                </ol></li>
                <li>Otherwise:
                <ol>
                    <li>Set <var>TREE</var> to be this older tree</li>
                    <li><a href="#dfn-assigned">Assign</a> <var>TREE</var> to the <var>POINT</var></li>
                    <li>Continue to <a href="#algo-composition-repeat">repeat</a></li>
                </ol></li>
            </ol></li>
        </ol></li>
        <li>Otherwise, <strong>stop</strong>.
    </li></ol></li>
</ol>
</div>

<p>When an <a href="#dfn-insertion-point">insertion point</a> or a <a href="#dfn-shadow-insertion-point">shadow insertion point</a> has nothing <a href="#dfn-assigned">assigned</a> or <a href="#dfn-distribution">distributed</a> to them, the fallback content <strong>must</strong> be used instead when rendering. The <dfn id="dfn-fallback-content">fallback content</dfn> is all descendants of the DOM element that represents the insertion point. The <a href="#dfn-insertion-point">insertion points</a> or <a href="#dfn-shadow-insertion-point">shadow insertion points</a> in fallback content <strong>must</strong> be considered <a href="#dfn-inactive-insertion-point">inactive</a>.</p>

<h3 id="nested-shadow-subtrees"><span class="section">5.6</span> Nested Shadow Subtrees</h3>

<p>Any element in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> can be a <a href="#dfn-shadow-host">shadow host</a>, thus producing nested shadow DOM subtrees. A shadow DOM subtree is <dfn id="dfn-nested-subtree">nested</dfn> when its <a href="#dfn-shadow-host">shadow host</a> is itself a part of a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</p>

<p>A <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> is <dfn id="dfn-enclosed-subtree">enclosed</dfn> by another <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> when the enclosing subtree nests the enclosed subtree through one or more levels of nesting.</p>

<h3 id="rendering-shadow-subtrees"><span class="section">5.7</span> Rendering Shadow DOM Subtrees</h3>

<p><dfn id="dfn-rendering">Rendering</dfn> of <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>, or presenting them visually, is defined as a specialization of rendering <strong>any DOM subtree</strong>, and <strong>must</strong> happen as these steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>HOST</var>, a <a href="#dfn-shadow-host">shadow host</a></dd>
<dt>Output</dt>
    <dd>Rendering of the <var>HOST</var>, including its <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a></dd>
</dl>

<ol>
    <li>Run <a href="#dfn-tree-composition">tree composition algorithm</a> for the given <a href="#dfn-shadow-host">shadow host</a></li>
    <li>As content of the <a href="#dfn-shadow-host">shadow host</a>, render the <a href="#dfn-youngest-tree">youngest tree</a> as a <strong>any DOM subtree</strong>, with the following <dfn id="dfn-shadow-rendering">shadow rendering</dfn> exceptions:
    <ul>
        <li>Each element that is a <a href="#dfn-shadow-host">shadow host</a> <strong>must</strong> be <a href="#dfn-rendering">rendered</a> accordingly</li>
        <li>In place of each <a href="#dfn-insertion-point">insertion point</a>, process the following <dfn id="dfn-insertion-point-rendering">insertion point rendering</dfn> steps:
        <ol>
            <li>If there are child nodes <a href="#dfn-distribution">distributed</a> to this insertion point, for each child node and in the order they were distributed:
            <ol>
                <li>Let <var>CHILD</var> be the child node being rendered</li>
                <li>If <var>CHILD</var> is itself an <a href="#dfn-insertion-point">insertion point</a>, and the tree being rendered is <a href="#dfn-nested-subtree">nested</a>, render them using <a href="#dfn-insertion-point-rendering">insertion point rendering</a> steps</li>
                <li>Otherwise, render <var>CHILD</var> as <strong>any DOM subtree</strong>
            </li></ol></li>
            <li>Otherwise, render <a href="#dfn-fallback-content">fallback content</a> as <strong>any DOM subtree</strong></li>
        </ol></li>
        <li>In place of each <a href="#dfn-shadow-insertion-point">shadow insertion point</a>:
        <ol>
            <li>If there is an <a href="#dfn-older-tree">older tree</a>, <a href="#dfn-assigned">assigned</a> to this shadow insertion point, render it as <strong>any DOM subtree</strong>, but with the same <a href="#dfn-shadow-rendering">shadow rendering</a> exceptions.</li>
            <li>Otherwise, render <a href="#dfn-fallback-content">fallback content</a> as <strong>any DOM subtree</strong></li>
        </ol></li>
    </ul></li>
</ol>
</div>

<p>This process of <a href="#dfn-rendering">rendering</a> produces a structure that is a composition of several DOM subtrees, including the document tree. The term "<dfn id="dfn-as-rendered">as rendered</dfn>" is used to refer to this structure.</p>

<h2 id="events"><span class="section">6</span> Events</h2>

<p>When an <a href="http://www.w3.org/TR/domcore/#events">event</a> is <a href="http://www.w3.org/TR/domcore/#dispatching-events">dispatched</a> in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, its path either crosses the <a href="#dfn-shadow-boundary">shadow boundary</a> or is terminated at the <a href="#dfn-shadow-boundary">shadow boundary</a>. One exception are the mutation events. The <a href="http://www.w3.org/TR/DOM-Level-2-Events/events.html#Events-eventgroupings-mutationevents">mutation event types</a> <strong>must</strong> never be dispatched in a shadow DOM subtree.</p>

<p>For event path to cross the <a href="#dfn-shadow-boundary">shadow boundary</a>, it <strong>must</strong> be populated with <dfn id="dfn-adjusted-parent">adjusted parents</dfn>, or nodes that appear as parents <a href="#dfn-as-rendered">as rendered</a>. The <dfn id="dfn-parent-calculation-algorithm">parent calculation algorithm</dfn> is used to determine the <a href="#dfn-adjusted-parent">adjusted parent</a> of any given node and create the list of ancestors for event dispatch. This algorithm <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>NODE</var>, a DOM node</dd>
<dt>Output</dt>
    <dd><var>PARENT</var>, a DOM node's <a href="#dfn-adjusted-parent">adjusted parent</a></dd>
</dl>
<ol>
    <li>If <var>NODE</var> is a <a href="#dfn-shadow-root">shadow root</a>:
    <ol>
        <li>If <var>NODE</var> is currently <a href="#dfn-assigned">assigned</a> to a <a href="#dfn-shadow-insertion-point">shadow insertion point</a>:
        <ol>
            <li>Let the <var>PARENT</var> be the <a href="#dfn-shadow-insertion-point">shadow insertion point</a> to which <var>NODE</var> is <a href="#dfn-assigned">assigned</a> to</li>
        </ol></li>
        <li>Otherwise, let the <var>PARENT</var> be the <a href="#dfn-shadow-host">shadow host</a> of the <var>NODE</var>
    </li></ol></li>
    <li>If <var>NODE</var> is currently <a href="#dfn-distribution">distributed</a> to an <a href="#dfn-insertion-point">insertion point</a> in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, let the <var>PARENT</var> be the <a href="#dfn-insertion-point">insertion point</a> to which the <var>NODE</var> is <a href="#dfn-distribution">distributed</a> to</li>
    <li>Otherwise, let <var>PARENT</var> be the node's parent node.</li>
</ol>
</div>

<h3 id="event-retargeting"><span class="section">6.1</span> Event Retargeting</h3>

<p>In the cases where events cross the <a href="#dfn-shadow-boundary">shadow boundaries</a>, the event's information about the target of the event is adjusted in order to maintain <a href="#dfn-upper-boundary-encapsulation">upper boundary encapsulation</a>. Event <dfn id="dfn-retargeting">retargeting</dfn> is a process of computing relative targets for each ancestor of the node at which the event is dispatched. A <dfn id="dfn-relative-target">relative target</dfn> is a DOM node that most accurately represents the target of a dispatched event at a given ancestor while maintaining the <a href="#dfn-upper-boundary-encapsulation">upper boundary encapsulation</a>.

</p><p>The <dfn id="dfn-retargeting-algorithm">retargeting algorithm</dfn> is used to determine relative targets, and it <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>NODE</var>, a DOM node</dd>
<dt>Output</dt>
    <dd><var>TARGETS</var>, a list of tuples, each containing <var>NODE</var>'s ancestor and its relative target</dd>
</dl>
<ol>
    <li>Let <var>STACK</var> be a stack of DOM nodes</li>
    <li>Let <var>ANCESTOR</var> be <var>NODE</var></li>
    <li><dfn id="algo-reatargeting-repeat">Repeat</dfn> while <var>ANCESTOR</var> exists:
    <ol>
        <li>If <var>ANCESTOR</var> is an <a href="#dfn-insertion-point">insertion point</a>, push <var>ANCESTOR</var> into <var>STACK</var></li>
        <li>If <var>STACK</var> is empty, push <var>ANCESTOR</var> into <var>STACK</var></li>
        <li>Let <var>TARGET</var> be the DOM node at the top of <var>STACK</var></li>
        <li>Add (<var>TARGET</var>, <var>ANCESTOR</var>) tuple to <var>TARGETS</var></li>
        <li>If <var>ANCESTOR</var> is a <a href="#dfn-shadow-root">shadow root</a>:
        <ol>
            <li>Pop <var>STACK</var>, if <var>STACK</var> is not empty</li>
        </ol></li>
        <li>Set <var>ANCESTOR</var> to be the result of <a href="#dfn-parent-calculation-algorithm">parent calculation algorithm</a>, given <var>ANCESTOR</var> as input</li>
    </ol></li>
</ol>
</div>

<p>The retargeting process <strong>must</strong> occur prior to dispatch of an event.</p>

<h3 id="retargeting-related-target"><span class="section">6.2</span> Retargeting <code>relatedTarget</code></h3>

<p>Some events have a <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> property, which holds a node that's not the event's target, but is related to the event.</p>

<p>For instance, a <code>mouseover</code> event's <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> may hold the node from which the mouse has moved to event's <code>target</code>. In the case where <code>relatedTarget</code> is in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, the conforming UAs <strong>must</strong> not leak its actual value outside of this subtree. In cases where both <code>relatedTarget</code> and <code>target</code> are part of the same <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, the conforming UAs <strong>must</strong> <em>stop</em> events at the <a href="#dfn-shadow-boundary">shadow boundary</a> to avoid the appearance of spurious <code>mouseover</code> and <code>mouseout</code> events firing from the same node.</p>

<p>Thus, if an event has a <code>relatedTarget</code>, its value and extent of event dispatch <strong>must</strong> be adjusted. In general:</p>
<ol>
    <li>For a given DOM node, the <code>relatedTarget</code> <strong>must</strong> be changed to its ancestor (or self) that is in the same <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> as the node</li>
    <li>Event listeners <strong>must not</strong> be invoked on a DOM node for which the <code>target</code> and <code>relatedTarget</code> are the same.</li>
</ol>

<p>The <dfn id="dfn-related-target-algorithm">related target resolution</dfn> algorithm <strong>must</strong> be used to determine the value of the <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> property and <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>NODE</var>, the DOM node on which event listeners would be invoked</dd>
    <dd><var>RELATED</var>, the related target for the event</dd>
<dt>Output</dt>
    <dd><var>ADJUSTED</var>, the <dfn id="dfn-adjusted-related-target">adjusted related target</dfn> for <var>NODE</var></dd>
</dl>
<ol>
    <li>Let <var>TARGET</var> be <var>NODE</var></li>
    <li>Let <var>ADJUSTED</var> be <strong>undefined</strong></li>
    <li><dfn id="algo-target-repeat">Repeat</dfn> while <var>TARGET</var> exists:
    <ol>
        <li>Let <var>STACK</var> be an empty stack of DOM nodes</li>
        <li>Let <var>ANCESTOR</var> be <var>RELATED</var></li>
        <li>Let <var>LAST</var> be <strong>undefined</strong></li>
        <li><dfn id="algo-ancestor-repeat">Repeat</dfn> while <var>ANCESTOR</var> exists:
        <ol>
            <li>If <var>STACK</var> is empty, push <var>ANCESTOR</var> into <var>STACK</var></li>
            <li>Otherwise, if <var>ANCESTOR</var> is an <a href="#dfn-insertion-point">insertion point</a>:
            <ol>
                <li>If <var>LAST</var> is <a href="#dfn-distribution">distributed</a> or assigned into <var>ANCESTOR</var>:
                <ol>
                    <li>Let <var>HEAD</var> be the DOM node at the top of the <var>STACK</var></li>
                    <li>Push <var>HEAD</var> into <var>STACK</var></li>
                </ol></li>
            </ol></li>
            <li>If <var>ANCESTOR</var> and <var>TARGET</var> are in the same subtree:
            <ol>
                <li>Let <var>ADJUSTED</var> be the DOM node at the top of the stack</li>
                <li><strong>Stop.</strong></li>
            </ol></li>
            <li>If <var>ANCESTOR</var> is a <a href="#dfn-shadow-root">shadow root</a>, pop <var>STACK</var></li>
            <li>Let <var>LAST</var> be <var>ANCESTOR</var></li>
            <li>Set <var>ANCESTOR</var> to be the result of <a href="#dfn-parent-calculation-algorithm">parent calculation algorithm</a>, given <var>ANCESTOR</var> as input</li>
        </ol></li>
        <li>If <var>TARGET</var> is a <a href="#dfn-shadow-root">shadow root</a>, let <var>TARGET</var> be the <a href="#dfn-shadow-host">shadow host</a> of <var>TARGET</var></li>
        <li>Otherwise, let <var>TARGET</var> be <var>TARGET</var>'s parent node</li>
    </ol></li>
</ol>
</div>

<h3 id="retargeting-focus-events"><span class="section">6.3</span> Retargeting Focus Events</h3>

<p>The <code>focus</code>, <code>DOMFocusIn</code>, <code>blur</code>, and <code>DOMFocusOut</code> events <strong>must</strong> be treated in the same way as events with a <code>relatedTarget</code>, where the corresponding node that is losing focus as a result of <code>target</code> gaining focus or the node that is gaining focus, and thus causing the blurring of <code>target</code> acts as the related target.</p>

<h3 id="events-that-are-always-stopped"><span class="section">6.4</span> Events that are Always Stopped</h3>

<p>The following events <strong>must</strong> always be stopped at the nearest <a href="#dfn-shadow-boundary">shadow boundary</a>:</p>
<ul>
    <li><code>abort</code></li>
    <li><code>error</code></li>
    <li><code>select</code></li>
    <li><code>change</code></li>
    <li><code>load</code></li>
    <li><code>reset</code></li>
    <li><code>resize</code></li>
    <li><code>scroll</code></li>
    <li><code>selectstart</code></li>
</ul>

<h3 id="event-dispatch"><span class="section">6.5</span> Event Dispatch</h3>

<p>At the time of event dispatch:</p>
<ul>
    <li>The <a href="http://www.w3.org/TR/domcore/#event"><code>Event</code></a> <a href="http://www.w3.org/TR/domcore/#dom-event-target"><code>target</code></a> and <a href="http://www.w3.org/TR/domcore/#dom-event-currenttarget"><code>currentTarget</code></a> attributes <strong>must</strong> return the <a href="#dfn-relative-target">relative target</a> for the node on which event listeners are <a href="http://www.w3.org/TR/domcore/#concept-event-listener-invoke">invoked</a></li>
    <li>The <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-UIEvent"><code>UIEvent</code></a> <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> attribute <strong>must</strong> return the <a href="#dfn-adjusted-related-target">adjusted related target</a></li>
    <li>If the <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> and <a href="http://www.w3.org/TR/domcore/#dom-event-target"><code>target</code></a> are the same for a given node, its the event listeners <strong>must not</strong> be invoked</li>
    <li>When <em>capturing</em>, which entails processing step 3 of the <a href="http://www.w3.org/TR/domcore/#dispatching-events">event dispatch algorithm</a>, the <a href="http://www.w3.org/TR/domcore/#event"><code>Event</code></a> <a href="http://www.w3.org/TR/domcore/#dom-event-eventphase">eventPhase</a> attribute <strong>must</strong> return <a href="http://www.w3.org/TR/domcore/#dom-event-at_target">AT_TARGET</a> <strong>if</strong> the <a href="#dfn-relative-target">relative target</a> is same as the node on which event listeners are <a href="http://www.w3.org/TR/domcore/#concept-event-listener-invoke">invoked</a></li>
    <li>When <em>bubbling</em>, which entails processing step 6 of the <a href="http://www.w3.org/TR/domcore/#dispatching-events">event dispatch algorithm</a>, the event listeners <strong>must not</strong> be <a href="http://www.w3.org/TR/domcore/#concept-event-listener-invoke">invoked</a> on a node <strong>if</strong> it is the same as its <a href="#dfn-relative-target">relative target</a></li>
</ul>

<p>Upon completion of the event dispatch, the <a href="http://www.w3.org/TR/domcore/#event"><code>Event</code></a> object's <a href="http://www.w3.org/TR/domcore/#dom-event-target"><code>target</code></a> and <a href="http://www.w3.org/TR/domcore/#dom-event-currenttarget"><code>currentTarget</code></a> <strong>must</strong> be to the highest ancestor's <a href="#dfn-relative-target">relative target</a>. Since it is possible for a script to hold on to the <code>Event</code> object past the scope of event dispatch, this step is necessary to avoid revealing the nodes in <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>.</p>

<h3 id="event-retargeting-example"><span class="section">6.6</span> Event Retargeting Example</h3>

<p>Suppose we have a user interface for a media controller, represented by this DOM tree, composed of both document and the <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>. In this example, we will assume that selectors are allowed to cross the shadow boundaries and we will use these selectors to identify the elements. Also, we will invent a fictional <code>shadow-root</code> element to demarcate the <a href="#dfn-shadow-boundary">shadow boundaries</a> and represent <a href="#dfn-shadow-root">shadow roots</a>:</p>
<pre><code>
&lt;div id="player"&gt;
    <span class="shadow-boundary">&lt;shadow-root id="player-shadow-root"&gt;</span>
        &lt;div id="controls"&gt;
            &lt;button class="play-button"&gt;PLAY&lt;/button&gt;
            &lt;input type="range" id="timeline"&gt;
                <span class="shadow-boundary">&lt;shadow-root id="timeline-shadow-root"&gt;</span>
                    &lt;div class="slider-thumb" id="timeline-slider-thumb"&gt;&lt;/div&gt;
                <span class="shadow-boundary">&lt;/shadow-root&gt;</span>
            &lt;/input&gt;
            &lt;div class="volume-slider-container"&gt;
                &lt;input type="range" class="volume-slider"&gt;
                    <span class="shadow-boundary">&lt;shadow-root id="volume-shadow-root"&gt;</span>
                        &lt;div class="slider-thumb" id="volume-slider-thumb"&gt;&lt;/div&gt;
                    <span class="shadow-boundary">&lt;/shadow-root&gt;</span>
                &lt;/input&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    <span class="shadow-boundary">&lt;/shadow-root&gt;</span>
&lt;/div&gt;
</code></pre>

<p>Let's have a user position their pointing device over the volume slider's thumb (<code>#volume-slider-thumb</code>), thus triggering a <code>mouseover</code> event on that node. For this event, let's pretend it has no associated <code>relatedTarget</code>.</p>

<p>Just before the event is dispatched, we perform <a href="#dfn-retargeting">retargeting</a>:</p>
<ol>
    <li>Since <code>#volume-slider-thumb</code> is not an <a href="#dfn-insertion-point">insertion point</a>, we push it onto <var>STACK</var>, and add the first tuple to <var>TARGETS</var> as (<code>#volume-slider-thumb</code>, <code>#volume-slider-thumb</code>)</li>
    <li>We then <a href="#dfn-parent-calculation-algorithm">calculate parent</a> as <code>#volume-shadow-root</code> and proceed to second iteration, adding (<code>#volume-slider-thumb</code>, <code>#volume-shadow-root</code>) tuple to <var>TARGETS</var></li>
    <li>Because <code>#volume-shadow-root</code> is a <a href="#dfn-shadow-root">shadow root</a>, we pop <var>STACK</var>, thus emptying it</li>
    <li>Next <a href="#dfn-parent-calculation-algorithm">parent calculation</a> yields <code>#volume-slider</code>, and so we begin the third iteration</li>
    <li>Here, <var>STACK</var> is empty again, so we push <code>#volume-slider</code> into it and add (<code>#volume-slider</code>, <code>#volume-slider</code>) to <var>TARGETS</var></li>
    <li>The <a href="#dfn-parent-calculation-algorithm">parent</a> of <code>#volume-slider</code> is <code>#volume-slider-container</code> not a <a href="#dfn-shadow-root">shadow root</a> and not an <a href="#dfn-insertion-point">insertion point</a>, which dictates that we add (<code>#volume-slider</code>, <code>#volume-slider-container</code>) to <var>TARGETS</var></li>
    <li>Next <a href="#dfn-parent-calculation-algorithm">up</a>, we see <code>#controls</code>, again neither a <a href="#dfn-shadow-root">shadow root</a> nor an <a href="#dfn-insertion-point">insertion point</a>, which means we add (<code>##volume-slider</code>, <code>#controls</code>) to <var>TARGETS</var></li>
    <li>The <a href="#dfn-parent-calculation-algorithm">next ancestor</a> is <code>#player-shadow-root</code>, a <a href="#dfn-shadow-root">shadow root</a>, and thus we add it (<code>#volume-slider</code>, <code>#player-shadow-root</code>) to <var>TARGETS</var>, then pop <var>STACK</var>, emptying it</li>
    <li>Its <a href="#dfn-parent-calculation-algorithm">parent</a> is <code>#player</code>, neither <a href="#dfn-shadow-root">shadow root</a> nor <a href="#dfn-insertion-point">insertion point</a>, and <var>STACK</var> is empty, so we push <code>#player</code> to <var>STACK</var>, then add (<code>#player</code>, <code>#player</code>) to <var>TARGETS</var></li>
    <li>In our example, there are no further <a href="#dfn-parent-calculation-algorithm">parents</a>, causing us to exit the <a href="#algo-reatargeting-repeat">loop</a> and stop.</li>
</ol>

<p>At the end of this process, we should have the following set of ancestors and relative targets:</p>
<table>
<thead>
<tr>
    <th>Ancestor</th>
    <th>Relative Target</th>
</tr>
</thead>
<tbody>
<tr>
    <td><code>#player</code></td>
    <td><code><strong>#player</strong></code></td>
</tr>
<tr>
    <td><code>#player-shadow-root</code></td>
    <td><code>#volume-slider</code></td>
</tr>
<tr>
    <td><code>#controls</code></td>
    <td><code>#volume-slider</code></td>
</tr>
<tr>
    <td><code>#volume-slider-container</code></td>
    <td><code>#volume-slider</code></td>
</tr>
<tr>
    <td><code>#volume-slider</code></td>
    <td><code><strong>#volume-slider</strong></code></td>
</tr>
<tr>
    <td><code>#volume-shadow-root</code></td>
    <td><code>#volume-slider-thumb</code></td>
</tr>
<tr>
    <td><code>#volume-slider-thumb</code></td>
    <td><code><strong>#volume-slider-thumb</strong></code></td>
</tr>
</tbody>
</table>

<p>After we dispatch the <code>mouseover</code> event using these newly computed relative targets, the user decides to move their pointing device over the thumb of the timeline
(<code>#timeline-slider-thumb</code>). This triggers both a <code>mouseout</code> event for the volume slider thumb and the <code>mouseover</code> event for the timeline thumb.</p>

<p>Let's study how the <code>relatedTarget</code> value of the volume thumb's <code>mouseout</code> event is affected. For this event, the <code>relatedTarget</code> is the timeline thumb (<code>#timeline-slider-thumb</code>). Per <a href="#dfn-related-target-algorithm">algorithm</a>:</p>

<ol>
    <li>Starting with <var>NODE</var> as <code>#volume-slider-thumb</code> and <var>RELATED</var> as <code>#timeline-slider-thumb</code>,</li>
    <li>We <a href="#algo-ancestor-repeat">examine</a> ancestors of <var>RELATED</var>:
    <ol>
        <li>First <a href="#dfn-parent-calculation-algorithm">up</a> is <code>#timeline-slider-thumb</code>, and we push it into <var>STACK</var></li>
        <li>Then it's <code>#timeline-shadow-root</code>, a <a href="#dfn-shadow-root">shadow root</a>, so we pop <var>STACK</var>, emptying it</li>
        <li>Next is <code>#timeline</code>, we push it into <var>STACK</var></li>
        <li>Then comes <code>#controls</code> and after it, <code>#player-shadow-root</code>, a <a href="#dfn-shadow-root">shadow root</a>, so we pop <var>STACK</var>, emptying it</li>
        <li>Final ancestor is <code>#player</code>, we push it into <var>STACK</var></li>
    </ol>
    </li><li>Set <var>TARGET</var> to <code>#volume-shadow-root</code></li>
    <li>We again <a href="#algo-ancestor-repeat">examine</a> ancestors of <var>RELATED</var> and notice that it produces the same result as our previous such examination</li>
    <li>We then set <var>TARGET</var> to <code>#volume-slider</code> and</li>
    <li>Repeat <a href="#algo-ancestor-repeat">examination</a> of ancestors once more—and realize that when <var>ANCESTOR</var> value is <code>#timeline</code>, the <var>ANCESTOR</var> and <var>TARGET</var> are in the same tree, and thus</li>
    <li>Return <code>#timeline</code> as the adjusted <code>relatedTarget</code> value.
</li></ol>

<p>Performing this computation with <var>NODE</var> as <code>#player</code> yields the result of both <code>target</code> and <code>relatedTarget</code> being the same value (<code>#player</code>), which means that we do not dispatch the event on this node and its ancestors.</p>

<h2 id="styles"><span class="section">7</span> Styles</h2>

<p>Each <a href="#dfn-shadow-root">shadow root</a> has an associated list of zero or more <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheets</a>, named <dfn id="dfn-shadow-root-style-sheets">shadow root style sheets</dfn>. This is an ordered list that contains all <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheets</a>, associated with the <a href="#dfn-shadow-root">shadow root</a>, in <a href="http://www.w3.org/TR/dom/#concept-tree-order">tree order</a>.</p>

<p>When a <a href="#dfn-shadow-host">shadow host</a> has multiple <a href="#dfn-shadow-root">shadow roots</a>, the <a href="http://www.w3.org/TR/CSS2/cascade.html#cascading-order">sorting order</a> of <a href="http://www.w3.org/TR/CSS2/syndata.html#rule-sets">CSS rules</a>, defined in <a href="#dfn-shadow-root-style-sheets">shadow roow style sheets</a>, in ascending order of precedence <strong>must</strong> match the order of the <a href="#dfn-tree-stack">tree stack</a>, ending with the <a href="#dfn-youngest-tree">youngest tree</a>.

</p><p>To enforce <a href="#dfn-upper-boundary-encapsulation">upper-boundary encapsulation</a>, <a href="http://www.w3.org/TR/CSS2/syndata.html#rule-sets">CSS rules</a> declared by the document <strong>must not</strong> apply in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, unless the <dfn id="dfn-apply-author-styles">apply-author-styles</dfn> flag is set for this subtree. The flag signals that document CSS rules are applicable in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.

</p><p>Even when the <a href="#dfn-apply-author-styles">apply-author-styles</a> is set, the <a href="http://www.w3.org/TR/selectors/">selectors</a> still <strong>must not</strong> cross the <a href="#dfn-shadow-boundary">shadow boundary</a> per <a href="#dfn-scoping-constraints">scoping constraints</a>. In other words, with <a href="#dfn-apply-author-styles">apply-author-styles</a> set, the document CSS rules only match wholly inside or outside of the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</p>

<p>Conversely, to enforce <a href="#dfn-lower-boundary-encapsulation">lower-boundary encapsulation</a>, <a href="http://www.w3.org/TR/CSS2/syndata.html#rule-sets">CSS rules</a> declared in a <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a> <strong>must not</strong> apply in the document tree, with two exceptions:</p>
<ol>
    <li>Rules that contain <code>select</code> <a href="http://dev.w3.org/csswg/selectors4/#idref-combinators">reference combinators</a> and match elements in the document tree;</li>
    <li>The <a href="#host-at-rule"><code>@host</code> @-rule</a> that matches a <a href="#dfn-shadow-host">shadow host</a> in a document tree.</li>
</ol>

<p>The <dfn id="dfn-rule-applicability-algorithm">rule applicability algorithm</dfn> is used to determine whether any given rule is applicable to any DOM tree, and it <strong>must</strong> be equivalent to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
<dd><var>RULE</var>, a CSS rule whose applicability is being determined</dd>
<dd><var>TREE</var>, the document tree or <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a></dd>
<dt>Output</dt>
<dd>Whether <var>RULE</var> is applicable in <var>TREE</var>.</dd>
</dl>
<ol>
    <li>If <var>RULE</var> is not an <a href="http://www.w3.org/TR/CSS2/cascade.html">author style</a>, the rule <strong>is</strong> applicable in <var>TREE</var>.</li>
    <li>Otherwise, if <var>RULE</var> is either an <a href="#host-at-rule"><code>@host</code> @-rule</a> or contains a <code>select</code>  <a href="http://dev.w3.org/csswg/selectors4/#idref-combinators">reference combinator</a> <em>and</em> <var>RULE</var> is declared in <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>:
    <ol>
        <li>Let <var>BOTTOM</var> the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, with which these <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a> are associated</li>
        <li>If the <a href="#dfn-shadow-host">shadow host</a> of <var>BOTTOM</var> is in <var>TREE</var>, then <var>RULE</var> <strong>is</strong> applicable in <var>TREE</var>.</li>
    </ol></li>
    <li>Otherwise, if <var>TREE</var> is a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>:
    <ol>
        <li>If <var>TREE</var> has <a href="#dfn-apply-author-styles">apply-author-styles</a> flag set and <var>RULE</var> is declared in the document tree, <var>RULE</var> <strong>is</strong> applicable in <var>TREE</var>.</li>
        <li>Otherwise, if <var>RULE</var> is declared in <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>:
        <ol>
            <li>Let <var>TOP</var> the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, with which these <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a> are associated</li>
            <li>If <var>TOP</var> is <var>TREE</var>, then <var>RULE</var> <strong>is</strong> applicable in <var>TREE</var>.</li>
            <li>Otherwise, if <var>TREE</var> has <a href="#dfn-apply-author-styles">apply-author-styles</a> flag set and if each <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> that both <a href="#dfn-enclosed-subtree">encloses</a> <var>TREE</var> and is <a href="#dfn-enclosed-subtree">enclosed</a> by <var>TOP</var> has <a href="#dfn-apply-author-styles">apply-author-styles</a> flag set, then <var>RULE</var> <strong>is</strong> applicable in <var>TREE</var>.</li>
        </ol></li>
        <li>Otherwise, <var>RULE</var> <strong>is not</strong> applicable in <var>TREE</var>.</li>
    </ol></li>
    <li>Otherwise, if <var>TREE</var> is a document tree and <var>RULE</var> is declared in <var>TREE</var>, the rule <strong>is</strong> applicable in <var>TREE</var>.</li>
    <li>Otherwise, <var>RULE</var> <strong>is not</strong> applicable in <var>TREE</var>.</li>
</ol>
</div>

<p>In a document that contains <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>, the CSS properties <strong>must</strong> be inherited from parent nodes, produced using <a href="#dfn-parent-calculation-algorithm">parent calculation algorithm</a>. This requirement has the following effects:</p>
<ul>
    <li>the styles of the <a href="#dfn-shadow-host">shadow host</a> are inherited by the children of the <a href="#dfn-shadow-root">shadow root</a></li>
    <li>the styles of the <a href="#dfn-insertion-point">insertion point</a> node are inherited by those child nodes of the <a href="#dfn-shadow-host">shadow host</a> that are <a href="#dfn-assigned">assigned</a> to this <a href="#dfn-insertion-point">insertion point</a></li>
    <li>the styles of the <a href="#dfn-shadow-insertion-point">shadow insertion point</a> node are inherited by the child nodes of the <a href="#dfn-shadow-root">shadow root</a> of the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, <a href="#dfn-distribution">distributed</a> to this <a href="#dfn-shadow-insertion-point">shadow insertion point</a></li>
</ul>

<p>If the <dfn id="dfn-reset-style-inheritance">reset-style-inheritance</dfn> flag is set for a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, all <a href="http://www.w3.org/TR/2005/WD-css3-cascade-20051215/#inheritance">inheritable</a> CSS properties <strong>must</strong> behave as if they were explicitly set to the <a href="http://www.w3.org/TR/2005/WD-css3-cascade-20051215/#initial0">initial value</a> at the upper boundary of the subtree.</p>

<p>If the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag is set for an <a href="#dfn-insertion-point">insertion point</a> in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, all <a href="http://www.w3.org/TR/2005/WD-css3-cascade-20051215/#inheritance">inheritable</a> CSS properties <strong>must</strong> behave as if they were explicitly set to the <a href="http://www.w3.org/TR/2005/WD-css3-cascade-20051215/#initial0">initial value</a> at the lower boundary of the subtree.</p>

<h3 id="css-variables"><span class="section">7.1</span> CSS Variables</h3>

<p>The <a href="#dfn-shadow-host">shadow host</a> styles being inherited by the children of the <a href="#dfn-shadow-root">shadow root</a> <strong>must</strong> also apply to <a href="http://dev.w3.org/csswg/css-variables/">CSS Variables</a>. This provides a way for document DOM tree styles to send signals into the <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>, and for the <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a> to receive these signals with the use of the <a href="http://dev.w3.org/csswg/css-variables/#using-variables"><code>var()</code></a> function.</p>

<h3 id="text-decoration-property"><span class="section">7.2</span> <code>text-decoration</code> Property</h3>

<p>The text decorations, specified by the <a href="http://www.w3.org/TR/CSS2/text.html#lining-striking-props"><code>text-decoration</code></a> property <strong>must not</strong> be propagated from <a href="#dfn-shadow-host">shadow hosts</a> to <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>.</p>

<h3 id="host-at-rule"><span class="section">7.3</span> <code>@host</code> @-rule</h3>

<p>Within styles, specified in <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>, the author may use a <code>@host</code> @-rule. The syntax of this rule is defined as this addition to <a href="http://www.w3.org/TR/CSS21/grammar.html">CSS Grammar</a>:</p>

<p>The following production is added to the <a href="http://www.w3.org/TR/CSS21/grammar.html#grammar">grammar</a>:</p>

<pre><code>
host
    : HOST_SYM S* '{' S* ruleset* '}' S*
    ;
</code></pre>

<p>The following rule is added to the <a href="http://www.w3.org/TR/CSS21/grammar.html#scanner">tokenizer</a>:</p>

<pre><code>
@{H}{O}{S}{T}        {return HOST_SYM;}
</code></pre>

<p>The <a href="http://www.w3.org/TR/CSS21/syndata.html#x19">declarations</a> of the rules in a <code>@host</code> @-rule <strong>must</strong> only be matched against the <a href="#dfn-shadow-host">shadow host</a> of the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> in which the style is specified, but only if this <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> is <a href="#dfn-rendering">rendered</a>. When the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> is not <a href="#dfn-rendering">rendered</a> (when it's an older tree that is not assigned to a <a href="#dfn-shadow-insertion-point">shadow insertion point</a>), the <a href="http://www.w3.org/TR/CSS21/syndata.html#x19">declarations</a> <strong>must not</strong> be applied.</p>

<p>When a rule in <a href="#host-at-rule"><code>@host</code> @-rule</a> matches an element, it <strong>must</strong> have higher <a href="http://www.w3.org/TR/CSS2/cascade.html#specificity">specificity</a> than any <a href="http://www.w3.org/TR/selectors/">selector</a>, but lower <a href="http://www.w3.org/TR/CSS2/cascade.html#specificity">specificity</a> than <a href="http://www.w3.org/TR/CSS21/syndata.html#x19">declarations</a> from a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#the-style-attribute"><code>style</code></a> attribute.</p>


<section class="mechanics">

<h2 id="user-interaction"><span class="section">8</span> User Interaction</h2>

<h3 id="ranges-and-selection"><span class="section">8.1</span> Ranges and Selections</h3>

<p>Since a DOM node in a document tree and a DOM node in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> never have the same <a href="http://www.w3.org/TR/domcore/#concept-tree-root">root</a>, there may never exist a valid <a href="http://www.w3.org/TR/domcore/#range">DOM range</a> that spans either both a document tree and a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, or multiple <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>.</p>

<p>Accordingly, <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selections</a> may only exist within one tree, because they are defined by a single <a href="http://www.w3.org/TR/domcore/#range">range</a>. To maintain <a href="#dfn-upper-boundary-encapsulation">upper boundary encapsulation</a>, the selection, returned by the <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#dom-window-getselection"><code>window.getSelection()</code></a> method <strong>must</strong> never return a selection within a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</p>

<p>The <code>getSelection()</code> method of the <a href="#dfn-shadow-root">shadow root</a> object <strong>must</strong> return the current <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selection</a> in this <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</p>

<h3 id="focus-navigation"><span class="section">8.2</span> Focus Navigation</h3>

<p><a href="#dfn-shadow-dom-subtree">Shadow DOM subtrees</a> participate in <a href="http://www.w3.org/TR/css3-ui/#keyboard">sequential</a> or <a href="http://www.w3.org/TR/css3-ui/#keyboard">directional</a> focus navigation as part of the document tree. The <a href="http://www.w3.org/TR/css3-ui/#keyboard">navigation order</a> within a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> <strong>must</strong> be computed as a list of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#focusable">focusable</a> elements in <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#tree-order">tree order</a> <a href="#dfn-as-rendered">as-rendered</a>, with the exception of any elements, <a href="#dfn-distribution">distributed</a> its <a href="#dfn-insertion-point">insertion points</a>, and is called <dfn id="dfn-shadow-dom-navigation-order">shadow DOM navigation order</dfn>.</p>

<p>For <a href="http://www.w3.org/TR/css3-ui/#keyboard">sequential focus navigation</a>, the <a href="#dfn-shadow-dom-navigation-order">shadow DOM navigation order</a> sequence <strong>must</strong> be inserted into the document <a href="http://www.w3.org/TR/css3-ui/#keyboard">navigation order</a>:</p>
<ol>
    <li>immediately after the <a href="#dfn-shadow-host">shadow host</a>, if the shadow host is <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#focusable">focusable</a>; or</li>
    <li>in place of the <a href="#dfn-shadow-host">shadow host</a> as if the shadow host were assigned the value of <a href="http://www.w3.org/TR/css3-ui/#keyboard"><code>auto</code></a> for determining its position.</li>
</ol>

<p>For <a href="http://www.w3.org/TR/css3-ui/#keyboard">directional focus navigation</a>, it is up to the user agent to integrate the <a href="#dfn-shadow-dom-navigation-order">shadow DOM navigation order</a> into the document <a href="http://www.w3.org/TR/css3-ui/#keyboard">navigation order</a>.</p>

<h3 id="active-element"><span class="section">8.3</span> Active Element</h3>

<p>To maintain <a href="#dfn-upper-boundary-encapsulation">upper-boundary encapsulation</a>, the value of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document">Document</a> object's focus API property <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement">activeElement</a> <strong>must</strong> be adjusted. To prevent loss of information when adjusting this value, each <a href="#dfn-shadow-root">shadow root</a> <strong>must</strong> also have an <code>activeElement</code> property to store the value of the focused element in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</p>

<p>The <dfn id="active-element-adjustment-algorithm">active element adjustment algorithm</dfn> is used to determine the values of the respective <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement">activeElement</a> properties, and it <strong>must</strong> be equivalent to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>ELEMENT</var>, the focused element</dd>
<dt>Output</dt>
    <dd>Adjusted values of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement">activeElement</a> properties.</dd>
</dl>
<ol>
    <li>Run the <a href="#dfn-retargeting-algorithm">retargeting algorithm</a> with <var>ELEMENT</var> as input</li>
    <li>For each <var>TUPLE</var> in the resulting list of tuples:
    <ol>
        <li>Let <var>ADJUSTED</var> be the first value of the <var>TUPLE</var></li>
        <li>Let <var>NODE</var> be the second value of the <var>TUPLE</var></li>
        <li>If <var>NODE</var> is a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document">Document</a> or a <a href="#dfn-shadow-root">shadow root</a>, set the value of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement">activeElement</a> to <var>ADJUSTED</var>.</li>
    </ol>
    </li>
</ol>
</div>

<h3 id="editing"><span class="section">8.4</span> Editing</h3>

<p>The value of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#attr-contenteditable"><code>contenteditable</code></a> attribute <strong>must not</strong> propagate from <a href="#dfn-shadow-host">shadow host</a> to its <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>.</p>

<h3 id="assistive-technology"><span class="section">8.5</span> Assistive Technology</h3>

<p>User agents with assistive technology traverse the document tree <a href="#dfn-as-rendered">as rendered</a>, and thus enable full use of of <a href="http://www.w3.org/WAI/PF/aria/">WAI-ARIA</a> semantics in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>.</p>

<h2 id="html-elements"><span class="section">9</span> HTML Elements in Shadow DOM Subtrees</h2>

<p>Comparatively, a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> can be seen as somewhere between <em>just a DOM subtree in a document</em> and a <a href="http://www.w3.org/TR/domcore/#interface-documentfragment">document fragment</a>. Since it is rendered, a shadow DOM subtree aims to retain the traits of a typical DOM subtree in a document. At the same time, it is an encapsulation abstraction, so it has to avoid affecting the document DOM tree. Thus, the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> <strong>must</strong> behave <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/">as specified</a> in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>, with a few exceptions.</p>

<h3 id="inert-html-elements"><span class="section">9.1</span> Inert HTML Elements</h3>

<p>A subset of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> <strong>must</strong> behave as <dfn id="dfn-inert">inert</dfn>, or not part of the document tree. This is consistent how the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> would behave in a <a href="http://www.w3.org/TR/domcore/#interface-documentfragment">document fragment</a>. These elements are:</p>
<ul>
    <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-base-element"><code>base</code></a></li>
    <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-link-element"><code>link</code></a></li>
</ul>

<p>All other <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a> <strong>must</strong> behave as if they were part of the document tree, with the <a href="#dfn-scoping-constraints">scoping constraints</a> of their respective subtrees applied.</p>

<h3 id="html-forms"><span class="section">9.2</span> HTML Forms</h3>

<p>The <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#forms">forms</a> in HTML are scoped at the document level. That is, all <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#the-form-element"><code>form</code></a> elements and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#form-associated-element">form-associated elements</a> are accessible using the document <a href="http://www.w3.org/TR/domcore/#interface-document">DOM object</a>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-tree-accessors">tree accessors</a>. Per <a href="#dfn-scoping-constraints">scoping constraints</a>, this <strong>must</strong> exclude elements in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>.</p>

<p>Instead, each <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> <strong>must</strong> scope its <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#the-form-element"><code>form</code></a> elements and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#form-associated-element">form-associated elements</a>. Because the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#the-form-element"><code>form</code></a>'s <a href="http://www.w3.org/TR/domcore/#dom-node-ownerdocument"><code>ownerDocument</code></a> is the <a href="#dfn-shadow-host">shadow host</a>'s document, the form submission <strong>must</strong> continue to work <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/association-of-controls-and-forms.html#form-submission">as specified</a>.</p>

<h2 id="html-elements-and-their-shadow-dom-subtrees"><span class="section">10</span> HTML Elements and Their Shadow DOM Subtrees</h2>

<p>Per <a href="http://www.whatwg.org/specs/web-apps/current-work/">specification</a>, some <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> are designed to either not render their contents or have special requirements in regard to contents rendering. In order to reconcile these differences in rendering behavior with the shadow DOM <a href="#dfn-tree-composition">tree composition</a>, all <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> <strong>must</strong> have an <a href="#dfn-processing-equivalence">equivalent</a> of a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> that is created and populated at the time of element instantiation. It is up to a user agent to define the content of these subtrees. However, all conforming user agents <strong>must</strong> satisfy the following requirements:</p>

<table>
<thead>
    <tr>
        <th style="width: 30%">HTML Element</th>
        <th>Shadow DOM Subtree Requirements</th>
    </tr>
</thead>
<tbody>
    <tr>
        <td><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/embedded-content-1.html#the-img-element"><code>img</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-iframe-element"><code>iframe</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-embed-element"><code>embed</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-object-element"><code>object</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-video-element.html#the-video-element"><code>video</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-video-element.html#the-audio-element"><code>audio</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-canvas-element.html#the-canvas-element"><code>canvas</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-map-element.html#the-map-element"><code>map</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-input-element.html#the-input-element"><code>input</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-textarea-element"><code>textarea</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-progress-element"><code>progress</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-meter-element"><code>meter</code></a></td>
        <td>If the element that can have <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#fallback-content">fallback content</a>, contains one <a href="#dfn-insertion-point">insertion point</a>. The <a href="#dfn-matching-criteria">matching criteria</a> value is <a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a> only when the element needs to show <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#fallback-content">fallback content</a>. Otherwise, contains no <a href="#dfn-insertion-point">insertion points</a> or an <a href="#dfn-insertion-point">insertion points</a> that matches nothing.</td>
    </tr>
    <tr>
        <td><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#the-fieldset-element"><code>fieldset</code></a></td>
        <td>Contains two <a href="#dfn-insertion-point">insertion points</a> with the following <a href="#dfn-matching-criteria">matching criteria</a>:
        <ol>
            <li><code>legend:first-of-type</code></li>
            <li><a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a></li>
        </ol>
        </td>
    </tr>
    <tr>
        <td><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/interactive-elements.html#the-details-element"><code>details</code></a></td>
        <td>Contains two <a href="#dfn-insertion-point">insertion points</a> with the following <a href="#dfn-matching-criteria">matching criteria</a>:
        <ol>
            <li><code>summary:first-of-type</code></li>
            <li><a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a></li>
        </ol>
        </td>
    </tr>
    <tr>
        <td>All other elements</td>
        <td>Contains one <a href="#dfn-insertion-point">insertion point</a> with the <a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a> as the <a href="#dfn-matching-criteria">matching criteria</a></td>
    </tr>
</tbody>
</table>

<h2 id="elements-and-dom-objects"><span class="section">11</span> Elements and DOM Objects</h2>

<h3 id="shadow-root-object"><span class="section">11.1</span> <code>ShadowRoot</code> Object</h3>

<p>The <code>ShadowRoot</code> object represents the <a href="#dfn-shadow-root">shadow root</a>.</p>
    
<pre><code>
[Constructor(in <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#htmlelement">HTMLElement</a> host) raises (DOMException)]
interface <dfn id="api-shadow-root">ShadowRoot</dfn> : <a href="http://www.w3.org/TR/domcore/#interface-documentfragment">DocumentFragment</a> {
    <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#htmlelement">HTMLElement</a> <a href="#api-shadow-root-get-element-by-id">getElementById</a>(in DOMString elementId);
    <a href="http://www.w3.org/TR/domcore/#nodelist">NodeList</a> <a href="#api-shadow-root-get-elements-by-class-name">getElementsByClassName</a>(in DOMString tagName);
    <a href="http://www.w3.org/TR/domcore/#nodelist">NodeList</a> <a href="#api-shadow-root-get-elements-by-tag-name">getElementsByTagName</a>(in DOMString className);
    <a href="http://www.w3.org/TR/domcore/#nodelist">NodeList</a> <a href="#api-shadow-root-get-elements-by-tag-name-ns">getElementsByTagNameNS</a>(DOMString namespace, DOMString localName);
    <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#selection">Selection</a> <a href="#api-shadow-root-selection">getSelection</a>();
    <a href="http://www.w3.org/TR/cssom/#the-cssstylesheet-interface">CSSStyleSheet</a> <a href="#api-shadow-root-add-style-sheet">addStyleSheet</a>(HTMLElement element) raises (DOMException);
    <a href="http://www.w3.org/TR/cssom/#the-cssstylesheet-interface">CSSStyleSheet</a> <a href="#api-shadow-root-remove-style-sheet">removeStyleSheet</a>(<a href="http://www.w3.org/TR/cssom/#the-cssstylesheet-interface">CSSStyleSheet</a> styleSheet) raises (DOMException);
    attribute bool <a href="#api-shadow-root-apply-author-styles">applyAuthorStyles</a>;
    attribute bool <a href="#api-shadow-root-reset-style-inheritance">resetStyleInheritance</a>;
    readonly attribute Element <a href="#api-shadow-root-active-element">activeElement</a>;
    attribute DOMString <a href="#api-shadow-root-inner-html">innerHTML</a>;
    readonly attribute <a href="http://www.w3.org/TR/cssom/#the-stylesheet-interface">StyleSheetList</a> <a href="#api-shadow-root-style-sheets">styleSheets</a>;
}
</code></pre>

<h4 id="shadow-root-attributes"><span class="section">11.1.1</span> <code>ShadowRoot</code> Attributes</h4>

<dl>
<dt id="api-shadow-root-apply-author-styles"><code>applyAuthorStyles</code> of type <code>bool</code></dt>
<dd>Represents the <a href="#dfn-apply-author-styles">apply-author-styles</a> flag and indicates whether or not the rules in <a href="http://www.w3.org/TR/CSS2/cascade.html">author styles</a> associated with the element's document apply to the shadow DOM subtree. If <code>false</code> (default value), the author styles <strong>are not</strong> applied to the shadow DOM subtree. If <code>true</code>, the author styles <strong>are</strong> applied.</dd>
<dd>On getting, the attribute <strong>must</strong> return the current value of the <a href="#dfn-apply-author-styles">apply-author-styles</a> flag for the <a href="#dfn-shadow-host">shadow host</a>'s subtree.</dd>
<dd>On setting, the attribute <strong>must</strong> set the value of the <a href="#dfn-apply-author-styles">apply-author-styles</a> flag for the <a href="#dfn-shadow-host">shadow host</a>'s subtree to specified value.</dd>
<dt id="api-shadow-root-reset-style-inheritance"><code>resetStyleInheritance</code> of type <code>bool</code></dt>
<dd>Represents the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag and indicates whether or not the inheritable CSS properties are set to the initial value at the shadow boundary. If <code>false</code> (default value), the properties continue to inherit. If <code>true</code>, the properties are set to initial value.</dd>
<dd>On getting, the attribute <strong>must</strong> return the current value of the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag for the <a href="#dfn-shadow-host">shadow host</a>'s subtree.</dd>
<dd>On setting, the attribute <strong>must</strong> set the value of the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag for the <a href="#dfn-shadow-host">shadow host</a>'s subtree to specified value.</dd>
<dt id="api-shadow-root-active-element"><code>activeElement</code> of type <code>Element</code>, readonly</dt>
<dd>Represents the currently focused element in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</dd>
<dd>On getting, the attribute <strong>must</strong> return the currently focused element in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> or <code>null</code>, if there is none.</dd>
<dt id="api-shadow-root-inner-html"><code>innerHTML</code> of type <code>DOMString</code></dt>
<dd>represents the markup of <a href="#api-shadow-root"><code>ShadowRoot</code></a>'s contents.</dd>
<dd>On getting, the attribute <strong>must</strong> return the result of running the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-end.html#html-fragment-serialization-algorithm">HTML fragment serialization algorithm</a> with the <a href="http://html5.org/specs/dom-parsing.html#context-object">context object</a> as <a href="#dfn-shadow-host"><code>shadow host</code></a>.</dd>
<dd>On setting, these steps <strong>must</strong> be run:
<ol>
    <li>Let <var>FRAGMENT</var> be the result of invoking the <a href="http://html5.org/specs/dom-parsing.html#concept-parse-fragment">fragment parsing algorithm</a> with the new value as <var>MARKUP</var>, and the <a href="http://html5.org/specs/dom-parsing.html#context-object">context object</a> as <a href="#dfn-shadow-host"><code>shadow host</code></a></li>
    <li><a href="#dfn-shadow-host"></a><a href="http://www.w3.org/TR/dom/#concept-node-replace-all">Replace all</a> with <var>FRAGMENT</var> within the <a href="#dfn-shadow-root">shadow root</a>.</li>
</ol></dd>
<dt id="api-shadow-root-style-sheets"><code>styleSheets</code> of type <code>StyleSheetList</code>, readonly</dt>
<dd>Represents the <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>.</dd>
<dd>On getting, the attribute <strong>must</strong> return a <code>StyleSheetList</code> sequence containing the <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>.
</dd>
</dl>

<p>The <a href="http://www.w3.org/TR/domcore/#dom-node-nodetype"><code>nodeType</code></a> attribute of a <a href="#api-shadow-root"><code>ShadowRoot</code></a> instance <strong>must</strong> return <a href="http://www.w3.org/TR/domcore/#dom-node-document_fragment_node"><code>DOCUMENT_FRAGMENT_NODE</code></a>. Accordingly, the <a href="http://www.w3.org/TR/domcore/#dom-node-nodename"><code>nodeName</code></a> attribute of a <a href="#api-shadow-root"><code>ShadowRoot</code></a> instance <strong>must</strong> return <code>"#document-fragment"</code>.</p>

<h4 id="shadow-root-methods"><span class="section">11.1.2</span> <code>ShadowRoot</code> Methods</h4>

<dl>
<dt><code>constructor</code></dt>
<dd>
    <table>
        <thead>
            <tr>
                <th>Parameter</th>
                <th>Type</th>
                <th>Nullable</th>
                <th>Optional</th>
                <th>Description</th>
            </tr>
        </thead>
            <tbody><tr>
                <td><dfn id="api-shadow-root-constructor-element"><code>element</code></dfn></td>
                <td><a href="http://www.w3.org/TR/domcore/#element"><code>Element</code></a></td>
                <td>No</td>
                <td>No</td>
                <td>Element that will be the <a href="#dfn-shadow-host">shadow host</a> of the newly created <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</td>
            </tr>
        </tbody><tbody>
        </tbody>
    </table>
    <div>
        <em>Exceptions:</em>
        <dl>
            <dt><a href="http://www.w3.org/TR/domcore/#dom-domexception-hierarchy_request_err"><code>HIERARCHY_REQUEST_ERR</code></a></dt>
            <dd>This exception <strong>must</strong> be thrown when the <code>element</code> parameter is not a valid <a href="http://www.w3.org/TR/domcore/#element"><code>Element</code></a>.
        </dd></dl>
    </div>
    <p>When invoked, the <code>ShadowRoot()</code> constructor <strong>must</strong> run these steps:</p>
    <ol>
        <li>Create a new instance of the <code>ShadowRoot</code> object</li>
        <li>Establish element, supplied as <code>element</code> argument as the <a href="#dfn-shadow-host">shadow host</a> for the <code>ShadowRoot</code> object</li>
        <li>Return <code>ShadowRoot</code> object</li>
    </ol>
</dd>
<dt id="api-shadow-root-get-element-by-id"><code>getElementById</code></dt>
<dd><strong>Must</strong> behave exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementbyid">document.getElementById</a>, except <a href="#dfn-scoping-constraints">scoped</a> to the shadow DOM subtree.</dd>
<dt id="api-shadow-root-get-elements-by-class-name"><code>getElementsByClassName</code></dt>
<dd><strong>Must</strong> behave exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementsbyclassname">document.getElementsByClassName</a>, except <a href="#dfn-scoping-constraints">scoped</a> to the shadow DOM subtree.</dd>
<dt id="api-shadow-root-get-elements-by-tag-name"><code>getElementsByTagName</code></dt>
<dd><strong>Must</strong> behave exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementsbytagname">document.getElementsByTagName</a>, except <a href="#dfn-scoping-constraints">scoped</a> to the shadow DOM subtree.</dd>
<dt id="api-shadow-root-get-elements-by-tag-name-ns"><code>getElementsByTagNameNS</code></dt>
<dd><strong>Must</strong> behave exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementsbytagnamens">document.getElementsByTagNameNS</a>, except <a href="#dfn-scoping-constraints">scoped</a> to the shadow DOM subtree.</dd>
<dt id="api-shadow-root-selection"><code>getSelection</code></dt><dt>
</dt><dd>Returns the current selection in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</dd>
<dd>When invoked, it <strong>must</strong> return <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selection</a> in <a href="#dfn-shadow-host">shadow host</a>'s subtree.</dd>
<dt id="api-shadow-root-add-style-sheet"><code>addStyleSheet</code></dt>
<dd>Adds a new <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a> to <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>.</dd>
<dd>When invoked, the method <strong>must</strong> run the following steps:
<ol>
    <li>If the parameter is an <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#htmllinkelement">HTMLLinkElement</a>:
    <ol>
        <li>Follow <a href="http://www.w3.org/TR/cssom/#requirements-on-user-agents-implementing-the-http-link-header">requirements</a> for implementing the HTTP <code>link</code> header with the exception that the newly created style sheet <strong>must</strong> be appended to the <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>, not <a href="http://www.w3.org/TR/cssom/#document-style-sheets">document style sheets</a></li>
        <li>Return the newly created <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a> object.</li>
    </ol></li>
    <li>If the parameter is an <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#htmlstyleelement">HTMLStyleElement</a>:
    <ol>
        <li><a href="http://www.w3.org/TR/cssom/#create-a-style-sheet">Create a style sheet</a> with the following properties and the exception that the newly created style sheet <strong>must</strong> be appended to the <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>, not <a href="http://www.w3.org/TR/cssom/#document-style-sheets">document style sheets</a>:
        <dl>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-location">style sheet location</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-owner-node">style sheet owner node</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-parent">style sheet parent</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-owner-css-rule">style sheet owner CSS rule</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-owner-css-rule">style sheet owner CSS rule</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-media">style sheet media</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-title">style sheet title</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-alternate-flag">style sheet alternate flag</a></dt>
            <dd>false</dd>
        </dl></li>
        <li>Return the newly created <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a> object.</li>
    </ol>
    </li><li>Otherwise, throw a <a href="http://www.w3.org/TR/domcore/#typemismatcherror"><code>TypeMismatchError</code></a> exception.</li>
</ol></dd>
<dt id="api-shadow-root-remove-style-sheet"><code>removeStyleSheet</code></dt>
<dd>Removes a <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a>, added with <a href="#api-shadow-root-add-style-sheet"><code>addStyleSheet</code></a>.</dd>
<dd>When invoked, the method <strong>must</strong> run these steps:
<ol>
    <li>If the <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a>, represented by the method parameter exists in the <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a> and was added with <a href="#api-shadow-root-add-style-sheet"><code>addStyleSheet</code></a>:
    <ol>
        <li>Remove the <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a> from <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>.</li>
        <li>Return the removed <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a> instance.</li>
    </ol></li>
    <li>Otherwise, throw a <a href="http://www.w3.org/TR/domcore/#nomodificationallowederror"><code>NoModificationAllowedError</code></a> exception.</li>
</ol></dd>
</dl>

<p>Invoking the <a href="http://www.w3.org/TR/domcore/#dom-node-clonenode"><code>cloneNode()</code></a> method on a <a href="#api-shadow-root"><code>ShadowRoot</code></a> instance <strong>must</strong> always throw a <a href="http://www.w3.org/TR/domcore/#dom-domexception-data_clone_err"><code>DATA_CLONE_ERR</code></a> exception.</p>


<h3 id="content-element"><span class="section">11.2</span> The <code>content</code> HTML element</h3>

<p>The <dfn id="dfn-content-element"><code>content</code></dfn> HTML element represents an <a href="#dfn-insertion-point">insertion point</a> in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</p>

<dl>
<dt>Context</dt>
<dd>Where <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#flow-content-0">flow content</a> is expected.</dd>
<dt>Content model</dt>
<dd><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#transparent">Transparent</a></dd>
<dt>Children</dt>
<dd>Anything as <a href="#dfn-fallback-content">fallback content</a></dd>
<dt>Content attributes</dt>
<dd><a href="http://dev.w3.org/html5/spec/Overview.html#global-attributes">Global attributes</a></dd>
<dd>
    <dl>
<!--    <dt id="markup-content-apply-shadow-styles"><code>apply-shadow-styles</code>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#boolean-attribute">boolean attribute</a></dt>
    <dd>indicates whether or not the rules in the scoped styles, defined in shadow DOM subtree are applied to the <a href="#dfn-shadow-host">shadow host</a>'s children that are inserted in place of this <code>content</code> element. If present, the styles are applied.</dd> -->
    <dt id="markup-content-select"><code>select</code>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#comma-separated-tokens">set of comma-separated tokens</a></dt>
    <dd>
        defines the <a href="#dfn-matching-criteria">matching criteria</a> for <a href="#dfn-distribution">distributing</a> child nodes of the <a href="#dfn-shadow-host">shadow host</a>. Each token <strong>must</strong> be a valid <a href="#dfn-selector-fragment">selector fragment</a>. If any token is invalid, the entire value of the <code>select</code> attribute is considered invalid.
    </dd>
    <dt id="markup-content-reset-style-inheritance"><code>reset-style-inheritance</code>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#boolean-attribute">boolean</a> attribute</dt>
    <dd>indicates the state of the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag for this <a href="#dfn-insertion-point">insertion point</a>. If present, the value of the flag <strong>must</strong> be set to <strong>true</strong>. Otherwise, the value <strong>must</strong> be set to <strong>false</strong>.</dd>
    </dl>
</dd>
<dt>DOM Interface</dt>
<dd>
    <pre><code>
interface <dfn id="api-html-content-element">HTMLContentElement</dfn> : <a href="http://dev.w3.org/html5/spec/Overview.html#htmlelement">HTMLElement</a> {<!--    attribute bool <a href="#api-html-content-element-apply-shadow-styles">applyShadowStyles</a>; -->
    attribute DOMString <a href="#api-html-content-element-select">select</a>;
    attribute boolean <a href="#api-html-content-element-reset-style-inheritance">resetStyleInheritance</a>;
}
    </code></pre>
    <dl>
    <dt>Attributes</dt>
    <dd>
    <dl>
<!--        <dt id="api-html-content-element-apply-shadow-styles"><code>applyShadowStyles</code> of type <code>bool</code></dt>
        <dd>Must <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the <a href="#markup-content-apply-shadow-styles">apply-shadow-styles</a> attribute.</dd> -->
        <dt id="api-html-content-element-select"><code>select</code> of type <code>DOMString</code></dt>
        <dd><strong>Must</strong> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the <a href="#markup-content-select">select</a> attribute.</dd>
        <dt id="api-html-content-element-reset-style-inheritance"><code>resetStyleInheritance</code> of type <code>boolean</code></dt>
        <dd><strong>Must</strong> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the <a href="#markup-content-reset-style-inheritance">reset-style-inheritance</a> attribute.</dd>
    </dl>
    </dd>
    </dl>
</dd>
</dl>


<h3 id="shadow-element"><span class="section">11.3</span> The <code>shadow</code> HTML element</h3>

<p>The <dfn id="dfn-shadow-element"><code>shadow</code></dfn> HTML element represents an <a href="#dfn-shadow-insertion-point">shadow insertion point</a> in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</p>

<dl>
<dt>Context</dt>
<dd>Where <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#flow-content-0">flow content</a> is expected.</dd>
<dt>Content model</dt>
<dd><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#transparent">Transparent</a></dd>
<dt>Children</dt>
<dd>Anything as <a href="#dfn-fallback-content">fallback content</a></dd>
<dt>Content attributes</dt>
<dd><a href="http://dev.w3.org/html5/spec/Overview.html#global-attributes">Global attributes</a></dd>
<dd>
<dl>
    <dt id="markup-shadow-reset-style-inheritance"><code>reset-style-inheritance</code>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#boolean-attribute">boolean</a> attribute</dt>
    <dd>indicates the state of the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag for this <a href="#dfn-shadow-insertion-point">shadow insertion point</a>. If present, the value of the flag <strong>must</strong> be set to <strong>true</strong>. Otherwise, the value <strong>must</strong> be set to <strong>false</strong>.</dd>
</dl></dd>
<dt>DOM Interface</dt>
<dd>
    <pre><code>
interface <dfn id="api-html-shadow-element">HTMLShadowElement</dfn> : <a href="http://dev.w3.org/html5/spec/Overview.html#htmlelement">HTMLElement</a> {
    attribute boolean <a href="#api-html-shadow-element-reset-style-inheritance">resetStyleInheritance</a>;
}
    </code></pre>
    <dl>
        <dt>Attributes</dt>
        <dt id="api-html-shadow-element-reset-style-inheritance"><code>resetStyleInheritance</code> of type <code>boolean</code></dt>
        <dd><strong>Must</strong> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the <a href="#markup-shadow-reset-style-inheritance">reset-style-inheritance</a> attribute.</dd>
    </dl>
</dd>
</dl>
</section>

<h2 id="shadow-dom-example"><span class="section">12</span> Shadow DOM Example</h2>

<p>Bob was asked to turn a simple list of links into a News Widget, which has links organized into two categories: breaking news and just news. The current document markup for the stories looks like this:</p>
<pre class="prettyprint"><code><span class="pln">
</span><span class="tag">&lt;ul</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"stories"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/1"</span><span class="tag">&gt;</span><span class="pln">A story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/2"</span><span class="tag">&gt;</span><span class="pln">Another story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/3"</span><span class="tag">&gt;</span><span class="pln">Also a story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/4"</span><span class="tag">&gt;</span><span class="pln">Yet another story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/4"</span><span class="tag">&gt;</span><span class="pln">Awesome story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/5"</span><span class="tag">&gt;</span><span class="pln">Horrible story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
</span><span class="tag">&lt;/ul&gt;</span></code></pre>

<p>To organize the stories, Bob decides to use <strong>shadow DOM</strong>. Doing so will allow Bob to keep the document markup uncluttered, and harnessing the power of insertion point makes sorting stories by class name a very simple task. After getting another cup of <a href="http://en.wikipedia.org/wiki/List_of_coffee_beverages#Green_Eye">Green Eye</a>, he quickly mocks up the following shadow DOM subtree, to be hosted by the <code>ul</code> element:</p>
<pre class="prettyprint"><code><span class="pln">
</span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;ul&gt;</span><span class="pln">
        </span><span class="tag">&lt;content</span><span class="pln"> </span><span class="atn">select</span><span class="pun">=</span><span class="atv">".breaking"</span><span class="tag">&gt;&lt;/content&gt;</span><span class="pln"> </span><span class="com">&lt;!-- insertion point for breaking news --&gt;</span><span class="pln">
    </span><span class="tag">&lt;/ul&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span><span class="pln">
</span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"other"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;ul&gt;</span><span class="pln">
        </span><span class="tag">&lt;content&gt;&lt;/content&gt;</span><span class="pln"> </span><span class="com">&lt;!-- insertion point for the rest of the news --&gt;</span><span class="pln">
    </span><span class="tag">&lt;/ul&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span></code></pre>
<p>Bob then styles the newborn widget according to comps from the designer by adding this to the shadow DOM subtree mockup:</p>
<pre class="prettyprint"><code><span class="pln">
</span><span class="tag">&lt;style&gt;</span><span class="pln">
    div</span><span class="pun">.</span><span class="pln">breaking </span><span class="pun">{</span><span class="pln">
        color</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Red</span><span class="pun">;</span><span class="pln">
        font</span><span class="pun">-</span><span class="pln">size</span><span class="pun">:</span><span class="pln"> </span><span class="lit">20px</span><span class="pun">;</span><span class="pln">
        border</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1px</span><span class="pln"> dashed </span><span class="typ">Purple</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
    div</span><span class="pun">.</span><span class="pln">other </span><span class="pun">{</span><span class="pln">
        padding</span><span class="pun">:</span><span class="pln"> </span><span class="lit">2px</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln">
        border</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1px</span><span class="pln"> solid </span><span class="typ">Cyan</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
</span><span class="tag">&lt;/style&gt;</span></code></pre>
<p>While pondering if his company should start looking for a new designer, Bob converts the mockup to code:</p>
<pre class="prettyprint"><code><span class="pln">
</span><span class="kwd">function</span><span class="pln"> createStoryGroup</span><span class="pun">(</span><span class="pln">className</span><span class="pun">,</span><span class="pln"> contentSelector</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> </span><span class="kwd">group</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'div'</span><span class="pun">);</span><span class="pln">
    </span><span class="kwd">group</span><span class="pun">.</span><span class="pln">className </span><span class="pun">=</span><span class="pln"> className</span><span class="pun">;</span><span class="pln">
    </span><span class="com">// Empty string in select attribute or absence thereof work the same, so no need for special handling.</span><span class="pln">
    </span><span class="kwd">group</span><span class="pun">.</span><span class="pln">innerHTML </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;ul&gt;&lt;content select="'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> contentSelector </span><span class="pun">+</span><span class="pln"> </span><span class="str">'"&gt;&lt;/content&gt;&lt;/ul&gt;'</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">group</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> createStyle</span><span class="pun">()</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> style </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'style'</span><span class="pun">);</span><span class="pln">
    style</span><span class="pun">.</span><span class="pln">scoped </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span><span class="pln">
    style</span><span class="pun">.</span><span class="pln">textContent </span><span class="pun">=</span><span class="pln"> </span><span class="str">'div.breaking { color: Red;font-size: 20px; border: 1px dashed Purple; }'</span><span class="pln"> </span><span class="pun">+</span><span class="pln">
        </span><span class="str">'div.other { padding: 2px 0 0 0; border: 1px solid Cyan; }'</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> style</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> makeShadowSubtree</span><span class="pun">(</span><span class="pln">storyList</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> root </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ShadowRoot</span><span class="pun">(</span><span class="pln">storyList</span><span class="pun">);</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStyle</span><span class="pun">());</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStoryGroup</span><span class="pun">(</span><span class="str">'breaking'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'.breaking'</span><span class="pun">));</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStoryGroup</span><span class="pun">(</span><span class="str">'other'</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">));</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

document</span><span class="pun">.</span><span class="pln">addEventListener</span><span class="pun">(</span><span class="str">'DOMContentLoaded'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="pun">[].</span><span class="pln">forEach</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="pln">document</span><span class="pun">.</span><span class="pln">querySelectorAll</span><span class="pun">(</span><span class="str">'ul.stories'</span><span class="pun">),</span><span class="pln"> makeShadowSubtree</span><span class="pun">);</span><span class="pln">
</span><span class="pun">});</span></code></pre>

<p>Well done, Bob! With the cup of coffee still half-full, the work is complete. Recognizing his awesomeness, Bob returns to teaching n00bs the ways of <a href="http://en.wikipedia.org/wiki/World_of_Warcraft">WoW</a>.</p>

<p>A few months pass.</p>

<p>It's election time. With Bob at his annual conference, Alice is charged with adding <strong>another</strong>, temporary box to the news widget, filled with election-related stories. Alice studies Bob's code, reads up on the shadow DOM spec and realizes that, thanks to multiple shadow DOM subtree support, she doesn't have to touch his code. As usual, her solution is elegant and simple, fitting neatly right under Bob's code:</p>
<pre class="prettyprint"><code><span class="pln">
</span><span class="com">// TODO(alice): BEGIN -- DELETE THIS CODE AFTER ELECTIONS ARE OVER.</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> ELECTION_BOX_REMOVAL_DEADLINE </span><span class="pun">=</span><span class="pln"> </span><span class="pun">...;</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> createElectionStyle</span><span class="pun">()</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> style </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'style'</span><span class="pun">);</span><span class="pln">
    style</span><span class="pun">.</span><span class="pln">scoped </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span><span class="pln">
    </span><span class="com">// TODO(alice): Check designer's desk for hallucinogens.</span><span class="pln">
    style</span><span class="pun">.</span><span class="pln">textContent </span><span class="pun">=</span><span class="pln"> </span><span class="str">'div.election { color: Magenta;font-size: 24px; border: 2px dotted Fuchsia; }'</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> style</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> makeElectionShadowSubtree</span><span class="pun">(</span><span class="pln">storyList</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> root </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ShadowRoot</span><span class="pun">(</span><span class="pln">storyList</span><span class="pun">);</span><span class="pln">
    </span><span class="com">// Add and style election story box.</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createElectionStyle</span><span class="pun">());</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStoryGroup</span><span class="pun">(</span><span class="str">'election'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'.election'</span><span class="pun">));</span><span class="pln">
    </span><span class="com">// Insert Bob's shadow tree under the election story box.</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'shadow'</span><span class="pun">));</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Date</span><span class="pun">.</span><span class="pln">now</span><span class="pun">()</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> ELECTION_BOX_REMOVAL_DEADLINE</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    document</span><span class="pun">.</span><span class="pln">addEventListener</span><span class="pun">(</span><span class="str">'DOMContentLoaded'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="pun">[].</span><span class="pln">forEach</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="pln">document</span><span class="pun">.</span><span class="pln">querySelectorAll</span><span class="pun">(</span><span class="str">'ul.stories'</span><span class="pun">),</span><span class="pln"> makeElectionShadowSubtree</span><span class="pun">);</span><span class="pln">
    </span><span class="pun">});</span><span class="pln">
</span><span class="pun">}</span><span class="pln">
</span><span class="com">// TODO(alice): END -- DELETE THIS CODE AFTER ELECTIONS ARE OVER.</span></code></pre>
<p>Using the <code>shadow</code> element allows Alice to compose Bob's widget <strong>inside</strong> of hers—without having to change a line of production code. Smiling to herself, Alice realizes that Bob may have come up with a way to keep the document markup clean, but <strong>she</strong> is the one who takes the cake for using shadow DOM subtree composition in such a cool way.</p>

</section>


<h2 id="acknowledgements">Acknowledgements</h2>

<p><span class="vcard">David Hyatt</span> developed <a href="http://dev.w3.org/2006/xbl2/">XBL 1.0</a>, and <span class="vcard">Ian Hickson</span> co-wrote <a href="http://dev.w3.org/2006/xbl2/">XBL 2.0</a>. These documents provided tremendous insight into the problem of functional encapsulation and greatly influenced this specification.</p>

<p><span class="vcard">Alex Russell</span> and his considerable forethought triggered a new wave of enthusiasm around the subject of shadow DOM and how it can be applied practically on the Web.</p>

<p><span class="vcard">Dominic Cooney</span>, <span class="vcard">Hajime Morrita</span>, and <span class="vcard">Roland Steiner</span> worked tirelessly to scope the problem of functional encapsulation within the confines of the Web platform and provided a solid foundation for this document.</p>

<p>The editor would also like to thank <span class="vcard">Alex Komoroske</span>, <span class="vcard">Anne van Kesteren</span>, <span class="vcard">Brian Kardell</span>, <span class="vcard">Darin Fisher</span>, <span class="vcard">Deepak Sherveghar</span>, <span class="vcard">Edward O'Connor</span>, <span class="vcard">Elisée Maurer</span>, <span class="vcard">Erik Arvidsson</span>, <span class="vcard">Glenn Adams</span>, <span class="vcard">Hayato Ito</span>, <span class="vcard">Jonas Sicking</span>, <span class="vcard">Malte Ubl</span>, <span class="vcard">Oliver Nightingale</span>, <span class="vcard">Olli Pettay</span>, <span class="vcard">Rafael Weinstein</span>, <span class="vcard">Richard Bradshaw</span>, <span class="vcard">Ruud Steltenpool</span>, <span class="vcard">Sam Dutton</span>, <span class="vcard">Shinya Kawanaka</span>, <span class="vcard">Tab Atkins</span>, and <span class="vcard">Takashi Sakamoto</span> for their comments and contributions to this specification.</p>

<p>This list is too short. There's a lot of work left to do. Please contribute by reviewing and filing bugs—and don't forget to ask the editor to add your name into this section.</p>



</body></html>
<!DOCTYPE html>
<html lang="en"><head>
<title>Shadow DOM</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<link rel="stylesheet" href="spec.css" type="text/css">
<link rel="stylesheet" href="prettify.css" type="text/css">
<link rel="stylesheet" href="http://www.w3.org/StyleSheets/TR/W3C-WD" type="text/css">
</head>

<body>

<div class="head">

<div class="logo">
    <a href="http://www.w3.org/"><img width="72" height="48" src="http://www.w3.org/Icons/w3c_home" alt="W3C"></a>
</div>

<h1>Shadow DOM</h1>
<h2 id="working-draft">W3C Working Draft 14 May 2013</h2>
<dl>
<dt>This version</dt>
    <dd><a href="http://www.w3.org/TR/2013/WD-shadow-dom-20130514/">http://www.w3.org/TR/2013/WD-shadow-dom-20130514/</a></dd>
<dt>Latest version</dt>
    <dd><a href="http://www.w3.org/TR/shadow-dom/">http://www.w3.org/TR/shadow-dom/</a></dd>
<dt>Latest editor's draft</dt>
    <dd><a href="http://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/shadow/index.html">http://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/shadow/index.html</a></dd>
<dt>Previous version</dt>
    <dd><a href="http://www.w3.org/TR/2012/WD-shadow-dom-20121016/">http://www.w3.org/TR/2012/WD-shadow-dom-20121016/</a></dd>
<dt>Revision history</dt>
    <dd><a id="log" href="https://dvcs.w3.org/hg/webcomponents/log/tip/spec/shadow/index.html">https://dvcs.w3.org/hg/webcomponents/log/tip/spec/shadow/index.html</a></dd>
<dt>Participate</dt>
    <dd>Discuss on <a href="http://lists.w3.org/Archives/Public/public-webapps/">public-webapps@w3.org</a> (<a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a>)</dd>
    <dd><a href="https://www.w3.org/Bugs/Public/enter_bug.cgi?comment=&amp;blocked=14978&amp;short_desc=%5BShadow%5D%3A%20&amp;product=WebAppsWG&amp;component=Component%20Model">File bugs</a> (w3.org's <a href="https://www.w3.org/Bugs/Public/">Bugzilla</a>)</dd>
<dt>Editor</dt>
    <dd class="vcard"><span class="fn">Dimitri Glazkov</span>, <span class="org">Google</span>, &lt;<a class="email" href="mailto:dglazkov@chromium.org">dglazkov@chromium.org</a>&gt;</dd>
</dl>

<p class="copyright"><a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © 2013 <a href="http://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>®</sup> (<a href="http://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>, <a href="http://www.ercim.eu/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>, <a href="http://www.keio.ac.jp/">Keio</a>, <a href="http://ev.buaa.edu.cn/">Beihang</a>), All Rights Reserved. W3C <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>, <a href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and <a href="http://www.w3.org/Consortium/Legal/copyright-documents">document use</a> rules apply.</p>

<hr>

<h2 id="abstract">Abstract</h2>

<p>This specification describes a method of establishing and maintaining functional boundaries between DOM trees and how these trees interact with each other within a document, thus enabling better functional encapsulation within the DOM.</p>

<h2 id="status">Status of This Document</h2>

<p><em>This section describes the status of this document at the time of its publication. Other documents may supersede this document. A list of current <abbr title="World Wide Web Consortium">W3C</abbr> publications and the latest revision of this technical report can be found in the <a href="http://www.w3.org/TR/"><abbr title="World Wide Web Consortium">W3C</abbr> technical reports index</a> at http://www.w3.org/TR/.</em></p>

<p>This document was published by the <a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a> as a Working Draft. If you wish to make comments regarding this document, please send them to <a href="mailto:public-webapps@w3.org">public-webapps@w3.org</a> (<a href="mailto:public-webapps-request@w3.org?subject=subscribe">subscribe</a>, <a href="http://lists.w3.org/Archives/Public/public-webapps/">archives</a>). All feedback is welcome.</p><p>Publication as a Working Draft does not imply endorsement by the <abbr title="World Wide Web Consortium">W3C</abbr> Membership. This is a draft document and may be updated, replaced or obsoleted by other documents at any time. It is inappropriate to cite this document as other than work in progress.</p>

<p>This document was produced by a group operating under the <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004 <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>. <abbr title="World Wide Web Consortium">W3C</abbr> maintains a <a href="http://www.w3.org/2004/01/pp-impl/42538/status" rel="disclosure">public list of any patent disclosures</a> made in connection with the deliverables of the group; that page also includes instructions for disclosing a patent. An individual who has actual knowledge of a patent which the individual believes contains <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential Claim(s)</a> must disclose the information in accordance with <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section 6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>.</p>

</div>

<section class="toc">
<h2 id="toc">Table of Contents</h2>
<ol>
    <li><a href="#about"><span class="section">1</span> About this Document</a></li>
    <li><a href="#dependencies"><span class="section">2</span> Dependencies</a></li>
    <li><a href="#introduction"><span class="section">3</span> Introduction</a>
    <ol>
        <li><a href="#functional-encapsulation-example"><span class="section">3.1</span> Functional Encapsulation Example</a></li>
    </ol></li>
    <li><a href="#shadow-trees"><span class="section">4</span> Shadow Trees</a>
    <ol>
        <li><a href="#upper-boundary-encapsulation"><span class="section">4.1</span> Upper-boundary Encapsulation</a></li>
        <li><a href="#lower-boundary-encapsulation"><span class="section">4.2</span> Lower-boundary Encapsulation</a></li>
        <li><a href="#satisfying-matching-criteria"><span class="section">4.3</span> Satisfying Matching Criteria</a></li>
        <li><a href="#distributed-pseudo-element"><span class="section">4.4</span> <code>::distributed()</code> pseudo-element</a></li>
        <li><a href="#multiple-shadow-trees"><span class="section">4.5</span> Hosting Multiple Shadow Trees</a></li>
        <li><a href="#reprojection"><span class="section">4.6</span> Reprojection</a></li>
        <li><a href="#composition"><span class="section">4.7</span> Composition</a></li>
        <li><a href="#nested-shadow-trees"><span class="section">4.8</span> Nested Shadow Trees</a></li>
        <li><a href="#rendering-shadow-trees"><span class="section">4.9</span> Rendering Shadow Trees</a></li>
        <li><a href="#custom-pseudo-elements"><span class="section">4.10</span> Custom Pseudo-elements</a></li>
    </ol></li>
    <li><a href="#events"><span class="section">5</span> Events</a>
    <ol>
        <li><a href="#event-retargeting"><span class="section">5.1</span> Event Retargeting</a></li>
        <li><a href="#retargeting-related-target"><span class="section">5.2</span> Retargeting <code>relatedTarget</code></a></li>
        <li><a href="#retargeting-focus-events"><span class="section">5.3</span> Retargeting Focus Events</a></li>
        <li><a href="#events-that-are-always-stopped"><span class="section">5.4</span> Events that are Always Stopped</a></li>
        <li><a href="#event-dispatch"><span class="section">5.5</span> Event Dispatch</a></li>
        <li><a href="#event-retargeting-example"><span class="section">5.6</span> Event Retargeting Example</a></li>
    </ol></li>
    <li><a href="#styles"><span class="section">6</span> Styles</a>
    <ol>
        <li><a href="#css-variables"><span class="section">6.1</span> CSS Variables</a></li>
        <li><a href="#text-decoration-property"><span class="section">6.2</span> <code>text-decoration</code> Property</a></li>
        <li><a href="#host-at-rule"><span class="section">6.3</span> <code>@host</code> @-rule</a></li>
    </ol></li>
    <li><a href="#user-interaction"><span class="section">7</span> User Interaction</a>
    <ol>
        <li><a href="#ranges-and-selection"><span class="section">7.1</span> Ranges and Selections</a></li>
        <li><a href="#focus-navigation"><span class="section">7.2</span> Focus Navigation</a></li>
        <li><a href="#active-element"><span class="section">7.3</span> Active Element</a></li>
        <li><a href="#editing"><span class="section">7.4</span> Editing</a></li>
        <li><a href="#assistive-technology"><span class="section">7.5</span> Assistive Technology</a></li>
    </ol>
    </li>
    <li><a href="#html-elements"><span class="section">8</span> HTML Elements in Shadow Trees</a>
    <ol>
        <li><a href="#inert-html-elements"><span class="section">8.1</span> Inert HTML Elements</a></li>
        <li><a href="#html-forms"><span class="section">8.2</span> HTML Forms</a></li>
    </ol></li>
    <li><a href="#html-elements-and-their-shadow-trees"><span class="section">9</span> HTML Elements and Their Shadow Trees</a>
    <li><a href="#elements-and-dom-objects"><span class="section">10</span> Elements and DOM Objects</a>
    <ol>
        <li><a href="#shadow-root-object"><span class="section">10.1</span> <code>ShadowRoot</code> Object</a>
        <ol>
            <li><a href="#shadow-root-attributes"><span class="section">10.1.1</span> <code>ShadowRoot</code> Attributes</a></li>
            <li><a href="#shadow-root-methods"><span class="section">10.1.2</span> <code>ShadowRoot</code> Methods</a></li>
        </ol></li>
        <li><a href="#extensions-to-element"><span class="section">10.2</span>  Extensions to <code>Element</code> Interface</a>
        <ol>
            <li><a href="#partial-element-attributes"><span class="section">10.2.1</span> Attributes</a></li>
            <li><a href="#partial-element-methods"><span class="section">10.2.2</span> Methods</a></li>
        </ol></li>
        <li><a href="#css-host-rule-interface"><span class="section">10.3</span> <code>CSSHostRule</code> Interface</a>
        <ol>
            <li><a href="#css-host-rule-attributes"><span class="section">10.3.1</span> <code>CSSHostRule</code> Attributes</a></li>
            <li><a href="#css-host-rule-methods"><span class="section">10.3.2</span> <code>CSSHostRule</code> Methods</a></li>
        </ol></li>
        <li><a href="#content-element"><span class="section">10.4</span> The <code>content</code> HTML element</a></li>
        <li><a href="#shadow-element"><span class="section">10.5</span> The <code>shadow</code> HTML element</a></li>
    </ol></li>
    <li><a href="#shadow-dom-example"><span class="section">11</span> Shadow DOM Example</a></li>
    <li><a href="#acknowledgements">Acknowledgements</a></li>
</ol>

</section>

<section class="math">

<h2 id="about">About this Document</h2>

<p>All diagrams, examples, notes, are non-normative, as well as sections explicitly marked as non-normative. Everything else in this specification is normative.</p>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in the normative parts of this document are to be interpreted as described in <a href="http://dev.w3.org/2006/xbl2/#refsRFC2119">RFC2119</a>. For readability, these words do not appear in all uppercase letters in this specification.</p>

<p>To help with layering and to avoid circular dependencies between various parts of specification, this document consists of three consecutive narratives:
<ol>
    <li>setting up the stage for the specification,</li>
    <li>explaining of the conceptual model and algorithms behind it, and</li>
    <li>expressing this model with DOM interfaces and HTML elements.</li>
</ol>
<p>In a sense, these parts can be viewed as <em>math</em>, which sets up the reasoning environment, <em>physics</em>, which is the theoretical reasoning about the concept, and <em>mechanics</em>, which is the practical application of this reasoning.</p>

<p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="http://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence">processing equivalence</dfn> is a constraint imposed on the algorithm implementors, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>

<h2 id="dependencies">Dependencies</h2>

<p>This document relies on the following specifications:</p>

<ul>
    <li><a href="http://www.w3.org/TR/CSS2/">CSS Level 2 Revision 1</a></li>
    <li><a href="http://www.w3.org/TR/cssom/">CSSOM</a></li>
    <li><a href="http://www.w3.org/TR/DOM-Level-3-Events/">DOM Level 3 Events</a></li>
    <li><a href="http://www.w3.org/TR/domcore/">DOM4 (DOM Core)</a></li>
    <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/">HTML</a></li>
    <li><a href="http://html5.org/specs/dom-parsing.html">DOM Parsing and Serialization</a></li>
    <li><a href="http://www.w3.org/TR/selectors/">Selectors Level 3</a></li>
    <li><a href="http://dev.w3.org/2006/webapi/selectors-api/">Selectors API Level 1</a></li>
</ul>

</section>

<section class="physics">

<h2 id="introduction">Introduction</h2>

<p>Web application developers often encounter the need to provide <a href="http://en.wikipedia.org/wiki/Encapsulation_(object-oriented_programming)">encapsulation</a> within a <a href="http://www.w3.org/TR/domcore/#introduction-to-the-dom">DOM</a> <a href="http://www.w3.org/TR/domcore/#concept-tree">tree</a>. Despite being part of one <dfn id="dfn-document-tree">document tree</dfn> (a <a href="http://www.w3.org/TR/domcore/#concept-tree">tree</a> that has <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> as its <a href="http://www.w3.org/TR/domcore/#concept-tree-root">root</a>), there are typically many functional <a href="http://www.w3.org/TR/domcore/#trees">tree</a> fragments, as well as assumptions about these fragments operating independently. This specification calls this type of encapsulation a  <dfn id="dfn-functional-encapsulation">functional encapsulation</dfn>, as opposed to <dfn id="dfn-trust-encapsulation">trust encapsulation</dfn>, which deals with limiting information flow based on trust and ensuring security of data and state within an application.</p>

<p><a href="#dfn-functional-encapsulation">Functional encapsulation</a> is primarily concerned with establishing functional boundaries in a <a href="#dfn-document-tree">document tree</a>. A functional boundary (or just <dfn id="dfn-boundary">boundary</dfn> hereon) is a delineation of functional concerns between two loosely coupled units of functionality.</p>

<h3 id="functional-encapsulation-example">Functional Encapsulation Example</h3>

<p>A Web application user interface is commonly composed of several user interface elements (or <dfn id="dfn-widget">widgets</dfn>), each functionally its own tree. In cases where a widget is tasked with hosting other widgets, the need arises for the widget to understand where its <a href="http://www.w3.org/TR/domcore/#trees">tree</a> ends and another widget's <a href="http://www.w3.org/TR/domcore/#trees">tree</a> begins.</p>

<object data="functional-encapsulation-example.svg" width="800" height="500"></object>

<p>This need for observing the functional <a href="#dfn-boundary">boundaries</a> in a <a href="#dfn-document-tree">document tree</a> is even larger when a <a href="#dfn-widget">widget</a> is operated on&mdash;added, moved, or removed in the <a href="#dfn-document-tree">document tree</a>&mdash;by an outside actor, such as the Web application that consumes these widgets. Unless the widget consumer knows exactly how a <a href="#dfn-widget">widget</a>'s <a href="http://www.w3.org/TR/domcore/#trees">tree</a> is designed, it is impossible for the consumer to reasonably operate on the widget. A typical workaround has been providing alternative means of operation by the widget developer, which, in striving for API consistency quickly extrapolates into a complete set of widget-specific, <a href="http://www.w3.org/TR/domcore/#introduction-to-the-dom">DOM</a>-like APIs.</p>

<h2 id="shadow-trees">Shadow Trees</h2>

<p>To solve this problem at its core, a new abstraction is introduced. The <dfn id="dfn-shadow-dom">shadow DOM</dfn> allows multiple <a href="http://www.w3.org/TR/domcore/#introduction-to-the-dom">DOM</a> trees (in addition to the <a href="#dfn-document-tree">document tree</a>) to be composed into one larger <a href="http://www.w3.org/TR/domcore/#trees">tree</a> when rendered. The existence of multiple <a href="http://www.w3.org/TR/domcore/#introduction-to-the-dom">DOM</a> trees is enabled by letting any <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> in the <a href="#dfn-document-tree">document tree</a> to host one or more additional <a href="http://www.w3.org/TR/domcore/#introduction-to-the-dom">DOM</a> trees. These <dfn id="dfn-shadow-tree">shadow trees</dfn> are governed by a set of rules that establish encapsulation <a href="#dfn-boundary">boundaries</a> while retaining the standard <a href="http://www.w3.org/TR/domcore/#introduction-to-the-dom">DOM</a> composability semantics.</p>

<p>The encapsulation <a href="#dfn-boundary">boundaries</a> between the <a href="#dfn-document-tree">document tree</a> and <a href="#dfn-shadow-tree">shadow trees</a> are called <dfn id="dfn-shadow-boundary">shadow boundaries</dfn>. The <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a> that host <a href="#dfn-shadow-tree">shadow trees</a> are called <dfn id="dfn-shadow-host">shadow hosts</dfn>, and the <a href="http://www.w3.org/TR/domcore/#concept-tree-root">roots</a> of the <a href="#dfn-shadow-tree">shadow trees</a> are called <dfn id="dfn-shadow-root">shadow roots</dfn>.</p>

<object data="shadow-trees.svg" width="800" height="430"></object>

<p>When rendered, the <a href="#dfn-shadow-tree">shadow tree</a> takes place of the <a href="#dfn-shadow-host">shadow host</a>'s content.</p>

<object data="shadow-rendering.svg" width="450" height="400"></object>

<p>To enable composition of <a href="#dfn-shadow-host">shadow host</a>'s children and the <a href="#dfn-shadow-tree">shadow tree</a>, a notion of insertion points is added to the abstraction. An <dfn id="dfn-insertion-point">insertion point</dfn> is a defined location in the <a href="#dfn-shadow-tree">shadow tree</a>, to which the <a href="#dfn-shadow-host">shadow host</a>'s children are transposed when rendering. The mechanism that determines which <a href="#dfn-shadow-host">shadow host</a>'s children are transposed into which <a href="#dfn-insertion-point">insertion points</a> is called <dfn id="dfn-distribution">distribution</dfn>.</p>

<object data="insertion-points.svg" width="800" height="900"></object>

<p>Thus, the encapsulation of a <a href="#dfn-shadow-tree">shadow tree</a> can be viewed as a two-fold problem:
<ol>
    <li>the <dfn id="dfn-upper-boundary-encapsulation">upper-boundary encapsulation</dfn>, or governing the boundary between the shadow root and the shadow host; and</li>
    <li>the <dfn id="dfn-lower-boundary-encapsulation">lower-boundary encapsulation</dfn>, or governing the boundary between the insertion points and the shadow host's children.</li>
</ol>

<h3 id="upper-boundary-encapsulation">Upper-boundary Encapsulation</h3>

<p>To maintain the upper-boundary encapsulation, the following <dfn id="dfn-scoping-constraints">scoping constraints</dfn> <strong>must</strong> apply to all <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> in a <a href="#dfn-shadow-tree">shadow tree</a>:</p>
<ul>
    <li>The <a href="http://www.w3.org/TR/domcore/#dom-node-ownerdocument"><code>ownerDocument</code></a> property refers to the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> of the <a href="#dfn-shadow-host">shadow host</a></li>
    <li>The <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-document-nameditem-filter">named elements</a> <strong>are not</strong> accessible using <a href="#dfn-shadow-host">shadow host</a>'s <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-tree-accessors">DOM tree accessors</a> or with <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#window">Window</a> object <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#named-access-on-the-window-object">named properties</a></li>
    <li>The <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> <strong>are not</strong> present in any of the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a>'s <a href="http://www.w3.org/TR/dom/#interface-nodelist"><code>NodeList</code></a>, <a href="http://www.w3.org/TR/dom/#interface-htmlcollection"><code>HTMLCollection</code></a>, or <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#domelementmap-0"><code>DOMElementMap</code></a> instances</li>
    <li>The <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> with a unique <a href="http://www.w3.org/TR/domcore/#concept-id">id</a> and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-document-nameditem-filter">named elements</a> <strong>are not</strong> addressable from any attributes of <a href="http://www.w3.org/TR/domcore/#element">elements</a> in <a href="#dfn-shadow-host">shadow host</a>'s <a href="http://www.w3.org/TR/domcore/#concept-document">document</a></li>
    <li>The style sheets, represented by the <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> <strong>are not</strong> accessible using <a href="#dfn-shadow-host">shadow host</a> <a href="http://www.w3.org/TR/domcore/#concept-document">document</a>'s <a href="http://www.w3.org/TR/cssom/#extensions-to-the-document-interface">CSSOM extensions</a></li>
    <li>The <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> <strong>are</strong> accessible using <a href="#dfn-shadow-root">shadow root</a>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-tree-accessors">DOM tree accessor</a> methods</li>
    <li>The <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> with a unique <a href="http://www.w3.org/TR/domcore/#concept-id">id</a> and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-document-nameditem-filter">named elements</a> <strong>are</strong> addressable from any attributes of <a href="http://www.w3.org/TR/domcore/#element">elements</a> in the same <a href="#dfn-shadow-tree">shadow tree</a></li>
    <li>The <a href="http://www.w3.org/TR/selectors/">selectors</a> <strong>must not</strong> cross the <a href="#dfn-shadow-boundary">shadow boundary</a> from the <a href="#dfn-document-tree">document tree</a> into the <a href="#dfn-shadow-tree">shadow tree</a></li>
</ul>
<p>For convenience, the <a href="#dfn-shadow-root">shadow root</a> provides its own set of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-tree-accessors">DOM tree accessor</a> methods. No <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> other than <a href="#dfn-shadow-root">shadow root</a> descendants are accessible with these methods.</p>

<p>The <a href="http://www.w3.org/TR/dom/#dom-node-parentnode"><code>parentNode</code></a> and <a href="http://www.w3.org/TR/dom/#dom-node-parentelement"><code>parentElement</code></a> attributes of the <a href="#dfn-shadow-root">shadow root</a> object <strong>must</strong> always return <code>null</code>.</p>

<h3 id="lower-boundary-encapsulation">Lower-boundary Encapsulation</h3>

<p>To maintain the lower-boundary encapsulation, the <a href="#dfn-distribution">distribution</a> of child <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> of the <a href="#dfn-shadow-host">shadow host</a> among the <a href="#dfn-insertion-point">insertion points</a> in the associated <a href="#dfn-shadow-tree">shadow tree</a> <strong>must</strong> have the following traits:</p>
<ul>
    <li>The <a href="#dfn-distribution">distribution</a> does not affect the state of the <a href="#dfn-document-tree">document tree</a> or <a href="#dfn-shadow-tree">shadow trees</a></li>
    <li>Each insertion point participates in <a href="#dfn-distribution">distribution</a> by providing a matching criteria for the child nodes. The <dfn id="dfn-matching-criteria">matching criteria</dfn> determines whether a given  <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> could be <a href="#dfn-distribution">distributed</a> to a given insertion point</li>
    <li>The <a href="#dfn-distribution">distribution</a> is a result of executing a stable algorithm</li>
    <li>The <a href="#dfn-distribution">distribution</a> itself does not change the variables affecting the <a href="#dfn-distribution">distribution</a></li>
    <li>The <a href="#dfn-distribution">distribution</a> reoccurs whenever any variable affecting it is changed</li>
</ul>

<p>An <a href="#dfn-insertion-point">insertion point</a> may be <strong>active</strong> or <strong>inactive</strong>. An <dfn id="dfn-active-insertion-point">active</dfn> insertion point participates in the <a href="#dfn-distribution">distribution</a> process, whereas the <dfn id="dfn-inactive-insertion-point">inactive</dfn> insertion does not. If not specifically set to be inactive, the insertion point <strong>must</strong> be considered <strong>active</strong>.</p>

<p>If an <a href="#dfn-insertion-point">insertion point</a> is not in a <a href="#dfn-shadow-tree">shadow tree</a>, it <strong>must</strong> have the same rendering behavior as the <a href="http://www.whatwg.org/specs/web-apps/current-work/#htmlunknownelement"><code>HTMLUnknownElement</code></a>.</p>

<p>The <dfn id="dfn-distribution-algorithm">distribution algorithm</dfn> <strong>must</strong> produce an outcome that is <a href="#dfn-processing-equivalence">equivalent</a> of the outcome of processing these steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>TREE</var>, a <a href="#dfn-shadow-tree">shadow tree</a></dd>
    <dd><var>POOL</var>, a list of <a href="http://www.w3.org/TR/domcore/#introduction-to-the-dom">DOM</a> nodes</dd>
<dt>Output</dt>
    <dd>The <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> in <var>POOL</var> are <a href="#dfn-distribution">distributed</a> among <a href="#dfn-insertion-point">insertion points</a> in <var>TREE</var>.</dd>
</dl>

<ol>
    <li><dfn id="algo-distribution-repeat-outer">Repeat</dfn> for each <a href="#dfn-active-insertion-point">active</a> <a href="#dfn-insertion-point">insertion point</a> in <var>TREE</var>, in <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#tree-order">tree order</a>:
    <ol>
        <li>Let <var>POINT</var> be the current insertion point</li>
        <li><dfn id="algo-distribution-repeat">Repeat</dfn> for each <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> in <var>POOL</var>:
        <ol>
            <li>Let <var>NODE</var> be the current <a href="http://www.w3.org/TR/domcore/#concept-node">node</a></li>
            <li>If the <var>NODE</var> <a href="#dfn-satisfies-matching-criteria">satisfies</a> <var>POINT</var>'s <a href="#dfn-matching-criteria">matching criteria</a>:
                <ol>
                    <li><a href="#dfn-distribution">Distribute</a> the <var>NODE</var> to <var>POINT</var></li>
                    <li>Remove <var>NODE</var> from the <var>POOL</var></li>
                </ol></li>
            <li>Otherwise, continue to <a href="#algo-distribution-repeat">repeat</a></li>
        </ol></li>
        <li>Continue to <a href="#algo-distribution-repeat-outer">repeat</a></li>
    </ol></li>
</ol>
</div>

<h3 id="satisfying-matching-criteria">Satisfying Matching Criteria</h3>

<p>The <a href="#dfn-matching-criteria">matching criteria</a> for an <a href="#dfn-insertion-point">insertion point</a> is a set of <a href="http://dev.w3.org/csswg/selectors4/#compound">compound selectors</a>. These <a href="http://dev.w3.org/csswg/selectors4/#compound">compound selectors</a> are restricted to contain only these <a href="http://dev.w3.org/csswg/selectors4/#simple">simple selectors</a>:</p>

<ul>
    <li>A <a href="http://dev.w3.org/csswg/selectors4/#type-selector">type selector</a> or a <a href="http://dev.w3.org/csswg/selectors4/#universal-selector0">universal selector</a></li>
    <li><a href="http://dev.w3.org/csswg/selectors4/#class-selector">class selector(s)</a></li>
    <li>An <a href="http://dev.w3.org/csswg/selectors4/#id-selector">ID selector</a></li>
    <li><a href="http://dev.w3.org/csswg/selectors4/#attribute-selector">attribute selector(s)</a></li>
<!--     <li>the following <a href="http://www.w3.org/TR/css3-selectors/#pseudo-classes">pseudo-class selector(s)</a>:
        <ul>
            <li><code>:link</code></li>
            <li><code>:visited</code></li>
            <li><code>:target</code></li>
            <li><code>:enabled</code></li>
            <li><code>:disabled</code></li>
            <li><code>:checked</code></li>
            <li><code>:indeterminate</code></li>
            <li><code>:nth-child()</code></li>
            <li><code>:nth-last-child()</code></li>
            <li><code>:nth-of-type()</code></li>
            <li><code>:nth-last-of-type()</code></li>
            <li><code>:first-child</code></li>
            <li><code>:last-child</code></li>
            <li><code>:first-of-type</code></li>
            <li><code>:last-of-type</code></li>
            <li><code>:only-of-type</code></li>
        </ul>
    </li> -->
</ul>

<p>A <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> <dfn id="dfn-satisfies-matching-criteria">satisfies</dfn> a <a href="#dfn-matching-criteria">matching criteria</a> only if:
<ol>
    <li>all <a href="http://dev.w3.org/csswg/selectors4/#compound">compound selectors</a> in the set, contain only the <a href="http://dev.w3.org/csswg/selectors4/#simple">simple selectors</a> specified above; and</li>
    <li>a <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> matches at least one <a href="http://dev.w3.org/csswg/selectors4/#compound">compound selectors</a> in the set or the set is empty.</li>
</ol>

<h3 id="distributed-pseudo-element"><code>::distributed()</code> pseudo-element</h3>

<p>The <dfn id="dfn-distributed-pseudo-element">::distributed(selector)</dfn> is a functional pseudo-element taking a <a href="http://www.w3.org/TR/selectors-api2/#relative-selector">relative selector</a> as an argument. It represents a relationship between an <a href="#dfn-insertion-point">insertion point</a> in a <a href="#dfn-shadow-tree">shadow tree</a> and an <a href="http://dom.spec.whatwg.org/#concept-element">element</a> whose <a href="http://dom.spec.whatwg.org/#concept-tree-inclusive-ancestor">inclusive ancestor</a> is <a href="#dfn-distribution">distributed</a> into that <a href="#dfn-insertion-point">insertion point</a>. The argument is <a href="http://dev.w3.org/csswg/selectors4/#scope-contained-selectors">scope-contained-selectors</a>, with the <a href="http://dev.w3.org/csswg/selectors4/#reference-element-set">reference element set</a> initialized to the <a href="http://dom.spec.whatwg.org/#concept-tree-parent">parent</a> of the <a href="">element</a>, distributed to the <a href="#dfn-insertion-point">insertion point</a>.</p>

<div class="informative">
<p>For example, the following selector represents the all <code>div</code> elements that that are descendants of an element, distributed into an insertion point</p>
<pre><code class="prettyprint">
    ::distributed(div)
</code></pre>
<p>This selector represents all child <code>span</code> elements that are distrubted into insertion points with class attribute <code>victory</code></p>
<pre><code class="prettyprint">
    .victory::distributed(>span)
</code></pre>
</div>

<p class="fixme">Should reference element set be insertion point or parent?</p>

<p>All other types of selectors <strong>must not</strong> cross the <a href="#dfn-shadow-boundary">shadow boundary</a> from a <a href="#dfn-shadow-tree">shadow tree</a> to the <a href="http://www.w3.org/TR/domcore/#trees">tree</a> of its <a href="#dfn-shadow-host">shadow host</a>.</p>

<h3 id="multiple-shadow-trees">Hosting Multiple Shadow Trees</h3>

<p>A <a href="#dfn-shadow-host">shadow host</a> may host more than one <a href="#dfn-shadow-tree">shadow tree</a>. In such cases, the trees are stacked in the order they were added the host, starting with the <a href="http://www.w3.org/TR/domcore/#trees">tree</a> added most recently. This set of trees is called a <dfn id="dfn-tree-stack">tree stack</dfn>. The more recently added <a href="http://www.w3.org/TR/domcore/#trees">tree</a> is called the <dfn id="dfn-younger-tree">younger tree</dfn>, and the less recently added <a href="http://www.w3.org/TR/domcore/#trees">tree</a> is called the <dfn id="dfn-older-tree">older tree</dfn>. The most recently added <a href="http://www.w3.org/TR/domcore/#trees">tree</a> is called the <dfn id="dfn-youngest-tree">youngest tree</dfn>.</p>

<p>To facilitate composing multiple shadow trees of the same host, a special kind of <a href="#dfn-insertion-point">insertion point</a> is defined. The <dfn id="dfn-shadow-insertion-point">shadow insertion point</dfn> designates a place in the <a href="#dfn-shadow-tree">shadow tree</a>, where an <a href="#dfn-older-tree">older tree</a> is inserted when rendering. If multiple <a href="#dfn-shadow-insertion-point">shadow insertion points</a> exist in a <a href="#dfn-shadow-tree">shadow tree</a>, only the first, in <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#tree-order">tree order</a>, is recognized. It is said that the <a href="#dfn-shadow-tree">shadow tree</a> is <dfn id="dfn-assigned">assigned</dfn> to a <a href="#dfn-shadow-insertion-point">shadow insertion point</a> if the <a href="#dfn-shadow-tree">shadow tree</a> is rendered in place of this <a href="#dfn-shadow-insertion-point">shadow insertion point</a>.</p>

<p>Just like other <a href="#dfn-insertion-point">insertion points</a>, the <a href="#dfn-shadow-insertion-point">shadow insertion points</a> can be <a href="#dfn-active-insertion-point">active</a> or <a href="#dfn-inactive-insertion-point">inactive</a>.</p>

<h3 id="reprojection">Reprojection</h3>

<p>One case that deserves special consideration is the situation when an <a href="#dfn-insertion-point">insertion point</a> is a child <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> of another <a href="#dfn-shadow-host">shadow host</a>. In such situations, the <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> <a href="#dfn-distribution">distributed</a> into that <a href="#dfn-insertion-point">insertion point</a> <strong>must</strong> appear as if they were child <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> of the <a href="#dfn-shadow-host">shadow host</a> in the context of <a href="#dfn-distribution">distribution</a> within the <a href="#dfn-shadow-tree">shadow tree</a>, hosted by said <a href="#dfn-shadow-host">shadow host</a>. Thus, the <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> <a href="#dfn-distribution">distributed</a> to a <a href="#dfn-shadow-tree">shadow tree</a> could have already been <a href="#dfn-distribution">distributed</a> by the <a href="#dfn-nesting-tree">nesting</a> tree. The effect of a <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> being <a href="#dfn-distribution">distributed</a> into more than one <a href="#dfn-insertion-point">insertion point</a> is called <dfn id="dfn-reprojection">reprojection</dfn>.</p>

<div class="informative">
Despite being distributed to more than one insertion point during reprojection, a node is still only rendered once, because of the constraints under which the reprojection occurs: since the insertion points are only subject to reprojection when they are children of a shadow host, they are never rendered. Instead the shadow tree is rendered in their place.
</div>

<h3 id="composition">Composition</h3>

<p>The composition of <a href="#dfn-shadow-tree">shadow trees</a> for a given <a href="#dfn-shadow-host">shadow host</a> is performed with the <dfn id="dfn-tree-composition">tree composition algorithm</dfn>, which <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:


<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>HOST</var>, a <a href="#dfn-shadow-host">shadow host</a></dd>
<dt>Output</dt>
    <dd>All <a href="#dfn-insertion-point">insertion points</a> and <a href="#dfn-shadow-insertion-point">shadow insertion points</a> are populated.</dd>
</dl>

<ol>
    <li>Let <var>TREE</var> be the <a href="#dfn-youngest-tree">youngest tree</a> in the <var>HOST</var>'s <a href="#dfn-tree-stack">tree stack</a>
    <li>Let <var>POOL</var> be an empty list of nodes</li>
    <li>For each child <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> of <var>HOST</var>:
    <ol>
        <li>Let <var>CHILD</var> be this node</li>
        <li>If <var>CHILD</var> is an <a href="#dfn-insertion-point">insertion point</a>:
        <ol>
            <li>Let <var>REPROJECTED</var> be the list of nodes, distributed into this <a href="#dfn-insertion-point">insertion point</a> as a result of running <a href="#dfn-tree-composition">tree composition algorithm</a> on this <a href="#dfn-insertion-point">insertion point</a>'s <a href="#dfn-shadow-tree">shadow tree</a></li>
            <li>If <var>REPROJECTED</var> is an empty list, set it to the list of all child <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> of <var>CHILD</var>
            <li>Add all <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> in <var>REPROJECTED</var> into <var>POOL</var></li>
        </ol></li>
        <li>Otherwise, add <var>CHILD</var> to <var>POOL</var></li>
    </ol></li>
    <li><dfn id="algo-composition-repeat">Repeat</dfn> while <var>TREE</var> exists:
    <ol>
        <li>Let <var>POINT</var> be the first encountered <a href="#dfn-active-insertion-point">active</a> <a href="#dfn-shadow-insertion-point">shadow insertion point</a> in <var>TREE</var>, in <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#tree-order">tree order</a>
        <li>Run the <a href="#dfn-distribution-algorithm">distribution algorithm</a>, supplying <var>POOL</var> and <var>TREE</var> as input</li>
        <li>If <var>POINT</var> exists:
        <ol>
            <li>Find the next older tree, relative to <var>TREE</var> in the <var>HOST</var>'s <a href="#dfn-tree-stack">tree stack</a>
            <ol>
                <li>If there is no older tree, <strong>stop</strong>.</li>
                <li>Otherwise:
                <ol>
                    <li>Set <var>TREE</var> to be this older tree</li>
                    <li><a href="#dfn-assigned">Assign</a> <var>TREE</var> to the <var>POINT</var></li>
                    <li>Continue to <a href="#algo-composition-repeat">repeat</a></li>
                </ol></li>
            </ol></li>
        </ol></li>
        <li>Otherwise, <strong>stop</strong>.
    </ol></li>
</ol>
</div>

<p>When an <a href="#dfn-insertion-point">insertion point</a> or a <a href="#dfn-shadow-insertion-point">shadow insertion point</a> has nothing <a href="#dfn-assigned">assigned</a> or <a href="#dfn-distribution">distributed</a> to them, the fallback content <strong>must</strong> be used instead when rendering. The <dfn id="dfn-fallback-content">fallback content</dfn> is all descendants of the <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> that represents the insertion point. The <a href="#dfn-insertion-point">insertion points</a> or <a href="#dfn-shadow-insertion-point">shadow insertion points</a> in fallback content <strong>must</strong> be considered <a href="#dfn-inactive-insertion-point">inactive</a>.</p>

<h3 id="nested-shadow-trees">Nested Shadow Trees</h3>

<p>Any <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> in a <a href="#dfn-shadow-tree">shadow tree</a> can be a <a href="#dfn-shadow-host">shadow host</a>, thus producing nested <a href="#dfn-shadow-tree">shadow trees</a>. A <a href="#dfn-shadow-tree">shadow tree</a> is <dfn id="dfn-nested-tree">nested</dfn> when its <a href="#dfn-shadow-host">shadow host</a> is itself a part of a <a href="#dfn-shadow-tree">shadow tree</a>. Conversely, a <a href="#dfn-shadow-tree">shadow tree</a> <em>A</em> is said to be <dfn id="dfn-nesting-tree">nesting</dfn> the <a href="#dfn-shadow-tree">shadow tree</a> <em>B</em> if <em>B</em> is <a href="#dfn-nested-tree">nested</a> by <em>A</em>. If a <a href="#dfn-shadow-host">shadow host</a> is declared in the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a>, the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> is the <a href="#dfn-nesting-tree">nesting</a> <a href="http://www.w3.org/TR/domcore/#trees">tree</a> of its <a href="#dfn-shadow-tree">shadow trees</a>.</p>

<p>A <a href="#dfn-shadow-tree">shadow tree</a> is <dfn id="dfn-enclosed-tree">enclosed</dfn> by another <a href="#dfn-shadow-tree">shadow tree</a> when the enclosing <a href="http://www.w3.org/TR/domcore/#trees">tree</a> nests the enclosed <a href="http://www.w3.org/TR/domcore/#trees">tree</a> through one or more levels of nesting. All <a href="#dfn-shadow-tree">shadow trees</a> are <a href="#dfn-enclosed-tree">enclosed</a> by the <a href="#dfn-document-tree">document tree</a>.</p>

<h3 id="rendering-shadow-trees">Rendering Shadow Trees</h3>

<p><dfn id="dfn-rendering">Rendering</dfn> of <a href="#dfn-shadow-tree">shadow trees</a>, or presenting them visually, is defined as a specialization of rendering <strong>any DOM tree</strong>, and <strong>must</strong> happen as these steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>HOST</var>, a <a href="#dfn-shadow-host">shadow host</a></dd>
<dt>Output</dt>
    <dd>Rendering of the <var>HOST</var>, including its <a href="#dfn-shadow-tree">shadow trees</a></dd>
</dl>

<ol>
    <li>Run <a href="#dfn-tree-composition">tree composition algorithm</a> for the given <a href="#dfn-shadow-host">shadow host</a></li>
    <li>As content of the <a href="#dfn-shadow-host">shadow host</a>, render the <a href="#dfn-youngest-tree">youngest tree</a> as a <strong>any DOM tree</strong>, with the following <dfn id="dfn-shadow-rendering">shadow rendering</dfn> exceptions:
    <ul>
        <li>Each <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> that is a <a href="#dfn-shadow-host">shadow host</a> <strong>must</strong> be <a href="#dfn-rendering">rendered</a> accordingly</li>
        <li>In place of each <a href="#dfn-insertion-point">insertion point</a>, process the following <dfn id="dfn-insertion-point-rendering">insertion point rendering</dfn> steps:
        <ol>
            <li>If there are child <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> <a href="#dfn-distribution">distributed</a> to this insertion point, for each child <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> and in the order they were distributed:
            <ol>
                <li>Let <var>CHILD</var> be the child <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> being rendered</li>
                <li>If <var>CHILD</var> is itself an <a href="#dfn-insertion-point">insertion point</a>, and the <a href="http://www.w3.org/TR/domcore/#trees">tree</a> being rendered is <a href="#dfn-nested-tree">nested</a>, render them using <a href="#dfn-insertion-point-rendering">insertion point rendering</a> steps</li>
                <li>Otherwise, render <var>CHILD</var> as <strong>any DOM tree</strong>
            </ol></li>
            <li>Otherwise, render <a href="#dfn-fallback-content">fallback content</a> as <strong>any DOM tree</strong></li>
        </ol></li>
        <li>In place of each <a href="#dfn-shadow-insertion-point">shadow insertion point</a>:
        <ol>
            <li>If there is an <a href="#dfn-older-tree">older tree</a>, <a href="#dfn-assigned">assigned</a> to this shadow insertion point, render it as <strong>any DOM tree</strong>, but with the same <a href="#dfn-shadow-rendering">shadow rendering</a> exceptions.</li>
            <li>Otherwise, render <a href="#dfn-fallback-content">fallback content</a> as <strong>any DOM tree</strong></li>
        </ol></li>
    </ul></li>
</ol>
</div>

<p>This process of <a href="#dfn-rendering">rendering</a> produces a structure that is a composition of several <a href="http://www.w3.org/TR/domcore/#introduction-to-the-dom">DOM</a> trees, including the <a href="#dfn-document-tree">document tree</a>. The term "<dfn id="dfn-as-rendered">as rendered</dfn>" is used to refer to this structure.</p>

<h3 id="custom-pseudo-elements">Custom Pseudo-Elements</h3>

<p>In certain situations, the author of a <a href="#dfn-shadow-tree">shadow tree</a> may wish to designate one or more <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a> from that <a href="http://www.w3.org/TR/domcore/#trees">tree</a> as a structural abstraction that provides additional information about the contents of the <a href="#dfn-shadow-tree">shadow tree</a>.</p>

<div class="informative">
For example, when developing a 2-dimensional range slider widget, which offers a thumb that could be moved in 2 directions in a rectangular space, the author decides to allow the widget users to style the thumb directly.
</div>

<p>The <dfn id="dfn-custom-pseudo-element">custom pseudo-elements</dfn> enable this scenario. A <a href="#dfn-custom-pseudo-element">custom pseudo-element</a> is an association between an <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> in a <a href="#dfn-shadow-tree">shadow tree</a> and a string value. This string value is called a <dfn id="dfn-custom-pseudo-element-value">custom pseudo-element value</dfn>. The <a href="#dfn-custom-pseudo-element-value">custom pseudo-element value</a> <strong>must</strong> be considered <dfn id="dfn-valid-custom-pseudo-element-value">valid</dfn> if it starts with a <var>U+0078 LATIN SMALL LETTER X</var>, followed by  <var>U+002D HYPHEN-MINUS</var>. Otherwise, the <a href="#dfn-custom-pseudo-element-value">custom pseudo-element value</a> <strong>must</strong> be considered invalid.</p>

<div class="informative">

<p>In the case of the aforementioned 2-dimensional slider widget, the author could build the widget's shadow tree as follows:</p>

<pre><code class="prettyprint">
var widget = document.createElement('div');
var root = widget.createShadowRoot();
var thumb = document.createElement('div');
thumb.pseudo = 'x-thumb';
root.appendChild(thumb);
</code></pre>

<p>Once the <code>pseudo</code> property is set, the consumer of the widget could style the widget's thumb using <code>x-thumb</code> pseudo-element, reaching into the widget's shadow tree directly to the thumb:</p>

<pre><code class="prettyprint">
div::x-thumb {
    width: 10px;
    height: 10px;
    color: bisque;
}
</code></pre>

<p></p>
</div>

<div class="fixme">
    Using the <code>x-</code> prefix was raised as a problem (see <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=20600">bug 20600</a>), but no one presented better alternatives yet.
</div>

<h2 id="events">Events</h2>

<p>When an <a href="http://www.w3.org/TR/domcore/#events">event</a> is <a href="http://www.w3.org/TR/domcore/#dispatching-events">dispatched</a> in a <a href="#dfn-shadow-tree">shadow tree</a>, its path either crosses the <a href="#dfn-shadow-boundary">shadow boundary</a> or is terminated at the <a href="#dfn-shadow-boundary">shadow boundary</a>. One exception are the mutation events. The <a href="http://www.w3.org/TR/DOM-Level-2-Events/events.html#Events-eventgroupings-mutationevents">mutation event types</a> <strong>must</strong> never be dispatched in a <a href="#dfn-shadow-tree">shadow tree</a>.</p>

<p>For event path to cross the <a href="#dfn-shadow-boundary">shadow boundary</a>, it <strong>must</strong> be populated with <dfn id="dfn-adjusted-parent">adjusted parents</dfn>, or <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> that appear as parents <a href="#dfn-as-rendered">as rendered</a>. The <dfn id="dfn-parent-calculation-algorithm">parent calculation algorithm</dfn> is used to determine the <a href="#dfn-adjusted-parent">adjusted parent</a> of any given <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> and create the list of ancestors for event dispatch. This algorithm <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>NODE</var>, a node</dd>
    <dd><var>CONTEXT</var>, <strong>null</strong> or a <a href="#dfn-reprojection">reprojection</a> context node</dd>
<dt>Output</dt>
    <dd><var>PARENT</var>, a node's <a href="#dfn-adjusted-parent">adjusted parent</a></dd>
</dl>
<ol>
    <li>If <var>NODE</var> is a <a href="#dfn-shadow-root">shadow root</a>:
    <ol>
        <li>If <var>NODE</var> is currently <a href="#dfn-assigned">assigned</a> to a <a href="#dfn-shadow-insertion-point">shadow insertion point</a>:
        <ol>
            <li>Let the <var>PARENT</var> be the <a href="#dfn-shadow-insertion-point">shadow insertion point</a> to which <var>NODE</var> is <a href="#dfn-assigned">assigned</a> to</li>
        </ol></li>
        <li>Otherwise, let the <var>PARENT</var> be the <a href="#dfn-shadow-host">shadow host</a> of the <var>NODE</var>
    </ol></li>
    <li>If <var>NODE</var> is currently <a href="#dfn-distribution">distributed</a> to an <a href="#dfn-insertion-point">insertion point</a> in a <a href="#dfn-shadow-tree">shadow tree</a>, let <var>PARENT</var> be the <a href="#dfn-insertion-point">insertion point</a> to which the <var>NODE</var> is <a href="#dfn-distribution">distributed</a></li>
    <li>If <var>NODE</var> is an <a href="#dfn-insertion-point">insertion point</a> and <var>CONTEXT</var> is not <strong>null</strong>:
    <ol>
      <li>If the parent <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> of <var>NODE</var> is a <a href="#dfn-shadow-host">shadow host</a> <em>and</em> its <a href="#dfn-shadow-tree">shadow tree</a> contains an <a href="#dfn-insertion-point">insertion point</a> to which <var>CONTEXT</var> is <a href="#dfn-distribution">distributed</a>, let <var>PARENT</var> be that <a href="#dfn-insertion-point">insertion point</a></li>
    </ol></li>
    <li>Otherwise, let <var>PARENT</var> be the node's parent node.</li>
</ol>
</div>

<h3 id="event-retargeting">Event Retargeting</h3>

<p>In the cases where events cross the <a href="#dfn-shadow-boundary">shadow boundaries</a>, the event's information about the target of the event is adjusted in order to maintain <a href="#dfn-upper-boundary-encapsulation">upper boundary encapsulation</a>. Event <dfn id="dfn-retargeting">retargeting</dfn> is a process of computing relative targets for each ancestor of the <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> at which the event is dispatched. A <dfn id="dfn-relative-target">relative target</dfn> is a <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> that most accurately represents the target of a dispatched event at a given ancestor while maintaining the <a href="#dfn-upper-boundary-encapsulation">upper boundary encapsulation</a>.

<p>The <dfn id="dfn-retargeting-algorithm">retargeting algorithm</dfn> is used to determine relative targets, and it <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>NODE</var>, a node</dd>
<dt>Output</dt>
    <dd><var>TARGETS</var>, a list of tuples, each containing <var>NODE</var>'s ancestor and its relative target</dd>
</dl>
<ol>
    <li>Let <var>STACK</var> be a stack of nodes</li>
    <li>Let <var>ANCESTOR</var> be <var>NODE</var></li>
    <li><dfn id="algo-reatargeting-repeat">Repeat</dfn> while <var>ANCESTOR</var> exists:
    <ol>
        <li>If <var>ANCESTOR</var> is an <a href="#dfn-insertion-point">insertion point</a>:
        <ol>
            <li>Let <var>CONTEXT</var> be the top-most item in <var>STACK</var> that is not an <a href="#dfn-insertion-point">insertion point</a> or <strong>null</strong> if such item does not exist.</li>
            <li>Let <var>TOP</var> be the item at the top of <var>STACK</var>, or <var>ANCESTOR</var> if <var>STACK</var> is empty</li>
            <li>Push <var>TOP</var> into <var>STACK</var></li>
        </ol></li>
        <li>Otherwise, let <var>CONTEXT</var> be <strong>null</strong></li>
        <li>If <var>STACK</var> is empty, push <var>ANCESTOR</var> into <var>STACK</var></li>
        <li>Let <var>TARGET</var> be the <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> at the top of <var>STACK</var></li>
        <li>Add (<var>TARGET</var>, <var>ANCESTOR</var>) tuple to <var>TARGETS</var></li>
        <li>If <var>ANCESTOR</var> is a <a href="#dfn-shadow-root">shadow root</a>:
        <ol>
            <li>Pop <var>STACK</var>, if <var>STACK</var> is not empty</li>
        </ol></li>
        <li>Set <var>ANCESTOR</var> to be the result of <a href="#dfn-parent-calculation-algorithm">parent calculation algorithm</a>, given <var>ANCESTOR</var> and <var>CONTEXT</var> as input</li>
    </ol></li>
</ol>
</div>

<p>The retargeting process <strong>must</strong> occur prior to dispatch of an event.</p>

<h3 id="retargeting-related-target">Retargeting <code>relatedTarget</code></h3>

<p>Some events have a <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> property, which holds a <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> that's not the event's target, but is related to the event.</p>

<p>For instance, a <code>mouseover</code> event's <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> may hold the <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> from which the mouse has moved to event's <code>target</code>. In the case where <code>relatedTarget</code> is in a <a href="#dfn-shadow-tree">shadow tree</a>, the conforming UAs <strong>must</strong> not leak its actual value outside of this tree. In cases where both <code>relatedTarget</code> and <code>target</code> are part of the same <a href="#dfn-shadow-tree">shadow tree</a>, the conforming UAs <strong>must</strong> <em>stop</em> events at the <a href="#dfn-shadow-boundary">shadow boundary</a> to avoid the appearance of spurious <code>mouseover</code> and <code>mouseout</code> events firing from the same node.</p>

<p>Thus, if an event has a <code>relatedTarget</code>, its value and extent of event dispatch <strong>must</strong> be adjusted. In general:</p>
<ol>
    <li>For a given node, the <code>relatedTarget</code> <strong>must</strong> be changed to its ancestor (or self) that is in the same <a href="#dfn-shadow-tree">shadow tree</a> as the node</li>
    <li>Event listeners <strong>must not</strong> be invoked on a <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> for which the <code>target</code> and <code>relatedTarget</code> are the same.</li>
</ol>

<p>The <dfn id="dfn-related-target-algorithm">related target resolution</dfn> algorithm <strong>must</strong> be used to determine the value of the <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> property and <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>NODE</var>, the <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> on which event listeners would be invoked</dd>
    <dd><var>RELATED</var>, the related target for the event</dd>
<dt>Output</dt>
    <dd><var>ADJUSTED</var>, the <dfn id="dfn-adjusted-related-target">adjusted related target</dfn> for <var>NODE</var></dd>
</dl>
<ol>
    <li>Let <var>TARGET</var> be <var>NODE</var></li>
    <li>Let <var>ADJUSTED</var> be <strong>undefined</strong></li>
    <li><dfn id="algo-target-repeat">Repeat</dfn> while <var>TARGET</var> exists:
    <ol>
        <li>Let <var>STACK</var> be an empty stack of nodes</li>
        <li>Let <var>ANCESTOR</var> be <var>RELATED</var></li>
        <li>Let <var>LAST</var> be <strong>undefined</strong></li>
        <li><dfn id="algo-ancestor-repeat">Repeat</dfn> while <var>ANCESTOR</var> exists:
        <ol>
            <li>Let <var>CONTEXT</var> be <strong>null</strong>
            <li>If <var>STACK</var> is empty, push <var>ANCESTOR</var> into <var>STACK</var></li>
            <li>Otherwise, if <var>ANCESTOR</var> is an <a href="#dfn-insertion-point">insertion point</a>:
            <ol>
                <li>Let <var>CONTEXT</var> be the top-most item that is not an <a href="#dfn-insertion-point">insertion point</a> in <var>STACK</var> or <strong>null</strong>, if such item does not exist.</li>
                <li>If <var>LAST</var> is <a href="#dfn-distribution">distributed</a> or <a href="#dfn-assigned">assigned</a> into <var>ANCESTOR</var>:
                <ol>
                    <li>Let <var>HEAD</var> be the <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> at the top of the <var>STACK</var></li>
                    <li>Push <var>HEAD</var> into <var>STACK</var></li>
                </ol></li>
            </ol></li>
            <li>If <var>ANCESTOR</var> and <var>TARGET</var> are in the same tree:
            <ol>
                <li>Let <var>ADJUSTED</var> be the <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> at the top of the stack</li>
                <li><strong>Stop.</strong></li>
            </ol></li>
            <li>If <var>ANCESTOR</var> is a <a href="#dfn-shadow-root">shadow root</a>, pop <var>STACK</var></li>
            <li>Let <var>LAST</var> be <var>ANCESTOR</var></li>
            <li>Set <var>ANCESTOR</var> to be the result of <a href="#dfn-parent-calculation-algorithm">parent calculation algorithm</a>, given <var>ANCESTOR</var> and <var>CONTEXT</var> as input</li>
        </ol></li>
        <li>If <var>TARGET</var> is a <a href="#dfn-shadow-root">shadow root</a>, let <var>TARGET</var> be the <a href="#dfn-shadow-host">shadow host</a> of <var>TARGET</var></li>
        <li>Otherwise, let <var>TARGET</var> be <var>TARGET</var>'s parent node</li>
    </ol></li>
</ol>
</div>

<h3 id="retargeting-focus-events">Retargeting Focus Events</h3>

<p>The <code>focus</code>, <code>DOMFocusIn</code>, <code>blur</code>, and <code>DOMFocusOut</code> events <strong>must</strong> be treated in the same way as events with a <code>relatedTarget</code>, where the corresponding <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> that is losing focus as a result of <code>target</code> gaining focus or the <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> that is gaining focus, and thus causing the blurring of <code>target</code> acts as the related target.</p>

<h3 id="events-that-are-always-stopped">Events that are Always Stopped</h3>

<p>The following events <strong>must</strong> always be stopped at the nearest <a href="#dfn-shadow-boundary">shadow boundary</a>:</p>
<ul>
    <li><code>abort</code></li>
    <li><code>error</code></li>
    <li><code>select</code></li>
    <li><code>change</code></li>
    <li><code>load</code></li>
    <li><code>reset</code></li>
    <li><code>resize</code></li>
    <li><code>scroll</code></li>
    <li><code>selectstart</code></li>
</ul>

<h3 id="event-dispatch">Event Dispatch</h3>

<p>At the time of event dispatch:</p>
<ul>
    <li>The <a href="http://www.w3.org/TR/domcore/#event"><code>Event</code></a> <a href="http://www.w3.org/TR/domcore/#dom-event-target"><code>target</code></a> and <a href="http://www.w3.org/TR/domcore/#dom-event-currenttarget"><code>currentTarget</code></a> attributes <strong>must</strong> return the <a href="#dfn-relative-target">relative target</a> for the <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> on which event listeners are <a href="http://www.w3.org/TR/domcore/#concept-event-listener-invoke">invoked</a></li>
    <li>The <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent"><code>MouseEvent</code></a> <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> attribute <strong>must</strong> return the <a href="#dfn-adjusted-related-target">adjusted related target</a></li>
    <li>The <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent"><code>MouseEvent</code></a> <a href="http://dev.w3.org/csswg/cssom-view/#widl-MouseEvent-offsetX"><code>offsetX</code></a> and <a href="http://dev.w3.org/csswg/cssom-view/#widl-MouseEvent-offsetY"><code>offsetY</code></a> attributes <strong>must</strong> return the coordinates relative to the origin of the <a href="http://dev.w3.org/csswg/cssom-view/#padding-edge">padding edge</a> of the <a href="#dfn-relative-target">relative target</a></li>
    <li>If the <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> and <a href="http://www.w3.org/TR/domcore/#dom-event-target"><code>target</code></a> are the same for a given node, its the event listeners <strong>must not</strong> be invoked</li>
    <li>When <em>capturing</em>, which entails processing step 6 of the <a href="http://dom.spec.whatwg.org/#concept-event-dispatch">event dispatch algorithm</a>, the event listeners <strong>must not</strong> be <a href="http://dom.spec.whatwg.org/#concept-event-listener-invoke">invoked</a> on a <a href="http://dom.spec.whatwg.org/#concept-node">node</a> <strong>if</strong> it is the same as its <a href="#dfn-relative-target">relative target</a></li>
    <li>When <em>bubbling</em>, which entails processing step 9 of the <a href="http://dom.spec.whatwg.org/#concept-event-dispatch">event dispatch algorithm</a>, the <a href="http://dom.spec.whatwg.org/#event"><code>Event</code></a> <a href="http://dom.spec.whatwg.org/#dom-event-eventphase">eventPhase</a> attribute <strong>must</strong> return <a href="http://dom.spec.whatwg.org/#dom-event-at_target">AT_TARGET</a> <strong>if</strong> the <a href="#dfn-relative-target">relative target</a> is same as the <a href="http://dom.spec.whatwg.org/#concept-node">node</a> on which event listeners are <a href="http://dom.spec.whatwg.org/#concept-event-listener-invoke">invoked</a></li>
    <li>If the event's <a href="http://dom.spec.whatwg.org/#dom-event-bubbles"><code>bubbles</code></a> attribute value is <strong>false</strong>, run these substeps:
    <ol>
        <li>Reverse the order of <em>event path</em></li>
        <li>Initialize event's <a href="http://dom.spec.whatwg.org/#dom-event-eventphase"><code>eventPhase</code></a> attribute to <a href="http://dom.spec.whatwg.org/#dom-event-at_target"><code>AT_TARGET</code></a></li>
        <li>For each object in <em>event path</em> where the <a href="#dfn-relative-target">relative target</a> is same as the object, <a href="http://dom.spec.whatwg.org/#concept-event-listener-invoke">invoke</a> its <a href="http://dom.spec.whatwg.org/#concept-event-listener">event listeners</a>, with event <em>event</em>, as long as <em>event</em>'s <a href="http://dom.spec.whatwg.org/#stop-propagation-flag">stop propagation flag</a> is unset</li>
    </ol>
</ul>

<p>Upon completion of the event dispatch, the <a href="http://www.w3.org/TR/domcore/#event"><code>Event</code></a> object's <a href="http://www.w3.org/TR/domcore/#dom-event-target"><code>target</code></a> and <a href="http://www.w3.org/TR/domcore/#dom-event-currenttarget"><code>currentTarget</code></a> <strong>must</strong> be to the highest ancestor's <a href="#dfn-relative-target">relative target</a>. Since it is possible for a script to hold on to the <code>Event</code> object past the scope of event dispatch, this step is necessary to avoid revealing the <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> in <a href="#dfn-shadow-tree">shadow trees</a>.</p>

<h3 id="event-retargeting-example">Event Retargeting Example</h3>

<p>Suppose we have a user interface for a media controller, represented by this tree, composed of both <a href="#dfn-document-tree">document tree</a> and the <a href="#dfn-shadow-tree">shadow trees</a>. In this example, we will assume that selectors are allowed to cross the shadow boundaries and we will use these selectors to identify the <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a>. Also, we will invent a fictional <code>shadow-root</code> <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> to demarcate the <a href="#dfn-shadow-boundary">shadow boundaries</a> and represent <a href="#dfn-shadow-root">shadow roots</a>:</p>
<pre><code>
&lt;div id=&quot;player&quot;&gt;
    <span class=shadow-boundary>&lt;shadow-root id=&quot;player-shadow-root&quot;&gt;</span>
        &lt;div id=&quot;controls&quot;&gt;
            &lt;button class=&quot;play-button&quot;&gt;PLAY&lt;/button&gt;
            &lt;input type=&quot;range&quot; id=&quot;timeline&quot;&gt;
                <span class=shadow-boundary>&lt;shadow-root id=&quot;timeline-shadow-root&quot;&gt;</span>
                    &lt;div class=&quot;slider-thumb&quot; id=&quot;timeline-slider-thumb&quot;&gt;&lt;/div&gt;
                <span class=shadow-boundary>&lt;/shadow-root&gt;</span>
            &lt;/input&gt;
            &lt;div class=&quot;volume-slider-container&quot;&gt;
                &lt;input type=&quot;range&quot; class=&quot;volume-slider&quot;&gt;
                    <span class=shadow-boundary>&lt;shadow-root id=&quot;volume-shadow-root&quot;&gt;</span>
                        &lt;div class=&quot;slider-thumb&quot; id=&quot;volume-slider-thumb&quot;&gt;&lt;/div&gt;
                    <span class=shadow-boundary>&lt;/shadow-root&gt;</span>
                &lt;/input&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    <span class=shadow-boundary>&lt;/shadow-root&gt;</span>
&lt;/div&gt;
</code></pre>

<p>Let's have a user position their pointing device over the volume slider's thumb (<code>#volume-slider-thumb</code>), thus triggering a <code>mouseover</code> event on that node. For this event, let's pretend it has no associated <code>relatedTarget</code>.</p>

<p>Just before the event is dispatched, we perform <a href="#dfn-retargeting">retargeting</a>:</p>
<ol>
    <li>Since <code>#volume-slider-thumb</code> is not an <a href="#dfn-insertion-point">insertion point</a>, we push it onto <var>STACK</var>, and add the first tuple to <var>TARGETS</var> as (<code>#volume-slider-thumb</code>, <code>#volume-slider-thumb</code>)</li>
    <li>We then <a href="#dfn-parent-calculation-algorithm">calculate parent</a> as <code>#volume-shadow-root</code> and proceed to second iteration, adding (<code>#volume-slider-thumb</code>, <code>#volume-shadow-root</code>) tuple to <var>TARGETS</var></li>
    <li>Because <code>#volume-shadow-root</code> is a <a href="#dfn-shadow-root">shadow root</a>, we pop <var>STACK</var>, thus emptying it</li>
    <li>Next <a href="#dfn-parent-calculation-algorithm">parent calculation</a> yields <code>#volume-slider</code>, and so we begin the third iteration</li>
    <li>Here, <var>STACK</var> is empty again, so we push <code>#volume-slider</code> into it and add (<code>#volume-slider</code>, <code>#volume-slider</code>) to <var>TARGETS</var></li>
    <li>The <a href="#dfn-parent-calculation-algorithm">parent</a> of <code>#volume-slider</code> is <code>#volume-slider-container</code> not a <a href="#dfn-shadow-root">shadow root</a> and not an <a href="#dfn-insertion-point">insertion point</a>, which dictates that we add (<code>#volume-slider</code>, <code>#volume-slider-container</code>) to <var>TARGETS</var></li>
    <li>Next <a href="#dfn-parent-calculation-algorithm">up</a>, we see <code>#controls</code>, again neither a <a href="#dfn-shadow-root">shadow root</a> nor an <a href="#dfn-insertion-point">insertion point</a>, which means we add (<code>##volume-slider</code>, <code>#controls</code>) to <var>TARGETS</var></li>
    <li>The <a href="#dfn-parent-calculation-algorithm">next ancestor</a> is <code>#player-shadow-root</code>, a <a href="#dfn-shadow-root">shadow root</a>, and thus we add it (<code>#volume-slider</code>, <code>#player-shadow-root</code>) to <var>TARGETS</var>, then pop <var>STACK</var>, emptying it</li>
    <li>Its <a href="#dfn-parent-calculation-algorithm">parent</a> is <code>#player</code>, neither <a href="#dfn-shadow-root">shadow root</a> nor <a href="#dfn-insertion-point">insertion point</a>, and <var>STACK</var> is empty, so we push <code>#player</code> to <var>STACK</var>, then add (<code>#player</code>, <code>#player</code>) to <var>TARGETS</var></li>
    <li>In our example, there are no further <a href="#dfn-parent-calculation-algorithm">parents</a>, causing us to exit the <a href="#algo-reatargeting-repeat">loop</a> and stop.</li>
</ol>

<p>At the end of this process, we should have the following set of ancestors and relative targets:</p>
<table>
<thead>
<tr>
    <th>Ancestor</th>
    <th>Relative Target</th>
</tr>
</thead>
<tbody>
<tr>
    <td><code>#player</code></td>
    <td><code><strong>#player</strong></code></td>
</tr>
<tr>
    <td><code>#player-shadow-root</code></td>
    <td><code>#volume-slider</code></td>
</tr>
<tr>
    <td><code>#controls</code></td>
    <td><code>#volume-slider</code></td>
</tr>
<tr>
    <td><code>#volume-slider-container</code></td>
    <td><code>#volume-slider</code></td>
</tr>
<tr>
    <td><code>#volume-slider</code></td>
    <td><code><strong>#volume-slider</strong></code></td>
</tr>
<tr>
    <td><code>#volume-shadow-root</code></td>
    <td><code>#volume-slider-thumb</code></td>
</tr>
<tr>
    <td><code>#volume-slider-thumb</code></td>
    <td><code><strong>#volume-slider-thumb</strong></code></td>
</tr>
</tbody>
</table>

<p>After we dispatch the <code>mouseover</code> event using these newly computed relative targets, the user decides to move their pointing device over the thumb of the timeline
(<code>#timeline-slider-thumb</code>). This triggers both a <code>mouseout</code> event for the volume slider thumb and the <code>mouseover</code> event for the timeline thumb.</p>

<p>Let's study how the <code>relatedTarget</code> value of the volume thumb's <code>mouseout</code> event is affected. For this event, the <code>relatedTarget</code> is the timeline thumb (<code>#timeline-slider-thumb</code>). Per <a href="#dfn-related-target-algorithm">algorithm</a>:</p>

<ol>
    <li>Starting with <var>NODE</var> as <code>#volume-slider-thumb</code> and <var>RELATED</var> as <code>#timeline-slider-thumb</code>,</li>
    <li>We <a href="#algo-ancestor-repeat">examine</a> ancestors of <var>RELATED</var>:
    <ol>
        <li>First <a href="#dfn-parent-calculation-algorithm">up</a> is <code>#timeline-slider-thumb</code>, and we push it into <var>STACK</var></li>
        <li>Then it's <code>#timeline-shadow-root</code>, a <a href="#dfn-shadow-root">shadow root</a>, so we pop <var>STACK</var>, emptying it</li>
        <li>Next is <code>#timeline</code>, we push it into <var>STACK</var></li>
        <li>Then comes <code>#controls</code> and after it, <code>#player-shadow-root</code>, a <a href="#dfn-shadow-root">shadow root</a>, so we pop <var>STACK</var>, emptying it</li>
        <li>Final ancestor is <code>#player</code>, we push it into <var>STACK</var></li>
    </ol>
    <li>Set <var>TARGET</var> to <code>#volume-shadow-root</code></li>
    <li>We again <a href="#algo-ancestor-repeat">examine</a> ancestors of <var>RELATED</var> and notice that it produces the same result as our previous such examination</li>
    <li>We then set <var>TARGET</var> to <code>#volume-slider</code> and</li>
    <li>Repeat <a href="#algo-ancestor-repeat">examination</a> of ancestors once more&mdash;and realize that when <var>ANCESTOR</var> value is <code>#timeline</code>, the <var>ANCESTOR</var> and <var>TARGET</var> are in the same tree, and thus</li>
    <li>Return <code>#timeline</code> as the adjusted <code>relatedTarget</code> value.
</ol>

<p>Performing this computation with <var>NODE</var> as <code>#player</code> yields the result of both <code>target</code> and <code>relatedTarget</code> being the same value (<code>#player</code>), which means that we do not dispatch the event on this <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> and its ancestors.</p>

<h2 id="styles">Styles</h2>

<p>Each <a href="#dfn-shadow-root">shadow root</a> has an associated list of zero or more <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheets</a>, named <dfn id="dfn-shadow-root-style-sheets">shadow root style sheets</dfn>. This is an ordered list that contains all <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheets</a>, associated with the <a href="#dfn-shadow-root">shadow root</a>, in <a href="http://www.w3.org/TR/dom/#concept-tree-order">tree order</a>.</p>

<p>When a <a href="#dfn-shadow-host">shadow host</a> has multiple <a href="#dfn-shadow-root">shadow roots</a>, the <a href="http://dev.w3.org/csswg/css3-cascade/#cascade">cascade order</a> of <a href="http://www.w3.org/TR/CSS2/syndata.html#rule-sets">CSS rules</a>, defined in <a href="#dfn-shadow-root-style-sheets">shadow roow style sheets</a>, in ascending order of precedence <strong>must</strong> match the order of the <a href="#dfn-tree-stack">tree stack</a>, ending with the <a href="#dfn-youngest-tree">youngest tree</a>.</p>

<p>To enforce <a href="#dfn-upper-boundary-encapsulation">upper-boundary encapsulation</a>, <a href="http://www.w3.org/TR/CSS2/syndata.html#rule-sets">CSS rules</a> declared in an <a href="#dfn-enclosed-tree">enclosing</a> <a href="http://www.w3.org/TR/domcore/#trees">tree</a> <strong>must not</strong> apply in a <a href="#dfn-shadow-tree">shadow tree</a>, except when the <dfn id="dfn-apply-author-styles">apply-author-styles</dfn> flag is set for this tree. The flag signals that the rules declared in the <a href="#dfn-enclosed-tree">enclosing</a> trees are applicable in the <a href="#dfn-shadow-tree">shadow tree</a>.</p>

<p>Even when the <a href="#dfn-apply-author-styles">apply-author-styles</a> is set, the <a href="http://www.w3.org/TR/selectors/">selectors</a> still <strong>must not</strong> cross the <a href="#dfn-shadow-boundary">shadow boundary</a> per <a href="#dfn-scoping-constraints">scoping constraints</a>. In other words, with <a href="#dfn-apply-author-styles">apply-author-styles</a> set, the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> CSS rules only match wholly inside or outside of the <a href="#dfn-shadow-tree">shadow tree</a>.</p>

<p>For the purposes of the <a href="http://dev.w3.org/csswg/css3-cascade/#cascade">cascade order</a>, the  <a href="http://www.w3.org/TR/CSS2/syndata.html#rule-sets">CSS rules</a> for <a href="#dfn-shadow-tree">shadow trees</a> that have the <a href="#dfn-apply-author-styles">apply-author-styles</a> flag set <strong>must</strong> be treated as <a href="http://www.w3.org/TR/selectors4/#scoping">scoped</a> selectors with <a href="#dfn-shadow-root">shadow root</a> as their scope. In this context, for <a href="#dfn-shadow-tree">shadow trees</a> <em>A</em> and <em>B</em>, the <em>A</em>'s <a href="#dfn-shadow-root">shadow root</a> is treated as <em>descendant</em> of <em>B</em>'s <a href="#dfn-shadow-root">shadow root</a> if <em>A</em> is <a href="#dfn-enclosed-tree">enclosed</a> by <em>B</em>.</p>

<p>If a <a href="http://www.w3.org/TR/CSS2/syndata.html#rule-sets">CSS rule</a> in a <a href="#dfn-nesting-tree">nesting</a> <a href="http://www.w3.org/TR/domcore/#trees">tree</a> ends with a <a href="http://www.w3.org/TR/selectors4/#compound">compound selector</a> that contains a <a href="http://www.w3.org/TR/selectors4/#pseudo-elements">pseudo-element</a> whose name equals to a <a href="#dfn-valid-custom-pseudo-element-value">valid</a> <a href="#dfn-custom-pseudo-element-value">value</a> of a <a href="#dfn-custom-pseudo-element">custom pseudo-element</a> that exists in this <a href="#dfn-shadow-tree">shadow tree</a>, this <a href="http://www.w3.org/TR/selectors4/#pseudo-elements">pseudo-element</a> <strong>must</strong> match the <a href="http://www.w3.org/TR/domcore/#concept-element">element</a>, associated with this <a href="#dfn-custom-pseudo-element">custom pseudo-element</a>.</p>

<p>Conversely, to enforce <a href="#dfn-lower-boundary-encapsulation">lower-boundary encapsulation</a>, <a href="http://www.w3.org/TR/CSS2/syndata.html#rule-sets">CSS rules</a> declared in a <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a> <strong>must not</strong> apply in the <a href="#dfn-document-tree">document tree</a>, with two exceptions:</p>
<ol>
    <li>Rules that contain <code>select</code> <a href="#dfn-distributed-pseudo-element"><code>::distributed()</code> pseudo-element</a> match <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a> in the <a href="#dfn-enclosed-tree">enclosing</a> trees;</li>
    <li>The <a href="#host-at-rule"><code>@host</code> @-rule</a> matches a <a href="#dfn-shadow-host">shadow host</a> in the <a href="#dfn-nesting-tree">nesting</a> tree.</li>
</ol>

<p>In a <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> that contains <a href="#dfn-shadow-tree">shadow trees</a>, the CSS properties <strong>must</strong> be inherited from parent nodes, produced using the <a href="#dfn-parent-calculation-algorithm">parent calculation algorithm</a>. This requirement has the following effects:</p>
<ul>
    <li>the styles of the <a href="#dfn-shadow-host">shadow host</a> are inherited by the children of the <a href="#dfn-shadow-root">shadow root</a></li>
    <li>the styles of the <a href="#dfn-insertion-point">insertion point</a> <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> are inherited by those child <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> of the <a href="#dfn-shadow-host">shadow host</a> that are <a href="#dfn-assigned">assigned</a> to this <a href="#dfn-insertion-point">insertion point</a></li>
    <li>the styles of the <a href="#dfn-shadow-insertion-point">shadow insertion point</a> <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> are inherited by the child <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> of the <a href="#dfn-shadow-root">shadow root</a> of the <a href="#dfn-shadow-tree">shadow tree</a>, <a href="#dfn-distribution">distributed</a> to this <a href="#dfn-shadow-insertion-point">shadow insertion point</a></li>
</ul>

<p>If the <dfn id="dfn-reset-style-inheritance">reset-style-inheritance</dfn> flag is set for a <a href="#dfn-shadow-tree">shadow tree</a>, all <a href="http://www.w3.org/TR/2005/WD-css3-cascade-20051215/#inheritance">inheritable</a> CSS properties <strong>must</strong> behave as if they were explicitly set to the <a href="http://www.w3.org/TR/2005/WD-css3-cascade-20051215/#initial0">initial value</a> at the upper boundary of the tree.</p>

<p>If the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag is set for an <a href="#dfn-insertion-point">insertion point</a> in a <a href="#dfn-shadow-tree">shadow tree</a>, all <a href="http://www.w3.org/TR/2005/WD-css3-cascade-20051215/#inheritance">inheritable</a> CSS properties <strong>must</strong> behave as if they were explicitly set to the <a href="http://www.w3.org/TR/2005/WD-css3-cascade-20051215/#initial0">initial value</a> at the lower boundary of the tree.</p>

<h3 id="css-variables">CSS Variables</h3>

<p>The <a href="#dfn-shadow-host">shadow host</a> styles being inherited by the children of the <a href="#dfn-shadow-root">shadow root</a> <strong>must</strong> also apply to <a href="http://dev.w3.org/csswg/css-variables/">CSS Variables</a>. This provides a way for <a href="#dfn-document-tree">document tree</a> styles to send signals into the <a href="#dfn-shadow-tree">shadow trees</a>, and for the <a href="#dfn-shadow-tree">shadow trees</a> to receive these signals with the use of the <a href="http://dev.w3.org/csswg/css-variables/#using-variables"><code>var()</code></a> function.</p>

<h3 id="text-decoration-property"><code>text-decoration</code> Property</h3>

<p>The text decorations, specified by the <a href="http://www.w3.org/TR/CSS2/text.html#lining-striking-props"><code>text-decoration</code></a> property <strong>must not</strong> be propagated from <a href="#dfn-shadow-host">shadow hosts</a> to <a href="#dfn-shadow-tree">shadow trees</a>.</p>

<h3 id="host-at-rule"><code>@host</code> @-rule</h3>

<p>Within styles, specified in <a href="#dfn-shadow-tree">shadow trees</a>, the author may use a <code>@host</code> @-rule. The syntax of this rule is defined as this addition to <a href="http://www.w3.org/TR/CSS21/grammar.html">CSS Grammar</a>:</p>

<p>The following production is added to the <a href="http://www.w3.org/TR/CSS21/grammar.html#grammar">grammar</a>:</p>

<pre><code>
host
    : HOST_SYM S* '{' S* ruleset* '}' S*
    ;
</code></pre>

<p>The following rule is added to the <a href="http://www.w3.org/TR/CSS21/grammar.html#scanner">tokenizer</a>:</p>

<pre><code>
@{H}{O}{S}{T}        {return HOST_SYM;}
</code></pre>

<p>The <a href="http://www.w3.org/TR/CSS21/syndata.html#x19">declarations</a> of the rules in a <code>@host</code> @-rule <strong>must</strong> only be matched against the <a href="#dfn-shadow-host">shadow host</a> of the <a href="#dfn-shadow-tree">shadow tree</a> in which the style is specified, but only if this <a href="#dfn-shadow-tree">shadow tree</a> is <a href="#dfn-rendering">rendered</a>. When the <a href="#dfn-shadow-tree">shadow tree</a> is not <a href="#dfn-rendering">rendered</a> (when it's an older <a href="http://www.w3.org/TR/domcore/#trees">tree</a> that is not <a href="#dfn-assigned">assigned</a> to a <a href="#dfn-shadow-insertion-point">shadow insertion point</a>), the <a href="http://www.w3.org/TR/CSS21/syndata.html#x19">declarations</a> <strong>must not</strong> be applied.</p>

<p>When a rule in <a href="#host-at-rule"><code>@host</code> @-rule</a> matches an <a href="http://www.w3.org/TR/domcore/#concept-element">element</a>, it <strong>must</strong> have higher <a href="http://www.w3.org/TR/CSS2/cascade.html#specificity">specificity</a> than any <a href="http://www.w3.org/TR/selectors/">selector</a>, but lower <a href="http://www.w3.org/TR/CSS2/cascade.html#specificity">specificity</a> than <a href="http://www.w3.org/TR/CSS21/syndata.html#x19">declarations</a> from a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#the-style-attribute"><code>style</code></a> attribute.</p>


<section class="mechanics">

<h2 id="user-interaction">User Interaction</h2>

<h3 id="ranges-and-selection">Ranges and Selections</h3>

<p>Since a <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> in a <a href="#dfn-document-tree">document tree</a> and a <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> in a <a href="#dfn-shadow-tree">shadow tree</a> never have the same <a href="http://www.w3.org/TR/domcore/#concept-tree-root">root</a>, there may never exist a valid <a href="http://www.w3.org/TR/domcore/#range">DOM range</a> that spans either both a <a href="#dfn-document-tree">document tree</a> and a <a href="#dfn-shadow-tree">shadow tree</a>, or multiple <a href="#dfn-shadow-tree">shadow trees</a>.</p>

<p>Accordingly, <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selections</a> may only exist within one tree, because they are defined by a single <a href="http://www.w3.org/TR/domcore/#range">range</a>. To maintain <a href="#dfn-upper-boundary-encapsulation">upper boundary encapsulation</a>, the selection, returned by the <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#dom-window-getselection"><code>window.getSelection()</code></a> method <strong>must</strong> never return a selection within a <a href="#dfn-shadow-tree">shadow tree</a>.</p>

<p>The <code>getSelection()</code> method of the <a href="#dfn-shadow-root">shadow root</a> object <strong>must</strong> return the current <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selection</a> in this <a href="#dfn-shadow-tree">shadow tree</a>.</p>

<h3 id="focus-navigation">Focus Navigation</h3>

<p><a href="#dfn-shadow-tree">Shadow trees</a> participate in <a href="http://www.w3.org/TR/css3-ui/#keyboard">sequential</a> or <a href="http://www.w3.org/TR/css3-ui/#keyboard">directional</a> focus navigation as part of the <a href="#dfn-document-tree">document tree</a>. The <a href="http://www.w3.org/TR/css3-ui/#keyboard">navigation order</a> within a <a href="#dfn-shadow-tree">shadow tree</a> <strong>must</strong> be computed as a list of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#focusable">focusable</a> <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a> in <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#tree-order">tree order</a> <a href="#dfn-as-rendered">as-rendered</a>, with the exception of any <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a>, <a href="#dfn-distribution">distributed</a> into <a href="#dfn-insertion-point">insertion points</a>, and is called <dfn id="dfn-shadow-dom-navigation-order">shadow DOM navigation order</dfn>.</p>

<div class="informative">
Since the elements, distributed into insertion points are not part of the shadow tree, their order remains to be controlled by the navigation order of the nesting tree.
</div>

<p>For <a href="http://www.w3.org/TR/css3-ui/#keyboard">sequential focus navigation</a>, the <a href="#dfn-shadow-dom-navigation-order">shadow DOM navigation order</a> sequence <strong>must</strong> be inserted into the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> <a href="http://www.w3.org/TR/css3-ui/#keyboard">navigation order</a>:</p>
<ol>
    <li>immediately after the <a href="#dfn-shadow-host">shadow host</a>, if the shadow host is <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#focusable">focusable</a>; or</li>
    <li>in place of the <a href="#dfn-shadow-host">shadow host</a> as if the shadow host were assigned the value of <a href="http://www.w3.org/TR/css3-ui/#keyboard"><code>auto</code></a> for determining its position.</li>
</ol>

<p>For <a href="http://www.w3.org/TR/css3-ui/#keyboard">directional focus navigation</a>, it is up to the user agent to integrate the <a href="#dfn-shadow-dom-navigation-order">shadow DOM navigation order</a> into the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> <a href="http://www.w3.org/TR/css3-ui/#keyboard">navigation order</a>.</p>

<h3 id="active-element">Active Element</h3>

<p>To maintain <a href="#dfn-upper-boundary-encapsulation">upper-boundary encapsulation</a>, the value of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document">Document</a> object's focus API property <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement">activeElement</a> <strong>must</strong> be adjusted. To prevent loss of information when adjusting this value, each <a href="#dfn-shadow-root">shadow root</a> <strong>must</strong> also have an <code>activeElement</code> property to store the value of the focused <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> in the <a href="#dfn-shadow-tree">shadow tree</a>.</p>

<p>The <dfn id="active-element-adjustment-algorithm">active <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> adjustment algorithm</dfn> is used to determine the values of the respective <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement">activeElement</a> properties, and it <strong>must</strong> be equivalent to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>ELEMENT</var>, the focused <a href="http://www.w3.org/TR/domcore/#concept-element">element</a></dd>
<dt>Output</dt>
    <dd>Adjusted values of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement">activeElement</a> properties.</dd>
</dl>
<ol>
    <li>Run the <a href="#dfn-retargeting-algorithm">retargeting algorithm</a> with <var>ELEMENT</var> as input</li>
    <li>For each <var>TUPLE</var> in the resulting list of tuples:
    <ol>
        <li>Let <var>ADJUSTED</var> be the first value of the <var>TUPLE</var></li>
        <li>Let <var>NODE</var> be the second value of the <var>TUPLE</var></li>
        <li>If <var>NODE</var> is a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document">Document</a> or a <a href="#dfn-shadow-root">shadow root</a>, set the value of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement">activeElement</a> to <var>ADJUSTED</var>.</li>
    </ol>
    </li>
</ol>
</div>

<h3 id="editing">Editing</h3>

<p>The value of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#attr-contenteditable"><code>contenteditable</code></a> attribute <strong>must not</strong> propagate from <a href="#dfn-shadow-host">shadow host</a> to its <a href="#dfn-shadow-tree">shadow trees</a>.</p>

<h3 id="assistive-technology">Assistive Technology</h3>

<p>User agents with assistive technology traverse the <a href="#dfn-document-tree">document tree</a> <a href="#dfn-as-rendered">as rendered</a>, and thus enable full use of of <a href="http://www.w3.org/WAI/PF/aria/">WAI-ARIA</a> semantics in the <a href="#dfn-shadow-tree">shadow trees</a>.</p>

<h2 id="html-elements">HTML Elements in Shadow Trees</h2>

<p>Comparatively, a <a href="#dfn-shadow-tree">shadow tree</a> can be seen as somewhere between <em>just part of a <a href="http://www.w3.org/TR/domcore/#concept-document">document</a></em> and itself being a <a href="http://www.w3.org/TR/domcore/#interface-documentfragment">document fragment</a>. Since it is rendered, a <a href="#dfn-shadow-tree">shadow tree</a> aims to retain the traits of a typical <a href="http://www.w3.org/TR/domcore/#trees">tree</a> in a <a href="http://www.w3.org/TR/domcore/#concept-document">document</a>. At the same time, it is an encapsulation abstraction, so it has to avoid affecting the <a href="#dfn-document-tree">document tree</a>. Thus, the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> <strong>must</strong> behave <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/">as specified</a> in the <a href="#dfn-shadow-tree">shadow trees</a>, with a few exceptions.</p>

<h3 id="inert-html-elements">Inert HTML Elements</h3>

<p>A subset of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> <strong>must</strong> behave as <dfn id="dfn-inert">inert</dfn>, or not part of the <a href="#dfn-document-tree">document tree</a>. This is consistent how the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> would behave in a <a href="http://www.w3.org/TR/domcore/#interface-documentfragment">document fragment</a>. These <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a> are:</p>
<ul>
    <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-base-element"><code>base</code></a></li>
    <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-link-element"><code>link</code></a></li>
</ul>

<p>All other <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> in the <a href="#dfn-shadow-tree">shadow trees</a> <strong>must</strong> behave as if they were part of the <a href="#dfn-document-tree">document tree</a>, with the <a href="#dfn-scoping-constraints">scoping constraints</a> of their respective trees applied.</p>

<h3 id="html-forms">HTML Forms</h3>

<p>The <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#forms">forms</a> in HTML are scoped at the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> level. That is, all <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#the-form-element"><code>form</code></a> <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a> and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#form-associated-element">form-associated elements</a> are accessible using the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> <a href="http://www.w3.org/TR/domcore/#interface-document">DOM object</a>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-tree-accessors">tree accessors</a>. Per <a href="#dfn-scoping-constraints">scoping constraints</a>, this <strong>must</strong> exclude <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a> in the <a href="#dfn-shadow-tree">shadow trees</a>.</p>

<p>Instead, each <a href="#dfn-shadow-tree">shadow tree</a> <strong>must</strong> scope its <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#the-form-element"><code>form</code></a> <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a> and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#form-associated-element">form-associated elements</a>. Because the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#the-form-element"><code>form</code></a>'s <a href="http://www.w3.org/TR/domcore/#dom-node-ownerdocument"><code>ownerDocument</code></a> is the <a href="#dfn-shadow-host">shadow host</a>'s <a href="http://www.w3.org/TR/domcore/#concept-document">document</a>, the form submission <strong>must</strong> continue to work <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/association-of-controls-and-forms.html#form-submission">as specified</a>.</p>

<h2 id="html-elements-and-their-shadow-trees">HTML Elements and Their Shadow Trees</h2>

<p>Per <a href="http://www.whatwg.org/specs/web-apps/current-work/">specification</a>, some <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> are designed to either not render their contents or have special requirements in regard to contents rendering. In order to reconcile these differences in rendering behavior with the <a href="#dfn-shadow-dom">shadow DOM</a> <a href="#dfn-tree-composition">tree composition</a>, all <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> <strong>must</strong> have an <a href="#dfn-processing-equivalence">equivalent</a> of a <a href="#dfn-shadow-tree">shadow tree</a> that is created and populated at the time of <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> instantiation. It is up to a user agent to define the content of these trees. However, all conforming user agents <strong>must</strong> satisfy the following requirements:</p>

<table>
<thead>
    <tr>
        <th style="width: 30%">HTML Element</th>
        <th>Shadow Tree Requirements</th>
    </tr>
</thead>
<tbody>
    <tr>
        <td><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/embedded-content-1.html#the-img-element"><code>img</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-iframe-element"><code>iframe</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-embed-element"><code>embed</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-object-element"><code>object</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-video-element.html#the-video-element"><code>video</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-video-element.html#the-audio-element"><code>audio</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-canvas-element.html#the-canvas-element"><code>canvas</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-map-element.html#the-map-element"><code>map</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-input-element.html#the-input-element"><code>input</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-textarea-element"><code>textarea</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-progress-element"><code>progress</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-meter-element"><code>meter</code></a></td>
        <td>If the <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> can have <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#fallback-content">fallback content</a>, contains one <a href="#dfn-insertion-point">insertion point</a>. The <a href="#dfn-matching-criteria">matching criteria</a> value is the <a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a> only when the <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> needs to show <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#fallback-content">fallback content</a>. Otherwise, contains no <a href="#dfn-insertion-point">insertion points</a> or an <a href="#dfn-insertion-point">insertion point</a> that matches nothing.</td>
    </tr>
    <tr>
        <td><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#the-fieldset-element"><code>fieldset</code></a></td>
        <td>Contains two <a href="#dfn-insertion-point">insertion points</a> with the following <a href="#dfn-matching-criteria">matching criteria</a>:
        <ol>
            <li><code>legend:first-of-type</code></li>
            <li><a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a></li>
        </ol>
        </td>
    </tr>
    <tr>
        <td><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/interactive-elements.html#the-details-element"><code>details</code></a></td>
        <td>Contains two <a href="#dfn-insertion-point">insertion points</a> with the following <a href="#dfn-matching-criteria">matching criteria</a>:
        <ol>
            <li><code>summary:first-of-type</code></li>
            <li><a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a></li>
        </ol>
        </td>
    </tr>
    <tr>
        <td>All other <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a></td>
        <td>Contains one <a href="#dfn-insertion-point">insertion point</a> with the <a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a> as the <a href="#dfn-matching-criteria">matching criteria</a></td>
    </tr>
</tbody>
</table>

<h2 id="elements-and-dom-objects">Elements and DOM Objects</h2>

<h3 id="shadow-root-object"><code>ShadowRoot</code> Object</h3>

<p>The <code>ShadowRoot</code> object represents the <a href="#dfn-shadow-root">shadow root</a>.</p>

<pre><code>
interface <dfn id="api-shadow-root">ShadowRoot</dfn> : <a href="http://www.w3.org/TR/domcore/#interface-documentfragment">DocumentFragment</a> {
    <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#htmlelement">HTMLElement</a> <a href="#api-shadow-root-get-element-by-id">getElementById</a>(DOMString elementId);
    <a href="http://www.w3.org/TR/domcore/#nodelist">NodeList</a> <a href="#api-shadow-root-get-elements-by-class-name">getElementsByClassName</a>(DOMString tagName);
    <a href="http://www.w3.org/TR/domcore/#nodelist">NodeList</a> <a href="#api-shadow-root-get-elements-by-tag-name">getElementsByTagName</a>(DOMString className);
    <a href="http://www.w3.org/TR/domcore/#nodelist">NodeList</a> <a href="#api-shadow-root-get-elements-by-tag-name-ns">getElementsByTagNameNS</a>(DOMString? namespace, DOMString localName);
    <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#selection">Selection</a>? <a href="#api-shadow-root-selection">getSelection</a>();
    <a href="http://www.w3.org/TR/domcore/#interface-element">Element</a>? <a href="#api-shadow-root-element-from-point">elementFromPoint</a>(float x, float y);
<!--
    <a href="http://www.w3.org/TR/cssom/#the-cssstylesheet-interface">CSSStyleSheet</a> <a href="#api-shadow-root-add-style-sheet">addStyleSheet</a>(HTMLElement element);
    <a href="http://www.w3.org/TR/cssom/#the-cssstylesheet-interface">CSSStyleSheet</a> <a href="#api-shadow-root-remove-style-sheet">removeStyleSheet</a>(<a href="http://www.w3.org/TR/cssom/#the-cssstylesheet-interface">CSSStyleSheet</a> styleSheet);
-->    
    attribute bool <a href="#api-shadow-root-apply-author-styles">applyAuthorStyles</a>;
    attribute bool <a href="#api-shadow-root-reset-style-inheritance">resetStyleInheritance</a>;
    readonly attribute <a href="http://www.w3.org/TR/domcore/#interface-element">Element</a>? <a href="#api-shadow-root-active-element">activeElement</a>;
    attribute DOMString <a href="#api-shadow-root-inner-html">innerHTML</a>;
    readonly attribute <a href="http://www.w3.org/TR/cssom/#the-stylesheet-interface">StyleSheetList</a> <a href="#api-shadow-root-style-sheets">styleSheets</a>;
}
</code></pre>

<h4 id="shadow-root-attributes"><code>ShadowRoot</code> Attributes</h4>

<dl>
<dt id="api-shadow-root-apply-author-styles"><code>applyAuthorStyles</code> of type <code>bool</code></dt>
<dd>Represents the <a href="#dfn-apply-author-styles">apply-author-styles</a> flag and indicates whether or not the rules in <a href="http://www.w3.org/TR/CSS2/cascade.html">author styles</a> associated with the <a href="http://www.w3.org/TR/domcore/#concept-element">element</a>'s <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> apply to the <a href="#dfn-shadow-tree">shadow tree</a>. If <code>false</code> (default value), the author styles <strong>are not</strong> applied to the <a href="#dfn-shadow-tree">shadow tree</a>. If <code>true</code>, the author styles <strong>are</strong> applied.</dd>
<dd>On getting, the attribute <strong>must</strong> return the current value of the <a href="#dfn-apply-author-styles">apply-author-styles</a> flag for the <a href="#dfn-shadow-host">shadow host</a>'s tree.</dd>
<dd>On setting, the attribute <strong>must</strong> set the value of the <a href="#dfn-apply-author-styles">apply-author-styles</a> flag for the <a href="#dfn-shadow-host">shadow host</a>'s <a href="http://www.w3.org/TR/domcore/#trees">tree</a> to specified value.</dd>
<dt id="api-shadow-root-reset-style-inheritance"><code>resetStyleInheritance</code> of type <code>bool</code></dt>
<dd>Represents the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag and indicates whether or not the inheritable CSS properties are set to the initial value at the shadow boundary. If <code>false</code> (default value), the properties continue to inherit. If <code>true</code>, the properties are set to initial value.</dd>
<dd>On getting, the attribute <strong>must</strong> return the current value of the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag for the <a href="#dfn-shadow-host">shadow host</a>'s tree.</dd>
<dd>On setting, the attribute <strong>must</strong> set the value of the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag for the <a href="#dfn-shadow-host">shadow host</a>'s <a href="http://www.w3.org/TR/domcore/#trees">tree</a> to specified value.</dd>
<dt id="api-shadow-root-active-element"><code>activeElement</code> of type <code>Element</code>, readonly</dt>
<dd>Represents the currently focused <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> in the <a href="#dfn-shadow-tree">shadow tree</a>.</dd>
<dd>On getting, the attribute <strong>must</strong> return the currently focused <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> in the <a href="#dfn-shadow-tree">shadow tree</a> or <code>null</code>, if there is none.</dd>
<dt id="api-shadow-root-inner-html"><code>innerHTML</code> of type <code>DOMString</code></dt>
<dd>represents the markup of <a href="#api-shadow-root"><code>ShadowRoot</code></a>'s contents.</dd>
<dd>On getting, the attribute <strong>must</strong> return the result of running the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-end.html#html-fragment-serialization-algorithm">HTML fragment serialization algorithm</a> with the <a href="http://html5.org/specs/dom-parsing.html#context-object">context object</a> as <a href="#dfn-shadow-host"><code>shadow host</code></a>.</dd>
<dd>On setting, these steps <strong>must</strong> be run:
<ol>
    <li>Let <var>FRAGMENT</var> be the result of invoking the <a href="http://html5.org/specs/dom-parsing.html#concept-parse-fragment">fragment parsing algorithm</a> with the new value as <var>MARKUP</var>, and the <a href="http://html5.org/specs/dom-parsing.html#context-object">context object</a> as <a href="#dfn-shadow-host"><code>shadow host</code></a></li>
    <li><a href="http://www.w3.org/TR/dom/#concept-node-replace-all">Replace all</a> with <var>FRAGMENT</var> within the <a href="#dfn-shadow-root">shadow root</a>.</li>
</ol></dd>
<dt id="api-shadow-root-style-sheets"><code>styleSheets</code> of type <code>StyleSheetList</code>, readonly</dt>
<dd>Represents the <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>.</dd>
<dd>On getting, the attribute <strong>must</strong> return a <code>StyleSheetList</code> sequence containing the <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>.
</dd>
</dl>

<p>The <a href="http://www.w3.org/TR/domcore/#dom-node-nodetype"><code>nodeType</code></a> attribute of a <a href="#api-shadow-root"><code>ShadowRoot</code></a> instance <strong>must</strong> return <a href="http://www.w3.org/TR/domcore/#dom-node-document_fragment_node"><code>DOCUMENT_FRAGMENT_NODE</code></a>. Accordingly, the <a href="http://www.w3.org/TR/domcore/#dom-node-nodename"><code>nodeName</code></a> attribute of a <a href="#api-shadow-root"><code>ShadowRoot</code></a> instance <strong>must</strong> return <code>"#document-fragment"</code>.</p>

<h4 id="shadow-root-methods"><code>ShadowRoot</code> Methods</h4>

<dl>
<dt id="api-shadow-root-get-element-by-id"><code>getElementById</code></dt>
<dd><strong>Must</strong> behave exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementbyid">document.getElementById</a>, except <a href="#dfn-scoping-constraints">scoped</a> to the <a href="#dfn-shadow-tree">shadow tree</a>.</dd>
<dt id="api-shadow-root-get-elements-by-class-name"><code>getElementsByClassName</code></dt>
<dd><strong>Must</strong> behave exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementsbyclassname">document.getElementsByClassName</a>, except <a href="#dfn-scoping-constraints">scoped</a> to the <a href="#dfn-shadow-tree">shadow tree</a>.</dd>
<dt id="api-shadow-root-get-elements-by-tag-name"><code>getElementsByTagName</code></dt>
<dd><strong>Must</strong> behave exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementsbytagname">document.getElementsByTagName</a>, except <a href="#dfn-scoping-constraints">scoped</a> to the <a href="#dfn-shadow-tree">shadow tree</a>.</dd>
<dt id="api-shadow-root-get-elements-by-tag-name-ns"><code>getElementsByTagNameNS</code></dt>
<dd><strong>Must</strong> behave exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementsbytagnamens">document.getElementsByTagNameNS</a>, except <a href="#dfn-scoping-constraints">scoped</a> to the <a href="#dfn-shadow-tree">shadow tree</a>.</dd>
<dt id="api-shadow-root-selection"><code>getSelection</code><dt>
<dd>Returns the current selection in the <a href="#dfn-shadow-tree">shadow tree</a>.</dd>
<dd>When invoked, it <strong>must</strong> return the <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selection</a> in the <a href="#dfn-shadow-host">shadow host</a>'s tree.</dd>

<dt id="api-shadow-root-element-from-point"><code>elementFromPoint</code></dt>
<dd>Returns an <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> at specified coordinates.
<div class="informative">Eventually, this needs to be part of <a href="http://dvcs.w3.org/hg/csswg/raw-file/tip/cssom-view/Overview.html">CSSOM View Module</a> specification</div>
When invoked, it <strong>must</strong> return result of running the following steps:
<ol>
    <li>If <a href="http://html5.org/specs/dom-parsing.html#context-object">context object</a> is not a <a href="#api-shadow-root"><code>ShadowRoot</code></a> instance, throw an <a href="http://dom.spec.whatwg.org/#invalidnodetypeerror"><code>InvalidNodeTypeError</code></a>.</li>
    <li>If either argument is negative, <code>x</code> is greated than the <a href="http://dvcs.w3.org/hg/csswg/raw-file/tip/cssom-view/Overview.html#viewport">viewport</a> width excluding the size of a rendered scroll bar (if any), or if <code>y</code> is greated than the <a href="http://dvcs.w3.org/hg/csswg/raw-file/tip/cssom-view/Overview.html#viewport">viewport</a> height excluding the size of a rendered scroll bar (if any), return <strong>null</strong>.</li>
    <li>Let <var>HIT</var> be the <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> at coordinates <code>x</code> and <code>y</code> in the <a href="http://dvcs.w3.org/hg/csswg/raw-file/tip/cssom-view/Overview.html#viewport">viewport</a>, determined through hit testing</li>
    <li>Let <var>TARGETS</var> be the result of running the <a href="#dfn-retargeting-algorithm">retargeting algorithm</a> with <var>HIT</var> as its argument</li>
    <li>Let <var>TUPLE</var> be the tuple in <var>TARGETS</var>, whose <em>second</em> value is <a href="http://html5.org/specs/dom-parsing.html#context-object">context object</a></li>
    <li>Return <em>first</em> value of <var>TUPLE</var>.</li>
</ol></dd>
<!--
<dt id="api-shadow-root-add-style-sheet"><code>addStyleSheet</code></dt>
<dd>Adds a new <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a> to <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>.
<div class="informative">
There is a <a href="http://lists.w3.org/Archives/Public/www-style/2012Oct/thread.html#msg491">discussion</a> under way in the <a href="http://www.w3.org/Style/CSS/">CSS WG</a> to make <a href="http://www.w3.org/TR/cssom/#the-cssstylesheet-interface">CSSStyleSheet</a> constructable. Once that is the case, this API will change to simply accept a <a href="http://www.w3.org/TR/cssom/#the-cssstylesheet-interface">CSSStyleSheet</a> object.
</div>
</dd>
<dd>When invoked, the method <strong>must</strong> run the following steps:
<ol>
    <li>If the parameter is an <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#htmllinkelement">HTMLLinkElement</a>:
    <ol>
        <li>Follow <a href="http://www.w3.org/TR/cssom/#requirements-on-user-agents-implementing-the-http-link-header">requirements</a> for implementing the HTTP <code>link</code> header with the exception that the newly created style sheet <strong>must</strong> be appended to the <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>, not <a href="http://www.w3.org/TR/cssom/#document-style-sheets">document style sheets</a></li>
        <li>Return the newly created <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a> object.</li>
    </ol></li>
    <li>If the parameter is an <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#htmlstyleelement">HTMLStyleElement</a>:
    <ol>
        <li><a href="http://www.w3.org/TR/cssom/#create-a-style-sheet">Create a style sheet</a> with the following properties and the exception that the newly created style sheet <strong>must</strong> be appended to the <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>, not <a href="http://www.w3.org/TR/cssom/#document-style-sheets">document style sheets</a>:
        <dl>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-location">style sheet location</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-owner-node">style sheet owner node</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-parent">style sheet parent</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-owner-css-rule">style sheet owner CSS rule</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-owner-css-rule">style sheet owner CSS rule</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-media">style sheet media</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-title">style sheet title</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-alternate-flag">style sheet alternate flag</a></dt>
            <dd>false</dd>
        </dl></li>
        <li>Return the newly created <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a> object.</li>
    </ol>
    <li>Otherwise, throw an <a href="http://dom.spec.whatwg.org/#invalidnodetypeerror"><code>InvalidNodeTypeError</code></a>.</li>
</ol></dd>
<dt id="api-shadow-root-remove-style-sheet"><code>removeStyleSheet</code></dt>
<dd>Removes a <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a>, added with <a href="#api-shadow-root-add-style-sheet"><code>addStyleSheet</code></a>.</dd>
<dd>When invoked, the method <strong>must</strong> run these steps:
<ol>
    <li>If the <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a>, represented by the method parameter exists in the <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a> and was added with <a href="#api-shadow-root-add-style-sheet"><code>addStyleSheet</code></a>:
    <ol>
        <li>Remove the <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a> from <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>.</li>
        <li>Return the removed <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a> instance.</li>
    </ol></li>
    <li>Otherwise, throw a <a href="http://www.w3.org/TR/domcore/#nomodificationallowederror"><code>NoModificationAllowedError</code></a> exception.</li>
</ol></dd>
-->
</dl>

<p>Invoking the <a href="http://www.w3.org/TR/domcore/#dom-node-clonenode"><code>cloneNode()</code></a> method on a <a href="#api-shadow-root"><code>ShadowRoot</code></a> instance <strong>must</strong> always throw a <a href="http://www.w3.org/TR/domcore/#dom-domexception-data_clone_err"><code>DATA_CLONE_ERR</code></a> exception.</p>


<h3 id="extensions-to-element">Extensions to <code>Element</code> Interface</h3>

<pre><code>
partial interface <a href="http://dom.spec.whatwg.org/#element">Element</a> {
    <a href="#api-shadow-root">ShadowRoot</a> <a href="#api-partial-element-create-shadow-root">createShadowRoot</a>();
    readonly attribute <a href="#api-shadow-root">ShadowRoot</a>? <a href="#api-partial-element-shadow-root">shadowRoot</a>;
    attribute DOMString <a href="#api-partial-element-pseudo">pseudo</a>;
}
</code></pre>

<h4 id="partial-element-attributes">Attributes</h4>

<dl>
<dt><dfn id="api-partial-element-pseudo">pseudo</dfn> of type <code>DOMString</code></dt>
<dd>Represents the <a href="#dfn-custom-pseudo-element-value">custom pseudo-element value</a>, associated with the <a href="http://www.w3.org/TR/domcore/#concept-element">element</a>.</dd>
<dd>On getting, the attribute <strong>must</strong> return the current <a href="#dfn-custom-pseudo-element-value">custom pseudo-element value</a> or <strong>empty string</strong> if there is no <a href="#dfn-custom-pseudo-element">custom pseudo-element</a> associated with this <a href="http://www.w3.org/TR/domcore/#concept-element">element</a>.</dd>
<dd>On setting, these steps <strong>must</strong> be run:
<ol>
    <li>If the <a href="#dfn-custom-pseudo-element">custom pseudo-element</a>, associated with this <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> already exists, discard it</li>
    <li>If the new value is not <strong>null</strong>, create a new <a href="#dfn-custom-pseudo-element">custom pseudo-element</a> with <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> and the new value as its <a href="#dfn-custom-pseudo-element-value">value</a>.</li>
</ol></dd>
<dt><dfn id="api-partial-element-shadow-root">shadowRoot</dfn> of type <a href="#api-shadow-root"><code>ShadowRoot</code></a><dt>
<dd>Represents the top <a href="#dfn-shadow-tree">shadow tree</a> in the "<a href="#dfn-as-rendered">as rendered</a>" structure.</dd>
<dd>On getting, the attribute <strong>must</strong> return the <a href="#dfn-youngest-tree">youngest tree</a> that has the <a href="http://www.w3.org/TR/domcore/#context-object">context object</a> as its <a href="#dfn-shadow-host">shadow host</a>, or <strong>null</strong> if no such <a href="#dfn-shadow-tree">shadow tree</a> is accesible.</dd>
<dd>For <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a>, the <a href="#html-elements-and-their-shadow-trees">UA-provided</a> <a href="#dfn-shadow-tree">shadow trees</a> <strong>must not</strong> be accessible.</dd>
</dl>

<h4 id="partial-element-methods">Methods</h4>

<dl>
<dt><dfn id="api-partial-element-create-shadow-root"><code>createShadowRoot</code></dfn></dt>
<dd>When invoked, these steps <strong>must</strong> be run:
<ol>
    <li>If the <a href="http://www.w3.org/TR/domcore/#context-object">context object</a> is not an <a href="http://www.w3.org/TR/domcore/#concept-element">element</a>, throw an <a href="http://dom.spec.whatwg.org/#invalidnodetypeerror">InvalidNodeTypeError</a>.</li>
    <li>Otherwise:
    <ol>
        <li>Create a new instance of the <a href="#api-shadow-root"><code>ShadowRoot</code></a> object</li>
        <li>Establish the <a href="http://www.w3.org/TR/domcore/#context-object">context object</a> as the <a href="#dfn-shadow-host">shadow host</a> of the <a href="#api-shadow-root"><code>ShadowRoot</code></a> object</li>
        <li>Add the <a href="#api-shadow-root"><code>ShadowRoot</code></a> object at the top of the <a href="#dfn-tree-stack">tree stack</a> of its <a href="#dfn-shadow-host">host</a></li>
        <li>Return <a href="#api-shadow-root"><code>ShadowRoot</code></a> object.</li>
    </ol></li>
</ol></dd>
</dl>


<h3 id="css-host-rule-interface"><code>CSSHostRule</code> Interface</h3>

<p>The <code>CSSHostRule</code> represents the <a href="#host-at-rule"><code>@host</code></a> at-rule in a CSS style sheet.</p>

<pre><code>
interface <dfn id="api-css-host-rule">CSSHostRule</dfn> : <a href="http://dev.w3.org/csswg/cssom/#the-cssrule-interface">CSSRule</a> {
    readonly attribute <a href="http://dev.w3.org/csswg/cssom/#the-cssrulelist-sequence">CSSRuleList</a> <a href="#api-css-host-rule-css-rules">cssRules</a>;
    unsigned long <a href="#api-css-host-rule-insert-rule">insertRule</a>(DOMString rule, unsigned long index);
    void <a href="#api-css-host-rule-delete-rule">deleteRule</a>(unsigned long index);
};
</code></pre>

<h4 id="css-host-rule-attributes"><code>CSSHostRule</code> Attributes</h4>

<dl>
    <dt><dfn id="api-css-host-rule-css-rules"><code>cssRules</code></dfn> of type <a href="http://dev.w3.org/csswg/cssom/#the-cssrulelist-sequence">CSSRuleList</a></dt>
    <dd>Represents the CSS rules in the <code>@host</code> style block</dd>
    <dd>On getting, the attribute <strong>must</strong> return the list of all CSS rules, specified in the <code>@host</code> at-rule, represented by the <a href="http://domparsing.spec.whatwg.org/#context-object">context object</a>.</dd>
</dl>

<h4 id="css-host-rule-methods"><code>CSSHostRule</code> Methods</h4>

<dl>
    <dt><dfn id="api-css-host-rule-insert-rule"><code>insertRule(DOMSTring <em>rule</em>, unsigned long <em>index</em>)</code></dfn></dt>
    <dd>When invoked, the method <strong>must</strong> <a href="http://dvcs.w3.org/hg/csswg/raw-file/tip/cssom/Overview.html#insert-a-css-rule">insert a CSS rule</a> <em>rule</em> into the CSS rule list returned by <a href="#api-css-host-rule-css-rules"><code>cssRules</code></a> at <em>index</em>.</dd>
    <dt><dfn id="api-css-host-rule-delete-rule"><code>deleteRule(unsigned long <em>index</em>)</code></dfn></dt>
    <dd>When invoked, the method <strong>must</strong> <a href="http://dvcs.w3.org/hg/csswg/raw-file/tip/cssom/Overview.html#remove-a-css-rule">remove a CSS rule</a> <em>rule</em> from the CSS rule list returned by <a href="#api-css-host-rule-css-rules"><code>cssRules</code></a> at <em>index</em>.</dd>
</dl>

<p>The <code>HOST_RULE</code> type is added to <a href="http://dev.w3.org/csswg/cssom/#the-cssrule-interface">CSSRule</a> interface.</p>

<pre><code>
partial interface <a href="http://dev.w3.org/csswg/cssom/#the-cssrule-interface">CSSRule</a> {
    const unsigned short <a href="#api-css-rule-host-rule">HOST_RULE</a> = 1001;
};
</code></pre>

<dl>
    <dt><dfn id="api-css-rule-host-rule"><code>HOST_RULE</code></dfn></dt>
    <dd>When the value of the <code>type</code> attribute is <code>HOST_RULE</code>, then the object that implements this interface <strong>must</strong> implement <a href="#api-css-host-rule"><code>CSSHostRule</code></a> interface.</dd>
</dl>

<h3 id="content-element">The <code>content</code> HTML element</h3>

<p>The <dfn id="dfn-content-element"><code>content</code></dfn> HTML element represents a <a href="#dfn-insertion-point">insertion point</a> in the <a href="#dfn-shadow-tree">shadow tree</a>.</p>

<dl>
<dt>Context</dt>
<dd>Where <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#flow-content-0">flow content</a> is expected.</dd>
<dt>Content model</dt>
<dd><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#transparent">Transparent</a></dd>
<dt>Children</dt>
<dd>Anything as <a href="#dfn-fallback-content">fallback content</a></dd>
<dt>Content attributes</dt>
<dd><a href="http://dev.w3.org/html5/spec/Overview.html#global-attributes">Global attributes</a></dd>
<dd>
    <dl>
<!--    <dt id="markup-content-apply-shadow-styles"><code>apply-shadow-styles</code>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#boolean-attribute">boolean attribute</a></dt>
    <dd>indicates whether or not the rules in the scoped styles, defined in shadow tree are applied to the <a href="#dfn-shadow-host">shadow host</a>'s children that are inserted in place of this <code>content</code> element. If present, the styles are applied.</dd> -->
    <dt id="markup-content-select"><code>select</code>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#comma-separated-tokens">set of comma-separated tokens</a></dt>
    <dd>
        represents the <a href="#dfn-matching-criteria">matching criteria</a> for <a href="#dfn-distribution">distributing</a> child <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> of the <a href="#dfn-shadow-host">shadow host</a>. Each token <strong>must</strong> be a <a href="http://dev.w3.org/csswg/selectors4/#compound">compound selector</a>.
    </dd>
    <dt id="markup-content-reset-style-inheritance"><code>resetstyleinheritance</code>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#boolean-attribute">boolean</a> attribute</dt>
    <dd>indicates the state of the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag for this <a href="#dfn-insertion-point">insertion point</a>. If present, the value of the flag <strong>must</strong> be set to <strong>true</strong>. Otherwise, the value <strong>must</strong> be set to <strong>false</strong>.</dd>
    </dl>
</dd>
<dt>DOM Interface</dt>
<dd>
    <pre><code>
interface <dfn id="api-html-content-element">HTMLContentElement</dfn> : <a href="http://dev.w3.org/html5/spec/Overview.html#htmlelement">HTMLElement</a> {<!--    attribute bool <a href="#api-html-content-element-apply-shadow-styles">applyShadowStyles</a>; -->
    attribute DOMString <a href="#api-html-content-element-select">select</a>;
    attribute boolean <a href="#api-html-content-element-reset-style-inheritance">resetStyleInheritance</a>;
    <a href="http://www.w3.org/TR/domcore/#interface-nodelist">NodeList</a> <a href="#api-html-content-element-get-distributed-nodes">getDistributedNodes</a>();
}
    </code></pre>
    <dl>
    <dt>Attributes</dt>
    <dd>
    <dl>
<!--        <dt id="api-html-content-element-apply-shadow-styles"><code>applyShadowStyles</code> of type <code>bool</code></dt>
        <dd>Must <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the <a href="#markup-content-apply-shadow-styles">apply-shadow-styles</a> attribute.</dd> -->
        <dt id="api-html-content-element-select"><code>select</code> of type <code>DOMString</code></dt>
        <dd><strong>Must</strong> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the <a href="#markup-content-select">select</a> attribute.</dd>
        <dt id="api-html-content-element-reset-style-inheritance"><code>resetStyleInheritance</code> of type <code>boolean</code></dt>
        <dd><strong>Must</strong> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the <a href="#markup-content-reset-style-inheritance">resetstyleinheritance</a> attribute.</dd>
    </dl>
    </dd>
    </dl>
    <dl>
        <dt>Methods</dt>
        <dd><dl>
            <dt id="api-html-content-element-get-distributed-nodes"><code>getDistributedNodes</code></dt>
            <dd><strong>Must</strong> return a <a href="http://www.w3.org/TR/domcore/#concept-collection-static">static</a> <a href="http://www.w3.org/TR/domcore/#nodelist"><code>NodeList</code></a> consisting of nodes, currently <a href="#dfn-distribution">distributed</a> into this <a href="#dfn-insertion-point">insertion point</a>.</dd>
        </dl></dd>
    </dl>
</dd>
</dl>


<h3 id="shadow-element">The <code>shadow</code> HTML element</h3>

<p>The <dfn id="dfn-shadow-element"><code>shadow</code></dfn> HTML element represents an <a href="#dfn-shadow-insertion-point">shadow insertion point</a> in a <a href="#dfn-shadow-tree">shadow tree</a>.</p>

<dl>
<dt>Context</dt>
<dd>Where <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#flow-content-0">flow content</a> is expected.</dd>
<dt>Content model</dt>
<dd><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#transparent">Transparent</a></dd>
<dt>Children</dt>
<dd>Anything as <a href="#dfn-fallback-content">fallback content</a></dd>
<dt>Content attributes</dt>
<dd><a href="http://dev.w3.org/html5/spec/Overview.html#global-attributes">Global attributes</a></dd>
<dd>
<dl>
    <dt id="markup-shadow-reset-style-inheritance"><code>resetstyleinheritance</code>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#boolean-attribute">boolean</a> attribute</dt>
    <dd>indicates the state of the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag for this <a href="#dfn-shadow-insertion-point">shadow insertion point</a>. If present, the value of the flag <strong>must</strong> be set to <strong>true</strong>. Otherwise, the value <strong>must</strong> be set to <strong>false</strong>.</dd>
</dl></dd>
<dt>DOM Interface</dt>
<dd>
    <pre><code>
interface <dfn id="api-html-shadow-element">HTMLShadowElement</dfn> : <a href="http://dev.w3.org/html5/spec/Overview.html#htmlelement">HTMLElement</a> {
    readonly attribute <a href="#api-shadow-root">ShadowRoot</a>? <a href="#api-html-shadow-element-older-shadow-root">olderShadowRoot</a>;
    attribute boolean <a href="#api-html-shadow-element-reset-style-inheritance">resetStyleInheritance</a>;
}
    </code></pre>
    <dl>
        <dt>Attributes</dt>
        <dd><dl>
            <dt id="api-html-shadow-element-older-shadow-root"><code>olderShadowRoot</code> of type <a href="#api-shadow-root"><code>ShadowRoot</code></a></dt>
            <dd>Represents the <a href="#dfn-shadow-tree">shadow tree</a> that is <a href="#dfn-as-rendered">rendered</a> in place of this <a href="#dfn-shadow-insertion-point">shadow insertion point</a></dd>
            <dd>On getting, the attribute <strong>must</strong> return a result that is <a href="#dfn-processing-equivalence">equivalent</a> to running the following steps:
            <ol>
                <li>Let <var>TREE</var> be the <a href="#dfn-shadow-tree">shadow tree</a> that contains the <a href="http://www.w3.org/TR/domcore/#context-object">context object</a></li>
                <li>If <var>TREE</var> does not exist, return <strong>null</strong>.</li>
                <li>If <a href="http://www.w3.org/TR/domcore/#context-object">context object</a>, in <a href="http://www.w3.org/TR/domcore/#concept-tree-order">tree order</a>, is not the first <a href="#dfn-active-insertion-point">active</a> instance of <a href="#dfn-shadow-element"><code>shadow</code></a> element in <var>TREE</var>, return <strong>null</strong>.</li>
                <li>Let <var>HOST</var> be the <a href="#dfn-shadow-host">shadow host</a> of <var>TREE</var></li>
                <li>From <var>HOST</var>'s <a href="#dfn-tree-stack">tree stack</a>, return the <a href="#dfn-older-tree">older tree</a> relative to <var>TREE</var>, or <strong>null</strong> if no such <a href="#dfn-shadow-tree">shadow tree</a> is accessible.</li>
            </ol></dd>
            <dd>For <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a>, the <a href="#html-elements-and-their-shadow-trees">UA-provided</a> <a href="#dfn-shadow-tree">shadow trees</a> <strong>must not</strong> be accessible.</dd>
            <dt id="api-html-shadow-element-reset-style-inheritance"><code>resetStyleInheritance</code> of type <code>boolean</code></dt>
            <dd><strong>Must</strong> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the <a href="#markup-shadow-reset-style-inheritance">resetstyleinheritance</a> attribute.</dd>
        </dl></dd>
    </dl>
</dd>
</dl>
</section>

<h2 id="shadow-dom-example">Shadow DOM Example</h2>

<p>Bob was asked to turn a simple list of links into a News Widget, which has links organized into two categories: breaking news and just news. The current document markup for the stories looks like this:</p>
<pre class="prettyprint"><code>
&lt;ul class=&quot;stories&quot;&gt;
    &lt;li&gt;&lt;a href=&quot;//example.com/stories/1&quot;&gt;A story&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&quot;//example.com/stories/2&quot;&gt;Another story&lt;/a&gt;&lt;/li&gt;
    &lt;li class=&quot;breaking&quot;&gt;&lt;a href=&quot;//example.com/stories/3&quot;&gt;Also a story&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&quot;//example.com/stories/4&quot;&gt;Yet another story&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&quot;//example.com/stories/4&quot;&gt;Awesome story&lt;/a&gt;&lt;/li&gt;
    &lt;li class=&quot;breaking&quot;&gt;&lt;a href=&quot;//example.com/stories/5&quot;&gt;Horrible story&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</code></pre>

<p>To organize the stories, Bob decides to use <strong>shadow DOM</strong>. Doing so will allow Bob to keep the document markup uncluttered, and harnessing the power of insertion point makes sorting stories by class name a very simple task. After getting another cup of <a href="http://en.wikipedia.org/wiki/List_of_coffee_beverages#Green_Eye">Green Eye</a>, he quickly mocks up the following shadow tree, to be hosted by the <code>ul</code> element:</p>
<pre class="prettyprint"><code>
&lt;div class=&quot;breaking&quot;&gt;
    &lt;ul&gt;
        &lt;content select=&quot;.breaking&quot;&gt;&lt;/content&gt; &lt;!-- insertion point for breaking news --&gt;
    &lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;other&quot;&gt;
    &lt;ul&gt;
        &lt;content&gt;&lt;/content&gt; &lt;!-- insertion point for the rest of the news --&gt;
    &lt;/ul&gt;
&lt;/div&gt;
</code></pre>
<p>Bob then styles the newborn widget according to comps from the designer by adding this to the shadow tree mockup:</p>
<pre class="prettyprint"><code>
&lt;style&gt;
    div.breaking {
        color: Red;
        font-size: 20px;
        border: 1px dashed Purple;
    }
    div.other {
        padding: 2px 0 0 0;
        border: 1px solid Cyan;
    }
&lt;/style&gt;
</code></pre>
<p>While pondering if his company should start looking for a new designer, Bob converts the mockup to code:</p>
<pre class="prettyprint"><code>
function createStoryGroup(className, contentSelector)
{
    var group = document.createElement('div');
    group.className = className;
    // Empty string in select attribute or absence thereof work the same, so no need for special handling.
    group.innerHTML = '&lt;ul&gt;&lt;content select=&quot;' + contentSelector + '&quot;&gt;&lt;/content&gt;&lt;/ul&gt;';
    return group;
}

function createStyle()
{
    var style = document.createElement('style');
    style.textContent = 'div.breaking { color: Red;font-size: 20px; border: 1px dashed Purple; }' +
        'div.other { padding: 2px 0 0 0; border: 1px solid Cyan; }';
    return style;
}

function makeShadowTree(storyList)
{
    var root = storyList.createShadowRoot();
    root.appendChild(createStyle());
    root.appendChild(createStoryGroup('breaking', '.breaking'));
    root.appendChild(createStoryGroup('other', ''));
}

document.addEventListener('DOMContentLoaded', function() {
    [].forEach.call(document.querySelectorAll('ul.stories'), makeShadowTree);
});
</code></pre>

<p>Well done, Bob! With the cup of coffee still half-full, the work is complete. Recognizing his awesomeness, Bob returns to teaching n00bs the ways of <a href="http://en.wikipedia.org/wiki/World_of_Warcraft">WoW</a>.</p>

<p>A few months pass.</p>

<p>It's election time. With Bob at his annual conference, Alice is charged with adding <strong>another</strong>, temporary box to the news widget, filled with election-related stories. Alice studies Bob's code, reads up on the shadow DOM spec and realizes that, thanks to multiple shadow tree support, she doesn't have to touch his code. As usual, her solution is elegant and simple, fitting neatly right under Bob's code:</p>
<pre class="prettyprint"><code>
// TODO(alice): BEGIN -- DELETE THIS CODE AFTER ELECTIONS ARE OVER.
var ELECTION_BOX_REMOVAL_DEADLINE = ...;

function createElectionStyle()
{
    var style = document.createElement('style');
    // TODO(alice): Check designer's desk for hallucinogens.
    style.textContent = 'div.election { color: Magenta;font-size: 24px; border: 2px dotted Fuchsia; }';
    return style;
}

function makeElectionShadowTree(storyList)
{
    var root = storyList.createShadowRoot();
    // Add and style election story box.
    root.appendChild(createElectionStyle());
    root.appendChild(createStoryGroup('election', '.election'));
    // Insert Bob's shadow tree under the election story box.
    root.appendChild(document.createElement('shadow'));
}

if (Date.now() &lt; ELECTION_BOX_REMOVAL_DEADLINE) {
    document.addEventListener('DOMContentLoaded', function() {
        [].forEach.call(document.querySelectorAll('ul.stories'), makeElectionShadowTree);
    });
}
// TODO(alice): END -- DELETE THIS CODE AFTER ELECTIONS ARE OVER.
</code></pre>
<p>Using the <code>shadow</code> element allows Alice to compose Bob's widget <strong>inside</strong> of hers&mdash;without having to change a line of production code. Smiling to herself, Alice realizes that Bob may have come up with a way to keep the document markup clean, but <strong>she</strong> is the one who takes the cake for using shadow tree composition in such a cool way.</p>

</section>


<h2 id="acknowledgements">Acknowledgements</h2>

<p><span class="vcard">David Hyatt</span> developed <a href="http://dev.w3.org/2006/xbl2/">XBL 1.0</a>, and <span class="vcard">Ian Hickson</span> co-wrote <a href="http://dev.w3.org/2006/xbl2/">XBL 2.0</a>. These documents provided tremendous insight into the problem of functional encapsulation and greatly influenced this specification.</p>

<p><span class="vcard">Alex Russell</span> and his considerable forethought triggered a new wave of enthusiasm around the subject of shadow DOM and how it can be applied practically on the Web.</p>

<p><span class="vcard">Dominic Cooney</span>, <span class="vcard">Hajime Morrita</span>, and <span class="vcard">Roland Steiner</span> worked tirelessly to scope the problem of functional encapsulation within the confines of the Web platform and provided a solid foundation for this document.</p>

<p>The editor would also like to thank <span class="vcard">Alex Komoroske</span>, <span class="vcard">Anne van Kesteren</span>, <span class="vcard">Brandon Payton</span>, <span class="vcard">Brian Kardell</span>, <span class="vcard">Darin Fisher</span>, <span class="vcard">Eric Bidelman</span>, <span class="vcard">Deepak Sherveghar</span>, <span class="vcard">Edward O'Connor</span>, <span class="vcard">Elisée Maurer</span>, <span class="vcard">Elliott Sprehn</span>, <span class="vcard">Erik Arvidsson</span>, <span class="vcard">Glenn Adams</span>, <span class="vcard">Hayato Ito</span>, <span class="vcard">Jonas Sicking</span>, <span class="vcard">Malte Ubl</span>, <span class="vcard">Mike Taylor</span>, <span class="vcard">Oliver Nightingale</span>, <span class="vcard">Olli Pettay</span>, <span class="vcard">Rafael Weinstein</span>, <span class="vcard">Richard Bradshaw</span>, <span class="vcard">Ruud Steltenpool</span>, <span class="vcard">Sam Dutton</span>, <span class="vcard">Sergey G. Grekhov</span>, <span class="vcard">Shinya Kawanaka</span>, <span class="vcard">Tab Atkins</span>, and <span class="vcard">Takashi Sakamoto</span> for their comments and contributions to this specification.</p>

<p>This list is too short. There's a lot of work left to do. Please contribute by reviewing and filing bugs&mdash;and don't forget to ask the editor to add your name into this section.</p>

</body>
</html>
<!DOCTYPE html>
<html lang="en" dir="ltr" typeof="bibo:Document " about="" property="dcterms:language" content="en">
<head>
    <meta charset="utf-8">
    <title>Shadow DOM</title>
    
    
    <style>/* --- EXAMPLES --- */
div.example-title {
    min-width: 7.5em;
    color: #b9ab2d;
}
div.example-title span {
    text-transform: uppercase;   
}
aside.example, div.example, div.illegal-example {
    padding: 0.5em;
    margin: 1em 0;
    position: relative;
    clear: both;
}
div.illegal-example { color: red }
div.illegal-example p { color: black }
aside.example, div.example {
    padding: .5em;
    border-left-width: .5em;
    border-left-style: solid;
    border-color: #e0cb52;
    background: #fcfaee;    
}

aside.example div.example {
    border-left-width: .1em;
    border-color: #999;
    background: #fff;
}
aside.example div.example div.example-title {
    color: #999;
}
</style><style>/* --- ISSUES/NOTES --- */
div.issue-title, div.note-title {
    padding-right:  1em;
    min-width: 7.5em;
    color: #b9ab2d;
}
div.issue-title { color: #e05252; }
div.note-title { color: #2b2; }
div.issue-title span, div.note-title span {
    text-transform: uppercase;
}
div.note, div.issue {
    margin-top: 1em;
    margin-bottom: 1em;
}
.note > p:first-child, .issue > p:first-child { margin-top: 0 }
.issue, .note {
    padding: .5em;
    border-left-width: .5em;
    border-left-style: solid;
}
div.issue, div.note {
    padding: 1em 1.2em 0.5em;
    margin: 1em 0;
    position: relative;
    clear: both;
}
span.note, span.issue { padding: .1em .5em .15em; }

.issue {
    border-color: #e05252;
    background: #fbe9e9;
}
.note {
    border-color: #52e052;
    background: #e9fbe9;
}


</style><style>/* HIGHLIGHTS */
code.prettyprint {
    color:  inherit;
}

/* this from google-code-prettify */
.pln{color:#000}@media screen{.str{color:#080}.kwd{color:#008}.com{color:#800}.typ{color:#606}.lit{color:#066}.pun,.opn,.clo{color:#660}.tag{color:#008}.atn{color:#606}.atv{color:#080}.dec,.var{color:#606}.fun{color:red}}@media print,projection{.str{color:#060}.kwd{color:#006;font-weight:bold}.com{color:#600;font-style:italic}.typ{color:#404;font-weight:bold}.lit{color:#044}.pun,.opn,.clo{color:#440}.tag{color:#006;font-weight:bold}.atn{color:#404}.atv{color:#060}}ol.linenums{margin-top:0;margin-bottom:0}li.L0,li.L1,li.L2,li.L3,li.L5,li.L6,li.L7,li.L8{list-style-type:none}li.L1,li.L3,li.L5,li.L7,li.L9{background:#eee}
</style><style>/* --- WEB IDL --- */
pre.idl {
    border-top: 1px solid #90b8de;
    border-bottom: 1px solid #90b8de;
    padding:    1em;
    line-height:    120%;
}

pre.idl::before {
    content:    "WebIDL";
    display:    block;
    width:      150px;
    background: #90b8de;
    color:  #fff;
    font-family:    initial;
    padding:    3px;
    font-weight:    bold;
    margin: -1em 0 1em -1em;
}

.idlType {
    color:  #ff4500;
    font-weight:    bold;
    text-decoration:    none;
}

/*.idlModule*/
/*.idlModuleID*/
/*.idlInterface*/
.idlInterfaceID, .idlDictionaryID, .idlCallbackID, .idlEnumID {
    font-weight:    bold;
    color:  #005a9c;
}
a.idlEnumItem {
    color:  #000;
    border-bottom:  1px dotted #ccc;
    text-decoration: none;
}

.idlSuperclass {
    font-style: italic;
    color:  #005a9c;
}

/*.idlAttribute*/
.idlAttrType, .idlFieldType, .idlMemberType {
    color:  #005a9c;
}
.idlAttrName, .idlFieldName, .idlMemberName {
    color:  #ff4500;
}
.idlAttrName a, .idlFieldName a, .idlMemberName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlMethod*/
.idlMethType, .idlCallbackType {
    color:  #005a9c;
}
.idlMethName {
    color:  #ff4500;
}
.idlMethName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlCtor*/
.idlCtorName {
    color:  #ff4500;
}
.idlCtorName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlParam*/
.idlParamType {
    color:  #005a9c;
}
.idlParamName, .idlDefaultValue {
    font-style: italic;
}

.extAttr {
    color:  #666;
}

/*.idlSectionComment*/
.idlSectionComment {
    color: gray;
}

/*.idlConst*/
.idlConstType {
    color:  #005a9c;
}
.idlConstName {
    color:  #ff4500;
}
.idlConstName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlException*/
.idlExceptionID {
    font-weight:    bold;
    color:  #c00;
}

.idlTypedefID, .idlTypedefType {
    color:  #005a9c;
}

.idlRaises, .idlRaises a.idlType, .idlRaises a.idlType code, .excName a, .excName a code {
    color:  #c00;
    font-weight:    normal;
}

.excName a {
    font-family:    monospace;
}

.idlRaises a.idlType, .excName a.idlType {
    border-bottom:  1px dotted #c00;
}

.excGetSetTrue, .excGetSetFalse, .prmNullTrue, .prmNullFalse, .prmOptTrue, .prmOptFalse {
    width:  45px;
    text-align: center;
}
.excGetSetTrue, .prmNullTrue, .prmOptTrue { color:  #0c0; }
.excGetSetFalse, .prmNullFalse, .prmOptFalse { color:  #c00; }

.idlImplements a {
    font-weight:    bold;
}

dl.attributes, dl.methods, dl.constants, dl.constructors, dl.fields, dl.dictionary-members {
    margin-left:    2em;
}

.attributes dt, .methods dt, .constants dt, .constructors dt, .fields dt, .dictionary-members dt {
    font-weight:    normal;
}

.attributes dt code, .methods dt code, .constants dt code, .constructors dt code, .fields dt code, .dictionary-members dt code {
    font-weight:    bold;
    color:  #000;
    font-family:    monospace;
}

.attributes dt code, .fields dt code, .dictionary-members dt code {
    background:  #ffffd2;
}

.attributes dt .idlAttrType code, .fields dt .idlFieldType code, .dictionary-members dt .idlMemberType code {
    color:  #005a9c;
    background:  transparent;
    font-family:    inherit;
    font-weight:    normal;
    font-style: italic;
}

.methods dt code {
    background:  #d9e6f8;
}

.constants dt code {
    background:  #ddffd2;
}

.constructors dt code {
    background:  #cfc;
}

.attributes dd, .methods dd, .constants dd, .constructors dd, .fields dd, .dictionary-members dd {
    margin-bottom:  1em;
}

table.parameters, table.exceptions {
    border-spacing: 0;
    border-collapse:    collapse;
    margin: 0.5em 0;
    width:  100%;
}
table.parameters { border-bottom:  1px solid #90b8de; }
table.exceptions { border-bottom:  1px solid #deb890; }

.parameters th, .exceptions th {
    color:  #fff;
    padding:    3px 5px;
    text-align: left;
    font-family:    initial;
    font-weight:    normal;
    text-shadow:    #666 1px 1px 0;
}
.parameters th { background: #90b8de; }
.exceptions th { background: #deb890; }

.parameters td, .exceptions td {
    padding:    3px 10px;
    border-top: 1px solid #ddd;
    vertical-align: top;
}

.parameters tr:first-child td, .exceptions tr:first-child td {
    border-top: none;
}

.parameters td.prmName, .exceptions td.excName, .exceptions td.excCodeName {
    width:  100px;
}

.parameters td.prmType {
    width:  120px;
}

table.exceptions table {
    border-spacing: 0;
    border-collapse:    collapse;
    width:  100%;
}
</style><link rel="stylesheet" href="respec-complement.css" type="text/css">
<link rel="stylesheet" href="working-draft.css" type="text/css">
    
    
    
  <style>/*****************************************************************
 * ReSpec 3 CSS
 * Robin Berjon - http://berjon.com/
 *****************************************************************/

/* --- INLINES --- */
em.rfc2119 { 
    text-transform:     lowercase;
    font-variant:       small-caps;
    font-style:         normal;
    color:              #900;
}

h1 acronym, h2 acronym, h3 acronym, h4 acronym, h5 acronym, h6 acronym, a acronym,
h1 abbr, h2 abbr, h3 abbr, h4 abbr, h5 abbr, h6 abbr, a abbr {
    border: none;
}

dfn {
    font-weight:    bold;
}

a.internalDFN {
    color:  inherit;
    border-bottom:  1px solid #99c;
    text-decoration:    none;
}

a.externalDFN {
    color:  inherit;
    border-bottom:  1px dotted #ccc;
    text-decoration:    none;
}

a.bibref {
    text-decoration:    none;
}

cite .bibref {
    font-style: normal;
}

code {
    color:  #ff4500;
}

/* --- TOC --- */
.toc a, .tof a {
    text-decoration:    none;
}

a .secno, a .figno {
    color:  #000;
}

ul.tof, ol.tof {
    list-style: none outside none;
}

.caption {
    margin-top: 0.5em;
    font-style:   italic;
}

/* --- TABLE --- */
table.simple {
    border-spacing: 0;
    border-collapse:    collapse;
    border-bottom:  3px solid #005a9c;
}

.simple th {
    background: #005a9c;
    color:  #fff;
    padding:    3px 5px;
    text-align: left;
}

.simple th[scope="row"] {
    background: inherit;
    color:  inherit;
    border-top: 1px solid #ddd;
}

.simple td {
    padding:    3px 10px;
    border-top: 1px solid #ddd;
}

.simple tr:nth-child(even) {
    background: #f0f6ff;
}

/* --- DL --- */
.section dd > p:first-child {
    margin-top: 0;
}

.section dd > p:last-child {
    margin-bottom: 0;
}

.section dd {
    margin-bottom:  1em;
}

.section dl.attrs dd, .section dl.eldef dd {
    margin-bottom:  0;
}

@media print {
    .removeOnSave {
        display: none;
    }
}
</style><link rel="stylesheet" href="https://www.w3.org/StyleSheets/TR/W3C-WD"><!--[if lt IE 9]><script src='https://www.w3.org/2008/site/js/html5shiv.js'></script><![endif]--></head>
  <body class="h-entry" role="document" id="respecDocument"><div class="head" role="contentinfo" id="respecHeader">
  <p>
    
      <a href="http://www.w3.org/"><img width="72" height="48" src="https://www.w3.org/Icons/w3c_home" alt="W3C"></a>
    
  </p>
  <h1 class="title p-name" id="title" property="dcterms:title">Shadow DOM</h1>
  
  <h2 property="dcterms:issued" datatype="xsd:dateTime" content="2014-06-12T00:00:00.000Z" id="w3c-working-draft-12-jun-2014"><abbr title="World Wide Web Consortium">W3C</abbr> Working Draft <time class="dt-published" datetime="2014-06-12">12 Jun 2014</time></h2>
  <dl>
    
      <dt>This version:</dt>
      <dd><a href="http://www.w3.org/TR/2014/WD-shadow-dom-20140612/">http://www.w3.org/TR/2014/WD-shadow-dom-20140612/</a></dd>
      <dt>Latest published version:</dt>
      <dd><a href="http://www.w3.org/TR/shadow-dom/">http://www.w3.org/TR/shadow-dom/</a></dd>
    
    
      <dt>Latest editor's draft:</dt>
      <dd><a href="http://w3c.github.io/webcomponents/spec/shadow/">http://w3c.github.io/webcomponents/spec/shadow/</a></dd>
      <dt>Previous version</dt>
      <dd><a href="http://www.w3.org/TR/2013/WD-shadow-dom-20130514/">http://www.w3.org/TR/2013/WD-shadow-dom-20130514/</a></dd>
    
    
    
      
    
    
    
    <dt>Editors:</dt>
    <dd class="p-author h-card vcard" rel="bibo:editor" inlist=""><span typeof="foaf:Person"><a class="u-url url p-name fn" rel="foaf:homepage" property="foaf:name" content="Dimitri Glazkov" href="mailto:dglazkov@chromium.org">Dimitri Glazkov</a>, Google, Inc.</span>
</dd>
<dd class="p-author h-card vcard" rel="bibo:editor" inlist=""><span typeof="foaf:Person"><a class="u-url url p-name fn" rel="foaf:homepage" property="foaf:name" content="Hayato Ito" href="mailto:hayato@google.com">Hayato Ito</a>, Google, Inc.</span>
</dd>

    
    
      
        
          <dt>Revision history:</dt>
          
            
              
                <dd>
                  <a href="https://github.com/w3c/webcomponents/commits/gh-pages/spec/shadow/">https://github.com/w3c/webcomponents/commits/gh-pages/spec/shadow/</a>
                </dd>
              
            
          
        
      
    
  </dl>
  

  <div data-fill-with=warning>
    <details class=annoying-warning open>
      <summary>This Version of this Document Is Obsolete and Has Been Replaced</summary>
      <p>
        This version of the specification is obsolete and has been replaced by the document at <a href=http://w3c.github.io/webcomponents/spec/shadow/>http://w3c.github.io/webcomponents/spec/shadow/</a>.
        Do not attempt to implement this version of the specification.
        Do not refer to this version except as a historical artifact.
      </p>
    </details>
  </div>
  
  
    
      <p class="copyright">
        <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> ©
        2014
        
        <a href="http://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>®</sup>
        (<a href="http://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>,
        <a href="http://www.ercim.eu/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>,
        <a href="http://www.keio.ac.jp/">Keio</a>, <a href="http://ev.buaa.edu.cn/">Beihang</a>), 
        
        All Rights Reserved.
        
        <abbr title="World Wide Web Consortium">W3C</abbr> <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>,
        <a href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and
        
          <a href="http://www.w3.org/Consortium/Legal/copyright-documents">document use</a>
        
        rules apply.
      </p>
    
  
  <hr>
</div>
    <section id="abstract" class="introductory" property="dcterms:abstract" datatype="" typeof="bibo:Chapter" resource="#abstract" rel="bibo:Chapter"><h2 aria-level="1" role="heading" id="h2_abstract">Abstract</h2>
      <p>
        This specification describes a method of combining multiple DOM trees into one hierarchy and how these trees interact with each other within a document, thus
        enabling better composition of the DOM.
      </p>
    </section><section id="sotd" class="introductory" typeof="bibo:Chapter" resource="#sotd" rel="bibo:Chapter"><h2 aria-level="1" role="heading" id="h2_sotd">Status of This Document</h2>
  
    
      
        <p>
          <em>This section describes the status of this document at the time of its publication.
          Other documents may supersede this document. A list of current <abbr title="World Wide Web Consortium">W3C</abbr> publications and the
          latest revision of this technical report can be found in the <a href="http://www.w3.org/TR/"><abbr title="World Wide Web Consortium">W3C</abbr> technical reports index</a> at
          http://www.w3.org/TR/.</em>
        </p>
        
    
        <p>
          This document was published by the <a href="http://www.w3.org/2008/webapps/"><abbr title="World Wide Web Consortium">W3C</abbr> Web Applications (WebApps)</a> as a Working Draft.
          
          
            If you wish to make comments regarding this document, please send them to 
            <a href="mailto:public-webapps@w3.org">public-webapps@w3.org</a> 
            (<a href="mailto:public-webapps-request@w3.org?subject=subscribe">subscribe</a>,
            <a href="http://lists.w3.org/Archives/Public/public-webapps/">archives</a>).
          
          
          
          
            All comments are welcome.
          
        </p>
        
        
          <p>
            Publication as a Working Draft does not imply endorsement by the <abbr title="World Wide Web Consortium">W3C</abbr>
            Membership. This is a draft document and may be updated, replaced or obsoleted by other
            documents at any time. It is inappropriate to cite this document as other than work in
            progress.
          </p>
        
        
        
        <p>
          
            This document was produced by a group operating under the 
            <a id="sotd_patent" about="" rel="w3p:patentRules" href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004 <abbr title="World Wide Web Consortium">W3C</abbr> Patent
            Policy</a>.
          
          
          
            
              <abbr title="World Wide Web Consortium">W3C</abbr> maintains a <a href="http://www.w3.org/2004/01/pp-impl/42538/status" rel="disclosure">public list of any patent
              disclosures</a> 
            
            made in connection with the deliverables of the group; that page also includes
            instructions for disclosing a patent. An individual who has actual knowledge of a patent
            which the individual believes contains
            <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential
            Claim(s)</a> must disclose the information in accordance with
            <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section
            6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>.
          
          
        </p>
        
      
    
  
</section><section id="toc"><h2 class="introductory" aria-level="1" role="heading" id="h2_toc">Table of Contents</h2><ul class="toc" role="directory" id="respecContents"><li class="tocline"><a href="#conformance" class="tocxref"><span class="secno">1. </span>Conformance</a></li><li class="tocline"><a href="#concepts" class="tocxref"><span class="secno">2. </span>Concepts</a><ul class="toc"><li class="tocline"><a href="#introduction" class="tocxref"><span class="secno">2.1 </span>Introduction</a></li><li class="tocline"><a href="#shadow-trees" class="tocxref"><span class="secno">2.2 </span>Shadow trees</a></li><li class="tocline"><a href="#trees-of-trees" class="tocxref"><span class="secno">2.3 </span>Trees of trees</a><ul class="toc"><li class="tocline"><a href="#example-tree-of-trees" class="tocxref"><span class="secno">2.3.1 </span>Example tree of trees</a></li></ul></li><li class="tocline"><a href="#composed-trees" class="tocxref"><span class="secno">2.4 </span>Composed trees</a></li></ul></li><li class="tocline"><a href="#distributions" class="tocxref"><span class="secno">3. </span>Distributions</a><ul class="toc"><li class="tocline"><a href="#insertion-points" class="tocxref"><span class="secno">3.1 </span>Insertion Points</a></li><li class="tocline"><a href="#content-insertion-points" class="tocxref"><span class="secno">3.2 </span>Content Insertion Points</a></li><li class="tocline"><a href="#shadow-insertion-points" class="tocxref"><span class="secno">3.3 </span>Shadow Insertion Points</a></li><li class="tocline"><a href="#distribution-results" class="tocxref"><span class="secno">3.4 </span>Distribution Results</a></li><li class="tocline"><a href="#distribution-algorithms" class="tocxref"><span class="secno">3.5 </span>Distribution Algorithms</a></li><li class="tocline"><a href="#satisfying-matching-criteria" class="tocxref"><span class="secno">3.6 </span>Satisfying Matching Criteria</a></li></ul></li><li class="tocline"><a href="#composition" class="tocxref"><span class="secno">4. </span>Composition</a></li><li class="tocline"><a href="#events" class="tocxref"><span class="secno">5. </span>Events</a><ul class="toc"><li class="tocline"><a href="#events-that-are-always-stopped" class="tocxref"><span class="secno">5.1 </span>Events that are Always Stopped</a></li><li class="tocline"><a href="#event-paths" class="tocxref"><span class="secno">5.2 </span>Event Paths</a></li><li class="tocline"><a href="#event-paths-example" class="tocxref"><span class="secno">5.3 </span>Event Paths Example</a></li><li class="tocline"><a href="#event-retargeting" class="tocxref"><span class="secno">5.4 </span>Event Retargeting</a></li><li class="tocline"><a href="#retargeting-relatedtarget" class="tocxref"><span class="secno">5.5 </span>Retargeting <code>relatedTarget</code></a></li><li class="tocline"><a href="#retargeting-touch-events" class="tocxref"><span class="secno">5.6 </span>Retargeting Touch Events</a></li><li class="tocline"><a href="#retargeting-focus-events" class="tocxref"><span class="secno">5.7 </span>Retargeting Focus Events</a></li><li class="tocline"><a href="#event-dispatch" class="tocxref"><span class="secno">5.8 </span>Event Dispatch</a></li><li class="tocline"><a href="#event-retargeting-example" class="tocxref"><span class="secno">5.9 </span>Event Retargeting Example</a></li></ul></li><li class="tocline"><a href="#user-interaction" class="tocxref"><span class="secno">6. </span>User Interaction</a><ul class="toc"><li class="tocline"><a href="#ranges-and-selections" class="tocxref"><span class="secno">6.1 </span>Ranges and Selections</a></li><li class="tocline"><a href="#focus-navigation" class="tocxref"><span class="secno">6.2 </span>Focus Navigation</a></li><li class="tocline"><a href="#active-element" class="tocxref"><span class="secno">6.3 </span>Active Element</a></li><li class="tocline"><a href="#editing" class="tocxref"><span class="secno">6.4 </span>Editing</a></li><li class="tocline"><a href="#assistive-technology" class="tocxref"><span class="secno">6.5 </span>Assistive Technology</a></li></ul></li><li class="tocline"><a href="#html-elements-in-shadow-trees" class="tocxref"><span class="secno">7. </span>HTML Elements in Shadow Trees</a><ul class="toc"><li class="tocline"><a href="#inert-html-elements" class="tocxref"><span class="secno">7.1 </span>Inert HTML Elements</a></li></ul></li><li class="tocline"><a href="#html-elements-and-their-shadow-trees" class="tocxref"><span class="secno">8. </span>HTML Elements and Their Shadow Trees</a></li><li class="tocline"><a href="#elements-and-dom-objects" class="tocxref"><span class="secno">9. </span>Elements and DOM Objects</a><ul class="toc"><li class="tocline"><a href="#shadowroot-object" class="tocxref"><span class="secno">9.1 </span><code>ShadowRoot</code> Object</a><ul class="toc"><li class="tocline"><a href="#attributes" class="tocxref"><span class="secno">9.1.1 </span>Attributes</a></li><li class="tocline"><a href="#methods" class="tocxref"><span class="secno">9.1.2 </span>Methods</a></li></ul></li><li class="tocline"><a href="#extensions-to-element-interface" class="tocxref"><span class="secno">9.2 </span>Extensions to <code>Element</code> Interface</a><ul class="toc"><li class="tocline"><a href="#attributes-1" class="tocxref"><span class="secno">9.2.1 </span>Attributes</a></li><li class="tocline"><a href="#methods-1" class="tocxref"><span class="secno">9.2.2 </span>Methods</a></li></ul></li><li class="tocline"><a href="#the-content-element" class="tocxref"><span class="secno">9.3 </span>The <code>content</code> element</a></li><li class="tocline"><a href="#the-shadow-element" class="tocxref"><span class="secno">9.4 </span>The <code>shadow</code> element</a></li><li class="tocline"><a href="#extensions-to-event-interface" class="tocxref"><span class="secno">9.5 </span>Extensions to <code>Event</code> Interface</a><ul class="toc"><li class="tocline"><a href="#attributes-2" class="tocxref"><span class="secno">9.5.1 </span>Attributes</a></li></ul></li></ul></li><li class="tocline"><a href="#shadow-dom-example" class="tocxref"><span class="secno">10. </span>Shadow DOM Example</a></li><li class="tocline"><a href="#acknowledgements" class="tocxref"><span class="secno">A. </span>Acknowledgements</a></li><li class="tocline"><a href="#references" class="tocxref"><span class="secno">B. </span>References</a><ul class="toc"><li class="tocline"><a href="#normative-references" class="tocxref"><span class="secno">B.1 </span>Normative references</a></li></ul></li></ul></section>

    

    <section id="conformance">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_conformance"><span class="secno">1. </span>Conformance</h2>

      <p>All diagrams, examples, notes, are non-normative, as well as sections explicitly marked as non-normative. Everything else in this specification is normative.</p>

      <p>The key words "<em class="rfc2119" title="MUST">MUST</em>", "<em class="rfc2119" title="MUST NOT">MUST NOT</em>", "<em class="rfc2119" title="REQUIRED">REQUIRED</em>", "<em class="rfc2119" title="SHALL">SHALL</em>", "<em class="rfc2119" title="SHALL NOT">SHALL NOT</em>", "<em class="rfc2119" title="SHOULD">SHOULD</em>", "<em class="rfc2119" title="SHOULD NOT">SHOULD NOT</em>", "<em class="rfc2119" title="RECOMMENDED">RECOMMENDED</em>", "<em class="rfc2119" title="MAY">MAY</em>", and "<em class="rfc2119" title="OPTIONAL">OPTIONAL</em>" in the normative parts of this document are to be interpreted as described in [<cite><a class="bibref" href="#bib-RFC2119">RFC2119</a></cite>]. For readability, these words do not appear in all uppercase letters in this specification.</p>

      <p>To help with layering and to avoid circular dependencies between various parts of specification, this document consists of three consecutive narratives:</p>
      <ol>
        <li>setting up the stage for the specification,</li>
        <li>explaining of the conceptual model and algorithms behind it, and</li>
        <li>expressing this model with DOM interfaces and HTML elements.</li>
      </ol>

      <p>In a sense, these parts can be viewed as <em>math</em>, which sets up the reasoning environment, <em>physics</em>, which is the theoretical reasoning about the concept, and <em>mechanics</em>, which is the practical application of this reasoning.</p>

      <p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="http://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence">processing equivalence</dfn> is a constraint imposed on the algorithm implementors, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>
    </section>

    <section id="concepts">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_concepts"><span class="secno">2. </span>Concepts</h2>

      <section class="informative" id="introduction">
        <h3 aria-level="2" role="heading" id="h3_introduction"><span class="secno">2.1 </span>Introduction</h3><p><em>This section is non-normative.</em></p>

        <p>
          See the <a href="http://w3c.github.io/webcomponents/explainer/#shadow-dom-section">Shadow DOM section</a> of <a href="http://w3c.github.io/webcomponents/explainer/">Introduction to Web Components</a> as a non-normative intruduction.
        </p>
      </section>

      <section id="shadow-trees">
        <h3 aria-level="2" role="heading" id="h3_shadow-trees"><span class="secno">2.2 </span>Shadow trees</h3>

        <p>A <dfn id="dfn-document-tree">document tree</dfn> is a <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> [<cite><a class="bibref" href="#bib-DOM">DOM</a></cite>] whose <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> is a <a href="http://dom.spec.whatwg.org/#concept-document" class="externalDFN">document</a>.</p>

        <p>Any element can have an <dfn title="shadow roots list" id="dfn-shadow-roots-list">associated ordered list</dfn> of zero or more <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a>.</p>

        <p>An element <dfn id="dfn-hosts">hosts</dfn> a <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> if the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> is a member of this associated list.</p>

        <p>A <dfn id="dfn-shadow-host">shadow host</dfn> is an element that <a href="#dfn-hosts" class="internalDFN">hosts</a> one or more <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a>.</p>

        <p>A <dfn id="dfn-shadow-tree">shadow tree</dfn> is a <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> <a title="hosts" href="#dfn-hosts" class="internalDFN">hosted</a> by a <a href="#dfn-shadow-host" class="internalDFN">shadow host</a>.</p>

        <p>A <dfn id="dfn-shadow-root">shadow root</dfn> is the <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of a shadow tree.</p>

        <p>If more than one <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> is <a title="hosts" href="#dfn-hosts" class="internalDFN">hosted</a> by the same <a href="#dfn-shadow-host" class="internalDFN">shadow host</a>, the more recently added <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> is called the <dfn id="dfn-younger-shadow-tree">younger shadow tree</dfn> and the less recently added <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> is called the <dfn id="dfn-older-shadow-tree">older shadow tree</dfn>.</p>

        <p>If there is no <a href="#dfn-older-shadow-tree" class="internalDFN">older shadow tree</a> than a given <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>,
          the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> is called the <dfn id="dfn-oldest-shadow-tree">oldest shadow tree</dfn>.</p>

        <p>If there is no <a href="#dfn-younger-shadow-tree" class="internalDFN">younger shadow tree</a> than a given <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>,
          the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> is called the <dfn id="dfn-youngest-shadow-tree">youngest shadow tree</dfn>.</p>

        <p>The <dfn id="dfn-older-shadow-root">older shadow root</dfn> is the root node of the <a href="#dfn-older-shadow-tree" class="internalDFN">older shadow tree</a>.</p>

        <p>The <dfn id="dfn-younger-shadow-root">younger shadow root</dfn> is the root node of the <a href="#dfn-younger-shadow-tree" class="internalDFN">younger shadow tree</a>.</p>

        <p>The <dfn id="dfn-oldest-shadow-root">oldest shadow root</dfn> is the root node of the <a href="#dfn-oldest-shadow-tree" class="internalDFN">oldest shadow tree</a>.</p>

        <p>The <dfn id="dfn-youngest-shadow-root">youngest shadow root</dfn> is the root node of the <a href="#dfn-youngest-shadow-tree" class="internalDFN">youngest shadow tree</a>.</p>

        <div class="note"><div class="note-title" aria-level="3" role="heading" id="h_note_1"><span>Note</span></div><p class="">
          For convenience, the <a href="#dfn-shadow-root" class="internalDFN">shadow root</a> provides its own set of <a title="DOM tree accessors" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-tree-accessors" class="externalDFN">DOM tree accessor</a> methods.
          No <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> other than the <a href="#dfn-shadow-root" class="internalDFN">shadow root</a> descendants are accessible with these methods.
        </p></div>
      </section>

      <section id="trees-of-trees">
        <h3 aria-level="2" role="heading" id="h3_trees-of-trees"><span class="secno">2.3 </span>Trees of trees</h3>

        <p>A <dfn id="dfn-tree-of-trees">tree of trees</dfn> is a <a href="http://dom.spec.whatwg.org/#trees" class="externalDFN">tree</a> of <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a>.</p>

        <div class="note"><div class="note-title" aria-level="3" role="heading" id="h_note_2"><span>Note</span></div><p class="">
          The purpose of introducing a tree of trees here is to define algorithms easily in the following sections.
          This is a kind of a notation techchique to make the this specification simpler.
        </p></div>

        <p>Just like a <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> is defined as <a title="tree" href="http://dom.spec.whatwg.org/#trees" class="externalDFN">a set of relationships</a> between <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a>,
          a <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a> is similarly defined as a set of relationships between <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a>:</p>
        <ul>
          <li>
            A <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> <var>A</var> is called a <dfn id="dfn-parent-tree">parent tree</dfn> of a <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> <var>B</var> if either of the following conditions is satisfied:
            <ul>
              <li><var>A</var> and <var>B</var> are next to each other in the same <a title="shadow roots list" href="#dfn-shadow-roots-list" class="internalDFN">associated ordered list</a> and <var>A</var> is the <a href="#dfn-older-shadow-tree" class="internalDFN">older shadow tree</a> relative to <var>B</var>.</li>
              <li><var>B</var> is the <a href="#dfn-oldest-shadow-tree" class="internalDFN">oldest shadow tree</a> and <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> of <var>B</var> participates in <var>A</var>.</li>
            </ul>

          </li>
          <li>If there is more than one <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> that shares the same <a href="#dfn-parent-tree" class="internalDFN">parent tree</a>, the <a href="http://dom.spec.whatwg.org/#concept-tree-order" class="externalDFN">tree order</a> between them in the <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a> is defined as follows:
            <ol>
              <li>Let <var>A</var> and <var>B</var> be <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a> that share the same <a href="#dfn-parent-tree" class="internalDFN">parent tree</a>.</li>
              <li><var>A</var> comes before <var>B</var> if either of the following conditions is satisfied:
                <ul>
                  <li>The <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> which <a href="#dfn-hosts" class="internalDFN">hosts</a> <var>A</var> is <a href="http://dom.spec.whatwg.org/#concept-tree-preceding" class="externalDFN">preceding</a> the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> which <a href="#dfn-hosts" class="internalDFN">hosts</a> <var>B</var>.</li>
                  <li><var>B</var> is not the <a href="#dfn-oldest-shadow-tree" class="internalDFN">oldest shadow tree</a>.</li>
                </ul>
              </li>
            </ol>
          </li>
          <li>Other relationships and terms, such as <dfn id="dfn-root-tree">root tree</dfn>, <dfn id="dfn-child-tree">child tree</dfn>,
            <dfn id="dfn-descendant-tree">descendant tree</dfn>, <dfn id="dfn-inclusive-descendant-tree">inclusive descendant tree</dfn>,
            <dfn id="dfn-ancestor-tree">ancestor tree</dfn>, <dfn id="dfn-inclusive-ancestor-tree">inclusive ancestor tree</dfn>,
            <dfn id="dfn-preceding-tree">preceding tree</dfn>
            are defined in the similar way as defined in <a title="tree" href="http://dom.spec.whatwg.org/#trees" class="externalDFN">trees</a>.</li>
        </ul>

        <p>The <a href="http://dom.spec.whatwg.org/#dom-node-ownerdocument" class="externalDFN"><code>ownerDocument</code></a> property of a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> in a shadow tree <strong>must</strong> refers to the <a href="http://dom.spec.whatwg.org/#concept-document" class="externalDFN">document</a> of the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> which <a href="#dfn-hosts" class="internalDFN">hosts</a> the shadow tree.</p>

        <p><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#window" class="externalDFN"><code>Window</code></a> object <a title="named access on the window object" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#named-access-on-the-window-object" class="externalDFN">named properties</a> [<cite><a class="bibref" href="#bib-HTML">HTML</a></cite>] <strong>must</strong> access the <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> in the <a href="#dfn-document-tree" class="internalDFN">document tree</a>.</p>

        <section class="informative" id="example-tree-of-trees">
          <h4 aria-level="3" role="heading" id="h4_example-tree-of-trees"><span class="secno">2.3.1 </span>Example tree of trees</h4><p><em>This section is non-normative.</em></p>

          <figure id="fig-a-tree-of-trees.x">
            <object data="tree-of-trees.svg" width="650" height="823"></object>
            <figcaption>Fig. <span class="figno">1</span> <span class="fig-title">
              A tree of trees.
            </span></figcaption>
          </figure>

          <p>
            In the figure, there are seven node trees, named A, B, C, D, E and F.
            The node trees, C, D and E, are hosted by the same <a href="#dfn-shadow-host" class="internalDFN">shadow host</a>, which participates in the node tree A.
            The node tree C is the <a href="#dfn-oldest-shadow-tree" class="internalDFN">oldest shadow tree</a>. The node tree E is the <a href="#dfn-youngest-shadow-tree" class="internalDFN">youngest shadow tree</a>.
            The following set of relationships holds in the figure:
            </p><ul>
              <li>The ordered list of A's <a title="child tree" href="#dfn-child-tree" class="internalDFN">child trees</a> is [B, C].</li>
              <li>The ordered list of B's <a title="child tree" href="#dfn-child-tree" class="internalDFN">child trees</a> is [].</li>
              <li>The ordered list of C's <a title="child tree" href="#dfn-child-tree" class="internalDFN">child trees</a> is [F, D].</li>
              <li>The ordered list of D's <a title="child tree" href="#dfn-child-tree" class="internalDFN">child trees</a> is [E].</li>
              <li>The ordered list of E's <a title="child tree" href="#dfn-child-tree" class="internalDFN">child trees</a> is [].</li>
            </ul>
          <p></p>
        </section>

      </section>

      <section id="composed-trees">
        <h3 aria-level="2" role="heading" id="h3_composed-trees"><span class="secno">2.4 </span>Composed trees</h3>

        <p>A <dfn id="dfn-composed-tree">composed tree</dfn> is a <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> which is constructed out of <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> from multiple <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a> in a <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a>.
          The exact algorithm of constructing a composed tree is specified later.</p>

        <figure id="fig-a-composed-tree">
          <object data="composed-tree.svg" width="654" height="606"></object>
          <figcaption>Fig. <span class="figno">2</span> <span class="fig-title">A composed tree</span></figcaption>
        </figure>

        <p>In <dfn id="dfn-rendering">rendering</dfn> a <a href="#dfn-document-tree" class="internalDFN">document tree</a>, or presenting it visually, the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a> <strong>must</strong> be used instead of the <a href="#dfn-document-tree" class="internalDFN">document tree</a>.</p>

        <p>The <a href="#dfn-composed-tree" class="internalDFN">composed tree</a> <strong>must</strong> be updated before the <a href="#dfn-rendering" class="internalDFN">rendering</a> occurs.</p>
      </section>

    </section>

    <section id="distributions">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_distributions"><span class="secno">3. </span>Distributions</h2>

      <section id="insertion-points">
        <h3 aria-level="2" role="heading" id="h3_insertion-points"><span class="secno">3.1 </span>Insertion Points</h3>

        <p>An <dfn id="dfn-insertion-point">insertion point</dfn> is a defined location where <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> in a different <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> appear instead of the nodes's original position when constructing a <a href="#dfn-composed-tree" class="internalDFN">composed tree</a>.</p>

        <figure id="fig-a-distribution">
          <object data="distributions.svg" width="663" height="598"></object>
          <figcaption>Fig. <span class="figno">3</span> <span class="fig-title">A distribution</span></figcaption>
        </figure>

        <p>A <dfn id="dfn-distribution">distribution</dfn> is the mechanism that determines which <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> appear at each <a href="#dfn-insertion-point" class="internalDFN">insertion point</a>. The exact algorithm of a <a href="#dfn-distribution" class="internalDFN">distribution</a> is specified later.</p>
      </section>


      <section id="content-insertion-points">
        <h3 aria-level="2" role="heading" id="h3_content-insertion-points"><span class="secno">3.2 </span>Content Insertion Points</h3>

        <p>A <dfn id="dfn-content-insertion-point">content insertion point</dfn> is an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> to where the child <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> of the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> are distributed.
          The <a href="#dfn-content-element" class="internalDFN">content element</a> that satisfies all of the following conditions represents a <a href="#dfn-content-insertion-point" class="internalDFN">content insertion point</a>:</p>
        <ul>
          <li>The <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of the <a href="#dfn-content-element" class="internalDFN">content element</a> is a <a href="#dfn-shadow-root" class="internalDFN">shadow root</a></li>
          <li>There is no other <a href="#dfn-content-element" class="internalDFN">content element</a> in the <a title="ancestor" href="http://dom.spec.whatwg.org/#concept-tree-ancestor" class="externalDFN">ancestors</a> of the <a href="#dfn-content-element" class="internalDFN">content element</a></li>
          <li>There is no <a href="#dfn-shadow-element" class="internalDFN">shadow element</a> in the <a title="ancestor" href="http://dom.spec.whatwg.org/#concept-tree-ancestor" class="externalDFN">ancestors</a> of the <a href="#dfn-content-element" class="internalDFN">content element</a></li>
        </ul>
      </section>

      <section id="shadow-insertion-points">
        <h3 aria-level="2" role="heading" id="h3_shadow-insertion-points"><span class="secno">3.3 </span>Shadow Insertion Points</h3>

        <p>A <dfn id="dfn-shadow-insertion-point">shadow insertion point</dfn> is an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> to where the children of the <a href="#dfn-older-shadow-root" class="internalDFN">older shadow root</a> are distributed.
          The <a href="#dfn-shadow-element" class="internalDFN">shadow element</a> that satisfies of the following conditions represents a <a href="#dfn-shadow-insertion-point" class="internalDFN">shadow insertion point</a>:</p>
        <ul>
          <li>The <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of the <a href="#dfn-shadow-element" class="internalDFN">shadow element</a> is a <a href="#dfn-shadow-root" class="internalDFN">shadow root</a></li>
          <li>There is no other <a href="#dfn-shadow-element" class="internalDFN">shadow element</a> which is <a href="http://dom.spec.whatwg.org/#concept-tree-preceding" class="externalDFN">preceding</a> the <a href="#dfn-shadow-element" class="internalDFN">shadow element</a></li>
          <li>There is no other <a href="#dfn-content-element" class="internalDFN">content element</a> in the <a title="ancestor" href="http://dom.spec.whatwg.org/#concept-tree-ancestor" class="externalDFN">ancestors</a> of the <a href="#dfn-shadow-element" class="internalDFN">shadow element</a></li>
        </ul>
      </section>

      <section id="distribution-results">
        <h3 aria-level="2" role="heading" id="h3_distribution-results"><span class="secno">3.4 </span>Distribution Results</h3>

        <p>Each <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a> has the <dfn id="dfn-distribution-result">distribution result</dfn> which describes the result of distributions.
          The <a href="#dfn-distribution-result" class="internalDFN">distribution result</a> <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> of the following:</p>
        <ol>
          <li>Each <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> has an ordered list, called <dfn id="dfn-distributed-nodes">distributed nodes</dfn>, which consists of <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> which are distributed into the <a href="#dfn-insertion-point" class="internalDFN">insertion point</a>.</li>
          <li>Each <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> that is not an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> has an ordered list, called <dfn id="dfn-destination-insertion-points">destination insertion points</dfn>, which consists of <a title="insertion point" href="#dfn-insertion-point" class="internalDFN">insertion points</a> to where the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> is distributed</li>
        </ol>

        <p>An <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> <var>A</var> is the <dfn id="dfn-final-destination">final destination</dfn> of a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> <var>B</var> if <var>A</var> is the last item of the <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of <var>B</var>.</p>

        <p>When a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> <var>A</var> is <dfn title="distributes" id="dfn-distributes">distributed</dfn> into an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> <var>B</var>, the following steps <strong>must</strong> happen:</p>
        <ul>
          <li>Add <var>A</var> to the <a href="#dfn-distributed-nodes" class="internalDFN">distributed nodes</a> of <var>B</var></li>
          <li>Add <var>B</var> to the <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of <var>A</var></li>
        </ul>

        <div class="note"><div class="note-title" aria-level="3" role="heading" id="h_note_3"><span>Note</span></div><div class="">
          <p>One case that deserves special consideration is the situation when an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> is a child <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of another <a href="#dfn-shadow-host" class="internalDFN">shadow host</a>. In such situations, the <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> <a title="distributes" href="#dfn-distributes" class="internalDFN">distributed</a> into that <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> appear as if they were child <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> of the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> in the context of <a href="#dfn-distribution" class="internalDFN">distribution</a>. Thus, the <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> <a title="distributes" href="#dfn-distributes" class="internalDFN">distributed</a> to a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> could have already been <a title="distributes" href="#dfn-distributes" class="internalDFN">distributed</a> from its parent tree.</p>

          <p>Despite being distributed to more than one insertion point, a node still only appears once in the composed tree at the final destination.</p>
        </div></div>

        <figure id="fig-a-re-distribution.-in-the-figure-a-node-child-1-is-distributed-into-insertion-point-1.-then-child1-is-re-distributed-into-insertion-point-3.-the-destination-insertion-points-of-child-1-is-insertion-point-1-insertion-point-3-and-insertion-point-3-is-the-final-destination-of-child-1.-the-distributed-nodes-of-insertion-point-1-and-insertion-point-3-is-child-1-and-child-1-child-3-respectively.x">
          <object data="re-distributions.svg" width="693" height="822"></object>
          <figcaption>Fig. <span class="figno">4</span> <span class="fig-title">A re-distribution.
            In the figure, a node <em>child 1</em> is distributed into <em>insertion point 1</em>. Then <em>child1</em> is re-distributed into <em>insertion point 3</em>.
            The destination insertion points of <em>child 1</em> is [<em>insertion point 1</em>, <em>insertion point 3</em>] and <em>insertion point 3</em> is the final destination of <em>child 1</em>.
            The distributed nodes of <em>insertion point 1</em> and <em>insertion point 3</em> is [<em>child 1</em>] and [<em>child 1</em>, <em>child 3</em>], respectively.
          </span></figcaption>
        </figure>

      </section>

      <section id="distribution-algorithms">
        <h3 aria-level="2" role="heading" id="h3_distribution-algorithms"><span class="secno">3.5 </span>Distribution Algorithms</h3>

        <p>The <dfn id="dfn-distribution-algorithm">distribution algorithm</dfn> <strong>must</strong> be used to determine the <a href="#dfn-distribution-result" class="internalDFN">distribution result</a> for a <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a> and <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>TREE-OF-TREES</var>, a <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a></dd>
            <dt>Output</dt>
            <dd>The <a href="#dfn-distribution-result" class="internalDFN">distribution result</a> of <var>TREE-OF-TREES</var> is updated</dd>
          </dl>
          <ol>
            <li>Let all <a href="#dfn-distributed-nodes" class="internalDFN">distributed nodes</a> and <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> owned by <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> in <var>TREE-OF-TREES</var> be empty</li>
            <li>Let <var>ROOT-TREE</var> be the <a href="#dfn-root-tree" class="internalDFN">root tree</a> of <var>TREE-OF-TREES</var></li>
            <li>Run the <a href="#dfn-distribution-resolution-algorithm" class="internalDFN">distribution resolution algorithm</a> with <var>ROOT-TREE</var> as input</li>
          </ol>
        </div>

        <p>The <dfn id="dfn-distribution-resolution-algorithm">distribution resolution algorithm</dfn> <strong>must</strong> be used to determine the <a href="#dfn-distribution-result" class="internalDFN">distribution result</a> for a given <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> and its <a title="descendant tree" href="#dfn-descendant-tree" class="internalDFN">descendant trees</a>, and <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>NODE-TREE</var>, a <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a></dd>
            <dt>Output</dt>
            <dd>The <a href="#dfn-distribution-result" class="internalDFN">distribution result</a> is updated for the <a title="inclusive descendant tree" href="#dfn-inclusive-descendant-tree" class="internalDFN">inclusive descendant trees</a> of <var>NODE-TREE</var></dd>
          </dl>

          <ol>
            <li>For each <a href="#dfn-shadow-host" class="internalDFN">shadow host</a>, <var>SHADOW-HOST</var>, which participates in <var>NODE-TREE</var>, in <a href="http://dom.spec.whatwg.org/#concept-tree-order" class="externalDFN">tree order</a>:
              <ol>
                <li>Let <var>POOL</var> be the result of the <a href="#dfn-pool-population-algorithm" class="internalDFN">pool population algorithm</a> with <var>SHADOW-HOST</var> as input</li>
                <li>For each <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>, <var>SHADOW-TREE</var>, which <var>SHADOW-HOST</var> <a href="#dfn-hosts" class="internalDFN">hosts</a>, in order from the <a href="#dfn-youngest-shadow-tree" class="internalDFN">youngest shadow tree</a> to the <a href="#dfn-oldest-shadow-tree" class="internalDFN">oldest shadow tree</a>:
                  <ol>
                    <li>Run the <a href="#dfn-pool-distribution-algorithm" class="internalDFN">pool distribution algorithm</a> with <var>SHADOW-TREE</var> and <var>POOL</var> as input</li>
                  </ol></li>
                <li>For each <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>, <var>SHADOW-TREE</var>, that <var>SHADOW-HOST</var> <a href="#dfn-hosts" class="internalDFN">hosts</a>, in order from the <a href="#dfn-oldest-shadow-tree" class="internalDFN">oldest shadow tree</a> to the <a href="#dfn-youngest-shadow-tree" class="internalDFN">youngest shadow tree</a>:
                  <ol>
                    <li>Let <var>SHADOW</var> be the <a href="#dfn-shadow-insertion-point" class="internalDFN">shadow insertion point</a> which participates in <var>SHADOW-TREE</var></li>
                    <li>If such a <var>SHADOW</var> exits:
                      <ol>
                        <li>If <var>SHADOW-TREE</var> is not the <a href="#dfn-oldest-shadow-tree" class="internalDFN">oldest shadow tree</a>:
                          <ol>
                            <li>Let <var>POOL</var> be the result of the <a href="#dfn-pool-population-algorithm" class="internalDFN">pool population algorithm</a> with the root node of the <a href="#dfn-older-shadow-tree" class="internalDFN">older shadow tree</a> relative to <var>SHADOW-TREE</var> as input.</li>
                          </ol></li>
                        <li>For each <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a>, <var>CHILD</var>, in <var>POOL</var>
                          <ol>
                            <li><a title="distributes" href="#dfn-distributes" class="internalDFN">Distribute</a> <var>CHILD</var> into <var>SHADOW</var></li>
                          </ol></li>
                      </ol></li>
                    <li>Run the <a href="#dfn-distribution-resolution-algorithm" class="internalDFN">distribution resolution algorithm</a>, recursively, with <var>SHADOW-TREE</var> as input</li>
                  </ol></li>
              </ol></li>
          </ol>
        </div>

        <p>The <dfn id="dfn-pool-population-algorithm">pool population algorithm</dfn> <strong>must</strong> be used to populate <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> from the child <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> of a given <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> and <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>NODE</var>, a node</dd>
            <dt>Output</dt>
            <dd><var>POOL</var>, an ordered list of nodes</dd>
          </dl>

          <ol>
            <li>Let <var>POOL</var> be an empty ordered list.</li>
            <li>For each child <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a>, <var>CHILD</var>, of <var>NODE</var>:
              <ol>
                <li>If <var>CHILD</var> is an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a>:
                  <ol>
                    <li>Add all <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> in the <a href="#dfn-distributed-nodes" class="internalDFN">distributed nodes</a> of <var>CHILD</var> to <var>POOL</var></li>
                  </ol></li>
                <li>Otherwise:
                  <ol>
                    <li>Add <var>CHILD</var> to <var>POOL</var></li>
                  </ol></li>
              </ol></li>
          </ol>
        </div>

        <p>The <dfn id="dfn-pool-distribution-algorithm">pool distribution algorithm</dfn> <strong>must</strong> be used to distribute <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> in a pool into the <a title="content insertion point" href="#dfn-content-insertion-point" class="internalDFN">content insertion points</a> in a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> and <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>SHADOW-TREE</var>, a shadow tree</dd>
            <dd><var>POOL</var>, an ordered list of nodes</dd>
            <dt>Output</dt>
            <dd>Nodes in POOL are distributed into the content insertion points in the tree.</dd>
          </dl>

          <ol>
            <li>For each <a href="#dfn-content-insertion-point" class="internalDFN">content insertion point</a>, <var>CONTENT</var>, which participates in <var>SHADOW-TREE</var>, in tree order:
              <ol>
                <li>For each <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a>, <var>NODE</var>, in <var>POOL</var>
                  <ol>
                    <li>If <var>NODE</var> satisfies <var>CONTENT</var>'s matching criteria:
                      <ol>
                        <li><a title="distributes" href="#dfn-distributes" class="internalDFN">Distribute</a> <var>NODE</var> into <var>CONTENT</var></li>
                        <li>Remove <var>NODE</var> from <var>POOL</var></li>
                      </ol></li>
                  </ol></li>
                <li>If no <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> are distributed to <var>CONTENT</var>:
                  <ol>
                    <li>For each child, <var>CHILD</var>, of <var>CONTENT</var>
                      <ol>
                        <li><a title="distributes" href="#dfn-distributes" class="internalDFN">Distribute</a> <var>CHILD</var> into <var>CONTENT</var></li>
                      </ol></li>
                  </ol></li>
              </ol></li>
          </ol>

        </div>

        <div class="note"><div class="note-title" aria-level="3" role="heading" id="h_note_4"><span>Note</span></div><p class="">If no nodes are distributed into a <a href="#dfn-content-insertion-point" class="internalDFN">content insertion point</a> <var>CONTENT</var>, the child <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> of <var>CONTENT</var> are distributed into <var>CONTENT</var> as fallback nodes.</p></div>

        <p>If any condition which affects the <a href="#dfn-distribution-result" class="internalDFN">distribution result</a> changes, the <a href="#dfn-distribution-result" class="internalDFN">distribution result</a> <strong>must</strong> be updated before any use of the <a href="#dfn-distribution-result" class="internalDFN">distribution result</a>.</p>

      </section>

      <section id="satisfying-matching-criteria">
        <h3 aria-level="2" role="heading" id="h3_satisfying-matching-criteria"><span class="secno">3.6 </span>Satisfying Matching Criteria</h3>

        <p>The <dfn id="dfn-matching-criteria">matching criteria</dfn> for an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> is a set of <a title="compound selector" href="http://dev.w3.org/csswg/selectors4/#compound" class="externalDFN">compound selectors</a> [<cite><a class="bibref" href="#bib-SELECTORS4">SELECTORS4</a></cite>]. These <a title="compound selector" href="http://dev.w3.org/csswg/selectors4/#compound" class="externalDFN">compound selectors</a> are restricted to contain only these <a title="simple selector" href="http://dev.w3.org/csswg/selectors4/#simple" class="externalDFN">simple selectors</a>:</p>

        <ul>
          <li>A <a href="http://dev.w3.org/csswg/selectors4/#type-selector" class="externalDFN">type selector</a> or a <a href="http://dev.w3.org/csswg/selectors4/#universal-selector" class="externalDFN">universal selector</a></li>
          <li><a title="class selector" href="http://dev.w3.org/csswg/selectors4/#class-selector" class="externalDFN">class selector(s)</a></li>
          <li>An <a href="http://dev.w3.org/csswg/selectors4/#id-selector" class="externalDFN">ID selector</a></li>
          <li><a title="attribute selector" href="http://dev.w3.org/csswg/selectors4/#attribute-selector" class="externalDFN">attribute selector(s)</a></li>
          <li>A <a href="http://dev.w3.org/csswg/selectors4/#negation" class="externalDFN">negation pseudo-class</a>, <code>:not()</code></li>
        </ul>

        <p>A <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> <dfn title="satisfies-matching-criteria" id="dfn-satisfies-matching-criteria">satisfies</dfn> a <a href="#dfn-matching-criteria" class="internalDFN">matching criteria</a> only if:</p>
        <ol>
          <li>all <a title="compound selector" href="http://dev.w3.org/csswg/selectors4/#compound" class="externalDFN">compound selectors</a> in the set, contain only the <a title="simple selector" href="http://dev.w3.org/csswg/selectors4/#simple" class="externalDFN">simple selectors</a> specified above; and</li>
          <li>a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> matches at least one <a title="compound selector" href="http://dev.w3.org/csswg/selectors4/#compound" class="externalDFN">compound selectors</a> in the set or the set is empty.</li>
        </ol>
      </section>

    </section>

    <section id="composition">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_composition"><span class="secno">4. </span>Composition</h2>

      <p>The <dfn id="dfn-composed-tree-children-calculation-algorithm">composed tree children calculation algorithm</dfn> <strong>must</strong> be used to determine the child <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> of a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> in the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a> and <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to processing the following steps:</p>

      <div class="algorithm">
        <dl>
          <dt>Input</dt>
          <dd><var>NODE</var>, a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> which participates in a composed tree</dd>
          <dt>Output</dt>
          <dd><var>CHILDREN</var>, the child nodes of <var>NODE</var> in the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a>.</dd>
        </dl>

        <ol>
          <li>Let <var>CHILDREN</var> be an empty ordered list of nodes</li>
          <li>If <var>NODE</var> is a <a href="#dfn-shadow-host" class="internalDFN">shadow host</a>:
            <ol>
              <li>Let <var>CHILD-POOL</var> be the children of the <a href="#dfn-youngest-shadow-root" class="internalDFN">youngest shadow root</a> which <var>NODE</var> <a href="#dfn-hosts" class="internalDFN">hosts</a>.</li>
            </ol></li>
          <li>Otherwise:
            <ol>
              <li>Let <var>CHILD-POOL</var> be the child <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> of NODE</li>
            </ol></li>
          <li>For each <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a>, <var>CHILD</var>, in <var>CHILD-POOL</var>:
            <ol>
              <li>If <var>CHILD</var> is an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a>:
                <ol>
                  <li>For each <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a>, <var>DISTRIBUTED-NODE</var>, in the <a href="#dfn-distributed-nodes" class="internalDFN">distributed nodes</a> of the <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> <var>CHILD</var>:
                    <ol>
                      <li>If <var>CHILD</var> is the <a href="#dfn-final-destination" class="internalDFN">final destination</a> of <var>DISTRIBUTED-NODE</var>, add <var>DISTRIBUTED-NODE</var> to <var>CHILDREN</var></li>
                    </ol></li>
                </ol></li>
              <li>Otherwise:
                <ol>
                  <li>Add <var>CHILD</var> to <var>CHILDREN</var></li>
                </ol></li>
            </ol></li>
        </ol>

      </div>

      <p>For a given <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a> <var>TREE-OF-TREES</var>, the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a> constructed from <var>TREE-OF-TREES</var> <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to the following tree:</p>
      <ul>
        <li>The <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a> is the <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of the <a href="#dfn-root-tree" class="internalDFN">root tree</a> of <var>TREE-OF-TREES</var>.</li>
        <li>For a given <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> which <a href="http://dom.spec.whatwg.org/#concept-tree-participate" class="externalDFN">participates</a> in the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a>, the child <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> of the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> is the result of the <a href="#dfn-composed-tree-children-calculation-algorithm" class="internalDFN">composed tree children calculation algorithm</a> with the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> as input.
        </li>
      </ul>
    </section>

    <section id="events">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_events"><span class="secno">5. </span>Events</h2>

      <p>When an <a href="http://dom.spec.whatwg.org/#events" class="externalDFN">event</a> is <a title="event dispatch" href="http://dom.spec.whatwg.org/#concept-event-dispatch" class="externalDFN">dispatched</a> in a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>, its path either crosses the <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a> or is terminated at the <a href="#dfn-shadow-root" class="internalDFN">shadow root</a>. One exception are the <a title="mutation event" href="http://www.w3.org/TR/DOM-Level-3-Events/#interface-MutationEvent" class="externalDFN">mutation events</a>. The <a title="mutation event" href="http://www.w3.org/TR/DOM-Level-3-Events/#interface-MutationEvent" class="externalDFN">mutation event types</a> <strong>must</strong> never be dispatched in a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>

      <section id="events-that-are-always-stopped">
        <h3 aria-level="2" role="heading" id="h3_events-that-are-always-stopped"><span class="secno">5.1 </span>Events that are Always Stopped</h3>

        <p>The <dfn title="events-always-stopped" id="dfn-events-always-stopped">following events</dfn> <strong>must</strong> always be stopped at the <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a>:</p>
        <ul>
          <li><code>abort</code></li>
          <li><code>error</code></li>
          <li><code>select</code></li>
          <li><code>change</code></li>
          <li><code>load</code></li>
          <li><code>reset</code></li>
          <li><code>resize</code></li>
          <li><code>scroll</code></li>
          <li><code>selectstart</code></li>
        </ul>
      </section>

      <section id="event-paths">
        <h3 aria-level="2" role="heading" id="h3_event-paths"><span class="secno">5.2 </span>Event Paths</h3>

        <p>The <dfn id="dfn-event-path-calculation-algorithm">event path calculation algorithm</dfn> must be used to determine event path and <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>NODE</var>, a node</dd>
            <dd><var>EVENT</var>, an event</dd>
            <dt>Output</dt>
            <dd><var>PATH</var>, an event path, a ordered list of an event target</dd>
          </dl>
          <ol>
            <li>Let <var>PATH</var> be the empty ordered list of nodes</li>
            <li>Let <var>CURRENT</var> be <var>NODE</var></li>
            <li>Add <var>CURRENT</var> to <var>PATH</var></li>
            <li>Repeat while <var>CURRENT</var> exists:
              <ol>
                <li>If the <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of <var>CURRENT</var> is not empty:
                  <ol>
                    <li>For each <a href="#dfn-insertion-point" class="internalDFN">insertion point</a>, <var>INSERTION-POINT</var>, in the <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of <var>CURRENT</var>:
                      <ol>
                        <li>If <var>INSERTION-POINT</var> is a <a href="#dfn-shadow-insertion-point" class="internalDFN">shadow insertion point</a>:
                          <ol>
                            <li>Let <var>SHADOW-ROOT</var> be the <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of <var>INSERTION-POINT</var></li>
                            <li>If <var>SHADOW-ROOT</var> is not the <a href="#dfn-oldest-shadow-root" class="internalDFN">oldest shadow root</a>:
                              <ol>
                                <li>Add the <a href="#dfn-older-shadow-root" class="internalDFN">older shadow root</a> relative to <var>SHADOW-ROOT</var> to <var>PATH</var></li>
                              </ol></li>
                          </ol></li>
                        <li>Add <var>INSERTION-POINT</var> to <var>PATH</var></li>
                      </ol></li>
                    <li>Let <var>CURRENT</var> be the <a href="#dfn-final-destination" class="internalDFN">final destination</a> of <var>CURRENT</var></li>
                  </ol></li>
                <li>Otherwise:
                  <ol>
                    <li>If <var>CURRENT</var> is a <a href="#dfn-shadow-root" class="internalDFN">shadow root</a>:
                      <ol>
                        <li>If <var>NODE</var> and <var>CURRENT</var> are in the same <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> and <var>EVENT</var> is one of the <a title="events-always-stopped" href="#dfn-events-always-stopped" class="internalDFN">events which must be stopped</a>:
                          <ol>
                            <li>Stop this algorithm</li>
                          </ol></li>
                        <li>Let <var>CURRENT</var> be the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> which <a href="#dfn-hosts" class="internalDFN">hosts</a> <var>CURRENT</var></li>
                        <li>Add <var>CURRENT</var> to <var>PATH</var></li>
                      </ol></li>
                    <li>Otherwise:
                      <ol>
                        <li>Let <var>CURRENT</var> be the <a href="http://dom.spec.whatwg.org/#concept-tree-parent" class="externalDFN">parent</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of <var>CURRENT</var></li>
                        <li>If <var>CURRENT</var> exists:
                          <ol>
                            <li>Add <var>CURRENT</var> to <var>PATH</var></li>
                          </ol></li>
                      </ol></li>
                  </ol></li>
              </ol></li>
          </ol>
        </div>

      </section>

      <section class="informative" id="event-paths-example">
        <h3 aria-level="2" role="heading" id="h3_event-paths-example"><span class="secno">5.3 </span>Event Paths Example</h3><p><em>This section is non-normative.</em></p>

        <p>
          Suppose we have the following tree of trees:
        </p>

        <figure id="fig-an-example-tree-of-trees.-nodes-which-are-not-involved-in-the-example-event-path-which-is-explained-later-are-omitted.x">
          <object data="event-path-tree-of-trees.svg" width="301" height="1074"></object>
          <figcaption>Fig. <span class="figno">5</span> <span class="fig-title">An example tree of trees. Nodes which are not involved in the example event path, which is explained later, are omitted.</span></figcaption>
        </figure>

        <ul>
          <li>
            <code>A</code> is a <a href="http://dom.spec.whatwg.org/#concept-document" class="externalDFN">document</a>.
          </li>
          <li>
            <code>E</code>, <code>J</code>, <code>N</code>, <code>Q</code>, <code>S</code> and <code>V</code> are <a title="shadow root" href="#dfn-shadow-root" class="internalDFN">shadow roots</a>.
          </li>
          <li>
            <code>I</code>, <code>M</code>, <code>P</code>, <code>R</code> and <code>U</code> are <a title="content insertion point" href="#dfn-content-insertion-point" class="internalDFN">content insertion points</a>.
          </li>
          <li>
            <code>X</code> is a <a href="#dfn-shadow-insertion-point" class="internalDFN">shadow insertion point</a>.
          </li>
        </ul>

        <p>
          This <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a> has the following seven <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a>, one <a href="#dfn-document-tree" class="internalDFN">document tree</a> and six <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a>:
        </p>

        <ul>
          <li>
            The <var>document tree 1</var>. Node <code>A</code>, <code>B</code>, <code>C</code> and <code>D</code> participate in that.
          </li>
          <li>
            The <var>shadow tree 2</var> hosted by <code>B</code>. Node <code>E</code>, <code>F</code>, <code>G</code>, <code>H</code> and <code>I</code> participate in that.
          </li>
          <li>
            The <var>shadow tree 3</var> hosted by <code>H</code>. Node <code>J</code>, <code>K</code>, <code>L</code> and <code>M</code> participate in that.
          </li>
          <li>
            The <var>shadow tree 4</var> hosted by <code>K</code>. Node <code>N</code>, <code>O</code> and <code>P</code> participate in that.
          </li>
          <li>
            The <var>shadow tree 5</var> hosted by <code>O</code>. Node <code>Q</code> and <code>R</code> participate in that.
          </li>
          <li>
            The <var>shadow tree 6</var> hosted by <code>F</code>. Node <code>S</code>, <code>T</code> and <code>U</code> participate in that.
          </li>
          <li>
            The <var>shadow tree 7</var> hosted by <code>B</code>. Node <code>V</code>, <code>W</code> and <code>X</code> participate in that.
            This <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> is younger than the <var>shadow tree 2</var>.
          </li>
        </ul>

        <p>
          Let's assume that the <a href="#dfn-distribution-result" class="internalDFN">distribution result</a> of this <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a> is:
        </p>

        <ul>
          <li>
            The <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of <code>C</code> are <code>[I, M]</code> (<code>C</code> is re-distributed)
          </li>
          <li>
            The <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of <code>L</code> are <code>[P, R]</code> (<code>L</code> is re-distributed)
          </li>
          <li>
            The <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of <code>G</code> are <code>[U]</code>
          </li>
          <li>
            The <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of <code>F</code> are <code>[X]</code>
          </li>
        </ul>

        <p>
          In this case, if an event is dispatched on node <code>D</code>, the event path will be:
        </p>
        <p>
          <code>
            [D, C, I, M, L, P, R, Q, O, N, K, J, H, G, U, T, S, F, E, X, W, V, B, A]
          </code>
        </p>

        <p>
          Note that the <a href="#dfn-event-path-calculation-algorithm" class="internalDFN">event path calculation algorithm</a> is designed to achieve the following goals:
        </p>

        <ol>
          <li>
            If there is a node, <var>CHILD</var>, in the event path and <var>CHILD</var> has a parent node, <var>PARENT</var>, in the node tree, the event path also includes <var>PARENT</var>.
            <var>PARENT</var> always appears somewhere after <var>CHILD</var> in the event path.
          </li>
          <li>
            Nodes in the event path form a <em>linear ancestor chain</em> in each <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a>. There are no <em>branch points</em> in each <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a>.
          </li>
        </ol>

        <figure id="fig-the-relationship-between-an-event-path-and-node-trees.-in-the-figure-a-number-shown-in-a-left-side-of-each-node-represents-a-zero-based-position-of-each-node-in-the-event-path.-a-parent-node-always-have-a-larger-number-than-that-of-its-child-node-in-each-node-tree.x">
          <object data="event-path-node-trees.svg" width="884" height="473">&gt;</object>
          <figcaption>Fig. <span class="figno">6</span> <span class="fig-title">
            The relationship between an event path and node trees. In the figure, a number shown in a left-side of each node represents a zero-based position of each node in the event path.
            A parent node always have a larger number than that of its child node in each node tree.
          </span></figcaption>
        </figure>

        <p>
          That means if we focus on one <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> and forget all other <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a>,
          the event path would be seen as if the event happened only on the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> which we are focused on.
          This is an important aspect in a sense that hosting shadow trees doesn't have any effect to the event path <em>within</em> the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> participate in
          as long as the event is not stopped somewhere in the <a title="descendant tree" href="#dfn-descendant-tree" class="internalDFN">descendant trees</a>.
        </p>

        <p>
          For example, from the view of the <var>document tree 1</var>, the event path would be seen as <code>[D, C, B, A]</code>.
          From the view of the <var>shadow tree 2</var>, the event path would be seen as <code>[I, H, G, F, E]</code>.
          The similar things also apply to other <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a>.
        </p>

        <p>
          It is also worth pointing out that if we exclude all <a title="insertion point" href="#dfn-insertion-point" class="internalDFN">insertion points</a> and <a title="shadow root" href="#dfn-shadow-root" class="internalDFN">shadow roots</a> from an event path,
          the result would be equivalent to the inclusive ancestors of the node on which the event is dispatched, in the composed tree.
        </p>

        <figure id="fig-the-relationship-between-an-event-path-and-the-composed-tree.-the-event-path-used-in-the-example-is-shown-in-the-left-hand-side-and-the-composed-tree-is-shown-in-the-right-hand-side.-if-we-exclude-all-insertion-points-and-shadow-roots-from-the-event-path-the-result-would-be-equivalent-to-the-inclusive-ancestors-of-the-node-d-in-the-composed-tree.x">
          <object data="event-path-and-composed-tree.svg" width="217" height="1723"></object>
          <figcaption>Fig. <span class="figno">7</span> <span class="fig-title">
            The relationship between an event path and the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a>. The event path used in the example is shown in the left-hand side and the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a> is shown in the right-hand side.
            If we exclude all <a title="insertion point" href="#dfn-insertion-point" class="internalDFN">insertion points</a> and <a title="shadow root" href="#dfn-shadow-root" class="internalDFN">shadow roots</a> from the event path,
            the result would be equivalent to the inclusive ancestors of the node, <code>D</code>, in the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a>.
          </span></figcaption>
        </figure>

      </section>

      <section id="event-retargeting">
        <h3 aria-level="2" role="heading" id="h3_event-retargeting"><span class="secno">5.4 </span>Event Retargeting</h3>

        <p>In the cases where event path is across multiple node trees, the event's information about the target of the event is adjusted in order to maintain encapsulation. Event <dfn id="dfn-retargeting">retargeting</dfn> is a process of computing relative targets for each ancestor of the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> at which the event is dispatched. A <dfn id="dfn-relative-target">relative target</dfn> is a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> that most accurately represents the target of a dispatched event at a given ancestor while maintaining the encapsulation.</p>

        <p>The <dfn id="dfn-retargeting-algorithm">retargeting algorithm</dfn> is used to determine relative targets, and it <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>EVENT-PATH</var>, an event path</dd>
            <dd><var>CURRENT-TARGET</var>, a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> where the event listener is invoked.</dd>
            <dt>Output</dt>
            <dd><var>RELATIVE-TARGET</var>, adjusted target</dd>
          </dl>
          <ol>
            <li>Let <var>CURRENT-TARGET-TREE</var> be the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> which <var>CURRENT-TARGET</var> <a href="http://dom.spec.whatwg.org/#concept-tree-participate" class="externalDFN">participates</a> in</li>
            <li>Let <var>ORIGINAL-TARGET</var> be the first item in <var>EVENT-PATH</var></li>
            <li>Let <var>ORIGINAL-TARGET-TREE</var> be the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> which <var>ORIGINAL-TARGET</var> <a href="http://dom.spec.whatwg.org/#concept-tree-participate" class="externalDFN">participates</a> in</li>
            <li>Let <var>RELATIVE-TARGET-TREE</var> be the lowest common <a href="#dfn-inclusive-ancestor-tree" class="internalDFN">inclusive ancestor tree</a> of <var>CURRENT-TARGET-TREE</var> and <var>ORIGINAL-TARGET-TREE</var></li>
            <li>Let <var>RELATIVE-TARGET</var> be the first <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> in <var>EVENT-PATH</var> which satisfies the following condition:
              <ol>
                <li>The <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> <a href="http://dom.spec.whatwg.org/#concept-tree-participate" class="externalDFN">participates</a> in <var>RELATIVE-TARGET-TREE</var></li>
              </ol>
            </li>
          </ol>
        </div>

        <p>The retargeting process <strong>must</strong> occur prior to dispatch of an event.</p>
      </section>

      <section id="retargeting-relatedtarget">
        <h3 aria-level="2" role="heading" id="h3_retargeting-relatedtarget"><span class="secno">5.5 </span>Retargeting <code>relatedTarget</code></h3>

        <p>Some events have a <a href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget" class="externalDFN"><code>relatedTarget</code></a> [<cite><a class="bibref" href="#bib-DOM-Level-3-Events">DOM-Level-3-Events</a></cite>] property, which holds a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> that's not the event's target, but is related to the event.</p>

        <p>For instance, a <code>mouseover</code> event's <a href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget" class="externalDFN"><code>relatedTarget</code></a> may hold the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> from which the mouse has moved to event's <code>target</code>. In the case where <code>relatedTarget</code> is in a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>, the conforming UAs <strong>must</strong> not leak its actual value outside of this tree. In cases where both <code>relatedTarget</code> and <code>target</code> are part of the same <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>, the conforming UAs <strong>must</strong> <em>stop</em> events at the shadow root to avoid the appearance of spurious <code>mouseover</code> and <code>mouseout</code> events firing from the same node.</p>

        <p>Thus, if an event has a <code>relatedTarget</code>, its value and extent of event dispatch <strong>must</strong> be adjusted. In general:</p>
        <ol>
          <li>For a given node, the <code>relatedTarget</code> <strong>must</strong> be changed to its ancestor (or self) that is in the same <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> as the node</li>
          <li>Event listeners <strong>must not</strong> be invoked on a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> for which the <code>target</code> and <code>relatedTarget</code> are the same.</li>
        </ol>

        <p>The <dfn id="dfn-related-target-resolution-algorithm">related target resolution algorithm</dfn> <strong>must</strong> be used to determine the value of the <a href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget" class="externalDFN"><code>relatedTarget</code></a> property and <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>EVENT</var>, an event</dd>
            <dd><var>CURRENT-TARGET</var>, the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> on which event listeners would be invoked</dd>
            <dd><var>RELATED-TARGET</var>, the related target for the event</dd>
            <dt>Output</dt>
            <dd><var>ADJUSTED-RELATED-TARGET</var>, the <dfn id="dfn-adjusted-related-target">adjusted related target</dfn> for <var>CURRENT-TARGET</var></dd>
          </dl>
          <ol>
            <li>Let <var>CURRENT-TARGET-TREE</var> be the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> which <var>CURRENT-TARGET</var> <a href="http://dom.spec.whatwg.org/#concept-tree-participate" class="externalDFN">participates</a> in</li>
            <li>Let <var>RELATED-TARGET-TREE</var> be the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> which <var>RELATED-TARGET</var> <a href="http://dom.spec.whatwg.org/#concept-tree-participate" class="externalDFN">participates</a> in</li>
            <li>Let <var>RELATED-TARGET-EVENT-PATH</var> be the result of the <a href="#dfn-event-path-calculation-algorithm" class="internalDFN">event path calculation algorithm</a> with <var>RELATED-TARGET</var> and <var>EVENT</var> as input</li>
            <li>If <var>CURRENT-TARGET-TREE</var> and <var>RELATED-TARGET-TREE</var> participate in the same <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a>:
              <ol>
                <li>Let <var>LOWEST-COMMON-ANCESTOR-TREE</var> be the lowest common <a href="#dfn-inclusive-ancestor-tree" class="internalDFN">inclusive ancestor tree</a> of <var>CURRENT-TARGET-TREE</var> and <var>RELATED-TARGET-TREE</var></li>
              </ol>
            </li>
            <li>Otherwise:
              <ol>
                <li>Let <var>LOWEST-COMMON-ANCESTOR-TREE</var> be the <a href="#dfn-root-tree" class="internalDFN">root tree</a> of <var>RELATED-TARGET-TREE</var></li>
              </ol>
            </li>
            <li>For each <a href="#dfn-inclusive-ancestor-tree" class="internalDFN">inclusive ancestor tree</a>, <var>COMMON-ANCESTOR-TREE</var>, of the <var>LOWEST-COMMON-ANCESTOR-TREE</var>, in ascending order:
              <ol>
                <li>Let <var>ADJUSTED-RELATED-TARGET</var> be the first <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> in <var>RELATED-TARGET-EVENT-PATH</var> which satisfies the following condition:
                  <ol>
                    <li>The <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> <a href="http://dom.spec.whatwg.org/#concept-tree-participate" class="externalDFN">participates</a> in <var>COMMON-ANCESTOR-TREE</var></li>
                  </ol>
                </li>
                <li>If such a <var>ADJUSTED-RELATED-TARGET</var> exists:
                  <ol>
                    <li>Stops this algorithm</li>
                  </ol>
                </li>
              </ol>
            </li>
          </ol>
        </div>

        <div class="note"><div class="note-title" aria-level="3" role="heading" id="h_note_5"><span>Note</span></div><p class="">The result of the related target resolution algorithm is not always null. Unless that, you should file a bug for this specification.</p></div>

        <p>The relatedTarget retargeting process <strong>must</strong> occur prior to dispatch of an event.</p>
      </section>

      <section id="retargeting-touch-events">
        <h3 aria-level="2" role="heading" id="h3_retargeting-touch-events"><span class="secno">5.6 </span>Retargeting Touch Events</h3>

        <p>The <a href="http://www.w3.org/TR/touch-events/#touch-interface" class="externalDFN"><code>Touch</code></a> <a title="Touch target" href="http://www.w3.org/TR/touch-events/#widl-Touch-target" class="externalDFN"><code>target</code></a> [<cite><a class="bibref" href="#bib-TOUCH-EVENTS">TOUCH-EVENTS</a></cite>] attribute must be adjusted in the same way as an event with a <a href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget" class="externalDFN"><code>relatedTarget</code></a>. Each <a href="http://www.w3.org/TR/touch-events/#touch-interface" class="externalDFN"><code>Touch</code></a> <a title="Touch target" href="http://www.w3.org/TR/touch-events/#widl-Touch-target" class="externalDFN"><code>target</code></a> in the <a href="http://www.w3.org/TR/touch-events/#touchlist-interface" class="externalDFN"><code>TouchList</code></a> returned from <a href="http://www.w3.org/TR/touch-events/#touchevent-interface" class="externalDFN"><code>TouchEvent</code></a> <a title="touches" href="http://www.w3.org/TR/touch-events/#widl-TouchEvent-touches" class="externalDFN"><code>touches()</code></a>, <a title="changedTouches" href="http://www.w3.org/TR/touch-events/#widl-TouchEvent-changedTouches" class="externalDFN"><code>changedTouches()</code></a> and <a title="targetTouches" href="http://www.w3.org/TR/touch-events/#widl-TouchEvent-targetTouches" class="externalDFN"><code>targetTouches()</code></a> must be the result of <a href="#dfn-related-target-resolution-algorithm" class="internalDFN">related target resolution algorithm</a>, given <var>NODE</var> and <a href="http://www.w3.org/TR/touch-events/#touch-interface" class="externalDFN"><code>Touch</code></a> <a title="Touch target" href="http://www.w3.org/TR/touch-events/#widl-Touch-target" class="externalDFN"><code>target</code></a> as arguments.</p>
      </section>

      <section id="retargeting-focus-events">
        <h3 aria-level="2" role="heading" id="h3_retargeting-focus-events"><span class="secno">5.7 </span>Retargeting Focus Events</h3>

        <p>The <code>focus</code>, <code>DOMFocusIn</code>, <code>blur</code>, and <code>DOMFocusOut</code> events <strong>must</strong> be treated in the same way as events with a <code>relatedTarget</code>, where the corresponding <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> that is losing focus as a result of <code>target</code> gaining focus or the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> that is gaining focus, and thus causing the blurring of <code>target</code> acts as the related target.</p>
      </section>

      <section id="event-dispatch">
        <h3 aria-level="2" role="heading" id="h3_event-dispatch"><span class="secno">5.8 </span>Event Dispatch</h3>

        <p>At the time of event dispatch:</p>
        <ul>
          <li>The <a href="http://dom.spec.whatwg.org/#events" class="externalDFN"><code>Event</code></a> <a href="http://dom.spec.whatwg.org/#dom-event-target" class="externalDFN"><code>target</code></a> and <a href="http://dom.spec.whatwg.org/#dom-event-currenttarget" class="externalDFN"><code>currentTarget</code></a> attributes <strong>must</strong> return the <a href="#dfn-relative-target" class="internalDFN">relative target</a> for the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> on which event listeners are <a title="event listener invoke" href="http://dom.spec.whatwg.org/#concept-event-listener-invoke" class="externalDFN">invoked</a></li>
          <li>The <a href="http://www.w3.org/TR/DOM-Level-3-Events/#interface-MouseEvent" class="externalDFN"><code>MouseEvent</code></a> <a href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget" class="externalDFN"><code>relatedTarget</code></a> attribute <strong>must</strong> return the <a href="#dfn-adjusted-related-target" class="internalDFN">adjusted related target</a></li>
          <li>The <a href="http://www.w3.org/TR/DOM-Level-3-Events/#interface-MouseEvent" class="externalDFN"><code>MouseEvent</code></a> <a href="http://www.w3.org/TR/cssom-view/#dom-mouseevent-offsetx" class="externalDFN"><code>offsetX</code></a> and <a href="http://www.w3.org/TR/cssom-view/#dom-mouseevent-offsety" class="externalDFN"><code>offsetY</code></a> attributes <strong>must</strong> return the coordinates relative to the origin of the <a href="http://www.w3.org/TR/cssom-view/#padding-edge" class="externalDFN">padding edge</a> of the <a href="#dfn-relative-target" class="internalDFN">relative target</a></li>
          <li>The <a href="http://www.w3.org/TR/touch-events/#touch-interface" class="externalDFN"><code>Touch</code></a> <a title="Touch target" href="http://www.w3.org/TR/touch-events/#widl-Touch-target" class="externalDFN"><code>target</code></a> attribute <strong>must</strong> return the <a href="#dfn-adjusted-related-target" class="internalDFN">adjusted related target</a></li>
          <li>If the <a href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget" class="externalDFN"><code>relatedTarget</code></a> and <a href="http://dom.spec.whatwg.org/#dom-event-target" class="externalDFN"><code>target</code></a> are the same for a given node, its the event listeners <strong>must not</strong> be invoked. <a href="http://www.w3.org/TR/touch-events/#touchevent-interface" class="externalDFN"><code>TouchEvent</code></a> is not subject to this rule.</li>
          <li>When <em>capturing</em>, which entails processing step 6 of the <a title="event dispatch" href="http://dom.spec.whatwg.org/#concept-event-dispatch" class="externalDFN">event dispatch algorithm</a>, the event listeners <strong>must not</strong> be <a title="event listener invoke" href="http://dom.spec.whatwg.org/#concept-event-listener-invoke" class="externalDFN">invoked</a> on a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> <strong>if</strong> it is the same as its <a href="#dfn-relative-target" class="internalDFN">relative target</a></li>
          <li>When <em>bubbling</em>, which entails processing step 9 of the <a title="event dispatch" href="http://dom.spec.whatwg.org/#concept-event-dispatch" class="externalDFN">event dispatch algorithm</a>, the <a href="http://dom.spec.whatwg.org/#events" class="externalDFN"><code>Event</code></a> <a href="http://dom.spec.whatwg.org/#dom-event-eventphase" class="externalDFN">eventPhase</a> attribute <strong>must</strong> return <a href="http://dom.spec.whatwg.org/#dom-event-at_target" class="externalDFN">AT_TARGET</a> <strong>if</strong> the <a href="#dfn-relative-target" class="internalDFN">relative target</a> is same as the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> on which event listeners are <a title="event listener invoke" href="http://dom.spec.whatwg.org/#concept-event-listener-invoke" class="externalDFN">invoked</a></li>
          <li>If the event's <a href="http://dom.spec.whatwg.org/#dom-event-bubbles" class="externalDFN"><code>bubbles</code></a> attribute value is <strong>false</strong>, run these substeps:
            <ol>
              <li>Reverse the order of <em>event path</em></li>
              <li>Initialize event's <a href="http://dom.spec.whatwg.org/#dom-event-eventphase" class="externalDFN"><code>eventPhase</code></a> attribute to <a href="http://dom.spec.whatwg.org/#dom-event-at_target" class="externalDFN"><code>AT_TARGET</code></a></li>
              <li>For each object in <em>event path</em> where the <a href="#dfn-relative-target" class="internalDFN">relative target</a> is same as the object, <a title="event listener invoke" href="http://dom.spec.whatwg.org/#concept-event-listener-invoke" class="externalDFN">invoke</a> its <a title="event listener" href="http://dom.spec.whatwg.org/#concept-event-listener" class="externalDFN">event listeners</a>, with event <em>event</em>, as long as <em>event</em>'s <a href="http://dom.spec.whatwg.org/#stop-propagation-flag" class="externalDFN">stop propagation flag</a> is unset</li>
            </ol></li>
        </ul>

        <p>Upon completion of the event dispatch, the <a href="http://dom.spec.whatwg.org/#events" class="externalDFN"><code>Event</code></a> object's <a href="http://dom.spec.whatwg.org/#dom-event-target" class="externalDFN"><code>target</code></a> and <a href="http://dom.spec.whatwg.org/#dom-event-currenttarget" class="externalDFN"><code>currentTarget</code></a> <strong>must</strong> be to the highest ancestor's <a href="#dfn-relative-target" class="internalDFN">relative target</a>. Since it is possible for a script to hold on to the <code>Event</code> object past the scope of event dispatch, this step is necessary to avoid revealing the <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> in <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a>.</p>
      </section>

      <section class="informative" id="event-retargeting-example">
        <h3 aria-level="2" role="heading" id="h3_event-retargeting-example"><span class="secno">5.9 </span>Event Retargeting Example</h3><p><em>This section is non-normative.</em></p>

        <p>Suppose we have a user interface for a media controller, represented by this tree, composed of both <a href="#dfn-document-tree" class="internalDFN">document tree</a> and the <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a>. In this example, we will assume that selectors are allowed to cross the shadow boundaries and we will use these selectors to identify the <a title="element" href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">elements</a>. Also, we will invent a fictional <code>shadow-root</code> <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> to demarcate the shadow boundaries and represent <a title="shadow root" href="#dfn-shadow-root" class="internalDFN">shadow roots</a>:</p>
        <div class="example"><div class="example-title"><span>Example 1</span></div><pre class="example">&lt;div id="player"&gt;
    <span class="shadow-boundary">&lt;shadow-root id="player-shadow-root"&gt;</span>
        &lt;div id="controls"&gt;
            &lt;button id="play-button"&gt;PLAY&lt;/button&gt;
            &lt;input type="range" id="timeline"&gt;
                <span class="shadow-boundary">&lt;shadow-root id="timeline-shadow-root"&gt;</span>
                    &lt;div id="slider-thumb" id="timeline-slider-thumb"&gt;&lt;/div&gt;
                <span class="shadow-boundary">&lt;/shadow-root&gt;</span>
            &lt;/input&gt;
            &lt;div id="volume-slider-container"&gt;
                &lt;input type="range" id="volume-slider"&gt;
                    <span class="shadow-boundary">&lt;shadow-root id="volume-shadow-root"&gt;</span>
                        &lt;div id="slider-thumb" id="volume-slider-thumb"&gt;&lt;/div&gt;
                    <span class="shadow-boundary">&lt;/shadow-root&gt;</span>
                &lt;/input&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    <span class="shadow-boundary">&lt;/shadow-root&gt;</span>
&lt;/div&gt;</pre></div>

        <p>Let's have a user position their pointing device over the volume slider's thumb (<code>#volume-slider-thumb</code>), thus triggering a <code>mouseover</code> event on that node. For this event, let's pretend it has no associated <code>relatedTarget</code>.</p>

        <p>Per the <a href="#dfn-retargeting-algorithm" class="internalDFN">retargeting algorithm</a>, we should have the following set of ancestors and relative targets:</p>
        <table>
          <thead>
            <tr>
              <th>Ancestor</th>
              <th>Relative Target</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>#player</code></td>
              <td><code><strong>#player</strong></code></td>
            </tr>
            <tr>
              <td><code>#player-shadow-root</code></td>
              <td><code>#volume-slider</code></td>
            </tr>
            <tr>
              <td><code>#controls</code></td>
              <td><code>#volume-slider</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider-container</code></td>
              <td><code>#volume-slider</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider</code></td>
              <td><code><strong>#volume-slider</strong></code></td>
            </tr>
            <tr>
              <td><code>#volume-shadow-root</code></td>
              <td><code>#volume-slider-thumb</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider-thumb</code></td>
              <td><code><strong>#volume-slider-thumb</strong></code></td>
            </tr>
          </tbody>
        </table>

        <p>After we dispatch the <code>mouseover</code> event using these newly computed relative targets, the user decides to move their pointing device over the thumb of the timeline
          (<code>#timeline-slider-thumb</code>). This triggers both a <code>mouseout</code> event for the volume slider thumb and the <code>mouseover</code> event for the timeline thumb.</p>

        <p>Let's see how the <code>relatedTarget</code> value of the volume thumb's <code>mouseout</code> event is affected. For this event, the <code>relatedTarget</code> is the timeline thumb (<code>#timeline-slider-thumb</code>). Per the <a href="#dfn-related-target-resolution-algorithm" class="internalDFN">related target resolution algorithm</a>, we should have the following set of ancestors and adjusted related targets:</p>

        <table>
          <thead>
            <tr>
              <th>Ancestor</th>
              <th>Relative Target</th>
              <th>Adjusted related Target</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>#player</code></td>
              <td><code><strong>#player</strong></code></td>
              <td><code><strong>#player</strong></code></td>
            </tr>
            <tr>
              <td><code>#player-shadow-root</code></td>
              <td><code>#volume-slider</code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#controls</code></td>
              <td><code>#volume-slider</code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider-container</code></td>
              <td><code>#volume-slider</code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider</code></td>
              <td><code><strong>#volume-slider</strong></code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#volume-shadow-root</code></td>
              <td><code>#volume-slider-thumb</code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider-thumb</code></td>
              <td><code><strong>#volume-slider-thumb</strong></code></td>
              <td><code><strong>#timeline</strong></code></td>
            </tr>
          </tbody>
        </table>

        <p>The node, <code>#player</code>, has both <code>target</code> and <code>relatedTarget</code> being the same value (<code>#player</code>), which means that we do not dispatch the event on this <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> and its ancestors.</p>
      </section>

    </section>

    <section id="user-interaction">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_user-interaction"><span class="secno">6. </span>User Interaction</h2>

      <section class="informative" id="ranges-and-selections">
        <h3 aria-level="2" role="heading" id="h3_ranges-and-selections"><span class="secno">6.1 </span>Ranges and Selections</h3><p><em>This section is non-normative.</em></p>

        <p>
          <a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection" class="externalDFN">Selection</a> [<cite><a class="bibref" href="#bib-EDITING">EDITING</a></cite>] is not defined. Implementation should do their best to do what's best for them. Here's one possible, admittedly naive way:
        </p>

        <p>Since <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> which are in the different <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a> never have the same <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a>, there may never exist a valid <a title="range" href="http://dom.spec.whatwg.org/#range" class="externalDFN">DOM range</a> that spans multiple <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a>.</p>

        <p>Accordingly, <a title="selection" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection" class="externalDFN">selections</a> may only exist within one <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a>, because they are defined by a single <a href="http://dom.spec.whatwg.org/#range" class="externalDFN">range</a>. The <a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection" class="externalDFN">selection</a>, returned by the <a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#dom-window-getselection" class="externalDFN"><code>window.getSelection()</code></a> method never returns a <a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection" class="externalDFN">selection</a> within a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>

        <p>The <code>getSelection()</code> method of the <a href="#dfn-shadow-root" class="internalDFN">shadow root</a> object returns the current <a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection" class="externalDFN">selection</a> in this <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>
      </section>

      <section id="focus-navigation">
        <h3 aria-level="2" role="heading" id="h3_focus-navigation"><span class="secno">6.2 </span>Focus Navigation</h3>

        <p>If a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> doesn’t <a title="participates" href="http://dom.spec.whatwg.org/#concept-tree-participate" class="externalDFN">participate</a> in the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a>, the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> <strong>must</strong> be skipped from the <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation order</a> [<cite><a class="bibref" href="#bib-CSS3UI">CSS3UI</a></cite>] sequence.</p>

        <p>For <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">sequential focus navigation</a>, the <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation order</a> sequence for a given <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> <var>A</var> <strong>must</strong> be inserted into the <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation order</a> for other <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> as follow:</p>
        <ol>
          <li>If <var>A</var> is the <a href="#dfn-youngest-shadow-tree" class="internalDFN">youngest shadow tree</a>:
            <ol>
              <li>Let <var>HOST</var> be the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> which <a href="#dfn-hosts" class="internalDFN">hosts</a> A</li>
              <li>Let <var>B</var> be the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> which <var>HOST</var> participates in</li>
              <li>The <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation order</a> for A <strong>must</strong> be inserted into the <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation order</a> for <var>B</var>:
                <ol>
                  <li>immediately after <var>HOST</var>, if <var>HOST</var> is <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#focusable-area" class="externalDFN">focusable</a>; or</li>
                  <li>in place of the <var>HOST</var> as if <var>HOST</var> were assigned the value of <a title="nav-index auto" href="http://www.w3.org/TR/css3-ui/#nav-index" class="externalDFN"><code>auto</code></a> for determining its position.</li>
                </ol></li>
            </ol></li>
          <li>Otherwise:
            <ol>
              <li>Let <var>B</var> be the <a href="#dfn-younger-shadow-tree" class="internalDFN">younger shadow tree</a> relative to <var>A</var></li>
              <li>Let <var>SHADOW</var> be the <a href="#dfn-shadow-insertion-point" class="internalDFN">shadow insertion point</a> in <var>B</var></li>
              <li>If <var>SHADOW</var> exists, the <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation order</a> for <var>A</var> <strong>must</strong> be inserted into the <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation order</a> for <var>B</var> immediately after <var>SHADOW</var> as if <var>SHADOW</var> were assigned the value of <a title="nav-index auto" href="http://www.w3.org/TR/css3-ui/#nav-index" class="externalDFN"><code>auto</code></a> for determining its position.</li>
            </ol></li>
        </ol>

        <p>For <a href="http://www.w3.org/TR/css3-ui/#nav-dir" class="externalDFN">directional focus navigation</a>, it is up to the user agent to integrate the <a title="navigation order" href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation orders</a> for <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a> into the <a href="http://dom.spec.whatwg.org/#concept-document" class="externalDFN">document</a> <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation order</a>.</p>
      </section>

      <section id="active-element">
        <h3 aria-level="2" role="heading" id="h3_active-element"><span class="secno">6.3 </span>Active Element</h3>

        <p>To maintain encapsulation, the value of the <a title="Document object" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document" class="externalDFN">Document</a> object's focus API property <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement" class="externalDFN">activeElement</a> <strong>must</strong> be adjusted. To prevent loss of information when adjusting this value, each <a href="#dfn-shadow-root" class="internalDFN">shadow root</a> <strong>must</strong> also have an <code>activeElement</code> property to store the value of the focused <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> in the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>

        <p>The <dfn id="dfn-active-element-adjustment-algorithm">active <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> adjustment algorithm</dfn> is used to determine the value of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement" class="externalDFN">activeElement</a> property, and it <strong>must</strong> be equivalent to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>ELEMENT</var>, the focused <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a></dd>
            <dd><var>ROOT</var>, either a <a href="http://dom.spec.whatwg.org/#concept-document" class="externalDFN">document</a> or a <a href="#dfn-shadow-root" class="internalDFN">shadow root</a></dd>
            <dt>Output</dt>
            <dd><var>ADJUSTED</var>, an adjusted <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement" class="externalDFN">activeElement</a> property of <var>ROOT</var>.</dd>
          </dl>
          <ol>
            <li>Let <var>PATH</var> be the result of the <a href="#dfn-event-path-calculation-algorithm" class="internalDFN">event path calculation algorithm</a> with <var>ELEMENT</var> and null as input</li>
            <li>Let <var>ADJUSTED</var> be the result of the <a href="#dfn-retargeting-algorithm" class="internalDFN">retargeting algorithm</a> with <var>PATH</var> and <var>ROOT</var> as input</li>
          </ol>
        </div>
      </section>

      <section id="editing">
        <h3 aria-level="2" role="heading" id="h3_editing"><span class="secno">6.4 </span>Editing</h3>

        <p>The value of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#attr-contenteditable" class="externalDFN"><code>contenteditable</code></a> attribute <strong>must not</strong> propagate from <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> to its <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a>.</p>
      </section>

      <section id="assistive-technology">
        <h3 aria-level="2" role="heading" id="h3_assistive-technology"><span class="secno">6.5 </span>Assistive Technology</h3>

        <p>User agents with assistive technology traverse the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a>, and thus enable full use of WAI-ARIA [<cite><a class="bibref" href="#bib-WAI-ARIA">WAI-ARIA</a></cite>] semantics in the <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a>.</p>

      </section>

    </section>

    <section id="html-elements-in-shadow-trees">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_html-elements-in-shadow-trees"><span class="secno">7. </span>HTML Elements in Shadow Trees</h2>

      <p>Comparatively, a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> can be seen as somewhere between <em>just part of a <a href="http://dom.spec.whatwg.org/#concept-document" class="externalDFN">document</a></em> and itself being a <a title="interface DocumentFragment" href="http://dom.spec.whatwg.org/#interface-documentfragment" class="externalDFN">document fragment</a>. Since it is rendered, a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> aims to retain the traits of a typical <a href="http://dom.spec.whatwg.org/#trees" class="externalDFN">tree</a> in a <a href="http://dom.spec.whatwg.org/#concept-document" class="externalDFN">document</a>. At the same time, it is an encapsulation abstraction, so it has to avoid affecting the <a href="#dfn-document-tree" class="internalDFN">document tree</a>. Thus, the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics" class="externalDFN">HTML elements</a> <strong>must</strong> behave as specified [<cite><a class="bibref" href="#bib-HTML">HTML</a></cite>] in the <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a>, with a few exceptions.</p>

      <section id="inert-html-elements">
        <h3 aria-level="2" role="heading" id="h3_inert-html-elements"><span class="secno">7.1 </span>Inert HTML Elements</h3>

        <p>A subset of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics" class="externalDFN">HTML elements</a> <strong>must</strong> behave as <dfn id="dfn-inert">inert</dfn>, or not part of the <a href="#dfn-document-tree" class="internalDFN">document tree</a>. This is consistent how the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics" class="externalDFN">HTML elements</a> would behave in a <a title="interface DocumentFragment" href="http://dom.spec.whatwg.org/#interface-documentfragment" class="externalDFN">document fragment</a>. These <a title="element" href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">elements</a> are:</p>
        <ul>
          <li><a title="base element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-base-element" class="externalDFN"><code>base</code></a></li>
          <li><a title="link element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-link-element" class="externalDFN"><code>link</code></a></li>
        </ul>

        <p>All other <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics" class="externalDFN">HTML elements</a> in the <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a> <strong>must</strong> behave as if they were part of the <a href="#dfn-document-tree" class="internalDFN">document tree</a>.</p>
      </section>

    </section>

    <section id="html-elements-and-their-shadow-trees">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_html-elements-and-their-shadow-trees"><span class="secno">8. </span>HTML Elements and Their Shadow Trees</h2>

      <p>Per <a title="HTML" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/" class="externalDFN">specification</a>, some <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics" class="externalDFN">HTML elements</a> are designed to either not render their contents or have special requirements in regard to contents rendering. In order to reconcile these differences in rendering behavior with the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a>, all <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics" class="externalDFN">HTML elements</a> <strong>must</strong> have an <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> of a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> that is created and populated at the time of <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> instantiation. It is up to a user agent to define the content of these trees. However, all conforming user agents <strong>must</strong> satisfy the following requirements:</p>

      <table>
        <thead>
          <tr>
            <th style="width: 30%">HTML Element</th>
            <th>Shadow Tree Requirements</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><a title="img element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/edits.html#the-img-element" class="externalDFN"><code>img</code></a>, <a title="iframe element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-iframe-element" class="externalDFN"><code>iframe</code></a>, <a title="embed element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-embed-element" class="externalDFN"><code>embed</code></a>, <a title="object element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-object-element" class="externalDFN"><code>object</code></a>, <a title="video element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-video-element.html#the-video-element" class="externalDFN"><code>video</code></a>, <a title="audio element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-video-element.html#the-audio-element" class="externalDFN"><code>audio</code></a>, <a title="canvas element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-canvas-element.html#the-canvas-element" class="externalDFN"><code>canvas</code></a>, <a title="map element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-map-element.html#the-map-element" class="externalDFN"><code>map</code></a>, <a title="input element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-input-element.html#the-input-element" class="externalDFN"><code>input</code></a>, <a title="textarea element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-textarea-element" class="externalDFN"><code>textarea</code></a>, <a title="progress element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-progress-element" class="externalDFN"><code>progress</code></a>, <a title="meter element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-meter-element" class="externalDFN"><code>meter</code></a></td>
            <td>If the <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> can have <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#fallback-content" class="externalDFN">fallback content</a>, contains one <a href="#dfn-content-insertion-point" class="internalDFN">content insertion point</a>. The <a href="#dfn-matching-criteria" class="internalDFN">matching criteria</a> value is the <a href="http://dev.w3.org/csswg/selectors4/#universal-selector" class="externalDFN">universal selector</a> only when the <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> needs to show <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#fallback-content" class="externalDFN">fallback content</a>. Otherwise, contains no <a title="content insertion point" href="#dfn-content-insertion-point" class="internalDFN">content insertion points</a> or an <a href="#dfn-content-insertion-point" class="internalDFN">content insertion point</a> that matches nothing.</td>
          </tr>
          <tr>
            <td><a title="fieldset element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-fieldset-element" class="externalDFN"><code>fieldset</code></a></td>
            <td>Contains two <a title="content insertion point" href="#dfn-content-insertion-point" class="internalDFN">content insertion points</a> with the following <a href="#dfn-matching-criteria" class="internalDFN">matching criteria</a>:
              <ol>
                <li><code>legend:first-of-type</code></li>
                <li><a href="http://dev.w3.org/csswg/selectors4/#universal-selector" class="externalDFN">universal selector</a></li>
              </ol>
            </td>
          </tr>
          <tr>
            <td><a title="details element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/interactive-elements.html#the-details-element" class="externalDFN"><code>details</code></a></td>
            <td>Contains two <a title="content insertion point" href="#dfn-content-insertion-point" class="internalDFN">content insertion points</a> with the following <a href="#dfn-matching-criteria" class="internalDFN">matching criteria</a>:
              <ol>
                <li><code>summary:first-of-type</code></li>
                <li><a href="http://dev.w3.org/csswg/selectors4/#universal-selector" class="externalDFN">universal selector</a></li>
              </ol>
            </td>
          </tr>
          <tr>
            <td>All other <a title="element" href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">elements</a></td>
            <td>Contains one <a href="#dfn-content-insertion-point" class="internalDFN">content insertion point</a> with the <a href="http://dev.w3.org/csswg/selectors4/#universal-selector" class="externalDFN">universal selector</a> as the <a href="#dfn-matching-criteria" class="internalDFN">matching criteria</a></td>
          </tr>
        </tbody>
      </table>
    </section>

    <section id="elements-and-dom-objects">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_elements-and-dom-objects"><span class="secno">9. </span>Elements and DOM Objects</h2>

      <section id="shadowroot-object">
        <h3 aria-level="2" role="heading" id="h3_shadowroot-object"><span class="secno">9.1 </span><code>ShadowRoot</code> Object</h3>

        <p>The <code>ShadowRoot</code> object represents the <a href="#dfn-shadow-root" class="internalDFN">shadow root</a>.</p>

        <pre class="idl"><span class="idlInterface" id="idl-def-ShadowRoot">interface <span class="idlInterfaceID">ShadowRoot</span> : <span class="idlSuperclass">DocumentFragment</span> {
<span class="idlMethod">    <span class="idlMethType">HTMLElement</span> <span class="idlMethName"><a href="#widl-ShadowRoot-getElementById-HTMLElement-DOMString-elementId">getElementById</a></span> (<span class="idlParam"><span class="idlParamType">DOMString</span> <span class="idlParamName">elementId</span></span>);</span>
<span class="idlMethod">    <span class="idlMethType">NodeList</span>    <span class="idlMethName"><a href="#widl-ShadowRoot-getElementsByClassName-NodeList-DOMString-className">getElementsByClassName</a></span> (<span class="idlParam"><span class="idlParamType">DOMString</span> <span class="idlParamName">className</span></span>);</span>
<span class="idlMethod">    <span class="idlMethType">NodeList</span>    <span class="idlMethName"><a href="#widl-ShadowRoot-getElementsByTagName-NodeList-DOMString-tagName">getElementsByTagName</a></span> (<span class="idlParam"><span class="idlParamType">DOMString</span> <span class="idlParamName">tagName</span></span>);</span>
<span class="idlMethod">    <span class="idlMethType">NodeList</span>    <span class="idlMethName"><a href="#widl-ShadowRoot-getElementsByTagNameNS-NodeList-DOMString-namespace-DOMString-localName">getElementsByTagNameNS</a></span> (<span class="idlParam"><span class="idlParamType">DOMString?</span> <span class="idlParamName">namespace</span></span>, <span class="idlParam"><span class="idlParamType">DOMString</span> <span class="idlParamName">localName</span></span>);</span>
<span class="idlMethod">    <span class="idlMethType">Selection?</span>  <span class="idlMethName"><a href="#widl-ShadowRoot-getSelection-Selection">getSelection</a></span> ();</span>
<span class="idlMethod">    <span class="idlMethType"><a href="#idl-def-Element" class="idlType"><code>Element</code></a>?</span>    <span class="idlMethName"><a href="#widl-ShadowRoot-elementFromPoint-Element-double-x-double-y">elementFromPoint</a></span> (<span class="idlParam"><span class="idlParamType">double</span> <span class="idlParamName">x</span></span>, <span class="idlParam"><span class="idlParamType">double</span> <span class="idlParamName">y</span></span>);</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType"><a href="#idl-def-Element" class="idlType"><code>Element</code></a>?</span>       <span class="idlAttrName"><a href="#widl-ShadowRoot-activeElement">activeElement</a></span>;</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType"><a href="#idl-def-Element" class="idlType"><code>Element</code></a></span>        <span class="idlAttrName"><a href="#widl-ShadowRoot-host">host</a></span>;</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType"><a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a>?</span>    <span class="idlAttrName"><a href="#widl-ShadowRoot-olderShadowRoot">olderShadowRoot</a></span>;</span>
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span>      <span class="idlAttrName"><a href="#widl-ShadowRoot-innerHTML">innerHTML</a></span>;</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType">StyleSheetList</span> <span class="idlAttrName"><a href="#widl-ShadowRoot-styleSheets">styleSheets</a></span>;</span>
};</span></pre><section id="attributes"><h4 aria-level="3" role="heading" id="h4_attributes"><span class="secno">9.1.1 </span>Attributes</h4><dl class="attributes"><dt id="widl-ShadowRoot-activeElement"><code>activeElement</code> of type <span class="idlAttrType"><a href="#idl-def-Element" class="idlType"><code>Element</code></a></span>, readonly   , nullable</dt><dd>
            <p>Represents the currently focused <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> in the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>
            <p>On getting, the attribute <strong>must</strong> return the currently focused <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> in the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> or <code>null</code>, if there is none.</p>
          </dd><dt id="widl-ShadowRoot-host"><code>host</code> of type <span class="idlAttrType"><a href="#idl-def-Element" class="idlType"><code>Element</code></a></span>, readonly   </dt><dd>
            <p>Represents the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> which <a href="#dfn-hosts" class="internalDFN">hosts</a> the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a>.</p>
            <p>On getting, the attribute <strong>must</strong> return the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> which <a href="#dfn-hosts" class="internalDFN">hosts</a> the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a>.</p>
          </dd><dt id="widl-ShadowRoot-innerHTML"><code>innerHTML</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd>
            <p>Represents the markup of <a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a>'s contents.</p>
            <p>On getting, the attribute <strong>must</strong> return the result of running the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-end.html#html-fragment-serialization-algorithm" class="externalDFN">HTML fragment serialization algorithm</a> with the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> as <a title="shadow host" href="#dfn-shadow-host" class="internalDFN"><code>shadow host</code></a>.</p>
            <p>
              On setting, these steps <strong>must</strong> be run:
            </p>
            <ol>
              <li>Let <var>FRAGMENT</var> be the result of invoking the <a title="parse fragment" href="http://domparsing.spec.whatwg.org/#concept-parse-fragment" class="externalDFN">fragment parsing algorithm</a> [<cite><a class="bibref" href="#bib-DOMPARSING">DOMPARSING</a></cite>] with the new value as <var>MARKUP</var>, and the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> as <a title="shadow host" href="#dfn-shadow-host" class="internalDFN"><code>shadow host</code></a></li>
              <li><a href="http://dom.spec.whatwg.org/#concept-node-replace-all" class="externalDFN">Replace all</a> with <var>FRAGMENT</var> within the <a href="#dfn-shadow-root" class="internalDFN">shadow root</a>.</li>
            </ol>
          </dd><dt id="widl-ShadowRoot-olderShadowRoot"><code>olderShadowRoot</code> of type <span class="idlAttrType"><a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a></span>, readonly   , nullable</dt><dd>
            <p>Represents the <a href="#dfn-older-shadow-root" class="internalDFN">older shadow root</a> relative to the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a></p>
            <p>
              On getting, the attribute <strong>must</strong> return a result that is <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to running the following steps:
            </p>
            <ol>
              <li>If the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> is the <a href="#dfn-oldest-shadow-root" class="internalDFN">oldest shadow root</a>, return <strong>null</strong>.</li>
              <li>Return the <a href="#dfn-older-shadow-root" class="internalDFN">older shadow root</a> relative to the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a>.</li>
            </ol>
            <p>For <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics" class="externalDFN">HTML elements</a>, the <a href="#html-elements-and-their-shadow-trees">UA-provided</a> <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a> <strong>must not</strong> be accessible.</p>
          </dd><dt id="widl-ShadowRoot-styleSheets"><code>styleSheets</code> of type <span class="idlAttrType">StyleSheetList</span>, readonly   </dt><dd>
            <p>Represents the shadow root style sheets.</p>
            <p>On getting, the attribute <strong>must</strong> return a <a href="http://www.w3.org/TR/cssom/#the-stylesheetlist-interface" class="externalDFN"><code>StyleSheetList</code></a> sequence containing the shadow root style sheets.
            </p>
          </dd></dl></section><section id="methods"><h4 aria-level="3" role="heading" id="h4_methods"><span class="secno">9.1.2 </span>Methods</h4><dl class="methods"><dt id="widl-ShadowRoot-elementFromPoint-Element-double-x-double-y"><code>elementFromPoint</code></dt><dd>
            <p>Returns an <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> at specified coordinates.</p>
            <div class="note"><div class="note-title" aria-level="4" role="heading" id="h_note_6"><span>Note</span></div><p class="">Eventually, this needs to be part of CSSOM View Module specification [<cite><a class="bibref" href="#bib-CSSOM-VIEW">CSSOM-VIEW</a></cite>]</p></div>
            <p>
              When invoked, it <strong>must</strong> return result of running the following steps:
            </p>
            <ol>
              <li>If <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> is not a <a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a> instance, throw an <a href="http://dom.spec.whatwg.org/#invalidnodetypeerror" class="externalDFN"><code>InvalidNodeTypeError</code></a>.</li>
              <li>If either argument is negative, <code>x</code> is greater than the <a href="http://www.w3.org/TR/cssom-view/#viewport" class="externalDFN">viewport</a> width excluding the size of a rendered scroll bar (if any), or if <code>y</code> is greater than the <a href="http://www.w3.org/TR/cssom-view/#viewport" class="externalDFN">viewport</a> height excluding the size of a rendered scroll bar (if any), return <strong>null</strong>.</li>
              <li>Let <var>HIT</var> be the <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> at coordinates <code>x</code> and <code>y</code> in the <a href="http://www.w3.org/TR/cssom-view/#viewport" class="externalDFN">viewport</a>, determined through hit testing</li>
              <li>Let <var>PATH</var> be the result of running the <a href="#dfn-event-path-calculation-algorithm" class="internalDFN">event path calculation algorithm</a> with <var>HIT</var> and null as input</li>
              <li>Return the result of running the <a href="#dfn-retargeting-algorithm" class="internalDFN">retargeting algorithm</a> with <var>PATH</var> and <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> as input</li>
            </ol>
          <table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">x</td><td class="prmType"><code>double</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr><tr><td class="prmName">y</td><td class="prmType"><code>double</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code><a href="#idl-def-Element" class="idlType"><code>Element</code></a></code>, nullable</div></dd><dt id="widl-ShadowRoot-getElementById-HTMLElement-DOMString-elementId"><code>getElementById</code></dt><dd>
            <strong>Must</strong> behave exactly like <a href="http://dom.spec.whatwg.org/#dom-nonelementparentnode-getelementbyid" class="externalDFN">document.getElementById</a>, except scoped to the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.
          <table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">elementId</td><td class="prmType"><code>DOMString</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code>HTMLElement</code></div></dd><dt id="widl-ShadowRoot-getElementsByClassName-NodeList-DOMString-className"><code>getElementsByClassName</code></dt><dd>
            <strong>Must</strong> behave exactly like document.getElementsByClassName, except scoped to the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.
          <table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">className</td><td class="prmType"><code>DOMString</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code>NodeList</code></div></dd><dt id="widl-ShadowRoot-getElementsByTagName-NodeList-DOMString-tagName"><code>getElementsByTagName</code></dt><dd>
            <strong>Must</strong> behave exactly like <a href="http://dom.spec.whatwg.org/#dom-document-getelementsbytagname" class="externalDFN">document.getElementsByTagName</a>, except scoped to the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.
          <table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">tagName</td><td class="prmType"><code>DOMString</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code>NodeList</code></div></dd><dt id="widl-ShadowRoot-getElementsByTagNameNS-NodeList-DOMString-namespace-DOMString-localName"><code>getElementsByTagNameNS</code></dt><dd>
            <strong>Must</strong> behave exactly like <a href="http://dom.spec.whatwg.org/#dom-document-getelementsbytagnamens" class="externalDFN">document.getElementsByTagNameNS</a>, except scoped to the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.
          <table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">namespace</td><td class="prmType"><code>DOMString</code></td><td class="prmNullTrue"><span role="img" aria-label="True">✔</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr><tr><td class="prmName">localName</td><td class="prmType"><code>DOMString</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code>NodeList</code></div></dd><dt id="widl-ShadowRoot-getSelection-Selection"><code>getSelection</code></dt><dd>
            <p>Returns the current selection in the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>
            <p>When invoked, it <strong>must</strong> return the <a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection" class="externalDFN">selection</a> in the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>
          <div><em>No parameters.</em></div><div><em>Return type: </em><code>Selection</code>, nullable</div></dd></dl></section>

        <p>The <a href="http://dom.spec.whatwg.org/#dom-node-nodetype" class="externalDFN"><code>nodeType</code></a> attribute of a <a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a> instance <strong>must</strong> return <a href="http://dom.spec.whatwg.org/#dom-node-document_fragment_node" class="externalDFN"><code>DOCUMENT_FRAGMENT_NODE</code></a>. Accordingly, the <a href="http://dom.spec.whatwg.org/#dom-node-nodename" class="externalDFN"><code>nodeName</code></a> attribute of a <a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a> instance <strong>must</strong> return <code>"#document-fragment"</code>.</p>

        <p>Invoking the <a href="http://dom.spec.whatwg.org/#dom-node-clonenode" class="externalDFN"><code>cloneNode()</code></a> method on a <a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a> instance <strong>must</strong> always throw a <a href="http://dom.spec.whatwg.org/#dom-domexception-data_clone_err" class="externalDFN"><code>DATA_CLONE_ERR</code></a> exception.</p>

      </section>

      <section id="extensions-to-element-interface">
        <h3 aria-level="2" role="heading" id="h3_extensions-to-element-interface"><span class="secno">9.2 </span>Extensions to <code>Element</code> Interface</h3>

        <pre class="idl"><span class="idlInterface" id="idl-def-Element">partial interface <span class="idlInterfaceID">Element</span> {
<span class="idlMethod">    <span class="idlMethType"><a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a></span> <span class="idlMethName"><a href="#widl-Element-createShadowRoot-ShadowRoot">createShadowRoot</a></span> ();</span>
<span class="idlMethod">    <span class="idlMethType">NodeList</span>   <span class="idlMethName"><a href="#widl-Element-getDestinationInsertionPoints-NodeList">getDestinationInsertionPoints</a></span> ();</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType"><a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a>?</span> <span class="idlAttrName"><a href="#widl-Element-shadowRoot">shadowRoot</a></span>;</span>
};</span></pre><section id="attributes-1"><h4 aria-level="3" role="heading" id="h4_attributes-1"><span class="secno">9.2.1 </span>Attributes</h4><dl class="attributes"><dt id="widl-Element-shadowRoot"><code>shadowRoot</code> of type <span class="idlAttrType"><a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a></span>, readonly   , nullable</dt><dd>
            <p>Represents the <a href="#dfn-youngest-shadow-root" class="internalDFN">youngest shadow root</a> that <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> <a href="#dfn-hosts" class="internalDFN">hosts</a>.</p>
            <p>On getting, the attribute <strong>must</strong> return the <a href="#dfn-youngest-shadow-root" class="internalDFN">youngest shadow root</a> that <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> <a href="#dfn-hosts" class="internalDFN">hosts</a>, or <strong>null</strong> if no such <a href="#dfn-shadow-root" class="internalDFN">shadow root</a> is accessible.</p>
            <p>For <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics" class="externalDFN">HTML elements</a>, the <a href="#html-elements-and-their-shadow-trees">UA-provided</a> <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a> <strong>must not</strong> be accessible.</p>
          </dd></dl></section><section id="methods-1"><h4 aria-level="3" role="heading" id="h4_methods-1"><span class="secno">9.2.2 </span>Methods</h4><dl class="methods"><dt id="widl-Element-createShadowRoot-ShadowRoot"><code>createShadowRoot</code></dt><dd>
            When invoked, these steps <strong>must</strong> be run:
            <ol>
              <li>Create a new instance of the <a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a> object</li>
              <li>Add the <a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a> object to the <a title="shadow roots list" href="#dfn-shadow-roots-list" class="internalDFN">ordered list of shadow roots</a> associated with the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> as the <a href="#dfn-youngest-shadow-root" class="internalDFN">youngest shadow root</a></li>
              <li>Return <a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a> object.</li>
            </ol>
          <div><em>No parameters.</em></div><div><em>Return type: </em><code><a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a></code></div></dd><dt id="widl-Element-getDestinationInsertionPoints-NodeList"><code>getDestinationInsertionPoints</code></dt><dd>When invoked, the method <strong>must</strong> return a <a href="http://dom.spec.whatwg.org/#concept-collection-static" class="externalDFN">static</a> <a href="http://dom.spec.whatwg.org/#nodelist" class="externalDFN"><code>NodeList</code></a> consisting of <a title="insertion point" href="#dfn-insertion-point" class="internalDFN">insertion points</a> in the <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a>.<div><em>No parameters.</em></div><div><em>Return type: </em><code>NodeList</code></div></dd></dl></section>
      </section>

      <section id="the-content-element">
        <h3 aria-level="2" role="heading" id="h3_the-content-element"><span class="secno">9.3 </span>The <code>content</code> element</h3>

        <p>The <code><dfn title="content element" id="dfn-content-element">content</dfn></code> element represents an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> in the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>

        <p>If a <code>content</code> element does not satisfy the condition of an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a>, it <strong>must</strong> have the same rendering behavior as the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#htmlunknownelement" class="externalDFN"><code>HTMLUnknownElement</code></a>.</p>

        <dl>
          <dt>Context</dt>
          <dd>Where <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#flow-content-0" class="externalDFN">flow content</a> is expected.</dd>

          <dt>Content model</dt>
          <dd><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#transparent" class="externalDFN">Transparent</a></dd>

          <dt>Children</dt>
          <dd>Anything as fallback content</dd>

          <dt>Content attributes</dt>
          <dd><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#global-attributes" class="externalDFN">Global attributes</a></dd>
          <dd>
            <dl>
              <dt><code><dfn title="content element select" id="dfn-content-element-select">select</dfn></code>, a <a title="comma separated tokens" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#comma-separated-tokens" class="externalDFN">set of comma-separated tokens</a></dt>
              <dd>Represents the <a href="#dfn-matching-criteria" class="internalDFN">matching criteria</a> for <a title="distribution" href="#dfn-distribution" class="internalDFN">distributing</a> child <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> of the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a>. Each token <strong>must</strong> be a <a href="http://dev.w3.org/csswg/selectors4/#compound" class="externalDFN">compound selector</a>.</dd>
            </dl>
          </dd>

          <dt>DOM Interface</dt>
          <dd>
            <pre class="idl"><span class="idlInterface" id="idl-def-HTMLContentElement">interface <span class="idlInterfaceID">HTMLContentElement</span> : <span class="idlSuperclass">HTMLElement</span> {
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span> <span class="idlAttrName"><a href="#widl-HTMLContentElement-select">select</a></span>;</span>
<span class="idlMethod">    <span class="idlMethType">NodeList</span> <span class="idlMethName"><a href="#widl-HTMLContentElement-getDistributedNodes-NodeList">getDistributedNodes</a></span> ();</span>
};</span></pre><section><h4 id="attributes-3" aria-level="3" role="heading">Attributes</h4><dl class="attributes"><dt id="widl-HTMLContentElement-select"><code>select</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd><strong>Must</strong> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect" class="externalDFN">reflect</a> the <a href="#dfn-content-element-select">select</a> attribute.</dd></dl></section><section><h4 id="methods-2" aria-level="3" role="heading">Methods</h4><dl class="methods"><dt id="widl-HTMLContentElement-getDistributedNodes-NodeList"><code>getDistributedNodes</code></dt><dd>
                When invoked, it <strong>must</strong> return result of running the following steps:
                <ol>
                  <li>
                    If the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> is a <a href="#dfn-content-insertion-point" class="internalDFN">content insertion point</a>:
                    <ol>
                      <li>Return a <a href="http://dom.spec.whatwg.org/#concept-collection-static" class="externalDFN">static</a> <a href="http://dom.spec.whatwg.org/#nodelist" class="externalDFN"><code>NodeList</code></a> consisting of nodes in the <a href="#dfn-distributed-nodes" class="internalDFN">distributed nodes</a> of the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a>.</li>
                    </ol>
                  </li>
                  <li>
                    Otherwise:
                    <ol>
                      <li>Return an empty <a href="http://dom.spec.whatwg.org/#concept-collection-static" class="externalDFN">static</a> <a href="http://dom.spec.whatwg.org/#nodelist" class="externalDFN"><code>NodeList</code></a>.</li>
                    </ol>
                  </li>
                </ol>
              <div><em>No parameters.</em></div><div><em>Return type: </em><code>NodeList</code></div></dd></dl></section>
          </dd>
        </dl>
      </section>

      <section id="the-shadow-element">
        <h3 aria-level="2" role="heading" id="h3_the-shadow-element"><span class="secno">9.4 </span>The <code>shadow</code> element</h3>

        <p>The <code><dfn title="shadow element" id="dfn-shadow-element">shadow</dfn></code> element represents an <a href="#dfn-shadow-insertion-point" class="internalDFN">shadow insertion point</a> in a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>
        <p>If a <code>shadow</code> element does not satisfy the condition of an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a>, it <strong>must</strong> have the same rendering behavior as the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#htmlunknownelement" class="externalDFN"><code>HTMLUnknownElement</code></a>.</p>

        <dl>
          <dt>Context</dt>
          <dd>Where <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#flow-content-0" class="externalDFN">flow content</a> is expected.</dd>

          <dt>Content model</dt>
          <dd><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#transparent" class="externalDFN">Transparent</a></dd>

          <dt>Children</dt>
          <dd>Anything</dd>

          <dt>DOM Interface</dt>
          <dd>
            <pre class="idl"><span class="idlInterface" id="idl-def-HTMLShadowElement">interface <span class="idlInterfaceID">HTMLShadowElement</span> : <span class="idlSuperclass">HTMLElement</span> {
<span class="idlMethod">    <span class="idlMethType">NodeList</span> <span class="idlMethName"><a href="#widl-HTMLShadowElement-getDistributedNodes-NodeList">getDistributedNodes</a></span> ();</span>
};</span></pre><section><h4 id="methods-3" aria-level="3" role="heading">Methods</h4><dl class="methods"><dt id="widl-HTMLShadowElement-getDistributedNodes-NodeList"><code>getDistributedNodes</code></dt><dd>
                When invoked, it <strong>must</strong> return result of running the following steps:
                <ol>
                  <li>
                    If the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> is a <a href="#dfn-shadow-insertion-point" class="internalDFN">shadow insertion point</a>:
                    <ol>
                      <li>Return a <a href="http://dom.spec.whatwg.org/#concept-collection-static" class="externalDFN">static</a> <a href="http://dom.spec.whatwg.org/#nodelist" class="externalDFN"><code>NodeList</code></a> consisting of nodes in the <a href="#dfn-distributed-nodes" class="internalDFN">distributed nodes</a> of the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a>.</li>
                    </ol>
                  </li>
                  <li>
                    Otherwise:
                    <ol>
                      <li>Return an empty <a href="http://dom.spec.whatwg.org/#concept-collection-static" class="externalDFN">static</a> <a href="http://dom.spec.whatwg.org/#nodelist" class="externalDFN"><code>NodeList</code></a>.</li>
                    </ol>
                  </li>
                </ol>
              <div><em>No parameters.</em></div><div><em>Return type: </em><code>NodeList</code></div></dd></dl></section>
          </dd>
        </dl>
      </section>

      <section id="extensions-to-event-interface">
        <h3 aria-level="2" role="heading" id="h3_extensions-to-event-interface"><span class="secno">9.5 </span>Extensions to <code>Event</code> Interface</h3>

        <pre class="idl"><span class="idlInterface" id="idl-def-Event">partial interface <span class="idlInterfaceID">Event</span> {
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType">object</span> <span class="idlAttrName"><a href="#widl-Event-path">path</a></span>;</span>
};</span></pre><section id="attributes-2"><h4 aria-level="3" role="heading" id="h4_attributes-2"><span class="secno">9.5.1 </span>Attributes</h4><dl class="attributes"><dt id="widl-Event-path"><code>path</code> of type <span class="idlAttrType">object</span>, readonly   </dt><dd>
            <p>Represents the event path.</p>
            <p>
              On getting, the attribute <strong>must</strong> create and return a new JavaScript Array object, that is a copy of the event path for the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a>.
            </p>
            <div class="issue"><div class="issue-title" aria-level="4" role="heading" id="h_issue_1"><span>Issue 1</span></div><p class="">
              Use <code>Array</code> as the return type of the <code>path</code> attribute in WebIDL.
              WebIDL bugs: <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=20020"><code>Array</code> subclassing</a>
              and <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=23225">class, not interface</a>.
            </p></div>
          </dd></dl></section>
      </section>

    </section>

    <section id="shadow-dom-example">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_shadow-dom-example"><span class="secno">10. </span>Shadow DOM Example</h2>

      <p>Bob was asked to turn a simple list of links into a News Widget, which has links organized into two categories: breaking news and just news. The current document markup for the stories looks like this:</p>
      <div class="example"><div class="example-title"><span>Example 2</span></div><pre class="example highlight prettyprint prettyprinted"><span class="tag">&lt;ul</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"stories"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/1"</span><span class="tag">&gt;</span><span class="pln">A story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/2"</span><span class="tag">&gt;</span><span class="pln">Another story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/3"</span><span class="tag">&gt;</span><span class="pln">Also a story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/4"</span><span class="tag">&gt;</span><span class="pln">Yet another story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/4"</span><span class="tag">&gt;</span><span class="pln">Awesome story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/5"</span><span class="tag">&gt;</span><span class="pln">Horrible story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
</span><span class="tag">&lt;/ul&gt;</span></pre></div>

      <p>To organize the stories, Bob decides to use <strong>shadow DOM</strong>. Doing so will allow Bob to keep the document markup uncluttered, and harnessing the power of insertion point makes sorting stories by class name a very simple task. After getting another cup of <a href="http://en.wikipedia.org/wiki/List_of_coffee_beverages#Green_Eye">Green Eye</a>, he quickly mocks up the following shadow tree, to be hosted by the <code>ul</code> element:</p>
      <div class="example"><div class="example-title"><span>Example 3</span></div><pre class="example highlight prettyprint prettyprinted"><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;ul&gt;</span><span class="pln">
        </span><span class="tag">&lt;content</span><span class="pln"> </span><span class="atn">select</span><span class="pun">=</span><span class="atv">".breaking"</span><span class="tag">&gt;&lt;/content&gt;</span><span class="pln"> </span><span class="com">&lt;!-- insertion point for breaking news --&gt;</span><span class="pln">
    </span><span class="tag">&lt;/ul&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span><span class="pln">
</span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"other"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;ul&gt;</span><span class="pln">
        </span><span class="tag">&lt;content&gt;&lt;/content&gt;</span><span class="pln"> </span><span class="com">&lt;!-- insertion point for the rest of the news --&gt;</span><span class="pln">
    </span><span class="tag">&lt;/ul&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span></pre></div>
      <p>Bob then styles the newborn widget according to comps from the designer by adding this to the shadow tree mockup:</p>
      <div class="example"><div class="example-title"><span>Example 4</span></div><pre class="example highlight prettyprint prettyprinted"><span class="tag">&lt;style&gt;</span><span class="pln">
    div</span><span class="pun">.</span><span class="pln">breaking </span><span class="pun">{</span><span class="pln">
        color</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Red</span><span class="pun">;</span><span class="pln">
        font</span><span class="pun">-</span><span class="pln">size</span><span class="pun">:</span><span class="pln"> </span><span class="lit">20px</span><span class="pun">;</span><span class="pln">
        border</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1px</span><span class="pln"> dashed </span><span class="typ">Purple</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
    div</span><span class="pun">.</span><span class="pln">other </span><span class="pun">{</span><span class="pln">
        padding</span><span class="pun">:</span><span class="pln"> </span><span class="lit">2px</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln">
        border</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1px</span><span class="pln"> solid </span><span class="typ">Cyan</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
</span><span class="tag">&lt;/style&gt;</span></pre></div>
      <p>While pondering if his company should start looking for a new designer, Bob converts the mockup to code:</p>
      <div class="example"><div class="example-title"><span>Example 5</span></div><pre class="example highlight prettyprint prettyprinted"><span class="kwd">function</span><span class="pln"> createStoryGroup</span><span class="pun">(</span><span class="pln">className</span><span class="pun">,</span><span class="pln"> contentSelector</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> </span><span class="kwd">group</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'div'</span><span class="pun">);</span><span class="pln">
    </span><span class="kwd">group</span><span class="pun">.</span><span class="pln">className </span><span class="pun">=</span><span class="pln"> className</span><span class="pun">;</span><span class="pln">
    </span><span class="com">// Empty string in select attribute or absence thereof work the same, so no need for special handling.</span><span class="pln">
    </span><span class="kwd">group</span><span class="pun">.</span><span class="pln">innerHTML </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;ul&gt;&lt;content select="'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> contentSelector </span><span class="pun">+</span><span class="pln"> </span><span class="str">'"&gt;&lt;/content&gt;&lt;/ul&gt;'</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">group</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> createStyle</span><span class="pun">()</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> style </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'style'</span><span class="pun">);</span><span class="pln">
    style</span><span class="pun">.</span><span class="pln">textContent </span><span class="pun">=</span><span class="pln"> </span><span class="str">'div.breaking { color: Red;font-size: 20px; border: 1px dashed Purple; }'</span><span class="pln"> </span><span class="pun">+</span><span class="pln">
        </span><span class="str">'div.other { padding: 2px 0 0 0; border: 1px solid Cyan; }'</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> style</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> makeShadowTree</span><span class="pun">(</span><span class="pln">storyList</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> root </span><span class="pun">=</span><span class="pln"> storyList</span><span class="pun">.</span><span class="pln">createShadowRoot</span><span class="pun">();</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStyle</span><span class="pun">());</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStoryGroup</span><span class="pun">(</span><span class="str">'breaking'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'.breaking'</span><span class="pun">));</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStoryGroup</span><span class="pun">(</span><span class="str">'other'</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">));</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

document</span><span class="pun">.</span><span class="pln">addEventListener</span><span class="pun">(</span><span class="str">'DOMContentLoaded'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="pun">[].</span><span class="pln">forEach</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="pln">document</span><span class="pun">.</span><span class="pln">querySelectorAll</span><span class="pun">(</span><span class="str">'ul.stories'</span><span class="pun">),</span><span class="pln"> makeShadowTree</span><span class="pun">);</span><span class="pln">
</span><span class="pun">});</span></pre></div>

      <p>Well done, Bob! With the cup of coffee still half-full, the work is complete. Recognizing his awesomeness, Bob returns to teaching n00bs the ways of <a href="http://en.wikipedia.org/wiki/World_of_Warcraft">WoW</a>.</p>

      <p>A few months pass.</p>

      <p>It's election time. With Bob at his annual conference, Alice is charged with adding <strong>another</strong>, temporary box to the news widget, filled with election-related stories. Alice studies Bob's code, reads up on the shadow DOM spec and realizes that, thanks to multiple shadow tree support, she doesn't have to touch his code. As usual, her solution is elegant and simple, fitting neatly right under Bob's code:</p>
      <div class="example"><div class="example-title"><span>Example 6</span></div><pre class="example highlight prettyprint prettyprinted"><span class="com">// TODO(alice): BEGIN -- DELETE THIS CODE AFTER ELECTIONS ARE OVER.</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> ELECTION_BOX_REMOVAL_DEADLINE </span><span class="pun">=</span><span class="pln"> </span><span class="pun">...;</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> createElectionStyle</span><span class="pun">()</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> style </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'style'</span><span class="pun">);</span><span class="pln">
    </span><span class="com">// TODO(alice): Check designer's desk for hallucinogens.</span><span class="pln">
    style</span><span class="pun">.</span><span class="pln">textContent </span><span class="pun">=</span><span class="pln"> </span><span class="str">'div.election { color: Magenta; font-size: 24px; border: 2px dotted Fuchsia; }'</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> style</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> makeElectionShadowTree</span><span class="pun">(</span><span class="pln">storyList</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> root </span><span class="pun">=</span><span class="pln"> storyList</span><span class="pun">.</span><span class="pln">createShadowRoot</span><span class="pun">();</span><span class="pln">
    </span><span class="com">// Add and style election story box.</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createElectionStyle</span><span class="pun">());</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStoryGroup</span><span class="pun">(</span><span class="str">'election'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'.election'</span><span class="pun">));</span><span class="pln">
    </span><span class="com">// Insert Bob's shadow tree under the election story box.</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'shadow'</span><span class="pun">));</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Date</span><span class="pun">.</span><span class="pln">now</span><span class="pun">()</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> ELECTION_BOX_REMOVAL_DEADLINE</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    document</span><span class="pun">.</span><span class="pln">addEventListener</span><span class="pun">(</span><span class="str">'DOMContentLoaded'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="pun">[].</span><span class="pln">forEach</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="pln">document</span><span class="pun">.</span><span class="pln">querySelectorAll</span><span class="pun">(</span><span class="str">'ul.stories'</span><span class="pun">),</span><span class="pln"> makeElectionShadowTree</span><span class="pun">);</span><span class="pln">
    </span><span class="pun">});</span><span class="pln">
</span><span class="pun">}</span><span class="pln">
</span><span class="com">// TODO(alice): END -- DELETE THIS CODE AFTER ELECTIONS ARE OVER.</span></pre></div>
      <p>Using the <code>shadow</code> element allows Alice to compose Bob's widget <strong>inside</strong> of hers—without having to change a line of production code. Smiling to herself, Alice realizes that Bob may have come up with a way to keep the document markup clean, but <strong>she</strong> is the one who takes the cake for using shadow tree composition in such a cool way.</p>
    </section>

    <section class="appendix" id="acknowledgements">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_acknowledgements"><span class="secno">A. </span>Acknowledgements</h2>

      <p><span class="vcard">David Hyatt</span> developed <a href="http://dev.w3.org/2006/xbl2/">XBL 1.0</a>, and <span class="vcard">Ian Hickson</span> co-wrote <a href="http://dev.w3.org/2006/xbl2/">XBL 2.0</a>. These documents provided tremendous insight into the problem of functional encapsulation and greatly influenced this specification.</p>

      <p><span class="vcard">Alex Russell</span> and his considerable forethought triggered a new wave of enthusiasm around the subject of shadow DOM and how it can be applied practically on the Web.</p>

      <p><span class="vcard">Dominic Cooney</span>, <span class="vcard">Hajime Morrita</span>, and <span class="vcard">Roland Steiner</span> worked tirelessly to scope the problem of functional encapsulation within the confines of the Web platform and provided a solid foundation for this document.</p>

      <p>The editor would also like to thank <span class="vcard">Alex Komoroske</span>, <span class="vcard">Anne van Kesteren</span>, <span class="vcard">Brandon Payton</span>, <span class="vcard">Brian Kardell</span>, <span class="vcard">Darin Fisher</span>, <span class="vcard">Eric Bidelman</span>, <span class="vcard">Deepak Sherveghar</span>, <span class="vcard">Edward O'Connor</span>, <span class="vcard">Elisée Maurer</span>, <span class="vcard">Elliott Sprehn</span>, <span class="vcard">Erik Arvidsson</span>, <span class="vcard">Glenn Adams</span>, <span class="vcard">Jonas Sicking</span>, <span class="vcard">Malte Ubl</span>, <span class="vcard">Mike Taylor</span>, <span class="vcard">Oliver Nightingale</span>, <span class="vcard">Olli Pettay</span>, <span class="vcard">Rafael Weinstein</span>, <span class="vcard">Richard Bradshaw</span>, <span class="vcard">Ruud Steltenpool</span>, <span class="vcard">Sam Dutton</span>, <span class="vcard">Sergey G. Grekhov</span>, <span class="vcard">Shinya Kawanaka</span>, <span class="vcard">Tab Atkins</span>, <span class="vcard">Takashi Sakamoto</span>, and <span class="vcard">Yoshinori Sano</span> for their comments and contributions to this specification.</p>

      <p>This list is too short. There's a lot of work left to do. Please contribute by reviewing and filing bugs—and don't forget to ask the editor to add your name into this section.</p>
    </section>

  

<section id="references" class="appendix" typeof="bibo:Chapter" resource="#references" rel="bibo:Chapter"><!--OddPage--><h2 aria-level="1" role="heading" id="h2_references"><span class="secno">B. </span>References</h2><section id="normative-references" typeof="bibo:Chapter" resource="#normative-references" rel="bibo:Chapter"><h3 aria-level="2" role="heading" id="h3_normative-references"><span class="secno">B.1 </span>Normative references</h3><dl class="bibliography" about=""><dt id="bib-CSS3UI">[CSS3UI]</dt><dd rel="dcterms:requires">Tantek Çelik. <a href="http://www.w3.org/TR/css3-ui/"><cite>CSS3 Basic User Interface Module</cite></a>. 17 January 2012. W3C Working Draft. URL: <a href="http://www.w3.org/TR/css3-ui/">http://www.w3.org/TR/css3-ui/</a>
</dd><dt id="bib-CSSOM-VIEW">[CSSOM-VIEW]</dt><dd rel="dcterms:requires">Simon Pieters; Glenn Adams. <a href="http://www.w3.org/TR/cssom-view/"><cite>CSSOM View Module</cite></a>. 17 December 2013. W3C Working Draft. URL: <a href="http://www.w3.org/TR/cssom-view/">http://www.w3.org/TR/cssom-view/</a>
</dd><dt id="bib-DOM">[DOM]</dt><dd rel="dcterms:requires">Anne van Kesteren; Aryeh Gregor; Ms2ger. <a href="http://dom.spec.whatwg.org"><cite>DOM Standard</cite></a>. Living Standard. URL: <a href="http://dom.spec.whatwg.org">http://dom.spec.whatwg.org</a>
</dd><dt id="bib-DOM-Level-3-Events">[DOM-Level-3-Events]</dt><dd rel="dcterms:requires">Gary Kacmarcik; Travis Leithead; Jacob Rossi; Doug Schepers; Björn Höhrmann; Philippe Le Hégaret; Tom Pixley. <a href="http://www.w3.org/TR/DOM-Level-3-Events/"><cite>Document Object Model (DOM) Level 3 Events Specification</cite></a>. 5 November 2013. W3C Working Draft. URL: <a href="http://www.w3.org/TR/DOM-Level-3-Events/">http://www.w3.org/TR/DOM-Level-3-Events/</a>
</dd><dt id="bib-DOMPARSING">[DOMPARSING]</dt><dd rel="dcterms:requires">Ms2ger. <a href="http://domparsing.spec.whatwg.org/"><cite>DOM Parsing and Serialization</cite></a>. URL: <a href="http://domparsing.spec.whatwg.org/">http://domparsing.spec.whatwg.org/</a>
</dd><dt id="bib-EDITING">[EDITING]</dt><dd rel="dcterms:requires">Aryeh Gregor. <a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html"><cite>HTML Editing APIs</cite></a>. URL: <a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html">https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html</a>
</dd><dt id="bib-HTML">[HTML]</dt><dd rel="dcterms:requires">Ian Hickson. <a href="http://www.whatwg.org/specs/web-apps/current-work/"><cite>HTML</cite></a>. Living Standard. URL: <a href="http://www.whatwg.org/specs/web-apps/current-work/">http://www.whatwg.org/specs/web-apps/current-work/</a>
</dd><dt id="bib-RFC2119">[RFC2119]</dt><dd rel="dcterms:requires">S. Bradner. <a href="http://www.ietf.org/rfc/rfc2119.txt"><cite>Key words for use in RFCs to Indicate Requirement Levels.</cite></a> March 1997. Internet RFC 2119.  URL: <a href="http://www.ietf.org/rfc/rfc2119.txt">http://www.ietf.org/rfc/rfc2119.txt</a> 
</dd><dt id="bib-SELECTORS4">[SELECTORS4]</dt><dd rel="dcterms:requires">Elika Etemad; Tab Atkins Jr. <a href="http://dev.w3.org/csswg/selectors4/"><cite>Selectors Level 4</cite></a>. W3C Editor's Draft. URL: <a href="http://dev.w3.org/csswg/selectors4/">http://dev.w3.org/csswg/selectors4/</a>
</dd><dt id="bib-TOUCH-EVENTS">[TOUCH-EVENTS]</dt><dd rel="dcterms:requires">Doug Schepers; Sangwhan Moon; Matt Brubeck; Arthur Barstow. <a href="http://www.w3.org/TR/touch-events/"><cite>Touch Events</cite></a>. 10 October 2013. W3C Recommendation. URL: <a href="http://www.w3.org/TR/touch-events/">http://www.w3.org/TR/touch-events/</a>
</dd><dt id="bib-WAI-ARIA">[WAI-ARIA]</dt><dd rel="dcterms:requires">James Craig; Michael Cooper et al. <a href="http://www.w3.org/TR/wai-aria/"><cite>Accessible Rich Internet Applications (WAI-ARIA) 1.0</cite></a>. 20 March 2014. W3C Recommendation. URL: <a href="http://www.w3.org/TR/wai-aria/">http://www.w3.org/TR/wai-aria/</a>
</dd></dl></section></section></body></html>
<!DOCTYPE html>
<html lang="en" dir="ltr" typeof="bibo:Document " about="" property="dcterms:language" content="en">
<head>
    <meta charset="utf-8">
    <title>Shadow DOM</title>
    
    
    <style>/* --- EXAMPLES --- */
div.example-title {
    min-width: 7.5em;
    color: #b9ab2d;
}
div.example-title span {
    text-transform: uppercase;   
}
aside.example, div.example, div.illegal-example {
    padding: 0.5em;
    margin: 1em 0;
    position: relative;
    clear: both;
}
div.illegal-example { color: red }
div.illegal-example p { color: black }
aside.example, div.example {
    padding: .5em;
    border-left-width: .5em;
    border-left-style: solid;
    border-color: #e0cb52;
    background: #fcfaee;    
}

aside.example div.example {
    border-left-width: .1em;
    border-color: #999;
    background: #fff;
}
aside.example div.example div.example-title {
    color: #999;
}
</style><style>/* --- ISSUES/NOTES --- */
div.issue-title, div.note-title {
    padding-right:  1em;
    min-width: 7.5em;
    color: #b9ab2d;
}
div.issue-title { color: #e05252; }
div.note-title { color: #2b2; }
div.issue-title span, div.note-title span {
    text-transform: uppercase;
}
div.note, div.issue {
    margin-top: 1em;
    margin-bottom: 1em;
}
.note > p:first-child, .issue > p:first-child { margin-top: 0 }
.issue, .note {
    padding: .5em;
    border-left-width: .5em;
    border-left-style: solid;
}
div.issue, div.note {
    padding: 1em 1.2em 0.5em;
    margin: 1em 0;
    position: relative;
    clear: both;
}
span.note, span.issue { padding: .1em .5em .15em; }

.issue {
    border-color: #e05252;
    background: #fbe9e9;
}
.note {
    border-color: #52e052;
    background: #e9fbe9;
}


</style><style>/* HIGHLIGHTS */
code.prettyprint {
    color:  inherit;
}

/* this from google-code-prettify */
.pln{color:#000}@media screen{.str{color:#080}.kwd{color:#008}.com{color:#800}.typ{color:#606}.lit{color:#066}.pun,.opn,.clo{color:#660}.tag{color:#008}.atn{color:#606}.atv{color:#080}.dec,.var{color:#606}.fun{color:red}}@media print,projection{.str{color:#060}.kwd{color:#006;font-weight:bold}.com{color:#600;font-style:italic}.typ{color:#404;font-weight:bold}.lit{color:#044}.pun,.opn,.clo{color:#440}.tag{color:#006;font-weight:bold}.atn{color:#404}.atv{color:#060}}ol.linenums{margin-top:0;margin-bottom:0}li.L0,li.L1,li.L2,li.L3,li.L5,li.L6,li.L7,li.L8{list-style-type:none}li.L1,li.L3,li.L5,li.L7,li.L9{background:#eee}
</style><style>/* --- WEB IDL --- */
pre.idl {
    border-top: 1px solid #90b8de;
    border-bottom: 1px solid #90b8de;
    padding:    1em;
    line-height:    120%;
}

pre.idl::before {
    content:    "WebIDL";
    display:    block;
    width:      150px;
    background: #90b8de;
    color:  #fff;
    font-family:    initial;
    padding:    3px;
    font-weight:    bold;
    margin: -1em 0 1em -1em;
}

.idlType {
    color:  #ff4500;
    font-weight:    bold;
    text-decoration:    none;
}

/*.idlModule*/
/*.idlModuleID*/
/*.idlInterface*/
.idlInterfaceID, .idlDictionaryID, .idlCallbackID, .idlEnumID {
    font-weight:    bold;
    color:  #005a9c;
}
a.idlEnumItem {
    color:  #000;
    border-bottom:  1px dotted #ccc;
    text-decoration: none;
}

.idlSuperclass {
    font-style: italic;
    color:  #005a9c;
}

/*.idlAttribute*/
.idlAttrType, .idlFieldType, .idlMemberType {
    color:  #005a9c;
}
.idlAttrName, .idlFieldName, .idlMemberName {
    color:  #ff4500;
}
.idlAttrName a, .idlFieldName a, .idlMemberName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlMethod*/
.idlMethType, .idlCallbackType {
    color:  #005a9c;
}
.idlMethName {
    color:  #ff4500;
}
.idlMethName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlCtor*/
.idlCtorName {
    color:  #ff4500;
}
.idlCtorName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlParam*/
.idlParamType {
    color:  #005a9c;
}
.idlParamName, .idlDefaultValue {
    font-style: italic;
}

.extAttr {
    color:  #666;
}

/*.idlSectionComment*/
.idlSectionComment {
    color: gray;
}

/*.idlConst*/
.idlConstType {
    color:  #005a9c;
}
.idlConstName {
    color:  #ff4500;
}
.idlConstName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlException*/
.idlExceptionID {
    font-weight:    bold;
    color:  #c00;
}

.idlTypedefID, .idlTypedefType {
    color:  #005a9c;
}

.idlRaises, .idlRaises a.idlType, .idlRaises a.idlType code, .excName a, .excName a code {
    color:  #c00;
    font-weight:    normal;
}

.excName a {
    font-family:    monospace;
}

.idlRaises a.idlType, .excName a.idlType {
    border-bottom:  1px dotted #c00;
}

.excGetSetTrue, .excGetSetFalse, .prmNullTrue, .prmNullFalse, .prmOptTrue, .prmOptFalse {
    width:  45px;
    text-align: center;
}
.excGetSetTrue, .prmNullTrue, .prmOptTrue { color:  #0c0; }
.excGetSetFalse, .prmNullFalse, .prmOptFalse { color:  #c00; }

.idlImplements a {
    font-weight:    bold;
}

dl.attributes, dl.methods, dl.constants, dl.constructors, dl.fields, dl.dictionary-members {
    margin-left:    2em;
}

.attributes dt, .methods dt, .constants dt, .constructors dt, .fields dt, .dictionary-members dt {
    font-weight:    normal;
}

.attributes dt code, .methods dt code, .constants dt code, .constructors dt code, .fields dt code, .dictionary-members dt code {
    font-weight:    bold;
    color:  #000;
    font-family:    monospace;
}

.attributes dt code, .fields dt code, .dictionary-members dt code {
    background:  #ffffd2;
}

.attributes dt .idlAttrType code, .fields dt .idlFieldType code, .dictionary-members dt .idlMemberType code {
    color:  #005a9c;
    background:  transparent;
    font-family:    inherit;
    font-weight:    normal;
    font-style: italic;
}

.methods dt code {
    background:  #d9e6f8;
}

.constants dt code {
    background:  #ddffd2;
}

.constructors dt code {
    background:  #cfc;
}

.attributes dd, .methods dd, .constants dd, .constructors dd, .fields dd, .dictionary-members dd {
    margin-bottom:  1em;
}

table.parameters, table.exceptions {
    border-spacing: 0;
    border-collapse:    collapse;
    margin: 0.5em 0;
    width:  100%;
}
table.parameters { border-bottom:  1px solid #90b8de; }
table.exceptions { border-bottom:  1px solid #deb890; }

.parameters th, .exceptions th {
    color:  #fff;
    padding:    3px 5px;
    text-align: left;
    font-family:    initial;
    font-weight:    normal;
    text-shadow:    #666 1px 1px 0;
}
.parameters th { background: #90b8de; }
.exceptions th { background: #deb890; }

.parameters td, .exceptions td {
    padding:    3px 10px;
    border-top: 1px solid #ddd;
    vertical-align: top;
}

.parameters tr:first-child td, .exceptions tr:first-child td {
    border-top: none;
}

.parameters td.prmName, .exceptions td.excName, .exceptions td.excCodeName {
    width:  100px;
}

.parameters td.prmType {
    width:  120px;
}

table.exceptions table {
    border-spacing: 0;
    border-collapse:    collapse;
    width:  100%;
}
</style><link rel="stylesheet" href="respec-complement.css" type="text/css">
<link rel="stylesheet" href="working-draft.css" type="text/css">
<script src="working-draft.js"></script>
    
    
    
  <style>/*****************************************************************
 * ReSpec 3 CSS
 * Robin Berjon - http://berjon.com/
 *****************************************************************/

/* --- INLINES --- */
em.rfc2119 { 
    text-transform:     lowercase;
    font-variant:       small-caps;
    font-style:         normal;
    color:              #900;
}

h1 acronym, h2 acronym, h3 acronym, h4 acronym, h5 acronym, h6 acronym, a acronym,
h1 abbr, h2 abbr, h3 abbr, h4 abbr, h5 abbr, h6 abbr, a abbr {
    border: none;
}

dfn {
    font-weight:    bold;
}

a.internalDFN {
    color:  inherit;
    border-bottom:  1px solid #99c;
    text-decoration:    none;
}

a.externalDFN {
    color:  inherit;
    border-bottom:  1px dotted #ccc;
    text-decoration:    none;
}

a.bibref {
    text-decoration:    none;
}

cite .bibref {
    font-style: normal;
}

code {
    color:  #ff4500;
}

/* --- TOC --- */
.toc a, .tof a {
    text-decoration:    none;
}

a .secno, a .figno {
    color:  #000;
}

ul.tof, ol.tof {
    list-style: none outside none;
}

.caption {
    margin-top: 0.5em;
    font-style:   italic;
}

/* --- TABLE --- */
table.simple {
    border-spacing: 0;
    border-collapse:    collapse;
    border-bottom:  3px solid #005a9c;
}

.simple th {
    background: #005a9c;
    color:  #fff;
    padding:    3px 5px;
    text-align: left;
}

.simple th[scope="row"] {
    background: inherit;
    color:  inherit;
    border-top: 1px solid #ddd;
}

.simple td {
    padding:    3px 10px;
    border-top: 1px solid #ddd;
}

.simple tr:nth-child(even) {
    background: #f0f6ff;
}

/* --- DL --- */
.section dd > p:first-child {
    margin-top: 0;
}

.section dd > p:last-child {
    margin-bottom: 0;
}

.section dd {
    margin-bottom:  1em;
}

.section dl.attrs dd, .section dl.eldef dd {
    margin-bottom:  0;
}

@media print {
    .removeOnSave {
        display: none;
    }
}
</style><link rel="stylesheet" href="https://www.w3.org/StyleSheets/TR/W3C-WD"><!--[if lt IE 9]><script src='https://www.w3.org/2008/site/js/html5shiv.js'></script><![endif]--></head>
  <body class="h-entry" role="document" id="respecDocument"><div class="head" role="contentinfo" id="respecHeader">
  <p>
    
      <a href="http://www.w3.org/"><img width="72" height="48" src="https://www.w3.org/Icons/w3c_home" alt="W3C"></a>
    
  </p>
  <h1 class="title p-name" id="title" property="dcterms:title">Shadow DOM</h1>
  
  <h2 property="dcterms:issued" datatype="xsd:dateTime" content="2014-06-19T00:00:00.000Z" id="w3c-working-draft-19-jun-2014"><abbr title="World Wide Web Consortium">W3C</abbr> Working Draft <time class="dt-published" datetime="2014-06-19">19 June 2014</time></h2>
  <dl>
    
      <dt>This version:</dt>
      <dd><a href="http://www.w3.org/TR/2014/WD-shadow-dom-20140619/">http://www.w3.org/TR/2014/WD-shadow-dom-20140619/</a></dd>
      <dt>Latest published version:</dt>
      <dd><a href="http://www.w3.org/TR/shadow-dom/">http://www.w3.org/TR/shadow-dom/</a></dd>
    
    
      <dt>Latest editor's draft:</dt>
      <dd><a href="http://w3c.github.io/webcomponents/spec/shadow/">http://w3c.github.io/webcomponents/spec/shadow/</a></dd>
      <dt>Previous version</dt>
      <dd><a href="http://www.w3.org/TR/2013/WD-shadow-dom-20130514/">http://www.w3.org/TR/2013/WD-shadow-dom-20130514/</a></dd>
    
    
    
      
    
    
    
    <dt>Editors:</dt>
    <dd class="p-author h-card vcard" rel="bibo:editor" inlist=""><span typeof="foaf:Person"><a class="u-url url p-name fn" rel="foaf:homepage" property="foaf:name" content="Dimitri Glazkov" href="mailto:dglazkov@chromium.org">Dimitri Glazkov</a>, Google, Inc.</span>
</dd>
<dd class="p-author h-card vcard" rel="bibo:editor" inlist=""><span typeof="foaf:Person"><a class="u-url url p-name fn" rel="foaf:homepage" property="foaf:name" content="Hayato Ito" href="mailto:hayato@google.com">Hayato Ito</a>, Google, Inc.</span>
</dd>

    
    
      
        
          <dt>Revision history:</dt>
          
            
              
                <dd>
                  <a href="https://github.com/w3c/webcomponents/commits/gh-pages/spec/shadow/">https://github.com/w3c/webcomponents/commits/gh-pages/spec/shadow/</a>
                </dd>
              
            
          
        
      
    
  </dl>
  

      <p class="copyright">
        <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> ©
        2014
        
        <a href="http://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>®</sup>
        (<a href="http://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>,
        <a href="http://www.ercim.eu/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>,
        <a href="http://www.keio.ac.jp/">Keio</a>, <a href="http://ev.buaa.edu.cn/">Beihang</a>), 
        
        All Rights Reserved.
        
        <abbr title="World Wide Web Consortium">W3C</abbr> <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>,
        <a href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and
        
          <a href="http://www.w3.org/Consortium/Legal/copyright-documents">document use</a>
        
        rules apply.
      </p>
    
  
  <hr>
</div>
    <section id="abstract" class="introductory" property="dcterms:abstract" datatype="" typeof="bibo:Chapter" resource="#abstract" rel="bibo:Chapter"><h2 aria-level="1" role="heading" id="h2_abstract">Abstract</h2>

      <p>
        <strong>This is a work in progress!</strong> For the latest updates
        from the <a href="http://www.w3.org/2008/webapps/">Web Applications
        (WebApps) Working Group</a> possibly including important bug fixes,
        please look at the <a href="http://w3c.github.io/webcomponents/spec/shadow/">draft on GitHub</a>.
      </p>

      <p>
        This specification describes a method of combining multiple DOM trees into one hierarchy and how these trees interact with each other within a document, thus
        enabling better composition of the DOM.
      </p>
    </section><section id="sotd" class="introductory" typeof="bibo:Chapter" resource="#sotd" rel="bibo:Chapter"><h2 aria-level="1" role="heading" id="h2_sotd">Status of This Document</h2>

      <div id="wipcontainer">
        <p class="stability" id="wip">
          <strong>This is a work in progress!</strong>
          This specification is for review and not for implementation! For the latest updates,
          including important bug fixes, please look at the
          <a href="http://w3c.github.io/webcomponents/spec/shadow/">draft on GitHub</a> instead.
          <input onclick="hideWIP(this)" value="×" type="button">
        </p>
      </div>
    
        <p>
          <em>This section describes the status of this document at the time of its publication.
          Other documents may supersede this document. A list of current <abbr title="World Wide Web Consortium">W3C</abbr> publications and the
          latest revision of this technical report can be found in the <a href="http://www.w3.org/TR/"><abbr title="World Wide Web Consortium">W3C</abbr> technical reports index</a> at
          http://www.w3.org/TR/.</em>
        </p>
        
    
        <p>
          This document was published by the <a href="http://www.w3.org/2008/webapps/"><abbr title="World Wide Web Consortium">W3C</abbr> Web Applications (WebApps)</a> as a Working Draft.
          
          
            If you wish to make comments regarding this document, please send them to 
            <a href="mailto:public-webapps@w3.org">public-webapps@w3.org</a> 
            (<a href="mailto:public-webapps-request@w3.org?subject=subscribe">subscribe</a>,
            <a href="http://lists.w3.org/Archives/Public/public-webapps/">archives</a>).
          
          
          
          
            All comments are welcome.
          
        </p>
        
        
          <p>
            Publication as a Working Draft does not imply endorsement by the <abbr title="World Wide Web Consortium">W3C</abbr>
            Membership. This is a draft document and may be updated, replaced or obsoleted by other
            documents at any time. It is inappropriate to cite this document as other than work in
            progress.
          </p>
        
        
        
        <p>
          
            This document was produced by a group operating under the 
            <a id="sotd_patent" about="" rel="w3p:patentRules" href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004 <abbr title="World Wide Web Consortium">W3C</abbr> Patent
            Policy</a>.
          
          
          
            
              <abbr title="World Wide Web Consortium">W3C</abbr> maintains a <a href="http://www.w3.org/2004/01/pp-impl/42538/status" rel="disclosure">public list of any patent
              disclosures</a> 
            
            made in connection with the deliverables of the group; that page also includes
            instructions for disclosing a patent. An individual who has actual knowledge of a patent
            which the individual believes contains
            <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential
            Claim(s)</a> must disclose the information in accordance with
            <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section
            6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>.
          
          
        </p>
        
      
    
  
</section><section id="toc"><h2 class="introductory" aria-level="1" role="heading" id="h2_toc">Table of Contents</h2><ul class="toc" role="directory" id="respecContents"><li class="tocline"><a href="#conformance" class="tocxref"><span class="secno">1. </span>Conformance</a></li><li class="tocline"><a href="#concepts" class="tocxref"><span class="secno">2. </span>Concepts</a><ul class="toc"><li class="tocline"><a href="#introduction" class="tocxref"><span class="secno">2.1 </span>Introduction</a></li><li class="tocline"><a href="#shadow-trees" class="tocxref"><span class="secno">2.2 </span>Shadow trees</a></li><li class="tocline"><a href="#trees-of-trees" class="tocxref"><span class="secno">2.3 </span>Trees of trees</a><ul class="toc"><li class="tocline"><a href="#example-tree-of-trees" class="tocxref"><span class="secno">2.3.1 </span>Example tree of trees</a></li></ul></li><li class="tocline"><a href="#composed-trees" class="tocxref"><span class="secno">2.4 </span>Composed trees</a></li></ul></li><li class="tocline"><a href="#distributions" class="tocxref"><span class="secno">3. </span>Distributions</a><ul class="toc"><li class="tocline"><a href="#insertion-points" class="tocxref"><span class="secno">3.1 </span>Insertion Points</a></li><li class="tocline"><a href="#content-insertion-points" class="tocxref"><span class="secno">3.2 </span>Content Insertion Points</a></li><li class="tocline"><a href="#shadow-insertion-points" class="tocxref"><span class="secno">3.3 </span>Shadow Insertion Points</a></li><li class="tocline"><a href="#distribution-results" class="tocxref"><span class="secno">3.4 </span>Distribution Results</a></li><li class="tocline"><a href="#distribution-algorithms" class="tocxref"><span class="secno">3.5 </span>Distribution Algorithms</a></li><li class="tocline"><a href="#satisfying-matching-criteria" class="tocxref"><span class="secno">3.6 </span>Satisfying Matching Criteria</a></li></ul></li><li class="tocline"><a href="#composition" class="tocxref"><span class="secno">4. </span>Composition</a></li><li class="tocline"><a href="#events" class="tocxref"><span class="secno">5. </span>Events</a><ul class="toc"><li class="tocline"><a href="#events-that-are-always-stopped" class="tocxref"><span class="secno">5.1 </span>Events that are Always Stopped</a></li><li class="tocline"><a href="#event-paths" class="tocxref"><span class="secno">5.2 </span>Event Paths</a></li><li class="tocline"><a href="#event-paths-example" class="tocxref"><span class="secno">5.3 </span>Event Paths Example</a></li><li class="tocline"><a href="#event-retargeting" class="tocxref"><span class="secno">5.4 </span>Event Retargeting</a></li><li class="tocline"><a href="#retargeting-relatedtarget" class="tocxref"><span class="secno">5.5 </span>Retargeting <code>relatedTarget</code></a></li><li class="tocline"><a href="#retargeting-touch-events" class="tocxref"><span class="secno">5.6 </span>Retargeting Touch Events</a></li><li class="tocline"><a href="#retargeting-focus-events" class="tocxref"><span class="secno">5.7 </span>Retargeting Focus Events</a></li><li class="tocline"><a href="#event-dispatch" class="tocxref"><span class="secno">5.8 </span>Event Dispatch</a></li><li class="tocline"><a href="#event-retargeting-example" class="tocxref"><span class="secno">5.9 </span>Event Retargeting Example</a></li></ul></li><li class="tocline"><a href="#user-interaction" class="tocxref"><span class="secno">6. </span>User Interaction</a><ul class="toc"><li class="tocline"><a href="#ranges-and-selections" class="tocxref"><span class="secno">6.1 </span>Ranges and Selections</a></li><li class="tocline"><a href="#focus-navigation" class="tocxref"><span class="secno">6.2 </span>Focus Navigation</a></li><li class="tocline"><a href="#active-element" class="tocxref"><span class="secno">6.3 </span>Active Element</a></li><li class="tocline"><a href="#editing" class="tocxref"><span class="secno">6.4 </span>Editing</a></li><li class="tocline"><a href="#assistive-technology" class="tocxref"><span class="secno">6.5 </span>Assistive Technology</a></li></ul></li><li class="tocline"><a href="#html-elements-in-shadow-trees" class="tocxref"><span class="secno">7. </span>HTML Elements in Shadow Trees</a><ul class="toc"><li class="tocline"><a href="#inert-html-elements" class="tocxref"><span class="secno">7.1 </span>Inert HTML Elements</a></li></ul></li><li class="tocline"><a href="#html-elements-and-their-shadow-trees" class="tocxref"><span class="secno">8. </span>HTML Elements and Their Shadow Trees</a></li><li class="tocline"><a href="#elements-and-dom-objects" class="tocxref"><span class="secno">9. </span>Elements and DOM Objects</a><ul class="toc"><li class="tocline"><a href="#shadowroot-object" class="tocxref"><span class="secno">9.1 </span><code>ShadowRoot</code> Object</a><ul class="toc"><li class="tocline"><a href="#attributes" class="tocxref"><span class="secno">9.1.1 </span>Attributes</a></li><li class="tocline"><a href="#methods" class="tocxref"><span class="secno">9.1.2 </span>Methods</a></li></ul></li><li class="tocline"><a href="#extensions-to-element-interface" class="tocxref"><span class="secno">9.2 </span>Extensions to <code>Element</code> Interface</a><ul class="toc"><li class="tocline"><a href="#attributes-1" class="tocxref"><span class="secno">9.2.1 </span>Attributes</a></li><li class="tocline"><a href="#methods-1" class="tocxref"><span class="secno">9.2.2 </span>Methods</a></li></ul></li><li class="tocline"><a href="#the-content-element" class="tocxref"><span class="secno">9.3 </span>The <code>content</code> element</a></li><li class="tocline"><a href="#the-shadow-element" class="tocxref"><span class="secno">9.4 </span>The <code>shadow</code> element</a></li><li class="tocline"><a href="#extensions-to-event-interface" class="tocxref"><span class="secno">9.5 </span>Extensions to <code>Event</code> Interface</a><ul class="toc"><li class="tocline"><a href="#attributes-2" class="tocxref"><span class="secno">9.5.1 </span>Attributes</a></li></ul></li></ul></li><li class="tocline"><a href="#shadow-dom-example" class="tocxref"><span class="secno">10. </span>Shadow DOM Example</a></li><li class="tocline"><a href="#acknowledgements" class="tocxref"><span class="secno">A. </span>Acknowledgements</a></li><li class="tocline"><a href="#references" class="tocxref"><span class="secno">B. </span>References</a><ul class="toc"><li class="tocline"><a href="#normative-references" class="tocxref"><span class="secno">B.1 </span>Normative references</a></li></ul></li></ul></section>

    

    <section id="conformance">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_conformance"><span class="secno">1. </span>Conformance</h2>

      <p>All diagrams, examples, notes, are non-normative, as well as sections explicitly marked as non-normative. Everything else in this specification is normative.</p>

      <p>The key words "<em class="rfc2119" title="MUST">MUST</em>", "<em class="rfc2119" title="MUST NOT">MUST NOT</em>", "<em class="rfc2119" title="REQUIRED">REQUIRED</em>", "<em class="rfc2119" title="SHALL">SHALL</em>", "<em class="rfc2119" title="SHALL NOT">SHALL NOT</em>", "<em class="rfc2119" title="SHOULD">SHOULD</em>", "<em class="rfc2119" title="SHOULD NOT">SHOULD NOT</em>", "<em class="rfc2119" title="RECOMMENDED">RECOMMENDED</em>", "<em class="rfc2119" title="MAY">MAY</em>", and "<em class="rfc2119" title="OPTIONAL">OPTIONAL</em>" in the normative parts of this document are to be interpreted as described in [<cite><a class="bibref" href="#bib-RFC2119">RFC2119</a></cite>]. For readability, these words do not appear in all uppercase letters in this specification.</p>

      <p>To help with layering and to avoid circular dependencies between various parts of specification, this document consists of three consecutive narratives:</p>
      <ol>
        <li>setting up the stage for the specification,</li>
        <li>explaining of the conceptual model and algorithms behind it, and</li>
        <li>expressing this model with DOM interfaces and HTML elements.</li>
      </ol>

      <p>In a sense, these parts can be viewed as <em>math</em>, which sets up the reasoning environment, <em>physics</em>, which is the theoretical reasoning about the concept, and <em>mechanics</em>, which is the practical application of this reasoning.</p>

      <p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="http://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence">processing equivalence</dfn> is a constraint imposed on the algorithm implementors, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>
    </section>

    <section id="concepts">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_concepts"><span class="secno">2. </span>Concepts</h2>

      <section class="informative" id="introduction">
        <h3 aria-level="2" role="heading" id="h3_introduction"><span class="secno">2.1 </span>Introduction</h3><p><em>This section is non-normative.</em></p>

        <p>
          See the <a href="http://w3c.github.io/webcomponents/explainer/#shadow-dom-section">Shadow DOM section</a> of <a href="http://w3c.github.io/webcomponents/explainer/">Introduction to Web Components</a> as a non-normative intruduction.
        </p>
      </section>

      <section id="shadow-trees">
        <h3 aria-level="2" role="heading" id="h3_shadow-trees"><span class="secno">2.2 </span>Shadow trees</h3>

        <p>A <dfn id="dfn-document-tree">document tree</dfn> is a <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> [<cite><a class="bibref" href="#bib-DOM">DOM</a></cite>] whose <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> is a <a href="http://dom.spec.whatwg.org/#concept-document" class="externalDFN">document</a>.</p>

        <p>Any element can have an <dfn title="shadow roots list" id="dfn-shadow-roots-list">associated ordered list</dfn> of zero or more <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a>.</p>

        <p>An element <dfn id="dfn-hosts">hosts</dfn> a <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> if the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> is a member of this associated list.</p>

        <p>A <dfn id="dfn-shadow-host">shadow host</dfn> is an element that <a href="#dfn-hosts" class="internalDFN">hosts</a> one or more <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a>.</p>

        <p>A <dfn id="dfn-shadow-tree">shadow tree</dfn> is a <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> <a title="hosts" href="#dfn-hosts" class="internalDFN">hosted</a> by a <a href="#dfn-shadow-host" class="internalDFN">shadow host</a>.</p>

        <p>A <dfn id="dfn-shadow-root">shadow root</dfn> is the <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of a shadow tree.</p>

        <p>If more than one <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> is <a title="hosts" href="#dfn-hosts" class="internalDFN">hosted</a> by the same <a href="#dfn-shadow-host" class="internalDFN">shadow host</a>, the more recently added <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> is called the <dfn id="dfn-younger-shadow-tree">younger shadow tree</dfn> and the less recently added <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> is called the <dfn id="dfn-older-shadow-tree">older shadow tree</dfn>.</p>

        <p>If there is no <a href="#dfn-older-shadow-tree" class="internalDFN">older shadow tree</a> than a given <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>,
          the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> is called the <dfn id="dfn-oldest-shadow-tree">oldest shadow tree</dfn>.</p>

        <p>If there is no <a href="#dfn-younger-shadow-tree" class="internalDFN">younger shadow tree</a> than a given <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>,
          the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> is called the <dfn id="dfn-youngest-shadow-tree">youngest shadow tree</dfn>.</p>

        <p>The <dfn id="dfn-older-shadow-root">older shadow root</dfn> is the root node of the <a href="#dfn-older-shadow-tree" class="internalDFN">older shadow tree</a>.</p>

        <p>The <dfn id="dfn-younger-shadow-root">younger shadow root</dfn> is the root node of the <a href="#dfn-younger-shadow-tree" class="internalDFN">younger shadow tree</a>.</p>

        <p>The <dfn id="dfn-oldest-shadow-root">oldest shadow root</dfn> is the root node of the <a href="#dfn-oldest-shadow-tree" class="internalDFN">oldest shadow tree</a>.</p>

        <p>The <dfn id="dfn-youngest-shadow-root">youngest shadow root</dfn> is the root node of the <a href="#dfn-youngest-shadow-tree" class="internalDFN">youngest shadow tree</a>.</p>

        <div class="note"><div class="note-title" aria-level="3" role="heading" id="h_note_1"><span>Note</span></div><p class="">
          For convenience, the <a href="#dfn-shadow-root" class="internalDFN">shadow root</a> provides its own set of <a title="DOM tree accessors" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-tree-accessors" class="externalDFN">DOM tree accessor</a> methods.
          No <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> other than the <a href="#dfn-shadow-root" class="internalDFN">shadow root</a> descendants are accessible with these methods.
        </p></div>
      </section>

      <section id="trees-of-trees">
        <h3 aria-level="2" role="heading" id="h3_trees-of-trees"><span class="secno">2.3 </span>Trees of trees</h3>

        <p>A <dfn id="dfn-tree-of-trees">tree of trees</dfn> is a <a href="http://dom.spec.whatwg.org/#trees" class="externalDFN">tree</a> of <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a>.</p>

        <div class="note"><div class="note-title" aria-level="3" role="heading" id="h_note_2"><span>Note</span></div><p class="">
          The purpose of introducing a tree of trees here is to define algorithms easily in the following sections.
          This is a kind of a notation techchique to make the this specification simpler.
        </p></div>

        <p>Just like a <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> is defined as <a title="tree" href="http://dom.spec.whatwg.org/#trees" class="externalDFN">a set of relationships</a> between <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a>,
          a <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a> is similarly defined as a set of relationships between <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a>:</p>
        <ul>
          <li>
            A <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> <var>A</var> is called a <dfn id="dfn-parent-tree">parent tree</dfn> of a <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> <var>B</var> if either of the following conditions is satisfied:
            <ul>
              <li><var>A</var> and <var>B</var> are next to each other in the same <a title="shadow roots list" href="#dfn-shadow-roots-list" class="internalDFN">associated ordered list</a> and <var>A</var> is the <a href="#dfn-older-shadow-tree" class="internalDFN">older shadow tree</a> relative to <var>B</var>.</li>
              <li><var>B</var> is the <a href="#dfn-oldest-shadow-tree" class="internalDFN">oldest shadow tree</a> and <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> of <var>B</var> participates in <var>A</var>.</li>
            </ul>

          </li>
          <li>If there is more than one <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> that shares the same <a href="#dfn-parent-tree" class="internalDFN">parent tree</a>, the <a href="http://dom.spec.whatwg.org/#concept-tree-order" class="externalDFN">tree order</a> between them in the <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a> is defined as follows:
            <ol>
              <li>Let <var>A</var> and <var>B</var> be <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a> that share the same <a href="#dfn-parent-tree" class="internalDFN">parent tree</a>.</li>
              <li><var>A</var> comes before <var>B</var> if either of the following conditions is satisfied:
                <ul>
                  <li>The <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> which <a href="#dfn-hosts" class="internalDFN">hosts</a> <var>A</var> is <a href="http://dom.spec.whatwg.org/#concept-tree-preceding" class="externalDFN">preceding</a> the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> which <a href="#dfn-hosts" class="internalDFN">hosts</a> <var>B</var>.</li>
                  <li><var>B</var> is not the <a href="#dfn-oldest-shadow-tree" class="internalDFN">oldest shadow tree</a>.</li>
                </ul>
              </li>
            </ol>
          </li>
          <li>Other relationships and terms, such as <dfn id="dfn-root-tree">root tree</dfn>, <dfn id="dfn-child-tree">child tree</dfn>,
            <dfn id="dfn-descendant-tree">descendant tree</dfn>, <dfn id="dfn-inclusive-descendant-tree">inclusive descendant tree</dfn>,
            <dfn id="dfn-ancestor-tree">ancestor tree</dfn>, <dfn id="dfn-inclusive-ancestor-tree">inclusive ancestor tree</dfn>,
            <dfn id="dfn-preceding-tree">preceding tree</dfn>
            are defined in the similar way as defined in <a title="tree" href="http://dom.spec.whatwg.org/#trees" class="externalDFN">trees</a>.</li>
        </ul>

        <p>The <a href="http://dom.spec.whatwg.org/#dom-node-ownerdocument" class="externalDFN"><code>ownerDocument</code></a> property of a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> in a shadow tree <strong>must</strong> refers to the <a href="http://dom.spec.whatwg.org/#concept-document" class="externalDFN">document</a> of the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> which <a href="#dfn-hosts" class="internalDFN">hosts</a> the shadow tree.</p>

        <p><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#window" class="externalDFN"><code>Window</code></a> object <a title="named access on the window object" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#named-access-on-the-window-object" class="externalDFN">named properties</a> [<cite><a class="bibref" href="#bib-HTML">HTML</a></cite>] <strong>must</strong> access the <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> in the <a href="#dfn-document-tree" class="internalDFN">document tree</a>.</p>

        <section class="informative" id="example-tree-of-trees">
          <h4 aria-level="3" role="heading" id="h4_example-tree-of-trees"><span class="secno">2.3.1 </span>Example tree of trees</h4><p><em>This section is non-normative.</em></p>

          <figure id="fig-a-tree-of-trees.x">
            <object data="tree-of-trees.svg" width="650" height="823"></object>
            <figcaption>Fig. <span class="figno">1</span> <span class="fig-title">
              A tree of trees.
            </span></figcaption>
          </figure>

          <p>
            In the figure, there are seven node trees, named A, B, C, D, E and F.
            The node trees, C, D and E, are hosted by the same <a href="#dfn-shadow-host" class="internalDFN">shadow host</a>, which participates in the node tree A.
            The node tree C is the <a href="#dfn-oldest-shadow-tree" class="internalDFN">oldest shadow tree</a>. The node tree E is the <a href="#dfn-youngest-shadow-tree" class="internalDFN">youngest shadow tree</a>.
            The following set of relationships holds in the figure:
            </p><ul>
              <li>The ordered list of A's <a title="child tree" href="#dfn-child-tree" class="internalDFN">child trees</a> is [B, C].</li>
              <li>The ordered list of B's <a title="child tree" href="#dfn-child-tree" class="internalDFN">child trees</a> is [].</li>
              <li>The ordered list of C's <a title="child tree" href="#dfn-child-tree" class="internalDFN">child trees</a> is [F, D].</li>
              <li>The ordered list of D's <a title="child tree" href="#dfn-child-tree" class="internalDFN">child trees</a> is [E].</li>
              <li>The ordered list of E's <a title="child tree" href="#dfn-child-tree" class="internalDFN">child trees</a> is [].</li>
            </ul>
          <p></p>
        </section>

      </section>

      <section id="composed-trees">
        <h3 aria-level="2" role="heading" id="h3_composed-trees"><span class="secno">2.4 </span>Composed trees</h3>

        <p>A <dfn id="dfn-composed-tree">composed tree</dfn> is a <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> which is constructed out of <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> from multiple <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a> in a <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a>.
          The exact algorithm of constructing a composed tree is specified later.</p>

        <figure id="fig-a-composed-tree">
          <object data="composed-tree.svg" width="654" height="606"></object>
          <figcaption>Fig. <span class="figno">2</span> <span class="fig-title">A composed tree</span></figcaption>
        </figure>

        <p>In <dfn id="dfn-rendering">rendering</dfn> a <a href="#dfn-document-tree" class="internalDFN">document tree</a>, or presenting it visually, the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a> <strong>must</strong> be used instead of the <a href="#dfn-document-tree" class="internalDFN">document tree</a>.</p>

        <p>The <a href="#dfn-composed-tree" class="internalDFN">composed tree</a> <strong>must</strong> be updated before the <a href="#dfn-rendering" class="internalDFN">rendering</a> occurs.</p>
      </section>

    </section>

    <section id="distributions">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_distributions"><span class="secno">3. </span>Distributions</h2>

      <section id="insertion-points">
        <h3 aria-level="2" role="heading" id="h3_insertion-points"><span class="secno">3.1 </span>Insertion Points</h3>

        <p>An <dfn id="dfn-insertion-point">insertion point</dfn> is a defined location where <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> in a different <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> appear instead of the nodes's original position when constructing a <a href="#dfn-composed-tree" class="internalDFN">composed tree</a>.</p>

        <figure id="fig-a-distribution">
          <object data="distributions.svg" width="663" height="598"></object>
          <figcaption>Fig. <span class="figno">3</span> <span class="fig-title">A distribution</span></figcaption>
        </figure>

        <p>A <dfn id="dfn-distribution">distribution</dfn> is the mechanism that determines which <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> appear at each <a href="#dfn-insertion-point" class="internalDFN">insertion point</a>. The exact algorithm of a <a href="#dfn-distribution" class="internalDFN">distribution</a> is specified later.</p>
      </section>


      <section id="content-insertion-points">
        <h3 aria-level="2" role="heading" id="h3_content-insertion-points"><span class="secno">3.2 </span>Content Insertion Points</h3>

        <p>A <dfn id="dfn-content-insertion-point">content insertion point</dfn> is an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> to where the child <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> of the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> are distributed.
          The <a href="#dfn-content-element" class="internalDFN">content element</a> that satisfies all of the following conditions represents a <a href="#dfn-content-insertion-point" class="internalDFN">content insertion point</a>:</p>
        <ul>
          <li>The <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of the <a href="#dfn-content-element" class="internalDFN">content element</a> is a <a href="#dfn-shadow-root" class="internalDFN">shadow root</a></li>
          <li>There is no other <a href="#dfn-content-element" class="internalDFN">content element</a> in the <a title="ancestor" href="http://dom.spec.whatwg.org/#concept-tree-ancestor" class="externalDFN">ancestors</a> of the <a href="#dfn-content-element" class="internalDFN">content element</a></li>
          <li>There is no <a href="#dfn-shadow-element" class="internalDFN">shadow element</a> in the <a title="ancestor" href="http://dom.spec.whatwg.org/#concept-tree-ancestor" class="externalDFN">ancestors</a> of the <a href="#dfn-content-element" class="internalDFN">content element</a></li>
        </ul>
      </section>

      <section id="shadow-insertion-points">
        <h3 aria-level="2" role="heading" id="h3_shadow-insertion-points"><span class="secno">3.3 </span>Shadow Insertion Points</h3>

        <p>A <dfn id="dfn-shadow-insertion-point">shadow insertion point</dfn> is an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> to where the children of the <a href="#dfn-older-shadow-root" class="internalDFN">older shadow root</a> are distributed.
          The <a href="#dfn-shadow-element" class="internalDFN">shadow element</a> that satisfies of the following conditions represents a <a href="#dfn-shadow-insertion-point" class="internalDFN">shadow insertion point</a>:</p>
        <ul>
          <li>The <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of the <a href="#dfn-shadow-element" class="internalDFN">shadow element</a> is a <a href="#dfn-shadow-root" class="internalDFN">shadow root</a></li>
          <li>There is no other <a href="#dfn-shadow-element" class="internalDFN">shadow element</a> which is <a href="http://dom.spec.whatwg.org/#concept-tree-preceding" class="externalDFN">preceding</a> the <a href="#dfn-shadow-element" class="internalDFN">shadow element</a></li>
          <li>There is no other <a href="#dfn-content-element" class="internalDFN">content element</a> in the <a title="ancestor" href="http://dom.spec.whatwg.org/#concept-tree-ancestor" class="externalDFN">ancestors</a> of the <a href="#dfn-shadow-element" class="internalDFN">shadow element</a></li>
        </ul>
      </section>

      <section id="distribution-results">
        <h3 aria-level="2" role="heading" id="h3_distribution-results"><span class="secno">3.4 </span>Distribution Results</h3>

        <p>Each <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a> has the <dfn id="dfn-distribution-result">distribution result</dfn> which describes the result of distributions.
          The <a href="#dfn-distribution-result" class="internalDFN">distribution result</a> <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> of the following:</p>
        <ol>
          <li>Each <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> has an ordered list, called <dfn id="dfn-distributed-nodes">distributed nodes</dfn>, which consists of <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> which are distributed into the <a href="#dfn-insertion-point" class="internalDFN">insertion point</a>.</li>
          <li>Each <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> that is not an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> has an ordered list, called <dfn id="dfn-destination-insertion-points">destination insertion points</dfn>, which consists of <a title="insertion point" href="#dfn-insertion-point" class="internalDFN">insertion points</a> to where the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> is distributed</li>
        </ol>

        <p>An <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> <var>A</var> is the <dfn id="dfn-final-destination">final destination</dfn> of a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> <var>B</var> if <var>A</var> is the last item of the <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of <var>B</var>.</p>

        <p>When a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> <var>A</var> is <dfn title="distributes" id="dfn-distributes">distributed</dfn> into an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> <var>B</var>, the following steps <strong>must</strong> happen:</p>
        <ul>
          <li>Add <var>A</var> to the <a href="#dfn-distributed-nodes" class="internalDFN">distributed nodes</a> of <var>B</var></li>
          <li>Add <var>B</var> to the <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of <var>A</var></li>
        </ul>

        <div class="note"><div class="note-title" aria-level="3" role="heading" id="h_note_3"><span>Note</span></div><div class="">
          <p>One case that deserves special consideration is the situation when an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> is a child <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of another <a href="#dfn-shadow-host" class="internalDFN">shadow host</a>. In such situations, the <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> <a title="distributes" href="#dfn-distributes" class="internalDFN">distributed</a> into that <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> appear as if they were child <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> of the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> in the context of <a href="#dfn-distribution" class="internalDFN">distribution</a>. Thus, the <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> <a title="distributes" href="#dfn-distributes" class="internalDFN">distributed</a> to a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> could have already been <a title="distributes" href="#dfn-distributes" class="internalDFN">distributed</a> from its parent tree.</p>

          <p>Despite being distributed to more than one insertion point, a node still only appears once in the composed tree at the final destination.</p>
        </div></div>

        <figure id="fig-a-re-distribution.-in-the-figure-a-node-child-1-is-distributed-into-insertion-point-1.-then-child1-is-re-distributed-into-insertion-point-3.-the-destination-insertion-points-of-child-1-is-insertion-point-1-insertion-point-3-and-insertion-point-3-is-the-final-destination-of-child-1.-the-distributed-nodes-of-insertion-point-1-and-insertion-point-3-is-child-1-and-child-1-child-3-respectively.x">
          <object data="re-distributions.svg" width="693" height="822"></object>
          <figcaption>Fig. <span class="figno">4</span> <span class="fig-title">A re-distribution.
            In the figure, a node <em>child 1</em> is distributed into <em>insertion point 1</em>. Then <em>child1</em> is re-distributed into <em>insertion point 3</em>.
            The destination insertion points of <em>child 1</em> is [<em>insertion point 1</em>, <em>insertion point 3</em>] and <em>insertion point 3</em> is the final destination of <em>child 1</em>.
            The distributed nodes of <em>insertion point 1</em> and <em>insertion point 3</em> is [<em>child 1</em>] and [<em>child 1</em>, <em>child 3</em>], respectively.
          </span></figcaption>
        </figure>

      </section>

      <section id="distribution-algorithms">
        <h3 aria-level="2" role="heading" id="h3_distribution-algorithms"><span class="secno">3.5 </span>Distribution Algorithms</h3>

        <p>The <dfn id="dfn-distribution-algorithm">distribution algorithm</dfn> <strong>must</strong> be used to determine the <a href="#dfn-distribution-result" class="internalDFN">distribution result</a> for a <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a> and <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>TREE-OF-TREES</var>, a <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a></dd>
            <dt>Output</dt>
            <dd>The <a href="#dfn-distribution-result" class="internalDFN">distribution result</a> of <var>TREE-OF-TREES</var> is updated</dd>
          </dl>
          <ol>
            <li>Let all <a href="#dfn-distributed-nodes" class="internalDFN">distributed nodes</a> and <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> owned by <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> in <var>TREE-OF-TREES</var> be empty</li>
            <li>Let <var>ROOT-TREE</var> be the <a href="#dfn-root-tree" class="internalDFN">root tree</a> of <var>TREE-OF-TREES</var></li>
            <li>Run the <a href="#dfn-distribution-resolution-algorithm" class="internalDFN">distribution resolution algorithm</a> with <var>ROOT-TREE</var> as input</li>
          </ol>
        </div>

        <p>The <dfn id="dfn-distribution-resolution-algorithm">distribution resolution algorithm</dfn> <strong>must</strong> be used to determine the <a href="#dfn-distribution-result" class="internalDFN">distribution result</a> for a given <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> and its <a title="descendant tree" href="#dfn-descendant-tree" class="internalDFN">descendant trees</a>, and <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>NODE-TREE</var>, a <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a></dd>
            <dt>Output</dt>
            <dd>The <a href="#dfn-distribution-result" class="internalDFN">distribution result</a> is updated for the <a title="inclusive descendant tree" href="#dfn-inclusive-descendant-tree" class="internalDFN">inclusive descendant trees</a> of <var>NODE-TREE</var></dd>
          </dl>

          <ol>
            <li>For each <a href="#dfn-shadow-host" class="internalDFN">shadow host</a>, <var>SHADOW-HOST</var>, which participates in <var>NODE-TREE</var>, in <a href="http://dom.spec.whatwg.org/#concept-tree-order" class="externalDFN">tree order</a>:
              <ol>
                <li>Let <var>POOL</var> be the result of the <a href="#dfn-pool-population-algorithm" class="internalDFN">pool population algorithm</a> with <var>SHADOW-HOST</var> as input</li>
                <li>For each <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>, <var>SHADOW-TREE</var>, which <var>SHADOW-HOST</var> <a href="#dfn-hosts" class="internalDFN">hosts</a>, in order from the <a href="#dfn-youngest-shadow-tree" class="internalDFN">youngest shadow tree</a> to the <a href="#dfn-oldest-shadow-tree" class="internalDFN">oldest shadow tree</a>:
                  <ol>
                    <li>Run the <a href="#dfn-pool-distribution-algorithm" class="internalDFN">pool distribution algorithm</a> with <var>SHADOW-TREE</var> and <var>POOL</var> as input</li>
                  </ol></li>
                <li>For each <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>, <var>SHADOW-TREE</var>, that <var>SHADOW-HOST</var> <a href="#dfn-hosts" class="internalDFN">hosts</a>, in order from the <a href="#dfn-oldest-shadow-tree" class="internalDFN">oldest shadow tree</a> to the <a href="#dfn-youngest-shadow-tree" class="internalDFN">youngest shadow tree</a>:
                  <ol>
                    <li>Let <var>SHADOW</var> be the <a href="#dfn-shadow-insertion-point" class="internalDFN">shadow insertion point</a> which participates in <var>SHADOW-TREE</var></li>
                    <li>If such a <var>SHADOW</var> exits:
                      <ol>
                        <li>If <var>SHADOW-TREE</var> is not the <a href="#dfn-oldest-shadow-tree" class="internalDFN">oldest shadow tree</a>:
                          <ol>
                            <li>Let <var>POOL</var> be the result of the <a href="#dfn-pool-population-algorithm" class="internalDFN">pool population algorithm</a> with the root node of the <a href="#dfn-older-shadow-tree" class="internalDFN">older shadow tree</a> relative to <var>SHADOW-TREE</var> as input.</li>
                          </ol></li>
                        <li>For each <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a>, <var>CHILD</var>, in <var>POOL</var>
                          <ol>
                            <li><a title="distributes" href="#dfn-distributes" class="internalDFN">Distribute</a> <var>CHILD</var> into <var>SHADOW</var></li>
                          </ol></li>
                      </ol></li>
                    <li>Run the <a href="#dfn-distribution-resolution-algorithm" class="internalDFN">distribution resolution algorithm</a>, recursively, with <var>SHADOW-TREE</var> as input</li>
                  </ol></li>
              </ol></li>
          </ol>
        </div>

        <p>The <dfn id="dfn-pool-population-algorithm">pool population algorithm</dfn> <strong>must</strong> be used to populate <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> from the child <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> of a given <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> and <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>NODE</var>, a node</dd>
            <dt>Output</dt>
            <dd><var>POOL</var>, an ordered list of nodes</dd>
          </dl>

          <ol>
            <li>Let <var>POOL</var> be an empty ordered list.</li>
            <li>For each child <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a>, <var>CHILD</var>, of <var>NODE</var>:
              <ol>
                <li>If <var>CHILD</var> is an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a>:
                  <ol>
                    <li>Add all <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> in the <a href="#dfn-distributed-nodes" class="internalDFN">distributed nodes</a> of <var>CHILD</var> to <var>POOL</var></li>
                  </ol></li>
                <li>Otherwise:
                  <ol>
                    <li>Add <var>CHILD</var> to <var>POOL</var></li>
                  </ol></li>
              </ol></li>
          </ol>
        </div>

        <p>The <dfn id="dfn-pool-distribution-algorithm">pool distribution algorithm</dfn> <strong>must</strong> be used to distribute <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> in a pool into the <a title="content insertion point" href="#dfn-content-insertion-point" class="internalDFN">content insertion points</a> in a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> and <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>SHADOW-TREE</var>, a shadow tree</dd>
            <dd><var>POOL</var>, an ordered list of nodes</dd>
            <dt>Output</dt>
            <dd>Nodes in POOL are distributed into the content insertion points in the tree.</dd>
          </dl>

          <ol>
            <li>For each <a href="#dfn-content-insertion-point" class="internalDFN">content insertion point</a>, <var>CONTENT</var>, which participates in <var>SHADOW-TREE</var>, in tree order:
              <ol>
                <li>For each <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a>, <var>NODE</var>, in <var>POOL</var>
                  <ol>
                    <li>If <var>NODE</var> satisfies <var>CONTENT</var>'s matching criteria:
                      <ol>
                        <li><a title="distributes" href="#dfn-distributes" class="internalDFN">Distribute</a> <var>NODE</var> into <var>CONTENT</var></li>
                        <li>Remove <var>NODE</var> from <var>POOL</var></li>
                      </ol></li>
                  </ol></li>
                <li>If no <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> are distributed to <var>CONTENT</var>:
                  <ol>
                    <li>For each child, <var>CHILD</var>, of <var>CONTENT</var>
                      <ol>
                        <li><a title="distributes" href="#dfn-distributes" class="internalDFN">Distribute</a> <var>CHILD</var> into <var>CONTENT</var></li>
                      </ol></li>
                  </ol></li>
              </ol></li>
          </ol>

        </div>

        <div class="note"><div class="note-title" aria-level="3" role="heading" id="h_note_4"><span>Note</span></div><p class="">If no nodes are distributed into a <a href="#dfn-content-insertion-point" class="internalDFN">content insertion point</a> <var>CONTENT</var>, the child <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> of <var>CONTENT</var> are distributed into <var>CONTENT</var> as fallback nodes.</p></div>

        <p>If any condition which affects the <a href="#dfn-distribution-result" class="internalDFN">distribution result</a> changes, the <a href="#dfn-distribution-result" class="internalDFN">distribution result</a> <strong>must</strong> be updated before any use of the <a href="#dfn-distribution-result" class="internalDFN">distribution result</a>.</p>

      </section>

      <section id="satisfying-matching-criteria">
        <h3 aria-level="2" role="heading" id="h3_satisfying-matching-criteria"><span class="secno">3.6 </span>Satisfying Matching Criteria</h3>

        <p>The <dfn id="dfn-matching-criteria">matching criteria</dfn> for an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> is a set of <a title="compound selector" href="http://dev.w3.org/csswg/selectors4/#compound" class="externalDFN">compound selectors</a> [<cite><a class="bibref" href="#bib-SELECTORS4">SELECTORS4</a></cite>]. These <a title="compound selector" href="http://dev.w3.org/csswg/selectors4/#compound" class="externalDFN">compound selectors</a> are restricted to contain only these <a title="simple selector" href="http://dev.w3.org/csswg/selectors4/#simple" class="externalDFN">simple selectors</a>:</p>

        <ul>
          <li>A <a href="http://dev.w3.org/csswg/selectors4/#type-selector" class="externalDFN">type selector</a> or a <a href="http://dev.w3.org/csswg/selectors4/#universal-selector" class="externalDFN">universal selector</a></li>
          <li><a title="class selector" href="http://dev.w3.org/csswg/selectors4/#class-selector" class="externalDFN">class selector(s)</a></li>
          <li>An <a href="http://dev.w3.org/csswg/selectors4/#id-selector" class="externalDFN">ID selector</a></li>
          <li><a title="attribute selector" href="http://dev.w3.org/csswg/selectors4/#attribute-selector" class="externalDFN">attribute selector(s)</a></li>
          <li>A <a href="http://dev.w3.org/csswg/selectors4/#negation" class="externalDFN">negation pseudo-class</a>, <code>:not()</code></li>
        </ul>

        <p>A <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> <dfn title="satisfies-matching-criteria" id="dfn-satisfies-matching-criteria">satisfies</dfn> a <a href="#dfn-matching-criteria" class="internalDFN">matching criteria</a> only if:</p>
        <ol>
          <li>all <a title="compound selector" href="http://dev.w3.org/csswg/selectors4/#compound" class="externalDFN">compound selectors</a> in the set, contain only the <a title="simple selector" href="http://dev.w3.org/csswg/selectors4/#simple" class="externalDFN">simple selectors</a> specified above; and</li>
          <li>a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> matches at least one <a title="compound selector" href="http://dev.w3.org/csswg/selectors4/#compound" class="externalDFN">compound selectors</a> in the set or the set is empty.</li>
        </ol>
      </section>

    </section>

    <section id="composition">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_composition"><span class="secno">4. </span>Composition</h2>

      <p>The <dfn id="dfn-composed-tree-children-calculation-algorithm">composed tree children calculation algorithm</dfn> <strong>must</strong> be used to determine the child <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> of a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> in the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a> and <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to processing the following steps:</p>

      <div class="algorithm">
        <dl>
          <dt>Input</dt>
          <dd><var>NODE</var>, a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> which participates in a composed tree</dd>
          <dt>Output</dt>
          <dd><var>CHILDREN</var>, the child nodes of <var>NODE</var> in the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a>.</dd>
        </dl>

        <ol>
          <li>Let <var>CHILDREN</var> be an empty ordered list of nodes</li>
          <li>If <var>NODE</var> is a <a href="#dfn-shadow-host" class="internalDFN">shadow host</a>:
            <ol>
              <li>Let <var>CHILD-POOL</var> be the children of the <a href="#dfn-youngest-shadow-root" class="internalDFN">youngest shadow root</a> which <var>NODE</var> <a href="#dfn-hosts" class="internalDFN">hosts</a>.</li>
            </ol></li>
          <li>Otherwise:
            <ol>
              <li>Let <var>CHILD-POOL</var> be the child <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> of NODE</li>
            </ol></li>
          <li>For each <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a>, <var>CHILD</var>, in <var>CHILD-POOL</var>:
            <ol>
              <li>If <var>CHILD</var> is an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a>:
                <ol>
                  <li>For each <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a>, <var>DISTRIBUTED-NODE</var>, in the <a href="#dfn-distributed-nodes" class="internalDFN">distributed nodes</a> of the <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> <var>CHILD</var>:
                    <ol>
                      <li>If <var>CHILD</var> is the <a href="#dfn-final-destination" class="internalDFN">final destination</a> of <var>DISTRIBUTED-NODE</var>, add <var>DISTRIBUTED-NODE</var> to <var>CHILDREN</var></li>
                    </ol></li>
                </ol></li>
              <li>Otherwise:
                <ol>
                  <li>Add <var>CHILD</var> to <var>CHILDREN</var></li>
                </ol></li>
            </ol></li>
        </ol>

      </div>

      <p>For a given <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a> <var>TREE-OF-TREES</var>, the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a> constructed from <var>TREE-OF-TREES</var> <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to the following tree:</p>
      <ul>
        <li>The <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a> is the <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of the <a href="#dfn-root-tree" class="internalDFN">root tree</a> of <var>TREE-OF-TREES</var>.</li>
        <li>For a given <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> which <a href="http://dom.spec.whatwg.org/#concept-tree-participate" class="externalDFN">participates</a> in the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a>, the child <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> of the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> is the result of the <a href="#dfn-composed-tree-children-calculation-algorithm" class="internalDFN">composed tree children calculation algorithm</a> with the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> as input.
        </li>
      </ul>
    </section>

    <section id="events">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_events"><span class="secno">5. </span>Events</h2>

      <p>When an <a href="http://dom.spec.whatwg.org/#events" class="externalDFN">event</a> is <a title="event dispatch" href="http://dom.spec.whatwg.org/#concept-event-dispatch" class="externalDFN">dispatched</a> in a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>, its path either crosses the <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a> or is terminated at the <a href="#dfn-shadow-root" class="internalDFN">shadow root</a>. One exception are the <a title="mutation event" href="http://www.w3.org/TR/DOM-Level-3-Events/#interface-MutationEvent" class="externalDFN">mutation events</a>. The <a title="mutation event" href="http://www.w3.org/TR/DOM-Level-3-Events/#interface-MutationEvent" class="externalDFN">mutation event types</a> <strong>must</strong> never be dispatched in a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>

      <section id="events-that-are-always-stopped">
        <h3 aria-level="2" role="heading" id="h3_events-that-are-always-stopped"><span class="secno">5.1 </span>Events that are Always Stopped</h3>

        <p>The <dfn title="events-always-stopped" id="dfn-events-always-stopped">following events</dfn> <strong>must</strong> always be stopped at the <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a>:</p>
        <ul>
          <li><code>abort</code></li>
          <li><code>error</code></li>
          <li><code>select</code></li>
          <li><code>change</code></li>
          <li><code>load</code></li>
          <li><code>reset</code></li>
          <li><code>resize</code></li>
          <li><code>scroll</code></li>
          <li><code>selectstart</code></li>
        </ul>
      </section>

      <section id="event-paths">
        <h3 aria-level="2" role="heading" id="h3_event-paths"><span class="secno">5.2 </span>Event Paths</h3>

        <p>The <dfn id="dfn-event-path-calculation-algorithm">event path calculation algorithm</dfn> must be used to determine event path and <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>NODE</var>, a node</dd>
            <dd><var>EVENT</var>, an event</dd>
            <dt>Output</dt>
            <dd><var>PATH</var>, an event path, a ordered list of an event target</dd>
          </dl>
          <ol>
            <li>Let <var>PATH</var> be the empty ordered list of nodes</li>
            <li>Let <var>CURRENT</var> be <var>NODE</var></li>
            <li>Add <var>CURRENT</var> to <var>PATH</var></li>
            <li>Repeat while <var>CURRENT</var> exists:
              <ol>
                <li>If the <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of <var>CURRENT</var> is not empty:
                  <ol>
                    <li>For each <a href="#dfn-insertion-point" class="internalDFN">insertion point</a>, <var>INSERTION-POINT</var>, in the <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of <var>CURRENT</var>:
                      <ol>
                        <li>If <var>INSERTION-POINT</var> is a <a href="#dfn-shadow-insertion-point" class="internalDFN">shadow insertion point</a>:
                          <ol>
                            <li>Let <var>SHADOW-ROOT</var> be the <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of <var>INSERTION-POINT</var></li>
                            <li>If <var>SHADOW-ROOT</var> is not the <a href="#dfn-oldest-shadow-root" class="internalDFN">oldest shadow root</a>:
                              <ol>
                                <li>Add the <a href="#dfn-older-shadow-root" class="internalDFN">older shadow root</a> relative to <var>SHADOW-ROOT</var> to <var>PATH</var></li>
                              </ol></li>
                          </ol></li>
                        <li>Add <var>INSERTION-POINT</var> to <var>PATH</var></li>
                      </ol></li>
                    <li>Let <var>CURRENT</var> be the <a href="#dfn-final-destination" class="internalDFN">final destination</a> of <var>CURRENT</var></li>
                  </ol></li>
                <li>Otherwise:
                  <ol>
                    <li>If <var>CURRENT</var> is a <a href="#dfn-shadow-root" class="internalDFN">shadow root</a>:
                      <ol>
                        <li>If <var>NODE</var> and <var>CURRENT</var> are in the same <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> and <var>EVENT</var> is one of the <a title="events-always-stopped" href="#dfn-events-always-stopped" class="internalDFN">events which must be stopped</a>:
                          <ol>
                            <li>Stop this algorithm</li>
                          </ol></li>
                        <li>Let <var>CURRENT</var> be the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> which <a href="#dfn-hosts" class="internalDFN">hosts</a> <var>CURRENT</var></li>
                        <li>Add <var>CURRENT</var> to <var>PATH</var></li>
                      </ol></li>
                    <li>Otherwise:
                      <ol>
                        <li>Let <var>CURRENT</var> be the <a href="http://dom.spec.whatwg.org/#concept-tree-parent" class="externalDFN">parent</a> <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> of <var>CURRENT</var></li>
                        <li>If <var>CURRENT</var> exists:
                          <ol>
                            <li>Add <var>CURRENT</var> to <var>PATH</var></li>
                          </ol></li>
                      </ol></li>
                  </ol></li>
              </ol></li>
          </ol>
        </div>

      </section>

      <section class="informative" id="event-paths-example">
        <h3 aria-level="2" role="heading" id="h3_event-paths-example"><span class="secno">5.3 </span>Event Paths Example</h3><p><em>This section is non-normative.</em></p>

        <p>
          Suppose we have the following tree of trees:
        </p>

        <figure id="fig-an-example-tree-of-trees.-nodes-which-are-not-involved-in-the-example-event-path-which-is-explained-later-are-omitted.x">
          <object data="event-path-tree-of-trees.svg" width="301" height="1074"></object>
          <figcaption>Fig. <span class="figno">5</span> <span class="fig-title">An example tree of trees. Nodes which are not involved in the example event path, which is explained later, are omitted.</span></figcaption>
        </figure>

        <ul>
          <li>
            <code>A</code> is a <a href="http://dom.spec.whatwg.org/#concept-document" class="externalDFN">document</a>.
          </li>
          <li>
            <code>E</code>, <code>J</code>, <code>N</code>, <code>Q</code>, <code>S</code> and <code>V</code> are <a title="shadow root" href="#dfn-shadow-root" class="internalDFN">shadow roots</a>.
          </li>
          <li>
            <code>I</code>, <code>M</code>, <code>P</code>, <code>R</code> and <code>U</code> are <a title="content insertion point" href="#dfn-content-insertion-point" class="internalDFN">content insertion points</a>.
          </li>
          <li>
            <code>X</code> is a <a href="#dfn-shadow-insertion-point" class="internalDFN">shadow insertion point</a>.
          </li>
        </ul>

        <p>
          This <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a> has the following seven <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a>, one <a href="#dfn-document-tree" class="internalDFN">document tree</a> and six <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a>:
        </p>

        <ul>
          <li>
            The <var>document tree 1</var>. Node <code>A</code>, <code>B</code>, <code>C</code> and <code>D</code> participate in that.
          </li>
          <li>
            The <var>shadow tree 2</var> hosted by <code>B</code>. Node <code>E</code>, <code>F</code>, <code>G</code>, <code>H</code> and <code>I</code> participate in that.
          </li>
          <li>
            The <var>shadow tree 3</var> hosted by <code>H</code>. Node <code>J</code>, <code>K</code>, <code>L</code> and <code>M</code> participate in that.
          </li>
          <li>
            The <var>shadow tree 4</var> hosted by <code>K</code>. Node <code>N</code>, <code>O</code> and <code>P</code> participate in that.
          </li>
          <li>
            The <var>shadow tree 5</var> hosted by <code>O</code>. Node <code>Q</code> and <code>R</code> participate in that.
          </li>
          <li>
            The <var>shadow tree 6</var> hosted by <code>F</code>. Node <code>S</code>, <code>T</code> and <code>U</code> participate in that.
          </li>
          <li>
            The <var>shadow tree 7</var> hosted by <code>B</code>. Node <code>V</code>, <code>W</code> and <code>X</code> participate in that.
            This <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> is younger than the <var>shadow tree 2</var>.
          </li>
        </ul>

        <p>
          Let's assume that the <a href="#dfn-distribution-result" class="internalDFN">distribution result</a> of this <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a> is:
        </p>

        <ul>
          <li>
            The <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of <code>C</code> are <code>[I, M]</code> (<code>C</code> is re-distributed)
          </li>
          <li>
            The <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of <code>L</code> are <code>[P, R]</code> (<code>L</code> is re-distributed)
          </li>
          <li>
            The <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of <code>G</code> are <code>[U]</code>
          </li>
          <li>
            The <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of <code>F</code> are <code>[X]</code>
          </li>
        </ul>

        <p>
          In this case, if an event is dispatched on node <code>D</code>, the event path will be:
        </p>
        <p>
          <code>
            [D, C, I, M, L, P, R, Q, O, N, K, J, H, G, U, T, S, F, E, X, W, V, B, A]
          </code>
        </p>

        <p>
          Note that the <a href="#dfn-event-path-calculation-algorithm" class="internalDFN">event path calculation algorithm</a> is designed to achieve the following goals:
        </p>

        <ol>
          <li>
            If there is a node, <var>CHILD</var>, in the event path and <var>CHILD</var> has a parent node, <var>PARENT</var>, in the node tree, the event path also includes <var>PARENT</var>.
            <var>PARENT</var> always appears somewhere after <var>CHILD</var> in the event path.
          </li>
          <li>
            Nodes in the event path form a <em>linear ancestor chain</em> in each <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a>. There are no <em>branch points</em> in each <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a>.
          </li>
        </ol>

        <figure id="fig-the-relationship-between-an-event-path-and-node-trees.-in-the-figure-a-number-shown-in-a-left-side-of-each-node-represents-a-zero-based-position-of-each-node-in-the-event-path.-a-parent-node-always-have-a-larger-number-than-that-of-its-child-node-in-each-node-tree.x">
          <object data="event-path-node-trees.svg" width="884" height="473">&gt;</object>
          <figcaption>Fig. <span class="figno">6</span> <span class="fig-title">
            The relationship between an event path and node trees. In the figure, a number shown in a left-side of each node represents a zero-based position of each node in the event path.
            A parent node always have a larger number than that of its child node in each node tree.
          </span></figcaption>
        </figure>

        <p>
          That means if we focus on one <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> and forget all other <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a>,
          the event path would be seen as if the event happened only on the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> which we are focused on.
          This is an important aspect in a sense that hosting shadow trees doesn't have any effect to the event path <em>within</em> the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> participate in
          as long as the event is not stopped somewhere in the <a title="descendant tree" href="#dfn-descendant-tree" class="internalDFN">descendant trees</a>.
        </p>

        <p>
          For example, from the view of the <var>document tree 1</var>, the event path would be seen as <code>[D, C, B, A]</code>.
          From the view of the <var>shadow tree 2</var>, the event path would be seen as <code>[I, H, G, F, E]</code>.
          The similar things also apply to other <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a>.
        </p>

        <p>
          It is also worth pointing out that if we exclude all <a title="insertion point" href="#dfn-insertion-point" class="internalDFN">insertion points</a> and <a title="shadow root" href="#dfn-shadow-root" class="internalDFN">shadow roots</a> from an event path,
          the result would be equivalent to the inclusive ancestors of the node on which the event is dispatched, in the composed tree.
        </p>

        <figure id="fig-the-relationship-between-an-event-path-and-the-composed-tree.-the-event-path-used-in-the-example-is-shown-in-the-left-hand-side-and-the-composed-tree-is-shown-in-the-right-hand-side.-if-we-exclude-all-insertion-points-and-shadow-roots-from-the-event-path-the-result-would-be-equivalent-to-the-inclusive-ancestors-of-the-node-d-in-the-composed-tree.x">
          <object data="event-path-and-composed-tree.svg" width="217" height="1723"></object>
          <figcaption>Fig. <span class="figno">7</span> <span class="fig-title">
            The relationship between an event path and the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a>. The event path used in the example is shown in the left-hand side and the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a> is shown in the right-hand side.
            If we exclude all <a title="insertion point" href="#dfn-insertion-point" class="internalDFN">insertion points</a> and <a title="shadow root" href="#dfn-shadow-root" class="internalDFN">shadow roots</a> from the event path,
            the result would be equivalent to the inclusive ancestors of the node, <code>D</code>, in the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a>.
          </span></figcaption>
        </figure>

      </section>

      <section id="event-retargeting">
        <h3 aria-level="2" role="heading" id="h3_event-retargeting"><span class="secno">5.4 </span>Event Retargeting</h3>

        <p>In the cases where event path is across multiple node trees, the event's information about the target of the event is adjusted in order to maintain encapsulation. Event <dfn id="dfn-retargeting">retargeting</dfn> is a process of computing relative targets for each ancestor of the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> at which the event is dispatched. A <dfn id="dfn-relative-target">relative target</dfn> is a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> that most accurately represents the target of a dispatched event at a given ancestor while maintaining the encapsulation.</p>

        <p>The <dfn id="dfn-retargeting-algorithm">retargeting algorithm</dfn> is used to determine relative targets, and it <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>EVENT-PATH</var>, an event path</dd>
            <dd><var>CURRENT-TARGET</var>, a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> where the event listener is invoked.</dd>
            <dt>Output</dt>
            <dd><var>RELATIVE-TARGET</var>, adjusted target</dd>
          </dl>
          <ol>
            <li>Let <var>CURRENT-TARGET-TREE</var> be the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> which <var>CURRENT-TARGET</var> <a href="http://dom.spec.whatwg.org/#concept-tree-participate" class="externalDFN">participates</a> in</li>
            <li>Let <var>ORIGINAL-TARGET</var> be the first item in <var>EVENT-PATH</var></li>
            <li>Let <var>ORIGINAL-TARGET-TREE</var> be the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> which <var>ORIGINAL-TARGET</var> <a href="http://dom.spec.whatwg.org/#concept-tree-participate" class="externalDFN">participates</a> in</li>
            <li>Let <var>RELATIVE-TARGET-TREE</var> be the lowest common <a href="#dfn-inclusive-ancestor-tree" class="internalDFN">inclusive ancestor tree</a> of <var>CURRENT-TARGET-TREE</var> and <var>ORIGINAL-TARGET-TREE</var></li>
            <li>Let <var>RELATIVE-TARGET</var> be the first <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> in <var>EVENT-PATH</var> which satisfies the following condition:
              <ol>
                <li>The <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> <a href="http://dom.spec.whatwg.org/#concept-tree-participate" class="externalDFN">participates</a> in <var>RELATIVE-TARGET-TREE</var></li>
              </ol>
            </li>
          </ol>
        </div>

        <p>The retargeting process <strong>must</strong> occur prior to dispatch of an event.</p>
      </section>

      <section id="retargeting-relatedtarget">
        <h3 aria-level="2" role="heading" id="h3_retargeting-relatedtarget"><span class="secno">5.5 </span>Retargeting <code>relatedTarget</code></h3>

        <p>Some events have a <a href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget" class="externalDFN"><code>relatedTarget</code></a> [<cite><a class="bibref" href="#bib-DOM-Level-3-Events">DOM-Level-3-Events</a></cite>] property, which holds a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> that's not the event's target, but is related to the event.</p>

        <p>For instance, a <code>mouseover</code> event's <a href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget" class="externalDFN"><code>relatedTarget</code></a> may hold the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> from which the mouse has moved to event's <code>target</code>. In the case where <code>relatedTarget</code> is in a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>, the conforming UAs <strong>must</strong> not leak its actual value outside of this tree. In cases where both <code>relatedTarget</code> and <code>target</code> are part of the same <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>, the conforming UAs <strong>must</strong> <em>stop</em> events at the shadow root to avoid the appearance of spurious <code>mouseover</code> and <code>mouseout</code> events firing from the same node.</p>

        <p>Thus, if an event has a <code>relatedTarget</code>, its value and extent of event dispatch <strong>must</strong> be adjusted. In general:</p>
        <ol>
          <li>For a given node, the <code>relatedTarget</code> <strong>must</strong> be changed to its ancestor (or self) that is in the same <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> as the node</li>
          <li>Event listeners <strong>must not</strong> be invoked on a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> for which the <code>target</code> and <code>relatedTarget</code> are the same.</li>
        </ol>

        <p>The <dfn id="dfn-related-target-resolution-algorithm">related target resolution algorithm</dfn> <strong>must</strong> be used to determine the value of the <a href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget" class="externalDFN"><code>relatedTarget</code></a> property and <strong>must</strong> be <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>EVENT</var>, an event</dd>
            <dd><var>CURRENT-TARGET</var>, the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> on which event listeners would be invoked</dd>
            <dd><var>RELATED-TARGET</var>, the related target for the event</dd>
            <dt>Output</dt>
            <dd><var>ADJUSTED-RELATED-TARGET</var>, the <dfn id="dfn-adjusted-related-target">adjusted related target</dfn> for <var>CURRENT-TARGET</var></dd>
          </dl>
          <ol>
            <li>Let <var>CURRENT-TARGET-TREE</var> be the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> which <var>CURRENT-TARGET</var> <a href="http://dom.spec.whatwg.org/#concept-tree-participate" class="externalDFN">participates</a> in</li>
            <li>Let <var>RELATED-TARGET-TREE</var> be the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> which <var>RELATED-TARGET</var> <a href="http://dom.spec.whatwg.org/#concept-tree-participate" class="externalDFN">participates</a> in</li>
            <li>Let <var>RELATED-TARGET-EVENT-PATH</var> be the result of the <a href="#dfn-event-path-calculation-algorithm" class="internalDFN">event path calculation algorithm</a> with <var>RELATED-TARGET</var> and <var>EVENT</var> as input</li>
            <li>If <var>CURRENT-TARGET-TREE</var> and <var>RELATED-TARGET-TREE</var> participate in the same <a href="#dfn-tree-of-trees" class="internalDFN">tree of trees</a>:
              <ol>
                <li>Let <var>LOWEST-COMMON-ANCESTOR-TREE</var> be the lowest common <a href="#dfn-inclusive-ancestor-tree" class="internalDFN">inclusive ancestor tree</a> of <var>CURRENT-TARGET-TREE</var> and <var>RELATED-TARGET-TREE</var></li>
              </ol>
            </li>
            <li>Otherwise:
              <ol>
                <li>Let <var>LOWEST-COMMON-ANCESTOR-TREE</var> be the <a href="#dfn-root-tree" class="internalDFN">root tree</a> of <var>RELATED-TARGET-TREE</var></li>
              </ol>
            </li>
            <li>For each <a href="#dfn-inclusive-ancestor-tree" class="internalDFN">inclusive ancestor tree</a>, <var>COMMON-ANCESTOR-TREE</var>, of the <var>LOWEST-COMMON-ANCESTOR-TREE</var>, in ascending order:
              <ol>
                <li>Let <var>ADJUSTED-RELATED-TARGET</var> be the first <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> in <var>RELATED-TARGET-EVENT-PATH</var> which satisfies the following condition:
                  <ol>
                    <li>The <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> <a href="http://dom.spec.whatwg.org/#concept-tree-participate" class="externalDFN">participates</a> in <var>COMMON-ANCESTOR-TREE</var></li>
                  </ol>
                </li>
                <li>If such a <var>ADJUSTED-RELATED-TARGET</var> exists:
                  <ol>
                    <li>Stops this algorithm</li>
                  </ol>
                </li>
              </ol>
            </li>
          </ol>
        </div>

        <div class="note"><div class="note-title" aria-level="3" role="heading" id="h_note_5"><span>Note</span></div><p class="">The result of the related target resolution algorithm is not always null. Unless that, you should file a bug for this specification.</p></div>

        <p>The relatedTarget retargeting process <strong>must</strong> occur prior to dispatch of an event.</p>
      </section>

      <section id="retargeting-touch-events">
        <h3 aria-level="2" role="heading" id="h3_retargeting-touch-events"><span class="secno">5.6 </span>Retargeting Touch Events</h3>

        <p>The <a href="http://www.w3.org/TR/touch-events/#touch-interface" class="externalDFN"><code>Touch</code></a> <a title="Touch target" href="http://www.w3.org/TR/touch-events/#widl-Touch-target" class="externalDFN"><code>target</code></a> [<cite><a class="bibref" href="#bib-TOUCH-EVENTS">TOUCH-EVENTS</a></cite>] attribute must be adjusted in the same way as an event with a <a href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget" class="externalDFN"><code>relatedTarget</code></a>. Each <a href="http://www.w3.org/TR/touch-events/#touch-interface" class="externalDFN"><code>Touch</code></a> <a title="Touch target" href="http://www.w3.org/TR/touch-events/#widl-Touch-target" class="externalDFN"><code>target</code></a> in the <a href="http://www.w3.org/TR/touch-events/#touchlist-interface" class="externalDFN"><code>TouchList</code></a> returned from <a href="http://www.w3.org/TR/touch-events/#touchevent-interface" class="externalDFN"><code>TouchEvent</code></a> <a title="touches" href="http://www.w3.org/TR/touch-events/#widl-TouchEvent-touches" class="externalDFN"><code>touches()</code></a>, <a title="changedTouches" href="http://www.w3.org/TR/touch-events/#widl-TouchEvent-changedTouches" class="externalDFN"><code>changedTouches()</code></a> and <a title="targetTouches" href="http://www.w3.org/TR/touch-events/#widl-TouchEvent-targetTouches" class="externalDFN"><code>targetTouches()</code></a> must be the result of <a href="#dfn-related-target-resolution-algorithm" class="internalDFN">related target resolution algorithm</a>, given <var>NODE</var> and <a href="http://www.w3.org/TR/touch-events/#touch-interface" class="externalDFN"><code>Touch</code></a> <a title="Touch target" href="http://www.w3.org/TR/touch-events/#widl-Touch-target" class="externalDFN"><code>target</code></a> as arguments.</p>
      </section>

      <section id="retargeting-focus-events">
        <h3 aria-level="2" role="heading" id="h3_retargeting-focus-events"><span class="secno">5.7 </span>Retargeting Focus Events</h3>

        <p>The <code>focus</code>, <code>DOMFocusIn</code>, <code>blur</code>, and <code>DOMFocusOut</code> events <strong>must</strong> be treated in the same way as events with a <code>relatedTarget</code>, where the corresponding <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> that is losing focus as a result of <code>target</code> gaining focus or the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> that is gaining focus, and thus causing the blurring of <code>target</code> acts as the related target.</p>
      </section>

      <section id="event-dispatch">
        <h3 aria-level="2" role="heading" id="h3_event-dispatch"><span class="secno">5.8 </span>Event Dispatch</h3>

        <p>At the time of event dispatch:</p>
        <ul>
          <li>The <a href="http://dom.spec.whatwg.org/#events" class="externalDFN"><code>Event</code></a> <a href="http://dom.spec.whatwg.org/#dom-event-target" class="externalDFN"><code>target</code></a> and <a href="http://dom.spec.whatwg.org/#dom-event-currenttarget" class="externalDFN"><code>currentTarget</code></a> attributes <strong>must</strong> return the <a href="#dfn-relative-target" class="internalDFN">relative target</a> for the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> on which event listeners are <a title="event listener invoke" href="http://dom.spec.whatwg.org/#concept-event-listener-invoke" class="externalDFN">invoked</a></li>
          <li>The <a href="http://www.w3.org/TR/DOM-Level-3-Events/#interface-MouseEvent" class="externalDFN"><code>MouseEvent</code></a> <a href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget" class="externalDFN"><code>relatedTarget</code></a> attribute <strong>must</strong> return the <a href="#dfn-adjusted-related-target" class="internalDFN">adjusted related target</a></li>
          <li>The <a href="http://www.w3.org/TR/DOM-Level-3-Events/#interface-MouseEvent" class="externalDFN"><code>MouseEvent</code></a> <a href="http://www.w3.org/TR/cssom-view/#dom-mouseevent-offsetx" class="externalDFN"><code>offsetX</code></a> and <a href="http://www.w3.org/TR/cssom-view/#dom-mouseevent-offsety" class="externalDFN"><code>offsetY</code></a> attributes <strong>must</strong> return the coordinates relative to the origin of the <a href="http://www.w3.org/TR/cssom-view/#padding-edge" class="externalDFN">padding edge</a> of the <a href="#dfn-relative-target" class="internalDFN">relative target</a></li>
          <li>The <a href="http://www.w3.org/TR/touch-events/#touch-interface" class="externalDFN"><code>Touch</code></a> <a title="Touch target" href="http://www.w3.org/TR/touch-events/#widl-Touch-target" class="externalDFN"><code>target</code></a> attribute <strong>must</strong> return the <a href="#dfn-adjusted-related-target" class="internalDFN">adjusted related target</a></li>
          <li>If the <a href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget" class="externalDFN"><code>relatedTarget</code></a> and <a href="http://dom.spec.whatwg.org/#dom-event-target" class="externalDFN"><code>target</code></a> are the same for a given node, its the event listeners <strong>must not</strong> be invoked. <a href="http://www.w3.org/TR/touch-events/#touchevent-interface" class="externalDFN"><code>TouchEvent</code></a> is not subject to this rule.</li>
          <li>When <em>capturing</em>, which entails processing step 6 of the <a title="event dispatch" href="http://dom.spec.whatwg.org/#concept-event-dispatch" class="externalDFN">event dispatch algorithm</a>, the event listeners <strong>must not</strong> be <a title="event listener invoke" href="http://dom.spec.whatwg.org/#concept-event-listener-invoke" class="externalDFN">invoked</a> on a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> <strong>if</strong> it is the same as its <a href="#dfn-relative-target" class="internalDFN">relative target</a></li>
          <li>When <em>bubbling</em>, which entails processing step 9 of the <a title="event dispatch" href="http://dom.spec.whatwg.org/#concept-event-dispatch" class="externalDFN">event dispatch algorithm</a>, the <a href="http://dom.spec.whatwg.org/#events" class="externalDFN"><code>Event</code></a> <a href="http://dom.spec.whatwg.org/#dom-event-eventphase" class="externalDFN">eventPhase</a> attribute <strong>must</strong> return <a href="http://dom.spec.whatwg.org/#dom-event-at_target" class="externalDFN">AT_TARGET</a> <strong>if</strong> the <a href="#dfn-relative-target" class="internalDFN">relative target</a> is same as the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> on which event listeners are <a title="event listener invoke" href="http://dom.spec.whatwg.org/#concept-event-listener-invoke" class="externalDFN">invoked</a></li>
          <li>If the event's <a href="http://dom.spec.whatwg.org/#dom-event-bubbles" class="externalDFN"><code>bubbles</code></a> attribute value is <strong>false</strong>, run these substeps:
            <ol>
              <li>Reverse the order of <em>event path</em></li>
              <li>Initialize event's <a href="http://dom.spec.whatwg.org/#dom-event-eventphase" class="externalDFN"><code>eventPhase</code></a> attribute to <a href="http://dom.spec.whatwg.org/#dom-event-at_target" class="externalDFN"><code>AT_TARGET</code></a></li>
              <li>For each object in <em>event path</em> where the <a href="#dfn-relative-target" class="internalDFN">relative target</a> is same as the object, <a title="event listener invoke" href="http://dom.spec.whatwg.org/#concept-event-listener-invoke" class="externalDFN">invoke</a> its <a title="event listener" href="http://dom.spec.whatwg.org/#concept-event-listener" class="externalDFN">event listeners</a>, with event <em>event</em>, as long as <em>event</em>'s <a href="http://dom.spec.whatwg.org/#stop-propagation-flag" class="externalDFN">stop propagation flag</a> is unset</li>
            </ol></li>
        </ul>

        <p>Upon completion of the event dispatch, the <a href="http://dom.spec.whatwg.org/#events" class="externalDFN"><code>Event</code></a> object's <a href="http://dom.spec.whatwg.org/#dom-event-target" class="externalDFN"><code>target</code></a> and <a href="http://dom.spec.whatwg.org/#dom-event-currenttarget" class="externalDFN"><code>currentTarget</code></a> <strong>must</strong> be to the highest ancestor's <a href="#dfn-relative-target" class="internalDFN">relative target</a>. Since it is possible for a script to hold on to the <code>Event</code> object past the scope of event dispatch, this step is necessary to avoid revealing the <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> in <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a>.</p>
      </section>

      <section class="informative" id="event-retargeting-example">
        <h3 aria-level="2" role="heading" id="h3_event-retargeting-example"><span class="secno">5.9 </span>Event Retargeting Example</h3><p><em>This section is non-normative.</em></p>

        <p>Suppose we have a user interface for a media controller, represented by this tree, composed of both <a href="#dfn-document-tree" class="internalDFN">document tree</a> and the <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a>. In this example, we will assume that selectors are allowed to cross the shadow boundaries and we will use these selectors to identify the <a title="element" href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">elements</a>. Also, we will invent a fictional <code>shadow-root</code> <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> to demarcate the shadow boundaries and represent <a title="shadow root" href="#dfn-shadow-root" class="internalDFN">shadow roots</a>:</p>
        <div class="example"><div class="example-title"><span>Example 1</span></div><pre class="example">&lt;div id="player"&gt;
    <span class="shadow-boundary">&lt;shadow-root id="player-shadow-root"&gt;</span>
        &lt;div id="controls"&gt;
            &lt;button id="play-button"&gt;PLAY&lt;/button&gt;
            &lt;input type="range" id="timeline"&gt;
                <span class="shadow-boundary">&lt;shadow-root id="timeline-shadow-root"&gt;</span>
                    &lt;div id="slider-thumb" id="timeline-slider-thumb"&gt;&lt;/div&gt;
                <span class="shadow-boundary">&lt;/shadow-root&gt;</span>
            &lt;/input&gt;
            &lt;div id="volume-slider-container"&gt;
                &lt;input type="range" id="volume-slider"&gt;
                    <span class="shadow-boundary">&lt;shadow-root id="volume-shadow-root"&gt;</span>
                        &lt;div id="slider-thumb" id="volume-slider-thumb"&gt;&lt;/div&gt;
                    <span class="shadow-boundary">&lt;/shadow-root&gt;</span>
                &lt;/input&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    <span class="shadow-boundary">&lt;/shadow-root&gt;</span>
&lt;/div&gt;</pre></div>

        <p>Let's have a user position their pointing device over the volume slider's thumb (<code>#volume-slider-thumb</code>), thus triggering a <code>mouseover</code> event on that node. For this event, let's pretend it has no associated <code>relatedTarget</code>.</p>

        <p>Per the <a href="#dfn-retargeting-algorithm" class="internalDFN">retargeting algorithm</a>, we should have the following set of ancestors and relative targets:</p>
        <table>
          <thead>
            <tr>
              <th>Ancestor</th>
              <th>Relative Target</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>#player</code></td>
              <td><code><strong>#player</strong></code></td>
            </tr>
            <tr>
              <td><code>#player-shadow-root</code></td>
              <td><code>#volume-slider</code></td>
            </tr>
            <tr>
              <td><code>#controls</code></td>
              <td><code>#volume-slider</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider-container</code></td>
              <td><code>#volume-slider</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider</code></td>
              <td><code><strong>#volume-slider</strong></code></td>
            </tr>
            <tr>
              <td><code>#volume-shadow-root</code></td>
              <td><code>#volume-slider-thumb</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider-thumb</code></td>
              <td><code><strong>#volume-slider-thumb</strong></code></td>
            </tr>
          </tbody>
        </table>

        <p>After we dispatch the <code>mouseover</code> event using these newly computed relative targets, the user decides to move their pointing device over the thumb of the timeline
          (<code>#timeline-slider-thumb</code>). This triggers both a <code>mouseout</code> event for the volume slider thumb and the <code>mouseover</code> event for the timeline thumb.</p>

        <p>Let's see how the <code>relatedTarget</code> value of the volume thumb's <code>mouseout</code> event is affected. For this event, the <code>relatedTarget</code> is the timeline thumb (<code>#timeline-slider-thumb</code>). Per the <a href="#dfn-related-target-resolution-algorithm" class="internalDFN">related target resolution algorithm</a>, we should have the following set of ancestors and adjusted related targets:</p>

        <table>
          <thead>
            <tr>
              <th>Ancestor</th>
              <th>Relative Target</th>
              <th>Adjusted related Target</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>#player</code></td>
              <td><code><strong>#player</strong></code></td>
              <td><code><strong>#player</strong></code></td>
            </tr>
            <tr>
              <td><code>#player-shadow-root</code></td>
              <td><code>#volume-slider</code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#controls</code></td>
              <td><code>#volume-slider</code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider-container</code></td>
              <td><code>#volume-slider</code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider</code></td>
              <td><code><strong>#volume-slider</strong></code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#volume-shadow-root</code></td>
              <td><code>#volume-slider-thumb</code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider-thumb</code></td>
              <td><code><strong>#volume-slider-thumb</strong></code></td>
              <td><code><strong>#timeline</strong></code></td>
            </tr>
          </tbody>
        </table>

        <p>The node, <code>#player</code>, has both <code>target</code> and <code>relatedTarget</code> being the same value (<code>#player</code>), which means that we do not dispatch the event on this <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> and its ancestors.</p>
      </section>

    </section>

    <section id="user-interaction">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_user-interaction"><span class="secno">6. </span>User Interaction</h2>

      <section class="informative" id="ranges-and-selections">
        <h3 aria-level="2" role="heading" id="h3_ranges-and-selections"><span class="secno">6.1 </span>Ranges and Selections</h3><p><em>This section is non-normative.</em></p>

        <p>
          <a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection" class="externalDFN">Selection</a> [<cite><a class="bibref" href="#bib-EDITING">EDITING</a></cite>] is not defined. Implementation should do their best to do what's best for them. Here's one possible, admittedly naive way:
        </p>

        <p>Since <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> which are in the different <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a> never have the same <a href="http://dom.spec.whatwg.org/#concept-tree-root" class="externalDFN">root</a>, there may never exist a valid <a title="range" href="http://dom.spec.whatwg.org/#range" class="externalDFN">DOM range</a> that spans multiple <a title="node tree" href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node trees</a>.</p>

        <p>Accordingly, <a title="selection" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection" class="externalDFN">selections</a> may only exist within one <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a>, because they are defined by a single <a href="http://dom.spec.whatwg.org/#range" class="externalDFN">range</a>. The <a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection" class="externalDFN">selection</a>, returned by the <a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#dom-window-getselection" class="externalDFN"><code>window.getSelection()</code></a> method never returns a <a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection" class="externalDFN">selection</a> within a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>

        <p>The <code>getSelection()</code> method of the <a href="#dfn-shadow-root" class="internalDFN">shadow root</a> object returns the current <a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection" class="externalDFN">selection</a> in this <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>
      </section>

      <section id="focus-navigation">
        <h3 aria-level="2" role="heading" id="h3_focus-navigation"><span class="secno">6.2 </span>Focus Navigation</h3>

        <p>If a <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> doesn’t <a title="participates" href="http://dom.spec.whatwg.org/#concept-tree-participate" class="externalDFN">participate</a> in the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a>, the <a href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">node</a> <strong>must</strong> be skipped from the <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation order</a> [<cite><a class="bibref" href="#bib-CSS3UI">CSS3UI</a></cite>] sequence.</p>

        <p>For <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">sequential focus navigation</a>, the <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation order</a> sequence for a given <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> <var>A</var> <strong>must</strong> be inserted into the <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation order</a> for other <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> as follow:</p>
        <ol>
          <li>If <var>A</var> is the <a href="#dfn-youngest-shadow-tree" class="internalDFN">youngest shadow tree</a>:
            <ol>
              <li>Let <var>HOST</var> be the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> which <a href="#dfn-hosts" class="internalDFN">hosts</a> A</li>
              <li>Let <var>B</var> be the <a href="http://dom.spec.whatwg.org/#concept-node-tree" class="externalDFN">node tree</a> which <var>HOST</var> participates in</li>
              <li>The <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation order</a> for A <strong>must</strong> be inserted into the <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation order</a> for <var>B</var>:
                <ol>
                  <li>immediately after <var>HOST</var>, if <var>HOST</var> is <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#focusable-area" class="externalDFN">focusable</a>; or</li>
                  <li>in place of the <var>HOST</var> as if <var>HOST</var> were assigned the value of <a title="nav-index auto" href="http://www.w3.org/TR/css3-ui/#nav-index" class="externalDFN"><code>auto</code></a> for determining its position.</li>
                </ol></li>
            </ol></li>
          <li>Otherwise:
            <ol>
              <li>Let <var>B</var> be the <a href="#dfn-younger-shadow-tree" class="internalDFN">younger shadow tree</a> relative to <var>A</var></li>
              <li>Let <var>SHADOW</var> be the <a href="#dfn-shadow-insertion-point" class="internalDFN">shadow insertion point</a> in <var>B</var></li>
              <li>If <var>SHADOW</var> exists, the <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation order</a> for <var>A</var> <strong>must</strong> be inserted into the <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation order</a> for <var>B</var> immediately after <var>SHADOW</var> as if <var>SHADOW</var> were assigned the value of <a title="nav-index auto" href="http://www.w3.org/TR/css3-ui/#nav-index" class="externalDFN"><code>auto</code></a> for determining its position.</li>
            </ol></li>
        </ol>

        <p>For <a href="http://www.w3.org/TR/css3-ui/#nav-dir" class="externalDFN">directional focus navigation</a>, it is up to the user agent to integrate the <a title="navigation order" href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation orders</a> for <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a> into the <a href="http://dom.spec.whatwg.org/#concept-document" class="externalDFN">document</a> <a href="http://www.w3.org/TR/css3-ui/#keyboard" class="externalDFN">navigation order</a>.</p>
      </section>

      <section id="active-element">
        <h3 aria-level="2" role="heading" id="h3_active-element"><span class="secno">6.3 </span>Active Element</h3>

        <p>To maintain encapsulation, the value of the <a title="Document object" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document" class="externalDFN">Document</a> object's focus API property <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement" class="externalDFN">activeElement</a> <strong>must</strong> be adjusted. To prevent loss of information when adjusting this value, each <a href="#dfn-shadow-root" class="internalDFN">shadow root</a> <strong>must</strong> also have an <code>activeElement</code> property to store the value of the focused <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> in the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>

        <p>The <dfn id="dfn-active-element-adjustment-algorithm">active <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> adjustment algorithm</dfn> is used to determine the value of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement" class="externalDFN">activeElement</a> property, and it <strong>must</strong> be equivalent to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>ELEMENT</var>, the focused <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a></dd>
            <dd><var>ROOT</var>, either a <a href="http://dom.spec.whatwg.org/#concept-document" class="externalDFN">document</a> or a <a href="#dfn-shadow-root" class="internalDFN">shadow root</a></dd>
            <dt>Output</dt>
            <dd><var>ADJUSTED</var>, an adjusted <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement" class="externalDFN">activeElement</a> property of <var>ROOT</var>.</dd>
          </dl>
          <ol>
            <li>Let <var>PATH</var> be the result of the <a href="#dfn-event-path-calculation-algorithm" class="internalDFN">event path calculation algorithm</a> with <var>ELEMENT</var> and null as input</li>
            <li>Let <var>ADJUSTED</var> be the result of the <a href="#dfn-retargeting-algorithm" class="internalDFN">retargeting algorithm</a> with <var>PATH</var> and <var>ROOT</var> as input</li>
          </ol>
        </div>
      </section>

      <section id="editing">
        <h3 aria-level="2" role="heading" id="h3_editing"><span class="secno">6.4 </span>Editing</h3>

        <p>The value of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#attr-contenteditable" class="externalDFN"><code>contenteditable</code></a> attribute <strong>must not</strong> propagate from <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> to its <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a>.</p>
      </section>

      <section id="assistive-technology">
        <h3 aria-level="2" role="heading" id="h3_assistive-technology"><span class="secno">6.5 </span>Assistive Technology</h3>

        <p>User agents with assistive technology traverse the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a>, and thus enable full use of WAI-ARIA [<cite><a class="bibref" href="#bib-WAI-ARIA">WAI-ARIA</a></cite>] semantics in the <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a>.</p>

      </section>

    </section>

    <section id="html-elements-in-shadow-trees">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_html-elements-in-shadow-trees"><span class="secno">7. </span>HTML Elements in Shadow Trees</h2>

      <p>Comparatively, a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> can be seen as somewhere between <em>just part of a <a href="http://dom.spec.whatwg.org/#concept-document" class="externalDFN">document</a></em> and itself being a <a title="interface DocumentFragment" href="http://dom.spec.whatwg.org/#interface-documentfragment" class="externalDFN">document fragment</a>. Since it is rendered, a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> aims to retain the traits of a typical <a href="http://dom.spec.whatwg.org/#trees" class="externalDFN">tree</a> in a <a href="http://dom.spec.whatwg.org/#concept-document" class="externalDFN">document</a>. At the same time, it is an encapsulation abstraction, so it has to avoid affecting the <a href="#dfn-document-tree" class="internalDFN">document tree</a>. Thus, the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics" class="externalDFN">HTML elements</a> <strong>must</strong> behave as specified [<cite><a class="bibref" href="#bib-HTML">HTML</a></cite>] in the <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a>, with a few exceptions.</p>

      <section id="inert-html-elements">
        <h3 aria-level="2" role="heading" id="h3_inert-html-elements"><span class="secno">7.1 </span>Inert HTML Elements</h3>

        <p>A subset of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics" class="externalDFN">HTML elements</a> <strong>must</strong> behave as <dfn id="dfn-inert">inert</dfn>, or not part of the <a href="#dfn-document-tree" class="internalDFN">document tree</a>. This is consistent how the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics" class="externalDFN">HTML elements</a> would behave in a <a title="interface DocumentFragment" href="http://dom.spec.whatwg.org/#interface-documentfragment" class="externalDFN">document fragment</a>. These <a title="element" href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">elements</a> are:</p>
        <ul>
          <li><a title="base element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-base-element" class="externalDFN"><code>base</code></a></li>
          <li><a title="link element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-link-element" class="externalDFN"><code>link</code></a></li>
        </ul>

        <p>All other <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics" class="externalDFN">HTML elements</a> in the <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a> <strong>must</strong> behave as if they were part of the <a href="#dfn-document-tree" class="internalDFN">document tree</a>.</p>
      </section>

    </section>

    <section id="html-elements-and-their-shadow-trees">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_html-elements-and-their-shadow-trees"><span class="secno">8. </span>HTML Elements and Their Shadow Trees</h2>

      <p>Per <a title="HTML" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/" class="externalDFN">specification</a>, some <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics" class="externalDFN">HTML elements</a> are designed to either not render their contents or have special requirements in regard to contents rendering. In order to reconcile these differences in rendering behavior with the <a href="#dfn-composed-tree" class="internalDFN">composed tree</a>, all <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics" class="externalDFN">HTML elements</a> <strong>must</strong> have an <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> of a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> that is created and populated at the time of <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> instantiation. It is up to a user agent to define the content of these trees. However, all conforming user agents <strong>must</strong> satisfy the following requirements:</p>

      <table>
        <thead>
          <tr>
            <th style="width: 30%">HTML Element</th>
            <th>Shadow Tree Requirements</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><a title="img element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/edits.html#the-img-element" class="externalDFN"><code>img</code></a>, <a title="iframe element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-iframe-element" class="externalDFN"><code>iframe</code></a>, <a title="embed element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-embed-element" class="externalDFN"><code>embed</code></a>, <a title="object element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-object-element" class="externalDFN"><code>object</code></a>, <a title="video element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-video-element.html#the-video-element" class="externalDFN"><code>video</code></a>, <a title="audio element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-video-element.html#the-audio-element" class="externalDFN"><code>audio</code></a>, <a title="canvas element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-canvas-element.html#the-canvas-element" class="externalDFN"><code>canvas</code></a>, <a title="map element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-map-element.html#the-map-element" class="externalDFN"><code>map</code></a>, <a title="input element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-input-element.html#the-input-element" class="externalDFN"><code>input</code></a>, <a title="textarea element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-textarea-element" class="externalDFN"><code>textarea</code></a>, <a title="progress element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-progress-element" class="externalDFN"><code>progress</code></a>, <a title="meter element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-meter-element" class="externalDFN"><code>meter</code></a></td>
            <td>If the <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> can have <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#fallback-content" class="externalDFN">fallback content</a>, contains one <a href="#dfn-content-insertion-point" class="internalDFN">content insertion point</a>. The <a href="#dfn-matching-criteria" class="internalDFN">matching criteria</a> value is the <a href="http://dev.w3.org/csswg/selectors4/#universal-selector" class="externalDFN">universal selector</a> only when the <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> needs to show <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#fallback-content" class="externalDFN">fallback content</a>. Otherwise, contains no <a title="content insertion point" href="#dfn-content-insertion-point" class="internalDFN">content insertion points</a> or an <a href="#dfn-content-insertion-point" class="internalDFN">content insertion point</a> that matches nothing.</td>
          </tr>
          <tr>
            <td><a title="fieldset element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-fieldset-element" class="externalDFN"><code>fieldset</code></a></td>
            <td>Contains two <a title="content insertion point" href="#dfn-content-insertion-point" class="internalDFN">content insertion points</a> with the following <a href="#dfn-matching-criteria" class="internalDFN">matching criteria</a>:
              <ol>
                <li><code>legend:first-of-type</code></li>
                <li><a href="http://dev.w3.org/csswg/selectors4/#universal-selector" class="externalDFN">universal selector</a></li>
              </ol>
            </td>
          </tr>
          <tr>
            <td><a title="details element" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/interactive-elements.html#the-details-element" class="externalDFN"><code>details</code></a></td>
            <td>Contains two <a title="content insertion point" href="#dfn-content-insertion-point" class="internalDFN">content insertion points</a> with the following <a href="#dfn-matching-criteria" class="internalDFN">matching criteria</a>:
              <ol>
                <li><code>summary:first-of-type</code></li>
                <li><a href="http://dev.w3.org/csswg/selectors4/#universal-selector" class="externalDFN">universal selector</a></li>
              </ol>
            </td>
          </tr>
          <tr>
            <td>All other <a title="element" href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">elements</a></td>
            <td>Contains one <a href="#dfn-content-insertion-point" class="internalDFN">content insertion point</a> with the <a href="http://dev.w3.org/csswg/selectors4/#universal-selector" class="externalDFN">universal selector</a> as the <a href="#dfn-matching-criteria" class="internalDFN">matching criteria</a></td>
          </tr>
        </tbody>
      </table>
    </section>

    <section id="elements-and-dom-objects">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_elements-and-dom-objects"><span class="secno">9. </span>Elements and DOM Objects</h2>

      <section id="shadowroot-object">
        <h3 aria-level="2" role="heading" id="h3_shadowroot-object"><span class="secno">9.1 </span><code>ShadowRoot</code> Object</h3>

        <p>The <code>ShadowRoot</code> object represents the <a href="#dfn-shadow-root" class="internalDFN">shadow root</a>.</p>

        <pre class="idl"><span class="idlInterface" id="idl-def-ShadowRoot">interface <span class="idlInterfaceID">ShadowRoot</span> : <span class="idlSuperclass">DocumentFragment</span> {
<span class="idlMethod">    <span class="idlMethType">HTMLElement</span> <span class="idlMethName"><a href="#widl-ShadowRoot-getElementById-HTMLElement-DOMString-elementId">getElementById</a></span> (<span class="idlParam"><span class="idlParamType">DOMString</span> <span class="idlParamName">elementId</span></span>);</span>
<span class="idlMethod">    <span class="idlMethType">NodeList</span>    <span class="idlMethName"><a href="#widl-ShadowRoot-getElementsByClassName-NodeList-DOMString-className">getElementsByClassName</a></span> (<span class="idlParam"><span class="idlParamType">DOMString</span> <span class="idlParamName">className</span></span>);</span>
<span class="idlMethod">    <span class="idlMethType">NodeList</span>    <span class="idlMethName"><a href="#widl-ShadowRoot-getElementsByTagName-NodeList-DOMString-tagName">getElementsByTagName</a></span> (<span class="idlParam"><span class="idlParamType">DOMString</span> <span class="idlParamName">tagName</span></span>);</span>
<span class="idlMethod">    <span class="idlMethType">NodeList</span>    <span class="idlMethName"><a href="#widl-ShadowRoot-getElementsByTagNameNS-NodeList-DOMString-namespace-DOMString-localName">getElementsByTagNameNS</a></span> (<span class="idlParam"><span class="idlParamType">DOMString?</span> <span class="idlParamName">namespace</span></span>, <span class="idlParam"><span class="idlParamType">DOMString</span> <span class="idlParamName">localName</span></span>);</span>
<span class="idlMethod">    <span class="idlMethType">Selection?</span>  <span class="idlMethName"><a href="#widl-ShadowRoot-getSelection-Selection">getSelection</a></span> ();</span>
<span class="idlMethod">    <span class="idlMethType"><a href="#idl-def-Element" class="idlType"><code>Element</code></a>?</span>    <span class="idlMethName"><a href="#widl-ShadowRoot-elementFromPoint-Element-double-x-double-y">elementFromPoint</a></span> (<span class="idlParam"><span class="idlParamType">double</span> <span class="idlParamName">x</span></span>, <span class="idlParam"><span class="idlParamType">double</span> <span class="idlParamName">y</span></span>);</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType"><a href="#idl-def-Element" class="idlType"><code>Element</code></a>?</span>       <span class="idlAttrName"><a href="#widl-ShadowRoot-activeElement">activeElement</a></span>;</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType"><a href="#idl-def-Element" class="idlType"><code>Element</code></a></span>        <span class="idlAttrName"><a href="#widl-ShadowRoot-host">host</a></span>;</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType"><a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a>?</span>    <span class="idlAttrName"><a href="#widl-ShadowRoot-olderShadowRoot">olderShadowRoot</a></span>;</span>
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span>      <span class="idlAttrName"><a href="#widl-ShadowRoot-innerHTML">innerHTML</a></span>;</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType">StyleSheetList</span> <span class="idlAttrName"><a href="#widl-ShadowRoot-styleSheets">styleSheets</a></span>;</span>
};</span></pre><section id="attributes"><h4 aria-level="3" role="heading" id="h4_attributes"><span class="secno">9.1.1 </span>Attributes</h4><dl class="attributes"><dt id="widl-ShadowRoot-activeElement"><code>activeElement</code> of type <span class="idlAttrType"><a href="#idl-def-Element" class="idlType"><code>Element</code></a></span>, readonly   , nullable</dt><dd>
            <p>Represents the currently focused <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> in the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>
            <p>On getting, the attribute <strong>must</strong> return the currently focused <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> in the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a> or <code>null</code>, if there is none.</p>
          </dd><dt id="widl-ShadowRoot-host"><code>host</code> of type <span class="idlAttrType"><a href="#idl-def-Element" class="idlType"><code>Element</code></a></span>, readonly   </dt><dd>
            <p>Represents the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> which <a href="#dfn-hosts" class="internalDFN">hosts</a> the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a>.</p>
            <p>On getting, the attribute <strong>must</strong> return the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a> which <a href="#dfn-hosts" class="internalDFN">hosts</a> the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a>.</p>
          </dd><dt id="widl-ShadowRoot-innerHTML"><code>innerHTML</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd>
            <p>Represents the markup of <a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a>'s contents.</p>
            <p>On getting, the attribute <strong>must</strong> return the result of running the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-end.html#html-fragment-serialization-algorithm" class="externalDFN">HTML fragment serialization algorithm</a> with the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> as <a title="shadow host" href="#dfn-shadow-host" class="internalDFN"><code>shadow host</code></a>.</p>
            <p>
              On setting, these steps <strong>must</strong> be run:
            </p>
            <ol>
              <li>Let <var>FRAGMENT</var> be the result of invoking the <a title="parse fragment" href="http://domparsing.spec.whatwg.org/#concept-parse-fragment" class="externalDFN">fragment parsing algorithm</a> [<cite><a class="bibref" href="#bib-DOMPARSING">DOMPARSING</a></cite>] with the new value as <var>MARKUP</var>, and the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> as <a title="shadow host" href="#dfn-shadow-host" class="internalDFN"><code>shadow host</code></a></li>
              <li><a href="http://dom.spec.whatwg.org/#concept-node-replace-all" class="externalDFN">Replace all</a> with <var>FRAGMENT</var> within the <a href="#dfn-shadow-root" class="internalDFN">shadow root</a>.</li>
            </ol>
          </dd><dt id="widl-ShadowRoot-olderShadowRoot"><code>olderShadowRoot</code> of type <span class="idlAttrType"><a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a></span>, readonly   , nullable</dt><dd>
            <p>Represents the <a href="#dfn-older-shadow-root" class="internalDFN">older shadow root</a> relative to the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a></p>
            <p>
              On getting, the attribute <strong>must</strong> return a result that is <a title="processing equivalence" href="#dfn-processing-equivalence" class="internalDFN">equivalent</a> to running the following steps:
            </p>
            <ol>
              <li>If the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> is the <a href="#dfn-oldest-shadow-root" class="internalDFN">oldest shadow root</a>, return <strong>null</strong>.</li>
              <li>Return the <a href="#dfn-older-shadow-root" class="internalDFN">older shadow root</a> relative to the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a>.</li>
            </ol>
            <p>For <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics" class="externalDFN">HTML elements</a>, the <a href="#html-elements-and-their-shadow-trees">UA-provided</a> <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a> <strong>must not</strong> be accessible.</p>
          </dd><dt id="widl-ShadowRoot-styleSheets"><code>styleSheets</code> of type <span class="idlAttrType">StyleSheetList</span>, readonly   </dt><dd>
            <p>Represents the shadow root style sheets.</p>
            <p>On getting, the attribute <strong>must</strong> return a <a href="http://www.w3.org/TR/cssom/#the-stylesheetlist-interface" class="externalDFN"><code>StyleSheetList</code></a> sequence containing the shadow root style sheets.
            </p>
          </dd></dl></section><section id="methods"><h4 aria-level="3" role="heading" id="h4_methods"><span class="secno">9.1.2 </span>Methods</h4><dl class="methods"><dt id="widl-ShadowRoot-elementFromPoint-Element-double-x-double-y"><code>elementFromPoint</code></dt><dd>
            <p>Returns an <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> at specified coordinates.</p>
            <div class="note"><div class="note-title" aria-level="4" role="heading" id="h_note_6"><span>Note</span></div><p class="">Eventually, this needs to be part of CSSOM View Module specification [<cite><a class="bibref" href="#bib-CSSOM-VIEW">CSSOM-VIEW</a></cite>]</p></div>
            <p>
              When invoked, it <strong>must</strong> return result of running the following steps:
            </p>
            <ol>
              <li>If <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> is not a <a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a> instance, throw an <a href="http://dom.spec.whatwg.org/#invalidnodetypeerror" class="externalDFN"><code>InvalidNodeTypeError</code></a>.</li>
              <li>If either argument is negative, <code>x</code> is greater than the <a href="http://www.w3.org/TR/cssom-view/#viewport" class="externalDFN">viewport</a> width excluding the size of a rendered scroll bar (if any), or if <code>y</code> is greater than the <a href="http://www.w3.org/TR/cssom-view/#viewport" class="externalDFN">viewport</a> height excluding the size of a rendered scroll bar (if any), return <strong>null</strong>.</li>
              <li>Let <var>HIT</var> be the <a href="http://dom.spec.whatwg.org/#concept-element" class="externalDFN">element</a> at coordinates <code>x</code> and <code>y</code> in the <a href="http://www.w3.org/TR/cssom-view/#viewport" class="externalDFN">viewport</a>, determined through hit testing</li>
              <li>Let <var>PATH</var> be the result of running the <a href="#dfn-event-path-calculation-algorithm" class="internalDFN">event path calculation algorithm</a> with <var>HIT</var> and null as input</li>
              <li>Return the result of running the <a href="#dfn-retargeting-algorithm" class="internalDFN">retargeting algorithm</a> with <var>PATH</var> and <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> as input</li>
            </ol>
          <table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">x</td><td class="prmType"><code>double</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr><tr><td class="prmName">y</td><td class="prmType"><code>double</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code><a href="#idl-def-Element" class="idlType"><code>Element</code></a></code>, nullable</div></dd><dt id="widl-ShadowRoot-getElementById-HTMLElement-DOMString-elementId"><code>getElementById</code></dt><dd>
            <strong>Must</strong> behave exactly like <a href="http://dom.spec.whatwg.org/#dom-nonelementparentnode-getelementbyid" class="externalDFN">document.getElementById</a>, except scoped to the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.
          <table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">elementId</td><td class="prmType"><code>DOMString</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code>HTMLElement</code></div></dd><dt id="widl-ShadowRoot-getElementsByClassName-NodeList-DOMString-className"><code>getElementsByClassName</code></dt><dd>
            <strong>Must</strong> behave exactly like document.getElementsByClassName, except scoped to the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.
          <table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">className</td><td class="prmType"><code>DOMString</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code>NodeList</code></div></dd><dt id="widl-ShadowRoot-getElementsByTagName-NodeList-DOMString-tagName"><code>getElementsByTagName</code></dt><dd>
            <strong>Must</strong> behave exactly like <a href="http://dom.spec.whatwg.org/#dom-document-getelementsbytagname" class="externalDFN">document.getElementsByTagName</a>, except scoped to the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.
          <table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">tagName</td><td class="prmType"><code>DOMString</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code>NodeList</code></div></dd><dt id="widl-ShadowRoot-getElementsByTagNameNS-NodeList-DOMString-namespace-DOMString-localName"><code>getElementsByTagNameNS</code></dt><dd>
            <strong>Must</strong> behave exactly like <a href="http://dom.spec.whatwg.org/#dom-document-getelementsbytagnamens" class="externalDFN">document.getElementsByTagNameNS</a>, except scoped to the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.
          <table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">namespace</td><td class="prmType"><code>DOMString</code></td><td class="prmNullTrue"><span role="img" aria-label="True">✔</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr><tr><td class="prmName">localName</td><td class="prmType"><code>DOMString</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code>NodeList</code></div></dd><dt id="widl-ShadowRoot-getSelection-Selection"><code>getSelection</code></dt><dd>
            <p>Returns the current selection in the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>
            <p>When invoked, it <strong>must</strong> return the <a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection" class="externalDFN">selection</a> in the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>
          <div><em>No parameters.</em></div><div><em>Return type: </em><code>Selection</code>, nullable</div></dd></dl></section>

        <p>The <a href="http://dom.spec.whatwg.org/#dom-node-nodetype" class="externalDFN"><code>nodeType</code></a> attribute of a <a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a> instance <strong>must</strong> return <a href="http://dom.spec.whatwg.org/#dom-node-document_fragment_node" class="externalDFN"><code>DOCUMENT_FRAGMENT_NODE</code></a>. Accordingly, the <a href="http://dom.spec.whatwg.org/#dom-node-nodename" class="externalDFN"><code>nodeName</code></a> attribute of a <a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a> instance <strong>must</strong> return <code>"#document-fragment"</code>.</p>

        <p>Invoking the <a href="http://dom.spec.whatwg.org/#dom-node-clonenode" class="externalDFN"><code>cloneNode()</code></a> method on a <a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a> instance <strong>must</strong> always throw a <a href="http://dom.spec.whatwg.org/#dom-domexception-data_clone_err" class="externalDFN"><code>DATA_CLONE_ERR</code></a> exception.</p>

      </section>

      <section id="extensions-to-element-interface">
        <h3 aria-level="2" role="heading" id="h3_extensions-to-element-interface"><span class="secno">9.2 </span>Extensions to <code>Element</code> Interface</h3>

        <pre class="idl"><span class="idlInterface" id="idl-def-Element">partial interface <span class="idlInterfaceID">Element</span> {
<span class="idlMethod">    <span class="idlMethType"><a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a></span> <span class="idlMethName"><a href="#widl-Element-createShadowRoot-ShadowRoot">createShadowRoot</a></span> ();</span>
<span class="idlMethod">    <span class="idlMethType">NodeList</span>   <span class="idlMethName"><a href="#widl-Element-getDestinationInsertionPoints-NodeList">getDestinationInsertionPoints</a></span> ();</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType"><a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a>?</span> <span class="idlAttrName"><a href="#widl-Element-shadowRoot">shadowRoot</a></span>;</span>
};</span></pre><section id="attributes-1"><h4 aria-level="3" role="heading" id="h4_attributes-1"><span class="secno">9.2.1 </span>Attributes</h4><dl class="attributes"><dt id="widl-Element-shadowRoot"><code>shadowRoot</code> of type <span class="idlAttrType"><a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a></span>, readonly   , nullable</dt><dd>
            <p>Represents the <a href="#dfn-youngest-shadow-root" class="internalDFN">youngest shadow root</a> that <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> <a href="#dfn-hosts" class="internalDFN">hosts</a>.</p>
            <p>On getting, the attribute <strong>must</strong> return the <a href="#dfn-youngest-shadow-root" class="internalDFN">youngest shadow root</a> that <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> <a href="#dfn-hosts" class="internalDFN">hosts</a>, or <strong>null</strong> if no such <a href="#dfn-shadow-root" class="internalDFN">shadow root</a> is accessible.</p>
            <p>For <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics" class="externalDFN">HTML elements</a>, the <a href="#html-elements-and-their-shadow-trees">UA-provided</a> <a title="shadow tree" href="#dfn-shadow-tree" class="internalDFN">shadow trees</a> <strong>must not</strong> be accessible.</p>
          </dd></dl></section><section id="methods-1"><h4 aria-level="3" role="heading" id="h4_methods-1"><span class="secno">9.2.2 </span>Methods</h4><dl class="methods"><dt id="widl-Element-createShadowRoot-ShadowRoot"><code>createShadowRoot</code></dt><dd>
            When invoked, these steps <strong>must</strong> be run:
            <ol>
              <li>Create a new instance of the <a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a> object</li>
              <li>Add the <a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a> object to the <a title="shadow roots list" href="#dfn-shadow-roots-list" class="internalDFN">ordered list of shadow roots</a> associated with the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> as the <a href="#dfn-youngest-shadow-root" class="internalDFN">youngest shadow root</a></li>
              <li>Return <a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a> object.</li>
            </ol>
          <div><em>No parameters.</em></div><div><em>Return type: </em><code><a href="#idl-def-ShadowRoot" class="idlType"><code>ShadowRoot</code></a></code></div></dd><dt id="widl-Element-getDestinationInsertionPoints-NodeList"><code>getDestinationInsertionPoints</code></dt><dd>When invoked, the method <strong>must</strong> return a <a href="http://dom.spec.whatwg.org/#concept-collection-static" class="externalDFN">static</a> <a href="http://dom.spec.whatwg.org/#nodelist" class="externalDFN"><code>NodeList</code></a> consisting of <a title="insertion point" href="#dfn-insertion-point" class="internalDFN">insertion points</a> in the <a href="#dfn-destination-insertion-points" class="internalDFN">destination insertion points</a> of the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a>.<div><em>No parameters.</em></div><div><em>Return type: </em><code>NodeList</code></div></dd></dl></section>
      </section>

      <section id="the-content-element">
        <h3 aria-level="2" role="heading" id="h3_the-content-element"><span class="secno">9.3 </span>The <code>content</code> element</h3>

        <p>The <code><dfn title="content element" id="dfn-content-element">content</dfn></code> element represents an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a> in the <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>

        <p>If a <code>content</code> element does not satisfy the condition of an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a>, it <strong>must</strong> have the same rendering behavior as the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#htmlunknownelement" class="externalDFN"><code>HTMLUnknownElement</code></a>.</p>

        <dl>
          <dt>Context</dt>
          <dd>Where <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#flow-content-0" class="externalDFN">flow content</a> is expected.</dd>

          <dt>Content model</dt>
          <dd><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#transparent" class="externalDFN">Transparent</a></dd>

          <dt>Children</dt>
          <dd>Anything as fallback content</dd>

          <dt>Content attributes</dt>
          <dd><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#global-attributes" class="externalDFN">Global attributes</a></dd>
          <dd>
            <dl>
              <dt><code><dfn title="content element select" id="dfn-content-element-select">select</dfn></code>, a <a title="comma separated tokens" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#comma-separated-tokens" class="externalDFN">set of comma-separated tokens</a></dt>
              <dd>Represents the <a href="#dfn-matching-criteria" class="internalDFN">matching criteria</a> for <a title="distribution" href="#dfn-distribution" class="internalDFN">distributing</a> child <a title="node" href="http://dom.spec.whatwg.org/#concept-node" class="externalDFN">nodes</a> of the <a href="#dfn-shadow-host" class="internalDFN">shadow host</a>. Each token <strong>must</strong> be a <a href="http://dev.w3.org/csswg/selectors4/#compound" class="externalDFN">compound selector</a>.</dd>
            </dl>
          </dd>

          <dt>DOM Interface</dt>
          <dd>
            <pre class="idl"><span class="idlInterface" id="idl-def-HTMLContentElement">interface <span class="idlInterfaceID">HTMLContentElement</span> : <span class="idlSuperclass">HTMLElement</span> {
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span> <span class="idlAttrName"><a href="#widl-HTMLContentElement-select">select</a></span>;</span>
<span class="idlMethod">    <span class="idlMethType">NodeList</span> <span class="idlMethName"><a href="#widl-HTMLContentElement-getDistributedNodes-NodeList">getDistributedNodes</a></span> ();</span>
};</span></pre><section><h4 id="attributes-3" aria-level="3" role="heading">Attributes</h4><dl class="attributes"><dt id="widl-HTMLContentElement-select"><code>select</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd><strong>Must</strong> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect" class="externalDFN">reflect</a> the <a href="#dfn-content-element-select">select</a> attribute.</dd></dl></section><section><h4 id="methods-2" aria-level="3" role="heading">Methods</h4><dl class="methods"><dt id="widl-HTMLContentElement-getDistributedNodes-NodeList"><code>getDistributedNodes</code></dt><dd>
                When invoked, it <strong>must</strong> return result of running the following steps:
                <ol>
                  <li>
                    If the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> is a <a href="#dfn-content-insertion-point" class="internalDFN">content insertion point</a>:
                    <ol>
                      <li>Return a <a href="http://dom.spec.whatwg.org/#concept-collection-static" class="externalDFN">static</a> <a href="http://dom.spec.whatwg.org/#nodelist" class="externalDFN"><code>NodeList</code></a> consisting of nodes in the <a href="#dfn-distributed-nodes" class="internalDFN">distributed nodes</a> of the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a>.</li>
                    </ol>
                  </li>
                  <li>
                    Otherwise:
                    <ol>
                      <li>Return an empty <a href="http://dom.spec.whatwg.org/#concept-collection-static" class="externalDFN">static</a> <a href="http://dom.spec.whatwg.org/#nodelist" class="externalDFN"><code>NodeList</code></a>.</li>
                    </ol>
                  </li>
                </ol>
              <div><em>No parameters.</em></div><div><em>Return type: </em><code>NodeList</code></div></dd></dl></section>
          </dd>
        </dl>
      </section>

      <section id="the-shadow-element">
        <h3 aria-level="2" role="heading" id="h3_the-shadow-element"><span class="secno">9.4 </span>The <code>shadow</code> element</h3>

        <p>The <code><dfn title="shadow element" id="dfn-shadow-element">shadow</dfn></code> element represents an <a href="#dfn-shadow-insertion-point" class="internalDFN">shadow insertion point</a> in a <a href="#dfn-shadow-tree" class="internalDFN">shadow tree</a>.</p>
        <p>If a <code>shadow</code> element does not satisfy the condition of an <a href="#dfn-insertion-point" class="internalDFN">insertion point</a>, it <strong>must</strong> have the same rendering behavior as the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#htmlunknownelement" class="externalDFN"><code>HTMLUnknownElement</code></a>.</p>

        <dl>
          <dt>Context</dt>
          <dd>Where <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#flow-content-0" class="externalDFN">flow content</a> is expected.</dd>

          <dt>Content model</dt>
          <dd><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#transparent" class="externalDFN">Transparent</a></dd>

          <dt>Children</dt>
          <dd>Anything</dd>

          <dt>DOM Interface</dt>
          <dd>
            <pre class="idl"><span class="idlInterface" id="idl-def-HTMLShadowElement">interface <span class="idlInterfaceID">HTMLShadowElement</span> : <span class="idlSuperclass">HTMLElement</span> {
<span class="idlMethod">    <span class="idlMethType">NodeList</span> <span class="idlMethName"><a href="#widl-HTMLShadowElement-getDistributedNodes-NodeList">getDistributedNodes</a></span> ();</span>
};</span></pre><section><h4 id="methods-3" aria-level="3" role="heading">Methods</h4><dl class="methods"><dt id="widl-HTMLShadowElement-getDistributedNodes-NodeList"><code>getDistributedNodes</code></dt><dd>
                When invoked, it <strong>must</strong> return result of running the following steps:
                <ol>
                  <li>
                    If the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a> is a <a href="#dfn-shadow-insertion-point" class="internalDFN">shadow insertion point</a>:
                    <ol>
                      <li>Return a <a href="http://dom.spec.whatwg.org/#concept-collection-static" class="externalDFN">static</a> <a href="http://dom.spec.whatwg.org/#nodelist" class="externalDFN"><code>NodeList</code></a> consisting of nodes in the <a href="#dfn-distributed-nodes" class="internalDFN">distributed nodes</a> of the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a>.</li>
                    </ol>
                  </li>
                  <li>
                    Otherwise:
                    <ol>
                      <li>Return an empty <a href="http://dom.spec.whatwg.org/#concept-collection-static" class="externalDFN">static</a> <a href="http://dom.spec.whatwg.org/#nodelist" class="externalDFN"><code>NodeList</code></a>.</li>
                    </ol>
                  </li>
                </ol>
              <div><em>No parameters.</em></div><div><em>Return type: </em><code>NodeList</code></div></dd></dl></section>
          </dd>
        </dl>
      </section>

      <section id="extensions-to-event-interface">
        <h3 aria-level="2" role="heading" id="h3_extensions-to-event-interface"><span class="secno">9.5 </span>Extensions to <code>Event</code> Interface</h3>

        <pre class="idl"><span class="idlInterface" id="idl-def-Event">partial interface <span class="idlInterfaceID">Event</span> {
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType">object</span> <span class="idlAttrName"><a href="#widl-Event-path">path</a></span>;</span>
};</span></pre><section id="attributes-2"><h4 aria-level="3" role="heading" id="h4_attributes-2"><span class="secno">9.5.1 </span>Attributes</h4><dl class="attributes"><dt id="widl-Event-path"><code>path</code> of type <span class="idlAttrType">object</span>, readonly   </dt><dd>
            <p>Represents the event path.</p>
            <p>
              On getting, the attribute <strong>must</strong> create and return a new JavaScript Array object, that is a copy of the event path for the <a href="http://dom.spec.whatwg.org/#context-object" class="externalDFN">context object</a>.
            </p>
            <div class="issue"><div class="issue-title" aria-level="4" role="heading" id="h_issue_1"><span>Issue 1</span></div><p class="">
              Use <code>Array</code> as the return type of the <code>path</code> attribute in WebIDL.
              WebIDL bugs: <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=20020"><code>Array</code> subclassing</a>
              and <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=23225">class, not interface</a>.
            </p></div>
          </dd></dl></section>
      </section>

    </section>

    <section id="shadow-dom-example">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_shadow-dom-example"><span class="secno">10. </span>Shadow DOM Example</h2>

      <p>Bob was asked to turn a simple list of links into a News Widget, which has links organized into two categories: breaking news and just news. The current document markup for the stories looks like this:</p>
      <div class="example"><div class="example-title"><span>Example 2</span></div><pre class="example highlight prettyprint prettyprinted"><span class="tag">&lt;ul</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"stories"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/1"</span><span class="tag">&gt;</span><span class="pln">A story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/2"</span><span class="tag">&gt;</span><span class="pln">Another story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/3"</span><span class="tag">&gt;</span><span class="pln">Also a story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/4"</span><span class="tag">&gt;</span><span class="pln">Yet another story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/4"</span><span class="tag">&gt;</span><span class="pln">Awesome story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/5"</span><span class="tag">&gt;</span><span class="pln">Horrible story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
</span><span class="tag">&lt;/ul&gt;</span></pre></div>

      <p>To organize the stories, Bob decides to use <strong>shadow DOM</strong>. Doing so will allow Bob to keep the document markup uncluttered, and harnessing the power of insertion point makes sorting stories by class name a very simple task. After getting another cup of <a href="http://en.wikipedia.org/wiki/List_of_coffee_beverages#Green_Eye">Green Eye</a>, he quickly mocks up the following shadow tree, to be hosted by the <code>ul</code> element:</p>
      <div class="example"><div class="example-title"><span>Example 3</span></div><pre class="example highlight prettyprint prettyprinted"><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;ul&gt;</span><span class="pln">
        </span><span class="tag">&lt;content</span><span class="pln"> </span><span class="atn">select</span><span class="pun">=</span><span class="atv">".breaking"</span><span class="tag">&gt;&lt;/content&gt;</span><span class="pln"> </span><span class="com">&lt;!-- insertion point for breaking news --&gt;</span><span class="pln">
    </span><span class="tag">&lt;/ul&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span><span class="pln">
</span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"other"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;ul&gt;</span><span class="pln">
        </span><span class="tag">&lt;content&gt;&lt;/content&gt;</span><span class="pln"> </span><span class="com">&lt;!-- insertion point for the rest of the news --&gt;</span><span class="pln">
    </span><span class="tag">&lt;/ul&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span></pre></div>
      <p>Bob then styles the newborn widget according to comps from the designer by adding this to the shadow tree mockup:</p>
      <div class="example"><div class="example-title"><span>Example 4</span></div><pre class="example highlight prettyprint prettyprinted"><span class="tag">&lt;style&gt;</span><span class="pln">
    div</span><span class="pun">.</span><span class="pln">breaking </span><span class="pun">{</span><span class="pln">
        color</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Red</span><span class="pun">;</span><span class="pln">
        font</span><span class="pun">-</span><span class="pln">size</span><span class="pun">:</span><span class="pln"> </span><span class="lit">20px</span><span class="pun">;</span><span class="pln">
        border</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1px</span><span class="pln"> dashed </span><span class="typ">Purple</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
    div</span><span class="pun">.</span><span class="pln">other </span><span class="pun">{</span><span class="pln">
        padding</span><span class="pun">:</span><span class="pln"> </span><span class="lit">2px</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln">
        border</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1px</span><span class="pln"> solid </span><span class="typ">Cyan</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
</span><span class="tag">&lt;/style&gt;</span></pre></div>
      <p>While pondering if his company should start looking for a new designer, Bob converts the mockup to code:</p>
      <div class="example"><div class="example-title"><span>Example 5</span></div><pre class="example highlight prettyprint prettyprinted"><span class="kwd">function</span><span class="pln"> createStoryGroup</span><span class="pun">(</span><span class="pln">className</span><span class="pun">,</span><span class="pln"> contentSelector</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> </span><span class="kwd">group</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'div'</span><span class="pun">);</span><span class="pln">
    </span><span class="kwd">group</span><span class="pun">.</span><span class="pln">className </span><span class="pun">=</span><span class="pln"> className</span><span class="pun">;</span><span class="pln">
    </span><span class="com">// Empty string in select attribute or absence thereof work the same, so no need for special handling.</span><span class="pln">
    </span><span class="kwd">group</span><span class="pun">.</span><span class="pln">innerHTML </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;ul&gt;&lt;content select="'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> contentSelector </span><span class="pun">+</span><span class="pln"> </span><span class="str">'"&gt;&lt;/content&gt;&lt;/ul&gt;'</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">group</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> createStyle</span><span class="pun">()</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> style </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'style'</span><span class="pun">);</span><span class="pln">
    style</span><span class="pun">.</span><span class="pln">textContent </span><span class="pun">=</span><span class="pln"> </span><span class="str">'div.breaking { color: Red;font-size: 20px; border: 1px dashed Purple; }'</span><span class="pln"> </span><span class="pun">+</span><span class="pln">
        </span><span class="str">'div.other { padding: 2px 0 0 0; border: 1px solid Cyan; }'</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> style</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> makeShadowTree</span><span class="pun">(</span><span class="pln">storyList</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> root </span><span class="pun">=</span><span class="pln"> storyList</span><span class="pun">.</span><span class="pln">createShadowRoot</span><span class="pun">();</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStyle</span><span class="pun">());</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStoryGroup</span><span class="pun">(</span><span class="str">'breaking'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'.breaking'</span><span class="pun">));</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStoryGroup</span><span class="pun">(</span><span class="str">'other'</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">));</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

document</span><span class="pun">.</span><span class="pln">addEventListener</span><span class="pun">(</span><span class="str">'DOMContentLoaded'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="pun">[].</span><span class="pln">forEach</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="pln">document</span><span class="pun">.</span><span class="pln">querySelectorAll</span><span class="pun">(</span><span class="str">'ul.stories'</span><span class="pun">),</span><span class="pln"> makeShadowTree</span><span class="pun">);</span><span class="pln">
</span><span class="pun">});</span></pre></div>

      <p>Well done, Bob! With the cup of coffee still half-full, the work is complete. Recognizing his awesomeness, Bob returns to teaching n00bs the ways of <a href="http://en.wikipedia.org/wiki/World_of_Warcraft">WoW</a>.</p>

      <p>A few months pass.</p>

      <p>It's election time. With Bob at his annual conference, Alice is charged with adding <strong>another</strong>, temporary box to the news widget, filled with election-related stories. Alice studies Bob's code, reads up on the shadow DOM spec and realizes that, thanks to multiple shadow tree support, she doesn't have to touch his code. As usual, her solution is elegant and simple, fitting neatly right under Bob's code:</p>
      <div class="example"><div class="example-title"><span>Example 6</span></div><pre class="example highlight prettyprint prettyprinted"><span class="com">// TODO(alice): BEGIN -- DELETE THIS CODE AFTER ELECTIONS ARE OVER.</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> ELECTION_BOX_REMOVAL_DEADLINE </span><span class="pun">=</span><span class="pln"> </span><span class="pun">...;</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> createElectionStyle</span><span class="pun">()</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> style </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'style'</span><span class="pun">);</span><span class="pln">
    </span><span class="com">// TODO(alice): Check designer's desk for hallucinogens.</span><span class="pln">
    style</span><span class="pun">.</span><span class="pln">textContent </span><span class="pun">=</span><span class="pln"> </span><span class="str">'div.election { color: Magenta; font-size: 24px; border: 2px dotted Fuchsia; }'</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> style</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> makeElectionShadowTree</span><span class="pun">(</span><span class="pln">storyList</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> root </span><span class="pun">=</span><span class="pln"> storyList</span><span class="pun">.</span><span class="pln">createShadowRoot</span><span class="pun">();</span><span class="pln">
    </span><span class="com">// Add and style election story box.</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createElectionStyle</span><span class="pun">());</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStoryGroup</span><span class="pun">(</span><span class="str">'election'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'.election'</span><span class="pun">));</span><span class="pln">
    </span><span class="com">// Insert Bob's shadow tree under the election story box.</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'shadow'</span><span class="pun">));</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Date</span><span class="pun">.</span><span class="pln">now</span><span class="pun">()</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> ELECTION_BOX_REMOVAL_DEADLINE</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    document</span><span class="pun">.</span><span class="pln">addEventListener</span><span class="pun">(</span><span class="str">'DOMContentLoaded'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="pun">[].</span><span class="pln">forEach</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="pln">document</span><span class="pun">.</span><span class="pln">querySelectorAll</span><span class="pun">(</span><span class="str">'ul.stories'</span><span class="pun">),</span><span class="pln"> makeElectionShadowTree</span><span class="pun">);</span><span class="pln">
    </span><span class="pun">});</span><span class="pln">
</span><span class="pun">}</span><span class="pln">
</span><span class="com">// TODO(alice): END -- DELETE THIS CODE AFTER ELECTIONS ARE OVER.</span></pre></div>
      <p>Using the <code>shadow</code> element allows Alice to compose Bob's widget <strong>inside</strong> of hers—without having to change a line of production code. Smiling to herself, Alice realizes that Bob may have come up with a way to keep the document markup clean, but <strong>she</strong> is the one who takes the cake for using shadow tree composition in such a cool way.</p>
    </section>

    <section class="appendix" id="acknowledgements">
      <!--OddPage--><h2 aria-level="1" role="heading" id="h2_acknowledgements"><span class="secno">A. </span>Acknowledgements</h2>

      <p><span class="vcard">David Hyatt</span> developed <a href="http://dev.w3.org/2006/xbl2/">XBL 1.0</a>, and <span class="vcard">Ian Hickson</span> co-wrote <a href="http://dev.w3.org/2006/xbl2/">XBL 2.0</a>. These documents provided tremendous insight into the problem of functional encapsulation and greatly influenced this specification.</p>

      <p><span class="vcard">Alex Russell</span> and his considerable forethought triggered a new wave of enthusiasm around the subject of shadow DOM and how it can be applied practically on the Web.</p>

      <p><span class="vcard">Dominic Cooney</span>, <span class="vcard">Hajime Morrita</span>, and <span class="vcard">Roland Steiner</span> worked tirelessly to scope the problem of functional encapsulation within the confines of the Web platform and provided a solid foundation for this document.</p>

      <p>The editor would also like to thank <span class="vcard">Alex Komoroske</span>, <span class="vcard">Anne van Kesteren</span>, <span class="vcard">Brandon Payton</span>, <span class="vcard">Brian Kardell</span>, <span class="vcard">Darin Fisher</span>, <span class="vcard">Eric Bidelman</span>, <span class="vcard">Deepak Sherveghar</span>, <span class="vcard">Edward O'Connor</span>, <span class="vcard">Elisée Maurer</span>, <span class="vcard">Elliott Sprehn</span>, <span class="vcard">Erik Arvidsson</span>, <span class="vcard">Glenn Adams</span>, <span class="vcard">Jonas Sicking</span>, <span class="vcard">Malte Ubl</span>, <span class="vcard">Mike Taylor</span>, <span class="vcard">Oliver Nightingale</span>, <span class="vcard">Olli Pettay</span>, <span class="vcard">Rafael Weinstein</span>, <span class="vcard">Richard Bradshaw</span>, <span class="vcard">Ruud Steltenpool</span>, <span class="vcard">Sam Dutton</span>, <span class="vcard">Sergey G. Grekhov</span>, <span class="vcard">Shinya Kawanaka</span>, <span class="vcard">Tab Atkins</span>, <span class="vcard">Takashi Sakamoto</span>, and <span class="vcard">Yoshinori Sano</span> for their comments and contributions to this specification.</p>

      <p>This list is too short. There's a lot of work left to do. Please contribute by reviewing and filing bugs—and don't forget to ask the editor to add your name into this section.</p>
    </section>

  

<section id="references" class="appendix" typeof="bibo:Chapter" resource="#references" rel="bibo:Chapter"><!--OddPage--><h2 aria-level="1" role="heading" id="h2_references"><span class="secno">B. </span>References</h2><section id="normative-references" typeof="bibo:Chapter" resource="#normative-references" rel="bibo:Chapter"><h3 aria-level="2" role="heading" id="h3_normative-references"><span class="secno">B.1 </span>Normative references</h3><dl class="bibliography" about=""><dt id="bib-CSS3UI">[CSS3UI]</dt><dd rel="dcterms:requires">Tantek Çelik. <a href="http://www.w3.org/TR/css3-ui/"><cite>CSS3 Basic User Interface Module</cite></a>. 17 January 2012. W3C Working Draft. URL: <a href="http://www.w3.org/TR/css3-ui/">http://www.w3.org/TR/css3-ui/</a>
</dd><dt id="bib-CSSOM-VIEW">[CSSOM-VIEW]</dt><dd rel="dcterms:requires">Simon Pieters; Glenn Adams. <a href="http://www.w3.org/TR/cssom-view/"><cite>CSSOM View Module</cite></a>. 17 December 2013. W3C Working Draft. URL: <a href="http://www.w3.org/TR/cssom-view/">http://www.w3.org/TR/cssom-view/</a>
</dd><dt id="bib-DOM">[DOM]</dt><dd rel="dcterms:requires">Anne van Kesteren; Aryeh Gregor; Ms2ger. <a href="http://dom.spec.whatwg.org"><cite>DOM Standard</cite></a>. Living Standard. URL: <a href="http://dom.spec.whatwg.org">http://dom.spec.whatwg.org</a>
</dd><dt id="bib-DOM-Level-3-Events">[DOM-Level-3-Events]</dt><dd rel="dcterms:requires">Gary Kacmarcik; Travis Leithead; Jacob Rossi; Doug Schepers; Björn Höhrmann; Philippe Le Hégaret; Tom Pixley. <a href="http://www.w3.org/TR/DOM-Level-3-Events/"><cite>Document Object Model (DOM) Level 3 Events Specification</cite></a>. 5 November 2013. W3C Working Draft. URL: <a href="http://www.w3.org/TR/DOM-Level-3-Events/">http://www.w3.org/TR/DOM-Level-3-Events/</a>
</dd><dt id="bib-DOMPARSING">[DOMPARSING]</dt><dd rel="dcterms:requires">Ms2ger. <a href="http://domparsing.spec.whatwg.org/"><cite>DOM Parsing and Serialization</cite></a>. URL: <a href="http://domparsing.spec.whatwg.org/">http://domparsing.spec.whatwg.org/</a>
</dd><dt id="bib-EDITING">[EDITING]</dt><dd rel="dcterms:requires">Aryeh Gregor. <a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html"><cite>HTML Editing APIs</cite></a>. URL: <a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html">https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html</a>
</dd><dt id="bib-HTML">[HTML]</dt><dd rel="dcterms:requires">Ian Hickson. <a href="http://www.whatwg.org/specs/web-apps/current-work/"><cite>HTML</cite></a>. Living Standard. URL: <a href="http://www.whatwg.org/specs/web-apps/current-work/">http://www.whatwg.org/specs/web-apps/current-work/</a>
</dd><dt id="bib-RFC2119">[RFC2119]</dt><dd rel="dcterms:requires">S. Bradner. <a href="http://www.ietf.org/rfc/rfc2119.txt"><cite>Key words for use in RFCs to Indicate Requirement Levels.</cite></a> March 1997. Internet RFC 2119.  URL: <a href="http://www.ietf.org/rfc/rfc2119.txt">http://www.ietf.org/rfc/rfc2119.txt</a> 
</dd><dt id="bib-SELECTORS4">[SELECTORS4]</dt><dd rel="dcterms:requires">Elika Etemad; Tab Atkins Jr. <a href="http://dev.w3.org/csswg/selectors4/"><cite>Selectors Level 4</cite></a>. W3C Editor's Draft. URL: <a href="http://dev.w3.org/csswg/selectors4/">http://dev.w3.org/csswg/selectors4/</a>
</dd><dt id="bib-TOUCH-EVENTS">[TOUCH-EVENTS]</dt><dd rel="dcterms:requires">Doug Schepers; Sangwhan Moon; Matt Brubeck; Arthur Barstow. <a href="http://www.w3.org/TR/touch-events/"><cite>Touch Events</cite></a>. 10 October 2013. W3C Recommendation. URL: <a href="http://www.w3.org/TR/touch-events/">http://www.w3.org/TR/touch-events/</a>
</dd><dt id="bib-WAI-ARIA">[WAI-ARIA]</dt><dd rel="dcterms:requires">James Craig; Michael Cooper et al. <a href="http://www.w3.org/TR/wai-aria/"><cite>Accessible Rich Internet Applications (WAI-ARIA) 1.0</cite></a>. 20 March 2014. W3C Recommendation. URL: <a href="http://www.w3.org/TR/wai-aria/">http://www.w3.org/TR/wai-aria/</a>
</dd></dl></section></section></body></html>

<!DOCTYPE html>
<html lang="en" dir="ltr" typeof="bibo:Document w3p:WD" prefix="bibo: http://purl.org/ontology/bibo/ w3p: http://www.w3.org/2001/02pd/rec54#">
<head><meta property="dc:language" content="en" lang="">
    <meta charset="utf-8">
    <title>Shadow DOM</title>
    
    
    <style>/* --- EXAMPLES --- */
div.example-title {
    min-width: 7.5em;
    color: #b9ab2d;
}
div.example-title span {
    text-transform: uppercase;
}
aside.example, div.example, div.illegal-example {
    padding: 0.5em;
    margin: 1em 0;
    position: relative;
    clear: both;
}
div.illegal-example { color: red }
div.illegal-example p { color: black }
aside.example, div.example {
    padding: .5em;
    border-left-width: .5em;
    border-left-style: solid;
    border-color: #e0cb52;
    background: #fcfaee;
}

aside.example div.example {
    border-left-width: .1em;
    border-color: #999;
    background: #fff;
}
aside.example div.example div.example-title {
    color: #999;
}
</style><style>/* --- ISSUES/NOTES --- */
div.issue-title, div.note-title , div.ednote-title, div.warning-title {
    padding-right:  1em;
    min-width: 7.5em;
    color: #b9ab2d;
}
div.issue-title { color: #e05252; }
div.note-title, div.ednote-title { color: #2b2; }
div.warning-title { color: #f22; }
div.issue-title span, div.note-title span, div.ednote-title span, div.warning-title span {
    text-transform: uppercase;
}
div.note, div.issue, div.ednote, div.warning {
    margin-top: 1em;
    margin-bottom: 1em;
}
.note > p:first-child, .ednote > p:first-child, .issue > p:first-child, .warning > p:first-child { margin-top: 0 }
.issue, .note, .ednote, .warning {
    padding: .5em;
    border-left-width: .5em;
    border-left-style: solid;
}
div.issue, div.note , div.ednote,  div.warning {
    padding: 1em 1.2em 0.5em;
    margin: 1em 0;
    position: relative;
    clear: both;
}
span.note, span.ednote, span.issue, span.warning { padding: .1em .5em .15em; }

.issue {
    border-color: #e05252;
    background: #fbe9e9;
}
.note, .ednote {
    border-color: #52e052;
    background: #e9fbe9;
}

.warning {
    border-color: #f11;
    border-right-width: .2em;
    border-top-width: .2em;
    border-bottom-width: .2em;
    border-style: solid;
    background: #fbe9e9;
}

.warning-title:before{
    content: "⚠"; /*U+26A0 WARNING SIGN*/
    font-size: 3em;
    float: left;
    height: 100%;
    padding-right: .3em;
    vertical-align: top;
    margin-top: -0.5em;
}

li.task-list-item {
    list-style: none;
}

input.task-list-item-checkbox {
    margin: 0 0.35em 0.25em -1.6em;
    vertical-align: middle;
}
</style><style>/* HIGHLIGHTS */
code.prettyprint {
    color:  inherit;
}

/* this from google-code-prettify */
.pln{color:#000}@media screen{.str{color:#080}.kwd{color:#008}.com{color:#800}.typ{color:#606}.lit{color:#066}.pun,.opn,.clo{color:#660}.tag{color:#008}.atn{color:#606}.atv{color:#080}.dec,.var{color:#606}.fun{color:red}}@media print,projection{.str{color:#060}.kwd{color:#006;font-weight:bold}.com{color:#600;font-style:italic}.typ{color:#404;font-weight:bold}.lit{color:#044}.pun,.opn,.clo{color:#440}.tag{color:#006;font-weight:bold}.atn{color:#404}.atv{color:#060}}ol.linenums{margin-top:0;margin-bottom:0}li.L0,li.L1,li.L2,li.L3,li.L5,li.L6,li.L7,li.L8{list-style-type:none}li.L1,li.L3,li.L5,li.L7,li.L9{background:#eee}
</style><style>/* --- WEB IDL --- */
pre.idl {
    border-top: 1px solid #90b8de;
    border-bottom: 1px solid #90b8de;
    padding:    1em;
    line-height:    120%;
}

pre.idl::before {
    content:    "WebIDL";
    display:    block;
    width:      150px;
    background: #90b8de;
    color:  #fff;
    font-family:    sans-serif;
    padding:    3px;
    font-weight:    bold;
    margin: -1em 0 1em -1em;
}

.idlType {
    color:  #ff4500;
    font-weight:    bold;
    text-decoration:    none;
}

/*.idlModule*/
/*.idlModuleID*/
/*.idlInterface*/
.idlInterfaceID, .idlDictionaryID, .idlCallbackID, .idlEnumID {
    font-weight:    bold;
    color:  #005a9c;
}
a.idlEnumItem {
    color:  #000;
    border-bottom:  1px dotted #ccc;
    text-decoration: none;
}

.idlSuperclass {
    font-style: italic;
    color:  #005a9c;
}

/*.idlAttribute*/
.idlAttrType, .idlFieldType, .idlMemberType {
    color:  #005a9c;
}
.idlAttrName, .idlFieldName, .idlMemberName {
    color:  #ff4500;
}
.idlAttrName a, .idlFieldName a, .idlMemberName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlMethod*/
.idlMethType, .idlCallbackType {
    color:  #005a9c;
}
.idlMethName {
    color:  #ff4500;
}
.idlMethName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlCtor*/
.idlCtorName {
    color:  #ff4500;
}
.idlCtorName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlParam*/
.idlParamType {
    color:  #005a9c;
}
.idlParamName, .idlDefaultValue {
    font-style: italic;
}

.extAttr {
    color:  #666;
}

/*.idlSectionComment*/
.idlSectionComment {
    color: gray;
}

/*.idlIterable*/
.idlIterableKeyType, .idlIterableValueType {
    color:  #005a9c;
}

/*.idlMaplike*/
.idlMaplikeKeyType, .idlMaplikeValueType {
    color:  #005a9c;
}

/*.idlConst*/
.idlConstType {
    color:  #005a9c;
}
.idlConstName {
    color:  #ff4500;
}
.idlConstName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlException*/
.idlExceptionID {
    font-weight:    bold;
    color:  #c00;
}

.idlTypedefID, .idlTypedefType {
    color:  #005a9c;
}

.idlRaises, .idlRaises a.idlType, .idlRaises a.idlType code, .excName a, .excName a code {
    color:  #c00;
    font-weight:    normal;
}

.excName a {
    font-family:    monospace;
}

.idlRaises a.idlType, .excName a.idlType {
    border-bottom:  1px dotted #c00;
}

.excGetSetTrue, .excGetSetFalse, .prmNullTrue, .prmNullFalse, .prmOptTrue, .prmOptFalse {
    width:  45px;
    text-align: center;
}
.excGetSetTrue, .prmNullTrue, .prmOptTrue { color:  #0c0; }
.excGetSetFalse, .prmNullFalse, .prmOptFalse { color:  #c00; }

.idlImplements a {
    font-weight:    bold;
}

dl.attributes, dl.methods, dl.constants, dl.constructors, dl.fields, dl.dictionary-members {
    margin-left:    2em;
}

.attributes dt, .methods dt, .constants dt, .constructors dt, .fields dt, .dictionary-members dt {
    font-weight:    normal;
}

.attributes dt code, .methods dt code, .constants dt code, .constructors dt code, .fields dt code, .dictionary-members dt code {
    font-weight:    bold;
    color:  #000;
    font-family:    monospace;
}

.attributes dt code, .fields dt code, .dictionary-members dt code {
    background:  #ffffd2;
}

.attributes dt .idlAttrType code, .fields dt .idlFieldType code, .dictionary-members dt .idlMemberType code {
    color:  #005a9c;
    background:  transparent;
    font-family:    inherit;
    font-weight:    normal;
    font-style: italic;
}

.methods dt code {
    background:  #d9e6f8;
}

.constants dt code {
    background:  #ddffd2;
}

.constructors dt code {
    background:  #cfc;
}

.attributes dd, .methods dd, .constants dd, .constructors dd, .fields dd, .dictionary-members dd {
    margin-bottom:  1em;
}

table.parameters, table.exceptions {
    border-spacing: 0;
    border-collapse:    collapse;
    margin: 0.5em 0;
    width:  100%;
}
table.parameters { border-bottom:  1px solid #90b8de; }
table.exceptions { border-bottom:  1px solid #deb890; }

.parameters th, .exceptions th {
    color:  #fff;
    padding:    3px 5px;
    text-align: left;
    font-weight:    normal;
    text-shadow:    #666 1px 1px 0;
}
.parameters th { background: #90b8de; }
.exceptions th { background: #deb890; }

.parameters td, .exceptions td {
    padding:    3px 10px;
    border-top: 1px solid #ddd;
    vertical-align: top;
}

.parameters tr:first-child td, .exceptions tr:first-child td {
    border-top: none;
}

.parameters td.prmName, .exceptions td.excName, .exceptions td.excCodeName {
    width:  100px;
}

.parameters td.prmType {
    width:  120px;
}

table.exceptions table {
    border-spacing: 0;
    border-collapse:    collapse;
    width:  100%;
}
</style><link rel="stylesheet" href="respec-complement.css" type="text/css">

<link rel="stylesheet" href="working-draft.css" type="text/css">
<script src="working-draft.js"></script>
    
  <style>/*****************************************************************
 * ReSpec 3 CSS
 * Robin Berjon - http://berjon.com/
 *****************************************************************/

/* --- INLINES --- */
em.rfc2119 { 
    text-transform:     lowercase;
    font-variant:       small-caps;
    font-style:         normal;
    color:              #900;
}

h1 acronym, h2 acronym, h3 acronym, h4 acronym, h5 acronym, h6 acronym, a acronym,
h1 abbr, h2 abbr, h3 abbr, h4 abbr, h5 abbr, h6 abbr, a abbr {
    border: none;
}

dfn {
    font-weight:    bold;
}

a.internalDFN {
    color:  inherit;
    border-bottom:  1px solid #99c;
    text-decoration:    none;
}

a.externalDFN {
    color:  inherit;
    border-bottom:  1px dotted #ccc;
    text-decoration:    none;
}

a.bibref {
    text-decoration:    none;
}

cite .bibref {
    font-style: normal;
}

code {
    color:  #C83500;
}

/* --- TOC --- */
.toc a, .tof a {
    text-decoration:    none;
}

a .secno, a .figno {
    color:  #000;
}

ul.tof, ol.tof {
    list-style: none outside none;
}

.caption {
    margin-top: 0.5em;
    font-style:   italic;
}

/* --- TABLE --- */
table.simple {
    border-spacing: 0;
    border-collapse:    collapse;
    border-bottom:  3px solid #005a9c;
}

.simple th {
    background: #005a9c;
    color:  #fff;
    padding:    3px 5px;
    text-align: left;
}

.simple th[scope="row"] {
    background: inherit;
    color:  inherit;
    border-top: 1px solid #ddd;
}

.simple td {
    padding:    3px 10px;
    border-top: 1px solid #ddd;
}

.simple tr:nth-child(even) {
    background: #f0f6ff;
}

/* --- DL --- */
.section dd > p:first-child {
    margin-top: 0;
}

.section dd > p:last-child {
    margin-bottom: 0;
}

.section dd {
    margin-bottom:  1em;
}

.section dl.attrs dd, .section dl.eldef dd {
    margin-bottom:  0;
}

@media print {
    .removeOnSave {
        display: none;
    }
}
</style><link href="https://www.w3.org/StyleSheets/TR/W3C-WD" rel="stylesheet"><!--[if lt IE 9]><script src='https://www.w3.org/2008/site/js/html5shiv.js'></script><![endif]--><script type="application/json" id="initialUserConfig">{
  "specStatus": "ED",
  "shortName": "shadow-dom",
  "editors": [
    {
      "name": "Dimitri Glazkov",
      "url": "mailto:dglazkov@chromium.org",
      "company": "Google, Inc."
    },
    {
      "name": "Hayato Ito",
      "url": "mailto:hayato@google.com",
      "company": "Google, Inc."
    }
  ],
  "wg": "W3C Web Applications (WebApps)",
  "wgURI": "http://www.w3.org/2008/webapps/",
  "wgPublicList": "public-webapps",
  "wgPatentURI": "",
  "edDraftURI": "http://w3c.github.io/webcomponents/spec/shadow/",
  "otherLinks": [
    {
      "key": "Revision history",
      "href": "https://github.com/w3c/webcomponents/commits/gh-pages/spec/shadow/"
    },
    {
      "key": "Bugs filed",
      "href": "https://github.com/w3c/webcomponents/labels/shadow-dom"
    }
  ],
  "preProcess": [
    null
  ],
  "localBiblio": {
    "EDITING": {
      "title": "HTML Editing APIs",
      "href": "https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html",
      "authors": [
        "Aryeh Gregor"
      ]
    }
  }
}</script></head>
  <body id="respecDocument" role="document" class="h-entry"><div id="respecHeader" role="contentinfo" class="head">
  <p>
      
        
            <a href="http://www.w3.org/"><img src="https://www.w3.org/Icons/w3c_home" alt="W3C" height="48" width="72"></a>
            
            
        
      
  </p>
  <h1 class="title p-name" id="title" property="dcterms:title">Shadow DOM</h1>
  
  <h2 id="w3c-working-draft-06-october-2015"><abbr title="World Wide Web Consortium">W3C</abbr> Working Draft <time property="dcterms:issued" class="dt-published" datetime="2015-10-06">06 October 2015</time></h2>
  <dl>
    
      <dt>This version:</dt>
      <dd><a class="u-url" href="http://www.w3.org/TR/2015/WD-shadow-dom-20151006/">http://www.w3.org/TR/2015/WD-shadow-dom-20151006/</a></dd>
      <dt>Latest published version:</dt>
      <dd><a href="http://www.w3.org/TR/shadow-dom/">http://www.w3.org/TR/shadow-dom/</a></dd>
    
    
      <dt>Latest editor's draft:</dt>
      <dd><a href="http://w3c.github.io/webcomponents/spec/shadow/">http://w3c.github.io/webcomponents/spec/shadow/</a></dd>
    
    
    
    
    
    
      <dt>Previous version:</dt>
      <dd><a rel="dcterms:replaces" href="http://www.w3.org/TR/2014/WD-shadow-dom-20140617/">http://www.w3.org/TR/2014/WD-shadow-dom-20140617/</a></dd>
    
    
    <dt>Editors:</dt>
    <dd class="p-author h-card vcard" property="bibo:editor" resource="_:editor0"><span property="rdf:first" typeof="foaf:Person"><meta property="foaf:name" content="Dimitri Glazkov"><a class="u-url url p-name fn" property="foaf:homepage" href="mailto:dglazkov@chromium.org">Dimitri Glazkov</a>, Google, Inc.</span>
<span property="rdf:rest" resource="_:editor1"></span>
</dd>
<dd class="p-author h-card vcard" resource="_:editor1"><span property="rdf:first" typeof="foaf:Person"><meta property="foaf:name" content="Hayato Ito"><a class="u-url url p-name fn" property="foaf:homepage" href="mailto:hayato@google.com">Hayato Ito</a>, Google, Inc.</span>
<span property="rdf:rest" resource="rdf:nil"></span>
</dd>

    
    
      
        
          <dt>Revision history:</dt>
          
            
              
                <dd>
                  <a href="https://github.com/w3c/webcomponents/commits/gh-pages/spec/shadow/">https://github.com/w3c/webcomponents/commits/gh-pages/spec/shadow/</a>
                </dd>
              
            
          
        
      
        
          <dt>Bugs filed:</dt>
          
            
              
                <dd>
                  <a href="https://github.com/w3c/webcomponents/labels/shadow-dom">https://github.com/w3c/webcomponents/labels/shadow-dom</a>
                </dd>
              
            
          
        
      
    
  </dl>
  
  
  
  
    
      <p class="copyright">
        <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> ©
        2015
        
        <a href="http://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>®</sup>
        (<a href="http://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>,
        <a href="http://www.ercim.eu/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>,
        <a href="http://www.keio.ac.jp/">Keio</a>, <a href="http://ev.buaa.edu.cn/">Beihang</a>). 
        
        <abbr title="World Wide Web Consortium">W3C</abbr> <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>,
        <a href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and
        
          <a href="http://www.w3.org/Consortium/Legal/copyright-documents">document use</a>
        
        rules apply.
      </p>
    
  
  <hr>
</div>
    <section property="dc:abstract" class="introductory" id="abstract"><h2 resource="#h-abstract" id="h-abstract"><span property="xhv:role" resource="xhv:heading">Abstract</span></h2>
      <p>
        This specification describes a method of combining multiple DOM trees into one hierarchy and how these trees interact with each other within a document, thus
        enabling better composition of the DOM.
      </p>
    </section><section id="sotd" class="introductory"><h2 resource="#h-sotd" id="h-sotd"><span property="xhv:role" resource="xhv:heading">Status of This Document</span></h2>
  


      <div id="wipcontainer">
        <p class="stability" id="wip">
          <strong>This is a work in progress!</strong>
          This specification is for review and not for implementation! For the latest updates,
          including important bug fixes, please look at the
          <a href="http://w3c.github.io/webcomponents/spec/shadow/">draft on GitHub</a> instead.
          <input onclick="hideWIP(this)" value="×" type="button">
        </p>
      </div>
    
      
        <p>
          <em>This section describes the status of this document at the time of its publication. Other documents may supersede this document. A list of current <abbr title="World Wide Web Consortium">W3C</abbr> publications and the latest revision of this technical report can be found in the <a href="http://www.w3.org/TR/"><abbr title="World Wide Web Consortium">W3C</abbr> technical reports index</a> at http://www.w3.org/TR/.</em>
        </p>
        
          
          
    
          
          <p>
            This document was published by the <a href="http://www.w3.org/2008/webapps/"><abbr title="World Wide Web Consortium">W3C</abbr> Web Applications (WebApps)</a> as a Working Draft.
            
              This document is intended to become a <abbr title="World Wide Web Consortium">W3C</abbr> Recommendation.
            
            
              If you wish to make comments regarding this document, please send them to
              <a href="mailto:public-webapps@w3.org">public-webapps@w3.org</a>
              (<a href="mailto:public-webapps-request@w3.org?subject=subscribe">subscribe</a>,
              <a href="http://lists.w3.org/Archives/Public/public-webapps/">archives</a>).
            
            
            
            
            
              
              All comments are welcome.
              
            
          </p>
          
          
          
            <p>
              Publication as a Working Draft does not imply endorsement by the <abbr title="World Wide Web Consortium">W3C</abbr>
              Membership. This is a draft document and may be updated, replaced or obsoleted by other
              documents at any time. It is inappropriate to cite this document as other than work in
              progress.
            </p>
          
          
          
          <p>
            
              This document was produced by
              
              a group
               operating under the
              <a id="sotd_patent" property="w3p:patentRules" href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004 <abbr title="World Wide Web Consortium">W3C</abbr> Patent
              Policy</a>.
            
            
            
              
                <abbr title="World Wide Web Consortium">W3C</abbr> maintains a <a href="" rel="disclosure">public list of any patent
                disclosures</a>
              
              made in connection with the deliverables of
              
              the group; that page also includes
              
              instructions for disclosing a patent. An individual who has actual knowledge of a patent
              which the individual believes contains
              <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential
              Claim(s)</a> must disclose the information in accordance with
              <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section
              6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>.
            
            
          </p>
          
            <p>This document is governed by the <a id="w3c_process_revision" href="http://www.w3.org/2015/Process-20150901/">1 September 2015 <abbr title="World Wide Web Consortium">W3C</abbr> Process Document</a>.
            </p>
          
          
        
      
    
  
</section><section id="toc"><h2 resource="#h-toc" id="h-toc" class="introductory"><span property="xhv:role" resource="xhv:heading">Table of Contents</span></h2><ul id="respecContents" role="directory" class="toc"><li class="tocline"><a class="tocxref" href="#conformance"><span class="secno">1. </span>Conformance</a></li><li class="tocline"><a class="tocxref" href="#concepts"><span class="secno">2. </span>Concepts</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#shadow-trees"><span class="secno">2.1 </span>Shadow trees</a></li><li class="tocline"><a class="tocxref" href="#trees-of-trees"><span class="secno">2.2 </span>Trees of trees</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#example-tree-of-trees"><span class="secno">2.2.1 </span>Example tree of trees</a></li></ul></li><li class="tocline"><a class="tocxref" href="#composed-trees"><span class="secno">2.3 </span>Composed trees</a></li></ul></li><li class="tocline"><a class="tocxref" href="#distributions"><span class="secno">3. </span>Distributions</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#slots"><span class="secno">3.1 </span>Slots</a></li><li class="tocline"><a class="tocxref" href="#slotting-algorithm"><span class="secno">3.2 </span>Slotting Algorithm</a></li><li class="tocline"><a class="tocxref" href="#distributed-nodes-algorithm"><span class="secno">3.3 </span>Distributed Nodes Algorithm</a></li></ul></li><li class="tocline"><a class="tocxref" href="#composition"><span class="secno">4. </span>Composition</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#composition-algorithm"><span class="secno">4.1 </span>Composition Algorithm</a></li><li class="tocline"><a class="tocxref" href="#composition-example"><span class="secno">4.2 </span>Composition Example</a></li></ul></li><li class="tocline"><a class="tocxref" href="#events"><span class="secno">5. </span>Events</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#events-that-are-not-leaked-into-ancestor-trees"><span class="secno">5.1 </span>Events that are not leaked into ancestor trees</a></li><li class="tocline"><a class="tocxref" href="#event-paths"><span class="secno">5.2 </span>Event Paths</a></li><li class="tocline"><a class="tocxref" href="#event-paths-example"><span class="secno">5.3 </span>Event Paths Example</a></li><li class="tocline"><a class="tocxref" href="#event-retargeting"><span class="secno">5.4 </span>Event Retargeting</a></li><li class="tocline"><a class="tocxref" href="#retargeting-relatedtarget"><span class="secno">5.5 </span>Retargeting <code>relatedTarget</code></a></li><li class="tocline"><a class="tocxref" href="#retargeting-touch-events"><span class="secno">5.6 </span>Retargeting Touch Events</a></li><li class="tocline"><a class="tocxref" href="#retargeting-focus-events"><span class="secno">5.7 </span>Retargeting Focus Events</a></li><li class="tocline"><a class="tocxref" href="#event-path-trimming"><span class="secno">5.8 </span>Event Path Trimming</a></li><li class="tocline"><a class="tocxref" href="#event-dispatch"><span class="secno">5.9 </span>Event Dispatch</a></li><li class="tocline"><a class="tocxref" href="#event-retargeting-example"><span class="secno">5.10 </span>Event Retargeting Example</a></li></ul></li><li class="tocline"><a class="tocxref" href="#user-interaction"><span class="secno">6. </span>User Interaction</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#ranges-and-selections"><span class="secno">6.1 </span>Ranges and Selections</a></li><li class="tocline"><a class="tocxref" href="#focus-navigation"><span class="secno">6.2 </span>Focus Navigation</a></li><li class="tocline"><a class="tocxref" href="#active-element"><span class="secno">6.3 </span>Active Element</a></li><li class="tocline"><a class="tocxref" href="#editing"><span class="secno">6.4 </span>Editing</a></li><li class="tocline"><a class="tocxref" href="#assistive-technology"><span class="secno">6.5 </span>Assistive Technology</a></li><li class="tocline"><a class="tocxref" href="#hit-testing"><span class="secno">6.6 </span>Hit Testing</a></li></ul></li><li class="tocline"><a class="tocxref" href="#html-elements-in-shadow-trees"><span class="secno">7. </span>HTML Elements in Shadow Trees</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#inertness-of-html-elements-in-a-shadow-tree"><span class="secno">7.1 </span>Inertness of HTML Elements in a shadow tree</a></li><li class="tocline"><a class="tocxref" href="#attributes"><span class="secno">7.2 </span>Attributes</a></li></ul></li><li class="tocline"><a class="tocxref" href="#elements-and-dom-interfaces"><span class="secno">8. </span>Elements and DOM interfaces</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#the-shadowroot-interface"><span class="secno">8.1 </span>The <code>ShadowRoot</code> interface</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#attributes-1"><span class="secno">8.1.1 </span>Attributes</a></li><li class="tocline"><a class="tocxref" href="#methods"><span class="secno">8.1.2 </span>Methods</a></li></ul></li><li class="tocline"><a class="tocxref" href="#extensions-to-element-interface"><span class="secno">8.2 </span>Extensions to <code>Element</code> Interface</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#attributes-2"><span class="secno">8.2.1 </span>Attributes</a></li><li class="tocline"><a class="tocxref" href="#methods-1"><span class="secno">8.2.2 </span>Methods</a></li></ul></li><li class="tocline"><a class="tocxref" href="#shadowrootinit-dictionary"><span class="secno">8.3 </span><code>ShadowRootInit</code> dictionary</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#dictionary-shadowrootinit-members"><span class="secno">8.3.1 </span>Dictionary <span class="formerLink"><code>ShadowRootInit</code></span> Members</a></li></ul></li><li class="tocline"><a class="tocxref" href="#shadowrootmode-enum"><span class="secno">8.4 </span><code>ShadowRootMode</code> enum</a></li><li class="tocline"><a class="tocxref" href="#extensions-to-nondocumenttypechildnode-interface"><span class="secno">8.5 </span>Extensions to <code>NonDocumentTypeChildNode</code> Interface</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#attributes-3"><span class="secno">8.5.1 </span>Attributes</a></li></ul></li><li class="tocline"><a class="tocxref" href="#the-slot-element"><span class="secno">8.6 </span>The <code>slot</code> element</a></li><li class="tocline"><a class="tocxref" href="#extensions-to-eventinit-dictionary"><span class="secno">8.7 </span>Extensions to <span class="formerLink"><code>EventInit</code></span> Dictionary</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#dictionary-eventinit-members"><span class="secno">8.7.1 </span>Dictionary <span class="formerLink"><code>EventInit</code></span> Members</a></li></ul></li><li class="tocline"><a class="tocxref" href="#extensions-to-event-interface"><span class="secno">8.8 </span>Extensions to <code>Event</code> Interface</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#attributes-4"><span class="secno">8.8.1 </span>Attributes</a></li></ul></li></ul></li><li class="tocline"><a class="tocxref" href="#shadow-dom-example"><span class="secno">9. </span>Shadow DOM Example</a></li><li class="tocline"><a class="tocxref" href="#acknowledgements"><span class="secno">A. </span>Acknowledgements</a></li><li class="tocline"><a class="tocxref" href="#references"><span class="secno">B. </span>References</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#normative-references"><span class="secno">B.1 </span>Normative references</a></li><li class="tocline"><a class="tocxref" href="#informative-references"><span class="secno">B.2 </span>Informative references</a></li></ul></li></ul></section>

    

    <section property="bibo:hasPart" resource="#conformance" typeof="bibo:Chapter" id="conformance">
      <!--OddPage--><h2 resource="#h-conformance" id="h-conformance"><span property="xhv:role" resource="xhv:heading"><span class="secno">1. </span>Conformance</span></h2>

      <p>All diagrams, examples, notes, are non-normative, as well as sections explicitly marked as non-normative. Everything else in this specification is normative.</p>

      <p>The key words "<em title="MUST" class="rfc2119">MUST</em>", "<em title="MUST NOT" class="rfc2119">MUST NOT</em>", "<em title="REQUIRED" class="rfc2119">REQUIRED</em>", "<em title="SHALL" class="rfc2119">SHALL</em>", "<em title="SHALL NOT" class="rfc2119">SHALL NOT</em>", "<em title="SHOULD" class="rfc2119">SHOULD</em>", "<em title="SHOULD NOT" class="rfc2119">SHOULD NOT</em>", "<em title="RECOMMENDED" class="rfc2119">RECOMMENDED</em>", "<em title="MAY" class="rfc2119">MAY</em>", and "<em title="OPTIONAL" class="rfc2119">OPTIONAL</em>" in the normative parts of this document are to be interpreted as described in [<cite><a href="#bib-RFC2119" class="bibref">RFC2119</a></cite>]. For readability, these words do not appear in all uppercase letters in this specification.</p>

      <p>To help with layering and to avoid circular dependencies between various parts of specification, this document consists of three consecutive narratives:</p>
      <ol>
        <li>setting up the stage for the specification,</li>
        <li>explaining of the conceptual model and algorithms behind it, and</li>
        <li>expressing this model with DOM interfaces and HTML elements.</li>
      </ol>

      <p>In a sense, these parts can be viewed as <em>math</em>, which sets up the reasoning environment, <em>physics</em>, which is the theoretical reasoning about the concept, and <em>mechanics</em>, which is the practical application of this reasoning.</p>

      <p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="http://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence" data-dfn-type="dfn">processing equivalence</dfn> is a constraint imposed on the algorithm implementors, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>
    </section>

    <section property="bibo:hasPart" resource="#concepts" typeof="bibo:Chapter" id="concepts">
      <!--OddPage--><h2 resource="#h-concepts" id="h-concepts"><span property="xhv:role" resource="xhv:heading"><span class="secno">2. </span>Concepts</span></h2>

      <section property="bibo:hasPart" resource="#shadow-trees" typeof="bibo:Chapter" id="shadow-trees">
        <h3 resource="#h-shadow-trees" id="h-shadow-trees"><span property="xhv:role" resource="xhv:heading"><span class="secno">2.1 </span>Shadow trees</span></h3>

        <p>A <dfn id="dfn-document-tree" data-dfn-type="dfn">document tree</dfn> is a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> [<cite><a href="#bib-DOM" class="bibref">DOM</a></cite>] whose <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> is a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-document">document</a>.</p>

        <p>Any element can <dfn id="dfn-host" data-dfn-type="dfn">host</dfn> zero or one associated <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree" data-lt="node tree">node trees</a>, called a <dfn id="dfn-shadow-tree" data-dfn-type="dfn">shadow tree</dfn>.

        </p><p>A <dfn id="dfn-shadow-host" data-dfn-type="dfn">shadow host</dfn> is an element that <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> one <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree" data-lt="node tree">shadow tree</a>.

        </p><p>A shadow tree has an associated flag, called an <dfn id="dfn-encapsulation-mode" data-dfn-type="dfn">encapsulation mode</dfn>, which is either <dfn id="dfn-open" data-dfn-type="dfn">open</dfn> or <dfn id="dfn-closed" data-dfn-type="dfn">closed</dfn>.

        </p><p>A <dfn id="dfn-shadow-root" data-dfn-type="dfn">shadow root</dfn> is the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> of a shadow tree.</p>

        <p>
          A node <var>A</var> is called a <dfn id="dfn-deep-child" data-dfn-type="dfn">deep child</dfn> of a node <var>B</var>,
          if either <var>A</var> is a child of <var>B</var> or A is the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> node of the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a> that B <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a>.
        </p>

        <p>
          A node <var>A</var> is called a <dfn id="dfn-deep-descendant" data-dfn-type="dfn">deep descendant</dfn> of a node <var>B</var>,
          if either <var>A</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-deep-child">deep child</a> of <var>B</var>
          or <var>A</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-deep-child">deep child</a> of a node <var>C</var> that is a <a data-link-type="dfn" class="internalDFN" href="#dfn-deep-descendant">deep descendant</a> of <var>B</var>.
        </p>

        <p>
          An <dfn id="dfn-inclusive-deep-descendant" data-dfn-type="dfn">inclusive deep descendant</dfn> is a node or one of its <a data-link-type="dfn" class="internalDFN" href="#dfn-deep-descendant" data-lt="deep descendant">deep descendants</a>.
        </p>

        <p>
          A node <var>A</var> is called a <dfn id="dfn-deep-parent" data-dfn-type="dfn">deep parent</dfn> of a node <var>B</var>
          if and only if <var>B</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-deep-child">deep child</a> of <var>A</var>.
        </p>

        <p>
          A node <var>A</var> is called a <dfn id="dfn-deep-ancestor" data-dfn-type="dfn">deep ancestor</dfn> of a node <var>B</var>
          if and only if <var>B</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-deep-descendant">deep descendant</a> of <var>A</var>.
        </p>

        <p>
          An <dfn id="dfn-inclusive-deep-ancestor" data-dfn-type="dfn">inclusive deep ancestor</dfn> is a node or one of its <a data-link-type="dfn" class="internalDFN" href="#dfn-deep-ancestor" data-lt="deep ancestor">deep ancestors</a>.
        </p>

        <p>
          When an element is an <a data-link-type="dfn" class="internalDFN" href="#dfn-inclusive-deep-descendant">inclusive deep descendant</a> of a <a class="externalDFN" href="http://dom.spec.whatwg.org/#document-element">document element</a>, it is <dfn id="dfn-in-a-document-deeply" data-dfn-type="dfn">in a document deeply</dfn>.
        </p>

      </section>

      <section property="bibo:hasPart" resource="#trees-of-trees" typeof="bibo:Chapter" id="trees-of-trees">
        <h3 resource="#h-trees-of-trees" id="h-trees-of-trees"><span property="xhv:role" resource="xhv:heading"><span class="secno">2.2 </span>Trees of trees</span></h3>

        <p>A <dfn id="dfn-tree-of-trees" data-dfn-type="dfn">tree of trees</dfn> is a <a class="externalDFN" href="http://dom.spec.whatwg.org/#trees">tree</a> of <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree" data-lt="node tree">node trees</a>.</p>

        <div class="note"><div id="h-note1" role="heading" aria-level="4" class="note-title"><span>Note</span></div><p class="">
          The purpose of introducing a tree of trees here is to define algorithms easily in the following sections.
          This is a kind of a notation techchique to make the this specification simpler.
        </p></div>

        <p>Just like a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> is defined as <a class="externalDFN" href="http://dom.spec.whatwg.org/#trees" data-lt="tree">a set of relationships</a> between <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node" data-lt="node">nodes</a>,
          a <a data-link-type="dfn" class="internalDFN" href="#dfn-tree-of-trees">tree of trees</a> is similarly defined as a set of relationships between <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree" data-lt="node tree">node trees</a>:</p>
        <ul>
          <li>
            A <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> <var>A</var> is called a <dfn id="dfn-parent-tree" data-dfn-type="dfn">parent tree</dfn> of a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> <var>B</var> if B is a shadow tree and the shadow host which hosts <var>B</var> participates in <var>A</var>.
          </li>
          <li>
            A <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> <var>A</var> is called a <dfn id="dfn-preceding-sibling-tree" data-dfn-type="dfn">preceding sibling tree</dfn> of a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> <var>B</var> if all of the following conditions are satisfied:
            <ol>
              <li><var>A</var> and <var>B</var> share the same <a data-link-type="dfn" class="internalDFN" href="#dfn-parent-tree">parent tree</a>.</li>
              <li>The <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a> which <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> <var>A</var> is <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-preceding">preceding</a> the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a> which <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> <var>B</var>.</li>
            </ol>
          </li>
          <li>Other relationships and terms, such as <dfn id="dfn-root-tree" data-dfn-type="dfn">root tree</dfn>, <dfn id="dfn-child-tree" data-dfn-type="dfn">child tree</dfn>,
            <dfn id="dfn-descendant-tree" data-dfn-type="dfn">descendant tree</dfn>, <dfn id="dfn-inclusive-descendant-tree" data-dfn-type="dfn">inclusive descendant tree</dfn>,
            <dfn id="dfn-ancestor-tree" data-dfn-type="dfn">ancestor tree</dfn>, <dfn id="dfn-inclusive-ancestor-tree" data-dfn-type="dfn">inclusive ancestor tree</dfn>,
            <dfn id="dfn-preceding-tree" data-dfn-type="dfn">preceding tree</dfn>
            are defined in the similar way as defined in <a class="externalDFN" href="http://dom.spec.whatwg.org/#trees" data-lt="tree">trees</a>.</li>
        </ul>

        <p>
          A <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> <var>A</var> is called an <dfn id="dfn-unclosed-tree" data-dfn-type="dfn">unclosed tree</dfn> of a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> <var>B</var> if and only if one, at least, of the following conditions is satisfied:
        </p>

        <ul>
          <li><var>A</var> is an <a data-link-type="dfn" class="internalDFN" href="#dfn-inclusive-ancestor-tree">inclusive ancestor tree</a> of <var>B</var>.</li>
          <li>The <a data-link-type="dfn" class="internalDFN" href="#dfn-encapsulation-mode">encapsulation mode</a> of <var>A</var> is <a data-link-type="dfn" class="internalDFN" href="#dfn-open">open</a> and <var>A</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-child-tree">child tree</a> of <var>B</var>.</li>
          <li><var>A</var> is an <a data-link-type="dfn" class="internalDFN" href="#dfn-unclosed-tree">unclosed tree</a> of a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> <var>C</var> that is an <a data-link-type="dfn" class="internalDFN" href="#dfn-unclosed-tree">unclosed tree</a> of <var>B</var>.</li>
        </ul>

        <p>
          A node <var>A</var> is called an <dfn id="dfn-unclosed-node" data-dfn-type="dfn">unclosed node</dfn> of a node <var>B</var> if and only if the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> that <var>A</var> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-participate">participates</a> in
          is an <a data-link-type="dfn" class="internalDFN" href="#dfn-unclosed-tree">unclosed tree</a> of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> that <var>B</var> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-participate">participates</a> in.
        </p>

        <p>The <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-node-ownerdocument"><code>ownerDocument</code></a> property of a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> in a shadow tree <strong>must</strong> refers to the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-document">document</a> of the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a> which <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> the shadow tree.</p>

        <p><a class="externalDFN" href="http://html.spec.whatwg.org/#window"><code>Window</code></a> object <a class="externalDFN" href="http://html.spec.whatwg.org/#named-access-on-the-window-object" data-lt="named access on the window object">named properties</a> [<cite><a href="#bib-HTML" class="bibref">HTML</a></cite>] <strong>must</strong> access the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node" data-lt="node">nodes</a> in the <a data-link-type="dfn" class="internalDFN" href="#dfn-document-tree">document tree</a>.</p>

        <section property="bibo:hasPart" resource="#example-tree-of-trees" typeof="bibo:Chapter" id="example-tree-of-trees" class="informative">
          <h4 resource="#h-example-tree-of-trees" id="h-example-tree-of-trees"><span property="xhv:role" resource="xhv:heading"><span class="secno">2.2.1 </span>Example tree of trees</span></h4><p><em>This section is non-normative.</em></p>

          <figure id="fig-a-tree-of-trees.x">
            <object data="tree-of-trees.svg" height="823" width="650"></object>
            <figcaption>Fig. <span class="figno">1</span> <span class="fig-title">
              A tree of trees.
            </span></figcaption>
          </figure>

          <p>
            In the figure, there are six node trees, named <code>A</code>, <code>B</code>, <code>C</code>, <code>D</code>, <code>E</code> and <code>F</code>.
            The shadow trees, <code>B</code>, <code>C</code> and <code>D</code>, are hosted by elements which participate in the document tree <code>A</code>.
            The shadow trees, <code>E</code> and <code>F</code>, are hosted by elements which participates in the shadow tree <code>D</code>.
            The following set of relationships holds in the figure:
          </p>
          <ul>
            <li>The ordered list of <code>A</code>'s <a data-link-type="dfn" class="internalDFN" href="#dfn-child-tree" data-lt="child tree">child trees</a> is [<code>B</code>, <code>C</code>, <code>D</code>].</li>
            <li>The ordered list of <code>B</code>'s <a data-link-type="dfn" class="internalDFN" href="#dfn-child-tree" data-lt="child tree">child trees</a> is [].</li>
            <li>The ordered list of <code>C</code>'s <a data-link-type="dfn" class="internalDFN" href="#dfn-child-tree" data-lt="child tree">child trees</a> is [].</li>
            <li>The ordered list of <code>D</code>'s <a data-link-type="dfn" class="internalDFN" href="#dfn-child-tree" data-lt="child tree">child trees</a> is [<code>E</code>, <code>F</code>].</li>
            <li>The ordered list of <code>E</code>'s <a data-link-type="dfn" class="internalDFN" href="#dfn-child-tree" data-lt="child tree">child trees</a> is [].</li>
            <li>The ordered list of <code>F</code>'s <a data-link-type="dfn" class="internalDFN" href="#dfn-child-tree" data-lt="child tree">child trees</a> is [].</li>
            <li>The document tree, <code>A</code>, is the <a data-link-type="dfn" class="internalDFN" href="#dfn-root-tree">root tree</a> of the <a data-link-type="dfn" class="internalDFN" href="#dfn-tree-of-trees">tree of trees</a>.</li>
          </ul>

          <div class="note"><div id="h-note2" role="heading" aria-level="5" class="note-title"><span>Note</span></div><div class="">
            <p>
              As for a relationship between nodes, it's worth mentioning that there is no <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-ancestor">ancestor</a>/<a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-descendant">descendant</a> relationships between two nodes if they participate in different node trees.
              A shadow root is not a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-child">child</a> node of the shadow host. The <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-parent">parent</a> node of a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a> doesn't exist.
              Because of this nature, most of existing APIs are <strong>scoped</strong> and don't affect other node trees, even though they are forming one tree of trees.
              For example, <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-nonelementparentnode-getelementbyid" data-lt="getElementById"><code>document.getElementById(elementId)</code></a> never returns an element in a shadow tree,
              even when the element has the given <code>elementId</code>.
            </p>
            <p>
              The same thing also applies to CSS <a class="externalDFN" href="http://dev.w3.org/csswg/selectors4/" data-lt="selectors">Selectors</a> matching.
              For example, a <a class="externalDFN" href="http://dev.w3.org/csswg/selectors4/#descendant-combinators" data-lt="descendant combinators">descendant combinator</a> never descends into a node in a <a data-link-type="dfn" class="internalDFN" href="#dfn-child-tree" data-lt="child tree">child</a> <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>
              because a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a> is not a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-child">child</a> node of the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a>.
              Unless a special CSS Selector for Shadow DOM, which is mentioned later, is used, a CSS Selector never matches an element in a different node tree.
            </p>
          </div></div>
          <div class="note"><div id="h-note3" role="heading" aria-level="5" class="note-title"><span>Note</span></div><p class="">
            Because <code>ShadowRoot</code> inherits <code>DocumentFragment</code>, as <a href="#idl-def-ShadowRoot">specified</a> later,
            you can use <code>ShadowRoot.getElementByID(elementId)</code> to get a node in the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.
          </p></div>
        </section>

      </section>

      <section property="bibo:hasPart" resource="#composed-trees" typeof="bibo:Chapter" id="composed-trees">
        <h3 resource="#h-composed-trees" id="h-composed-trees"><span property="xhv:role" resource="xhv:heading"><span class="secno">2.3 </span>Composed trees</span></h3>

        <p>A <dfn id="dfn-composed-tree" data-dfn-type="dfn">composed tree</dfn> is a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> which is constructed out of <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node" data-lt="node">nodes</a> from multiple <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree" data-lt="node tree">node trees</a> in a <a data-link-type="dfn" class="internalDFN" href="#dfn-tree-of-trees">tree of trees</a>.
          The exact algorithm of constructing a composed tree is specified later.</p>

        <figure id="fig-a-composed-tree">
          <object data="composed-tree.svg" height="606" width="654"></object>
          <figcaption>Fig. <span class="figno">2</span> <span class="fig-title">A composed tree</span></figcaption>
        </figure>

        <p>A <dfn id="dfn-document-composed-tree" data-dfn-type="dfn">document composed tree</dfn> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> whose root node is a document</p>

        <p>A node is <dfn id="dfn-in-a-document-composed-tree" data-dfn-type="dfn">in a document composed tree</dfn> if it participates in a <a data-link-type="dfn" class="internalDFN" href="#dfn-document-composed-tree">document composed tree</a>.</p>

        <p>
          Unless an element is <a data-link-type="dfn" class="internalDFN" href="#dfn-in-a-document-composed-tree">in a document composed tree</a>, the element <strong>must not</strong> create any CSS <a class="externalDFN" href="http://www.w3.org/TR/CSS21/box.html">box</a>.
        </p>
        <p>
          In resolving CSS <a class="externalDFN" href="http://www.w3.org/TR/css3-cascade/#inheritance">inheritance</a>, an element <strong>must</strong> inherit from the parent node in the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a>, if applicable.
        </p>
        <p>
          User agents <strong>must</strong> use the <a data-link-type="dfn" class="internalDFN" href="#dfn-document-composed-tree">document composed tree</a> in the <a class="externalDFN" href="http://www.w3.org/TR/CSS21/visuren.html">visual formatting model</a>, instead of the <a data-link-type="dfn" class="internalDFN" href="#dfn-document-tree">document tree</a>.
        </p>

        <div class="note"><div id="h-note4" role="heading" aria-level="4" class="note-title"><span>Note</span></div><div class="">
          <p>
            The editor's draft of CSS Scoping specification [<cite><a href="#bib-css-scoping-1" class="bibref">css-scoping-1</a></cite>] defines the selectors which are related to Shadow DOM.
            Specifically, it defines the following selectors related to Shadow DOM:
          </p>

          <ul>
            <li><code>::shadow</code> pseudo element</li>
            <li><code>/deep/</code> combinator,  which was replaced with a <code>&gt;&gt;&gt;</code> combinator (or <strong>shadow piercing descendant combinator</strong>)</li>
            <li><code>::content</code> pseudo-element</li>
            <li><code>:host</code> pseudo-class and <code>:host()</code> functional pseudo-class</li>
            <li><code>:host-context()</code> functional pseudo-class</li>
          </ul>
        </div></div>
      </section>

    </section>

    <section property="bibo:hasPart" resource="#distributions" typeof="bibo:Chapter" id="distributions">
      <!--OddPage--><h2 resource="#h-distributions" id="h-distributions"><span property="xhv:role" resource="xhv:heading"><span class="secno">3. </span>Distributions</span></h2>

      <section property="bibo:hasPart" resource="#slots" typeof="bibo:Chapter" id="slots">
        <h3 resource="#h-slots" id="h-slots"><span property="xhv:role" resource="xhv:heading"><span class="secno">3.1 </span>Slots</span></h3>

        <p>
          A <dfn id="dfn-slot" data-dfn-type="dfn">slot</dfn> is a defined location in a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a> into which some of a shadow host's children are inserted in its <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a>.
          The exact algorithm of constructing a <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> is specified later.
        </p>

        <p>
          A node can be <dfn id="dfn-assigned" data-dfn-type="dfn">assigned</dfn> to a slot, called an <dfn id="dfn-assigned-slot" data-dfn-type="dfn">assigned slot</dfn>. The exact algorithm of determining the <a data-link-type="dfn" class="internalDFN" href="#dfn-assigned-slot">assigned slot</a> for a node is specified later.
        </p>

        <p>A <dfn id="dfn-distribution" data-dfn-type="dfn">distribution</dfn> is the mechanism that determines which <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node" data-lt="node">nodes</a> appear at each <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>. The exact algorithm of a <a data-link-type="dfn" class="internalDFN" href="#dfn-distribution">distribution</a> is specified later.</p>

        <figure id="fig-a-distribution">
          <object data="distributions.svg" height="598" width="663"></object>
          <figcaption>Fig. <span class="figno">3</span> <span class="fig-title">A distribution</span></figcaption>
        </figure>

        <p>
          The <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-element">slot element</a> that satisfies the following condition defines a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a> at the location of the element:
        </p>
        <ul>
          <li>The <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> of the <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-element">slot element</a> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a></li>
        </ul>

        <p>
          A <dfn id="dfn-slot-name" data-dfn-type="dfn">slot name</dfn> is the name of a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>.
        </p>

        <p>
          A <dfn id="dfn-default-slot" data-dfn-type="dfn">default slot</dfn> is a slot whose <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-name">slot name</a> is the empty string or missing.
          If there are more than one slots which don't have a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-name">slot name</a> in the same <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>, the most <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-preceding">preceding</a> one is the <a data-link-type="dfn" class="internalDFN" href="#dfn-default-slot">default slot</a>. The others are not.
        </p>
      </section>

      <section property="bibo:hasPart" resource="#slotting-algorithm" typeof="bibo:Chapter" id="slotting-algorithm">
        <h3 resource="#h-slotting-algorithm" id="h-slotting-algorithm"><span property="xhv:role" resource="xhv:heading"><span class="secno">3.2 </span>Slotting Algorithm</span></h3>

        <p>
          The <dfn id="dfn-slotting-algorithm" data-dfn-type="dfn">slotting algorithm</dfn> <strong>must</strong> be used to determine the <a data-link-type="dfn" class="internalDFN" href="#dfn-assigned-slot">assigned slot</a> for a node and <strong>must</strong> be <a data-link-type="dfn" class="internalDFN" href="#dfn-processing-equivalence" data-lt="processing equivalence">equivalent</a> to processing the following steps:
        </p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>NODE</var>, a node</dd>
            <dt>Output</dt>
            <dd>(nullable) <var>SLOT</var>, a <var>slot</var> to where <var>NODE</var> is assigned.</dd>
          </dl>

          <ol>
            <li>
              If the parent node of <var>NODE</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a>:
              <ol>
                <li>Let <var>TREE</var> be the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a> that the parent node of <var>NODE</var> <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a></li>
                <li>Let <var>NAME</var> be the value of the <a href="#widl-Element-slot">slot attribute</a> of <var>NODE</var></li>
                <li>
                  If <var>NAME</var> is the empty string or missing:
                  <ol>
                    <li>Let <var>SLOT</var> be a <a data-link-type="dfn" class="internalDFN" href="#dfn-default-slot">default slot</a> for <var>TREE</var> if it exits, Otherwise, null</li>
                  </ol>
                </li>
                <li>
                  Otherwise:
                  <ol>
                    <li>Let <var>SLOT</var> be the most <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-preceding">preceding</a> <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a> in <var>TREE</var> whose <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-name">slot name</a> is <var>NAME</var> if it exists. Otherwise null.</li>
                  </ol>
                </li>
              </ol>
            </li>
            <li>
              Otherwise:
              <ol>
                <li>Let <var>SLOT</var> be null</li>
              </ol>
            </li>
          </ol>
        </div>
      </section>

      <section property="bibo:hasPart" resource="#distributed-nodes-algorithm" typeof="bibo:Chapter" id="distributed-nodes-algorithm">
        <h3 resource="#h-distributed-nodes-algorithm" id="h-distributed-nodes-algorithm"><span property="xhv:role" resource="xhv:heading"><span class="secno">3.3 </span>Distributed Nodes Algorithm</span></h3>

        <p>
          The <dfn id="dfn-get-distributed-nodes-algorithm" data-dfn-type="dfn">get distributed nodes algorithm</dfn> <strong>must</strong> be used to determine the <dfn id="dfn-distributed-nodes" data-dfn-type="dfn">distributed nodes</dfn> for a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a> and <strong>must</strong> be <a data-link-type="dfn" class="internalDFN" href="#dfn-processing-equivalence" data-lt="processing equivalence">equivalent</a> to processing the following steps:
        </p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>SLOT</var>, a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a></dd>
            <dt>Output</dt>
            <dd><var>DISTRIBUTED-NODES</var>, an ordered list of nodes.</dd>
          </dl>

          <ol>
            <li>Let <var>HOST</var> be a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a> which <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a> that <var>SLOT</var> participates in</li>
            <li>
              For each child node <var>NODE</var> of <var>HOST</var>:
              <ol>
                <li>
                  If <var>NODE</var> is assinged to <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">SLOT</a>:
                  <ol>
                    <li>
                      If <var>NODE</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>:
                      <ol>
                        <li>Let <var>SUB-LIST</var> be the result of (recursively) running the <a data-link-type="dfn" class="internalDFN" href="#dfn-get-distributed-nodes-algorithm">get distributed nodes algorithm</a> with <var>NODE</var> as input</li>
                        <li>Append all nodes in <var>SUB-LIST</var> to <var>DISTRIBUTED-NODES</var></li>
                      </ol>
                    </li>
                    <li>
                      Otherwise:
                      <ol>
                        <li>Append <var>NODE</var> to <var>DISTRIBUTED-NODES</var></li>
                      </ol>
                    </li>
                  </ol>
                </li>
              </ol>
            </li>
          </ol>
        </div>
      </section>
    </section>

    <section property="bibo:hasPart" resource="#composition" typeof="bibo:Chapter" id="composition">
      <!--OddPage--><h2 resource="#h-composition" id="h-composition"><span property="xhv:role" resource="xhv:heading"><span class="secno">4. </span>Composition</span></h2>

      <section property="bibo:hasPart" resource="#composition-algorithm" typeof="bibo:Chapter" id="composition-algorithm">
        <h3 resource="#h-composition-algorithm" id="h-composition-algorithm"><span property="xhv:role" resource="xhv:heading"><span class="secno">4.1 </span>Composition Algorithm</span></h3>


        <p>The <dfn id="dfn-composed-tree-children-calculation-algorithm" data-dfn-type="dfn">composed tree children calculation algorithm</dfn> <strong>must</strong> be used to determine the child nodes of a node in the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> and <strong>must</strong> be <a data-link-type="dfn" class="internalDFN" href="#dfn-processing-equivalence" data-lt="processing equivalence">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>NODE</var>, a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> which participates in a composed tree</dd>
            <dt>Output</dt>
            <dd><var>CHILDREN</var>, the child nodes of <var>NODE</var> in the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a>.</dd>
          </dl>

          <ol>
            <li>Let <var>CHILDREN</var> be an empty ordered list of nodes</li>
            <li>
              If <var>NODE</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a>:
              <ol>
                <li>Let <var>CHILD-POOL</var> be the child nodes of the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a> which <var>NODE</var> <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a></li>
              </ol>
            </li>
            <li>
              Otherwise:
              <ol>
                <li>Let <var>CHILD-POOL</var> be the child nodes of <var>NODE</var></li>
              </ol>
            </li>
            <li>
              For each <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a>, <var>CHILD</var>, in <var>CHILD-POOL</var>:
              <ol>
                <li>
                  If <var>CHILD</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>:
                  <ol>
                    <li>If <var>CHILD</var> is not assigned to any <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>:
                      <ol>
                        <li>Append all nodes of the <a data-link-type="dfn" class="internalDFN" href="#dfn-distributed-nodes">distributed nodes</a> of <var>CHILD</var> to <var>CHILDREN</var></li>
                      </ol>
                    </li>
                  </ol>
                </li>
                <li>Otherwise:
                  <ol>
                    <li>Append <var>CHILD</var> to <var>CHILDREN</var></li>
                  </ol>
                </li>
              </ol>
            </li>
          </ol>
        </div>

        <p>For a given <a data-link-type="dfn" class="internalDFN" href="#dfn-tree-of-trees">tree of trees</a> <var>TREE-OF-TREES</var>, the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> constructed from <var>TREE-OF-TREES</var> <strong>must</strong> be <a data-link-type="dfn" class="internalDFN" href="#dfn-processing-equivalence" data-lt="processing equivalence">equivalent</a> to the following tree:</p>
        <ul>
          <li>The <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> of the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> is the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> of the <a data-link-type="dfn" class="internalDFN" href="#dfn-root-tree">root tree</a> of <var>TREE-OF-TREES</var>.</li>
          <li>For a given <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> which <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-participate">participates</a> in the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a>, the child <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node" data-lt="node">nodes</a> of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> is the result of the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree-children-calculation-algorithm">composed tree children calculation algorithm</a> with the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> as input.
          </li>
        </ul>
      </section>

      <section property="bibo:hasPart" resource="#composition-example" typeof="bibo:Chapter" id="composition-example" class="informative">
        <h3 resource="#h-composition-example" id="h-composition-example"><span property="xhv:role" resource="xhv:heading"><span class="secno">4.2 </span>Composition Example</span></h3><p><em>This section is non-normative.</em></p>

        <p>
          Suppose that we have the following tree of trees:
        </p>

        <figure id="fig-an-example-tree-of-trees.-a-node-whose-color-is-red-represents-a-slot.-unlike-the-previous-figures-a-box-surrounding-a-node-tree-is-omitted-here.x">
          <object data="composition-tree-of-trees.svg" height="616" width="581"></object>
          <figcaption>Fig. <span class="figno">4</span> <span class="fig-title">An example tree of trees. A node whose color is red represents a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>. Unlike the previous figures, a box surrounding a node tree is omitted here. </span></figcaption>
        </figure>

        <p>
          This <a data-link-type="dfn" class="internalDFN" href="#dfn-tree-of-trees">tree of trees</a> is composed of the following 3 <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree" data-lt="node tree">node trees</a>, one <a data-link-type="dfn" class="internalDFN" href="#dfn-document-tree">document tree</a> and two <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree" data-lt="shadow tree">shadow trees</a>:
        </p>

        <table>
          <thead>
            <tr>
              <th>Node tree</th>
              <th>Root node is: </th>
              <th>Hosted by:</th>
              <th>Composed of: (in tree order)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>document tree 1</td>
              <td>A</td>
              <td>-</td>
              <td>A, B, C, D, E, F, G, H, I</td>
            </tr>
            <tr>
              <td>shadow tree 1</td>
              <td>J</td>
              <td>C</td>
              <td>J, K, L, M, N, O, P, Q</td>
            </tr>
            <tr>
              <td>shadow tree 2</td>
              <td>R</td>
              <td>N</td>
              <td>R, S, T</td>
            </tr>
          </tbody>
        </table>

        <p>
          Suppose that an assigned slot for each node, if it exists, is:
        </p>

        <ul>
          <li>(D =&gt; L) (You can read this as <strong>"D is assigned to L</strong>")</li>
          <li>(F =&gt; L)</li>
          <li>(H =&gt; O)</li>
          <li>(O =&gt; T)</li>
          <li>(P =&gt; T)</li>
        </ul>

        <figure id="fig-a-result-of-slotting.x">
          <object data="composition-slotting.svg" height="616" width="581"></object>
          <figcaption>Fig. <span class="figno">5</span> <span class="fig-title">A result of slotting.</span></figcaption>
        </figure>

        <p>
          Then, the distributed nodes for each slot will be:
        </p>

        <table>
          <thead>
            <tr>
              <th>Node tree</th>
              <th>Root node is: </th>
              <th>Hosted by:</th>
              <th>Composed of: (in tree order)</th>
              <th>Assigned Slot for a node</th>
              <th>Distributed nodes for a slot</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>document tree 1</td>
              <td>A</td>
              <td>-</td>
              <td>A, B, C, D, E, F, G, H, I</td>
              <td>(D =&gt; L), (F =&gt; L), (H =&gt; O)</td>
              <td>-</td>
            </tr>
            <tr>
              <td>shadow tree 1</td>
              <td>J</td>
              <td>C</td>
              <td>J, K, L, M, N, O, P, Q</td>
              <td>(O =&gt; T), (P =&gt; T)</td>
              <td>L &lt;= [D, F], M &lt;= [], O &lt;= [H]</td>
            </tr>
            <tr>
              <td>shadow tree 2</td>
              <td>R</td>
              <td>N</td>
              <td>R, S, T</td>
              <td>-</td>
              <td>T &lt;= [H, P] </td>
            </tr>
          </tbody>
        </table>

        <div class="note"><div id="h-note5" role="heading" aria-level="4" class="note-title"><span>Note</span></div><ul class="">
          <li>More than one nodes can be assigned to the same slot. e.g. (D =&gt; L), (F =&gt; L)</li>
          <li>A slot can be assigned to an other slot, e.g. (O =&gt; T)</li>
          <li>
            The distributed nodes for T are [H, P]. That aren't [O, P].
            A slot is never a member of distributed nodes of an other slot.
            If a slot <var>A</var> is assigned to an other slot <var>B</var>, the distributed nodes for <var>A</var> are appended to the distributed nodes for <var>B</var>,
            instead of <var>A</var> itself, as per the <a data-link-type="dfn" class="internalDFN" href="#dfn-get-distributed-nodes-algorithm">get distributed nodes algorithm</a>.
          </li>
        </ul></div>

        <p>
          The document composed tree will be:
        </p>

        <figure id="fig-document-composed-tree.x">
          <object data="composition-composed-tree.svg" height="526" width="256"></object>
          <figcaption>Fig. <span class="figno">6</span> <span class="fig-title">Document composed tree.</span></figcaption>
        </figure>

        <div class="note"><div id="h-note6" role="heading" aria-level="4" class="note-title"><span>Note</span></div><ul class="">
          <li>A slot never participates in a <a data-link-type="dfn" class="internalDFN" href="#dfn-document-composed-tree">document composed tree</a>. Neither a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a> does.</li>
          <li>Node G doesn't participate in the document composed tree. G is a child of a shadow host, but it's not assigned to any slot.</li>
          <li>In an extreme case, even if a document tree has more than 1,000 nodes, you can make the page *blank* by attaching a shadow root to the document element because a document composed tree is used in rendering.</li>
        </ul></div>
    </section>

    </section>

    <section property="bibo:hasPart" resource="#events" typeof="bibo:Chapter" id="events">
      <!--OddPage--><h2 resource="#h-events" id="h-events"><span property="xhv:role" resource="xhv:heading"><span class="secno">5. </span>Events</span></h2>

      <p>In each algorithm in this section, the <a class="externalDFN" href="http://html.spec.whatwg.org/#window">Window</a> <strong>must</strong> be considered as if it were the parent node of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-document">Document</a> so that the <a class="externalDFN" href="http://html.spec.whatwg.org/#window">Window</a> also receives an <a class="externalDFN" href="http://dom.spec.whatwg.org/#events">event</a>.</p>

      <p>When an <a class="externalDFN" href="http://dom.spec.whatwg.org/#events">event</a> is <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-event-dispatch" data-lt="event dispatch">dispatched</a> in a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>, its path either crosses the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree" data-lt="shadow tree">shadow trees</a> or is terminated at the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a>. One exception are the <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#interface-MutationEvent" data-lt="mutation event">mutation events</a>. The <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#interface-MutationEvent" data-lt="mutation event">mutation event types</a> <strong>must</strong> never be dispatched in a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.</p>

      <section property="bibo:hasPart" resource="#events-that-are-not-leaked-into-ancestor-trees" typeof="bibo:Chapter" id="events-that-are-not-leaked-into-ancestor-trees">
        <h3 resource="#h-events-that-are-not-leaked-into-ancestor-trees" id="h-events-that-are-not-leaked-into-ancestor-trees"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.1 </span>Events that are not leaked into ancestor trees</span></h3>

        <p>For the following events, <a data-link-type="dfn" class="internalDFN" href="#dfn-scoped-flag">scoped flag</a> is initialized to true by default if the events are dispatched by the user agent:</p>
        <ul>
          <li><code>abort</code></li>
          <li><code>error</code></li>
          <li><code>select</code></li>
          <li><code>change</code></li>
          <li><code>load</code></li>
          <li><code>reset</code></li>
          <li><code>resize</code></li>
          <li><code>scroll</code></li>
          <li><code>selectstart</code></li>
        </ul>

        <div id="issue-1" class="issue"><div id="h-issue1" role="heading" aria-level="4" class="issue-title"><span>Issue 1</span></div><p class="">
          Upstream this section into relevant specs, instead of having a fixed list here.
        </p></div>

      </section>

      <section property="bibo:hasPart" resource="#event-paths" typeof="bibo:Chapter" id="event-paths">
        <h3 resource="#h-event-paths" id="h-event-paths"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.2 </span>Event Paths</span></h3>

        <p>The <dfn id="dfn-event-path-calculation-algorithm" data-dfn-type="dfn">event path calculation algorithm</dfn> must be used to determine event path and <strong>must</strong> be <a data-link-type="dfn" class="internalDFN" href="#dfn-processing-equivalence" data-lt="processing equivalence">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>NODE</var>, a node</dd>
            <dd><var>EVENT</var>, an event</dd>
            <dt>Output</dt>
            <dd><var>PATH</var>, an event path, a ordered list of an event target</dd>
          </dl>
          <ol>
            <li>Let <var>PATH</var> be the empty ordered list of nodes</li>
            <li>Let <var>CURRENT</var> be <var>NODE</var></li>
            <li>
              Repeat while <var>CURRENT</var> exists:
              <ol>
                <li>Append <var>CURRENT</var> to <var>PATH</var></li>
                <li>
                  If all of the following conditions are satisfied, stop this algorithm:
                  <ol>
                    <li><var>CURRENT</var> is a shadow root</li>
                    <li><var>CURRENT</var> is the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> node of <var>NODE</var></li>
                    <li><var>EVENT</var>'s <a data-link-type="dfn" class="internalDFN" href="#dfn-scoped-flag">scoped flag</a> is set</li>
                  </ol>
                </li>
                <li>
                  If <var>CURRENT</var> is assigned to a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a> <var>SLOT</var>:
                  <ol>
                    <li>Let <var>CURRENT</var> be <var>SLOT</var></li>
                  </ol>
                </li>
                <li>
                  Otherwise:
                  <ol>
                    <li>Let <var>CURRENT</var> be the <a data-link-type="dfn" class="internalDFN" href="#dfn-deep-parent">deep parent</a> of <var>CURRENT</var></li>
                  </ol>
                </li>
              </ol>
            </li>
          </ol>
        </div>

        <div class="note"><div id="h-note7" role="heading" aria-level="4" class="note-title"><span>Note</span></div><p class="">
          For a <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#trusted-events" data-lt="trusted events">trusted event</a> that has a <code>relatedTarget</code> attribute, the event path would be trimmed. See the <a data-link-type="dfn" class="internalDFN" href="#dfn-event-path-trimming-algorithm">event path trimming algorithm</a>, which is specified later.
        </p></div>

      </section>

      <section property="bibo:hasPart" resource="#event-paths-example" typeof="bibo:Chapter" id="event-paths-example" class="informative">
        <h3 resource="#h-event-paths-example" id="h-event-paths-example"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.3 </span>Event Paths Example</span></h3><p><em>This section is non-normative.</em></p>

        <p>
          Let's re-use the same tree of trees used in the composition example section. Suppose that an event is dispatched on node <code>I</code>. The event path will be:
        </p>
        <p>
          <code>[I, H, O, T, S, R, N, J, C, A]</code>  (<a class="externalDFN" href="http://html.spec.whatwg.org/#window">Window</a> is omitted)
        </p>

        <p>
          It's worth pointing out that if we exclude all nodes which don't participate in the composed tree from the event path,
          the result would be equivalent to the inclusive ancestors of the node <code>I</code> in the composed tree.
        </p>

        <figure id="fig-the-relationship-between-the-composed-tree-and-an-event-path.-if-we-exclude-o-t-r-and-j-that-don-t-participate-in-the-composed-tree-from-the-event-path-the-result-would-be-equivalent-to-the-inclusive-ancestors-of-the-node-i-in-the-composed-tree.x">
          <object data="event-path-composed-tree.svg" height="560" width="580"></object>
          <figcaption>Fig. <span class="figno">7</span> <span class="fig-title">
            The relationship between the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> and an event path.
            If we exclude O, T, R and J, that don't participate in the composed tree, from the event path,
            the result would be equivalent to the inclusive ancestors of the node, <code>I</code>, in the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a>.
          </span></figcaption>
        </figure>

        <p>
          Note that the <a data-link-type="dfn" class="internalDFN" href="#dfn-event-path-calculation-algorithm">event path calculation algorithm</a> is designed to achieve the following goals:
        </p>

        <ol>
          <li>
            If there is a node, <var>CHILD</var>, in the event path and <var>CHILD</var> has a parent node, <var>PARENT</var>, in the node tree, the event path always includes <var>PARENT</var>.
            <var>PARENT</var> always appears somewhere after <var>CHILD</var> in the event path.
          </li>
          <li>
            Nodes in the event path form a <em>linear ancestor chain</em> in each <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a>. There are no <em>branch points</em> in each <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a>.
          </li>
        </ol>

        <figure id="fig-the-relationship-between-an-event-path-and-node-trees.-in-the-figure-a-number-shown-in-a-right-side-of-each-node-represents-a-zero-based-position-of-each-node-in-the-event-path.-a-parent-node-always-has-a-larger-number-than-that-of-its-child-node-in-each-node-tree.x">
          <object data="event-path-trees.svg" height="386" width="766">&gt;</object>
          <figcaption>Fig. <span class="figno">8</span> <span class="fig-title">
            The relationship between an event path and node trees. In the figure, a number shown in a right-side of each node represents a zero-based position of each node in the event path.
            A parent node always has a larger number than that of its child node in each node tree.
          </span></figcaption>
        </figure>

        <p>A <em>local</em> event path for each node tree would be seen as:
        </p>

        <table>
          <thead>
            <tr>
              <th>Node tree</th>
              <th><em>Local</em> Event Path</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>document tree 1</td>
              <td>[I, H, C, A]</td>
            </tr>
            <tr>
              <td>shadow tree 1</td>
              <td>[O, N, J]</td>
            </tr>
            <tr>
              <td>shadow tree 2</td>
              <td>[T, S, R]</td>
            </tr>
          </tbody>
        </table>

        <p>
          That means, if your concern is only one <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a>, you can forget all other node trees.
          The event path would be seen as if the event happened only on the node tree you are focusing on.
          This is an important aspect in a sense that hosting a shadow tree doesn't have any effect to the <em>local</em> event path
          as long as the event is not stopped somewhere in the <a data-link-type="dfn" class="internalDFN" href="#dfn-descendant-tree" data-lt="descendant tree">descendant trees</a>.
        </p>
        <p>
          If you are a web author and your concern is only a document tree, this might be a good news because an event listener that is registered somewhere on the document tree
          would <em>continue to work</em> even when you attach a shadow root to an element in the document tree to <em>enhance</em> the element.
          At the same time, an author of a shadow tree also can receive an event which will happen on a node in the document tree, if the node, or its ancestor, is assigned to a slot in the shadow tree.
        </p>

      </section>

      <section property="bibo:hasPart" resource="#event-retargeting" typeof="bibo:Chapter" id="event-retargeting">
        <h3 resource="#h-event-retargeting" id="h-event-retargeting"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.4 </span>Event Retargeting</span></h3>

        <p>In the cases where event path is across multiple node trees, the event's information about the target of the event is adjusted in order to maintain encapsulation. Event <dfn id="dfn-retargeting" data-dfn-type="dfn">retargeting</dfn> is a process of computing relative targets for each ancestor of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> at which the event is dispatched. A <dfn id="dfn-relative-target" data-dfn-type="dfn">relative target</dfn> is a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> that most accurately represents the target of a dispatched event at a given ancestor while maintaining the encapsulation.</p>

        <p>The <dfn id="dfn-retargeting-algorithm" data-dfn-type="dfn">retargeting algorithm</dfn> is used to determine relative targets and <strong>must</strong> be <a data-link-type="dfn" class="internalDFN" href="#dfn-processing-equivalence" data-lt="processing equivalence">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>BASE</var>, a base node for which a target node should be adjusted</dd>
            <dd><var>TARGET</var>, a target node which should be adjusted</dd>
            <dt>Output</dt>
            <dd><var>RELATIVE-TARGET</var>, a <a data-link-type="dfn" class="internalDFN" href="#dfn-relative-target">relative target</a>, the result of adjusting <var>TARGET</var> for <var>BASE</var></dd>
          </dl>
          <ol>
            <li>Let <var>BASE-TREE</var> be the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> which <var>BASE</var> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-participate">participates</a> in</li>
            <li>Let <var>TARGET-TREE</var> be the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> which <var>TARGET</var> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-participate">participates</a> in</li>
            <li>If <var>BASE-TREE</var> and <var>TARGET-TREE</var> participate in the same <a data-link-type="dfn" class="internalDFN" href="#dfn-tree-of-trees">tree of trees</a>:
              <ol>
                <li>Let <var>COMMON-ANCESTOR-TREE</var> be the lowest common <a data-link-type="dfn" class="internalDFN" href="#dfn-inclusive-ancestor-tree">inclusive ancestor tree</a> of <var>BASE-TREE</var> and <var>TARGET-TREE</var></li>
              </ol>
            </li>
            <li>Otherwise:
              <ol>
                <li>Let <var>COMMON-ANCESTOR-TREE</var> be the <a data-link-type="dfn" class="internalDFN" href="#dfn-root-tree">root tree</a> of <var>TARGET-TREE</var></li>
              </ol>
            </li>
            <li>
              For each <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a>, <var>ANCETOR</var>, in an <a data-link-type="dfn" class="internalDFN" href="#dfn-inclusive-deep-ancestor">inclusive deep ancestor</a> nodes of <var>TARGET</var>, from descendants to ancestors:
              <ol>
                <li>
                  If <var>ANCESTOR</var> participates in <var>COMMON-ANCESTOR-TREE</var>:
                  <ol>
                    <li>Let <var>RELATIVE-TARGET</var> be <var>ANCESTOR</var></li>
                    <li>Stop this algorithm</li>
                  </ol>
                </li>
              </ol>
            </li>
          </ol>
        </div>

        <p>The value of the <code>Event</code> object's <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-event-target"><code>target</code></a> attribute <strong>must</strong> be the result of the <a data-link-type="dfn" class="internalDFN" href="#dfn-retargeting-algorithm">retargeting algorithm</a> with the event's <code>currentTarget</code> and <code>target</code> as input.</p>
        <p>The event target retargeting process <strong>must</strong> occur prior to dispatch of an event.</p>
      </section>

      <section property="bibo:hasPart" resource="#retargeting-relatedtarget" typeof="bibo:Chapter" id="retargeting-relatedtarget">
        <h3 resource="#h-retargeting-relatedtarget" id="h-retargeting-relatedtarget"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.5 </span>Retargeting <code>relatedTarget</code></span></h3>

        <p>Some events have a <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget"><code>relatedTarget</code></a> [<cite><a href="#bib-DOM-Level-3-Events" class="bibref">DOM-Level-3-Events</a></cite>] property, which holds a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> that's not the event's target, but is related to the event.</p>

        <p>
          For instance, a <code>mouseover</code> event's <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget"><code>relatedTarget</code></a> may hold the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> from which the mouse has moved to event's <code>target</code>. In the case where <code>relatedTarget</code> is in a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>, the conforming UAs <strong>must</strong> not leak its actual value outside of this tree.
        </p>
        <p>
          The value of the <code>Event</code> object's <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget"><code>relatedTarget</code></a> attribute <strong>must</strong> be the result of the <a data-link-type="dfn" class="internalDFN" href="#dfn-retargeting-algorithm">retargeting algorithm</a> with the event's <code>currentTarget</code> and <code>relatedTarget</code> as input. The result is called a <dfn id="dfn-relative-related-target" data-dfn-type="dfn">relative related target</dfn>.
        </p>
        <p>
          The event relatedTarget retargeting process <strong>must</strong> occur prior to dispatch of an event.
        </p>
      </section>

      <section property="bibo:hasPart" resource="#retargeting-touch-events" typeof="bibo:Chapter" id="retargeting-touch-events">
        <h3 resource="#h-retargeting-touch-events" id="h-retargeting-touch-events"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.6 </span>Retargeting Touch Events</span></h3>

        <p>The <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#touch-interface"><code>Touch</code></a> <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#widl-Touch-target" data-lt="Touch target"><code>target</code></a> [<cite><a href="#bib-TOUCH-EVENTS" class="bibref">TOUCH-EVENTS</a></cite>] attribute <strong>must</strong> be adjusted in the same way as an event with a <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget"><code>relatedTarget</code></a>. Each <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#touch-interface"><code>Touch</code></a> <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#widl-Touch-target" data-lt="Touch target"><code>target</code></a> in the <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#touchlist-interface"><code>TouchList</code></a> returned from <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#touchevent-interface"><code>TouchEvent</code></a> <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#widl-TouchEvent-touches" data-lt="touches"><code>touches()</code></a>, <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#widl-TouchEvent-changedTouches" data-lt="changedTouches"><code>changedTouches()</code></a> and <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#widl-TouchEvent-targetTouches" data-lt="targetTouches"><code>targetTouches()</code></a> must be the result of the <a data-link-type="dfn" class="internalDFN" href="#dfn-retargeting-algorithm">retargeting algorithm</a> with a current target and <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#touch-interface"><code>Touch</code></a> <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#widl-Touch-target" data-lt="Touch target"><code>target</code></a> as input.</p>
      </section>

      <section property="bibo:hasPart" resource="#retargeting-focus-events" typeof="bibo:Chapter" id="retargeting-focus-events">
        <h3 resource="#h-retargeting-focus-events" id="h-retargeting-focus-events"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.7 </span>Retargeting Focus Events</span></h3>

        <p>The <code>focus</code>, <code>focusin</code>, <code>blur</code>, and <code>focusout</code> events <strong>must</strong> be treated in the same way as events with a <code>relatedTarget</code>, where the corresponding <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> that is losing focus as a result of <code>target</code> gaining focus or the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> that is gaining focus, and thus causing the blurring of <code>target</code> acts as the related target.</p>
      </section>

      <section property="bibo:hasPart" resource="#event-path-trimming" typeof="bibo:Chapter" id="event-path-trimming">
        <h3 resource="#h-event-path-trimming" id="h-event-path-trimming"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.8 </span>Event Path Trimming</span></h3>

        <p>
          In cases where both <code>relatedTarget</code> and <code>target</code> of a <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#trusted-events" data-lt="trusted events">trusted event</a> are part of the same <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>, the conforming UAs <strong>must</strong> <em>stop</em> events at the shadow root to avoid the appearance of spurious <code>mouseover</code> and <code>mouseout</code> events firing from the same node.
        </p>
        <p>
           Thus, event listeners for <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#trusted-events">trusted events</a> <strong>must not</strong> be invoked on a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> for which the <code>target</code> and <code>relatedTarget</code> are the same.
        </p>

        <p>
          The <dfn id="dfn-event-path-trimming-algorithm" data-dfn-type="dfn">event path trimming algorithm</dfn> <strong>must</strong> be used to trim the event path for a <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#trusted-events" data-lt="trusted events">trusted event</a> that has a <code>relatedTarget</code> attribute and
          <strong>must</strong> be <a data-link-type="dfn" class="internalDFN" href="#dfn-processing-equivalence" data-lt="processing equivalence">equivalent</a> to processing the following steps:
        </p>
        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>EVENT-PATH</var>, the event path, which is the result of the <a data-link-type="dfn" class="internalDFN" href="#dfn-event-path-calculation-algorithm">event path calculation algorithm</a></dd>
            <dt>Output</dt>
            <dd><var>EVENT-PATH</var> is trimmed so that event listeners aren't invoked on a node for which the <code>target</code> and <code>relatedTarget</code> are the same.</dd>
          </dl>
          <ol>
            <li>
              For each object, <var>A</var>, in <var>EVENT-PATH</var>:
              <ol>
                <li>Let <var>RELATIVE-TARGET</var> be the <a data-link-type="dfn" class="internalDFN" href="#dfn-relative-target">relative target</a> for <var>A</var></li>
                <li>Let <var>RELATIVE-RELATED-TARGET</var> be the <a data-link-type="dfn" class="internalDFN" href="#dfn-relative-related-target">relative related target</a> for <var>A</var></li>
                <li>If <var>RELATIVE-TARGET</var> and <var>RELATIVE-RELATED-TARGET</var> are the same, remove <var>A</var> from <var>EVENT-PATH</var>.</li>
              </ol>
            </li>
          </ol>
        </div>
        <div class="note"><div id="h-note8" role="heading" aria-level="4" class="note-title"><span>Note</span></div><p class="">
          For an <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#trusted-events" data-lt="trusted events">untrusted event</a>, the <a data-link-type="dfn" class="internalDFN" href="#dfn-event-path-trimming-algorithm">event path trimming algorithm</a> is not used.
        </p></div>
      </section>

      <section property="bibo:hasPart" resource="#event-dispatch" typeof="bibo:Chapter" id="event-dispatch">
        <h3 resource="#h-event-dispatch" id="h-event-dispatch"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.9 </span>Event Dispatch</span></h3>

        <p>At the time of event dispatch:</p>
        <ul>
          <li>The <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#interface-MouseEvent"><code>MouseEvent</code></a> <a class="externalDFN" href="http://www.w3.org/TR/cssom-view/#dom-mouseevent-offsetx"><code>offsetX</code></a> and <a class="externalDFN" href="http://www.w3.org/TR/cssom-view/#dom-mouseevent-offsety"><code>offsetY</code></a> attributes <strong>must</strong> return the coordinates relative to the origin of the <a class="externalDFN" href="http://www.w3.org/TR/cssom-view/#padding-edge">padding edge</a> of the <a data-link-type="dfn" class="internalDFN" href="#dfn-relative-target">relative target</a></li>
          <li>When <em>capturing</em>, which entails processing step 6 of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-event-dispatch" data-lt="event dispatch">event dispatch algorithm</a>, the event listeners <strong>must not</strong> be <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-event-listener-invoke" data-lt="event listener invoke">invoked</a> on a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> <strong>if</strong> it is the same as its <a data-link-type="dfn" class="internalDFN" href="#dfn-relative-target">relative target</a></li>
          <li>When <em>bubbling</em>, which entails processing step 9 of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-event-dispatch" data-lt="event dispatch">event dispatch algorithm</a>, the <a class="externalDFN" href="http://dom.spec.whatwg.org/#events"><code>Event</code></a> <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-event-eventphase">eventPhase</a> attribute <strong>must</strong> return <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-event-at_target">AT_TARGET</a> <strong>if</strong> the <a data-link-type="dfn" class="internalDFN" href="#dfn-relative-target">relative target</a> is same as the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> on which event listeners are <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-event-listener-invoke" data-lt="event listener invoke">invoked</a></li>
          <li>If the event's <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-event-bubbles"><code>bubbles</code></a> attribute value is <strong>false</strong>, run these substeps:
            <ol>
              <li>Reverse the order of <em>event path</em></li>
              <li>Initialize event's <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-event-eventphase"><code>eventPhase</code></a> attribute to <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-event-at_target"><code>AT_TARGET</code></a></li>
              <li>For each object in <em>event path</em> where the <a data-link-type="dfn" class="internalDFN" href="#dfn-relative-target">relative target</a> is same as the object, <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-event-listener-invoke" data-lt="event listener invoke">invoke</a> its <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-event-listener" data-lt="event listener">event listeners</a>, with event <em>event</em>, as long as <em>event</em>'s <a class="externalDFN" href="http://dom.spec.whatwg.org/#stop-propagation-flag">stop propagation flag</a> is unset</li>
            </ol></li>
        </ul>

        <p>Upon completion of the event dispatch, the <a class="externalDFN" href="http://dom.spec.whatwg.org/#events"><code>Event</code></a> object's <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-event-target"><code>target</code></a> and <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget"><code>relatedTarget</code></a> <strong>must</strong> be to the highest ancestor's <a data-link-type="dfn" class="internalDFN" href="#dfn-relative-target">relative target</a>. Since it is possible for a script to hold on to the <code>Event</code> object past the scope of event dispatch, this step is necessary to avoid revealing the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node" data-lt="node">nodes</a> in <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree" data-lt="shadow tree">shadow trees</a>.</p>
      </section>

      <section property="bibo:hasPart" resource="#event-retargeting-example" typeof="bibo:Chapter" id="event-retargeting-example" class="informative">
        <h3 resource="#h-event-retargeting-example" id="h-event-retargeting-example"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.10 </span>Event Retargeting Example</span></h3><p><em>This section is non-normative.</em></p>

        <p>Suppose we have a user interface for a media controller, represented by this tree, composed of both <a data-link-type="dfn" class="internalDFN" href="#dfn-document-tree">document tree</a> and the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree" data-lt="shadow tree">shadow trees</a>. In this example, we will assume that selectors are allowed to cross the shadow boundaries and we will use these selectors to identify the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-element" data-lt="element">elements</a>. Also, we will invent a fictional <code>shadow-root</code> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-element">element</a> to demarcate the shadow boundaries and represent <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root" data-lt="shadow root">shadow roots</a>:</p>
        <div class="example"><div class="example-title"><span>Example 1</span></div><pre class="example">&lt;div id="player"&gt;
    <span class="shadow-boundary">&lt;shadow-root id="player-shadow-root"&gt;</span>
        &lt;div id="controls"&gt;
            &lt;button id="play-button"&gt;PLAY&lt;/button&gt;
            &lt;input type="range" id="timeline"&gt;
                <span class="shadow-boundary">&lt;shadow-root id="timeline-shadow-root"&gt;</span>
                    &lt;div id="slider-thumb" id="timeline-slider-thumb"&gt;&lt;/div&gt;
                <span class="shadow-boundary">&lt;/shadow-root&gt;</span>
            &lt;/input&gt;
            &lt;div id="volume-slider-container"&gt;
                &lt;input type="range" id="volume-slider"&gt;
                    <span class="shadow-boundary">&lt;shadow-root id="volume-shadow-root"&gt;</span>
                        &lt;div id="slider-thumb" id="volume-slider-thumb"&gt;&lt;/div&gt;
                    <span class="shadow-boundary">&lt;/shadow-root&gt;</span>
                &lt;/input&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    <span class="shadow-boundary">&lt;/shadow-root&gt;</span>
&lt;/div&gt;</pre></div>

        <p>Let's have a user position their pointing device over the volume slider's thumb (<code>#volume-slider-thumb</code>), thus triggering a <code>mouseover</code> event on that node. For this event, let's pretend it has no associated <code>relatedTarget</code>.</p>

        <p>Per the <a data-link-type="dfn" class="internalDFN" href="#dfn-retargeting-algorithm">retargeting algorithm</a>, we should have the following set of ancestors and relative targets:</p>
        <table>
          <thead>
            <tr>
              <th>Ancestor</th>
              <th>Relative Target</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>#player</code></td>
              <td><code><strong>#player</strong></code></td>
            </tr>
            <tr>
              <td><code>#player-shadow-root</code></td>
              <td><code>#volume-slider</code></td>
            </tr>
            <tr>
              <td><code>#controls</code></td>
              <td><code>#volume-slider</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider-container</code></td>
              <td><code>#volume-slider</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider</code></td>
              <td><code><strong>#volume-slider</strong></code></td>
            </tr>
            <tr>
              <td><code>#volume-shadow-root</code></td>
              <td><code>#volume-slider-thumb</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider-thumb</code></td>
              <td><code><strong>#volume-slider-thumb</strong></code></td>
            </tr>
          </tbody>
        </table>

        <p>After we dispatch the <code>mouseover</code> event using these newly computed relative targets, the user decides to move their pointing device over the thumb of the timeline
          (<code>#timeline-slider-thumb</code>). This triggers both a <code>mouseout</code> event for the volume slider thumb and the <code>mouseover</code> event for the timeline thumb.</p>

        <p>Let's see how the <code>relatedTarget</code> value of the volume thumb's <code>mouseout</code> event is affected. For this event, the <code>relatedTarget</code> is the timeline thumb (<code>#timeline-slider-thumb</code>). Per the <a href="#retargeting-relatedtarget">relatedTarget retargeting</a>, we should have the following set of ancestors and adjusted related targets:</p>

        <table>
          <thead>
            <tr>
              <th>Ancestor</th>
              <th>Relative Target</th>
              <th>Adjusted related Target</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>#player</code></td>
              <td><code><strong>#player</strong></code></td>
              <td><code><strong>#player</strong></code></td>
            </tr>
            <tr>
              <td><code>#player-shadow-root</code></td>
              <td><code>#volume-slider</code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#controls</code></td>
              <td><code>#volume-slider</code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider-container</code></td>
              <td><code>#volume-slider</code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider</code></td>
              <td><code><strong>#volume-slider</strong></code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#volume-shadow-root</code></td>
              <td><code>#volume-slider-thumb</code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider-thumb</code></td>
              <td><code><strong>#volume-slider-thumb</strong></code></td>
              <td><code><strong>#timeline</strong></code></td>
            </tr>
          </tbody>
        </table>

        <p>The node, <code>#player</code>, has both <code>target</code> and <code>relatedTarget</code> being the same value (<code>#player</code>), which means that we do not dispatch the event on this <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> and its ancestors.</p>
      </section>

    </section>

    <section property="bibo:hasPart" resource="#user-interaction" typeof="bibo:Chapter" id="user-interaction">
      <!--OddPage--><h2 resource="#h-user-interaction" id="h-user-interaction"><span property="xhv:role" resource="xhv:heading"><span class="secno">6. </span>User Interaction</span></h2>

      <section property="bibo:hasPart" resource="#ranges-and-selections" typeof="bibo:Chapter" id="ranges-and-selections" class="informative">
        <h3 resource="#h-ranges-and-selections" id="h-ranges-and-selections"><span property="xhv:role" resource="xhv:heading"><span class="secno">6.1 </span>Ranges and Selections</span></h3><p><em>This section is non-normative.</em></p>

        <p>
          <a class="externalDFN" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">Selection</a> [<cite><a href="#bib-EDITING" class="bibref">EDITING</a></cite>] is not defined. Implementation should do their best to do what's best for them. Here's one possible, admittedly naive way:
        </p>

        <p>Since <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node" data-lt="node">nodes</a> which are in the different <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree" data-lt="node tree">node trees</a> never have the same <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-root">root</a>, there may never exist a valid <a class="externalDFN" href="http://dom.spec.whatwg.org/#range" data-lt="range">DOM range</a> that spans multiple <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree" data-lt="node tree">node trees</a>.</p>

        <p>Accordingly, <a class="externalDFN" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection" data-lt="selection">selections</a> may only exist within one <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a>, because they are defined by a single <a class="externalDFN" href="http://dom.spec.whatwg.org/#range">range</a>. The <a class="externalDFN" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selection</a>, returned by the <a class="externalDFN" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#dom-window-getselection"><code>window.getSelection()</code></a> method never returns a <a class="externalDFN" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selection</a> within a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.</p>

        <p>The <code>getSelection()</code> method of the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a> object returns the current <a class="externalDFN" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selection</a> in this <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.</p>
      </section>

      <section property="bibo:hasPart" resource="#focus-navigation" typeof="bibo:Chapter" id="focus-navigation">
        <h3 resource="#h-focus-navigation" id="h-focus-navigation"><span property="xhv:role" resource="xhv:heading"><span class="secno">6.2 </span>Focus Navigation</span></h3>

        <p>If a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> doesn’t <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-participate" data-lt="participates">participate</a> in the <a data-link-type="dfn" class="internalDFN" href="#dfn-document-composed-tree">document composed tree</a>, the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> <strong>must</strong> be skipped from the <a class="externalDFN" href="http://html.spec.whatwg.org/#sequential-focus-navigation">sequential focus navigation</a>.</p>

        <p>The <a class="externalDFN" href="http://html.spec.whatwg.org/#sequential-focus-navigation-order">sequential focus navigation order</a> for a given <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a> <var>A</var> <strong>must</strong> be inserted into the <a class="externalDFN" href="http://html.spec.whatwg.org/#sequential-focus-navigation-order">sequential focus navigation order</a> for the <a data-link-type="dfn" class="internalDFN" href="#dfn-parent-tree">parent tree</a> <var>B</var> as follows:</p>
        <ol>
          <li>Let <var>HOST</var> be the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a> which <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> A</li>
          <li>
            The <a class="externalDFN" href="http://html.spec.whatwg.org/#sequential-focus-navigation-order">sequential focus navigation order</a> for A <strong>must</strong> be inserted into the <a class="externalDFN" href="http://html.spec.whatwg.org/#sequential-focus-navigation-order">sequential focus navigation order</a> for <var>B</var>:
            <ol>
              <li>immediately after <var>HOST</var>, if <var>HOST</var> is <a class="externalDFN" href="http://html.spec.whatwg.org/#focusable-area">focusable</a>; or</li>
              <li>in place of the <var>HOST</var> as if <var>HOST</var> were assigned the <a class="externalDFN" href="http://html.spec.whatwg.org/#attr-tabindex">tabindex</a> value 0 for determining its position.</li>
            </ol>
          </li>
        </ol>

        <p>For <a class="externalDFN" href="http://www.w3.org/TR/css3-ui/#nav-dir">directional focus navigation</a> [<cite><a href="#bib-CSS3-UI" class="bibref">CSS3-UI</a></cite>], it is up to the user agent to integrate the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree" data-lt="shadow tree">shadow trees</a> into the document's <a class="externalDFN" href="http://www.w3.org/TR/css3-ui/#nav-dir">directional focus navigation</a>.
      </p>
    </section>

      <section property="bibo:hasPart" resource="#active-element" typeof="bibo:Chapter" id="active-element">
        <h3 resource="#h-active-element" id="h-active-element"><span property="xhv:role" resource="xhv:heading"><span class="secno">6.3 </span>Active Element</span></h3>

        <p>To maintain encapsulation, the value of the <a class="externalDFN" href="http://html.spec.whatwg.org/#document" data-lt="Document object">Document</a> object's focus API property <a class="externalDFN" href="http://html.spec.whatwg.org/#dom-document-activeelement">activeElement</a> <strong>must</strong> be adjusted. To prevent loss of information when adjusting this value, each <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a> <strong>must</strong> also have an <code>activeElement</code> property to store the value of the focused <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-element">element</a> in the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.</p>

        <p>
          The <dfn id="dfn-active-element-adjustment-algorithm" data-dfn-type="dfn">active element adjustment algorithm</dfn> <strong>must</strong> be used to determine the value of <a class="externalDFN" href="http://html.spec.whatwg.org/#dom-document-activeelement">activeElement</a> property, and it <strong>must</strong> be <a data-link-type="dfn" class="internalDFN" href="#dfn-processing-equivalence" data-lt="processing equivalence">equivalent</a> to processing the following steps:
        </p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>ROOT</var>, either a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-document">document</a> or a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a></dd>
            <dd><var>ELEMENT</var>, the focused <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-element">element</a></dd>
            <dt>Output</dt>
            <dd><var>ADJUSTED</var>, an adjusted <a class="externalDFN" href="http://html.spec.whatwg.org/#dom-document-activeelement">activeElement</a> property of <var>ROOT</var>.</dd>
          </dl>
          <ol>
            <li>Let <var>ADJUSTED</var> be the result of the <a data-link-type="dfn" class="internalDFN" href="#dfn-retargeting-algorithm">retargeting algorithm</a> with <var>ROOT</var> and <var>ELEMENT</var> as input</li>
          </ol>
        </div>
      </section>

      <section property="bibo:hasPart" resource="#editing" typeof="bibo:Chapter" id="editing">
        <h3 resource="#h-editing" id="h-editing"><span property="xhv:role" resource="xhv:heading"><span class="secno">6.4 </span>Editing</span></h3>

        <p>The value of the <a class="externalDFN" href="http://html.spec.whatwg.org/#attr-contenteditable"><code>contenteditable</code></a> attribute <strong>must not</strong> propagate from <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a> to its <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree" data-lt="shadow tree">shadow trees</a>.</p>
      </section>

      <section property="bibo:hasPart" resource="#assistive-technology" typeof="bibo:Chapter" id="assistive-technology">
        <h3 resource="#h-assistive-technology" id="h-assistive-technology"><span property="xhv:role" resource="xhv:heading"><span class="secno">6.5 </span>Assistive Technology</span></h3>

        <p>User agents with assistive technology traverse the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a>, and thus enable full use of WAI-ARIA [<cite><a href="#bib-WAI-ARIA" class="bibref">WAI-ARIA</a></cite>] semantics in the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree" data-lt="shadow tree">shadow trees</a>.</p>

      </section>

      <section property="bibo:hasPart" resource="#hit-testing" typeof="bibo:Chapter" id="hit-testing">
        <h3 resource="#h-hit-testing" id="h-hit-testing"><span property="xhv:role" resource="xhv:heading"><span class="secno">6.6 </span>Hit Testing</span></h3>

        <p>
          When a text node is a child node of a shadow root, a hit testing <strong>must</strong> target the shadow host if the text node is the result of the hit testing.
        </p>
        <p>
          User-agent mouse events <strong>must</strong> be targeted to the parent node in the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> of a text node if the <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#glossary-topmost-event-target">topmost event target</a> is the text node.
        </p>
        <div class="note"><div id="h-note9" role="heading" aria-level="4" class="note-title"><span>Note</span></div><p class="">
          This section eventually needs to be part of some general hit testing specification.
        </p></div>
      </section>

    </section>

    <section property="bibo:hasPart" resource="#html-elements-in-shadow-trees" typeof="bibo:Chapter" id="html-elements-in-shadow-trees">
      <!--OddPage--><h2 resource="#h-html-elements-in-shadow-trees" id="h-html-elements-in-shadow-trees"><span property="xhv:role" resource="xhv:heading"><span class="secno">7. </span>HTML Elements in Shadow Trees</span></h2>

      <section property="bibo:hasPart" resource="#inertness-of-html-elements-in-a-shadow-tree" typeof="bibo:Chapter" id="inertness-of-html-elements-in-a-shadow-tree">
        <h3 resource="#h-inertness-of-html-elements-in-a-shadow-tree" id="h-inertness-of-html-elements-in-a-shadow-tree"><span property="xhv:role" resource="xhv:heading"><span class="secno">7.1 </span>Inertness of HTML Elements in a shadow tree</span></h3>

        <p>Comparatively, a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a> can be seen as somewhere between <em>just part of a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-document">document</a></em> and itself being a <a class="externalDFN" href="http://dom.spec.whatwg.org/#interface-documentfragment" data-lt="interface DocumentFragment">document fragment</a>. Since it is rendered, a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a> aims to retain the traits of a typical <a class="externalDFN" href="http://dom.spec.whatwg.org/#trees">tree</a> in a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-document">document</a>. At the same time, it is an encapsulation abstraction, so it has to avoid affecting the <a data-link-type="dfn" class="internalDFN" href="#dfn-document-tree">document tree</a>. Thus, the <a class="externalDFN" href="http://html.spec.whatwg.org/#semantics">HTML elements</a> <strong>must</strong> behave as specified [<cite><a href="#bib-HTML" class="bibref">HTML</a></cite>] in the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree" data-lt="shadow tree">shadow trees</a>, with a few exceptions.</p>

        <div class="note"><div id="h-note10" role="heading" aria-level="4" class="note-title"><span>Note</span></div><p class="">
          According to the [<cite><a href="#bib-HTML" class="bibref">HTML</a></cite>], some HTML Elements would have different behavior if they participate in a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>, instead of a document tree,
          because their definitions require the elements to be <a class="externalDFN" href="http://html.spec.whatwg.org/#in-a-document">in a document</a> as a necessary condition for them to work.
          In other words, they shouldn't work if they participate in a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>, even when they are <a data-link-type="dfn" class="internalDFN" href="#dfn-in-a-document-deeply">in a document deeply</a>.
          We must fill this gap because we expect that most of HTML Elements behave in the same way as <a class="externalDFN" href="http://html.spec.whatwg.org/#in-a-document">in a document</a>, as long as they are <a data-link-type="dfn" class="internalDFN" href="#dfn-in-a-document-deeply">in a document deeply</a>.
          See <abbr title="World Wide Web Consortium">W3C</abbr> <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=26365">Bug 26365</a> and <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=27406">Bug 27406</a> for the details.
          The following is the tentative summary of the discussions in the <abbr title="World Wide Web Consortium">W3C</abbr> bugs. We, however, haven't covered all HTML Elements and their behaviors here yet.
          For HTML Elements which are not explicitly stated here, they should be considered as <a data-link-type="dfn" class="internalDFN" href="#dfn-active-in-a-shadow-tree">active in a shadow tree</a>.
          We are trying to update [<cite><a href="#bib-HTML" class="bibref">HTML</a></cite>] itself, instead of having monkey patches here.
        </p></div>
        <p>
          HTML Elements are classified into the following categories:
        </p>
        <ul>
          <li>
            <p>
              <dfn id="dfn-active-in-a-shadow-tree" data-dfn-type="dfn">Active in a shadow tree</dfn>
            </p>
            <p>
              A subset of <a class="externalDFN" href="http://html.spec.whatwg.org/#semantics">HTML elements</a> which <strong>must</strong> behave as if they were in the <a data-link-type="dfn" class="internalDFN" href="#dfn-document-tree">document tree</a>, even when they participate in a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>,
              as long as they are <a data-link-type="dfn" class="internalDFN" href="#dfn-in-a-document-deeply">in a document deeply</a>.
            </p>
            <p>
              The following HTML elements <strong>must</strong> be classified to this category:
            </p>
            <ul>
              <li><code>dialog</code></li>
              <li><code>iframe</code></li>
              <li><code>style</code></li>
            </ul>
          </li>
          <li>
            <p>
              <dfn id="dfn-inert-in-a-shadow-tree" data-dfn-type="dfn">Inert in a shadow tree</dfn>:
            </p>
            <p>
              A subset of <a class="externalDFN" href="http://html.spec.whatwg.org/#semantics">HTML elements</a> which <strong>must</strong> behave as <a class="externalDFN" href="http://html.spec.whatwg.org/#inert">inert</a>, or not part of the <a data-link-type="dfn" class="internalDFN" href="#dfn-document-tree">document tree</a>, if they participate in a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.
              This is consistent how the <a class="externalDFN" href="http://html.spec.whatwg.org/#semantics">HTML elements</a> would behave in a <a class="externalDFN" href="http://dom.spec.whatwg.org/#interface-documentfragment" data-lt="interface DocumentFragment">document fragment</a>.
            </p>
            <p>
              The following HTML elements <strong>must</strong> be classified to this category:
            </p>
            <ul>
              <li><a class="externalDFN" href="http://html.spec.whatwg.org/#the-base-element" data-lt="base element"><code>base</code></a></li>
              <li><a class="externalDFN" href="http://html.spec.whatwg.org/#the-link-element" data-lt="link element"><code>link</code></a></li>
            </ul>
          </li>
          <li>
            <p>
              <dfn id="dfn-inert-unless-being-rendered" data-dfn-type="dfn">Inert unless being rendered</dfn>:
            </p>
            <p>
              A subset of <a class="externalDFN" href="http://html.spec.whatwg.org/#semantics">HTML elements</a> which <strong>must</strong> behave as <a class="externalDFN" href="http://html.spec.whatwg.org/#inert">inert</a>, or not part of the <a data-link-type="dfn" class="internalDFN" href="#dfn-document-tree">document tree</a>,
              unless they are <a class="externalDFN" href="http://html.spec.whatwg.org/#being-rendered">being rendered</a>.
              In other words, if they don't particitpate in a <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> whose root node is a document, they <strong>must</strong> behave as <a class="externalDFN" href="http://html.spec.whatwg.org/#inert">inert</a>.
            </p>
            <p>
              The following HTML elements <strong>must</strong> be classified to this category:
            </p>
            <ul>
              <li><code>applet</code></li>
              <li><code>embed</code></li>
              <li><code>object</code></li>
            </ul>
            <div class="note"><div id="h-note11" role="heading" aria-level="4" class="note-title"><span>Note</span></div><p class="">
              For example, suppose that an <code>object</code> element is a child node of a shadow host, but the <code>object</code> element is not assigned to a slot.
              In this case, according to the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree-children-calculation-algorithm">composed tree children calculation algorithm</a>,
              this element never participate in a <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> whose root node is a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-document">document</a>.
              Therefore, this element is <a class="externalDFN" href="http://html.spec.whatwg.org/#inert">inert</a> because this element is not <a class="externalDFN" href="http://html.spec.whatwg.org/#being-rendered">being rendered</a>. .
            </p></div>
          </li>
        </ul>
      </section>

      <section property="bibo:hasPart" resource="#attributes" typeof="bibo:Chapter" id="attributes">
        <h3 resource="#h-attributes" id="h-attributes"><span property="xhv:role" resource="xhv:heading"><span class="secno">7.2 </span>Attributes</span></h3>

        <p>When [<cite><a href="#bib-HTML" class="bibref">HTML</a></cite>] defines the processing algorithms to traverse trees for the following attributes, they <strong>must</strong> use the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a>.
        </p><ul>
          <li><code>dir</code></li>
          <li><code>draggable</code></li>
          <li><code>dropzone</code></li>
          <li><code>hidden</code></li>
          <li><code>lang</code> and <code>xml:lang</code></li>
          <li><code>spellcheck</code></li>
          <li><code>title</code></li>
        </ul>

        <div class="note"><div id="h-note12" role="heading" aria-level="4" class="note-title"><span>Note</span></div><div class="">
          <p>
            This list does not include attributes that are defined elsewhere in this specification. Such attributes include:
          </p>
          <ul>
            <li><code>tabindex</code> is defined in <a href="#focus-navigation">Focus Navigation</a>.</li>
            <li><code>role</code> and <code>ARIA</code> are defined in <a href="#assistive-technology">Assistive Technology</a>.</li>
          </ul>
        </div></div>
      </section>

    </section>

    <section property="bibo:hasPart" resource="#elements-and-dom-interfaces" typeof="bibo:Chapter" id="elements-and-dom-interfaces">
      <!--OddPage--><h2 resource="#h-elements-and-dom-interfaces" id="h-elements-and-dom-interfaces"><span property="xhv:role" resource="xhv:heading"><span class="secno">8. </span>Elements and DOM interfaces</span></h2>

      <section property="bibo:hasPart" resource="#the-shadowroot-interface" typeof="bibo:Chapter" id="the-shadowroot-interface">
        <h3 resource="#h-the-shadowroot-interface" id="h-the-shadowroot-interface"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.1 </span>The <code>ShadowRoot</code> interface</span></h3>

        <p>The <code>ShadowRoot</code> interface represents the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a>.</p>

        <pre class="idl"><span class="idlInterface" id="idl-def-ShadowRoot">interface <span class="idlInterfaceID">ShadowRoot</span> : <span class="idlSuperclass">DocumentFragment</span> {
<span class="idlMethod">    <span class="idlMethType">Selection?</span>        <span class="idlMethName"><a href="#widl-ShadowRoot-getSelection-Selection">getSelection</a></span> ();</span>
<span class="idlMethod">    <span class="idlMethType"><a class="idlType" href="#idl-def-Element"><code>Element</code></a>?</span>          <span class="idlMethName"><a href="#widl-ShadowRoot-elementFromPoint-Element-double-x-double-y">elementFromPoint</a></span> (<span class="idlParam"><span class="idlParamType">double</span> <span class="idlParamName">x</span></span>, <span class="idlParam"><span class="idlParamType">double</span> <span class="idlParamName">y</span></span>);</span>
<span class="idlMethod">    <span class="idlMethType">sequence&lt;<a class="idlType" href="#idl-def-Element"><code>Element</code></a>&gt;</span> <span class="idlMethName"><a href="#widl-ShadowRoot-elementsFromPoint-sequence-Element--double-x-double-y">elementsFromPoint</a></span> (<span class="idlParam"><span class="idlParamType">double</span> <span class="idlParamName">x</span></span>, <span class="idlParam"><span class="idlParamType">double</span> <span class="idlParamName">y</span></span>);</span>
<span class="idlMethod">    <span class="idlMethType">CaretPosition?</span>    <span class="idlMethName"><a href="#widl-ShadowRoot-caretPositionFromPoint-CaretPosition-double-x-double-y">caretPositionFromPoint</a></span> (<span class="idlParam"><span class="idlParamType">double</span> <span class="idlParamName">x</span></span>, <span class="idlParam"><span class="idlParamType">double</span> <span class="idlParamName">y</span></span>);</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType"><a class="idlType" href="#idl-def-Element"><code>Element</code></a>?</span>       <span class="idlAttrName"><a href="#widl-ShadowRoot-activeElement">activeElement</a></span>;</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType"><a class="idlType" href="#idl-def-Element"><code>Element</code></a></span>        <span class="idlAttrName"><a href="#widl-ShadowRoot-host">host</a></span>;</span>
<span class="idlAttribute">    [<span class="extAttr">TreatNullAs=EmptyString</span>]
                attribute <span class="idlAttrType">DOMString</span>      <span class="idlAttrName"><a href="#widl-ShadowRoot-innerHTML">innerHTML</a></span>;</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType">StyleSheetList</span> <span class="idlAttrName"><a href="#widl-ShadowRoot-styleSheets">styleSheets</a></span>;</span>
};</span></pre><section property="bibo:hasPart" resource="#attributes-1" typeof="bibo:Chapter" id="attributes-1"><h4 resource="#h-attributes-1" id="h-attributes-1"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.1.1 </span>Attributes</span></h4><dl class="attributes"><dt id="widl-ShadowRoot-activeElement"><code>activeElement</code> of type <span class="idlAttrType"><a class="idlType" href="#idl-def-Element"><code>Element</code></a></span>, readonly   , nullable</dt><dd>
            <p>Represents the currently focused <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-element">element</a> in the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.</p>
            <p>On getting, the attribute <strong>must</strong> return the currently focused <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-element">element</a> in the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a> or <code>null</code>, if there is none.</p>
          </dd><dt id="widl-ShadowRoot-host"><code>host</code> of type <span class="idlAttrType"><a class="idlType" href="#idl-def-Element"><code>Element</code></a></span>, readonly   </dt><dd>
            <p>Represents the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a> which <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a>.</p>
            <p>On getting, the attribute <strong>must</strong> return the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a> which <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a>.</p>
          </dd><dt id="widl-ShadowRoot-innerHTML"><code>innerHTML</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd>
            <p>Represents the markup of <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a>'s contents.</p>
            <p>On getting, the attribute <strong>must</strong> return the result of running the <a class="externalDFN" href="http://html.spec.whatwg.org/#html-fragment-serialization-algorithm">HTML fragment serialization algorithm</a> with the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> as <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host" data-lt="shadow host"><code>shadow host</code></a>.</p>
            <p>
              On setting, these steps <strong>must</strong> be run:
            </p>
            <ol>
              <li>Let <var>FRAGMENT</var> be the result of invoking the <a class="externalDFN" href="http://domparsing.spec.whatwg.org/#concept-parse-fragment" data-lt="parse fragment">fragment parsing algorithm</a> [<cite><a href="#bib-DOM-PARSING" class="bibref">DOM-PARSING</a></cite>] with the new value as <var>MARKUP</var>, and the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> as <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host" data-lt="shadow host"><code>shadow host</code></a></li>
              <li><a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-replace-all">Replace all</a> with <var>FRAGMENT</var> within the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a>.</li>
            </ol>
          </dd><dt id="widl-ShadowRoot-styleSheets"><code>styleSheets</code> of type <span class="idlAttrType">StyleSheetList</span>, readonly   </dt><dd>
            <p>Represents the shadow root style sheets.</p>
            <p>On getting, the attribute <strong>must</strong> return a <a class="externalDFN" href="http://www.w3.org/TR/cssom/#the-stylesheetlist-interface"><code>StyleSheetList</code></a> sequence containing the shadow root style sheets.
            </p>
          </dd></dl></section><section property="bibo:hasPart" resource="#methods" typeof="bibo:Chapter" id="methods"><h4 resource="#h-methods" id="h-methods"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.1.2 </span>Methods</span></h4><dl class="methods"><dt id="widl-ShadowRoot-caretPositionFromPoint-CaretPosition-double-x-double-y"><code>caretPositionFromPoint</code></dt><dd>
            <div class="note"><div id="h-note13" role="heading" aria-level="5" class="note-title"><span>Note</span></div><p class="">
              It could be defined in roughly the same way as <a class="externalDFN" href="http://www.w3.org/TR/cssom-view/#dom-document-caretpositionfrompoint">caretPositionFromPoint</a> [<cite><a href="#bib-CSSOM-VIEW" class="bibref">CSSOM-VIEW</a></cite>].
              Eventually, this needs to be part of CSSOM View Module specification [<cite><a href="#bib-CSSOM-VIEW" class="bibref">CSSOM-VIEW</a></cite>]. See also <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=27829"><abbr title="World Wide Web Consortium">W3C</abbr> bug 27829</a>.
          </p></div><table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">x</td><td class="prmType"><code>double</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr><tr><td class="prmName">y</td><td class="prmType"><code>double</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code>CaretPosition</code>, nullable</div></dd><dt id="widl-ShadowRoot-elementFromPoint-Element-double-x-double-y"><code>elementFromPoint</code></dt><dd>
            <p>Returns an <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-element">element</a> at specified coordinates.</p>
            <div class="note"><div id="h-note14" role="heading" aria-level="5" class="note-title"><span>Note</span></div><p class="">
              Eventually, this needs to be part of CSSOM View Module specification [<cite><a href="#bib-CSSOM-VIEW" class="bibref">CSSOM-VIEW</a></cite>]. See also <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=27829"><abbr title="World Wide Web Consortium">W3C</abbr> bug 27829</a>.
            </p></div>
            <p>
              When invoked, it <strong>must</strong> return result of running the following steps:
            </p>
            <ol>
              <li>If <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> is not a <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a> instance, throw an <a class="externalDFN" href="http://dom.spec.whatwg.org/#invalidnodetypeerror"><code>InvalidNodeTypeError</code></a>.</li>
              <li>If either argument is negative, <code>x</code> is greater than the <a class="externalDFN" href="http://www.w3.org/TR/cssom-view/#viewport">viewport</a> width excluding the size of a rendered scroll bar (if any), or if <code>y</code> is greater than the <a class="externalDFN" href="http://www.w3.org/TR/cssom-view/#viewport">viewport</a> height excluding the size of a rendered scroll bar (if any), return <strong>null</strong>.</li>
              <li>Let <var>HIT</var> be the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-element">element</a> at coordinates <code>x</code> and <code>y</code> in the <a class="externalDFN" href="http://www.w3.org/TR/cssom-view/#viewport">viewport</a>, determined through hit testing</li>
              <li>Return the result of running the <a data-link-type="dfn" class="internalDFN" href="#dfn-retargeting-algorithm">retargeting algorithm</a> with <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> and <var>HIT</var> as input</li>
            </ol>
          <table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">x</td><td class="prmType"><code>double</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr><tr><td class="prmName">y</td><td class="prmType"><code>double</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code><a class="idlType" href="#idl-def-Element"><code>Element</code></a></code>, nullable</div></dd><dt id="widl-ShadowRoot-elementsFromPoint-sequence-Element--double-x-double-y"><code>elementsFromPoint</code></dt><dd>
            <div class="note"><div id="h-note15" role="heading" aria-level="5" class="note-title"><span>Note</span></div><p class="">
              It could be defined in roughly the same way as elementFromPoint.
              Eventually, this needs to be part of CSSOM View Module specification [<cite><a href="#bib-CSSOM-VIEW" class="bibref">CSSOM-VIEW</a></cite>]. See also <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=27829"><abbr title="World Wide Web Consortium">W3C</abbr> bug 27829</a>.
            </p></div>
          <table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">x</td><td class="prmType"><code>double</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr><tr><td class="prmName">y</td><td class="prmType"><code>double</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code>sequence&lt;<a class="idlType" href="#idl-def-Element"><code>Element</code></a>&gt;</code></div></dd><dt id="widl-ShadowRoot-getSelection-Selection"><code>getSelection</code></dt><dd>
            <p>Returns the current selection in the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.</p>
            <p>When invoked, it <strong>must</strong> return the <a class="externalDFN" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selection</a> in the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.</p>
          <div><em>No parameters.</em></div><div><em>Return type: </em><code>Selection</code>, nullable</div></dd></dl></section>

        <p>The <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-node-nodetype"><code>nodeType</code></a> attribute of a <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a> instance <strong>must</strong> return <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-node-document_fragment_node"><code>DOCUMENT_FRAGMENT_NODE</code></a>. Accordingly, the <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-node-nodename"><code>nodeName</code></a> attribute of a <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a> instance <strong>must</strong> return <code>"#document-fragment"</code>.</p>

        <p>Invoking the <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-node-clonenode"><code>cloneNode()</code></a> method on a <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a> instance <strong>must</strong> always throw a <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-domexception-data_clone_err"><code>DATA_CLONE_ERR</code></a> exception.</p>

      </section>

      <section property="bibo:hasPart" resource="#extensions-to-element-interface" typeof="bibo:Chapter" id="extensions-to-element-interface">
        <h3 resource="#h-extensions-to-element-interface" id="h-extensions-to-element-interface"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.2 </span>Extensions to <code>Element</code> Interface</span></h3>

        <pre class="idl"><span class="idlInterface" id="idl-def-Element">partial interface <span class="idlInterfaceID">Element</span> {
<span class="idlMethod">    <span class="idlMethType"><a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a></span> <span class="idlMethName"><a href="#widl-Element-attachShadow-ShadowRoot-ShadowRootInit-shadowRootInitDict">attachShadow</a></span> (<span class="idlParam"><span class="idlParamType"><a class="idlType" href="#idl-def-ShadowRootInit"><code>ShadowRootInit</code></a></span> <span class="idlParamName">shadowRootInitDict</span></span>);</span>
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span>   <span class="idlAttrName"><a href="#widl-Element-slot">slot</a></span>;</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType"><a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a>?</span> <span class="idlAttrName"><a href="#widl-Element-shadowRoot">shadowRoot</a></span>;</span>
};</span></pre><section property="bibo:hasPart" resource="#attributes-2" typeof="bibo:Chapter" id="attributes-2"><h4 resource="#h-attributes-2" id="h-attributes-2"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.2.1 </span>Attributes</span></h4><dl class="attributes"><dt id="widl-Element-shadowRoot"><code>shadowRoot</code> of type <span class="idlAttrType"><a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a></span>, readonly   , nullable</dt><dd>
            <p>Represents the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a> that <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a>.</p>
            <p>On getting, the attribute <strong>must</strong> return the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a> that <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> if there is and it is <a data-link-type="dfn" class="internalDFN" href="#dfn-open">open</a>. Otherwise <strong>must</strong> return <code>null</code>.</p>
          </dd><dt id="widl-Element-slot"><code>slot</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd>
            <p>
              Reflects the <code>slot</code> attribute. The <code>slot</code> attribute represents the <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-name">slot name</a> of a slot to where this element is assigned.
            </p>
          </dd></dl></section><section property="bibo:hasPart" resource="#methods-1" typeof="bibo:Chapter" id="methods-1"><h4 resource="#h-methods-1" id="h-methods-1"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.2.2 </span>Methods</span></h4><dl class="methods"><dt id="widl-Element-attachShadow-ShadowRoot-ShadowRootInit-shadowRootInitDict"><code>attachShadow</code></dt><dd>
            When invoked, these steps <strong>must</strong> be run:
            <ol>
              <li>
                If the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> is one of the following elements, throws <code>NotSupportedError</code> exception.
                <ul>
                  <li><code>button</code></li>
                  <li><code>details</code></li>
                  <li><code>input</code></li>
                  <li><code>marquee</code></li>
                  <li><code>meter</code></li>
                  <li><code>progress</code></li>
                  <li><code>select</code></li>
                  <li><code>textarea</code></li>
                  <li><code>keygen</code></li>
                </ul>
                <div class="note"><div id="h-note16" role="heading" aria-level="5" class="note-title"><span>Note</span></div><p class="">
                  These are the elements whose rendering is defined through a <a class="externalDFN" href="http://html.spec.whatwg.org/#bindings">binding</a> property in HTML's Rendering section.
                </p></div>
              </li>
              <li>If the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> already hosts the shadow tree, throws <code>InvalidStateError</code> exception.</li>
              <li>
                Create a new instance of the <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a> object.
                The <code>shadowRootInitDict</code> argument allows for setting the <a data-link-type="dfn" class="internalDFN" href="#dfn-encapsulation-mode">encapsulation mode</a>.
              </li>
              <li>Let the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> host the <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a> object.</li>
              <li>Return <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a> object.</li>
            </ol>
          <table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">shadowRootInitDict</td><td class="prmType"><code><a class="idlType" href="#idl-def-ShadowRootInit"><code>ShadowRootInit</code></a></code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code><a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a></code></div></dd></dl></section>
      </section>

      <section property="bibo:hasPart" resource="#shadowrootinit-dictionary" typeof="bibo:Chapter" id="shadowrootinit-dictionary">
        <h3 resource="#h-shadowrootinit-dictionary" id="h-shadowrootinit-dictionary"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.3 </span><code>ShadowRootInit</code> dictionary</span></h3>
        <pre class="idl"><span class="idlDictionary" id="idl-def-ShadowRootInit">dictionary <span class="idlDictionaryID">ShadowRootInit</span> {
<span class="idlMember">    required <span class="idlMemberType"><a class="idlType" href="#idl-def-ShadowRootMode"><code>ShadowRootMode</code></a></span> <span class="idlMemberName"><a href="#widl-ShadowRootInit-mode">mode</a></span>;</span>
};</span></pre><section property="bibo:hasPart" resource="#dictionary-shadowrootinit-members" typeof="bibo:Chapter" id="dictionary-shadowrootinit-members"><h4 resource="#h-dictionary-shadowrootinit-members" id="h-dictionary-shadowrootinit-members"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.3.1 </span>Dictionary <a href="#idl-def-ShadowRootInit" class="idlType"><code>ShadowRootInit</code></a> Members</span></h4><dl class="dictionary-members"><dt id="widl-ShadowRootInit-mode"><code>mode</code> of type <span class="idlMemberType"><a class="idlType" href="#idl-def-ShadowRootMode"><code>ShadowRootMode</code></a></span>, required</dt><dd>Specifies the <a data-link-type="dfn" class="internalDFN" href="#dfn-encapsulation-mode">encapsulation mode</a> of <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a></dd></dl></section>
      </section>

      <section property="bibo:hasPart" resource="#shadowrootmode-enum" typeof="bibo:Chapter" id="shadowrootmode-enum">
        <h3 resource="#h-shadowrootmode-enum" id="h-shadowrootmode-enum"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.4 </span><code>ShadowRootMode</code> enum</span></h3>
        <pre class="idl"><span class="idlEnum" id="idl-def-ShadowRootMode">enum <span class="idlEnumID">ShadowRootMode</span> {
    "<a href="#idl-def-ShadowRootMode.open" class="idlEnumItem">open</a>",
    "<a href="#idl-def-ShadowRootMode.closed" class="idlEnumItem">closed</a>"
};</span></pre><table class="simple"><tbody><tr><th colspan="2">Enumeration description</th></tr><tr><td><code id="idl-def-ShadowRootMode.open">open</code></td><td>Specifies <a data-link-type="dfn" class="internalDFN" href="#dfn-open">open</a> <a data-link-type="dfn" class="internalDFN" href="#dfn-encapsulation-mode">encapsulation mode</a></td></tr><tr><td><code id="idl-def-ShadowRootMode.closed">closed</code></td><td>Specifies <a data-link-type="dfn" class="internalDFN" href="#dfn-closed">closed</a> <a data-link-type="dfn" class="internalDFN" href="#dfn-encapsulation-mode">encapsulation mode</a></td></tr></tbody></table>
      </section>

      <section property="bibo:hasPart" resource="#extensions-to-nondocumenttypechildnode-interface" typeof="bibo:Chapter" id="extensions-to-nondocumenttypechildnode-interface">
        <h3 resource="#h-extensions-to-nondocumenttypechildnode-interface" id="h-extensions-to-nondocumenttypechildnode-interface"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.5 </span>Extensions to <code>NonDocumentTypeChildNode</code> Interface</span></h3>

        <pre class="idl"><span class="idlInterface" id="idl-def-NonDocumentTypeChildNode">partial interface <span class="idlInterfaceID">NonDocumentTypeChildNode</span> {
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType"><a class="idlType" href="#idl-def-HTMLSlotElement"><code>HTMLSlotElement</code></a>?</span> <span class="idlAttrName"><a href="#widl-NonDocumentTypeChildNode-assignedSlot">assignedSlot</a></span>;</span>
};</span></pre><section property="bibo:hasPart" resource="#attributes-3" typeof="bibo:Chapter" id="attributes-3"><h4 resource="#h-attributes-3" id="h-attributes-3"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.5.1 </span>Attributes</span></h4><dl class="attributes"><dt id="widl-NonDocumentTypeChildNode-assignedSlot"><code>assignedSlot</code> of type <span class="idlAttrType"><a class="idlType" href="#idl-def-HTMLSlotElement"><code>HTMLSlotElement</code></a></span>, readonly   , nullable</dt><dd>
            <p>
              Represents the <a data-link-type="dfn" class="internalDFN" href="#dfn-assigned-slot">assigned slot</a> of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a>.
            </p>
            <p>
              On getting, the attribute <strong>must</strong> return the <a data-link-type="dfn" class="internalDFN" href="#dfn-assigned-slot">assigned slot</a> of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a>, if there is, and the assigned slot participates in an <a data-link-type="dfn" class="internalDFN" href="#dfn-open">open</a> shadow tree.
              Otherwise <strong>must</strong> return <code>null</code>.
            </p>
          </dd></dl></section>
      </section>

      <section property="bibo:hasPart" resource="#the-slot-element" typeof="bibo:Chapter" id="the-slot-element">
        <h3 resource="#h-the-slot-element" id="h-the-slot-element"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.6 </span>The <code>slot</code> element</span></h3>

        <p>The <dfn id="dfn-slot-element" data-dfn-type="dfn">slot element</dfn> is used to define a location of a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>.</p>

        <p>If a <code>slot</code> element does not satisfy the condition of a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>, it <strong>must</strong> have the same rendering behavior as the <a class="externalDFN" href="http://html.spec.whatwg.org/#htmlunknownelement"><code>HTMLUnknownElement</code></a>.</p>

        <dl>
          <dt>Context</dt>
          <dd>Where <a class="externalDFN" href="http://html.spec.whatwg.org/#flow-content">flow content</a> is expected.</dd>

          <dt>Content model</dt>
          <dd><a class="externalDFN" href="http://html.spec.whatwg.org/#transparent">Transparent</a></dd>

          <dt>Children</dt>
          <dd>Anything as fallback content</dd>

          <dt>Content attributes</dt>
          <dd><a class="externalDFN" href="http://html.spec.whatwg.org/#global-attributes">Global attributes</a></dd>
          <dd>
            <dl>
              <dt><code>name</code>, the <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-name">slot name</a></dt>
              <dd>Represents the <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-name">slot name</a>.</dd>
            </dl>
          </dd>

          <dt>DOM Interface</dt>
          <dd>
            <pre class="idl"><span class="idlInterface" id="idl-def-HTMLSlotElement">interface <span class="idlInterfaceID">HTMLSlotElement</span> : <span class="idlSuperclass">HTMLElement</span> {
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span> <span class="idlAttrName"><a href="#widl-HTMLSlotElement-name">name</a></span>;</span>
<span class="idlMethod">    <span class="idlMethType">sequence&lt;Node&gt;</span> <span class="idlMethName"><a href="#widl-HTMLSlotElement-getDistributedNodes-sequence-Node">getDistributedNodes</a></span> ();</span>
};</span></pre><section property="bibo:hasPart" resource="#attributes-5" typeof="bibo:Chapter"><h4 resource="#attributes-5" id="attributes-5"><span property="xhv:role" resource="xhv:heading">Attributes</span></h4><dl class="attributes"><dt id="widl-HTMLSlotElement-name"><code>name</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd><strong>Must</strong> <a class="externalDFN" href="http://html.spec.whatwg.org/#reflect">reflect</a> the <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-name" data-lt="slot name">name</a> attribute.</dd></dl></section><section property="bibo:hasPart" resource="#methods-2" typeof="bibo:Chapter"><h4 resource="#methods-2" id="methods-2"><span property="xhv:role" resource="xhv:heading">Methods</span></h4><dl class="methods"><dt id="widl-HTMLSlotElement-getDistributedNodes-sequence-Node"><code>getDistributedNodes</code></dt><dd>
                When invoked, it <strong>must</strong> return result of running the following steps:
                <ol>
                  <li>
                    If the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>:
                    <ol>
                      <li>
                        Return a sequence consisting of nodes in the <a data-link-type="dfn" class="internalDFN" href="#dfn-distributed-nodes">distributed nodes</a> of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a>.
                      </li>
                    </ol>
                  </li>
                  <li>
                    Otherwise:
                    <ol>
                      <li>Return an empty sequence.</li>
                    </ol>
                  </li>
                </ol>
              <div><em>No parameters.</em></div><div><em>Return type: </em><code>sequence&lt;Node&gt;</code></div></dd></dl></section>
          </dd>
        </dl>
      </section>

      <section property="bibo:hasPart" resource="#extensions-to-eventinit-dictionary" typeof="bibo:Chapter" id="extensions-to-eventinit-dictionary">
        <h3 resource="#h-extensions-to-eventinit-dictionary" id="h-extensions-to-eventinit-dictionary"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.7 </span>Extensions to <a class="externalDFN" href="http://dom.spec.whatwg.org/#dictdef-eventinit"><code>EventInit</code></a> Dictionary</span></h3>

        <pre class="idl"><span class="idlDictionary" id="idl-def-EventInit">partial dictionary <span class="idlDictionaryID">EventInit</span> {
<span class="idlMember">             <span class="idlMemberType">boolean</span> <span class="idlMemberName"><a href="#widl-EventInit-scoped">scoped</a></span> = <span class="idlMemberValue">false</span>;</span>
};</span></pre><section property="bibo:hasPart" resource="#dictionary-eventinit-members" typeof="bibo:Chapter" id="dictionary-eventinit-members"><h4 resource="#h-dictionary-eventinit-members" id="h-dictionary-eventinit-members"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.7.1 </span>Dictionary <a href="#idl-def-EventInit" class="idlType"><code>EventInit</code></a> Members</span></h4><dl class="dictionary-members"><dt id="widl-EventInit-scoped"><code>scoped</code> of type <span class="idlMemberType">boolean</span>,         , defaulting to <code>false</code></dt><dd>
            <p>Specifies the <a data-link-type="dfn" class="internalDFN" href="#dfn-scoped-flag">scoped flag</a> of <code>Event</code></p>
          </dd></dl></section>
      </section>

      <section property="bibo:hasPart" resource="#extensions-to-event-interface" typeof="bibo:Chapter" id="extensions-to-event-interface">
        <h3 resource="#h-extensions-to-event-interface" id="h-extensions-to-event-interface"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.8 </span>Extensions to <code>Event</code> Interface</span></h3>

        <pre class="idl"><span class="idlInterface" id="idl-def-Event">partial interface <span class="idlInterfaceID">Event</span> {
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType">object</span>  <span class="idlAttrName"><a href="#widl-Event-deepPath">deepPath</a></span>;</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType">boolean</span> <span class="idlAttrName"><a href="#widl-Event-scoped">scoped</a></span>;</span>
};</span></pre><section property="bibo:hasPart" resource="#attributes-4" typeof="bibo:Chapter" id="attributes-4"><h4 resource="#h-attributes-4" id="h-attributes-4"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.8.1 </span>Attributes</span></h4><dl class="attributes"><dt id="widl-Event-deepPath"><code>deepPath</code> of type <span class="idlAttrType">object</span>, readonly   </dt><dd>
            <p>Represents the event path.</p>
            <p>
              On getting, the attribute <strong>must</strong> create and return a new JavaScript Array object,
              that <strong>must</strong> be equivalent to processing the following steps:
            </p>

            <div class="algorithm">
              <dl>
                <dt>Input</dt>
                <dd><var>EVENT</var>, a <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a></dd>
                <dt>Output</dt>
                <dd><var>PATH</var>, an array of nodes</dd>
              </dl>

              <ol>
                <li>If <var>EVENT</var> hasn't been dispatched, return a new empty array.</li>
                <li>
                  Otherwise:
                  <ol>
                    <li>Let <var>PATH</var> be the event path of <var>EVENT</var>.</li>
                    <li>
                      If <var>EVENT</var> is being dispatched:
                      <ol>
                        <li>Let <var>CURRENT-TARGET</var> be the current target of <var>EVENT</var>.</li>
                      </ol>
                    </li>
                    <li>
                      Otherwise:
                      <ol>
                        <li>Let <var>CURRENT-TARGET</var> be the last node of <var>PATH</var>.</li>
                      </ol>
                    </li>
                    <li>Let PATH contain only a node which is an <a data-link-type="dfn" class="internalDFN" href="#dfn-unclosed-node">unclosed node</a> of <var>CURRENT-TARGET</var>.</li>
                  </ol>
                </li>
              </ol>
            </div>

            <div id="issue-2" class="issue"><div id="h-issue2" role="heading" aria-level="5" class="issue-title"><span>Issue 2</span></div><p class="">
              The API is not stable and may change. Use <code>FrozenArray</code> as the return type of the <code>deepPath</code> attribute in WebIDL.
              See <a href="https://github.com/w3c/webcomponents/issues/101">Issue #101</a>
            </p></div>
          </dd><dt id="widl-Event-scoped"><code>scoped</code> of type <span class="idlAttrType">boolean</span>, readonly   </dt><dd>
            <p>
              Returns the <dfn id="dfn-scoped-flag" data-dfn-type="dfn">scoped flag</dfn>.
            </p>
          </dd></dl></section>
      </section>

    </section>

    <section property="bibo:hasPart" resource="#shadow-dom-example" typeof="bibo:Chapter" id="shadow-dom-example">
      <!--OddPage--><h2 resource="#h-shadow-dom-example" id="h-shadow-dom-example"><span property="xhv:role" resource="xhv:heading"><span class="secno">9. </span>Shadow DOM Example</span></h2>

      <p>Bob was asked to turn a simple list of links into a News Widget, which has links organized into two categories: breaking news and just news. The current document markup for the stories looks like this:</p>
      <div class="example"><div class="example-title"><span>Example 2</span></div><pre style="" class="example highlight prettyprint prettyprinted"><span class="tag">&lt;ul</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"stories"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/1"</span><span class="tag">&gt;</span><span class="pln">A story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/2"</span><span class="tag">&gt;</span><span class="pln">Another story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="pln"> </span><span class="atn">slot</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/3"</span><span class="tag">&gt;</span><span class="pln">Also a story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/4"</span><span class="tag">&gt;</span><span class="pln">Yet another story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/5"</span><span class="tag">&gt;</span><span class="pln">Awesome story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="pln"> </span><span class="atn">slot</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/6"</span><span class="tag">&gt;</span><span class="pln">Horrible story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
</span><span class="tag">&lt;/ul&gt;</span></pre></div>

      <div id="issue-3" class="issue"><div id="h-issue3" role="heading" aria-level="3" class="issue-title"><span>Issue 3</span></div><p class="">
       It's weird that there are slot attributes in this markup because Bob has not decided to use Shadow DOM yet.
      </p></div>

      <p>To organize the stories, Bob decides to use <strong>shadow DOM</strong>. Doing so will allow Bob to keep the document markup uncluttered, and harnessing the power of insertion point makes sorting stories by class name a very simple task. After getting another cup of <a href="http://en.wikipedia.org/wiki/List_of_coffee_beverages#Green_Eye">Green Eye</a>, he quickly mocks up the following shadow tree, to be hosted by the <code>ul</code> element:</p>
      <div class="example"><div class="example-title"><span>Example 3</span></div><pre style="" class="example highlight prettyprint prettyprinted"><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;ul&gt;</span><span class="pln">
        </span><span class="tag">&lt;slot</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;&lt;/slot&gt;</span><span class="pln"> </span><span class="com">&lt;!-- slot for breaking news --&gt;</span><span class="pln">
    </span><span class="tag">&lt;/ul&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span><span class="pln">
</span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"other"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;ul&gt;</span><span class="pln">
        </span><span class="tag">&lt;slot&gt;&lt;/slot&gt;</span><span class="pln"> </span><span class="com">&lt;!-- slot for the rest of the news --&gt;</span><span class="pln">
    </span><span class="tag">&lt;/ul&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span></pre></div>
      <p>Bob then styles the newborn widget according to comps from the designer by adding this to the shadow tree mockup:</p>
      <div class="example"><div class="example-title"><span>Example 4</span></div><pre style="" class="example highlight prettyprint prettyprinted"><span class="tag">&lt;style&gt;</span><span class="pln">
    div</span><span class="pun">.</span><span class="pln">breaking </span><span class="pun">{</span><span class="pln">
        color</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Red</span><span class="pun">;</span><span class="pln">
        font</span><span class="pun">-</span><span class="pln">size</span><span class="pun">:</span><span class="pln"> </span><span class="lit">20px</span><span class="pun">;</span><span class="pln">
        border</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1px</span><span class="pln"> dashed </span><span class="typ">Purple</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
    div</span><span class="pun">.</span><span class="pln">other </span><span class="pun">{</span><span class="pln">
        padding</span><span class="pun">:</span><span class="pln"> </span><span class="lit">2px</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln">
        border</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1px</span><span class="pln"> solid </span><span class="typ">Cyan</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
</span><span class="tag">&lt;/style&gt;</span></pre></div>
      <p>While pondering if his company should start looking for a new designer, Bob converts the mockup to code:</p>
      <div class="example"><div class="example-title"><span>Example 5</span></div><pre style="" class="example highlight prettyprint prettyprinted"><span class="kwd">function</span><span class="pln"> createStoryGroup</span><span class="pun">(</span><span class="pln">className</span><span class="pun">,</span><span class="pln"> slotName</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> </span><span class="kwd">group</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'div'</span><span class="pun">);</span><span class="pln">
    </span><span class="kwd">group</span><span class="pun">.</span><span class="pln">className </span><span class="pun">=</span><span class="pln"> className</span><span class="pun">;</span><span class="pln">
    </span><span class="com">// Empty string in slot name attribute or absence thereof work the same, so no need for special handling.</span><span class="pln">
    </span><span class="kwd">group</span><span class="pun">.</span><span class="pln">innerHTML </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;ul&gt;&lt;slot name="'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> slotName </span><span class="pun">+</span><span class="pln"> </span><span class="str">'"&gt;&lt;/slot&gt;&lt;/ul&gt;'</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">group</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> createStyle</span><span class="pun">()</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> style </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'style'</span><span class="pun">);</span><span class="pln">
    style</span><span class="pun">.</span><span class="pln">textContent </span><span class="pun">=</span><span class="pln"> </span><span class="str">'div.breaking { color: Red;font-size: 20px; border: 1px dashed Purple; }'</span><span class="pln"> </span><span class="pun">+</span><span class="pln">
        </span><span class="str">'div.other { padding: 2px 0 0 0; border: 1px solid Cyan; }'</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> style</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> makeShadowTree</span><span class="pun">(</span><span class="pln">storyList</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> root </span><span class="pun">=</span><span class="pln"> storyList</span><span class="pun">.</span><span class="pln">attachShadow</span><span class="pun">({</span><span class="pln">mode</span><span class="pun">:</span><span class="pln"> </span><span class="str">'open'</span><span class="pun">});</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStyle</span><span class="pun">());</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStoryGroup</span><span class="pun">(</span><span class="str">'breaking'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'breaking'</span><span class="pun">));</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStoryGroup</span><span class="pun">(</span><span class="str">'other'</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">));</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

document</span><span class="pun">.</span><span class="pln">addEventListener</span><span class="pun">(</span><span class="str">'DOMContentLoaded'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="pun">[].</span><span class="pln">forEach</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="pln">document</span><span class="pun">.</span><span class="pln">querySelectorAll</span><span class="pun">(</span><span class="str">'ul.stories'</span><span class="pun">),</span><span class="pln"> makeShadowTree</span><span class="pun">);</span><span class="pln">
</span><span class="pun">});</span></pre></div>

      <p>Well done, Bob! With the cup of coffee still half-full, the work is complete. Recognizing his awesomeness, Bob returns to teaching n00bs the ways of <a href="https://en.wikipedia.org/wiki/Splatoon">Splatoon</a>.</p>
    </section>

    <section property="bibo:hasPart" resource="#acknowledgements" typeof="bibo:Chapter" id="acknowledgements" class="appendix">
      <!--OddPage--><h2 resource="#h-acknowledgements" id="h-acknowledgements"><span property="xhv:role" resource="xhv:heading"><span class="secno">A. </span>Acknowledgements</span></h2>

      <p><span class="vcard">David Hyatt</span> developed <a href="http://dev.w3.org/2006/xbl2/">XBL 1.0</a>, and <span class="vcard">Ian Hickson</span> co-wrote <a href="http://dev.w3.org/2006/xbl2/">XBL 2.0</a>. These documents provided tremendous insight into the problem of functional encapsulation and greatly influenced this specification.</p>

      <p><span class="vcard">Alex Russell</span> and his considerable forethought triggered a new wave of enthusiasm around the subject of shadow DOM and how it can be applied practically on the Web.</p>

      <p><span class="vcard">Dominic Cooney</span>, <span class="vcard">Hajime Morrita</span>, and <span class="vcard">Roland Steiner</span> worked tirelessly to scope the problem of functional encapsulation within the confines of the Web platform and provided a solid foundation for this document.</p>

      <p>The editor would also like to thank <span class="vcard">Alex Komoroske</span>, <span class="vcard">Anne van Kesteren</span>, <span class="vcard">Brandon Payton</span>, <span class="vcard">Brian Kardell</span>, <span class="vcard">Darin Fisher</span>, <span class="vcard">Eric Bidelman</span>, <span class="vcard">Deepak Sherveghar</span>, <span class="vcard">Edward O'Connor</span>, <span class="vcard">Elisée Maurer</span>, <span class="vcard">Elliott Sprehn</span>, <span class="vcard">Erik Arvidsson</span>, <span class="vcard">Glenn Adams</span>, <span class="vcard">Jonas Sicking</span>, <span class="vcard">Koji Ishii</span>, <span class="vcard">Malte Ubl</span>, <span class="vcard">Mike Taylor</span>, <span class="vcard">Oliver Nightingale</span>, <span class="vcard">Olli Pettay</span>, <span class="vcard">Rafael Weinstein</span>, <span class="vcard">Richard Bradshaw</span>, <span class="vcard">Ruud Steltenpool</span>, <span class="vcard">Sam Dutton</span>, <span class="vcard">Sergey G. Grekhov</span>, <span class="vcard">Shinya Kawanaka</span>, <span class="vcard">Tab Atkins</span>, <span class="vcard">Takashi Sakamoto</span>, and <span class="vcard">Yoshinori Sano</span> for their comments and contributions to this specification.</p>

      <p>This list is too short. There's a lot of work left to do. Please contribute by reviewing and filing bugs—and don't forget to ask the editor to add your name into this section.</p>
    </section>

  

<section property="bibo:hasPart" resource="#references" typeof="bibo:Chapter" id="references" class="appendix"><!--OddPage--><h2 resource="#h-references" id="h-references"><span property="xhv:role" resource="xhv:heading"><span class="secno">B. </span>References</span></h2><section property="bibo:hasPart" resource="#normative-references" typeof="bibo:Chapter" id="normative-references"><h3 resource="#h-normative-references" id="h-normative-references"><span property="xhv:role" resource="xhv:heading"><span class="secno">B.1 </span>Normative references</span></h3><dl resource="" class="bibliography"><dt id="bib-CSS3-UI">[CSS3UI]</dt><dd>Tantek Çelik; Florian Rivoal. <a property="dc:requires" href="http://www.w3.org/TR/css-ui-3/"><cite>CSS Basic User Interface Module Level 3 (CSS3 UI)</cite></a>. 7 July 2015. W3C Candidate Recommendation. URL: <a property="dc:requires" href="http://www.w3.org/TR/css-ui-3/">http://www.w3.org/TR/css-ui-3/</a>
</dd><dt id="bib-CSSOM-VIEW">[CSSOM-VIEW]</dt><dd>Simon Pieters; Glenn Adams. <a property="dc:requires" href="http://www.w3.org/TR/cssom-view/"><cite>CSSOM View Module</cite></a>. 17 December 2013. W3C Working Draft. URL: <a property="dc:requires" href="http://www.w3.org/TR/cssom-view/">http://www.w3.org/TR/cssom-view/</a>
</dd><dt id="bib-DOM">[DOM]</dt><dd>Anne van Kesteren; Aryeh Gregor; Ms2ger; Alex Russell; Robin Berjon. <a property="dc:requires" href="http://www.w3.org/TR/dom/"><cite>W3C DOM4</cite></a>. 18 June 2015. W3C Last Call Working Draft. URL: <a property="dc:requires" href="http://www.w3.org/TR/dom/">http://www.w3.org/TR/dom/</a>
</dd><dt id="bib-DOM-Level-3-Events">[DOM-Level-3-Events]</dt><dd>Gary Kacmarcik; Travis Leithead. <a property="dc:requires" href="http://www.w3.org/TR/uievents/"><cite>UI Events (formerly DOM Level 3 Events)</cite></a>. 28 April 2015. W3C Working Draft. URL: <a property="dc:requires" href="http://www.w3.org/TR/uievents/">http://www.w3.org/TR/uievents/</a>
</dd><dt id="bib-DOM-PARSING">[DOM-PARSING]</dt><dd>Travis Leithead. <a property="dc:requires" href="http://www.w3.org/TR/DOM-Parsing/"><cite>DOM Parsing and Serialization</cite></a>. 17 June 2014. W3C Candidate Recommendation. URL: <a property="dc:requires" href="http://www.w3.org/TR/DOM-Parsing/">http://www.w3.org/TR/DOM-Parsing/</a>
</dd><dt id="bib-EDITING">[EDITING]</dt><dd>Aryeh Gregor. <a property="dc:requires" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html"><cite>HTML Editing APIs</cite></a>. URL: <a property="dc:requires" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html">https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html</a>
</dd><dt id="bib-HTML">[HTML]</dt><dd>Ian Hickson. <a property="dc:requires" href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a property="dc:requires" href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
</dd><dt id="bib-RFC2119">[RFC2119]</dt><dd>S. Bradner. <a property="dc:requires" href="https://tools.ietf.org/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a property="dc:requires" href="https://tools.ietf.org/html/rfc2119">https://tools.ietf.org/html/rfc2119</a>
</dd><dt id="bib-TOUCH-EVENTS">[TOUCH-EVENTS]</dt><dd>Doug Schepers; Sangwhan Moon; Matt Brubeck; Arthur Barstow. <a property="dc:requires" href="http://www.w3.org/TR/touch-events/"><cite>Touch Events</cite></a>. 10 October 2013. W3C Recommendation. URL: <a property="dc:requires" href="http://www.w3.org/TR/touch-events/">http://www.w3.org/TR/touch-events/</a>
</dd><dt id="bib-WAI-ARIA">[WAI-ARIA]</dt><dd>James Craig; Michael Cooper et al. <a property="dc:requires" href="http://www.w3.org/TR/wai-aria/"><cite>Accessible Rich Internet Applications (WAI-ARIA) 1.0</cite></a>. 20 March 2014. W3C Recommendation. URL: <a property="dc:requires" href="http://www.w3.org/TR/wai-aria/">http://www.w3.org/TR/wai-aria/</a>
</dd></dl></section><section property="bibo:hasPart" resource="#informative-references" typeof="bibo:Chapter" id="informative-references"><h3 resource="#h-informative-references" id="h-informative-references"><span property="xhv:role" resource="xhv:heading"><span class="secno">B.2 </span>Informative references</span></h3><dl resource="" class="bibliography"><dt id="bib-css-scoping-1">[css-scoping-1]</dt><dd>Tab Atkins Jr.; Elika Etemad. <a property="dc:references" href="http://www.w3.org/TR/css-scoping-1/"><cite>CSS Scoping Module Level 1</cite></a>. 3 April 2014. W3C Working Draft. URL: <a property="dc:references" href="http://www.w3.org/TR/css-scoping-1/">http://www.w3.org/TR/css-scoping-1/</a>
</dd></dl></section></section></body></html>
<!DOCTYPE html>
<html lang="en" dir="ltr" typeof="bibo:Document w3p:WD" prefix="bibo: http://purl.org/ontology/bibo/ w3p: http://www.w3.org/2001/02pd/rec54#">
<head><meta property="dc:language" content="en" lang="">
    <meta charset="utf-8">
    <title>Shadow DOM</title>
    
    
    <style>/* --- EXAMPLES --- */
div.example-title {
    min-width: 7.5em;
    color: #b9ab2d;
}
div.example-title span {
    text-transform: uppercase;
}
aside.example, div.example, div.illegal-example {
    padding: 0.5em;
    margin: 1em 0;
    position: relative;
    clear: both;
}
div.illegal-example { color: red }
div.illegal-example p { color: black }
aside.example, div.example {
    padding: .5em;
    border-left-width: .5em;
    border-left-style: solid;
    border-color: #e0cb52;
    background: #fcfaee;
}

aside.example div.example {
    border-left-width: .1em;
    border-color: #999;
    background: #fff;
}
aside.example div.example div.example-title {
    color: #999;
}
</style><style>/* --- ISSUES/NOTES --- */
div.issue-title, div.note-title , div.ednote-title, div.warning-title {
    padding-right:  1em;
    min-width: 7.5em;
    color: #b9ab2d;
}
div.issue-title { color: #e05252; }
div.note-title, div.ednote-title { color: #2b2; }
div.warning-title { color: #f22; }
div.issue-title span, div.note-title span, div.ednote-title span, div.warning-title span {
    text-transform: uppercase;
}
div.note, div.issue, div.ednote, div.warning {
    margin-top: 1em;
    margin-bottom: 1em;
}
.note > p:first-child, .ednote > p:first-child, .issue > p:first-child, .warning > p:first-child { margin-top: 0 }
.issue, .note, .ednote, .warning {
    padding: .5em;
    border-left-width: .5em;
    border-left-style: solid;
}
div.issue, div.note , div.ednote,  div.warning {
    padding: 1em 1.2em 0.5em;
    margin: 1em 0;
    position: relative;
    clear: both;
}
span.note, span.ednote, span.issue, span.warning { padding: .1em .5em .15em; }

.issue {
    border-color: #e05252;
    background: #fbe9e9;
}
.note, .ednote {
    border-color: #52e052;
    background: #e9fbe9;
}

.warning {
    border-color: #f11;
    border-right-width: .2em;
    border-top-width: .2em;
    border-bottom-width: .2em;
    border-style: solid;
    background: #fbe9e9;
}

.warning-title:before{
    content: "⚠"; /*U+26A0 WARNING SIGN*/
    font-size: 3em;
    float: left;
    height: 100%;
    padding-right: .3em;
    vertical-align: top;
    margin-top: -0.5em;
}

li.task-list-item {
    list-style: none;
}

input.task-list-item-checkbox {
    margin: 0 0.35em 0.25em -1.6em;
    vertical-align: middle;
}
</style><style>/* HIGHLIGHTS */
code.prettyprint {
    color:  inherit;
}

/* this from google-code-prettify */
.pln{color:#000}@media screen{.str{color:#080}.kwd{color:#008}.com{color:#800}.typ{color:#606}.lit{color:#066}.pun,.opn,.clo{color:#660}.tag{color:#008}.atn{color:#606}.atv{color:#080}.dec,.var{color:#606}.fun{color:red}}@media print,projection{.str{color:#060}.kwd{color:#006;font-weight:bold}.com{color:#600;font-style:italic}.typ{color:#404;font-weight:bold}.lit{color:#044}.pun,.opn,.clo{color:#440}.tag{color:#006;font-weight:bold}.atn{color:#404}.atv{color:#060}}ol.linenums{margin-top:0;margin-bottom:0}li.L0,li.L1,li.L2,li.L3,li.L5,li.L6,li.L7,li.L8{list-style-type:none}li.L1,li.L3,li.L5,li.L7,li.L9{background:#eee}
</style><style>/* --- WEB IDL --- */
pre.idl {
    border-top: 1px solid #90b8de;
    border-bottom: 1px solid #90b8de;
    padding:    1em;
    line-height:    120%;
}

pre.idl::before {
    content:    "WebIDL";
    display:    block;
    width:      150px;
    background: #90b8de;
    color:  #fff;
    font-family:    sans-serif;
    padding:    3px;
    font-weight:    bold;
    margin: -1em 0 1em -1em;
}

.idlType {
    color:  #ff4500;
    font-weight:    bold;
    text-decoration:    none;
}

/*.idlModule*/
/*.idlModuleID*/
/*.idlInterface*/
.idlInterfaceID, .idlDictionaryID, .idlCallbackID, .idlEnumID {
    font-weight:    bold;
    color:  #005a9c;
}
a.idlEnumItem {
    color:  #000;
    border-bottom:  1px dotted #ccc;
    text-decoration: none;
}

.idlSuperclass {
    font-style: italic;
    color:  #005a9c;
}

/*.idlAttribute*/
.idlAttrType, .idlFieldType, .idlMemberType {
    color:  #005a9c;
}
.idlAttrName, .idlFieldName, .idlMemberName {
    color:  #ff4500;
}
.idlAttrName a, .idlFieldName a, .idlMemberName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlMethod*/
.idlMethType, .idlCallbackType {
    color:  #005a9c;
}
.idlMethName {
    color:  #ff4500;
}
.idlMethName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlCtor*/
.idlCtorName {
    color:  #ff4500;
}
.idlCtorName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlParam*/
.idlParamType {
    color:  #005a9c;
}
.idlParamName, .idlDefaultValue {
    font-style: italic;
}

.extAttr {
    color:  #666;
}

/*.idlSectionComment*/
.idlSectionComment {
    color: gray;
}

/*.idlIterable*/
.idlIterableKeyType, .idlIterableValueType {
    color:  #005a9c;
}

/*.idlMaplike*/
.idlMaplikeKeyType, .idlMaplikeValueType {
    color:  #005a9c;
}

/*.idlConst*/
.idlConstType {
    color:  #005a9c;
}
.idlConstName {
    color:  #ff4500;
}
.idlConstName a {
    color:  #ff4500;
    border-bottom:  1px dotted #ff4500;
    text-decoration: none;
}

/*.idlException*/
.idlExceptionID {
    font-weight:    bold;
    color:  #c00;
}

.idlTypedefID, .idlTypedefType {
    color:  #005a9c;
}

.idlRaises, .idlRaises a.idlType, .idlRaises a.idlType code, .excName a, .excName a code {
    color:  #c00;
    font-weight:    normal;
}

.excName a {
    font-family:    monospace;
}

.idlRaises a.idlType, .excName a.idlType {
    border-bottom:  1px dotted #c00;
}

.excGetSetTrue, .excGetSetFalse, .prmNullTrue, .prmNullFalse, .prmOptTrue, .prmOptFalse {
    width:  45px;
    text-align: center;
}
.excGetSetTrue, .prmNullTrue, .prmOptTrue { color:  #0c0; }
.excGetSetFalse, .prmNullFalse, .prmOptFalse { color:  #c00; }

.idlImplements a {
    font-weight:    bold;
}

dl.attributes, dl.methods, dl.constants, dl.constructors, dl.fields, dl.dictionary-members {
    margin-left:    2em;
}

.attributes dt, .methods dt, .constants dt, .constructors dt, .fields dt, .dictionary-members dt {
    font-weight:    normal;
}

.attributes dt code, .methods dt code, .constants dt code, .constructors dt code, .fields dt code, .dictionary-members dt code {
    font-weight:    bold;
    color:  #000;
    font-family:    monospace;
}

.attributes dt code, .fields dt code, .dictionary-members dt code {
    background:  #ffffd2;
}

.attributes dt .idlAttrType code, .fields dt .idlFieldType code, .dictionary-members dt .idlMemberType code {
    color:  #005a9c;
    background:  transparent;
    font-family:    inherit;
    font-weight:    normal;
    font-style: italic;
}

.methods dt code {
    background:  #d9e6f8;
}

.constants dt code {
    background:  #ddffd2;
}

.constructors dt code {
    background:  #cfc;
}

.attributes dd, .methods dd, .constants dd, .constructors dd, .fields dd, .dictionary-members dd {
    margin-bottom:  1em;
}

table.parameters, table.exceptions {
    border-spacing: 0;
    border-collapse:    collapse;
    margin: 0.5em 0;
    width:  100%;
}
table.parameters { border-bottom:  1px solid #90b8de; }
table.exceptions { border-bottom:  1px solid #deb890; }

.parameters th, .exceptions th {
    color:  #fff;
    padding:    3px 5px;
    text-align: left;
    font-weight:    normal;
    text-shadow:    #666 1px 1px 0;
}
.parameters th { background: #90b8de; }
.exceptions th { background: #deb890; }

.parameters td, .exceptions td {
    padding:    3px 10px;
    border-top: 1px solid #ddd;
    vertical-align: top;
}

.parameters tr:first-child td, .exceptions tr:first-child td {
    border-top: none;
}

.parameters td.prmName, .exceptions td.excName, .exceptions td.excCodeName {
    width:  100px;
}

.parameters td.prmType {
    width:  120px;
}

table.exceptions table {
    border-spacing: 0;
    border-collapse:    collapse;
    width:  100%;
}
</style><link rel="stylesheet" href="respec-complement.css" type="text/css">

<link rel="stylesheet" href="working-draft.css" type="text/css">
<script src="working-draft.js"></script>
    
  <style>/*****************************************************************
 * ReSpec 3 CSS
 * Robin Berjon - http://berjon.com/
 *****************************************************************/

/* --- INLINES --- */
em.rfc2119 { 
    text-transform:     lowercase;
    font-variant:       small-caps;
    font-style:         normal;
    color:              #900;
}

h1 acronym, h2 acronym, h3 acronym, h4 acronym, h5 acronym, h6 acronym, a acronym,
h1 abbr, h2 abbr, h3 abbr, h4 abbr, h5 abbr, h6 abbr, a abbr {
    border: none;
}

dfn {
    font-weight:    bold;
}

a.internalDFN {
    color:  inherit;
    border-bottom:  1px solid #99c;
    text-decoration:    none;
}

a.externalDFN {
    color:  inherit;
    border-bottom:  1px dotted #ccc;
    text-decoration:    none;
}

a.bibref {
    text-decoration:    none;
}

cite .bibref {
    font-style: normal;
}

code {
    color:  #C83500;
}

/* --- TOC --- */
.toc a, .tof a {
    text-decoration:    none;
}

a .secno, a .figno {
    color:  #000;
}

ul.tof, ol.tof {
    list-style: none outside none;
}

.caption {
    margin-top: 0.5em;
    font-style:   italic;
}

/* --- TABLE --- */
table.simple {
    border-spacing: 0;
    border-collapse:    collapse;
    border-bottom:  3px solid #005a9c;
}

.simple th {
    background: #005a9c;
    color:  #fff;
    padding:    3px 5px;
    text-align: left;
}

.simple th[scope="row"] {
    background: inherit;
    color:  inherit;
    border-top: 1px solid #ddd;
}

.simple td {
    padding:    3px 10px;
    border-top: 1px solid #ddd;
}

.simple tr:nth-child(even) {
    background: #f0f6ff;
}

/* --- DL --- */
.section dd > p:first-child {
    margin-top: 0;
}

.section dd > p:last-child {
    margin-bottom: 0;
}

.section dd {
    margin-bottom:  1em;
}

.section dl.attrs dd, .section dl.eldef dd {
    margin-bottom:  0;
}

@media print {
    .removeOnSave {
        display: none;
    }
}
</style><link href="https://www.w3.org/StyleSheets/TR/W3C-WD" rel="stylesheet"><!--[if lt IE 9]><script src='https://www.w3.org/2008/site/js/html5shiv.js'></script><![endif]--><script type="application/json" id="initialUserConfig">{
  "specStatus": "ED",
  "shortName": "shadow-dom",
  "editors": [
    {
      "name": "Dimitri Glazkov",
      "url": "mailto:dglazkov@chromium.org",
      "company": "Google, Inc."
    },
    {
      "name": "Hayato Ito",
      "url": "mailto:hayato@google.com",
      "company": "Google, Inc."
    }
  ],
  "wg": "W3C Web Applications (WebApps)",
  "wgURI": "http://www.w3.org/2008/webapps/",
  "wgPublicList": "public-webapps",
  "wgPatentURI": "",
  "edDraftURI": "http://w3c.github.io/webcomponents/spec/shadow/",
  "otherLinks": [
    {
      "key": "Revision history",
      "href": "https://github.com/w3c/webcomponents/commits/gh-pages/spec/shadow/"
    },
    {
      "key": "Bugs filed",
      "href": "https://github.com/w3c/webcomponents/labels/shadow-dom"
    }
  ],
  "preProcess": [
    null
  ],
  "localBiblio": {
    "EDITING": {
      "title": "HTML Editing APIs",
      "href": "https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html",
      "authors": [
        "Aryeh Gregor"
      ]
    }
  }
}</script></head>
  <body id="respecDocument" role="document" class="h-entry"><div id="respecHeader" role="contentinfo" class="head">
  <p>
      
        
            <a href="http://www.w3.org/"><img src="https://www.w3.org/Icons/w3c_home" alt="W3C" height="48" width="72"></a>
            
            
        
      
  </p>
  <h1 class="title p-name" id="title" property="dcterms:title">Shadow DOM</h1>
  
  <h2 id="w3c-working-draft-08-october-2015"><abbr title="World Wide Web Consortium">W3C</abbr> Working Draft <time property="dcterms:issued" class="dt-published" datetime="2015-10-08">08 October 2015</time></h2>
  <dl>
    
      <dt>This version:</dt>
      <dd><a class="u-url" href="http://www.w3.org/TR/2015/WD-shadow-dom-20151008/">http://www.w3.org/TR/2015/WD-shadow-dom-20151008/</a></dd>
      <dt>Latest published version:</dt>
      <dd><a href="http://www.w3.org/TR/shadow-dom/">http://www.w3.org/TR/shadow-dom/</a></dd>
    
    
      <dt>Latest editor's draft:</dt>
      <dd><a href="http://w3c.github.io/webcomponents/spec/shadow/">http://w3c.github.io/webcomponents/spec/shadow/</a></dd>
    
    
    
    
    
    
      <dt>Previous version:</dt>
      <dd><a rel="dcterms:replaces" href="http://www.w3.org/TR/2014/WD-shadow-dom-20140617/">http://www.w3.org/TR/2014/WD-shadow-dom-20140617/</a></dd>
    
    
    <dt>Editors:</dt>
    <dd class="p-author h-card vcard" property="bibo:editor" resource="_:editor0"><span property="rdf:first" typeof="foaf:Person"><meta property="foaf:name" content="Dimitri Glazkov"><a class="u-url url p-name fn" property="foaf:homepage" href="mailto:dglazkov@chromium.org">Dimitri Glazkov</a>, Google, Inc.</span>
<span property="rdf:rest" resource="_:editor1"></span>
</dd>
<dd class="p-author h-card vcard" resource="_:editor1"><span property="rdf:first" typeof="foaf:Person"><meta property="foaf:name" content="Hayato Ito"><a class="u-url url p-name fn" property="foaf:homepage" href="mailto:hayato@google.com">Hayato Ito</a>, Google, Inc.</span>
<span property="rdf:rest" resource="rdf:nil"></span>
</dd>

    
    
      
        
          <dt>Revision history:</dt>
          
            
              
                <dd>
                  <a href="https://github.com/w3c/webcomponents/commits/gh-pages/spec/shadow/">https://github.com/w3c/webcomponents/commits/gh-pages/spec/shadow/</a>
                </dd>
              
            
          
        
      
        
          <dt>Bugs filed:</dt>
          
            
              
                <dd>
                  <a href="https://github.com/w3c/webcomponents/labels/shadow-dom">https://github.com/w3c/webcomponents/labels/shadow-dom</a>
                </dd>
              
            
          
        
      
    
  </dl>
  
  
  
  
    
      <p class="copyright">
        <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> ©
        2015
        
        <a href="http://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>®</sup>
        (<a href="http://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>,
        <a href="http://www.ercim.eu/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>,
        <a href="http://www.keio.ac.jp/">Keio</a>, <a href="http://ev.buaa.edu.cn/">Beihang</a>). 
        
        <abbr title="World Wide Web Consortium">W3C</abbr> <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>,
        <a href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and
        
          <a href="http://www.w3.org/Consortium/Legal/copyright-documents">document use</a>
        
        rules apply.
      </p>
    
  
  <hr>
</div>
    <section property="dc:abstract" class="introductory" id="abstract"><h2 resource="#h-abstract" id="h-abstract"><span property="xhv:role" resource="xhv:heading">Abstract</span></h2>
      <p>
        This specification describes a method of combining multiple DOM trees into one hierarchy and how these trees interact with each other within a document, thus
        enabling better composition of the DOM.
      </p>
    </section><section id="sotd" class="introductory"><h2 resource="#h-sotd" id="h-sotd"><span property="xhv:role" resource="xhv:heading">Status of This Document</span></h2>
  


      <div id="wipcontainer">
        <p class="stability" id="wip">
          <strong>This is a work in progress!</strong>
          This specification is for review and not for implementation! For the latest updates,
          including important bug fixes, please look at the
          <a href="http://w3c.github.io/webcomponents/spec/shadow/">draft on GitHub</a> instead.
          <input onclick="hideWIP(this)" value="×" type="button">
        </p>
      </div>
    
      
        <p>
          <em>This section describes the status of this document at the time of its publication. Other documents may supersede this document. A list of current <abbr title="World Wide Web Consortium">W3C</abbr> publications and the latest revision of this technical report can be found in the <a href="http://www.w3.org/TR/"><abbr title="World Wide Web Consortium">W3C</abbr> technical reports index</a> at http://www.w3.org/TR/.</em>
        </p>
        
          
          
    
          
          <p>
            This document was published by the <a href="http://www.w3.org/2008/webapps/"><abbr title="World Wide Web Consortium">W3C</abbr> Web Applications (WebApps)</a> as a Working Draft.
            
              This document is intended to become a <abbr title="World Wide Web Consortium">W3C</abbr> Recommendation.
            
            
              If you wish to make comments regarding this document, please send them to
              <a href="mailto:public-webapps@w3.org">public-webapps@w3.org</a>
              (<a href="mailto:public-webapps-request@w3.org?subject=subscribe">subscribe</a>,
              <a href="http://lists.w3.org/Archives/Public/public-webapps/">archives</a>).
            
            
            
            
            
              
              All comments are welcome.
              
            
          </p>
          
          
          
            <p>
              Publication as a Working Draft does not imply endorsement by the <abbr title="World Wide Web Consortium">W3C</abbr>
              Membership. This is a draft document and may be updated, replaced or obsoleted by other
              documents at any time. It is inappropriate to cite this document as other than work in
              progress.
            </p>
          
          
          
          <p>
            
              This document was produced by
              
              a group
               operating under the
              <a id="sotd_patent" property="w3p:patentRules" href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004 <abbr title="World Wide Web Consortium">W3C</abbr> Patent
              Policy</a>.
            
            
            
              
                <abbr title="World Wide Web Consortium">W3C</abbr> maintains a <a href="" rel="disclosure">public list of any patent
                disclosures</a>
              
              made in connection with the deliverables of
              
              the group; that page also includes
              
              instructions for disclosing a patent. An individual who has actual knowledge of a patent
              which the individual believes contains
              <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential
              Claim(s)</a> must disclose the information in accordance with
              <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section
              6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>.
            
            
          </p>
          
            <p>This document is governed by the <a id="w3c_process_revision" href="http://www.w3.org/2015/Process-20150901/">1 September 2015 <abbr title="World Wide Web Consortium">W3C</abbr> Process Document</a>.
            </p>
          
          
        
      
    
  
</section><section id="toc"><h2 resource="#h-toc" id="h-toc" class="introductory"><span property="xhv:role" resource="xhv:heading">Table of Contents</span></h2><ul id="respecContents" role="directory" class="toc"><li class="tocline"><a class="tocxref" href="#conformance"><span class="secno">1. </span>Conformance</a></li><li class="tocline"><a class="tocxref" href="#concepts"><span class="secno">2. </span>Concepts</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#shadow-trees"><span class="secno">2.1 </span>Shadow trees</a></li><li class="tocline"><a class="tocxref" href="#trees-of-trees"><span class="secno">2.2 </span>Trees of trees</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#example-tree-of-trees"><span class="secno">2.2.1 </span>Example tree of trees</a></li></ul></li><li class="tocline"><a class="tocxref" href="#composed-trees"><span class="secno">2.3 </span>Composed trees</a></li></ul></li><li class="tocline"><a class="tocxref" href="#distributions"><span class="secno">3. </span>Distributions</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#slots"><span class="secno">3.1 </span>Slots</a></li><li class="tocline"><a class="tocxref" href="#slotting-algorithm"><span class="secno">3.2 </span>Slotting Algorithm</a></li><li class="tocline"><a class="tocxref" href="#distributed-nodes-algorithm"><span class="secno">3.3 </span>Distributed Nodes Algorithm</a></li></ul></li><li class="tocline"><a class="tocxref" href="#composition"><span class="secno">4. </span>Composition</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#composition-algorithm"><span class="secno">4.1 </span>Composition Algorithm</a></li><li class="tocline"><a class="tocxref" href="#composition-example"><span class="secno">4.2 </span>Composition Example</a></li></ul></li><li class="tocline"><a class="tocxref" href="#events"><span class="secno">5. </span>Events</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#events-that-are-not-leaked-into-ancestor-trees"><span class="secno">5.1 </span>Events that are not leaked into ancestor trees</a></li><li class="tocline"><a class="tocxref" href="#event-paths"><span class="secno">5.2 </span>Event Paths</a></li><li class="tocline"><a class="tocxref" href="#event-paths-example"><span class="secno">5.3 </span>Event Paths Example</a></li><li class="tocline"><a class="tocxref" href="#event-retargeting"><span class="secno">5.4 </span>Event Retargeting</a></li><li class="tocline"><a class="tocxref" href="#retargeting-relatedtarget"><span class="secno">5.5 </span>Retargeting <code>relatedTarget</code></a></li><li class="tocline"><a class="tocxref" href="#retargeting-touch-events"><span class="secno">5.6 </span>Retargeting Touch Events</a></li><li class="tocline"><a class="tocxref" href="#retargeting-focus-events"><span class="secno">5.7 </span>Retargeting Focus Events</a></li><li class="tocline"><a class="tocxref" href="#event-path-trimming"><span class="secno">5.8 </span>Event Path Trimming</a></li><li class="tocline"><a class="tocxref" href="#event-dispatch"><span class="secno">5.9 </span>Event Dispatch</a></li><li class="tocline"><a class="tocxref" href="#event-retargeting-example"><span class="secno">5.10 </span>Event Retargeting Example</a></li></ul></li><li class="tocline"><a class="tocxref" href="#user-interaction"><span class="secno">6. </span>User Interaction</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#ranges-and-selections"><span class="secno">6.1 </span>Ranges and Selections</a></li><li class="tocline"><a class="tocxref" href="#focus-navigation"><span class="secno">6.2 </span>Focus Navigation</a></li><li class="tocline"><a class="tocxref" href="#active-element"><span class="secno">6.3 </span>Active Element</a></li><li class="tocline"><a class="tocxref" href="#editing"><span class="secno">6.4 </span>Editing</a></li><li class="tocline"><a class="tocxref" href="#assistive-technology"><span class="secno">6.5 </span>Assistive Technology</a></li><li class="tocline"><a class="tocxref" href="#hit-testing"><span class="secno">6.6 </span>Hit Testing</a></li></ul></li><li class="tocline"><a class="tocxref" href="#html-elements-in-shadow-trees"><span class="secno">7. </span>HTML Elements in Shadow Trees</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#inertness-of-html-elements-in-a-shadow-tree"><span class="secno">7.1 </span>Inertness of HTML Elements in a shadow tree</a></li><li class="tocline"><a class="tocxref" href="#attributes"><span class="secno">7.2 </span>Attributes</a></li></ul></li><li class="tocline"><a class="tocxref" href="#elements-and-dom-interfaces"><span class="secno">8. </span>Elements and DOM interfaces</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#the-shadowroot-interface"><span class="secno">8.1 </span>The <code>ShadowRoot</code> interface</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#attributes-1"><span class="secno">8.1.1 </span>Attributes</a></li><li class="tocline"><a class="tocxref" href="#methods"><span class="secno">8.1.2 </span>Methods</a></li></ul></li><li class="tocline"><a class="tocxref" href="#extensions-to-element-interface"><span class="secno">8.2 </span>Extensions to <code>Element</code> Interface</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#attributes-2"><span class="secno">8.2.1 </span>Attributes</a></li><li class="tocline"><a class="tocxref" href="#methods-1"><span class="secno">8.2.2 </span>Methods</a></li></ul></li><li class="tocline"><a class="tocxref" href="#shadowrootinit-dictionary"><span class="secno">8.3 </span><code>ShadowRootInit</code> dictionary</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#dictionary-shadowrootinit-members"><span class="secno">8.3.1 </span>Dictionary <span class="formerLink"><code>ShadowRootInit</code></span> Members</a></li></ul></li><li class="tocline"><a class="tocxref" href="#shadowrootmode-enum"><span class="secno">8.4 </span><code>ShadowRootMode</code> enum</a></li><li class="tocline"><a class="tocxref" href="#extensions-to-nondocumenttypechildnode-interface"><span class="secno">8.5 </span>Extensions to <code>NonDocumentTypeChildNode</code> Interface</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#attributes-3"><span class="secno">8.5.1 </span>Attributes</a></li></ul></li><li class="tocline"><a class="tocxref" href="#the-slot-element"><span class="secno">8.6 </span>The <code>slot</code> element</a></li><li class="tocline"><a class="tocxref" href="#extensions-to-eventinit-dictionary"><span class="secno">8.7 </span>Extensions to <span class="formerLink"><code>EventInit</code></span> Dictionary</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#dictionary-eventinit-members"><span class="secno">8.7.1 </span>Dictionary <span class="formerLink"><code>EventInit</code></span> Members</a></li></ul></li><li class="tocline"><a class="tocxref" href="#extensions-to-event-interface"><span class="secno">8.8 </span>Extensions to <code>Event</code> Interface</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#attributes-4"><span class="secno">8.8.1 </span>Attributes</a></li></ul></li></ul></li><li class="tocline"><a class="tocxref" href="#shadow-dom-example"><span class="secno">9. </span>Shadow DOM Example</a></li><li class="tocline"><a class="tocxref" href="#acknowledgements"><span class="secno">A. </span>Acknowledgements</a></li><li class="tocline"><a class="tocxref" href="#references"><span class="secno">B. </span>References</a><ul class="toc"><li class="tocline"><a class="tocxref" href="#normative-references"><span class="secno">B.1 </span>Normative references</a></li><li class="tocline"><a class="tocxref" href="#informative-references"><span class="secno">B.2 </span>Informative references</a></li></ul></li></ul></section>

    

    <section property="bibo:hasPart" resource="#conformance" typeof="bibo:Chapter" id="conformance">
      <!--OddPage--><h2 resource="#h-conformance" id="h-conformance"><span property="xhv:role" resource="xhv:heading"><span class="secno">1. </span>Conformance</span></h2>

      <p>All diagrams, examples, notes, are non-normative, as well as sections explicitly marked as non-normative. Everything else in this specification is normative.</p>

      <p>The key words "<em title="MUST" class="rfc2119">MUST</em>", "<em title="MUST NOT" class="rfc2119">MUST NOT</em>", "<em title="REQUIRED" class="rfc2119">REQUIRED</em>", "<em title="SHALL" class="rfc2119">SHALL</em>", "<em title="SHALL NOT" class="rfc2119">SHALL NOT</em>", "<em title="SHOULD" class="rfc2119">SHOULD</em>", "<em title="SHOULD NOT" class="rfc2119">SHOULD NOT</em>", "<em title="RECOMMENDED" class="rfc2119">RECOMMENDED</em>", "<em title="MAY" class="rfc2119">MAY</em>", and "<em title="OPTIONAL" class="rfc2119">OPTIONAL</em>" in the normative parts of this document are to be interpreted as described in [<cite><a href="#bib-RFC2119" class="bibref">RFC2119</a></cite>]. For readability, these words do not appear in all uppercase letters in this specification.</p>

      <p>To help with layering and to avoid circular dependencies between various parts of specification, this document consists of three consecutive narratives:</p>
      <ol>
        <li>setting up the stage for the specification,</li>
        <li>explaining of the conceptual model and algorithms behind it, and</li>
        <li>expressing this model with DOM interfaces and HTML elements.</li>
      </ol>

      <p>In a sense, these parts can be viewed as <em>math</em>, which sets up the reasoning environment, <em>physics</em>, which is the theoretical reasoning about the concept, and <em>mechanics</em>, which is the practical application of this reasoning.</p>

      <p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="http://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence" data-dfn-type="dfn">processing equivalence</dfn> is a constraint imposed on the algorithm implementors, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>
    </section>

    <section property="bibo:hasPart" resource="#concepts" typeof="bibo:Chapter" id="concepts">
      <!--OddPage--><h2 resource="#h-concepts" id="h-concepts"><span property="xhv:role" resource="xhv:heading"><span class="secno">2. </span>Concepts</span></h2>

      <section property="bibo:hasPart" resource="#shadow-trees" typeof="bibo:Chapter" id="shadow-trees">
        <h3 resource="#h-shadow-trees" id="h-shadow-trees"><span property="xhv:role" resource="xhv:heading"><span class="secno">2.1 </span>Shadow trees</span></h3>

        <p>A <dfn id="dfn-document-tree" data-dfn-type="dfn">document tree</dfn> is a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> [<cite><a href="#bib-DOM" class="bibref">DOM</a></cite>] whose <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> is a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-document">document</a>.</p>

        <p>Any element can <dfn id="dfn-host" data-dfn-type="dfn">host</dfn> zero or one associated <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree" data-lt="node tree">node trees</a>, called a <dfn id="dfn-shadow-tree" data-dfn-type="dfn">shadow tree</dfn>.

        </p><p>A <dfn id="dfn-shadow-host" data-dfn-type="dfn">shadow host</dfn> is an element that <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> one <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree" data-lt="node tree">shadow tree</a>.

        </p><p>A shadow tree has an associated flag, called an <dfn id="dfn-encapsulation-mode" data-dfn-type="dfn">encapsulation mode</dfn>, which is either <dfn id="dfn-open" data-dfn-type="dfn">open</dfn> or <dfn id="dfn-closed" data-dfn-type="dfn">closed</dfn>.

        </p><p>A <dfn id="dfn-shadow-root" data-dfn-type="dfn">shadow root</dfn> is the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> of a shadow tree.</p>

        <p>
          A node <var>A</var> is called a <dfn id="dfn-deep-child" data-dfn-type="dfn">deep child</dfn> of a node <var>B</var>,
          if either <var>A</var> is a child of <var>B</var> or A is the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> node of the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a> that B <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a>.
        </p>

        <p>
          A node <var>A</var> is called a <dfn id="dfn-deep-descendant" data-dfn-type="dfn">deep descendant</dfn> of a node <var>B</var>,
          if either <var>A</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-deep-child">deep child</a> of <var>B</var>
          or <var>A</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-deep-child">deep child</a> of a node <var>C</var> that is a <a data-link-type="dfn" class="internalDFN" href="#dfn-deep-descendant">deep descendant</a> of <var>B</var>.
        </p>

        <p>
          An <dfn id="dfn-inclusive-deep-descendant" data-dfn-type="dfn">inclusive deep descendant</dfn> is a node or one of its <a data-link-type="dfn" class="internalDFN" href="#dfn-deep-descendant" data-lt="deep descendant">deep descendants</a>.
        </p>

        <p>
          A node <var>A</var> is called a <dfn id="dfn-deep-parent" data-dfn-type="dfn">deep parent</dfn> of a node <var>B</var>
          if and only if <var>B</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-deep-child">deep child</a> of <var>A</var>.
        </p>

        <p>
          A node <var>A</var> is called a <dfn id="dfn-deep-ancestor" data-dfn-type="dfn">deep ancestor</dfn> of a node <var>B</var>
          if and only if <var>B</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-deep-descendant">deep descendant</a> of <var>A</var>.
        </p>

        <p>
          An <dfn id="dfn-inclusive-deep-ancestor" data-dfn-type="dfn">inclusive deep ancestor</dfn> is a node or one of its <a data-link-type="dfn" class="internalDFN" href="#dfn-deep-ancestor" data-lt="deep ancestor">deep ancestors</a>.
        </p>

        <p>
          When an element is an <a data-link-type="dfn" class="internalDFN" href="#dfn-inclusive-deep-descendant">inclusive deep descendant</a> of a <a class="externalDFN" href="http://dom.spec.whatwg.org/#document-element">document element</a>, it is <dfn id="dfn-in-a-document-deeply" data-dfn-type="dfn">in a document deeply</dfn>.
        </p>

      </section>

      <section property="bibo:hasPart" resource="#trees-of-trees" typeof="bibo:Chapter" id="trees-of-trees">
        <h3 resource="#h-trees-of-trees" id="h-trees-of-trees"><span property="xhv:role" resource="xhv:heading"><span class="secno">2.2 </span>Trees of trees</span></h3>

        <p>A <dfn id="dfn-tree-of-trees" data-dfn-type="dfn">tree of trees</dfn> is a <a class="externalDFN" href="http://dom.spec.whatwg.org/#trees">tree</a> of <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree" data-lt="node tree">node trees</a>.</p>

        <div class="note"><div id="h-note1" role="heading" aria-level="4" class="note-title"><span>Note</span></div><p class="">
          The purpose of introducing a tree of trees here is to define algorithms easily in the following sections.
          This is a kind of a notation techchique to make the this specification simpler.
        </p></div>

        <p>Just like a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> is defined as <a class="externalDFN" href="http://dom.spec.whatwg.org/#trees" data-lt="tree">a set of relationships</a> between <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node" data-lt="node">nodes</a>,
          a <a data-link-type="dfn" class="internalDFN" href="#dfn-tree-of-trees">tree of trees</a> is similarly defined as a set of relationships between <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree" data-lt="node tree">node trees</a>:</p>
        <ul>
          <li>
            A <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> <var>A</var> is called a <dfn id="dfn-parent-tree" data-dfn-type="dfn">parent tree</dfn> of a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> <var>B</var> if B is a shadow tree and the shadow host which hosts <var>B</var> participates in <var>A</var>.
          </li>
          <li>
            A <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> <var>A</var> is called a <dfn id="dfn-preceding-sibling-tree" data-dfn-type="dfn">preceding sibling tree</dfn> of a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> <var>B</var> if all of the following conditions are satisfied:
            <ol>
              <li><var>A</var> and <var>B</var> share the same <a data-link-type="dfn" class="internalDFN" href="#dfn-parent-tree">parent tree</a>.</li>
              <li>The <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a> which <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> <var>A</var> is <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-preceding">preceding</a> the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a> which <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> <var>B</var>.</li>
            </ol>
          </li>
          <li>Other relationships and terms, such as <dfn id="dfn-root-tree" data-dfn-type="dfn">root tree</dfn>, <dfn id="dfn-child-tree" data-dfn-type="dfn">child tree</dfn>,
            <dfn id="dfn-descendant-tree" data-dfn-type="dfn">descendant tree</dfn>, <dfn id="dfn-inclusive-descendant-tree" data-dfn-type="dfn">inclusive descendant tree</dfn>,
            <dfn id="dfn-ancestor-tree" data-dfn-type="dfn">ancestor tree</dfn>, <dfn id="dfn-inclusive-ancestor-tree" data-dfn-type="dfn">inclusive ancestor tree</dfn>,
            <dfn id="dfn-preceding-tree" data-dfn-type="dfn">preceding tree</dfn>
            are defined in the similar way as defined in <a class="externalDFN" href="http://dom.spec.whatwg.org/#trees" data-lt="tree">trees</a>.</li>
        </ul>

        <p>
          A <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> <var>A</var> is called an <dfn id="dfn-unclosed-tree" data-dfn-type="dfn">unclosed tree</dfn> of a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> <var>B</var> if and only if one, at least, of the following conditions is satisfied:
        </p>

        <ul>
          <li><var>A</var> is an <a data-link-type="dfn" class="internalDFN" href="#dfn-inclusive-ancestor-tree">inclusive ancestor tree</a> of <var>B</var>.</li>
          <li>The <a data-link-type="dfn" class="internalDFN" href="#dfn-encapsulation-mode">encapsulation mode</a> of <var>A</var> is <a data-link-type="dfn" class="internalDFN" href="#dfn-open">open</a> and <var>A</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-child-tree">child tree</a> of <var>B</var>.</li>
          <li><var>A</var> is an <a data-link-type="dfn" class="internalDFN" href="#dfn-unclosed-tree">unclosed tree</a> of a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> <var>C</var> that is an <a data-link-type="dfn" class="internalDFN" href="#dfn-unclosed-tree">unclosed tree</a> of <var>B</var>.</li>
        </ul>

        <p>
          A node <var>A</var> is called an <dfn id="dfn-unclosed-node" data-dfn-type="dfn">unclosed node</dfn> of a node <var>B</var> if and only if the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> that <var>A</var> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-participate">participates</a> in
          is an <a data-link-type="dfn" class="internalDFN" href="#dfn-unclosed-tree">unclosed tree</a> of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> that <var>B</var> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-participate">participates</a> in.
        </p>

        <p>The <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-node-ownerdocument"><code>ownerDocument</code></a> property of a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> in a shadow tree <strong>must</strong> refers to the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-document">document</a> of the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a> which <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> the shadow tree.</p>

        <p><a class="externalDFN" href="http://html.spec.whatwg.org/#window"><code>Window</code></a> object <a class="externalDFN" href="http://html.spec.whatwg.org/#named-access-on-the-window-object" data-lt="named access on the window object">named properties</a> [<cite><a href="#bib-HTML" class="bibref">HTML</a></cite>] <strong>must</strong> access the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node" data-lt="node">nodes</a> in the <a data-link-type="dfn" class="internalDFN" href="#dfn-document-tree">document tree</a>.</p>

        <section property="bibo:hasPart" resource="#example-tree-of-trees" typeof="bibo:Chapter" id="example-tree-of-trees" class="informative">
          <h4 resource="#h-example-tree-of-trees" id="h-example-tree-of-trees"><span property="xhv:role" resource="xhv:heading"><span class="secno">2.2.1 </span>Example tree of trees</span></h4><p><em>This section is non-normative.</em></p>

          <figure id="fig-a-tree-of-trees.x">
            <object data="tree-of-trees.svg" height="823" width="650"></object>
            <figcaption>Fig. <span class="figno">1</span> <span class="fig-title">
              A tree of trees.
            </span></figcaption>
          </figure>

          <p>
            In the figure, there are six node trees, named <code>A</code>, <code>B</code>, <code>C</code>, <code>D</code>, <code>E</code> and <code>F</code>.
            The shadow trees, <code>B</code>, <code>C</code> and <code>D</code>, are hosted by elements which participate in the document tree <code>A</code>.
            The shadow trees, <code>E</code> and <code>F</code>, are hosted by elements which participates in the shadow tree <code>D</code>.
            The following set of relationships holds in the figure:
          </p>
          <ul>
            <li>The ordered list of <code>A</code>'s <a data-link-type="dfn" class="internalDFN" href="#dfn-child-tree" data-lt="child tree">child trees</a> is [<code>B</code>, <code>C</code>, <code>D</code>].</li>
            <li>The ordered list of <code>B</code>'s <a data-link-type="dfn" class="internalDFN" href="#dfn-child-tree" data-lt="child tree">child trees</a> is [].</li>
            <li>The ordered list of <code>C</code>'s <a data-link-type="dfn" class="internalDFN" href="#dfn-child-tree" data-lt="child tree">child trees</a> is [].</li>
            <li>The ordered list of <code>D</code>'s <a data-link-type="dfn" class="internalDFN" href="#dfn-child-tree" data-lt="child tree">child trees</a> is [<code>E</code>, <code>F</code>].</li>
            <li>The ordered list of <code>E</code>'s <a data-link-type="dfn" class="internalDFN" href="#dfn-child-tree" data-lt="child tree">child trees</a> is [].</li>
            <li>The ordered list of <code>F</code>'s <a data-link-type="dfn" class="internalDFN" href="#dfn-child-tree" data-lt="child tree">child trees</a> is [].</li>
            <li>The document tree, <code>A</code>, is the <a data-link-type="dfn" class="internalDFN" href="#dfn-root-tree">root tree</a> of the <a data-link-type="dfn" class="internalDFN" href="#dfn-tree-of-trees">tree of trees</a>.</li>
          </ul>

          <div class="note"><div id="h-note2" role="heading" aria-level="5" class="note-title"><span>Note</span></div><div class="">
            <p>
              As for a relationship between nodes, it's worth mentioning that there is no <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-ancestor">ancestor</a>/<a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-descendant">descendant</a> relationships between two nodes if they participate in different node trees.
              A shadow root is not a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-child">child</a> node of the shadow host. The <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-parent">parent</a> node of a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a> doesn't exist.
              Because of this nature, most of existing APIs are <strong>scoped</strong> and don't affect other node trees, even though they are forming one tree of trees.
              For example, <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-nonelementparentnode-getelementbyid" data-lt="getElementById"><code>document.getElementById(elementId)</code></a> never returns an element in a shadow tree,
              even when the element has the given <code>elementId</code>.
            </p>
            <p>
              The same thing also applies to CSS <a class="externalDFN" href="http://dev.w3.org/csswg/selectors4/" data-lt="selectors">Selectors</a> matching.
              For example, a <a class="externalDFN" href="http://dev.w3.org/csswg/selectors4/#descendant-combinators" data-lt="descendant combinators">descendant combinator</a> never descends into a node in a <a data-link-type="dfn" class="internalDFN" href="#dfn-child-tree" data-lt="child tree">child</a> <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>
              because a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a> is not a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-child">child</a> node of the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a>.
              Unless a special CSS Selector for Shadow DOM, which is mentioned later, is used, a CSS Selector never matches an element in a different node tree.
            </p>
          </div></div>
          <div class="note"><div id="h-note3" role="heading" aria-level="5" class="note-title"><span>Note</span></div><p class="">
            Because <code>ShadowRoot</code> inherits <code>DocumentFragment</code>, as <a href="#idl-def-ShadowRoot">specified</a> later,
            you can use <code>ShadowRoot.getElementByID(elementId)</code> to get a node in the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.
          </p></div>
        </section>

      </section>

      <section property="bibo:hasPart" resource="#composed-trees" typeof="bibo:Chapter" id="composed-trees">
        <h3 resource="#h-composed-trees" id="h-composed-trees"><span property="xhv:role" resource="xhv:heading"><span class="secno">2.3 </span>Composed trees</span></h3>

        <p>A <dfn id="dfn-composed-tree" data-dfn-type="dfn">composed tree</dfn> is a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> which is constructed out of <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node" data-lt="node">nodes</a> from multiple <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree" data-lt="node tree">node trees</a> in a <a data-link-type="dfn" class="internalDFN" href="#dfn-tree-of-trees">tree of trees</a>.
          The exact algorithm of constructing a composed tree is specified later.</p>

        <figure id="fig-a-composed-tree">
          <object data="composed-tree.svg" height="606" width="654"></object>
          <figcaption>Fig. <span class="figno">2</span> <span class="fig-title">A composed tree</span></figcaption>
        </figure>

        <p>A <dfn id="dfn-document-composed-tree" data-dfn-type="dfn">document composed tree</dfn> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> whose root node is a document</p>

        <p>A node is <dfn id="dfn-in-a-document-composed-tree" data-dfn-type="dfn">in a document composed tree</dfn> if it participates in a <a data-link-type="dfn" class="internalDFN" href="#dfn-document-composed-tree">document composed tree</a>.</p>

        <p>
          Unless an element is <a data-link-type="dfn" class="internalDFN" href="#dfn-in-a-document-composed-tree">in a document composed tree</a>, the element <strong>must not</strong> create any CSS <a class="externalDFN" href="http://www.w3.org/TR/CSS21/box.html">box</a>.
        </p>
        <p>
          In resolving CSS <a class="externalDFN" href="http://www.w3.org/TR/css3-cascade/#inheritance">inheritance</a>, an element <strong>must</strong> inherit from the parent node in the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a>, if applicable.
        </p>
        <p>
          User agents <strong>must</strong> use the <a data-link-type="dfn" class="internalDFN" href="#dfn-document-composed-tree">document composed tree</a> in the <a class="externalDFN" href="http://www.w3.org/TR/CSS21/visuren.html">visual formatting model</a>, instead of the <a data-link-type="dfn" class="internalDFN" href="#dfn-document-tree">document tree</a>.
        </p>

        <div class="note"><div id="h-note4" role="heading" aria-level="4" class="note-title"><span>Note</span></div><div class="">
          <p>
            The editor's draft of CSS Scoping specification [<cite><a href="#bib-css-scoping-1" class="bibref">css-scoping-1</a></cite>] defines the selectors which are related to Shadow DOM.
            Specifically, it defines the following selectors related to Shadow DOM:
          </p>

          <ul>
            <li><code>::shadow</code> pseudo element</li>
            <li><code>/deep/</code> combinator,  which was replaced with a <code>&gt;&gt;&gt;</code> combinator (or <strong>shadow piercing descendant combinator</strong>)</li>
            <li><code>::content</code> pseudo-element</li>
            <li><code>:host</code> pseudo-class and <code>:host()</code> functional pseudo-class</li>
            <li><code>:host-context()</code> functional pseudo-class</li>
          </ul>
        </div></div>
      </section>

    </section>

    <section property="bibo:hasPart" resource="#distributions" typeof="bibo:Chapter" id="distributions">
      <!--OddPage--><h2 resource="#h-distributions" id="h-distributions"><span property="xhv:role" resource="xhv:heading"><span class="secno">3. </span>Distributions</span></h2>

      <section property="bibo:hasPart" resource="#slots" typeof="bibo:Chapter" id="slots">
        <h3 resource="#h-slots" id="h-slots"><span property="xhv:role" resource="xhv:heading"><span class="secno">3.1 </span>Slots</span></h3>

        <p>
          A <dfn id="dfn-slot" data-dfn-type="dfn">slot</dfn> is a defined location in a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a> into which some of a shadow host's children are inserted in its <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a>.
          The exact algorithm of constructing a <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> is specified later.
        </p>

        <p>
          A node can be <dfn id="dfn-assigned" data-dfn-type="dfn">assigned</dfn> to a slot, called an <dfn id="dfn-assigned-slot" data-dfn-type="dfn">assigned slot</dfn>. The exact algorithm of determining the <a data-link-type="dfn" class="internalDFN" href="#dfn-assigned-slot">assigned slot</a> for a node is specified later.
        </p>

        <p>A <dfn id="dfn-distribution" data-dfn-type="dfn">distribution</dfn> is the mechanism that determines which <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node" data-lt="node">nodes</a> appear at each <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>. The exact algorithm of a <a data-link-type="dfn" class="internalDFN" href="#dfn-distribution">distribution</a> is specified later.</p>

        <figure id="fig-a-distribution">
          <object data="distributions.svg" height="598" width="663"></object>
          <figcaption>Fig. <span class="figno">3</span> <span class="fig-title">A distribution</span></figcaption>
        </figure>

        <p>
          The <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-element">slot element</a> that satisfies the following condition defines a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a> at the location of the element:
        </p>
        <ul>
          <li>The <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> of the <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-element">slot element</a> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a></li>
        </ul>

        <p>
          A <dfn id="dfn-slot-name" data-dfn-type="dfn">slot name</dfn> is the name of a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>.
        </p>

        <p>
          A <dfn id="dfn-default-slot" data-dfn-type="dfn">default slot</dfn> is a slot whose <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-name">slot name</a> is the empty string or missing.
          If there are more than one slots which don't have a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-name">slot name</a> in the same <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>, the most <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-preceding">preceding</a> one is the <a data-link-type="dfn" class="internalDFN" href="#dfn-default-slot">default slot</a>. The others are not.
        </p>
      </section>

      <section property="bibo:hasPart" resource="#slotting-algorithm" typeof="bibo:Chapter" id="slotting-algorithm">
        <h3 resource="#h-slotting-algorithm" id="h-slotting-algorithm"><span property="xhv:role" resource="xhv:heading"><span class="secno">3.2 </span>Slotting Algorithm</span></h3>

        <p>
          The <dfn id="dfn-slotting-algorithm" data-dfn-type="dfn">slotting algorithm</dfn> <strong>must</strong> be used to determine the <a data-link-type="dfn" class="internalDFN" href="#dfn-assigned-slot">assigned slot</a> for a node and <strong>must</strong> be <a data-link-type="dfn" class="internalDFN" href="#dfn-processing-equivalence" data-lt="processing equivalence">equivalent</a> to processing the following steps:
        </p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>NODE</var>, a node</dd>
            <dt>Output</dt>
            <dd>(nullable) <var>SLOT</var>, a <var>slot</var> to where <var>NODE</var> is assigned.</dd>
          </dl>

          <ol>
            <li>
              If the parent node of <var>NODE</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a>:
              <ol>
                <li>Let <var>TREE</var> be the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a> that the parent node of <var>NODE</var> <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a></li>
                <li>Let <var>NAME</var> be the value of the <a href="#widl-Element-slot">slot attribute</a> of <var>NODE</var></li>
                <li>
                  If <var>NAME</var> is the empty string or missing:
                  <ol>
                    <li>Let <var>SLOT</var> be a <a data-link-type="dfn" class="internalDFN" href="#dfn-default-slot">default slot</a> for <var>TREE</var> if it exits, Otherwise, null</li>
                  </ol>
                </li>
                <li>
                  Otherwise:
                  <ol>
                    <li>Let <var>SLOT</var> be the most <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-preceding">preceding</a> <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a> in <var>TREE</var> whose <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-name">slot name</a> is <var>NAME</var> if it exists. Otherwise null.</li>
                  </ol>
                </li>
              </ol>
            </li>
            <li>
              Otherwise:
              <ol>
                <li>Let <var>SLOT</var> be null</li>
              </ol>
            </li>
          </ol>
        </div>
      </section>

      <section property="bibo:hasPart" resource="#distributed-nodes-algorithm" typeof="bibo:Chapter" id="distributed-nodes-algorithm">
        <h3 resource="#h-distributed-nodes-algorithm" id="h-distributed-nodes-algorithm"><span property="xhv:role" resource="xhv:heading"><span class="secno">3.3 </span>Distributed Nodes Algorithm</span></h3>

        <p>
          The <dfn id="dfn-get-distributed-nodes-algorithm" data-dfn-type="dfn">get distributed nodes algorithm</dfn> <strong>must</strong> be used to determine the <dfn id="dfn-distributed-nodes" data-dfn-type="dfn">distributed nodes</dfn> for a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a> and <strong>must</strong> be <a data-link-type="dfn" class="internalDFN" href="#dfn-processing-equivalence" data-lt="processing equivalence">equivalent</a> to processing the following steps:
        </p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>SLOT</var>, a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a></dd>
            <dt>Output</dt>
            <dd><var>DISTRIBUTED-NODES</var>, an ordered list of nodes.</dd>
          </dl>

          <ol>
            <li>Let <var>HOST</var> be a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a> which <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a> that <var>SLOT</var> participates in</li>
            <li>
              For each child node <var>NODE</var> of <var>HOST</var>:
              <ol>
                <li>
                  If <var>NODE</var> is assinged to <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">SLOT</a>:
                  <ol>
                    <li>
                      If <var>NODE</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>:
                      <ol>
                        <li>Let <var>SUB-LIST</var> be the result of (recursively) running the <a data-link-type="dfn" class="internalDFN" href="#dfn-get-distributed-nodes-algorithm">get distributed nodes algorithm</a> with <var>NODE</var> as input</li>
                        <li>Append all nodes in <var>SUB-LIST</var> to <var>DISTRIBUTED-NODES</var></li>
                      </ol>
                    </li>
                    <li>
                      Otherwise:
                      <ol>
                        <li>Append <var>NODE</var> to <var>DISTRIBUTED-NODES</var></li>
                      </ol>
                    </li>
                  </ol>
                </li>
              </ol>
            </li>
          </ol>
        </div>
      </section>
    </section>

    <section property="bibo:hasPart" resource="#composition" typeof="bibo:Chapter" id="composition">
      <!--OddPage--><h2 resource="#h-composition" id="h-composition"><span property="xhv:role" resource="xhv:heading"><span class="secno">4. </span>Composition</span></h2>

      <section property="bibo:hasPart" resource="#composition-algorithm" typeof="bibo:Chapter" id="composition-algorithm">
        <h3 resource="#h-composition-algorithm" id="h-composition-algorithm"><span property="xhv:role" resource="xhv:heading"><span class="secno">4.1 </span>Composition Algorithm</span></h3>


        <p>The <dfn id="dfn-composed-tree-children-calculation-algorithm" data-dfn-type="dfn">composed tree children calculation algorithm</dfn> <strong>must</strong> be used to determine the child nodes of a node in the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> and <strong>must</strong> be <a data-link-type="dfn" class="internalDFN" href="#dfn-processing-equivalence" data-lt="processing equivalence">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>NODE</var>, a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> which participates in a composed tree</dd>
            <dt>Output</dt>
            <dd><var>CHILDREN</var>, the child nodes of <var>NODE</var> in the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a>.</dd>
          </dl>

          <ol>
            <li>Let <var>CHILDREN</var> be an empty ordered list of nodes</li>
            <li>
              If <var>NODE</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a>:
              <ol>
                <li>Let <var>CHILD-POOL</var> be the child nodes of the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a> which <var>NODE</var> <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a></li>
              </ol>
            </li>
            <li>
              Otherwise:
              <ol>
                <li>Let <var>CHILD-POOL</var> be the child nodes of <var>NODE</var></li>
              </ol>
            </li>
            <li>
              For each <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a>, <var>CHILD</var>, in <var>CHILD-POOL</var>:
              <ol>
                <li>
                  If <var>CHILD</var> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>:
                  <ol>
                    <li>If <var>CHILD</var> is not assigned to any <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>:
                      <ol>
                        <li>Append all nodes of the <a data-link-type="dfn" class="internalDFN" href="#dfn-distributed-nodes">distributed nodes</a> of <var>CHILD</var> to <var>CHILDREN</var></li>
                      </ol>
                    </li>
                  </ol>
                </li>
                <li>Otherwise:
                  <ol>
                    <li>Append <var>CHILD</var> to <var>CHILDREN</var></li>
                  </ol>
                </li>
              </ol>
            </li>
          </ol>
        </div>

        <p>For a given <a data-link-type="dfn" class="internalDFN" href="#dfn-tree-of-trees">tree of trees</a> <var>TREE-OF-TREES</var>, the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> constructed from <var>TREE-OF-TREES</var> <strong>must</strong> be <a data-link-type="dfn" class="internalDFN" href="#dfn-processing-equivalence" data-lt="processing equivalence">equivalent</a> to the following tree:</p>
        <ul>
          <li>The <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> of the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> is the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> of the <a data-link-type="dfn" class="internalDFN" href="#dfn-root-tree">root tree</a> of <var>TREE-OF-TREES</var>.</li>
          <li>For a given <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> which <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-participate">participates</a> in the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a>, the child <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node" data-lt="node">nodes</a> of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> is the result of the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree-children-calculation-algorithm">composed tree children calculation algorithm</a> with the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> as input.
          </li>
        </ul>
      </section>

      <section property="bibo:hasPart" resource="#composition-example" typeof="bibo:Chapter" id="composition-example" class="informative">
        <h3 resource="#h-composition-example" id="h-composition-example"><span property="xhv:role" resource="xhv:heading"><span class="secno">4.2 </span>Composition Example</span></h3><p><em>This section is non-normative.</em></p>

        <p>
          Suppose that we have the following tree of trees:
        </p>

        <figure id="fig-an-example-tree-of-trees.-a-node-whose-color-is-red-represents-a-slot.-unlike-the-previous-figures-a-box-surrounding-a-node-tree-is-omitted-here.x">
          <object data="composition-tree-of-trees.svg" height="616" width="581"></object>
          <figcaption>Fig. <span class="figno">4</span> <span class="fig-title">An example tree of trees. A node whose color is red represents a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>. Unlike the previous figures, a box surrounding a node tree is omitted here. </span></figcaption>
        </figure>

        <p>
          This <a data-link-type="dfn" class="internalDFN" href="#dfn-tree-of-trees">tree of trees</a> is composed of the following 3 <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree" data-lt="node tree">node trees</a>, one <a data-link-type="dfn" class="internalDFN" href="#dfn-document-tree">document tree</a> and two <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree" data-lt="shadow tree">shadow trees</a>:
        </p>

        <table>
          <thead>
            <tr>
              <th>Node tree</th>
              <th>Root node is: </th>
              <th>Hosted by:</th>
              <th>Composed of: (in tree order)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>document tree 1</td>
              <td>A</td>
              <td>-</td>
              <td>A, B, C, D, E, F, G, H, I</td>
            </tr>
            <tr>
              <td>shadow tree 1</td>
              <td>J</td>
              <td>C</td>
              <td>J, K, L, M, N, O, P, Q</td>
            </tr>
            <tr>
              <td>shadow tree 2</td>
              <td>R</td>
              <td>N</td>
              <td>R, S, T</td>
            </tr>
          </tbody>
        </table>

        <p>
          Suppose that an assigned slot for each node, if it exists, is:
        </p>

        <ul>
          <li>(D =&gt; L) (You can read this as <strong>"D is assigned to L</strong>")</li>
          <li>(F =&gt; L)</li>
          <li>(H =&gt; O)</li>
          <li>(O =&gt; T)</li>
          <li>(P =&gt; T)</li>
        </ul>

        <figure id="fig-a-result-of-slotting.x">
          <object data="composition-slotting.svg" height="616" width="581"></object>
          <figcaption>Fig. <span class="figno">5</span> <span class="fig-title">A result of slotting.</span></figcaption>
        </figure>

        <p>
          Then, the distributed nodes for each slot will be:
        </p>

        <table>
          <thead>
            <tr>
              <th>Node tree</th>
              <th>Root node is: </th>
              <th>Hosted by:</th>
              <th>Composed of: (in tree order)</th>
              <th>Assigned Slot for a node</th>
              <th>Distributed nodes for a slot</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>document tree 1</td>
              <td>A</td>
              <td>-</td>
              <td>A, B, C, D, E, F, G, H, I</td>
              <td>(D =&gt; L), (F =&gt; L), (H =&gt; O)</td>
              <td>-</td>
            </tr>
            <tr>
              <td>shadow tree 1</td>
              <td>J</td>
              <td>C</td>
              <td>J, K, L, M, N, O, P, Q</td>
              <td>(O =&gt; T), (P =&gt; T)</td>
              <td>L &lt;= [D, F], M &lt;= [], O &lt;= [H]</td>
            </tr>
            <tr>
              <td>shadow tree 2</td>
              <td>R</td>
              <td>N</td>
              <td>R, S, T</td>
              <td>-</td>
              <td>T &lt;= [H, P] </td>
            </tr>
          </tbody>
        </table>

        <div class="note"><div id="h-note5" role="heading" aria-level="4" class="note-title"><span>Note</span></div><ul class="">
          <li>More than one nodes can be assigned to the same slot. e.g. (D =&gt; L), (F =&gt; L)</li>
          <li>A slot can be assigned to an other slot, e.g. (O =&gt; T)</li>
          <li>
            The distributed nodes for T are [H, P]. That aren't [O, P].
            A slot is never a member of distributed nodes of an other slot.
            If a slot <var>A</var> is assigned to an other slot <var>B</var>, the distributed nodes for <var>A</var> are appended to the distributed nodes for <var>B</var>,
            instead of <var>A</var> itself, as per the <a data-link-type="dfn" class="internalDFN" href="#dfn-get-distributed-nodes-algorithm">get distributed nodes algorithm</a>.
          </li>
        </ul></div>

        <p>
          The document composed tree will be:
        </p>

        <figure id="fig-document-composed-tree.x">
          <object data="composition-composed-tree.svg" height="526" width="256"></object>
          <figcaption>Fig. <span class="figno">6</span> <span class="fig-title">Document composed tree.</span></figcaption>
        </figure>

        <div class="note"><div id="h-note6" role="heading" aria-level="4" class="note-title"><span>Note</span></div><ul class="">
          <li>A slot never participates in a <a data-link-type="dfn" class="internalDFN" href="#dfn-document-composed-tree">document composed tree</a>. Neither a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a> does.</li>
          <li>Node G doesn't participate in the document composed tree. G is a child of a shadow host, but it's not assigned to any slot.</li>
          <li>In an extreme case, even if a document tree has more than 1,000 nodes, you can make the page *blank* by attaching a shadow root to the document element because a document composed tree is used in rendering.</li>
        </ul></div>
    </section>

    </section>

    <section property="bibo:hasPart" resource="#events" typeof="bibo:Chapter" id="events">
      <!--OddPage--><h2 resource="#h-events" id="h-events"><span property="xhv:role" resource="xhv:heading"><span class="secno">5. </span>Events</span></h2>

      <p>In each algorithm in this section, the <a class="externalDFN" href="http://html.spec.whatwg.org/#window">Window</a> <strong>must</strong> be considered as if it were the parent node of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-document">Document</a> so that the <a class="externalDFN" href="http://html.spec.whatwg.org/#window">Window</a> also receives an <a class="externalDFN" href="http://dom.spec.whatwg.org/#events">event</a>.</p>

      <p>When an <a class="externalDFN" href="http://dom.spec.whatwg.org/#events">event</a> is <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-event-dispatch" data-lt="event dispatch">dispatched</a> in a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>, its path either crosses the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree" data-lt="shadow tree">shadow trees</a> or is terminated at the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a>. One exception are the <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#interface-MutationEvent" data-lt="mutation event">mutation events</a>. The <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#interface-MutationEvent" data-lt="mutation event">mutation event types</a> <strong>must</strong> never be dispatched in a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.</p>

      <section property="bibo:hasPart" resource="#events-that-are-not-leaked-into-ancestor-trees" typeof="bibo:Chapter" id="events-that-are-not-leaked-into-ancestor-trees">
        <h3 resource="#h-events-that-are-not-leaked-into-ancestor-trees" id="h-events-that-are-not-leaked-into-ancestor-trees"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.1 </span>Events that are not leaked into ancestor trees</span></h3>

        <p>For the following events, <a data-link-type="dfn" class="internalDFN" href="#dfn-scoped-flag">scoped flag</a> is initialized to true by default if the events are dispatched by the user agent:</p>
        <ul>
          <li><code>abort</code></li>
          <li><code>error</code></li>
          <li><code>select</code></li>
          <li><code>change</code></li>
          <li><code>load</code></li>
          <li><code>reset</code></li>
          <li><code>resize</code></li>
          <li><code>scroll</code></li>
          <li><code>selectstart</code></li>
        </ul>

        <div id="issue-1" class="issue"><div id="h-issue1" role="heading" aria-level="4" class="issue-title"><span>Issue 1</span></div><p class="">
          Upstream this section into relevant specs, instead of having a fixed list here.
        </p></div>

      </section>

      <section property="bibo:hasPart" resource="#event-paths" typeof="bibo:Chapter" id="event-paths">
        <h3 resource="#h-event-paths" id="h-event-paths"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.2 </span>Event Paths</span></h3>

        <p>The <dfn id="dfn-event-path-calculation-algorithm" data-dfn-type="dfn">event path calculation algorithm</dfn> must be used to determine event path and <strong>must</strong> be <a data-link-type="dfn" class="internalDFN" href="#dfn-processing-equivalence" data-lt="processing equivalence">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>NODE</var>, a node</dd>
            <dd><var>EVENT</var>, an event</dd>
            <dt>Output</dt>
            <dd><var>PATH</var>, an event path, a ordered list of an event target</dd>
          </dl>
          <ol>
            <li>Let <var>PATH</var> be the empty ordered list of nodes</li>
            <li>Let <var>CURRENT</var> be <var>NODE</var></li>
            <li>
              Repeat while <var>CURRENT</var> exists:
              <ol>
                <li>Append <var>CURRENT</var> to <var>PATH</var></li>
                <li>
                  If all of the following conditions are satisfied, stop this algorithm:
                  <ol>
                    <li><var>CURRENT</var> is a shadow root</li>
                    <li><var>CURRENT</var> is the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> node of <var>NODE</var></li>
                    <li><var>EVENT</var>'s <a data-link-type="dfn" class="internalDFN" href="#dfn-scoped-flag">scoped flag</a> is set</li>
                  </ol>
                </li>
                <li>
                  If <var>CURRENT</var> is assigned to a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a> <var>SLOT</var>:
                  <ol>
                    <li>Let <var>CURRENT</var> be <var>SLOT</var></li>
                  </ol>
                </li>
                <li>
                  Otherwise:
                  <ol>
                    <li>Let <var>CURRENT</var> be the <a data-link-type="dfn" class="internalDFN" href="#dfn-deep-parent">deep parent</a> of <var>CURRENT</var></li>
                  </ol>
                </li>
              </ol>
            </li>
          </ol>
        </div>

        <div class="note"><div id="h-note7" role="heading" aria-level="4" class="note-title"><span>Note</span></div><p class="">
          For a <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#trusted-events" data-lt="trusted events">trusted event</a> that has a <code>relatedTarget</code> attribute, the event path would be trimmed. See the <a data-link-type="dfn" class="internalDFN" href="#dfn-event-path-trimming-algorithm">event path trimming algorithm</a>, which is specified later.
        </p></div>

      </section>

      <section property="bibo:hasPart" resource="#event-paths-example" typeof="bibo:Chapter" id="event-paths-example" class="informative">
        <h3 resource="#h-event-paths-example" id="h-event-paths-example"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.3 </span>Event Paths Example</span></h3><p><em>This section is non-normative.</em></p>

        <p>
          Let's re-use the same tree of trees used in the composition example section. Suppose that an event is dispatched on node <code>I</code>. The event path will be:
        </p>
        <p>
          <code>[I, H, O, T, S, R, N, J, C, A]</code>  (<a class="externalDFN" href="http://html.spec.whatwg.org/#window">Window</a> is omitted)
        </p>

        <p>
          It's worth pointing out that if we exclude all nodes which don't participate in the composed tree from the event path,
          the result would be equivalent to the inclusive ancestors of the node <code>I</code> in the composed tree.
        </p>

        <figure id="fig-the-relationship-between-the-composed-tree-and-an-event-path.-if-we-exclude-o-t-r-and-j-that-don-t-participate-in-the-composed-tree-from-the-event-path-the-result-would-be-equivalent-to-the-inclusive-ancestors-of-the-node-i-in-the-composed-tree.x">
          <object data="event-path-composed-tree.svg" height="560" width="580"></object>
          <figcaption>Fig. <span class="figno">7</span> <span class="fig-title">
            The relationship between the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> and an event path.
            If we exclude O, T, R and J, that don't participate in the composed tree, from the event path,
            the result would be equivalent to the inclusive ancestors of the node, <code>I</code>, in the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a>.
          </span></figcaption>
        </figure>

        <p>
          Note that the <a data-link-type="dfn" class="internalDFN" href="#dfn-event-path-calculation-algorithm">event path calculation algorithm</a> is designed to achieve the following goals:
        </p>

        <ol>
          <li>
            If there is a node, <var>CHILD</var>, in the event path and <var>CHILD</var> has a parent node, <var>PARENT</var>, in the node tree, the event path always includes <var>PARENT</var>.
            <var>PARENT</var> always appears somewhere after <var>CHILD</var> in the event path.
          </li>
          <li>
            Nodes in the event path form a <em>linear ancestor chain</em> in each <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a>. There are no <em>branch points</em> in each <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a>.
          </li>
        </ol>

        <figure id="fig-the-relationship-between-an-event-path-and-node-trees.-in-the-figure-a-number-shown-in-a-right-side-of-each-node-represents-a-zero-based-position-of-each-node-in-the-event-path.-a-parent-node-always-has-a-larger-number-than-that-of-its-child-node-in-each-node-tree.x">
          <object data="event-path-trees.svg" height="386" width="766">&gt;</object>
          <figcaption>Fig. <span class="figno">8</span> <span class="fig-title">
            The relationship between an event path and node trees. In the figure, a number shown in a right-side of each node represents a zero-based position of each node in the event path.
            A parent node always has a larger number than that of its child node in each node tree.
          </span></figcaption>
        </figure>

        <p>A <em>local</em> event path for each node tree would be seen as:
        </p>

        <table>
          <thead>
            <tr>
              <th>Node tree</th>
              <th><em>Local</em> Event Path</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>document tree 1</td>
              <td>[I, H, C, A]</td>
            </tr>
            <tr>
              <td>shadow tree 1</td>
              <td>[O, N, J]</td>
            </tr>
            <tr>
              <td>shadow tree 2</td>
              <td>[T, S, R]</td>
            </tr>
          </tbody>
        </table>

        <p>
          That means, if your concern is only one <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a>, you can forget all other node trees.
          The event path would be seen as if the event happened only on the node tree you are focusing on.
          This is an important aspect in a sense that hosting a shadow tree doesn't have any effect to the <em>local</em> event path
          as long as the event is not stopped somewhere in the <a data-link-type="dfn" class="internalDFN" href="#dfn-descendant-tree" data-lt="descendant tree">descendant trees</a>.
        </p>
        <p>
          If you are a web author and your concern is only a document tree, this might be a good news because an event listener that is registered somewhere on the document tree
          would <em>continue to work</em> even when you attach a shadow root to an element in the document tree to <em>enhance</em> the element.
          At the same time, an author of a shadow tree also can receive an event which will happen on a node in the document tree, if the node, or its ancestor, is assigned to a slot in the shadow tree.
        </p>

      </section>

      <section property="bibo:hasPart" resource="#event-retargeting" typeof="bibo:Chapter" id="event-retargeting">
        <h3 resource="#h-event-retargeting" id="h-event-retargeting"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.4 </span>Event Retargeting</span></h3>

        <p>In the cases where event path is across multiple node trees, the event's information about the target of the event is adjusted in order to maintain encapsulation. Event <dfn id="dfn-retargeting" data-dfn-type="dfn">retargeting</dfn> is a process of computing relative targets for each ancestor of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> at which the event is dispatched. A <dfn id="dfn-relative-target" data-dfn-type="dfn">relative target</dfn> is a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> that most accurately represents the target of a dispatched event at a given ancestor while maintaining the encapsulation.</p>

        <p>The <dfn id="dfn-retargeting-algorithm" data-dfn-type="dfn">retargeting algorithm</dfn> is used to determine relative targets and <strong>must</strong> be <a data-link-type="dfn" class="internalDFN" href="#dfn-processing-equivalence" data-lt="processing equivalence">equivalent</a> to processing the following steps:</p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>BASE</var>, a base node for which a target node should be adjusted</dd>
            <dd><var>TARGET</var>, a target node which should be adjusted</dd>
            <dt>Output</dt>
            <dd><var>RELATIVE-TARGET</var>, a <a data-link-type="dfn" class="internalDFN" href="#dfn-relative-target">relative target</a>, the result of adjusting <var>TARGET</var> for <var>BASE</var></dd>
          </dl>
          <ol>
            <li>Let <var>BASE-TREE</var> be the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> which <var>BASE</var> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-participate">participates</a> in</li>
            <li>Let <var>TARGET-TREE</var> be the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> which <var>TARGET</var> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-participate">participates</a> in</li>
            <li>If <var>BASE-TREE</var> and <var>TARGET-TREE</var> participate in the same <a data-link-type="dfn" class="internalDFN" href="#dfn-tree-of-trees">tree of trees</a>:
              <ol>
                <li>Let <var>COMMON-ANCESTOR-TREE</var> be the lowest common <a data-link-type="dfn" class="internalDFN" href="#dfn-inclusive-ancestor-tree">inclusive ancestor tree</a> of <var>BASE-TREE</var> and <var>TARGET-TREE</var></li>
              </ol>
            </li>
            <li>Otherwise:
              <ol>
                <li>Let <var>COMMON-ANCESTOR-TREE</var> be the <a data-link-type="dfn" class="internalDFN" href="#dfn-root-tree">root tree</a> of <var>TARGET-TREE</var></li>
              </ol>
            </li>
            <li>
              For each <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a>, <var>ANCETOR</var>, in an <a data-link-type="dfn" class="internalDFN" href="#dfn-inclusive-deep-ancestor">inclusive deep ancestor</a> nodes of <var>TARGET</var>, from descendants to ancestors:
              <ol>
                <li>
                  If <var>ANCESTOR</var> participates in <var>COMMON-ANCESTOR-TREE</var>:
                  <ol>
                    <li>Let <var>RELATIVE-TARGET</var> be <var>ANCESTOR</var></li>
                    <li>Stop this algorithm</li>
                  </ol>
                </li>
              </ol>
            </li>
          </ol>
        </div>

        <p>The value of the <code>Event</code> object's <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-event-target"><code>target</code></a> attribute <strong>must</strong> be the result of the <a data-link-type="dfn" class="internalDFN" href="#dfn-retargeting-algorithm">retargeting algorithm</a> with the event's <code>currentTarget</code> and <code>target</code> as input.</p>
        <p>The event target retargeting process <strong>must</strong> occur prior to dispatch of an event.</p>
      </section>

      <section property="bibo:hasPart" resource="#retargeting-relatedtarget" typeof="bibo:Chapter" id="retargeting-relatedtarget">
        <h3 resource="#h-retargeting-relatedtarget" id="h-retargeting-relatedtarget"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.5 </span>Retargeting <code>relatedTarget</code></span></h3>

        <p>Some events have a <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget"><code>relatedTarget</code></a> [<cite><a href="#bib-DOM-Level-3-Events" class="bibref">DOM-Level-3-Events</a></cite>] property, which holds a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> that's not the event's target, but is related to the event.</p>

        <p>
          For instance, a <code>mouseover</code> event's <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget"><code>relatedTarget</code></a> may hold the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> from which the mouse has moved to event's <code>target</code>. In the case where <code>relatedTarget</code> is in a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>, the conforming UAs <strong>must</strong> not leak its actual value outside of this tree.
        </p>
        <p>
          The value of the <code>Event</code> object's <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget"><code>relatedTarget</code></a> attribute <strong>must</strong> be the result of the <a data-link-type="dfn" class="internalDFN" href="#dfn-retargeting-algorithm">retargeting algorithm</a> with the event's <code>currentTarget</code> and <code>relatedTarget</code> as input. The result is called a <dfn id="dfn-relative-related-target" data-dfn-type="dfn">relative related target</dfn>.
        </p>
        <p>
          The event relatedTarget retargeting process <strong>must</strong> occur prior to dispatch of an event.
        </p>
      </section>

      <section property="bibo:hasPart" resource="#retargeting-touch-events" typeof="bibo:Chapter" id="retargeting-touch-events">
        <h3 resource="#h-retargeting-touch-events" id="h-retargeting-touch-events"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.6 </span>Retargeting Touch Events</span></h3>

        <p>The <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#touch-interface"><code>Touch</code></a> <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#widl-Touch-target" data-lt="Touch target"><code>target</code></a> [<cite><a href="#bib-TOUCH-EVENTS" class="bibref">TOUCH-EVENTS</a></cite>] attribute <strong>must</strong> be adjusted in the same way as an event with a <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget"><code>relatedTarget</code></a>. Each <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#touch-interface"><code>Touch</code></a> <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#widl-Touch-target" data-lt="Touch target"><code>target</code></a> in the <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#touchlist-interface"><code>TouchList</code></a> returned from <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#touchevent-interface"><code>TouchEvent</code></a> <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#widl-TouchEvent-touches" data-lt="touches"><code>touches()</code></a>, <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#widl-TouchEvent-changedTouches" data-lt="changedTouches"><code>changedTouches()</code></a> and <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#widl-TouchEvent-targetTouches" data-lt="targetTouches"><code>targetTouches()</code></a> must be the result of the <a data-link-type="dfn" class="internalDFN" href="#dfn-retargeting-algorithm">retargeting algorithm</a> with a current target and <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#touch-interface"><code>Touch</code></a> <a class="externalDFN" href="http://www.w3.org/TR/touch-events/#widl-Touch-target" data-lt="Touch target"><code>target</code></a> as input.</p>
      </section>

      <section property="bibo:hasPart" resource="#retargeting-focus-events" typeof="bibo:Chapter" id="retargeting-focus-events">
        <h3 resource="#h-retargeting-focus-events" id="h-retargeting-focus-events"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.7 </span>Retargeting Focus Events</span></h3>

        <p>The <code>focus</code>, <code>focusin</code>, <code>blur</code>, and <code>focusout</code> events <strong>must</strong> be treated in the same way as events with a <code>relatedTarget</code>, where the corresponding <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> that is losing focus as a result of <code>target</code> gaining focus or the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> that is gaining focus, and thus causing the blurring of <code>target</code> acts as the related target.</p>
      </section>

      <section property="bibo:hasPart" resource="#event-path-trimming" typeof="bibo:Chapter" id="event-path-trimming">
        <h3 resource="#h-event-path-trimming" id="h-event-path-trimming"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.8 </span>Event Path Trimming</span></h3>

        <p>
          In cases where both <code>relatedTarget</code> and <code>target</code> of a <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#trusted-events" data-lt="trusted events">trusted event</a> are part of the same <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>, the conforming UAs <strong>must</strong> <em>stop</em> events at the shadow root to avoid the appearance of spurious <code>mouseover</code> and <code>mouseout</code> events firing from the same node.
        </p>
        <p>
           Thus, event listeners for <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#trusted-events">trusted events</a> <strong>must not</strong> be invoked on a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> for which the <code>target</code> and <code>relatedTarget</code> are the same.
        </p>

        <p>
          The <dfn id="dfn-event-path-trimming-algorithm" data-dfn-type="dfn">event path trimming algorithm</dfn> <strong>must</strong> be used to trim the event path for a <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#trusted-events" data-lt="trusted events">trusted event</a> that has a <code>relatedTarget</code> attribute and
          <strong>must</strong> be <a data-link-type="dfn" class="internalDFN" href="#dfn-processing-equivalence" data-lt="processing equivalence">equivalent</a> to processing the following steps:
        </p>
        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>EVENT-PATH</var>, the event path, which is the result of the <a data-link-type="dfn" class="internalDFN" href="#dfn-event-path-calculation-algorithm">event path calculation algorithm</a></dd>
            <dt>Output</dt>
            <dd><var>EVENT-PATH</var> is trimmed so that event listeners aren't invoked on a node for which the <code>target</code> and <code>relatedTarget</code> are the same.</dd>
          </dl>
          <ol>
            <li>
              For each object, <var>A</var>, in <var>EVENT-PATH</var>:
              <ol>
                <li>Let <var>RELATIVE-TARGET</var> be the <a data-link-type="dfn" class="internalDFN" href="#dfn-relative-target">relative target</a> for <var>A</var></li>
                <li>Let <var>RELATIVE-RELATED-TARGET</var> be the <a data-link-type="dfn" class="internalDFN" href="#dfn-relative-related-target">relative related target</a> for <var>A</var></li>
                <li>If <var>RELATIVE-TARGET</var> and <var>RELATIVE-RELATED-TARGET</var> are the same, remove <var>A</var> from <var>EVENT-PATH</var>.</li>
              </ol>
            </li>
          </ol>
        </div>
        <div class="note"><div id="h-note8" role="heading" aria-level="4" class="note-title"><span>Note</span></div><p class="">
          For an <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#trusted-events" data-lt="trusted events">untrusted event</a>, the <a data-link-type="dfn" class="internalDFN" href="#dfn-event-path-trimming-algorithm">event path trimming algorithm</a> is not used.
        </p></div>
      </section>

      <section property="bibo:hasPart" resource="#event-dispatch" typeof="bibo:Chapter" id="event-dispatch">
        <h3 resource="#h-event-dispatch" id="h-event-dispatch"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.9 </span>Event Dispatch</span></h3>

        <p>At the time of event dispatch:</p>
        <ul>
          <li>The <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#interface-MouseEvent"><code>MouseEvent</code></a> <a class="externalDFN" href="http://www.w3.org/TR/cssom-view/#dom-mouseevent-offsetx"><code>offsetX</code></a> and <a class="externalDFN" href="http://www.w3.org/TR/cssom-view/#dom-mouseevent-offsety"><code>offsetY</code></a> attributes <strong>must</strong> return the coordinates relative to the origin of the <a class="externalDFN" href="http://www.w3.org/TR/cssom-view/#padding-edge">padding edge</a> of the <a data-link-type="dfn" class="internalDFN" href="#dfn-relative-target">relative target</a></li>
          <li>When <em>capturing</em>, which entails processing step 6 of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-event-dispatch" data-lt="event dispatch">event dispatch algorithm</a>, the event listeners <strong>must not</strong> be <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-event-listener-invoke" data-lt="event listener invoke">invoked</a> on a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> <strong>if</strong> it is the same as its <a data-link-type="dfn" class="internalDFN" href="#dfn-relative-target">relative target</a></li>
          <li>When <em>bubbling</em>, which entails processing step 9 of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-event-dispatch" data-lt="event dispatch">event dispatch algorithm</a>, the <a class="externalDFN" href="http://dom.spec.whatwg.org/#events"><code>Event</code></a> <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-event-eventphase">eventPhase</a> attribute <strong>must</strong> return <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-event-at_target">AT_TARGET</a> <strong>if</strong> the <a data-link-type="dfn" class="internalDFN" href="#dfn-relative-target">relative target</a> is same as the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> on which event listeners are <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-event-listener-invoke" data-lt="event listener invoke">invoked</a></li>
          <li>If the event's <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-event-bubbles"><code>bubbles</code></a> attribute value is <strong>false</strong>, run these substeps:
            <ol>
              <li>Reverse the order of <em>event path</em></li>
              <li>Initialize event's <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-event-eventphase"><code>eventPhase</code></a> attribute to <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-event-at_target"><code>AT_TARGET</code></a></li>
              <li>For each object in <em>event path</em> where the <a data-link-type="dfn" class="internalDFN" href="#dfn-relative-target">relative target</a> is same as the object, <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-event-listener-invoke" data-lt="event listener invoke">invoke</a> its <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-event-listener" data-lt="event listener">event listeners</a>, with event <em>event</em>, as long as <em>event</em>'s <a class="externalDFN" href="http://dom.spec.whatwg.org/#stop-propagation-flag">stop propagation flag</a> is unset</li>
            </ol></li>
        </ul>

        <p>Upon completion of the event dispatch, the <a class="externalDFN" href="http://dom.spec.whatwg.org/#events"><code>Event</code></a> object's <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-event-target"><code>target</code></a> and <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#widl-MouseEvent-relatedTarget"><code>relatedTarget</code></a> <strong>must</strong> be to the highest ancestor's <a data-link-type="dfn" class="internalDFN" href="#dfn-relative-target">relative target</a>. Since it is possible for a script to hold on to the <code>Event</code> object past the scope of event dispatch, this step is necessary to avoid revealing the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node" data-lt="node">nodes</a> in <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree" data-lt="shadow tree">shadow trees</a>.</p>
      </section>

      <section property="bibo:hasPart" resource="#event-retargeting-example" typeof="bibo:Chapter" id="event-retargeting-example" class="informative">
        <h3 resource="#h-event-retargeting-example" id="h-event-retargeting-example"><span property="xhv:role" resource="xhv:heading"><span class="secno">5.10 </span>Event Retargeting Example</span></h3><p><em>This section is non-normative.</em></p>

        <p>Suppose we have a user interface for a media controller, represented by this tree, composed of both <a data-link-type="dfn" class="internalDFN" href="#dfn-document-tree">document tree</a> and the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree" data-lt="shadow tree">shadow trees</a>. In this example, we will assume that selectors are allowed to cross the shadow boundaries and we will use these selectors to identify the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-element" data-lt="element">elements</a>. Also, we will invent a fictional <code>shadow-root</code> <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-element">element</a> to demarcate the shadow boundaries and represent <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root" data-lt="shadow root">shadow roots</a>:</p>
        <div class="example"><div class="example-title"><span>Example 1</span></div><pre class="example">&lt;div id="player"&gt;
    <span class="shadow-boundary">&lt;shadow-root id="player-shadow-root"&gt;</span>
        &lt;div id="controls"&gt;
            &lt;button id="play-button"&gt;PLAY&lt;/button&gt;
            &lt;input type="range" id="timeline"&gt;
                <span class="shadow-boundary">&lt;shadow-root id="timeline-shadow-root"&gt;</span>
                    &lt;div id="slider-thumb" id="timeline-slider-thumb"&gt;&lt;/div&gt;
                <span class="shadow-boundary">&lt;/shadow-root&gt;</span>
            &lt;/input&gt;
            &lt;div id="volume-slider-container"&gt;
                &lt;input type="range" id="volume-slider"&gt;
                    <span class="shadow-boundary">&lt;shadow-root id="volume-shadow-root"&gt;</span>
                        &lt;div id="slider-thumb" id="volume-slider-thumb"&gt;&lt;/div&gt;
                    <span class="shadow-boundary">&lt;/shadow-root&gt;</span>
                &lt;/input&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    <span class="shadow-boundary">&lt;/shadow-root&gt;</span>
&lt;/div&gt;</pre></div>

        <p>Let's have a user position their pointing device over the volume slider's thumb (<code>#volume-slider-thumb</code>), thus triggering a <code>mouseover</code> event on that node. For this event, let's pretend it has no associated <code>relatedTarget</code>.</p>

        <p>Per the <a data-link-type="dfn" class="internalDFN" href="#dfn-retargeting-algorithm">retargeting algorithm</a>, we should have the following set of ancestors and relative targets:</p>
        <table>
          <thead>
            <tr>
              <th>Ancestor</th>
              <th>Relative Target</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>#player</code></td>
              <td><code><strong>#player</strong></code></td>
            </tr>
            <tr>
              <td><code>#player-shadow-root</code></td>
              <td><code>#volume-slider</code></td>
            </tr>
            <tr>
              <td><code>#controls</code></td>
              <td><code>#volume-slider</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider-container</code></td>
              <td><code>#volume-slider</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider</code></td>
              <td><code><strong>#volume-slider</strong></code></td>
            </tr>
            <tr>
              <td><code>#volume-shadow-root</code></td>
              <td><code>#volume-slider-thumb</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider-thumb</code></td>
              <td><code><strong>#volume-slider-thumb</strong></code></td>
            </tr>
          </tbody>
        </table>

        <p>After we dispatch the <code>mouseover</code> event using these newly computed relative targets, the user decides to move their pointing device over the thumb of the timeline
          (<code>#timeline-slider-thumb</code>). This triggers both a <code>mouseout</code> event for the volume slider thumb and the <code>mouseover</code> event for the timeline thumb.</p>

        <p>Let's see how the <code>relatedTarget</code> value of the volume thumb's <code>mouseout</code> event is affected. For this event, the <code>relatedTarget</code> is the timeline thumb (<code>#timeline-slider-thumb</code>). Per the <a href="#retargeting-relatedtarget">relatedTarget retargeting</a>, we should have the following set of ancestors and adjusted related targets:</p>

        <table>
          <thead>
            <tr>
              <th>Ancestor</th>
              <th>Relative Target</th>
              <th>Adjusted related Target</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>#player</code></td>
              <td><code><strong>#player</strong></code></td>
              <td><code><strong>#player</strong></code></td>
            </tr>
            <tr>
              <td><code>#player-shadow-root</code></td>
              <td><code>#volume-slider</code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#controls</code></td>
              <td><code>#volume-slider</code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider-container</code></td>
              <td><code>#volume-slider</code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider</code></td>
              <td><code><strong>#volume-slider</strong></code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#volume-shadow-root</code></td>
              <td><code>#volume-slider-thumb</code></td>
              <td><code>#timeline</code></td>
            </tr>
            <tr>
              <td><code>#volume-slider-thumb</code></td>
              <td><code><strong>#volume-slider-thumb</strong></code></td>
              <td><code><strong>#timeline</strong></code></td>
            </tr>
          </tbody>
        </table>

        <p>The node, <code>#player</code>, has both <code>target</code> and <code>relatedTarget</code> being the same value (<code>#player</code>), which means that we do not dispatch the event on this <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> and its ancestors.</p>
      </section>

    </section>

    <section property="bibo:hasPart" resource="#user-interaction" typeof="bibo:Chapter" id="user-interaction">
      <!--OddPage--><h2 resource="#h-user-interaction" id="h-user-interaction"><span property="xhv:role" resource="xhv:heading"><span class="secno">6. </span>User Interaction</span></h2>

      <section property="bibo:hasPart" resource="#ranges-and-selections" typeof="bibo:Chapter" id="ranges-and-selections" class="informative">
        <h3 resource="#h-ranges-and-selections" id="h-ranges-and-selections"><span property="xhv:role" resource="xhv:heading"><span class="secno">6.1 </span>Ranges and Selections</span></h3><p><em>This section is non-normative.</em></p>

        <p>
          <a class="externalDFN" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">Selection</a> [<cite><a href="#bib-EDITING" class="bibref">EDITING</a></cite>] is not defined. Implementation should do their best to do what's best for them. Here's one possible, admittedly naive way:
        </p>

        <p>Since <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node" data-lt="node">nodes</a> which are in the different <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree" data-lt="node tree">node trees</a> never have the same <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-root">root</a>, there may never exist a valid <a class="externalDFN" href="http://dom.spec.whatwg.org/#range" data-lt="range">DOM range</a> that spans multiple <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree" data-lt="node tree">node trees</a>.</p>

        <p>Accordingly, <a class="externalDFN" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection" data-lt="selection">selections</a> may only exist within one <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a>, because they are defined by a single <a class="externalDFN" href="http://dom.spec.whatwg.org/#range">range</a>. The <a class="externalDFN" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selection</a>, returned by the <a class="externalDFN" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#dom-window-getselection"><code>window.getSelection()</code></a> method never returns a <a class="externalDFN" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selection</a> within a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.</p>

        <p>The <code>getSelection()</code> method of the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a> object returns the current <a class="externalDFN" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selection</a> in this <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.</p>
      </section>

      <section property="bibo:hasPart" resource="#focus-navigation" typeof="bibo:Chapter" id="focus-navigation">
        <h3 resource="#h-focus-navigation" id="h-focus-navigation"><span property="xhv:role" resource="xhv:heading"><span class="secno">6.2 </span>Focus Navigation</span></h3>

        <p>If a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> doesn’t <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-tree-participate" data-lt="participates">participate</a> in the <a data-link-type="dfn" class="internalDFN" href="#dfn-document-composed-tree">document composed tree</a>, the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node">node</a> <strong>must</strong> be skipped from the <a class="externalDFN" href="http://html.spec.whatwg.org/#sequential-focus-navigation">sequential focus navigation</a>.</p>

        <p>The <a class="externalDFN" href="http://html.spec.whatwg.org/#sequential-focus-navigation-order">sequential focus navigation order</a> for a given <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a> <var>A</var> <strong>must</strong> be inserted into the <a class="externalDFN" href="http://html.spec.whatwg.org/#sequential-focus-navigation-order">sequential focus navigation order</a> for the <a data-link-type="dfn" class="internalDFN" href="#dfn-parent-tree">parent tree</a> <var>B</var> as follows:</p>
        <ol>
          <li>Let <var>HOST</var> be the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a> which <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> A</li>
          <li>
            The <a class="externalDFN" href="http://html.spec.whatwg.org/#sequential-focus-navigation-order">sequential focus navigation order</a> for A <strong>must</strong> be inserted into the <a class="externalDFN" href="http://html.spec.whatwg.org/#sequential-focus-navigation-order">sequential focus navigation order</a> for <var>B</var>:
            <ol>
              <li>immediately after <var>HOST</var>, if <var>HOST</var> is <a class="externalDFN" href="http://html.spec.whatwg.org/#focusable-area">focusable</a>; or</li>
              <li>in place of the <var>HOST</var> as if <var>HOST</var> were assigned the <a class="externalDFN" href="http://html.spec.whatwg.org/#attr-tabindex">tabindex</a> value 0 for determining its position.</li>
            </ol>
          </li>
        </ol>

        <p>For <a class="externalDFN" href="http://www.w3.org/TR/css3-ui/#nav-dir">directional focus navigation</a> [<cite><a href="#bib-CSS3-UI" class="bibref">CSS3-UI</a></cite>], it is up to the user agent to integrate the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree" data-lt="shadow tree">shadow trees</a> into the document's <a class="externalDFN" href="http://www.w3.org/TR/css3-ui/#nav-dir">directional focus navigation</a>.
      </p>
    </section>

      <section property="bibo:hasPart" resource="#active-element" typeof="bibo:Chapter" id="active-element">
        <h3 resource="#h-active-element" id="h-active-element"><span property="xhv:role" resource="xhv:heading"><span class="secno">6.3 </span>Active Element</span></h3>

        <p>To maintain encapsulation, the value of the <a class="externalDFN" href="http://html.spec.whatwg.org/#document" data-lt="Document object">Document</a> object's focus API property <a class="externalDFN" href="http://html.spec.whatwg.org/#dom-document-activeelement">activeElement</a> <strong>must</strong> be adjusted. To prevent loss of information when adjusting this value, each <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a> <strong>must</strong> also have an <code>activeElement</code> property to store the value of the focused <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-element">element</a> in the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.</p>

        <p>
          The <dfn id="dfn-active-element-adjustment-algorithm" data-dfn-type="dfn">active element adjustment algorithm</dfn> <strong>must</strong> be used to determine the value of <a class="externalDFN" href="http://html.spec.whatwg.org/#dom-document-activeelement">activeElement</a> property, and it <strong>must</strong> be <a data-link-type="dfn" class="internalDFN" href="#dfn-processing-equivalence" data-lt="processing equivalence">equivalent</a> to processing the following steps:
        </p>

        <div class="algorithm">
          <dl>
            <dt>Input</dt>
            <dd><var>ROOT</var>, either a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-document">document</a> or a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a></dd>
            <dd><var>ELEMENT</var>, the focused <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-element">element</a></dd>
            <dt>Output</dt>
            <dd><var>ADJUSTED</var>, an adjusted <a class="externalDFN" href="http://html.spec.whatwg.org/#dom-document-activeelement">activeElement</a> property of <var>ROOT</var>.</dd>
          </dl>
          <ol>
            <li>Let <var>ADJUSTED</var> be the result of the <a data-link-type="dfn" class="internalDFN" href="#dfn-retargeting-algorithm">retargeting algorithm</a> with <var>ROOT</var> and <var>ELEMENT</var> as input</li>
          </ol>
        </div>
      </section>

      <section property="bibo:hasPart" resource="#editing" typeof="bibo:Chapter" id="editing">
        <h3 resource="#h-editing" id="h-editing"><span property="xhv:role" resource="xhv:heading"><span class="secno">6.4 </span>Editing</span></h3>

        <p>The value of the <a class="externalDFN" href="http://html.spec.whatwg.org/#attr-contenteditable"><code>contenteditable</code></a> attribute <strong>must not</strong> propagate from <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a> to its <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree" data-lt="shadow tree">shadow trees</a>.</p>
      </section>

      <section property="bibo:hasPart" resource="#assistive-technology" typeof="bibo:Chapter" id="assistive-technology">
        <h3 resource="#h-assistive-technology" id="h-assistive-technology"><span property="xhv:role" resource="xhv:heading"><span class="secno">6.5 </span>Assistive Technology</span></h3>

        <p>User agents with assistive technology traverse the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a>, and thus enable full use of WAI-ARIA [<cite><a href="#bib-WAI-ARIA" class="bibref">WAI-ARIA</a></cite>] semantics in the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree" data-lt="shadow tree">shadow trees</a>.</p>

      </section>

      <section property="bibo:hasPart" resource="#hit-testing" typeof="bibo:Chapter" id="hit-testing">
        <h3 resource="#h-hit-testing" id="h-hit-testing"><span property="xhv:role" resource="xhv:heading"><span class="secno">6.6 </span>Hit Testing</span></h3>

        <p>
          When a text node is a child node of a shadow root, a hit testing <strong>must</strong> target the shadow host if the text node is the result of the hit testing.
        </p>
        <p>
          User-agent mouse events <strong>must</strong> be targeted to the parent node in the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> of a text node if the <a class="externalDFN" href="http://www.w3.org/TR/DOM-Level-3-Events/#glossary-topmost-event-target">topmost event target</a> is the text node.
        </p>
        <div class="note"><div id="h-note9" role="heading" aria-level="4" class="note-title"><span>Note</span></div><p class="">
          This section eventually needs to be part of some general hit testing specification.
        </p></div>
      </section>

    </section>

    <section property="bibo:hasPart" resource="#html-elements-in-shadow-trees" typeof="bibo:Chapter" id="html-elements-in-shadow-trees">
      <!--OddPage--><h2 resource="#h-html-elements-in-shadow-trees" id="h-html-elements-in-shadow-trees"><span property="xhv:role" resource="xhv:heading"><span class="secno">7. </span>HTML Elements in Shadow Trees</span></h2>

      <section property="bibo:hasPart" resource="#inertness-of-html-elements-in-a-shadow-tree" typeof="bibo:Chapter" id="inertness-of-html-elements-in-a-shadow-tree">
        <h3 resource="#h-inertness-of-html-elements-in-a-shadow-tree" id="h-inertness-of-html-elements-in-a-shadow-tree"><span property="xhv:role" resource="xhv:heading"><span class="secno">7.1 </span>Inertness of HTML Elements in a shadow tree</span></h3>

        <p>Comparatively, a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a> can be seen as somewhere between <em>just part of a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-document">document</a></em> and itself being a <a class="externalDFN" href="http://dom.spec.whatwg.org/#interface-documentfragment" data-lt="interface DocumentFragment">document fragment</a>. Since it is rendered, a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a> aims to retain the traits of a typical <a class="externalDFN" href="http://dom.spec.whatwg.org/#trees">tree</a> in a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-document">document</a>. At the same time, it is an encapsulation abstraction, so it has to avoid affecting the <a data-link-type="dfn" class="internalDFN" href="#dfn-document-tree">document tree</a>. Thus, the <a class="externalDFN" href="http://html.spec.whatwg.org/#semantics">HTML elements</a> <strong>must</strong> behave as specified [<cite><a href="#bib-HTML" class="bibref">HTML</a></cite>] in the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree" data-lt="shadow tree">shadow trees</a>, with a few exceptions.</p>

        <div class="note"><div id="h-note10" role="heading" aria-level="4" class="note-title"><span>Note</span></div><p class="">
          According to the [<cite><a href="#bib-HTML" class="bibref">HTML</a></cite>], some HTML Elements would have different behavior if they participate in a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>, instead of a document tree,
          because their definitions require the elements to be <a class="externalDFN" href="http://html.spec.whatwg.org/#in-a-document">in a document</a> as a necessary condition for them to work.
          In other words, they shouldn't work if they participate in a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>, even when they are <a data-link-type="dfn" class="internalDFN" href="#dfn-in-a-document-deeply">in a document deeply</a>.
          We must fill this gap because we expect that most of HTML Elements behave in the same way as <a class="externalDFN" href="http://html.spec.whatwg.org/#in-a-document">in a document</a>, as long as they are <a data-link-type="dfn" class="internalDFN" href="#dfn-in-a-document-deeply">in a document deeply</a>.
          See <abbr title="World Wide Web Consortium">W3C</abbr> <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=26365">Bug 26365</a> and <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=27406">Bug 27406</a> for the details.
          The following is the tentative summary of the discussions in the <abbr title="World Wide Web Consortium">W3C</abbr> bugs. We, however, haven't covered all HTML Elements and their behaviors here yet.
          For HTML Elements which are not explicitly stated here, they should be considered as <a data-link-type="dfn" class="internalDFN" href="#dfn-active-in-a-shadow-tree">active in a shadow tree</a>.
          We are trying to update [<cite><a href="#bib-HTML" class="bibref">HTML</a></cite>] itself, instead of having monkey patches here.
        </p></div>
        <p>
          HTML Elements are classified into the following categories:
        </p>
        <ul>
          <li>
            <p>
              <dfn id="dfn-active-in-a-shadow-tree" data-dfn-type="dfn">Active in a shadow tree</dfn>
            </p>
            <p>
              A subset of <a class="externalDFN" href="http://html.spec.whatwg.org/#semantics">HTML elements</a> which <strong>must</strong> behave as if they were in the <a data-link-type="dfn" class="internalDFN" href="#dfn-document-tree">document tree</a>, even when they participate in a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>,
              as long as they are <a data-link-type="dfn" class="internalDFN" href="#dfn-in-a-document-deeply">in a document deeply</a>.
            </p>
            <p>
              The following HTML elements <strong>must</strong> be classified to this category:
            </p>
            <ul>
              <li><code>dialog</code></li>
              <li><code>iframe</code></li>
              <li><code>style</code></li>
            </ul>
          </li>
          <li>
            <p>
              <dfn id="dfn-inert-in-a-shadow-tree" data-dfn-type="dfn">Inert in a shadow tree</dfn>:
            </p>
            <p>
              A subset of <a class="externalDFN" href="http://html.spec.whatwg.org/#semantics">HTML elements</a> which <strong>must</strong> behave as <a class="externalDFN" href="http://html.spec.whatwg.org/#inert">inert</a>, or not part of the <a data-link-type="dfn" class="internalDFN" href="#dfn-document-tree">document tree</a>, if they participate in a <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.
              This is consistent how the <a class="externalDFN" href="http://html.spec.whatwg.org/#semantics">HTML elements</a> would behave in a <a class="externalDFN" href="http://dom.spec.whatwg.org/#interface-documentfragment" data-lt="interface DocumentFragment">document fragment</a>.
            </p>
            <p>
              The following HTML elements <strong>must</strong> be classified to this category:
            </p>
            <ul>
              <li><a class="externalDFN" href="http://html.spec.whatwg.org/#the-base-element" data-lt="base element"><code>base</code></a></li>
              <li><a class="externalDFN" href="http://html.spec.whatwg.org/#the-link-element" data-lt="link element"><code>link</code></a></li>
            </ul>
          </li>
          <li>
            <p>
              <dfn id="dfn-inert-unless-being-rendered" data-dfn-type="dfn">Inert unless being rendered</dfn>:
            </p>
            <p>
              A subset of <a class="externalDFN" href="http://html.spec.whatwg.org/#semantics">HTML elements</a> which <strong>must</strong> behave as <a class="externalDFN" href="http://html.spec.whatwg.org/#inert">inert</a>, or not part of the <a data-link-type="dfn" class="internalDFN" href="#dfn-document-tree">document tree</a>,
              unless they are <a class="externalDFN" href="http://html.spec.whatwg.org/#being-rendered">being rendered</a>.
              In other words, if they don't particitpate in a <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> whose root node is a document, they <strong>must</strong> behave as <a class="externalDFN" href="http://html.spec.whatwg.org/#inert">inert</a>.
            </p>
            <p>
              The following HTML elements <strong>must</strong> be classified to this category:
            </p>
            <ul>
              <li><code>applet</code></li>
              <li><code>embed</code></li>
              <li><code>object</code></li>
            </ul>
            <div class="note"><div id="h-note11" role="heading" aria-level="4" class="note-title"><span>Note</span></div><p class="">
              For example, suppose that an <code>object</code> element is a child node of a shadow host, but the <code>object</code> element is not assigned to a slot.
              In this case, according to the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree-children-calculation-algorithm">composed tree children calculation algorithm</a>,
              this element never participate in a <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a> whose root node is a <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-document">document</a>.
              Therefore, this element is <a class="externalDFN" href="http://html.spec.whatwg.org/#inert">inert</a> because this element is not <a class="externalDFN" href="http://html.spec.whatwg.org/#being-rendered">being rendered</a>. .
            </p></div>
          </li>
        </ul>
      </section>

      <section property="bibo:hasPart" resource="#attributes" typeof="bibo:Chapter" id="attributes">
        <h3 resource="#h-attributes" id="h-attributes"><span property="xhv:role" resource="xhv:heading"><span class="secno">7.2 </span>Attributes</span></h3>

        <p>When [<cite><a href="#bib-HTML" class="bibref">HTML</a></cite>] defines the processing algorithms to traverse trees for the following attributes, they <strong>must</strong> use the <a data-link-type="dfn" class="internalDFN" href="#dfn-composed-tree">composed tree</a>.
        </p><ul>
          <li><code>dir</code></li>
          <li><code>draggable</code></li>
          <li><code>dropzone</code></li>
          <li><code>hidden</code></li>
          <li><code>lang</code> and <code>xml:lang</code></li>
          <li><code>spellcheck</code></li>
          <li><code>title</code></li>
        </ul>

        <div class="note"><div id="h-note12" role="heading" aria-level="4" class="note-title"><span>Note</span></div><div class="">
          <p>
            This list does not include attributes that are defined elsewhere in this specification. Such attributes include:
          </p>
          <ul>
            <li><code>tabindex</code> is defined in <a href="#focus-navigation">Focus Navigation</a>.</li>
            <li><code>role</code> and <code>ARIA</code> are defined in <a href="#assistive-technology">Assistive Technology</a>.</li>
          </ul>
        </div></div>
      </section>

    </section>

    <section property="bibo:hasPart" resource="#elements-and-dom-interfaces" typeof="bibo:Chapter" id="elements-and-dom-interfaces">
      <!--OddPage--><h2 resource="#h-elements-and-dom-interfaces" id="h-elements-and-dom-interfaces"><span property="xhv:role" resource="xhv:heading"><span class="secno">8. </span>Elements and DOM interfaces</span></h2>

      <section property="bibo:hasPart" resource="#the-shadowroot-interface" typeof="bibo:Chapter" id="the-shadowroot-interface">
        <h3 resource="#h-the-shadowroot-interface" id="h-the-shadowroot-interface"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.1 </span>The <code>ShadowRoot</code> interface</span></h3>

        <p>The <code>ShadowRoot</code> interface represents the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a>.</p>

        <pre class="idl"><span class="idlInterface" id="idl-def-ShadowRoot">interface <span class="idlInterfaceID">ShadowRoot</span> : <span class="idlSuperclass">DocumentFragment</span> {
<span class="idlMethod">    <span class="idlMethType">Selection?</span>        <span class="idlMethName"><a href="#widl-ShadowRoot-getSelection-Selection">getSelection</a></span> ();</span>
<span class="idlMethod">    <span class="idlMethType"><a class="idlType" href="#idl-def-Element"><code>Element</code></a>?</span>          <span class="idlMethName"><a href="#widl-ShadowRoot-elementFromPoint-Element-double-x-double-y">elementFromPoint</a></span> (<span class="idlParam"><span class="idlParamType">double</span> <span class="idlParamName">x</span></span>, <span class="idlParam"><span class="idlParamType">double</span> <span class="idlParamName">y</span></span>);</span>
<span class="idlMethod">    <span class="idlMethType">sequence&lt;<a class="idlType" href="#idl-def-Element"><code>Element</code></a>&gt;</span> <span class="idlMethName"><a href="#widl-ShadowRoot-elementsFromPoint-sequence-Element--double-x-double-y">elementsFromPoint</a></span> (<span class="idlParam"><span class="idlParamType">double</span> <span class="idlParamName">x</span></span>, <span class="idlParam"><span class="idlParamType">double</span> <span class="idlParamName">y</span></span>);</span>
<span class="idlMethod">    <span class="idlMethType">CaretPosition?</span>    <span class="idlMethName"><a href="#widl-ShadowRoot-caretPositionFromPoint-CaretPosition-double-x-double-y">caretPositionFromPoint</a></span> (<span class="idlParam"><span class="idlParamType">double</span> <span class="idlParamName">x</span></span>, <span class="idlParam"><span class="idlParamType">double</span> <span class="idlParamName">y</span></span>);</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType"><a class="idlType" href="#idl-def-Element"><code>Element</code></a>?</span>       <span class="idlAttrName"><a href="#widl-ShadowRoot-activeElement">activeElement</a></span>;</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType"><a class="idlType" href="#idl-def-Element"><code>Element</code></a></span>        <span class="idlAttrName"><a href="#widl-ShadowRoot-host">host</a></span>;</span>
<span class="idlAttribute">    [<span class="extAttr">TreatNullAs=EmptyString</span>]
                attribute <span class="idlAttrType">DOMString</span>      <span class="idlAttrName"><a href="#widl-ShadowRoot-innerHTML">innerHTML</a></span>;</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType">StyleSheetList</span> <span class="idlAttrName"><a href="#widl-ShadowRoot-styleSheets">styleSheets</a></span>;</span>
};</span></pre><section property="bibo:hasPart" resource="#attributes-1" typeof="bibo:Chapter" id="attributes-1"><h4 resource="#h-attributes-1" id="h-attributes-1"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.1.1 </span>Attributes</span></h4><dl class="attributes"><dt id="widl-ShadowRoot-activeElement"><code>activeElement</code> of type <span class="idlAttrType"><a class="idlType" href="#idl-def-Element"><code>Element</code></a></span>, readonly   , nullable</dt><dd>
            <p>Represents the currently focused <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-element">element</a> in the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.</p>
            <p>On getting, the attribute <strong>must</strong> return the currently focused <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-element">element</a> in the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a> or <code>null</code>, if there is none.</p>
          </dd><dt id="widl-ShadowRoot-host"><code>host</code> of type <span class="idlAttrType"><a class="idlType" href="#idl-def-Element"><code>Element</code></a></span>, readonly   </dt><dd>
            <p>Represents the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a> which <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a>.</p>
            <p>On getting, the attribute <strong>must</strong> return the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host">shadow host</a> which <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a>.</p>
          </dd><dt id="widl-ShadowRoot-innerHTML"><code>innerHTML</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd>
            <p>Represents the markup of <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a>'s contents.</p>
            <p>On getting, the attribute <strong>must</strong> return the result of running the <a class="externalDFN" href="http://html.spec.whatwg.org/#html-fragment-serialization-algorithm">HTML fragment serialization algorithm</a> with the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> as <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host" data-lt="shadow host"><code>shadow host</code></a>.</p>
            <p>
              On setting, these steps <strong>must</strong> be run:
            </p>
            <ol>
              <li>Let <var>FRAGMENT</var> be the result of invoking the <a class="externalDFN" href="http://domparsing.spec.whatwg.org/#concept-parse-fragment" data-lt="parse fragment">fragment parsing algorithm</a> [<cite><a href="#bib-DOM-PARSING" class="bibref">DOM-PARSING</a></cite>] with the new value as <var>MARKUP</var>, and the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> as <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-host" data-lt="shadow host"><code>shadow host</code></a></li>
              <li><a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-node-replace-all">Replace all</a> with <var>FRAGMENT</var> within the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a>.</li>
            </ol>
          </dd><dt id="widl-ShadowRoot-styleSheets"><code>styleSheets</code> of type <span class="idlAttrType">StyleSheetList</span>, readonly   </dt><dd>
            <p>Represents the shadow root style sheets.</p>
            <p>On getting, the attribute <strong>must</strong> return a <a class="externalDFN" href="http://www.w3.org/TR/cssom/#the-stylesheetlist-interface"><code>StyleSheetList</code></a> sequence containing the shadow root style sheets.
            </p>
          </dd></dl></section><section property="bibo:hasPart" resource="#methods" typeof="bibo:Chapter" id="methods"><h4 resource="#h-methods" id="h-methods"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.1.2 </span>Methods</span></h4><dl class="methods"><dt id="widl-ShadowRoot-caretPositionFromPoint-CaretPosition-double-x-double-y"><code>caretPositionFromPoint</code></dt><dd>
            <div class="note"><div id="h-note13" role="heading" aria-level="5" class="note-title"><span>Note</span></div><p class="">
              It could be defined in roughly the same way as <a class="externalDFN" href="http://www.w3.org/TR/cssom-view/#dom-document-caretpositionfrompoint">caretPositionFromPoint</a> [<cite><a href="#bib-CSSOM-VIEW" class="bibref">CSSOM-VIEW</a></cite>].
              Eventually, this needs to be part of CSSOM View Module specification [<cite><a href="#bib-CSSOM-VIEW" class="bibref">CSSOM-VIEW</a></cite>]. See also <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=27829"><abbr title="World Wide Web Consortium">W3C</abbr> bug 27829</a>.
          </p></div><table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">x</td><td class="prmType"><code>double</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr><tr><td class="prmName">y</td><td class="prmType"><code>double</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code>CaretPosition</code>, nullable</div></dd><dt id="widl-ShadowRoot-elementFromPoint-Element-double-x-double-y"><code>elementFromPoint</code></dt><dd>
            <p>Returns an <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-element">element</a> at specified coordinates.</p>
            <div class="note"><div id="h-note14" role="heading" aria-level="5" class="note-title"><span>Note</span></div><p class="">
              Eventually, this needs to be part of CSSOM View Module specification [<cite><a href="#bib-CSSOM-VIEW" class="bibref">CSSOM-VIEW</a></cite>]. See also <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=27829"><abbr title="World Wide Web Consortium">W3C</abbr> bug 27829</a>.
            </p></div>
            <p>
              When invoked, it <strong>must</strong> return result of running the following steps:
            </p>
            <ol>
              <li>If <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> is not a <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a> instance, throw an <a class="externalDFN" href="http://dom.spec.whatwg.org/#invalidnodetypeerror"><code>InvalidNodeTypeError</code></a>.</li>
              <li>If either argument is negative, <code>x</code> is greater than the <a class="externalDFN" href="http://www.w3.org/TR/cssom-view/#viewport">viewport</a> width excluding the size of a rendered scroll bar (if any), or if <code>y</code> is greater than the <a class="externalDFN" href="http://www.w3.org/TR/cssom-view/#viewport">viewport</a> height excluding the size of a rendered scroll bar (if any), return <strong>null</strong>.</li>
              <li>Let <var>HIT</var> be the <a class="externalDFN" href="http://dom.spec.whatwg.org/#concept-element">element</a> at coordinates <code>x</code> and <code>y</code> in the <a class="externalDFN" href="http://www.w3.org/TR/cssom-view/#viewport">viewport</a>, determined through hit testing</li>
              <li>Return the result of running the <a data-link-type="dfn" class="internalDFN" href="#dfn-retargeting-algorithm">retargeting algorithm</a> with <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> and <var>HIT</var> as input</li>
            </ol>
          <table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">x</td><td class="prmType"><code>double</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr><tr><td class="prmName">y</td><td class="prmType"><code>double</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code><a class="idlType" href="#idl-def-Element"><code>Element</code></a></code>, nullable</div></dd><dt id="widl-ShadowRoot-elementsFromPoint-sequence-Element--double-x-double-y"><code>elementsFromPoint</code></dt><dd>
            <div class="note"><div id="h-note15" role="heading" aria-level="5" class="note-title"><span>Note</span></div><p class="">
              It could be defined in roughly the same way as elementFromPoint.
              Eventually, this needs to be part of CSSOM View Module specification [<cite><a href="#bib-CSSOM-VIEW" class="bibref">CSSOM-VIEW</a></cite>]. See also <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=27829"><abbr title="World Wide Web Consortium">W3C</abbr> bug 27829</a>.
            </p></div>
          <table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">x</td><td class="prmType"><code>double</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr><tr><td class="prmName">y</td><td class="prmType"><code>double</code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code>sequence&lt;<a class="idlType" href="#idl-def-Element"><code>Element</code></a>&gt;</code></div></dd><dt id="widl-ShadowRoot-getSelection-Selection"><code>getSelection</code></dt><dd>
            <p>Returns the current selection in the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.</p>
            <p>When invoked, it <strong>must</strong> return the <a class="externalDFN" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selection</a> in the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-tree">shadow tree</a>.</p>
          <div><em>No parameters.</em></div><div><em>Return type: </em><code>Selection</code>, nullable</div></dd></dl></section>

        <p>The <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-node-nodetype"><code>nodeType</code></a> attribute of a <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a> instance <strong>must</strong> return <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-node-document_fragment_node"><code>DOCUMENT_FRAGMENT_NODE</code></a>. Accordingly, the <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-node-nodename"><code>nodeName</code></a> attribute of a <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a> instance <strong>must</strong> return <code>"#document-fragment"</code>.</p>

        <p>Invoking the <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-node-clonenode"><code>cloneNode()</code></a> method on a <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a> instance <strong>must</strong> always throw a <a class="externalDFN" href="http://dom.spec.whatwg.org/#dom-domexception-data_clone_err"><code>DATA_CLONE_ERR</code></a> exception.</p>

      </section>

      <section property="bibo:hasPart" resource="#extensions-to-element-interface" typeof="bibo:Chapter" id="extensions-to-element-interface">
        <h3 resource="#h-extensions-to-element-interface" id="h-extensions-to-element-interface"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.2 </span>Extensions to <code>Element</code> Interface</span></h3>

        <pre class="idl"><span class="idlInterface" id="idl-def-Element">partial interface <span class="idlInterfaceID">Element</span> {
<span class="idlMethod">    <span class="idlMethType"><a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a></span> <span class="idlMethName"><a href="#widl-Element-attachShadow-ShadowRoot-ShadowRootInit-shadowRootInitDict">attachShadow</a></span> (<span class="idlParam"><span class="idlParamType"><a class="idlType" href="#idl-def-ShadowRootInit"><code>ShadowRootInit</code></a></span> <span class="idlParamName">shadowRootInitDict</span></span>);</span>
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span>   <span class="idlAttrName"><a href="#widl-Element-slot">slot</a></span>;</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType"><a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a>?</span> <span class="idlAttrName"><a href="#widl-Element-shadowRoot">shadowRoot</a></span>;</span>
};</span></pre><section property="bibo:hasPart" resource="#attributes-2" typeof="bibo:Chapter" id="attributes-2"><h4 resource="#h-attributes-2" id="h-attributes-2"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.2.1 </span>Attributes</span></h4><dl class="attributes"><dt id="widl-Element-shadowRoot"><code>shadowRoot</code> of type <span class="idlAttrType"><a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a></span>, readonly   , nullable</dt><dd>
            <p>Represents the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a> that <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a>.</p>
            <p>On getting, the attribute <strong>must</strong> return the <a data-link-type="dfn" class="internalDFN" href="#dfn-shadow-root">shadow root</a> that <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> <a data-link-type="dfn" class="internalDFN" href="#dfn-host">hosts</a> if there is and it is <a data-link-type="dfn" class="internalDFN" href="#dfn-open">open</a>. Otherwise <strong>must</strong> return <code>null</code>.</p>
          </dd><dt id="widl-Element-slot"><code>slot</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd>
            <p>
              Reflects the <code>slot</code> attribute. The <code>slot</code> attribute represents the <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-name">slot name</a> of a slot to where this element is assigned.
            </p>
          </dd></dl></section><section property="bibo:hasPart" resource="#methods-1" typeof="bibo:Chapter" id="methods-1"><h4 resource="#h-methods-1" id="h-methods-1"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.2.2 </span>Methods</span></h4><dl class="methods"><dt id="widl-Element-attachShadow-ShadowRoot-ShadowRootInit-shadowRootInitDict"><code>attachShadow</code></dt><dd>
            When invoked, these steps <strong>must</strong> be run:
            <ol>
              <li>
                If the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> is one of the following elements, throws <code>NotSupportedError</code> exception.
                <ul>
                  <li><code>button</code></li>
                  <li><code>details</code></li>
                  <li><code>input</code></li>
                  <li><code>marquee</code></li>
                  <li><code>meter</code></li>
                  <li><code>progress</code></li>
                  <li><code>select</code></li>
                  <li><code>textarea</code></li>
                  <li><code>keygen</code></li>
                </ul>
                <div class="note"><div id="h-note16" role="heading" aria-level="5" class="note-title"><span>Note</span></div><p class="">
                  These are the elements whose rendering is defined through a <a class="externalDFN" href="http://html.spec.whatwg.org/#bindings">binding</a> property in HTML's Rendering section.
                </p></div>
              </li>
              <li>If the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> already hosts the shadow tree, throws <code>InvalidStateError</code> exception.</li>
              <li>
                Create a new instance of the <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a> object.
                The <code>shadowRootInitDict</code> argument allows for setting the <a data-link-type="dfn" class="internalDFN" href="#dfn-encapsulation-mode">encapsulation mode</a>.
              </li>
              <li>Let the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> host the <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a> object.</li>
              <li>Return <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a> object.</li>
            </ol>
          <table class="parameters"><tbody><tr><th>Parameter</th><th>Type</th><th>Nullable</th><th>Optional</th><th>Description</th></tr><tr><td class="prmName">shadowRootInitDict</td><td class="prmType"><code><a class="idlType" href="#idl-def-ShadowRootInit"><code>ShadowRootInit</code></a></code></td><td class="prmNullFalse"><span role="img" aria-label="False">✘</span></td><td class="prmOptFalse"><span role="img" aria-label="False">✘</span></td><td class="prmDesc"></td></tr></tbody></table><div><em>Return type: </em><code><a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a></code></div></dd></dl></section>
      </section>

      <section property="bibo:hasPart" resource="#shadowrootinit-dictionary" typeof="bibo:Chapter" id="shadowrootinit-dictionary">
        <h3 resource="#h-shadowrootinit-dictionary" id="h-shadowrootinit-dictionary"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.3 </span><code>ShadowRootInit</code> dictionary</span></h3>
        <pre class="idl"><span class="idlDictionary" id="idl-def-ShadowRootInit">dictionary <span class="idlDictionaryID">ShadowRootInit</span> {
<span class="idlMember">    required <span class="idlMemberType"><a class="idlType" href="#idl-def-ShadowRootMode"><code>ShadowRootMode</code></a></span> <span class="idlMemberName"><a href="#widl-ShadowRootInit-mode">mode</a></span>;</span>
};</span></pre><section property="bibo:hasPart" resource="#dictionary-shadowrootinit-members" typeof="bibo:Chapter" id="dictionary-shadowrootinit-members"><h4 resource="#h-dictionary-shadowrootinit-members" id="h-dictionary-shadowrootinit-members"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.3.1 </span>Dictionary <a href="#idl-def-ShadowRootInit" class="idlType"><code>ShadowRootInit</code></a> Members</span></h4><dl class="dictionary-members"><dt id="widl-ShadowRootInit-mode"><code>mode</code> of type <span class="idlMemberType"><a class="idlType" href="#idl-def-ShadowRootMode"><code>ShadowRootMode</code></a></span>, required</dt><dd>Specifies the <a data-link-type="dfn" class="internalDFN" href="#dfn-encapsulation-mode">encapsulation mode</a> of <a class="idlType" href="#idl-def-ShadowRoot"><code>ShadowRoot</code></a></dd></dl></section>
      </section>

      <section property="bibo:hasPart" resource="#shadowrootmode-enum" typeof="bibo:Chapter" id="shadowrootmode-enum">
        <h3 resource="#h-shadowrootmode-enum" id="h-shadowrootmode-enum"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.4 </span><code>ShadowRootMode</code> enum</span></h3>
        <pre class="idl"><span class="idlEnum" id="idl-def-ShadowRootMode">enum <span class="idlEnumID">ShadowRootMode</span> {
    "<a href="#idl-def-ShadowRootMode.open" class="idlEnumItem">open</a>",
    "<a href="#idl-def-ShadowRootMode.closed" class="idlEnumItem">closed</a>"
};</span></pre><table class="simple"><tbody><tr><th colspan="2">Enumeration description</th></tr><tr><td><code id="idl-def-ShadowRootMode.open">open</code></td><td>Specifies <a data-link-type="dfn" class="internalDFN" href="#dfn-open">open</a> <a data-link-type="dfn" class="internalDFN" href="#dfn-encapsulation-mode">encapsulation mode</a></td></tr><tr><td><code id="idl-def-ShadowRootMode.closed">closed</code></td><td>Specifies <a data-link-type="dfn" class="internalDFN" href="#dfn-closed">closed</a> <a data-link-type="dfn" class="internalDFN" href="#dfn-encapsulation-mode">encapsulation mode</a></td></tr></tbody></table>
      </section>

      <section property="bibo:hasPart" resource="#extensions-to-nondocumenttypechildnode-interface" typeof="bibo:Chapter" id="extensions-to-nondocumenttypechildnode-interface">
        <h3 resource="#h-extensions-to-nondocumenttypechildnode-interface" id="h-extensions-to-nondocumenttypechildnode-interface"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.5 </span>Extensions to <code>NonDocumentTypeChildNode</code> Interface</span></h3>

        <pre class="idl"><span class="idlInterface" id="idl-def-NonDocumentTypeChildNode">partial interface <span class="idlInterfaceID">NonDocumentTypeChildNode</span> {
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType"><a class="idlType" href="#idl-def-HTMLSlotElement"><code>HTMLSlotElement</code></a>?</span> <span class="idlAttrName"><a href="#widl-NonDocumentTypeChildNode-assignedSlot">assignedSlot</a></span>;</span>
};</span></pre><section property="bibo:hasPart" resource="#attributes-3" typeof="bibo:Chapter" id="attributes-3"><h4 resource="#h-attributes-3" id="h-attributes-3"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.5.1 </span>Attributes</span></h4><dl class="attributes"><dt id="widl-NonDocumentTypeChildNode-assignedSlot"><code>assignedSlot</code> of type <span class="idlAttrType"><a class="idlType" href="#idl-def-HTMLSlotElement"><code>HTMLSlotElement</code></a></span>, readonly   , nullable</dt><dd>
            <p>
              Represents the <a data-link-type="dfn" class="internalDFN" href="#dfn-assigned-slot">assigned slot</a> of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a>.
            </p>
            <p>
              On getting, the attribute <strong>must</strong> return the <a data-link-type="dfn" class="internalDFN" href="#dfn-assigned-slot">assigned slot</a> of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a>, if there is, and the assigned slot participates in an <a data-link-type="dfn" class="internalDFN" href="#dfn-open">open</a> shadow tree.
              Otherwise <strong>must</strong> return <code>null</code>.
            </p>
          </dd></dl></section>
      </section>

      <section property="bibo:hasPart" resource="#the-slot-element" typeof="bibo:Chapter" id="the-slot-element">
        <h3 resource="#h-the-slot-element" id="h-the-slot-element"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.6 </span>The <code>slot</code> element</span></h3>

        <p>The <dfn id="dfn-slot-element" data-dfn-type="dfn">slot element</dfn> is used to define a location of a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>.</p>

        <p>If a <code>slot</code> element does not satisfy the condition of a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>, it <strong>must</strong> have the same rendering behavior as the <a class="externalDFN" href="http://html.spec.whatwg.org/#htmlunknownelement"><code>HTMLUnknownElement</code></a>.</p>

        <dl>
          <dt>Context</dt>
          <dd>Where <a class="externalDFN" href="http://html.spec.whatwg.org/#flow-content">flow content</a> is expected.</dd>

          <dt>Content model</dt>
          <dd><a class="externalDFN" href="http://html.spec.whatwg.org/#transparent">Transparent</a></dd>

          <dt>Children</dt>
          <dd>Anything as fallback content</dd>

          <dt>Content attributes</dt>
          <dd><a class="externalDFN" href="http://html.spec.whatwg.org/#global-attributes">Global attributes</a></dd>
          <dd>
            <dl>
              <dt><code>name</code>, the <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-name">slot name</a></dt>
              <dd>Represents the <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-name">slot name</a>.</dd>
            </dl>
          </dd>

          <dt>DOM Interface</dt>
          <dd>
            <pre class="idl"><span class="idlInterface" id="idl-def-HTMLSlotElement">interface <span class="idlInterfaceID">HTMLSlotElement</span> : <span class="idlSuperclass">HTMLElement</span> {
<span class="idlAttribute">                attribute <span class="idlAttrType">DOMString</span> <span class="idlAttrName"><a href="#widl-HTMLSlotElement-name">name</a></span>;</span>
<span class="idlMethod">    <span class="idlMethType">sequence&lt;Node&gt;</span> <span class="idlMethName"><a href="#widl-HTMLSlotElement-getDistributedNodes-sequence-Node">getDistributedNodes</a></span> ();</span>
};</span></pre><section property="bibo:hasPart" resource="#attributes-5" typeof="bibo:Chapter"><h4 resource="#attributes-5" id="attributes-5"><span property="xhv:role" resource="xhv:heading">Attributes</span></h4><dl class="attributes"><dt id="widl-HTMLSlotElement-name"><code>name</code> of type <span class="idlAttrType">DOMString</span>,            </dt><dd><strong>Must</strong> <a class="externalDFN" href="http://html.spec.whatwg.org/#reflect">reflect</a> the <a data-link-type="dfn" class="internalDFN" href="#dfn-slot-name" data-lt="slot name">name</a> attribute.</dd></dl></section><section property="bibo:hasPart" resource="#methods-2" typeof="bibo:Chapter"><h4 resource="#methods-2" id="methods-2"><span property="xhv:role" resource="xhv:heading">Methods</span></h4><dl class="methods"><dt id="widl-HTMLSlotElement-getDistributedNodes-sequence-Node"><code>getDistributedNodes</code></dt><dd>
                When invoked, it <strong>must</strong> return result of running the following steps:
                <ol>
                  <li>
                    If the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a> is a <a data-link-type="dfn" class="internalDFN" href="#dfn-slot">slot</a>:
                    <ol>
                      <li>
                        Return a sequence consisting of nodes in the <a data-link-type="dfn" class="internalDFN" href="#dfn-distributed-nodes">distributed nodes</a> of the <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a>.
                      </li>
                    </ol>
                  </li>
                  <li>
                    Otherwise:
                    <ol>
                      <li>Return an empty sequence.</li>
                    </ol>
                  </li>
                </ol>
              <div><em>No parameters.</em></div><div><em>Return type: </em><code>sequence&lt;Node&gt;</code></div></dd></dl></section>
          </dd>
        </dl>
      </section>

      <section property="bibo:hasPart" resource="#extensions-to-eventinit-dictionary" typeof="bibo:Chapter" id="extensions-to-eventinit-dictionary">
        <h3 resource="#h-extensions-to-eventinit-dictionary" id="h-extensions-to-eventinit-dictionary"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.7 </span>Extensions to <a class="externalDFN" href="http://dom.spec.whatwg.org/#dictdef-eventinit"><code>EventInit</code></a> Dictionary</span></h3>

        <pre class="idl"><span class="idlDictionary" id="idl-def-EventInit">partial dictionary <span class="idlDictionaryID">EventInit</span> {
<span class="idlMember">             <span class="idlMemberType">boolean</span> <span class="idlMemberName"><a href="#widl-EventInit-scoped">scoped</a></span> = <span class="idlMemberValue">false</span>;</span>
};</span></pre><section property="bibo:hasPart" resource="#dictionary-eventinit-members" typeof="bibo:Chapter" id="dictionary-eventinit-members"><h4 resource="#h-dictionary-eventinit-members" id="h-dictionary-eventinit-members"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.7.1 </span>Dictionary <a href="#idl-def-EventInit" class="idlType"><code>EventInit</code></a> Members</span></h4><dl class="dictionary-members"><dt id="widl-EventInit-scoped"><code>scoped</code> of type <span class="idlMemberType">boolean</span>,         , defaulting to <code>false</code></dt><dd>
            <p>Specifies the <a data-link-type="dfn" class="internalDFN" href="#dfn-scoped-flag">scoped flag</a> of <code>Event</code></p>
          </dd></dl></section>
      </section>

      <section property="bibo:hasPart" resource="#extensions-to-event-interface" typeof="bibo:Chapter" id="extensions-to-event-interface">
        <h3 resource="#h-extensions-to-event-interface" id="h-extensions-to-event-interface"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.8 </span>Extensions to <code>Event</code> Interface</span></h3>

        <pre class="idl"><span class="idlInterface" id="idl-def-Event">partial interface <span class="idlInterfaceID">Event</span> {
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType">object</span>  <span class="idlAttrName"><a href="#widl-Event-deepPath">deepPath</a></span>;</span>
<span class="idlAttribute">    readonly    attribute <span class="idlAttrType">boolean</span> <span class="idlAttrName"><a href="#widl-Event-scoped">scoped</a></span>;</span>
};</span></pre><section property="bibo:hasPart" resource="#attributes-4" typeof="bibo:Chapter" id="attributes-4"><h4 resource="#h-attributes-4" id="h-attributes-4"><span property="xhv:role" resource="xhv:heading"><span class="secno">8.8.1 </span>Attributes</span></h4><dl class="attributes"><dt id="widl-Event-deepPath"><code>deepPath</code> of type <span class="idlAttrType">object</span>, readonly   </dt><dd>
            <p>Represents the event path.</p>
            <p>
              On getting, the attribute <strong>must</strong> create and return a new JavaScript Array object,
              that <strong>must</strong> be equivalent to processing the following steps:
            </p>

            <div class="algorithm">
              <dl>
                <dt>Input</dt>
                <dd><var>EVENT</var>, a <a class="externalDFN" href="http://dom.spec.whatwg.org/#context-object">context object</a></dd>
                <dt>Output</dt>
                <dd><var>PATH</var>, an array of nodes</dd>
              </dl>

              <ol>
                <li>If <var>EVENT</var> hasn't been dispatched, return a new empty array.</li>
                <li>
                  Otherwise:
                  <ol>
                    <li>Let <var>PATH</var> be the event path of <var>EVENT</var>.</li>
                    <li>
                      If <var>EVENT</var> is being dispatched:
                      <ol>
                        <li>Let <var>CURRENT-TARGET</var> be the current target of <var>EVENT</var>.</li>
                      </ol>
                    </li>
                    <li>
                      Otherwise:
                      <ol>
                        <li>Let <var>CURRENT-TARGET</var> be the last node of <var>PATH</var>.</li>
                      </ol>
                    </li>
                    <li>Let PATH contain only a node which is an <a data-link-type="dfn" class="internalDFN" href="#dfn-unclosed-node">unclosed node</a> of <var>CURRENT-TARGET</var>.</li>
                  </ol>
                </li>
              </ol>
            </div>

            <div id="issue-2" class="issue"><div id="h-issue2" role="heading" aria-level="5" class="issue-title"><span>Issue 2</span></div><p class="">
              The API is not stable and may change. Use <code>FrozenArray</code> as the return type of the <code>deepPath</code> attribute in WebIDL.
              See <a href="https://github.com/w3c/webcomponents/issues/101">Issue #101</a>
            </p></div>
          </dd><dt id="widl-Event-scoped"><code>scoped</code> of type <span class="idlAttrType">boolean</span>, readonly   </dt><dd>
            <p>
              Returns the <dfn id="dfn-scoped-flag" data-dfn-type="dfn">scoped flag</dfn>.
            </p>
          </dd></dl></section>
      </section>

    </section>

    <section property="bibo:hasPart" resource="#shadow-dom-example" typeof="bibo:Chapter" id="shadow-dom-example">
      <!--OddPage--><h2 resource="#h-shadow-dom-example" id="h-shadow-dom-example"><span property="xhv:role" resource="xhv:heading"><span class="secno">9. </span>Shadow DOM Example</span></h2>

      <p>Bob was asked to turn a simple list of links into a News Widget, which has links organized into two categories: breaking news and just news. The current document markup for the stories looks like this:</p>
      <div class="example"><div class="example-title"><span>Example 2</span></div><pre style="" class="example highlight prettyprint prettyprinted"><span class="tag">&lt;ul</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"stories"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/1"</span><span class="tag">&gt;</span><span class="pln">A story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/2"</span><span class="tag">&gt;</span><span class="pln">Another story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="pln"> </span><span class="atn">slot</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/3"</span><span class="tag">&gt;</span><span class="pln">Also a story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/4"</span><span class="tag">&gt;</span><span class="pln">Yet another story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/5"</span><span class="tag">&gt;</span><span class="pln">Awesome story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
    </span><span class="tag">&lt;li</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="pln"> </span><span class="atn">slot</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;&lt;a</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"//example.com/stories/6"</span><span class="tag">&gt;</span><span class="pln">Horrible story</span><span class="tag">&lt;/a&gt;&lt;/li&gt;</span><span class="pln">
</span><span class="tag">&lt;/ul&gt;</span></pre></div>

      <div id="issue-3" class="issue"><div id="h-issue3" role="heading" aria-level="3" class="issue-title"><span>Issue 3</span></div><p class="">
       It's weird that there are slot attributes in this markup because Bob has not decided to use Shadow DOM yet.
      </p></div>

      <p>To organize the stories, Bob decides to use <strong>shadow DOM</strong>. Doing so will allow Bob to keep the document markup uncluttered, and harnessing the power of insertion point makes sorting stories by class name a very simple task. After getting another cup of <a href="http://en.wikipedia.org/wiki/List_of_coffee_beverages#Green_Eye">Green Eye</a>, he quickly mocks up the following shadow tree, to be hosted by the <code>ul</code> element:</p>
      <div class="example"><div class="example-title"><span>Example 3</span></div><pre style="" class="example highlight prettyprint prettyprinted"><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;ul&gt;</span><span class="pln">
        </span><span class="tag">&lt;slot</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">"breaking"</span><span class="tag">&gt;&lt;/slot&gt;</span><span class="pln"> </span><span class="com">&lt;!-- slot for breaking news --&gt;</span><span class="pln">
    </span><span class="tag">&lt;/ul&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span><span class="pln">
</span><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"other"</span><span class="tag">&gt;</span><span class="pln">
    </span><span class="tag">&lt;ul&gt;</span><span class="pln">
        </span><span class="tag">&lt;slot&gt;&lt;/slot&gt;</span><span class="pln"> </span><span class="com">&lt;!-- slot for the rest of the news --&gt;</span><span class="pln">
    </span><span class="tag">&lt;/ul&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span></pre></div>
      <p>Bob then styles the newborn widget according to comps from the designer by adding this to the shadow tree mockup:</p>
      <div class="example"><div class="example-title"><span>Example 4</span></div><pre style="" class="example highlight prettyprint prettyprinted"><span class="tag">&lt;style&gt;</span><span class="pln">
    div</span><span class="pun">.</span><span class="pln">breaking </span><span class="pun">{</span><span class="pln">
        color</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Red</span><span class="pun">;</span><span class="pln">
        font</span><span class="pun">-</span><span class="pln">size</span><span class="pun">:</span><span class="pln"> </span><span class="lit">20px</span><span class="pun">;</span><span class="pln">
        border</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1px</span><span class="pln"> dashed </span><span class="typ">Purple</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
    div</span><span class="pun">.</span><span class="pln">other </span><span class="pun">{</span><span class="pln">
        padding</span><span class="pun">:</span><span class="pln"> </span><span class="lit">2px</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln">
        border</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1px</span><span class="pln"> solid </span><span class="typ">Cyan</span><span class="pun">;</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
</span><span class="tag">&lt;/style&gt;</span></pre></div>
      <p>While pondering if his company should start looking for a new designer, Bob converts the mockup to code:</p>
      <div class="example"><div class="example-title"><span>Example 5</span></div><pre style="" class="example highlight prettyprint prettyprinted"><span class="kwd">function</span><span class="pln"> createStoryGroup</span><span class="pun">(</span><span class="pln">className</span><span class="pun">,</span><span class="pln"> slotName</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> </span><span class="kwd">group</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'div'</span><span class="pun">);</span><span class="pln">
    </span><span class="kwd">group</span><span class="pun">.</span><span class="pln">className </span><span class="pun">=</span><span class="pln"> className</span><span class="pun">;</span><span class="pln">
    </span><span class="com">// Empty string in slot name attribute or absence thereof work the same, so no need for special handling.</span><span class="pln">
    </span><span class="kwd">group</span><span class="pun">.</span><span class="pln">innerHTML </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;ul&gt;&lt;slot name="'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> slotName </span><span class="pun">+</span><span class="pln"> </span><span class="str">'"&gt;&lt;/slot&gt;&lt;/ul&gt;'</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">group</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> createStyle</span><span class="pun">()</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> style </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'style'</span><span class="pun">);</span><span class="pln">
    style</span><span class="pun">.</span><span class="pln">textContent </span><span class="pun">=</span><span class="pln"> </span><span class="str">'div.breaking { color: Red;font-size: 20px; border: 1px dashed Purple; }'</span><span class="pln"> </span><span class="pun">+</span><span class="pln">
        </span><span class="str">'div.other { padding: 2px 0 0 0; border: 1px solid Cyan; }'</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> style</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> makeShadowTree</span><span class="pun">(</span><span class="pln">storyList</span><span class="pun">)</span><span class="pln">
</span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> root </span><span class="pun">=</span><span class="pln"> storyList</span><span class="pun">.</span><span class="pln">attachShadow</span><span class="pun">({</span><span class="pln">mode</span><span class="pun">:</span><span class="pln"> </span><span class="str">'open'</span><span class="pun">});</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStyle</span><span class="pun">());</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStoryGroup</span><span class="pun">(</span><span class="str">'breaking'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'breaking'</span><span class="pun">));</span><span class="pln">
    root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">createStoryGroup</span><span class="pun">(</span><span class="str">'other'</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">));</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

document</span><span class="pun">.</span><span class="pln">addEventListener</span><span class="pun">(</span><span class="str">'DOMContentLoaded'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="pun">[].</span><span class="pln">forEach</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="pln">document</span><span class="pun">.</span><span class="pln">querySelectorAll</span><span class="pun">(</span><span class="str">'ul.stories'</span><span class="pun">),</span><span class="pln"> makeShadowTree</span><span class="pun">);</span><span class="pln">
</span><span class="pun">});</span></pre></div>

      <p>Well done, Bob! With the cup of coffee still half-full, the work is complete. Recognizing his awesomeness, Bob returns to teaching n00bs the ways of <a href="https://en.wikipedia.org/wiki/Splatoon">Splatoon</a>.</p>
    </section>

    <section property="bibo:hasPart" resource="#acknowledgements" typeof="bibo:Chapter" id="acknowledgements" class="appendix">
      <!--OddPage--><h2 resource="#h-acknowledgements" id="h-acknowledgements"><span property="xhv:role" resource="xhv:heading"><span class="secno">A. </span>Acknowledgements</span></h2>

      <p><span class="vcard">David Hyatt</span> developed <a href="http://dev.w3.org/2006/xbl2/">XBL 1.0</a>, and <span class="vcard">Ian Hickson</span> co-wrote <a href="http://dev.w3.org/2006/xbl2/">XBL 2.0</a>. These documents provided tremendous insight into the problem of functional encapsulation and greatly influenced this specification.</p>

      <p><span class="vcard">Alex Russell</span> and his considerable forethought triggered a new wave of enthusiasm around the subject of shadow DOM and how it can be applied practically on the Web.</p>

      <p><span class="vcard">Dominic Cooney</span>, <span class="vcard">Hajime Morrita</span>, and <span class="vcard">Roland Steiner</span> worked tirelessly to scope the problem of functional encapsulation within the confines of the Web platform and provided a solid foundation for this document.</p>

      <p>The editor would also like to thank <span class="vcard">Alex Komoroske</span>, <span class="vcard">Anne van Kesteren</span>, <span class="vcard">Brandon Payton</span>, <span class="vcard">Brian Kardell</span>, <span class="vcard">Darin Fisher</span>, <span class="vcard">Eric Bidelman</span>, <span class="vcard">Deepak Sherveghar</span>, <span class="vcard">Edward O'Connor</span>, <span class="vcard">Elisée Maurer</span>, <span class="vcard">Elliott Sprehn</span>, <span class="vcard">Erik Arvidsson</span>, <span class="vcard">Glenn Adams</span>, <span class="vcard">Jonas Sicking</span>, <span class="vcard">Koji Ishii</span>, <span class="vcard">Malte Ubl</span>, <span class="vcard">Mike Taylor</span>, <span class="vcard">Oliver Nightingale</span>, <span class="vcard">Olli Pettay</span>, <span class="vcard">Rafael Weinstein</span>, <span class="vcard">Richard Bradshaw</span>, <span class="vcard">Ruud Steltenpool</span>, <span class="vcard">Sam Dutton</span>, <span class="vcard">Sergey G. Grekhov</span>, <span class="vcard">Shinya Kawanaka</span>, <span class="vcard">Tab Atkins</span>, <span class="vcard">Takashi Sakamoto</span>, and <span class="vcard">Yoshinori Sano</span> for their comments and contributions to this specification.</p>

      <p>This list is too short. There's a lot of work left to do. Please contribute by reviewing and filing bugs—and don't forget to ask the editor to add your name into this section.</p>
    </section>

  

<section property="bibo:hasPart" resource="#references" typeof="bibo:Chapter" id="references" class="appendix"><!--OddPage--><h2 resource="#h-references" id="h-references"><span property="xhv:role" resource="xhv:heading"><span class="secno">B. </span>References</span></h2><section property="bibo:hasPart" resource="#normative-references" typeof="bibo:Chapter" id="normative-references"><h3 resource="#h-normative-references" id="h-normative-references"><span property="xhv:role" resource="xhv:heading"><span class="secno">B.1 </span>Normative references</span></h3><dl resource="" class="bibliography"><dt id="bib-CSS3-UI">[CSS3UI]</dt><dd>Tantek Çelik; Florian Rivoal. <a property="dc:requires" href="http://www.w3.org/TR/css-ui-3/"><cite>CSS Basic User Interface Module Level 3 (CSS3 UI)</cite></a>. 7 July 2015. W3C Candidate Recommendation. URL: <a property="dc:requires" href="http://www.w3.org/TR/css-ui-3/">http://www.w3.org/TR/css-ui-3/</a>
</dd><dt id="bib-CSSOM-VIEW">[CSSOM-VIEW]</dt><dd>Simon Pieters; Glenn Adams. <a property="dc:requires" href="http://www.w3.org/TR/cssom-view/"><cite>CSSOM View Module</cite></a>. 17 December 2013. W3C Working Draft. URL: <a property="dc:requires" href="http://www.w3.org/TR/cssom-view/">http://www.w3.org/TR/cssom-view/</a>
</dd><dt id="bib-DOM">[DOM]</dt><dd>Anne van Kesteren; Aryeh Gregor; Ms2ger; Alex Russell; Robin Berjon. <a property="dc:requires" href="http://www.w3.org/TR/dom/"><cite>W3C DOM4</cite></a>. 18 June 2015. W3C Last Call Working Draft. URL: <a property="dc:requires" href="http://www.w3.org/TR/dom/">http://www.w3.org/TR/dom/</a>
</dd><dt id="bib-DOM-Level-3-Events">[DOM-Level-3-Events]</dt><dd>Gary Kacmarcik; Travis Leithead. <a property="dc:requires" href="http://www.w3.org/TR/uievents/"><cite>UI Events (formerly DOM Level 3 Events)</cite></a>. 28 April 2015. W3C Working Draft. URL: <a property="dc:requires" href="http://www.w3.org/TR/uievents/">http://www.w3.org/TR/uievents/</a>
</dd><dt id="bib-DOM-PARSING">[DOM-PARSING]</dt><dd>Travis Leithead. <a property="dc:requires" href="http://www.w3.org/TR/DOM-Parsing/"><cite>DOM Parsing and Serialization</cite></a>. 17 June 2014. W3C Candidate Recommendation. URL: <a property="dc:requires" href="http://www.w3.org/TR/DOM-Parsing/">http://www.w3.org/TR/DOM-Parsing/</a>
</dd><dt id="bib-EDITING">[EDITING]</dt><dd>Aryeh Gregor. <a property="dc:requires" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html"><cite>HTML Editing APIs</cite></a>. URL: <a property="dc:requires" href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html">https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html</a>
</dd><dt id="bib-HTML">[HTML]</dt><dd>Ian Hickson. <a property="dc:requires" href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a property="dc:requires" href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
</dd><dt id="bib-RFC2119">[RFC2119]</dt><dd>S. Bradner. <a property="dc:requires" href="https://tools.ietf.org/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a property="dc:requires" href="https://tools.ietf.org/html/rfc2119">https://tools.ietf.org/html/rfc2119</a>
</dd><dt id="bib-TOUCH-EVENTS">[TOUCH-EVENTS]</dt><dd>Doug Schepers; Sangwhan Moon; Matt Brubeck; Arthur Barstow. <a property="dc:requires" href="http://www.w3.org/TR/touch-events/"><cite>Touch Events</cite></a>. 10 October 2013. W3C Recommendation. URL: <a property="dc:requires" href="http://www.w3.org/TR/touch-events/">http://www.w3.org/TR/touch-events/</a>
</dd><dt id="bib-WAI-ARIA">[WAI-ARIA]</dt><dd>James Craig; Michael Cooper et al. <a property="dc:requires" href="http://www.w3.org/TR/wai-aria/"><cite>Accessible Rich Internet Applications (WAI-ARIA) 1.0</cite></a>. 20 March 2014. W3C Recommendation. URL: <a property="dc:requires" href="http://www.w3.org/TR/wai-aria/">http://www.w3.org/TR/wai-aria/</a>
</dd></dl></section><section property="bibo:hasPart" resource="#informative-references" typeof="bibo:Chapter" id="informative-references"><h3 resource="#h-informative-references" id="h-informative-references"><span property="xhv:role" resource="xhv:heading"><span class="secno">B.2 </span>Informative references</span></h3><dl resource="" class="bibliography"><dt id="bib-css-scoping-1">[css-scoping-1]</dt><dd>Tab Atkins Jr.; Elika Etemad. <a property="dc:references" href="http://www.w3.org/TR/css-scoping-1/"><cite>CSS Scoping Module Level 1</cite></a>. 3 April 2014. W3C Working Draft. URL: <a property="dc:references" href="http://www.w3.org/TR/css-scoping-1/">http://www.w3.org/TR/css-scoping-1/</a>
</dd></dl></section></section></body></html>
<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Custom Elements</title>
  <script src="https://www.w3.org/Tools/respec/respec-w3c-common" async="" class="remove">
</script>
  <script src="https://resources.whatwg.org/dfn.js" defer class="remove">
</script>
  <link rel="stylesheet" href="respec-complement.css">
  <script class="remove">
function resolveBacklink() {
      // For dfn.js
      if (window.initDfn) {
          initDfn();
      }
  }
  var respecConfig = {
    shortName: "custom-elements",
    specStatus: "ED",
    useExperimentalStyles: true,
    edDraftURI: "https://w3c.github.io/webcomponents/spec/custom/",
    editors: [{
       name: "Domenic Denicola",
       url: "mailto:d@domenic.me",
       company: "Google, Inc.",
       w3cid: "52873"
    }],
    wg: "Web Platform Working Group",
    wgURI: "https://www.w3.org/WebPlatform/WG/",
    wgPublicList: "public-webapps",
    subjectPrefix: "[custom-elements]",
    postProcess: [resolveBacklink],
    license: "w3c-software-doc",
    otherLinks: [{
      key: 'Repository',
      data: [{
        value: 'We are on Github.',
        href: 'https://github.com/w3c/webcomponents/'
      }, {
        value: 'File a bug.',
        href: 'https://github.com/w3c/webcomponents/labels/custom-elements'
      }, {
        value: 'Commit history.',
        href: 'https://github.com/w3c/webcomponents/commits/gh-pages/spec/custom'
      }]
    },{
      key: 'Mailing list',
      data: [{
        value: 'public-webapps@w3.org',
        href: 'https://lists.w3.org/Archives/Public/public-webapps/'
      }]
    },{
      key: 'Implementation',
      data: [{
        value: 'Can I use Custom Elements?',
        href: 'http://caniuse.com/#feat=custom-elementsv1'
      }, {
        value: 'Test Suite',
        href: 'http://w3c-test.org/custom-elements/'
      }, {
        value: 'Test Suite repository',
        href: 'https://github.com/w3c/web-platform-tests/tree/master/custom-elements'
      }]
    }],
    localBiblio:  {
      'WEBIDL': {
        title: 'Web IDL',
        href: 'https://heycam.github.io/webidl/',
        publisher: 'W3C',
        authors: [
            'Cameron McCormack',
            'Boris Zbarsky'
        ]
      },
      'MATHML': {
        title: 'Mathematical Markup Language (MathML)',
        href: 'https://www.w3.org/Math/draft-spec/',
        publisher: 'W3C',
        authors: [
          'David Carlisle',
          'Patrick Ion',
          'Robert Miner'
        ]
      },
      'SVG': {
        title: 'Scalable Vector Graphics (SVG)',
        href: 'https://www.w3.org/TR/SVG11/',
        authors: [
          'Erik Dahlström',
          'Patrick Dengler',
          'Anthony Grasso',
          'Chris Lilley',
          'Cameron McCormack',
          'Doug Schepers',
          'Jonathan Watt',
          'Jon Ferraiolo',
          '藤沢 淳 (FUJISAWA Jun)',
          'Dean Jackson'
        ]
      }
    },
    wgPatentURI: "https://www.w3.org/2004/01/pp-impl/83482/status"
  };
  </script>
  <style>
div.algorithm {
    padding: 0 0 0 20px;
    border-left: 5px solid #EAF7F9;
  }
  var {
    font-size: 0.8em;
    color: #005A9C;
    font-style: normal;
  }

  .monkeypatch {
    background: #fff9b5;
  }
  </style>
</head>

<body>
  <section id="abstract">
    <p>This specification describes the method for enabling the author to define and use new types of DOM elements in a document. It is a copy of the relevant parts of [[!HTML]] up through commit <a href="https://github.com/whatwg/html/commit/81ee034f316f4366aeb315d16ea21521c83ab427">81ee034f316f4366aeb315d16ea21521c83ab427</a> and [[!WHATWG-DOM]] through commit <a href="https://github.com/whatwg/dom/commit/cb85ac4c35baa1345f2b71e2dd3d57b098ddf2d1">cb85ac4c35baa1345f2b71e2dd3d57b098ddf2d1</a>. Section titles are prefixed with "HTML:" or "DOM:" to indicate which spec they copy from.</p>
  </section>

  <section id="sotd">
    <!-- draft specific information on status goes here -->
  </section>

  <section id="conformance">
    <p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="https://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence">processing equivalence</dfn> is a constraint imposed on the algorithm implementors, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>

    <p>The IDL fragments in this specification must be interpreted as required for conforming IDL fragments, as described in the Web IDL specification [[!WEBIDL]].</p>
  </section>

  <section>
    <h3 id="custom-elements">HTML: Custom elements</h3>

    <section>
      <h4 id="custom-elements-intro">Introduction</h4>

      <p><i>This section is non-normative.</i></p>

      <p><a href="#custom-element">Custom elements</a> provide a way for authors to build their own fully-featured DOM elements. Although authors could always use non-standard elements in their documents, with application-specific behaviour added after the fact by scripting or similar, such elements have historically been non-conforming and not very functional. By <a href="#element-definition">defining</a> a custom element, authors can inform the parser how to properly construct an element and how elements of that class should react to changes.</p>

      <p>Custom elements are part of a larger effort to "rationalise the platform", by explaining existing platform features (like the elements of HTML) in terms of lower-level author-exposed extensibility points (like custom element definition). Although today there are many limitations on the capabilities of custom elements—both functionally and semantically—that prevent them from fully explaining the behaviours of HTML's existing elements, we hope to shrink this gap over time.</p>

      <section>
        <h5 id="custom-elements-autonomous-example">Creating an autonomous custom element</h5>

        <p><i>This section is non-normative.</i></p>

        <p>For the purposes of illustrating how to create an <a href="#autonomous-custom-element">autonomous custom element</a>, let's define a custom element that encapsulates rendering a small icon for a country flag. Our goal is to be able to use it like so:</p>
        <pre>
&lt;flag-icon country="nl"&gt;&lt;/flag-icon&gt;
</pre>

        <p>To do this, we first declare a class for the custom element, extending <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code>:</p>
        <pre>
class FlagIcon extends HTMLElement {
  constructor() {
    super();
    this._countryCode = null;
  }

  static get observedAttributes() { return ["country"]; }

  attributeChangedCallback(name, oldValue, newValue) {
    // name will always be "country" due to observedAttributes
    this._countryCode = newValue;
    this._updateRendering();
  }
  connectedCallback() {
    this._updateRendering();
  }

  get country() {
    return this._countryCode;
  }
  set country(v) {
    this.setAttribute("country", v);
  }

  _updateRendering() {
    // Left as an exercise for the reader. But, you'll probably want to
    // check this.ownerDocument.defaultView to see if we've been
    // inserted into a document with a browsing context, and avoid
    // doing any work if not.
  }
}
</pre>

        <p>We then need to use this class to define the element:</p>
        <pre>
customElements.define("flag-icon", FlagIcon);
</pre>

        <p>At this point, our above code will work! The parser, whenever it sees the <code>flag-icon</code> tag, will construct a new instance of our <code>FlagIcon</code> class, and tell our code about its new <code>country</code> attribute, which we then use to set the element's internal state and update its rendering (when appropriate).</p>

        <p>You can also create <code>flag-icon</code> elements using the DOM API:</p>
        <pre>
const flagIcon = document.createElement("flag-icon")
flagIcon.country = "jp"
document.body.appendChild(flagIcon)
</pre>

        <p>Finally, we can also use the <a href="#custom-element-constructor">custom element constructor</a> itself. That is, the above code is equivalent to:</p>
        <pre>
const flagIcon = new FlagIcon()
flagIcon.country = "jp"
document.body.appendChild(flagIcon)
</pre>
      </section>

      <section>
        <h5 id="custom-elements-customized-builtin-example">Creating a customized built-in element</h5>

        <p><i>This section is non-normative.</i></p>

        <p><a href="#customized-built-in-element">Customized built-in elements</a> are a distinct kind of <a href="#custom-element">custom element</a>, which are defined slightly differently and used very differently compared to <a href="#autonomous-custom-element">autonomous custom elements</a>. They exist to allow reuse of behaviours from the existing elements of HTML, by extending those elements with new custom functionality. This is important since many of the existing behaviours of HTML elements can unfortunately not be duplicated by using purely <a href="#autonomous-custom-element">autonomous custom elements</a>. Instead, <a href="#customized-built-in-element">customized built-in elements</a> allow the installation of custom construction behaviour, lifecycle hooks, and prototype chain onto existing elements, essentially "mixing in" these capabilities on top of the already-existing element.</p>

        <p><a href="#customized-built-in-element">Customized built-in elements</a> require a distinct syntax from <a href="#autonomous-custom-element">autonomous custom elements</a> because user agents and other software key off an element's local name in order to identify the element's semantics and behaviour. That is, the concept of <a href="#customized-built-in-element">customized built-in elements</a> building on top of existing behaviour depends crucially on the extended elements retaining their original local name.</p>

        <p>In this example, we'll be creating a <a href="#customized-built-in-element">customized built-in element</a> named <code>plastic-button</code>, which behaves like a normal button but gets fancy animation effects added whenever you click on it. We start by defining a class, just like before, although this time we extend <code><a href="https://html.spec.whatwg.org/multipage/forms.html#htmlbuttonelement">HTMLButtonElement</a></code> instead of <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code>:</p>
        <pre>
class PlasticButton extends HTMLButtonElement {
  constructor() {
    super();

    this.addEventListener("click", () =&gt; {
      // Draw some fancy animation effects!
    });
  }
}
</pre>

        <p>When defining our custom element, we have to also specify the <code>extends</code> option:</p>
        <pre>
customElements.define("plastic-button", PlasticButton, { extends: "button" });
</pre>

        <p>In general, the name of the element being extended cannot be determined simply by looking at what element interface it extends, as many elements share the same interface (such as <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-q-element">q</a></code> and <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-blockquote-element">blockquote</a></code> both sharing <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#htmlquoteelement">HTMLQuoteElement</a></code>).</p>

        <p>To use our <a href="#customized-built-in-element">customized built-in element</a>, we use the <code><a href="#attr-is">is</a></code> attribute on a <code><a href="https://html.spec.whatwg.org/multipage/forms.html#the-button-element">button</a></code> element:</p>
        <pre>
&lt;button is="plastic-button"&gt;Click Me!&lt;/button&gt;
</pre>

        <p>Trying to use a <a href="#customized-built-in-element">customized built-in element</a> as an <a href="#autonomous-custom-element">autonomous custom element</a> will <em>not</em> work; that is, <code>&lt;plastic-button&gt;Click me?&lt;/plastic-button&gt;</code> will simply create an <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code> with no special behaviour.</p>

        <p>If you need to create a type-extended element programmatically, you can use the following form of <code><a href="https://dom.spec.whatwg.org/#dom-document-createelement">createElement()</a></code>:</p>
        <pre>
const plasticButton = document.createElement("button", { is: "plastic-button" });
plasticButton.textContent = "Click me!";
</pre>

        <p>And as before, the constructor will also work:</p>
        <pre>
const plasticButton2 = new PlasticButton();
console.log(plasticButton2.localName);          // will output "button"
console.log(plasticButton2.getAttribute("is")); // will output "plastic-button"
</pre>

        <p>Notably, all the of the ways in which <code><a href="https://html.spec.whatwg.org/multipage/forms.html#the-button-element">button</a></code> is special apply to such "plastic buttons" as well: their focus behaviour, ability to participate in <a href="https://html.spec.whatwg.org/multipage/forms.html#concept-form-submit">form submission</a>, the <code><a href="https://html.spec.whatwg.org/multipage/forms.html#attr-fe-disabled">disabled</a></code> attribute, and so on.</p>
      </section>

      <section>
        <h5 id="custom-elements-autonomous-drawbacks">Drawbacks of autonomous custom elements</h5>

        <p><i>This section is non-normative.</i></p>

        <p>As specified below, and alluded to above, simply defining and using an element called <code>taco-button</code> does not mean that such elements <a href="https://html.spec.whatwg.org/multipage/dom.html#represents">represent</a> buttons. That is, tools such as Web browsers, search engines, or accessibility technology will not automatically treat the resulting element as a button just based on its defined name.</p>

        <p>To convey the desired button semantics to a variety of users, while still using an <a href="#autonomous-custom-element">autonomous custom element</a>, a number of techniques would need to be employed:</p>

        <ul>
          <li>
            <p>The addition of the <code><a href="https://html.spec.whatwg.org/multipage/interaction.html#attr-tabindex">tabindex</a></code> attribute would make the <code>taco-button</code> <a href="https://html.spec.whatwg.org/multipage/dom.html#interactive-content-2">interactive content</a>, thus making it <a href="https://html.spec.whatwg.org/multipage/interaction.html#focusable-area">focusable</a>. Note that if the <code>taco-button</code> were to become logically disabled, the <code><a href="https://html.spec.whatwg.org/multipage/interaction.html#attr-tabindex">tabindex</a></code> attribute would need to be removed.</p>
          </li>

          <li>
            <p>The addition of various ARIA attributes helps convey semantics to accessibility technology. For example, setting the <code><a href="https://html.spec.whatwg.org/multipage/infrastructure.html#attr-aria-role">role</a></code> attribute to "<code><a href="https://w3c.github.io/aria/aria/aria.html#button">button</a></code>" will convey the semantics that this is a button, enabling users to successfully interact with the control using usual button-like interactions in their accessibility technology. Setting the <code><a href="https://w3c.github.io/aria/aria/aria.html#aria-label">aria-label</a></code> attribute is necessary to give the button an <a href="https://w3c.github.io/aria/aria/aria.html#dfn-accessible-name">accessible name</a>, instead of having accessibility technology traverse its child text nodes and announce them. And setting <code><a href="https://w3c.github.io/aria/aria/aria.html#aria-disabled">aria-disabled</a></code> to "<code>true</code>" when the button is logically disabled conveys to accessibility technology the button's disabled state.</p>
          </li>

          <li>
            <p>The addition of event handlers to handle commonly-expected button behaviours helps convey the semantics of the button to Web browser users. In this case, the most relevant event handler would be one that proxies appropriate <code><a href="https://w3c.github.io/uievents/#event-type-keydown">keydown</a></code> events to become <code><a href="https://w3c.github.io/uievents/#event-type-click">click</a></code> events, so that you can activate the button both with keyboard and by clicking.</p>
          </li>

          <li>
            <p>In addition to any default visual styling provided for <code>taco-button</code> elements, the visual styling will also need to be updated to reflect changes in logical state, such as becoming disabled; that is, whatever stylesheet has rules for <code>taco-button</code> will also need to have rules for <code>taco-button[disabled]</code>.</p>
          </li>
        </ul>

        <p>With these points in mind, a full-featured <code>taco-button</code> that took on the responsibility of conveying button semantics (including the ability to be disabled) might look something like this:</p>
        <pre>
class TacoButton extends HTMLElement {
  static get observedAttributes() { return ["disabled"]; }

  constructor() {
    super();

    this.addEventListener("keydown", e =&gt; {
      if (e.keyCode === 32 || e.keyCode === 13) {
        this.dispatchEvent(new MouseEvent("click", {
          bubbles: true,
          cancelable: true
        }));
      }
    });

    this.addEventListener("click", e =&gt; {
      if (this.disabled) {
        e.preventDefault();
        e.stopPropagation();
      }
    });

    this._observer = new MutationObserver(() =&gt; {
      this.setAttribute("aria-label", this.textContent);
    });
  }

  connectedCallback() {
    this.setAttribute("role", "button");
    this.setAttribute("tabindex", "0");

    this._observer.observe(this, {
      childList: true,
      characterData: true,
      subtree: true
    });
  }

  disconnectedCallback() {
    this._observer.disconnect();
  }

  get disabled() {
    return this.hasAttribute("disabled");
  }

  set disabled(v) {
    if (v) {
      this.setAttribute("disabled", "");
    } else {
      this.removeAttribute("disabled");
    }
  }

  attributeChangedCallback() {
    // only is called for the disabled attribute due to observedAttributes
    if (this.disabled) {
      this.removeAttribute("tabindex");
      this.setAttribute("aria-disabled", "true");
    } else {
      this.setAttribute("tabindex", "0");
      this.setAttribute("aria-disabled", "false");
    }
  }
}
</pre>

        <p>Even with this rather-complicated element definition, the element is not a pleasure to use for consumers: it will be continually "sprouting" <code><a href="https://html.spec.whatwg.org/multipage/interaction.html#attr-tabindex">tabindex</a></code> and <code><a href="https://html.spec.whatwg.org/multipage/infrastructure.html#attr-aria-*">aria-*</a></code> attributes of its own volition. This is because as of now there is no way to specify default accessibility semantics or focus behaviour for custom elements, forcing the use of these attributes to do so (even though they are usually reserved for allowing the consumer to override default behaviour).</p>

        <p>In contrast, a simple <a href="#customized-built-in-element">customized built-in element</a>, as shown in the previous section, would automatically inherit the semantics and behaviour of the <code><a href="https://html.spec.whatwg.org/multipage/forms.html#the-button-element">button</a></code> element, with no need to implement these behaviours manually. In general, for any elements with nontrivial behaviour and semantics that build on top of existing elements of HTML, <a href="#customized-built-in-element">customized built-in elements</a> will be easier to develop, maintain, and consume.</p>
      </section>

      <section>
        <h5 id="custom-elements-upgrades-examples">Upgrading elements after their creation</h5>

        <p><i>This section is non-normative.</i></p>

        <p>Because <a href="#element-definition">element definition</a> can occur at any time, a non-custom element could be <a href="#concept-create-element">created</a>, and then later become a <a href="#custom-element">custom element</a> after an appropriate <a href="#custom-element-definition">definition</a> is registered. We call this process "upgrading" the element, from a normal element into a custom element.</p>

        <p><a href="#upgrades">Upgrades</a> enable scenarios where it may be preferable for <a href="#custom-element-definition">custom element definitions</a> to be registered after relevant elements has been initially created, such as by the parser. They allow progressive enhancement of the content in the custom element. For example, in the following HTML document the element definition for <code>img-viewer</code> is loaded asynchronously:</p>
        <pre>
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;title&gt;Image viewer example&lt;/title&gt;

&lt;img-viewer filter="Kelvin"&gt;
  &lt;img src="images/tree.jpg" alt="A beautiful tree towering over an empty savannah"&gt;
&lt;/img-viewer&gt;

&lt;script src="js/elements/img-viewer.js" async&gt;&lt;/script&gt;
</pre>

        <p>The definition for the <code>img-viewer</code> element here is loaded using a <code><a href="https://html.spec.whatwg.org/multipage/#the-script-element">script</a></code> element marked with the <code><a href="https://html.spec.whatwg.org/multipage/#attr-script-async">async</a></code> attribute, placed after the <code>&lt;img-viewer&gt;</code> tag in the markup. While the script is loading, the <code>img-viewer</code> element will be treated as an undefined element, similar to a <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-span-element">span</a></code>. Once the script loads, it will define the <code>img-viewer</code> element, and the existing <code>img-viewer</code> element on the page will be upgraded, applying the custom element's definition (which presumably includes applying an image filter identified by the string "Kelvin", enhancing the image's visual appearance).</p>
        <hr>

        <p>Note that <a href="#upgrades">upgrades</a> only apply to elements in the document tree. (Formally, elements that are <a href="https://dom.spec.whatwg.org/#connected">connected</a>.) An element that is not inserted into a document will stay un-upgraded. An example illustrates this point:</p>
        <pre>
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;title&gt;Upgrade edge-cases example&lt;/title&gt;

&lt;example-element&gt;&lt;/example-element&gt;

&lt;script&gt;
  "use strict";

  const inDocument = document.querySelector("example-element");
  const outOfDocument = document.createElement("example-element");

  // Before the element definition, both are HTMLElement:
  console.assert(inDocument instanceof HTMLElement);
  console.assert(outOfDocument instanceof HTMLElement);

  class ExampleElement extends HTMLElement {}
  customElements.define("example-element", ExampleElement);

  // After element definition, the in-document element was upgraded:
  console.assert(inDocument instanceof ExampleElement);
  console.assert(!(outOfDocument instanceof ExampleElement));

  document.body.appendChild(outOfDocument);

  // Now that we've moved the element into the document, it too was upgraded:
  console.assert(outOfDocument instanceof ExampleElement);
&lt;/script&gt;
</pre>
      </section>
    </section>

    <section>
      <h4 id="custom-element-conformance">Requirements for custom element constructors</h4>

      <p>When authoring <a href="#custom-element-constructor">custom element constructors</a>, authors are bound by the following conformance requirements:</p>

      <ul>
        <li>
          <p>A parameter-less call to <code>super()</code> must be the first statement in the constructor body, to establish the correct prototype chain and <b>this</b> value before any further code is run.</p>
        </li>

        <li>
          <p>A <code>return</code> statement must not appear anywhere inside the constructor body, unless it is a simple early-return (<code>return</code> or <code>return this</code>).</p>
        </li>

        <li>
          <p>The constructor must not use the <code><a href="https://html.spec.whatwg.org/multipage/webappapis.html#dom-document-write">document.write()</a></code> or <code><a href="https://html.spec.whatwg.org/multipage/webappapis.html#dom-document-open">document.open()</a></code> methods.</p>
        </li>

        <li>
          <p>The element's attributes and children must not be inspected, as in the non-<a href="#upgrades">upgrade</a> case none will be present, and relying on upgrades makes the element less usable.</p>
        </li>

        <li>
          <p>The element must not gain any attributes or children, as this violates the expectations of consumers who use the <code><a href="https://dom.spec.whatwg.org/#dom-document-createelement">createElement</a></code> or <code><a href="https://dom.spec.whatwg.org/#dom-document-createelementns">createElementNS</a></code> methods.</p>
        </li>

        <li>
          <p>In general, work should be deferred to <code>connectedCallback</code> as much as possible—especially work involving fetching resources or rendering. However, note that <code>connectedCallback</code> can be called more than once, so any initialization work that is truly one-time will need a guard to prevent it from running twice.</p>
        </li>

        <li>
          <p>In general, the constructor should be used to set up initial state and default values, and to set up event listeners and possibly a <a href="https://dom.spec.whatwg.org/#concept-shadow-root">shadow root</a>.</p>
        </li>
      </ul>

      <p>Several of these requirements are checked during <a href="#concept-create-element">element creation</a>, either directly or indirectly, and failing to follow them will result in a custom element that cannot be instantiated by the parser or DOM APIs.</p>
    </section>

    <section>
      <h4 id="custom-elements-core-concepts">Core concepts</h4>

      <p>A <dfn id="custom-element">custom element</dfn> is an element that is <a href="#concept-element-custom">custom</a>. Informally, this means that its constructor and prototype are defined by the author, instead of by the user agent. This author-supplied constructor function is called the <dfn id="custom-element-constructor">custom element constructor</dfn>.</p>

      <p>Two distinct types of <a href="#custom-element">custom elements</a> can be defined:</p>

      <ol>
        <li>
          <p>An <dfn id="autonomous-custom-element">autonomous custom element</dfn>, which is defined with no <code>extends</code> option. These types of custom elements have a local name equal to their <a href="#concept-custom-element-definition-name">defined name</a>.</p>
        </li>

        <li>
          <p>A <dfn id="customized-built-in-element">customized built-in element</dfn>, which is defined with an <code>extends</code> option. These types of custom elements have local name equal to the value passed in their <code>extends</code> option, and their <a href="#concept-custom-element-definition-name">defined name</a> is used as the value of the <dfn id="attr-is"><code>is</code></dfn> attribute.</p>
        </li>
      </ol>

      <p>After a <a href="#custom-element">custom element</a> is <a href="#concept-create-element">created</a>, changing the value of the <code><a href="#attr-is">is</a></code> attribute does not change the element's behaviour, as it is saved on the element as its <a href="#concept-element-is-value"><code>is</code> value</a>.</p>

      <p><a href="#autonomous-custom-element">Autonomous custom elements</a> have the following element definition:</p>

      <dl class="element">
        <dt>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#concept-element-categories">Categories</a>:
        </dt>

        <dd>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#flow-content-2">Flow content</a>.
        </dd>

        <dd>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#phrasing-content-2">Phrasing content</a>.
        </dd>

        <dd>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#palpable-content-2">Palpable content</a>.
        </dd>

        <dt>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#concept-element-contexts">Contexts in which this element can be used</a>:
        </dt>

        <dd>
          Where <a href="https://html.spec.whatwg.org/multipage/dom.html#phrasing-content-2">phrasing content</a> is expected.
        </dd>

        <dt>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#concept-element-content-model">Content model</a>:
        </dt>

        <dd>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#transparent">Transparent</a>.
        </dd>

        <dt>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#concept-element-attributes">Content attributes</a>:
        </dt>

        <dd>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#global-attributes">Global attributes</a>, except the <code><a href="#attr-is">is</a></code> attribute
        </dd>

        <dd>Any other attribute that has no namespace (see prose).</dd>

        <dt>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#concept-element-dom">DOM interface</a>:
        </dt>

        <dd>Supplied by the element's author (inherits from <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code>)</dd>
      </dl>

      <p>An <a href="#autonomous-custom-element">autonomous custom element</a> does not have any special meaning: it <a href="https://html.spec.whatwg.org/multipage/dom.html#represents">represents</a> its children. A <a href="#customized-built-in-element">customized built-in element</a> inherits the semantics of the element that it extends.</p>

      <p>Any namespace-less attribute that is relevant to the element's functioning, as determined by the element's author, may be specified on an <a href="#autonomous-custom-element">autonomous custom element</a>, so long as the attribute name is <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#xml-compatible">XML-compatible</a> and contains no <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#uppercase-ascii-letters">uppercase ASCII letters</a>. The exception is the <code><a href="#attr-is">is</a></code> attribute, which must not be specified on an <a href="#autonomous-custom-element">autonomous custom element</a> (and which will have no effect if it is).</p>

      <p><a href="#customized-built-in-element">Customized built-in elements</a> follow the normal requirements for attributes, based on the elements they extend. To add custom attribute-based behavior, use <code><a href="https://html.spec.whatwg.org/multipage/dom.html#attr-data-*">data-*</a></code> attributes.</p>
      <hr>

      <p>A <dfn id="valid-custom-element-name">valid custom element name</dfn> is a sequence of characters <var>name</var> that meets all of the following requirements:</p>

      <ul>
        <li>
          <p><var>name</var> must match the <code><a href="#prod-potentialcustomelementname">PotentialCustomElementName</a></code> production:</p>

          <dl>
            <dt><code><dfn id="prod-potentialcustomelementname">PotentialCustomElementName</dfn> ::=</code></dt>

            <dd><code>[a-z] (<a href="#prod-pcenchar">PCENChar</a>)* '-' (<a href="#prod-pcenchar">PCENChar</a>)*</code></dd>

            <dt><code><dfn id="prod-pcenchar">PCENChar</dfn> ::=</code></dt>

            <dd><code>"-" | "." | [0-9] | "_" | [a-z] | #xB7 | [#xC0-#xD6] | [#xD8-#xF6] | [#xF8-#x37D] | [#x37F-#x1FFF] | [#x200C-#x200D] | [#x203F-#x2040] | [#x2070-#x218F] | [#x2C00-#x2FEF] | [#x3001-#xD7FF] | [#xF900-#xFDCF] | [#xFDF0-#xFFFD] | [#x10000-#xEFFFF]</code></dd>
          </dl>

          <p>This uses the <a href="https://www.w3.org/TR/xml/#sec-notation">EBNF notation</a> from the <cite>XML</cite> specification. [[!XML]]</p>
        </li>

        <li>
          <p><var>name</var> must not be any of the following:</p>

          <ul class="brief">
            <li><code>annotation-xml</code></li>

            <li><code>color-profile</code></li>

            <li><code>font-face</code></li>

            <li><code>font-face-src</code></li>

            <li><code>font-face-uri</code></li>

            <li><code>font-face-format</code></li>

            <li><code>font-face-name</code></li>

            <li><code>missing-glyph</code></li>
          </ul>

          <p class="note">The list of names above is the summary of all hyphen-containing element names from the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#other-applicable-specifications">applicable specifications</a>, namely <cite>SVG</cite> and <cite>MathML</cite>. [[SVG]] [[MATHML]]</p>
        </li>
      </ul>

      <div class="note">
        <p>These requirements ensure a number of goals for <a href="#valid-custom-element-name">valid custom element names</a>:</p>

        <ul>
          <li>
            <p>They start with a <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#lowercase-ascii-letters">lowercase ASCII letter</a>, ensuring that the HTML parser will treat them as tags instead of as text.</p>
          </li>

          <li>
            <p>They do not contain any <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#uppercase-ascii-letters">uppercase ASCII letters</a>, ensuring that the user agent can always treat HTML elements ASCII-case-insensitively.</p>
          </li>

          <li>
            <p>They contain a hyphen, used for namespacing and to ensure forward compatibility (since no elements will be added to HTML, SVG, or MathML with hyphen-containing local names in the future).</p>
          </li>

          <li>
            <p>They can always be created with <code><a href="https://dom.spec.whatwg.org/#dom-document-createelement">createElement()</a></code> and <code><a href="https://dom.spec.whatwg.org/#dom-document-createelementns">createElementNS()</a></code>, which have restrictions that go beyond the parser's.</p>
          </li>
        </ul>

        <p>Apart from these restrictions, a large variety of names is allowed, to give maximum flexibility for use cases like <code>&lt;math-α&gt;</code> or <code>&lt;emotion-😍&gt;</code>.</p>
      </div>

      <p>A <dfn id="custom-element-definition">custom element definition</dfn> describes a <a href="#custom-element">custom element</a> and consists of:</p>

      <dl>
        <dt>A <dfn id="concept-custom-element-definition-name">name</dfn></dt>

        <dd>
          A <a href="#valid-custom-element-name">valid custom element name</a>
        </dd>

        <dt>A <dfn id="concept-custom-element-definition-local-name">local name</dfn></dt>

        <dd>A local name</dd>

        <dt>A <dfn id="concept-custom-element-definition-constructor">constructor</dfn></dt>

        <dd>
          A <a href="#custom-element-constructor">custom element constructor</a>
        </dd>

        <dt>A <dfn id="concept-custom-element-definition-prototype">prototype</dfn></dt>

        <dd>A JavaScript object</dd>

        <dt>A list of <dfn id="concept-custom-element-definition-observed-attributes">observed attributes</dfn></dt>

        <dd>A <code>sequence&lt;DOMString&gt;</code></dd>

        <dt>A collection of <dfn id="concept-custom-element-definition-lifecycle-callbacks">lifecycle callbacks</dfn></dt>

        <dd>A map, whose four keys are the strings "<code>connectedCallback</code>", "<code>disconnectedCallback</code>", "<code>adoptedCallback</code>", and "<code>attributeChangedCallback</code>". The corresponding values are either a Web IDL <code><a href="https://heycam.github.io/webidl/#common-Function">Function</a></code> callback function type value, or null. By default the value of each entry is null.</dd>

        <dt>A <dfn id="concept-custom-element-definition-construction-stack">construction stack</dfn></dt>

        <dd>
          A list, initially empty, that is manipulated by the <a href="#concept-upgrade-an-element">upgrade an element</a> algorithm and the <a href="#html-element-constructors">HTML element constructors</a>. Each entry in the list will be either an element or an <dfn id="concept-already-constructed-marker"><i>already constructed</i> marker</dfn>.
        </dd>
      </dl>

      <p>To <dfn id="look-up-a-custom-element-definition">look up a custom element definition</dfn>, given a <var>document</var>, <var>namespace</var>, <var>localName</var>, and <var>is</var>, perform the following steps. They will return either a <a href="#custom-element-definition">custom element definition</a> or null:</p>

      <ol>
        <li>
          <p>If <var>namespace</var> is not the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#html-namespace-2">HTML namespace</a>, return null.</p>
        </li>

        <li>
          <p>If <var>document</var> does not have a <a href="https://html.spec.whatwg.org/multipage/browsers.html#concept-document-bc">browsing context</a>, return null.</p>
        </li>

        <li>
          <p>Let <var>registry</var> be <var>document</var>'s <a href="https://html.spec.whatwg.org/multipage/browsers.html#concept-document-bc">browsing context</a>'s <code><a href="https://html.spec.whatwg.org/multipage/browsers.html#window">Window</a></code>'s <code><a href="#customelementregistry">CustomElementRegistry</a></code> object.</p>
        </li>

        <li>
          <p>If there is <a href="#custom-element-definition">custom element definition</a> in <var>registry</var> with <a href="#concept-custom-element-definition-name">name</a> and <a href="#concept-custom-element-definition-local-name">local name</a> both equal to <var>localName</var>, return that <a href="#custom-element-definition">custom element definition</a>.</p>
        </li>

        <li>
          <p>If there is a <a href="#custom-element-definition">custom element definition</a> in <var>registry</var> with <a href="#concept-custom-element-definition-name">name</a> equal to <var>is</var> and <a href="#concept-custom-element-definition-local-name">local name</a> equal to <var>localName</var>, return that <a href="#custom-element-definition">custom element definition</a>.</p>
        </li>

        <li>
          <p>Return null.</p>
        </li>
      </ol>
    </section>

    <section>
      <h4 id="custom-elements-api">The CustomElementRegistry interface</h4>

      <p>Each <code><a href="https://html.spec.whatwg.org/multipage/browsers.html#window">Window</a></code> object is associated with a unique instance of a <code><a href="#customelementregistry">CustomElementRegistry</a></code> object, allocated when the <code><a href="https://html.spec.whatwg.org/multipage/browsers.html#window">Window</a></code> object is created.</p>

      <p class="note">Custom element registries are associated with <code><a href="https://html.spec.whatwg.org/multipage/browsers.html#window">Window</a></code> objects, instead of <code><a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a></code> objects, since each <a href="#custom-element-constructor">custom element constructor</a> inherits from the <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code> interface, and there is exactly one <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code> interface per <code><a href="https://html.spec.whatwg.org/multipage/browsers.html#window">Window</a></code> object.</p>

      <p>The <dfn id="dom-window-customelements"><code>customElements</code></dfn> attribute of the <code><a href="https://html.spec.whatwg.org/multipage/browsers.html#window">Window</a></code> interface must return the <code><a href="#customelementregistry">CustomElementRegistry</a></code> object for that <code><a href="https://html.spec.whatwg.org/multipage/browsers.html#window">Window</a></code> object.</p>
      <pre class="idl">
interface <dfn id="customelementregistry">CustomElementRegistry</dfn> {
  [<a href="#cereactions">CEReactions</a>] void <a href="#dom-customelementregistry-define">define</a>(DOMString name, Function constructor, optional ElementDefinitionOptions options);
  any <a href="#dom-customelementregistry-get">get</a>(DOMString name);
  Promise&lt;void&gt; <a href="#dom-customelementregistry-whendefined">whenDefined</a>(DOMString name);
};

dictionary <dfn id="elementdefinitionoptions">ElementDefinitionOptions</dfn> {
  DOMString extends;
};
</pre>

      <p>Every <code><a href="#customelementregistry">CustomElementRegistry</a></code> has a set of <a href="#custom-element-definition">custom element definitions</a>, initially empty. In general, algorithms in this specification look up elements in the registry by any of <a href="#concept-custom-element-definition-name">name</a>, <a href="#concept-custom-element-definition-local-name">local name</a>, or <a href="#concept-custom-element-definition-constructor">constructor</a>.</p>

      <p>Every <code><a href="#customelementregistry">CustomElementRegistry</a></code> also has an <dfn id="element-definition-is-running">element definition is running</dfn> flag which is used to prevent reentrant invocations of <a href="#element-definition">element definition</a>. It is initially unset.</p>

      <p>Every <code><a href="#customelementregistry">CustomElementRegistry</a></code> also has a <dfn id="when-defined-promise-map">when-defined promise map</dfn>, mapping <a href="#valid-custom-element-name">valid custom element names</a> to promises. It is used to implement the <code><a href="#dom-customelementregistry-whendefined">whenDefined()</a></code> method.</p>

      <dl class="domintro note">
        <dt><var>window</var> . <code><a href="#dom-window-customelements">customElements</a></code> . <code><a href="#dom-customelementregistry-define">define</a></code>(<var>name</var>, <var>constructor</var>)</dt>

        <dd>
          Defines a new <a href="#custom-element">custom element</a>, mapping the given name to the given constructor as an <a href="#autonomous-custom-element">autonomous custom element</a>.
        </dd>

        <dt><var>window</var> . <code><a href="#dom-window-customelements">customElements</a></code> . <code><a href="#dom-customelementregistry-define">define</a></code>(<var>name</var>, <var>constructor</var>, { extends: <var>baseLocalName</var> })</dt>

        <dd>
          Defines a new <a href="#custom-element">custom element</a>, mapping the given name to the given constructor as a <a href="#customized-built-in-element">customized built-in element</a> for the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#element-type">element type</a> identified by the supplied <var>baseLocalName</var>. A <a href="https://heycam.github.io/webidl/#notsupportederror">"<code>NotSupportedError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> will be thrown upon trying to extend a <a href="#custom-element">custom element</a> or an unknown element.
        </dd>

        <dt><var>window</var> . <code><a href="#dom-window-customelements">customElements</a></code> . <code><a href="#dom-customelementregistry-get">get</a></code>(<var>name</var>)</dt>

        <dd>
          Retrieves the <a href="#custom-element-constructor">custom element constructor</a> defined for the given <a href="#concept-custom-element-definition-name">name</a>. Returns undefined if there is no <a href="#custom-element-definition">custom element definition</a> with the given <a href="#concept-custom-element-definition-name">name</a>.
        </dd>

        <dt><var>window</var> . <code><a href="#dom-window-customelements">customElements</a></code> . <code><a href="#dom-customelementregistry-whendefined">whenDefined</a></code>(<var>name</var>)</dt>

        <dd>
          Returns a promise that will be fulfilled when a <a href="#custom-element">custom element</a> becomes defined with the given name. (If such a <a href="#custom-element">custom element</a> is already defined, the returned promise will be immediately fulfilled.) Returns a promise rejected with a <a href="https://heycam.github.io/webidl/#syntaxerror">"<code>SyntaxError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> if not given a <a href="#valid-custom-element-name">valid custom element name</a>.
        </dd>
      </dl>

      <p><dfn id="element-definition">Element definition</dfn> is a process of adding a <a href="#custom-element-definition">custom element definition</a> to the <code><a href="#customelementregistry">CustomElementRegistry</a></code>. This is accomplished by the <code><a href="#dom-customelementregistry-define">define()</a></code> method. When invoked, the <dfn id="dom-customelementregistry-define"><code>define(<var>name</var>, <var>constructor</var>, <var>options</var>)</code></dfn> method must run these steps:</p>

      <ol>
        <li>
          <p>If <a href="https://tc39.github.io/ecma262/#sec-isconstructor">IsConstructor</a>(<var>constructor</var>) is false, then throw a <code><a href="https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-typeerror">TypeError</a></code> and abort these steps.</p>
        </li>

        <li>
          <p>If <var>name</var> is not a <a href="#valid-custom-element-name">valid custom element name</a>, then throw a <a href="https://heycam.github.io/webidl/#syntaxerror">"<code>SyntaxError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> and abort these steps.</p>
        </li>

        <li>
          <p>If this <code><a href="#customelementregistry">CustomElementRegistry</a></code> contains an entry with <a href="#concept-custom-element-definition-name">name</a> <var>name</var>, then throw a <a href="https://heycam.github.io/webidl/#notsupportederror">"<code>NotSupportedError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> and abort these steps.</p>
        </li>

        <li>
          <p>If this <code><a href="#customelementregistry">CustomElementRegistry</a></code> contains an entry with <a href="#concept-custom-element-definition-constructor">constructor</a> <var>constructor</var>, then throw a <a href="https://heycam.github.io/webidl/#notsupportederror">"<code>NotSupportedError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> and abort these steps.</p>
        </li>

        <li>
          <p>Let <var>localName</var> be <var>name</var>.</p>
        </li>

        <li>
          <p>Let <var>extends</var> be the value of the <code>extends</code> member of <var>options</var>, or null if no such member exists.</p>
        </li>

        <li>
          <p>If <var>extends</var> is not null, then:</p>

          <ol>
            <li>
              <p>If <var>extends</var> is a <a href="#valid-custom-element-name">valid custom element name</a>, then throw a <a href="https://heycam.github.io/webidl/#notsupportederror">"<code>NotSupportedError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code>.</p>
            </li>

            <li>
              <p>If the <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> for <var>extends</var> and the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#html-namespace-2">HTML namespace</a> is <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlunknownelement">HTMLUnknownElement</a></code> (e.g., if <var>extends</var> does not indicate an element definition in this specification), then throw a <a href="https://heycam.github.io/webidl/#notsupportederror">"<code>NotSupportedError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code>.</p>
            </li>

            <li>
              <p>Set <var>localName</var> to <var>extends</var>.</p>
            </li>
          </ol>
        </li>

        <li>
          <p>If this <code><a href="#customelementregistry">CustomElementRegistry</a></code>'s <a href="#element-definition-is-running">element definition is running</a> flag is set, then throw a <a href="https://heycam.github.io/webidl/#notsupportederror">"<code>NotSupportedError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> and abort these steps.</p>
        </li>

        <li>
          <p>Set this <code><a href="#customelementregistry">CustomElementRegistry</a></code>'s <a href="#element-definition-is-running">element definition is running</a> flag.</p>
        </li>

        <li>
          <p>Run the following substeps while catching any exceptions:</p>

          <ol>
            <li>
              <p>Let <var>prototype</var> be <a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a>(<var>constructor</var>, "prototype"). Rethrow any exceptions.</p>
            </li>

            <li>
              <p>If <a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a>(<var>prototype</var>) is not Object, then throw a <code><a href="https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-typeerror">TypeError</a></code> exception.</p>
            </li>

            <li>
              <p>Let <var>lifecycleCallbacks</var> be a map with the four keys "<code>connectedCallback</code>", "<code>disconnectedCallback</code>", "<code>adoptedCallback</code>", and "<code>attributeChangedCallback</code>", each of which belongs to an entry whose value is null.</p>
            </li>

            <li>
              <p>For each of the four keys <var>callbackName</var> in <var>lifecycleCallbacks</var>, in the order listed in the previous step:</p>

              <ol>
                <li>
                  <p>Let <var>callbackValue</var> be <a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a>(<var>prototype</var>, <var>callbackName</var>). Rethrow any exceptions.</p>
                </li>

                <li>
                  <p>If <var>callbackValue</var> is not undefined, then set the value of the entry in <var>lifecycleCallbacks</var> with key <var>callbackName</var> to the result of <a href="https://heycam.github.io/webidl/#es-type-mapping">converting</a> <var>callbackValue</var> to the Web IDL <code><a href="https://heycam.github.io/webidl/#common-Function">Function</a></code> callback type. Rethrow any exceptions from the conversion.</p>
                </li>
              </ol>
            </li>

            <li>
              <p>Let <var>observedAttributes</var> be an empty <code>sequence&lt;DOMString&gt;</code>.</p>
            </li>

            <li>
              <p>If the value of the entry in <var>lifecycleCallbacks</var> with key "<code>attributeChangedCallback</code>" is not null, then:</p>

              <ol>
                <li>
                  <p>Let <var>observedAttributesIterable</var> be <a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a>(<var>constructor</var>, "observedAttributes"). Rethrow any exceptions.</p>
                </li>

                <li>
                  <p>If <var>observedAttributesIterable</var> is not undefined, then set <var>observedAttributes</var> to the result of <a href="https://heycam.github.io/webidl/#es-type-mapping">converting</a> <var>observedAttributesIterable</var> to a <code>sequence&lt;DOMString&gt;</code>. Rethrow any exceptions from the conversion.</p>
                </li>
              </ol>
            </li>
          </ol>

          <p>Then, perform the following substep, regardless of whether the above steps threw an exception or not:</p>

          <ol>
            <li>
              <p>Unset this <code><a href="#customelementregistry">CustomElementRegistry</a></code>'s <a href="#element-definition-is-running">element definition is running</a> flag.</p>
            </li>
          </ol>

          <p>Finally, if the first set of substeps threw an exception, then rethrow that exception, and terminate this algorithm. Otherwise, continue onward.</p>
        </li>

        <li>
          <p>Let <var>definition</var> be a new <a href="#custom-element-definition">custom element definition</a> with <a href="#concept-custom-element-definition-name">name</a> <var>name</var>, <a href="#concept-custom-element-definition-local-name">local name</a> <var>localName</var>, <a href="#concept-custom-element-definition-constructor">constructor</a> <var>constructor</var>, <a href="#concept-custom-element-definition-prototype">prototype</a> <var>prototype</var>, <a href="#concept-custom-element-definition-observed-attributes">observed attributes</a> <var>observedAttributes</var>, and <a href="#concept-custom-element-definition-lifecycle-callbacks">lifecycle callbacks</a> <var>lifecycleCallbacks</var>.</p>
        </li>

        <li>
          <p>Add <var>definition</var> to this <code><a href="#customelementregistry">CustomElementRegistry</a></code>.</p>
        </li>

        <li>
          <p>Let <var>document</var> be this <code><a href="#customelementregistry">CustomElementRegistry</a></code>'s <a href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global">relevant global object</a>'s <a href="https://html.spec.whatwg.org/multipage/browsers.html#concept-document-window">associated <code>Document</code></a>.</p>
        </li>

        <li>
          <p>Let <var>upgrade candidates</var> be all elements that are <a href="https://dom.spec.whatwg.org/#concept-shadow-including-descendant">shadow-including descendants</a> of <var>document</var>, whose namespace is the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#html-namespace-2">HTML namespace</a> and whose local name is <var>localName</var>, in <a href="https://dom.spec.whatwg.org/#concept-shadow-including-tree-order">shadow-including tree order</a>. Additionally, if <var>extends</var> is non-null, only include elements whose <a href="#concept-element-is-value"><code>is</code> value</a> is equal to <var>name</var>.</p>
        </li>

        <li>
          <p>For each element <var>element</var> in <var>upgrade candidates</var>, <a href="#enqueue-a-custom-element-upgrade-reaction">enqueue a custom element upgrade reaction</a> given <var>element</var> and <var>definition</var>.</p>
        </li>

        <li>
          <p>If this <code><a href="#customelementregistry">CustomElementRegistry</a></code>'s <a href="#when-defined-promise-map">when-defined promise map</a> contains an entry with key <var>name</var>:</p>

          <ol>
            <li>
              <p>Let <var>promise</var> be the value of that entry.</p>
            </li>

            <li>
              <p>Resolve <var>promise</var> with undefined.</p>
            </li>

            <li>
              <p>Delete the entry with key <var>name</var> from this <code><a href="#customelementregistry">CustomElementRegistry</a></code>'s <a href="#when-defined-promise-map">when-defined promise map</a>.</p>
            </li>
          </ol>
        </li>
      </ol>

      <p>When invoked, the <dfn id="dom-customelementregistry-get"><code>get(<var>name</var>)</code></dfn> method must run these steps:</p>

      <ol>
        <li>
          <p>If this <code><a href="#customelementregistry">CustomElementRegistry</a></code> contains an entry with <a href="#concept-custom-element-definition-name">name</a> <var>name</var>, then return that entry's <a href="#concept-custom-element-definition-constructor">constructor</a>.</p>
        </li>

        <li>
          <p>Otherwise, return undefined.</p>
        </li>
      </ol>

      <p>When invoked, the <dfn id="dom-customelementregistry-whendefined"><code>whenDefined(<var>name</var>)</code></dfn> method must run these steps:</p>

      <ol>
        <li>
          <p>If <var>name</var> is not a <a href="#valid-custom-element-name">valid custom element name</a>, then return a new promise rejected with a <a href="https://heycam.github.io/webidl/#syntaxerror">"<code>SyntaxError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> and abort these steps.</p>
        </li>

        <li>
          <p>If this <code><a href="#customelementregistry">CustomElementRegistry</a></code> contains an entry with <a href="#concept-custom-element-definition-name">name</a> <var>name</var>, then return a new promise resolved with undefined and abort these steps.</p>
        </li>

        <li>
          <p>Let <var>map</var> be this <code><a href="#customelementregistry">CustomElementRegistry</a></code>'s <a href="#when-defined-promise-map">when-defined promise map</a>.</p>
        </li>

        <li>
          <p>If <var>map</var> does not contain an entry with key <var>name</var>, create an entry in <var>map</var> with key <var>name</var> and whose value is a new promise.</p>
        </li>

        <li>
          <p>Let <var>promise</var> be the value of the entry in <var>map</var> with key <var>name</var>.</p>
        </li>

        <li>
          <p>Return <var>promise</var>.</p>
        </li>
      </ol>

      <div class="example">
        <p>The <code><a href="#dom-customelementregistry-whendefined">whenDefined()</a></code> method can be used to avoid performing an action until all appropriate <a href="#custom-element">custom elements</a> are <a href="#concept-element-defined">defined</a>. In this example, we combine it with the <code><a href="#selector-defined">:defined</a></code> pseudo-class to hide a dynamically-loaded article's contents until we're sure that all of the <a href="#autonomous-custom-element">autonomous custom elements</a> it uses are defined.</p>
        <pre>
articleContainer.hidden = true;

fetch(articleURL)
  .then(response =&gt; response.text())
  .then(text =&gt; {
    articleContainer.innerHTML = text;

    return Promise.all(
      [...articleContainer.querySelectorAll(":not(:defined)")]
        .map(el =&gt; customElements.whenDefined(el.localName))
    );
  })
  .then(() =&gt; {
    articleContainer.hidden = false;
  });
</pre>
      </div>
    </section>

    <section>
      <h4 id="upgrades">Upgrades</h4>

      <p>To <dfn id="concept-upgrade-an-element">upgrade an element</dfn>, given as input a <a href="#custom-element-definition">custom element definition</a> <var>definition</var> and an element <var>element</var>, run the following steps:</p>

      <ol>
        <li>
          <p>If <var>element</var> is <a href="#concept-element-custom">custom</a>, abort these steps.</p>

          <div class="example">
            <p>This can occur due to reentrant invocation of this algorithm, as in the following example:</p>
            <pre>
&lt;!DOCTYPE html&gt;
&lt;x-foo id="a"&gt;&lt;/x-foo&gt;
&lt;x-foo id="b"&gt;&lt;/x-foo&gt;

&lt;script&gt;
// Defining enqueues upgrade reactions for both "a" and "b"
customElements.define("x-foo", class extends HTMLElement {
  constructor() {
    super();

    const b = document.querySelector("#b");
    b.remove();

    // While this constructor is running for "a", "b" is still
    // undefined, and so inserting it into the document will enqueue a
    // second upgrade reaction for "b" in addition to the one enqueued
    // by defining x-foo.
    document.body.appendChild(b);
  }
})
&lt;/script&gt;
</pre>

            <p>This step will thus bail out the algorithm early when <a href="#concept-upgrade-an-element">upgrade an element</a> is invoked with "<code>b</code>" a second time.</p>
          </div>
        </li>

        <li>
          <p>If <var>element</var>'s <a href="#concept-element-custom-element-state">custom element state</a> is "<code>failed</code>", then abort these steps.</p>
        </li>

        <li>
          <p>For each <var>attribute</var> in <var>element</var>'s <a href="https://dom.spec.whatwg.org/#concept-element-attribute">attribute list</a>, in order, <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>attribute</var>'s local name, null, <var>attribute</var>'s value, and <var>attribute</var>'s namespace.</p>
        </li>

        <li>
          <p>If <var>element</var> is <a href="https://dom.spec.whatwg.org/#connected">connected</a>, then <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>connectedCallback</code>", and an empty argument list.</p>
        </li>

        <li>
          <p>Add <var>element</var> to the end of <var>definition</var>'s <a href="#concept-custom-element-definition-construction-stack">construction stack</a>.</p>
        </li>

        <li>
          <p>Let <var>C</var> be <var>definition</var>'s <a href="#concept-custom-element-definition-constructor">constructor</a>.</p>
        </li>

        <li>
          <p>Let <var>constructResult</var> be <a href="https://tc39.github.io/ecma262/#sec-construct">Construct</a>(<var>C</var>).</p>

          <p class="note">If <var>C</var> <a href="#custom-element-conformance">non-conformantly</a> uses an API decorated with the <code><a href="#cereactions">[CEReactions]</a></code> extended attribute, then the reactions enqueued at the beginning of this algorithm will execute during this step, before <var>C</var> finishes and control returns to this algorithm. Otherwise, they will execute after <var>C</var> and the rest of the upgrade process finishes.</p>
        </li>

        <li>
          <p>Remove the last entry from the end of <var>definition</var>'s <a href="#concept-custom-element-definition-construction-stack">construction stack</a>.</p>

          <div class="note">
            <p>Assuming <var>C</var> calls <code>super()</code> (as it will if it is <a href="#custom-element-conformance">conformant</a>), and that the call succeeds, this will be the <a href="#concept-already-constructed-marker"><i>already constructed</i> marker</a> that replaced the <var>element</var> we pushed at the beginning of this algorithm. (The <a href="#html-element-constructors">HTML element constructor</a> carries out this replacement.)</p>

            <p>If <var>C</var> does not call <code>super()</code> (i.e. it is not <a href="#custom-element-conformance">conformant</a>), or if any step in the <a href="#html-element-constructors">HTML element constructor</a> throws, then this entry will still be <var>element</var>.</p>
          </div>
        </li>

        <li>
          <p>If <var>constructResult</var> is an abrupt completion, then:</p>

          <ol>
            <li>
              <p>Set <var>element</var>'s <a href="#concept-element-custom-element-state">custom element state</a> to "<code>failed</code>".</p>
            </li>

            <li>
              <p>Return <var>constructResult</var> (i.e., rethrow the exception), and terminate these steps.</p>
            </li>
          </ol>
        </li>

        <li>
          <p>If <a href="https://tc39.github.io/ecma262/#sec-samevalue">SameValue</a>(<var>constructResult</var>.[[\value]], <var>element</var>) is false, then throw an <a href="https://heycam.github.io/webidl/#invalidstateerror">"<code>InvalidStateError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> and terminate these steps.</p>

          <p class="note">This can occur if <var>C</var> constructs another instance of the same custom element before calling <code>super()</code>, or if <var>C</var> uses JavaScript's <code>return</code>-override feature to return an arbitrary object from the constructor.</p>
        </li>

        <li>
          <p>Set <var>element</var>'s <a href="#concept-element-custom-element-state">custom element state</a> to "<code>custom</code>".</p>
        </li>

        <li>
          <p>Set <var>element</var>'s <a href="#concept-element-custom-element-definition">custom element definition</a> to <var>definition</var>.</p>
        </li>
      </ol>

      <p>To <dfn id="concept-try-upgrade">try to upgrade an element</dfn>, given as input an element <var>element</var>, run the following steps:</p>

      <ol>
        <li>
          <p>Let <var>definition</var> be the result of <a href="#look-up-a-custom-element-definition">looking up a custom element definition</a> given <var>element</var>'s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a>, <var>element</var>'s namespace, <var>element</var>'s local name, and <var>element</var>'s <a href="#concept-element-is-value"><code>is</code> value</a>.</p>
        </li>

        <li>
          <p>If <var>definition</var> is not null, then <a href="#enqueue-a-custom-element-upgrade-reaction">enqueue a custom element upgrade reaction</a> given <var>element</var> and <var>definition</var>.</p>
        </li>
      </ol>
    </section>

    <section>
      <h4 id="custom-element-reactions">Custom element reactions</h4>

      <p>A <a href="#custom-element">custom element</a> possesses the ability to respond to certain occurrences by running author code:</p>

      <ul>
        <li>
          <p>When <a href="#upgrades">upgraded</a>, its <a href="#custom-element-constructor">constructor</a> is run.</p>
        </li>

        <li>
          <p>When it <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#becomes-connected">becomes connected</a>, its <code>connectedCallback</code> is run.</p>
        </li>

        <li>
          <p>When it <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#becomes-disconnected">becomes disconnected</a>, its <code>disconnectedCallback</code> is run.</p>
        </li>

        <li>
          <p>When it is <a href="https://dom.spec.whatwg.org/#concept-node-adopt">adopted</a> into a new document, its <code>adoptedCallback</code> is run.</p>
        </li>

        <li>
          <p>When any of its attributes are <a href="#concept-element-attributes-change">changed</a>, <a href="#concept-element-attributes-append">appended</a>, <a href="#concept-element-attributes-remove">removed</a>, or <a href="#concept-element-attributes-replace">replaced</a>, its <code>attributeChangedCallback</code> is run.</p>
        </li>
      </ul>

      <p>We call these reactions collectively <dfn id="concept-custom-element-reaction">custom element reactions</dfn>.</p>

      <p>The way in which <a href="#concept-custom-element-reaction">custom element reactions</a> are invoked is done with special care, to avoid running author code during the middle of delicate operations. Effectively, they are delayed until "just before returning to user script". This means that for most purposes they appear to execute synchronously, but in the case of complicated composite operations (like <a href="#concept-node-clone">cloning</a>, or <a href="https://dom.spec.whatwg.org/#concept-range">range</a> manipulation), they will instead be delayed until after all the relevant user agent processing steps have completed, and then run together as a batch.</p>

      <p>Additionally, the precise ordering of these reactions is managed via a somewhat-complicated stack-of-queues system, described below. The intention behind this system is to guarantee that <a href="#concept-custom-element-reaction">custom element reactions</a> always are invoked in the same order as their triggering actions, at least within the local context of a single <a href="#custom-element">custom element</a>. (Because <a href="#concept-custom-element-reaction">custom element reaction</a> code can perform its own mutations, it is not possible to give a global ordering guarantee across multiple elements.)</p>
      <hr>

      <p>Each <a href="https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts">unit of related similar-origin browsing contexts</a> has a <dfn id="custom-element-reactions-stack">custom element reactions stack</dfn>, which is initially empty. The <dfn id="current-element-queue">current element queue</dfn> is the <a href="#element-queue">element queue</a> at the top of the <a href="#custom-element-reactions-stack">custom element reactions stack</a>. Each item in the stack is an <dfn id="element-queue">element queue</dfn>, which is initially empty as well. Each item in an <a href="#element-queue">element queue</a> is an element. (The elements are not necessarily <a href="#concept-element-custom">custom</a> yet, since this queue is used for <a href="#upgrades">upgrades</a> as well.)</p>

      <p>Each <a href="#custom-element-reactions-stack">custom element reactions stack</a> has an associated <dfn id="backup-element-queue">backup element queue</dfn>, which an initially-empty <a href="#element-queue">element queue</a>. Elements are pushed onto the <a href="#backup-element-queue">backup element queue</a> during operations that affect the DOM without going through an API decorated with <code><a href="#cereactions">[CEReactions]</a></code>, or through the parser's <a href="#create-an-element-for-the-token">create an element for the token</a> algorithm. An example of this is a user-initiated editing operation which modifies the descendants or attributes of an <a href="https://w3c.github.io/editing/execCommand.html#editable">editable</a> element. To prevent reentrancy when processing the <a href="#backup-element-queue">backup element queue</a>, each <a href="#custom-element-reactions-stack">custom element reactions stack</a> also has a <dfn id="processing-the-backup-element-queue">processing the backup element queue</dfn> flag, initially unset.</p>

      <p>All elements have an associated <dfn id="custom-element-reaction-queue">custom element reaction queue</dfn>, initially empty. Each item in the <a href="#custom-element-reaction-queue">custom element reaction queue</a> is of one of two types:</p>

      <ul>
        <li>
          <p>An <dfn id="upgrade-reaction">upgrade reaction</dfn>, which will <a href="#upgrades">upgrade</a> the custom element and contains a <a href="#custom-element-definition">custom element definition</a>; or</p>
        </li>

        <li>
          <p>A <dfn id="callback-reaction">callback reaction</dfn>, which will call a lifecycle callback, and contains a callback function as well as a list of arguments.</p>
        </li>
      </ul>

      <p>This is all summarised in the following schematic diagram:</p>

      <p><img src="custom-element-reactions.svg" alt="A custom element reactions stack consists of a stack of element queues. Zooming in on a particular queue, we see that it contains a number of elements (in our example, &lt;x-a&gt;, then &lt;x-b&gt;, then &lt;x-c&gt;). Any particular element in the queue then has a custom element reaction queue. Zooming in on the custom element reaction queue, we see that it contains a variety of queued-up reactions (in our example, upgrade, then attribute changed, then another attribute changed, then connected)." style="width: 80%; max-width: 580px;"></p>

      <p>To <dfn id="enqueue-an-element-on-the-appropriate-element-queue">enqueue an element on the appropriate element queue</dfn>, given an element <var>element</var>, run the following steps:</p>

      <ol>
        <li>
          <p>If the <a href="#custom-element-reactions-stack">custom element reactions stack</a> is empty, then:</p>

          <ol>
            <li>
              <p>Add <var>element</var> to the <a href="#backup-element-queue">backup element queue</a>.</p>
            </li>

            <li>
              <p>If the <a href="#processing-the-backup-element-queue">processing the backup element queue</a> flag is set, abort this algorithm.</p>
            </li>

            <li>
              <p>Set the <a href="#processing-the-backup-element-queue">processing the backup element queue</a> flag.</p>
            </li>

            <li>
              <p><a href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-microtask">Queue a microtask</a> to perform the following steps:</p>

              <ol>
                <li>
                  <p><a href="#invoke-custom-element-reactions">Invoke custom element reactions</a> in the <a href="#backup-element-queue">backup element queue</a>.</p>
                </li>

                <li>
                  <p>Unset the <a href="#processing-the-backup-element-queue">processing the backup element queue</a> flag.</p>
                </li>
              </ol>
            </li>
          </ol>
        </li>

        <li>
          <p>Otherwise, add <var>element</var> to the <a href="#current-element-queue">current element queue</a>.</p>
        </li>
      </ol>

      <p>To <dfn id="enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</dfn>, given a <a href="#custom-element">custom element</a> <var>element</var>, a callback name <var>callbackName</var>, and a list of arguments <var>args</var>, run the following steps:</p>

      <ol>
        <li>
          <p>Let <var>definition</var> be <var>element</var>'s <a href="#concept-element-custom-element-definition">custom element definition</a>.</p>
        </li>

        <li>
          <p>Let <var>callback</var> be the value of the entry in <var>definition</var>'s <a href="#concept-custom-element-definition-lifecycle-callbacks">lifecycle callbacks</a> with key <var>callbackName</var>.</p>
        </li>

        <li>
          <p>If <var>callback</var> is null, then abort these steps.</p>
        </li>

        <li>
          <p>If <var>callbackName</var> is "<code>attributeChangedCallback</code>", then:</p>

          <ol>
            <li>
              <p>Let <var>attributeName</var> be the first element of <var>args</var>.</p>
            </li>

            <li>
              <p>If <var>definition</var>'s <a href="#concept-custom-element-definition-observed-attributes">observed attributes</a> does not contain <var>attributeName</var>, then abort these steps.</p>
            </li>
          </ol>
        </li>

        <li>
          <p>Add a new <a href="#callback-reaction">callback reaction</a> to <var>element</var>'s <a href="#custom-element-reaction-queue">custom element reaction queue</a>, with callback function <var>callback</var> and arguments <var>args</var>.</p>
        </li>

        <li>
          <p><a href="#enqueue-an-element-on-the-appropriate-element-queue">Enqueue an element on the appropriate element queue</a> given <var>element</var>.</p>
        </li>
      </ol>

      <p>To <dfn id="enqueue-a-custom-element-upgrade-reaction">enqueue a custom element upgrade reaction</dfn>, given an element <var>element</var> and <a href="#custom-element-definition">custom element definition</a> <var>definition</var>, run the following steps:</p>

      <ol>
        <li>
          <p>Add a new <a href="#upgrade-reaction">upgrade reaction</a> to <var>element</var>'s <a href="#custom-element-reaction-queue">custom element reaction queue</a>, with <a href="#custom-element-definition">custom element definition</a> <var>definition</var>.</p>
        </li>

        <li>
          <p><a href="#enqueue-an-element-on-the-appropriate-element-queue">Enqueue an element on the appropriate element queue</a> given <var>element</var>.</p>
        </li>
      </ol>

      <p>To <dfn id="invoke-custom-element-reactions">invoke custom element reactions</dfn> in an <a href="#element-queue">element queue</a> <var>queue</var>, run the following steps:</p>

      <ol>
        <li>
          <p>For each <a href="#custom-element">custom element</a> <var>element</var> in <var>queue</var>:</p>

          <ol>
            <li>
              <p>Let <var>reactions</var> be <var>element</var>'s <a href="#custom-element-reaction-queue">custom element reaction queue</a>.</p>
            </li>

            <li>
              <p>Repeat until <var>reactions</var> is empty:</p>

              <ol>
                <li>
                  <p>Remove the first element of <var>reactions</var>, and let <var>reaction</var> be that element. Switch on <var>reaction</var>'s type:</p>

                  <dl class="switch">
                    <dt>
                      <a href="#upgrade-reaction">upgrade reaction</a>
                    </dt>

                    <dd>
                      <a href="#concept-upgrade-an-element">Upgrade</a> <var>element</var> using <var>reaction</var>'s <a href="#custom-element-definition">custom element definition</a>.
                    </dd>

                    <dt>
                      <a href="#callback-reaction">callback reaction</a>
                    </dt>

                    <dd>
                      <a href="https://heycam.github.io/webidl/#es-invoking-callback-functions">Invoke</a> <var>reaction</var>'s callback function with <var>reaction</var>'s arguments, and with <var>element</var> as the <a href="https://heycam.github.io/webidl/#dfn-callback-this-value">callback this value</a>.
                    </dd>
                  </dl>

                  <p>If this throws any exception, then <a href="https://html.spec.whatwg.org/multipage/webappapis.html#report-the-exception">report the exception</a>.</p>
                </li>
              </ol>
            </li>
          </ol>
        </li>
      </ol>
      <hr>

      <p>To ensure <a href="#concept-custom-element-reaction">custom element reactions</a> are triggered appropriately, we introduce the <dfn id="cereactions"><code>[CEReactions]</code></dfn> IDL <a href="https://heycam.github.io/webidl/#dfn-extended-attribute">extended attribute</a>. It indicates that the relevant algorithm is to be supplemented with additional steps in order to appropriately track and invoke <a href="#concept-custom-element-reaction">custom element reactions</a>.</p>

      <p>The <code><a href="#cereactions">[CEReactions]</a></code> extended attribute must take no arguments, and must not appear on anything other than an operation, attribute, setter, or deleter. Additionally, it must not appear on readonly attributes, unless the readonly attribute is also annotated with <code>[PutForwards]</code>.</p>

      <p>Operations, attributes, setters, or deleters annotated with the <code><a href="#cereactions">[CEReactions]</a></code> extended attribute must run the following steps surrounding the main algorithm specified for the operation, setter, deleter, or for the attribute's setter:</p>

      <dl>
        <dt>Before executing the algorithm's steps</dt>

        <dd>
          Push a new <a href="#element-queue">element queue</a> onto the <a href="#custom-element-reactions-stack">custom element reactions stack</a>.
        </dd>

        <dt>After executing the algorithm's steps</dt>

        <dd>
          Pop the <a href="#element-queue">element queue</a> from the <a href="#custom-element-reactions-stack">custom element reactions stack</a>, and <a href="#invoke-custom-element-reactions">invoke custom element reactions</a> in that queue.
        </dd>
      </dl>

      <div class="note">
        <p>The intent behind this extended attribute is somewhat subtle. One way of accomplishing its goals would be to say that every operation, attribute, setter, and deleter on the platform should have these steps inserted, and to allow implementers to optimize away unnecessary cases (where no DOM mutation is possible that could cause <a href="#concept-custom-element-reaction">custom element reactions</a> to occur).</p>

        <p>However, in practice this imprecision could lead to non-interoperable implementations of <a href="#concept-custom-element-reaction">custom element reactions</a>, as some implementations might forget to invoke these steps in some cases. Instead, we settled on the approach of explicitly annotating all relevant IDL constructs, as a way of ensuring interoperable behavior and helping implementations easily pinpoint all cases where these steps are necessary.</p>
      </div>

      <p>Any nonstandard APIs introduced by the user agent that could modify the DOM in such a way as to cause <a href="#enqueue-a-custom-element-callback-reaction">enqueuing a custom element callback reaction</a> or <a href="#enqueue-a-custom-element-upgrade-reaction">enqueuing a custom element upgrade reaction</a>, for example by modifying any attributes or child elements, must also be decorated with the <code><a href="#cereactions">[CEReactions]</a></code> attribute.</p>

      <div class="note">
        <p>As of the time of this writing, the following nonstandard or not-yet-standardized APIs are known to fall into this category:</p>

        <ul>
          <li>
            <p><code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code>'s <code>outerText</code> IDL attribute</p>
          </li>

          <li>
            <p><code><a href="https://html.spec.whatwg.org/multipage/forms.html#htmlinputelement">HTMLInputElement</a></code>'s <code>webkitdirectory</code> and <code>incremental</code> IDL attributes</p>
          </li>

          <li>
            <p><code><a href="https://html.spec.whatwg.org/multipage/semantics.html#htmllinkelement">HTMLLinkElement</a></code>'s <code>disabled</code> and <code>scope</code> IDL attributes</p>
          </li>

          <li>
            <p><code><a href="https://dom.spec.whatwg.org/#interface-shadowroot">ShadowRoot</a></code>'s <code>innerHTML</code> IDL attribute</p>
          </li>
        </ul>
      </div>
    </section>
  </section>

  <section>
    <h4 id="html-element-constructors">HTML: HTML element constructors</h4>

    <p>To support the <a href="#custom-elements">custom elements</a> feature, all HTML elements have special constructor behavior. This is indicated via the <dfn id="htmlconstructor"><code>[HTMLConstructor]</code></dfn> IDL <a href="https://heycam.github.io/webidl/#dfn-extended-attribute">extended attribute</a>. It indicates that the interface object for the given interface will have a specific behavior when called, as defined in detail below.</p>

    <p>The <code><a href="#htmlconstructor">[HTMLConstructor]</a></code> extended attribute must take no arguments, and must not appear on anything other than an interface. It must appear only once on an interface, and the interface must not be annotated with the <code>[Constructor]</code> or <code>[NoInterfaceObject]</code> extended attributes. (However, the interface may be annotated with <code>[NamedConstructor]</code>; there is no conflict there.) It must not be used on a callback interface.</p>

    <p><a href="https://heycam.github.io/webidl/#dfn-interface-object">Interface objects</a> for interfaces annotated with the <code><a href="#htmlconstructor">[HTMLConstructor]</a></code> extended attribute must run the following steps as the function body behavior for both [[\Call]] and [[\Construct]] invocations of the corresponding JavaScript function object. When invoked with [[\Call]], the NewTarget value is undefined, and so the algorithm below will immediately throw. When invoked with [[\Construct]], the [[\Construct]] <var>newTarget</var> parameter provides the NewTarget value.</p>

    <ol>
      <li>
        <p>Let <var>registry</var> be the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#current-global-object">current global object</a>'s <code><a href="#customelementregistry">CustomElementRegistry</a></code> object.</p>
      </li>

      <li>
        <p>If NewTarget is equal to the <a href="https://tc39.github.io/ecma262/#active-function-object">active function object</a>, then throw a <code><a href="https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-typeerror">TypeError</a></code> and abort these steps.</p>

        <div class="example no-backref">
          <p>This can occur when a custom element is defined using an <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> as its constructor:</p>
          <pre>
customElements.define("bad-1", HTMLButtonElement);
new HTMLButtonElement();          // (1)
document.createElement("bad-1");  // (2)
</pre>

          <p>In this case, during the execution of <code><a href="https://html.spec.whatwg.org/multipage/forms.html#htmlbuttonelement">HTMLButtonElement</a></code> (either explicitly, as in (1), or implicitly, as in (2)), both the <a href="https://tc39.github.io/ecma262/#active-function-object">active function object</a> and NewTarget are <code><a href="https://html.spec.whatwg.org/multipage/forms.html#htmlbuttonelement">HTMLButtonElement</a></code>. If this check was not present, it would be possible to create an instance of <code><a href="https://html.spec.whatwg.org/multipage/forms.html#htmlbuttonelement">HTMLButtonElement</a></code> whose local name was <code>bad-1</code>.</p>
        </div>
      </li>

      <li>
        <p>Let <var>definition</var> be the entry in <var>registry</var> with <a href="#concept-custom-element-definition-constructor">constructor</a> equal to NewTarget. If there is no such definition, then throw a <code><a href="https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-typeerror">TypeError</a></code> and abort these steps.</p>

        <p class="note">Since there can be no entry in <var>registry</var> with a <a href="#concept-custom-element-definition-constructor">constructor</a> of undefined, this step also prevents HTML element constructors from being called as functions (since in that case NewTarget will be undefined).</p>
      </li>

      <li>
        <p>If <var>definition</var>'s <a href="#concept-custom-element-definition-local-name">local name</a> is equal to <var>definition</var>'s <a href="#concept-custom-element-definition-name">name</a> (i.e., <var>definition</var> is for an <a href="#autonomous-custom-element">autonomous custom element</a>), then:</p>

        <ol>
          <li>
            <p>If the <a href="https://tc39.github.io/ecma262/#active-function-object">active function object</a> is not <code><a href="https://html.spec.whatwg.org/multipage/#htmlelement">HTMLElement</a></code>, then throw a <code><a href="https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-typeerror">TypeError</a></code> and abort these steps.</p>

            <div class="example no-backref">
              <p>This can occur when a custom element is defined to not extend any local names, but inherits from a non-<code><a href="https://html.spec.whatwg.org/multipage/#htmlelement">HTMLElement</a></code> class:</p>
              <pre>
customElements.define("bad-2", class Bad2 extends HTMLParagraphElement {});
</pre>

              <p>In this case, during the (implicit) <code>super()</code> call that occurs when constructing an instance of <code>Bad2</code>, the <a href="https://tc39.github.io/ecma262/#active-function-object">active function object</a> is <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#htmlparagraphelement">HTMLParagraphElement</a></code>, not <code><a href="https://html.spec.whatwg.org/multipage/#htmlelement">HTMLElement</a></code>.</p>
            </div>
          </li>
        </ol>
      </li>

      <li>
        <p>Otherwise (i.e., if <var>definition</var> is for a <a href="#customized-built-in-element">customized built-in element</a>):</p>

        <ol>
          <li>
            <p>Let <var>valid local names</var> be the list of local names for elements defined in this specification or in <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#other-applicable-specifications">other applicable specifications</a> that use the <a href="https://tc39.github.io/ecma262/#active-function-object">active function object</a> as their <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a>.</p>
          </li>

          <li>
            <p>If <var>valid local names</var> does not contain <var>definition</var>'s <a href="#concept-custom-element-definition-local-name">local name</a>, then throw a <code><a href="https://tc39.github.io/ecma262/#sec-native-error-types-used-in-this-standard-typeerror">TypeError</a></code> and abort these steps.</p>

            <div class="example no-backref">
              <p>This can occur when a custom element is defined to extend a given local name but inherits from the wrong class:</p>
              <pre>
customElements.define("bad-3", class Bad3 extends HTMLQuoteElement {}, { extends: "p" });
</pre>

              <p>In this case, during the (implicit) <code>super()</code> call that occurs when constructing an instance of <code>Bad3</code>, <var>valid local names</var> is the list containing <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-q-element">q</a></code> and <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-blockquote-element">blockquote</a></code>, but <var>definition</var>'s <a href="#concept-custom-element-definition-local-name">local name</a> is <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-p-element">p</a></code>, which is not in that list.</p>
            </div>
          </li>
        </ol>
      </li>

      <li>
        <p>Let <var>prototype</var> be <var>definition</var>'s <a href="#concept-custom-element-definition-prototype">prototype</a>.</p>
      </li>

      <li>
        <p>If <var>definition</var>'s <a href="#concept-custom-element-definition-construction-stack">construction stack</a> is empty, then:</p>

        <ol>
          <li>
            <p>Let <var>element</var> be a new element that implements the interface to which the <a href="https://tc39.github.io/ecma262/#active-function-object">active function object</a> corresponds, with no attributes, namespace set to the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#html-namespace-2">HTML namespace</a>, local name set to <var>definition</var>'s <a href="#concept-custom-element-definition-local-name">local name</a>, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#current-global-object">current global object</a>'s <a href="https://html.spec.whatwg.org/multipage/browsers.html#concept-document-window">associated <code>Document</code></a>.</p>
          </li>

          <li>
            <p>Perform <var>element</var>.[[\SetPrototypeOf]](<var>prototype</var>). Rethrow any exceptions.</p>
          </li>

          <li>
            <p>Set <var>element</var>'s <a href="#concept-element-custom-element-state">custom element state</a> to "<code>custom</code>".</p>
          </li>

          <li>
            <p>Set <var>element</var>'s <a href="#concept-element-custom-element-definition">custom element definition</a> to <var>definition</var>.</p>
          </li>

          <li>
            <p>Return <var>element</var>.</p>
          </li>
        </ol>

        <p class="note">This occurs when author script constructs a new custom element directly, e.g. via <code>new MyCustomElement()</code>.</p>
      </li>

      <li>
        <p>Let <var>element</var> be the last entry in <var>definition</var>'s <a href="#concept-custom-element-definition-construction-stack">construction stack</a>.</p>
      </li>

      <li>
        <p>If <var>element</var> is an <a href="#concept-already-constructed-marker"><i>already constructed</i> marker</a>, then throw an <a href="https://heycam.github.io/webidl/#invalidstateerror">"<code>InvalidStateError</code>"</a> <code><a href="https://heycam.github.io/webidl/#dfn-DOMException">DOMException</a></code> and abort these steps.</p>

        <div class="example">
          <p>This can occur when the author code inside the <a href="#custom-element-constructor">custom element constructor</a> <a href="#custom-element-conformance">non-conformantly</a> creates another instance of the class being constructed, before calling <code>super()</code>:</p>
          <pre>
let doSillyThing = false;

class DontDoThis extends HTMLElement {
  constructor() {
    if (doSillyThing) {
      doSillyThing = false;
      new DontDoThis();
      // Now the construction stack will contain an <i>already constructed</i> marker.
    }

    // This will then fail with an "InvalidStateError" DOMException:
    super();
  }
}
</pre>
        </div>

        <div class="example">
          <p>This can also occur when author code inside the <a href="#custom-element-constructor">custom element constructor</a> <a href="#custom-element-conformance">non-conformantly</a> calls <code>super()</code> twice, since per the JavaScript specification, this actually executes the superclass constructor (i.e. this algorithm) twice, before throwing an error:</p>
          <pre>
class DontDoThisEither extends HTMLElement {
  constructor() {
    super();

    // This will throw, but not until it has already called into the HTMLElement constructor
    super();
  }
}
</pre>
        </div>
      </li>

      <li>
        <p>Perform <var>element</var>.[[\SetPrototypeOf]](<var>prototype</var>). Rethrow any exceptions.</p>
      </li>

      <li>
        <p>Replace the last entry in <var>definition</var>'s <a href="#concept-custom-element-definition-construction-stack">construction stack</a> with an <a href="#concept-already-constructed-marker"><i>already constructed</i> marker</a>.</p>
      </li>

      <li>
        <p>Return <var>element</var>.</p>

        <p class="note">This step is normally reached when <a href="#upgrades">upgrading</a> a custom element; the existing element is returned, so that the <code>super()</code> call inside the <a href="#custom-element-constructor">custom element constructor</a> assigns that existing element to <b>this</b>.</p>
      </li>
    </ol>
    <hr>

    <p>In addition to the constructor behavior implied by <code><a href="#htmlconstructor">[HTMLConstructor]</a></code>, some elements also have <a href="https://heycam.github.io/webidl/#dfn-named-constructor">named constructors</a> (which are really factory functions with a modified <code>prototype</code> property).</p>

    <div class="example">
      <p>Named constructors for HTML elements can also be used in an <code>extends</code> clause when defining a <a href="#custom-element-constructor">custom element constructor</a>:</p>
      <pre>
class AutoEmbiggenedImage extends Image {
  constructor(width, height) {
    super(width * 10, height * 10);
  }
}

customElements.define("auto-embiggened", AutoEmbiggenedImage, { extends: "img" });

const image = new AutoEmbiggenedImage(15, 20);
console.assert(image.width === 150);
console.assert(image.height === 200);
</pre>
    </div>
  </section>

  <section>
    <h2>Miscellaneous patches</h2>

    <section id="window-modifications-to-html">
      <h3>HTML: The <a href="https://html.spec.whatwg.org/#window"><code>Window</code></a> object</h3>

      <p>HTML's <code>Window</code> object definition must be extended as follows:</p>
      <pre class="idl">
partial interface Window {
    readonly attribute CustomElementRegistry customElements;
};
</pre>
    </section>

    <section>
      <h2>HTML: Pseudo-classes</h2>

      <dl>
        <dt><dfn id="selector-defined"><code>:defined</code></dfn></dt>

        <dd>
          <p>The <code><a href="#selector-defined">:defined</a></code> <a href="https://drafts.csswg.org/selectors/#pseudo-class">pseudo-class</a> must match any element that is <a href="#concept-element-defined">defined</a>.</p>
        </dd>
      </dl>
    </section>

    <section>
      <h2>HTML: Creating and inserting nodes</h2>

      <p>When the HTML parser requires the UA to <dfn id="create-an-element-for-the-token">create an element for a token</dfn> in a particular <var>given namespace</var> and with a particular <var>intended parent</var>, the UA must run the following steps:</p>

      <ol>
        <li>
          <p>Let <var>document</var> be <var>intended parent</var>'s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a>.</p>
        </li>

        <li>
          <p>Let <var>local name</var> be the tag name of the token.</p>
        </li>

        <li>
          <p>Let <var>is</var> be the value of the "<code><a href="#attr-is">is</a></code>" attribute in the given token, if such an attribute exists, or null otherwise.</p>
        </li>

        <li>
          <p>Let <var>definition</var> be the result of <a href="#look-up-a-custom-element-definition">looking up a custom element definition</a> given <var>document</var>, <var>given namespace</var>, <var>local name</var>, and <var>is</var>.</p>
        </li>

        <li>
          <p>If <var>definition</var> is non-null and the parser was not originally created for the <a href="https://html.spec.whatwg.org/multipage/#html-fragment-parsing-algorithm">HTML fragment parsing algorithm</a>, then let <var>will execute script</var> be true. Otherwise, let it be false.</p>
        </li>

        <li>
          <p>If <var>will execute script</var> is true, then:</p>

          <ol>
            <li>
              <p>Increment <var>document</var>'s <a href="https://html.spec.whatwg.org/multipage/webappapis.html#throw-on-dynamic-markup-insertion-counter">throw-on-dynamic-markup-insertion counter</a>.</p>
            </li>

            <li>
              <p>If the <a href="https://tc39.github.io/ecma262/#execution-context-stack">JavaScript execution context stack</a> is empty, then <a href="https://html.spec.whatwg.org/multipage/webappapis.html#perform-a-microtask-checkpoint">perform a microtask checkpoint</a>.</p>
            </li>

            <li>
              <p>Push a new <a href="#element-queue">element queue</a> onto the <a href="#custom-element-reactions-stack">custom element reactions stack</a>.</p>
            </li>
          </ol>
        </li>

        <li>
          <p>Let <var>element</var> be the result of <a href="#concept-create-element">creating an element</a> given <var>document</var>, <var>localName</var>, <var>given namespace</var>, null, and <var>is</var>. If <var>will execute script</var> is true, set the <var>synchronous custom elements flag</var>; otherwise, leave it unset.</p>

          <p class="note">This will cause <a href="#custom-element-constructor">custom element constructors</a> to run, if <var>will execute script</var> is true. However, since we incremented the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#throw-on-dynamic-markup-insertion-counter">throw-on-dynamic-markup-insertion counter</a>, this cannot cause <a href="https://html.spec.whatwg.org/multipage/webappapis.html#dom-document-write">new characters to be inserted into the tokenizer</a>, or <a href="https://html.spec.whatwg.org/multipage/webappapis.html#dom-document-open">the document to be blown away</a>.</p>

          <p>If this step throws an exception, then <a href="https://html.spec.whatwg.org/multipage/webappapis.html#report-the-exception">report the exception</a>, and let <var>element</var> be instead a new element that implements <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlunknownelement">HTMLUnknownElement</a></code>, with no attributes, namespace set to <var>given namespace</var>, namespace prefix set to null, <a href="#concept-element-custom-element-state">custom element state</a> set to "<code>failed</code>", <a href="#concept-element-custom-element-definition">custom element definition</a> set to null, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to <var>document</var>.</p>
        </li>

        <li>
          <p><a href="#concept-element-attributes-append">Append</a> each attribute in the given token to <var>element</var>.</p>

          <p class="note">This can <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> for the <code>attributeChangedCallback</code>, which might run immediately (in the next step).</p>

          <p class="note">Even though the <code><a href="#attr-is">is</a></code> attribute governs the <a href="#concept-create-element">creation</a> of a <a href="#customized-built-in-element">customized built-in element</a>, it is not present during the execution of the relevant <a href="#custom-element-constructor">custom element constructor</a>; it is appended in this step, along with all other attributes.</p>
        </li>

        <li>
          <p>If <var>will execute script</var> is true, then:</p>

          <ol>
            <li>
              <p>Let <var>queue</var> be the result of popping the <a href="#current-element-queue">current element queue</a> from the <a href="#custom-element-reactions-stack">custom element reactions stack</a>. (This will be the same <a href="#element-queue">element queue</a> as was pushed above.)</p>
            </li>

            <li>
              <p><a href="#invoke-custom-element-reactions">Invoke custom element reactions</a> in <var>queue</var>.</p>
            </li>

            <li>
              <p>Decrement <var>document</var>'s <a href="https://html.spec.whatwg.org/multipage/webappapis.html#throw-on-dynamic-markup-insertion-counter">throw-on-dynamic-markup-insertion counter</a>.</p>
            </li>
          </ol>
        </li>

        <li>
          <p>If <var>element</var> has an <code>xmlns</code> attribute <em>in the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#xmlns-namespace">XMLNS namespace</a></em> whose value is not exactly the same as the element's namespace, that is a <a href="https://html.spec.whatwg.org/multipage/#parse-error">parse error</a>. Similarly, if <var>element</var> has an <code>xmlns:xlink</code> attribute in the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#xmlns-namespace">XMLNS namespace</a> whose value is not the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#xlink-namespace">XLink Namespace</a>, that is a <a href="https://html.spec.whatwg.org/multipage/#parse-error">parse error</a>.</p>
        </li>

        <li>
          <p>If <var>element</var> is a <a href="https://html.spec.whatwg.org/multipage/forms.html#category-reset">resettable element</a>, invoke its <a href="https://html.spec.whatwg.org/multipage/forms.html#concept-form-reset-control">reset algorithm</a>. (This initialises the element's <a href="https://html.spec.whatwg.org/multipage/forms.html#concept-fe-value">value</a> and <a href="https://html.spec.whatwg.org/multipage/forms.html#concept-fe-checked">checkedness</a> based on the element's attributes.)</p>
        </li>

        <li>
          <p>If <var>element</var> is a <a href="https://html.spec.whatwg.org/multipage/forms.html#form-associated-element">form-associated element</a>, and the <a href="https://html.spec.whatwg.org/multipage/#form-element-pointer"><code>form</code> element pointer</a> is not null, and there is no <code><a href="https://html.spec.whatwg.org/multipage/scripting.html#the-template-element">template</a></code> element on the <a href="https://html.spec.whatwg.org/multipage/#stack-of-open-elements">stack of open elements</a>, and <var>element</var> is either not <a href="https://html.spec.whatwg.org/multipage/forms.html#category-listed">listed</a> or doesn't have a <code><a href="https://html.spec.whatwg.org/multipage/forms.html#attr-fae-form">form</a></code> attribute, and the <var>intended parent</var> is in the same <a href="https://dom.spec.whatwg.org/#concept-tree">tree</a> as the element pointed to by the <a href="https://html.spec.whatwg.org/multipage/#form-element-pointer"><code>form</code> element pointer</a>, <a href="https://html.spec.whatwg.org/multipage/forms.html#concept-form-association">associate</a> <var>element</var> with the <code><a href="https://html.spec.whatwg.org/multipage/forms.html#the-form-element">form</a></code> element pointed to by the <a href="https://html.spec.whatwg.org/multipage/#form-element-pointer"><code>form</code> element pointer</a>, and suppress the running of the <a href="https://html.spec.whatwg.org/multipage/forms.html#reset-the-form-owner">reset the form owner</a> algorithm when the parser subsequently attempts to insert the element.</p>
        </li>

        <li>
          <p>Return <var>element</var>.</p>
        </li>
      </ol>
    </section>

    <section>
      <h2>HTML: Parsing XHTML documents</h2>

      <p>When creating DOM nodes representing elements, the <a href="#create-an-element-for-the-token">create an element for a token</a> algorithm or some equivalent that operates on appropriate XML datastructures must be used, to ensure the proper <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interfaces</a> are created and that <a href="#custom-element">custom elements</a> are set up correctly.</p>
    </section>

    <section>
      <h2>HTML: Content model</h2>

      <p>HTML has several sections that need to be updated when introducing a new element, or in this case class of elements. The necessary changes are:</p>

      <ul>
        <li>
          <p><a href="https://html.spec.whatwg.org/multipage/dom.html#content-categories">The categories venn diagram</a>'s interactive list must include <a href="#autonomous-custom-element">autonomous custom elements</a> in phrasing and flow content.</p>
        </li>

        <li>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#flow-content-2">Flow content</a> must include <a href="#autonomous-custom-element">autonomous custom elements</a>
        </li>

        <li>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#phrasing-content-2">Phrasing content</a> must include <a href="#autonomous-custom-element">autonomous custom elements</a>
        </li>

        <li>
          <a href="https://html.spec.whatwg.org/multipage/dom.html#palpable-content-2">Palpable content</a> must include <a href="#autonomous-custom-element">autonomous custom elements</a>
        </li>

        <li>
          <a href="https://html.spec.whatwg.org/multipage/indices.html#elements-3">The elements index</a> must include a row at the bottom for <a href="#autonomous-custom-element">autonomous custom elements</a>
        </li>

        <li>
          <a href="https://html.spec.whatwg.org/multipage/indices.html#element-content-categories">The element content categories index</a> must include <a href="#autonomous-custom-element">autonomous custom elements</a> in the flow content, phrasing content, and palpable content sections
        </li>

        <li>
          <a href="https://html.spec.whatwg.org/multipage/syntax.html#syntax-tag-omission">Tag omission</a> must note that <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-p-element"><code>p</code></a> element end tags cannot be omitted if the element's parent is an <a href="#autonomous-custom-element">autonomous custom element</a>
        </li>
      </ul>
    </section>

    <section>
      <h2>HTML: Wide-ranging patches</h2>

      <p>All IDL attributes in HTML which could potentially cause DOM mutations have been updated to be annotated with the <code><a href="#cereactions">[CEReactions]</a></code> extended attribute.</p>

      <p>All HTML interfaces representing a HTML element have been updated to be annotated with the <code><a href="#htmlconstructor">[HTMLConstructor]</a></code> extended attribute.</p>

      <p>All places in HTML that create elements have been updated to use the new <a href="#concept-create-element">create an element</a> algorithm.</p>
    </section>

    <section>
      <h2>DOM: Elements</h2>

      <p><a href="https://dom.spec.whatwg.org/#concept-element">Elements</a> have an associated <dfn id="concept-element-namespace">namespace</dfn>, <dfn id="concept-element-namespace-prefix">namespace prefix</dfn>, <dfn id="concept-element-local-name">local name</dfn>, <dfn id="concept-element-custom-element-state">custom element state</dfn>, <dfn id="concept-element-custom-element-definition">custom element definition</dfn>, <dfn id="concept-element-is-value"><code>is</code> value</dfn>. When an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> is <a href="#concept-create-element">created</a>, all of these values are initialized.</p>

      <p>An <a href="https://dom.spec.whatwg.org/#concept-element">element</a>’s <a href="#concept-element-custom-element-state">custom element state</a> is one of "<code>undefined</code>", "<code>failed</code>", "<code>uncustomized</code>", or "<code>custom</code>". An <a href="https://dom.spec.whatwg.org/#concept-element">element</a> whose <a href="#concept-element-custom-element-state">custom element state</a> is "<code>uncustomized</code>" or "<code>custom</code>" is said to be <dfn id="concept-element-defined">defined</dfn>. An <a href="https://dom.spec.whatwg.org/#concept-element">element</a> whose <a href="#concept-element-custom-element-state">custom element state</a> is "<code>custom</code>" is said to be <dfn id="concept-element-custom">custom</dfn>.</p>

      <p class="note" role="note">Whether or not an element is <a href="#concept-element-defined">defined</a> is used to determine the behavior of the <a class="css" href="#selector-defined">:defined</a> pseudo-class. Whether or not an element is <a href="#concept-element-custom">custom</a> is used to determine the behavior of the <a href="https://dom.spec.whatwg.org/#mutation-algorithms">mutation algorithms</a>. The "<code>failed</code>" state is used to ensure that if a <a href="#custom-element-constructor">custom element constructor</a> fails to execute correctly the first time, it is not executed again by an <a href="#concept-upgrade-an-element">upgrade</a>.</p>

      <div class="example">
        <p>The following code illustrates elements in each of these four states:</p>
        <pre>
&lt;!DOCTYPE html&gt;
&lt;script&gt;
  window.customElements.define("sw-rey", class extends HTMLElement {})
  window.customElements.define("sw-finn", class extends HTMLElement {}, { extends: "p" })
  window.customElements.define("sw-kylo", class extends HTMLElement {
    constructor() {
      // super() intentionally omitted for this example
    }
  })
&lt;/script&gt;

&lt;!-- "undefined" (not defined, not custom) --&gt;
&lt;sw-han&gt;&lt;/sw-han&gt;
&lt;p is="sw-luke"&gt;&lt;/p&gt;
&lt;p is="asdf"&gt;&lt;/p&gt;

&lt;!-- "failed" (not defined, not custom) --&gt;
&lt;sw-kylo&gt;&lt;/sw-kylo&gt;

&lt;!-- "uncustomized" (defined, not custom) --&gt;
&lt;p&gt;&lt;/p&gt;
&lt;asdf&gt;&lt;/asdf&gt;

&lt;!-- "custom" (defined, custom) --&gt;
&lt;sw-rey&gt;&lt;/sw-rey&gt;
&lt;p is="sw-finn"&gt;&lt;/p&gt;
</pre>
      </div>

      <p>To <dfn id="concept-create-element">create an element</dfn>, given a <var>document</var>, <var>localName</var>, <var>namespace</var>, and optional <var>prefix</var>, <var>is</var>, and <var>synchronous custom elements flag</var>, run these steps:</p>

      <ol>
        <li>
          <p>If <var>prefix</var> was not given, let <var>prefix</var> be null.</p>
        </li>

        <li>
          <p>If <var>is</var> was not given, let <var>is</var> be null.</p>
        </li>

        <li>
          <p>Let <var>result</var> be null.</p>
        </li>

        <li>
          <p>Let <var>definition</var> be the result of <a href="#look-up-a-custom-element-definition">looking up a custom element definition</a> given <var>document</var>, <var>namespace</var>, <var>localName</var>, and <var>is</var>.</p>
        </li>

        <li>
          <p>If <var>definition</var> is non-null, and <var>definition</var>’s <a href="#concept-custom-element-definition-name">name</a> is not equal to its <a href="#concept-custom-element-definition-local-name">local name</a> (i.e., <var>definition</var> represents a <a href="#customized-built-in-element">customized built-in element</a>), then:</p>

          <ol>
            <li>
              <p>Let <var>interface</var> be the <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> for <var>localName</var> and the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>.</p>
            </li>

            <li>
              <p>Set <var>result</var> to a new <a href="https://dom.spec.whatwg.org/#concept-element">element</a> that implements <var>interface</var>, with no attributes, <a href="#concept-element-namespace">namespace</a> set to the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <a href="#concept-element-namespace-prefix">namespace prefix</a> set to <var>prefix</var>, <a href="#concept-element-local-name">local name</a> set to <var>localName</var>, <a href="#concept-element-custom-element-state">custom element state</a> set to "<code>undefined</code>", <a href="#concept-element-custom-element-definition">custom element definition</a> set to null, <a href="#concept-element-is-value"><code>is</code> value</a> set to <var>is</var>, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to <var>document</var>.</p>
            </li>

            <li>
              <p>If the <var>synchronous custom elements flag</var> is set, <a href="#concept-upgrade-an-element">upgrade</a> <var>element</var> using <var>definition</var>.</p>
            </li>

            <li>
              <p>Otherwise, <a href="#enqueue-a-custom-element-upgrade-reaction">enqueue a custom element upgrade reaction</a> given <var>result</var> and <var>definition</var>.</p>
            </li>
          </ol>
        </li>

        <li>
          <p>Otherwise, if <var>definition</var> is non-null, then:</p>

          <ol>
            <li>
              <p>If the <var>synchronous custom elements flag</var> is set:</p>

              <ol>
                <li>
                  <p>Let <var>C</var> be <var>definition</var>’s <a href="#concept-custom-element-definition-constructor">constructor</a>.</p>
                </li>

                <li>
                  <p>Set <var>result</var> to <a href="https://tc39.github.io/ecma262/#sec-construct">Construct</a>(<var>C</var>). Rethrow any exceptions.</p>
                </li>

                <li>
                  <p>If <var>result</var> does not implement the <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code> interface, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code>.</p>

                  <div class="note" role="note">
                    <p>This is meant to be a brand check to ensure that the object was allocated by the a HTML element constructor. See <a href="https://github.com/heycam/webidl/issues/97">webidl #97</a> about making this more precise.</p>

                    <p>If this check passes, then <var>result</var> will already have its <a href="#concept-element-custom-element-state">custom element state</a> and <a href="#concept-element-custom-element-definition">custom element definition</a> initialized.</p>
                  </div>
                </li>

                <li>
                  <p>If <var>result</var>’s <a href="https://dom.spec.whatwg.org/#concept-element-attribute">attribute list</a> is not empty, then <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a href="https://heycam.github.io/webidl/#notsupportederror">NotSupportedError</a></code>.</p>
                </li>

                <li>
                  <p>If <var>result</var> has <a href="https://dom.spec.whatwg.org/#concept-tree-child">children</a>, then <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a href="https://heycam.github.io/webidl/#notsupportederror">NotSupportedError</a></code>.</p>
                </li>

                <li>
                  <p>If <var>result</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-parent">parent</a> is not null, then <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a href="https://heycam.github.io/webidl/#notsupportederror">NotSupportedError</a></code>.</p>
                </li>

                <li>
                  <p>If <var>result</var>’s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> is not <var>document</var>, then <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a href="https://heycam.github.io/webidl/#notsupportederror">NotSupportedError</a></code>.</p>
                </li>

                <li>
                  <p>If <var>result</var>’s <a href="#concept-element-namespace">namespace</a> is not the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, then <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a href="https://heycam.github.io/webidl/#notsupportederror">NotSupportedError</a></code>.</p>

                  <p class="note" role="note">As of the time of this writing, every element that implements the <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code> interface is also in the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, so this check is currently redundant with the above brand check. However, this is not guaranteed to be true forever in the face of potential specification changes, such as converging certain SVG and HTML interfaces.</p>
                </li>

                <li>
                  <p>If <var>result</var>’s <a href="#concept-element-local-name">local name</a> is not equal to <var>localName</var>, then <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code><a href="https://heycam.github.io/webidl/#notsupportederror">NotSupportedError</a></code>.</p>
                </li>

                <li>
                  <p>Set <var>result</var>’s <a href="#concept-element-namespace-prefix">namespace prefix</a> to <var>prefix</var>.</p>
                </li>

                <li>
                  <p>Set <var>result</var>’s <a href="#concept-element-is-value"><code>is</code> value</a> to null.</p>
                </li>
              </ol>
            </li>

            <li>
              <p>Otherwise:</p>

              <ol>
                <li>
                  <p>Set <var>result</var> to a new <a href="https://dom.spec.whatwg.org/#concept-element">element</a> that implements the <code><a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement">HTMLElement</a></code> interface, with no attributes, <a href="#concept-element-namespace">namespace</a> set to the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <a href="#concept-element-namespace-prefix">namespace prefix</a> set to <var>prefix</var>, <a href="#concept-element-local-name">local name</a> set to <var>localName</var>, <a href="#concept-element-custom-element-state">custom element state</a> set to "<code>undefined</code>", <a href="#concept-element-custom-element-definition">custom element definition</a> set to null, <a href="#concept-element-is-value"><code>is</code> value</a> set to null, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to <var>document</var>.</p>
                </li>

                <li>
                  <p><a href="#enqueue-a-custom-element-upgrade-reaction">Enqueue a custom element upgrade reaction</a> given <var>result</var> and <var>definition</var>.</p>
                </li>
              </ol>
            </li>
          </ol>
        </li>

        <li>
          <p>Otherwise:</p>

          <ol>
            <li>
              <p>Let <var>interface</var> be the <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> for <var>localName</var> and <var>namespace</var>.</p>
            </li>

            <li>
              <p>Set <var>result</var> to a new <a href="https://dom.spec.whatwg.org/#concept-element">element</a> that implements <var>interface</var>, with no attributes, <a href="#concept-element-namespace">namespace</a> set to <var>namespace</var>, <a href="#concept-element-namespace-prefix">namespace prefix</a> set to <var>prefix</var>, <a href="#concept-element-local-name">local name</a> set to <var>localName</var>, <a href="#concept-element-custom-element-state">custom element state</a> set to "<code>uncustomized</code>", <a href="#concept-element-custom-element-definition">custom element definition</a> set to null, <a href="#concept-element-is-value"><code>is</code> value</a> set to <var>is</var>, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to <var>document</var>.</p>
            </li>

            <li>
              <p>If <var>namespace</var> is the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, and either <var>localName</var> is a <a href="#valid-custom-element-name">valid custom element name</a> or <var>is</var> is non-null, then set <var>result</var>’s <a href="#concept-element-custom-element-state">custom element state</a> to "<code>undefined</code>".</p>
            </li>
          </ol>
        </li>

        <li>
          <p>Return <var>result</var>.</p>
        </li>
      </ol>

      <p>To <dfn id="concept-element-attributes-change">change</dfn> an <a href="https://dom.spec.whatwg.org/#concept-attribute">attribute</a> <var>attribute</var> from an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> <var>element</var> to <var>value</var>, run these steps:</p>

      <ol>
        <li>
          <a href="https://dom.spec.whatwg.org/#queue-a-mutation-record">Queue a mutation record</a> of "<code>attributes</code>" for <var>element</var> with name <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, namespace <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>, and oldValue <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>.
        </li>

        <li>If <var>element</var> is <a href="#concept-element-custom">custom</a>, then <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, <var>value</var>, and <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.
        </li>

        <li>
          <p>Run the <a href="https://dom.spec.whatwg.org/#concept-element-attributes-change-ext">attribute change steps</a> with <var>element</var>, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, <var>value</var>, and <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.</p>
        </li>

        <li>Set <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a> to <var>value</var>.
        </li>
      </ol>

      <p>To <dfn id="concept-element-attributes-append">append</dfn> an <a href="https://dom.spec.whatwg.org/#concept-attribute">attribute</a> <var>attribute</var> to an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> <var>element</var>, run these steps:</p>

      <ol>
        <li>
          <a href="https://dom.spec.whatwg.org/#queue-a-mutation-record">Queue a mutation record</a> of "<code>attributes</code>" for <var>element</var> with name <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, namespace <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>, and oldValue null.
        </li>

        <li>If <var>element</var> is <a href="#concept-element-custom">custom</a>, then <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, null, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, and <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.
        </li>

        <li>
          <p>Run the <a href="https://dom.spec.whatwg.org/#concept-element-attributes-change-ext">attribute change steps</a> with <var>element</var>, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, null, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, and <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.</p>
        </li>

        <li>Append the <var>attribute</var> to the <var>element</var>’s <a href="https://dom.spec.whatwg.org/#concept-element-attribute">attribute list</a>.
        </li>

        <li>Set <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-element">element</a> to <var>element</var>.
        </li>
      </ol>

      <p>To <dfn id="concept-element-attributes-remove">remove</dfn> an <a href="https://dom.spec.whatwg.org/#concept-attribute">attribute</a> <var>attribute</var> from an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> <var>element</var>, run these steps:</p>

      <ol>
        <li>
          <a href="https://dom.spec.whatwg.org/#queue-a-mutation-record">Queue a mutation record</a> of "<code>attributes</code>" for <var>element</var> with name <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, namespace <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>, and oldValue <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>.
        </li>

        <li>If <var>element</var> is <a href="#concept-element-custom">custom</a>, then <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, null, and <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.
        </li>

        <li>
          <p>Run the <a href="https://dom.spec.whatwg.org/#concept-element-attributes-change-ext">attribute change steps</a> with <var>element</var>, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, null, and <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.</p>
        </li>

        <li>Remove <var>attribute</var> from the <var>element</var>’s <a href="https://dom.spec.whatwg.org/#concept-element-attribute">attribute list</a>.
        </li>

        <li>Set <var>attribute</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-element">element</a> to null.
        </li>
      </ol>

      <p>To <dfn id="concept-element-attributes-replace">replace</dfn> an <a href="https://dom.spec.whatwg.org/#concept-attribute">attribute</a> <var>oldAttr</var> by an <a href="https://dom.spec.whatwg.org/#concept-attribute">attribute</a> <var>newAttr</var> in an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> <var>element</var>, run these steps:</p>

      <ol>
        <li>
          <p><a href="https://dom.spec.whatwg.org/#queue-a-mutation-record">Queue a mutation record</a> of "<code>attributes</code>" for <var>element</var> with name <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, namespace <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>, and oldValue <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>.</p>
        </li>

        <li>If <var>element</var> is <a href="#concept-element-custom">custom</a>, then <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, <var>newAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, and <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.
        </li>

        <li>
          <p>Run the <a href="https://dom.spec.whatwg.org/#concept-element-attributes-change-ext">attribute change steps</a> with <var>element</var>, <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, <var>newAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, and <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.</p>
        </li>

        <li>
          <p>Replace <var>oldAttr</var> by <var>newAttr</var> in the <var>element</var>’s <a href="https://dom.spec.whatwg.org/#concept-element-attribute">attribute list</a>.</p>
        </li>

        <li>
          <p>Set <var>oldAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-element">element</a> to null.</p>
        </li>

        <li>
          <p>Set <var>newAttr</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-element">element</a> to <var>element</var>.</p>
        </li>
      </ol>
    </section>

    <section>
      <h2>DOM: Cloning</h2>

      <p>To <dfn data-local-lt="clone" id="concept-node-clone">clone</dfn> a <var>node</var>, with an optional <var>document</var> and <i>clone children flag</i>, run these steps:</p>

      <ol>
        <li>
          <p>If <var>document</var> is not given, let <var>document</var> be <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a>.</p>
        </li>

        <li>
          <p>If <var>node</var> is an <a href="https://dom.spec.whatwg.org/#concept-element">element</a>, then:</p>

          <ol>
            <li>
              <p>Let <var>copy</var> be the result of <a href="#concept-create-element">creating an element</a>, given <var>document</var>, <var>node</var>’s <a href="#concept-element-local-name">local name</a>, <var>node</var>’s <a href="#concept-element-namespace">namespace</a>, <var>node</var>’s <a href="#concept-element-namespace-prefix">namespace prefix</a>, and the value of <var>node</var>’s <code>is</code> attribute if present (or null if not). The <var>synchronous custom elements flag</var> should be unset.</p>
            </li>

            <li>
              <p>For each <var>attribute</var> in <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-element-attribute">attribute list</a>, in order, run these substeps:</p>

              <ol>
                <li>
                  <p>Let <var>copyAttribute</var> be a <a href="#concept-node-clone">clone</a> of <var>attribute</var>.</p>
                </li>

                <li>
                  <p><a href="#concept-element-attributes-append">Append</a> <var>copyAttribute</var> to <var>copy</var>.</p>
                </li>
              </ol>
            </li>
          </ol>
        </li>

        <li>
          <p>Otherwise, let <var>copy</var> be a <a href="https://dom.spec.whatwg.org/#concept-node">node</a> that implements the same interfaces as <var>node</var>, and fulfills these additional requirements, switching on <var>node</var>:</p>

          <dl class="switch">
            <dt><code><a href="https://dom.spec.whatwg.org/#document">Document</a></code></dt>

            <dd>
              <p>Set <var>copy</var>’s <a href="https://dom.spec.whatwg.org/#concept-document-encoding">encoding</a>, <a href="https://dom.spec.whatwg.org/#concept-document-content-type">content type</a>, <a href="https://dom.spec.whatwg.org/#concept-document-url">URL</a>, <a href="https://dom.spec.whatwg.org/#concept-document-type">type</a>, and <a href="https://dom.spec.whatwg.org/#concept-document-mode">mode</a>, to those of <var>node</var>.</p>
            </dd>

            <dt><code><a href="https://dom.spec.whatwg.org/#documenttype">DocumentType</a></code></dt>

            <dd>
              <p>Set <var>copy</var>’s <a href="https://dom.spec.whatwg.org/#concept-doctype-name">name</a>, <a href="https://dom.spec.whatwg.org/#concept-doctype-publicid">public ID</a>, and <a href="https://dom.spec.whatwg.org/#concept-doctype-systemid">system ID</a>, to those of <var>node</var>.</p>
            </dd>

            <dt><code><a href="https://dom.spec.whatwg.org/#attr">Attr</a></code></dt>

            <dd>
              <p>Set <var>copy</var>’s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>, <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace-prefix">namespace prefix</a>, <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, and <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, to those of <var>node</var>.</p>
            </dd>

            <dt><code><a href="https://dom.spec.whatwg.org/#text">Text</a></code></dt>

            <dt><code><a href="https://dom.spec.whatwg.org/#comment">Comment</a></code></dt>

            <dd>
              Set <var>copy</var>’s <a href="https://dom.spec.whatwg.org/#concept-cd-data">data</a>, to that of <var>node</var>.
            </dd>

            <dt><code><a href="https://dom.spec.whatwg.org/#processinginstruction">ProcessingInstruction</a></code></dt>

            <dd>
              Set <var>copy</var>’s <a href="https://dom.spec.whatwg.org/#concept-pi-target">target</a> and <a href="https://dom.spec.whatwg.org/#concept-cd-data">data</a> to those of <var>node</var>.
            </dd>

            <dt>Any other node</dt>

            <dd>—</dd>
          </dl>
        </li>

        <li>
          <p>Set <var>copy</var>’s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> and <var>document</var> to <var>copy</var>, if <var>copy</var> is a <a href="https://dom.spec.whatwg.org/#concept-document">document</a>, and set <var>copy</var>’s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> to <var>document</var> otherwise.</p>
        </li>

        <li>Run any <a href="https://dom.spec.whatwg.org/#concept-node-clone-ext">cloning steps</a> defined for <var>node</var> in <a href="https://dom.spec.whatwg.org/#other-applicable-specifications">other applicable specifications</a> and pass <var>copy</var>, <var>node</var>, <var>document</var> and the <i>clone children flag</i> if set, as parameters.
        </li>

        <li>If the <i>clone children flag</i> is set, <a href="#concept-node-clone">clone</a> all the <a href="https://dom.spec.whatwg.org/#concept-tree-child">children</a> of <var>node</var> and append them to <var>copy</var>, with <var>document</var> as specified and the <i>clone children flag</i> being set.
        </li>

        <li>Return <var>copy</var>.</li>
      </ol>
    </section>

    <section>
      <h2>DOM: Mutation algorithms</h2>

      <p>To <dfn id="concept-node-insert">insert</dfn> a <var>node</var> into a <var>parent</var> before a <var>child</var>, with an optional <i>suppress observers flag</i>, run these steps:</p>

      <ol>
        <li>Let <var>count</var> be the number of <a href="https://dom.spec.whatwg.org/#concept-tree-child">children</a> of <var>node</var> if it is a <code><a href="https://dom.spec.whatwg.org/#documentfragment">DocumentFragment</a></code> <a href="https://dom.spec.whatwg.org/#concept-node">node</a>, and one otherwise.
        </li>

        <li>If <var>child</var> is non-null, run these substeps:

          <ol>
            <li>For each <a href="https://dom.spec.whatwg.org/#concept-range">range</a> whose <a href="https://dom.spec.whatwg.org/#concept-range-start-node">start node</a> is <var>parent</var> and <a href="https://dom.spec.whatwg.org/#concept-range-start-offset">start offset</a> is greater than <var>child</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-index">index</a>, increase its <a href="https://dom.spec.whatwg.org/#concept-range-start-offset">start offset</a> by <var>count</var>.
            </li>

            <li>For each <a href="https://dom.spec.whatwg.org/#concept-range">range</a> whose <a href="https://dom.spec.whatwg.org/#concept-range-end-node">end node</a> is <var>parent</var> and <a href="https://dom.spec.whatwg.org/#concept-range-end-offset">end offset</a> is greater than <var>child</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-index">index</a>, increase its <a href="https://dom.spec.whatwg.org/#concept-range-end-offset">end offset</a> by <var>count</var>.
            </li>
          </ol>
        </li>

        <li>Let <var>nodes</var> be <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-child">children</a> if <var>node</var> is a <code><a href="https://dom.spec.whatwg.org/#documentfragment">DocumentFragment</a></code> <a href="https://dom.spec.whatwg.org/#concept-node">node</a>, and a list containing solely <var>node</var> otherwise.
        </li>

        <li>If <var>node</var> is a <code><a href="https://dom.spec.whatwg.org/#documentfragment">DocumentFragment</a></code> <a href="https://dom.spec.whatwg.org/#concept-node">node</a>, <a href="#concept-node-remove">remove</a> its <a href="https://dom.spec.whatwg.org/#concept-tree-child">children</a> with the <i>suppress observers flag</i> set.
        </li>

        <li>If <var>node</var> is a <code><a href="https://dom.spec.whatwg.org/#documentfragment">DocumentFragment</a></code> <a href="https://dom.spec.whatwg.org/#concept-node">node</a>, <a href="https://dom.spec.whatwg.org/#queue-a-mutation-record">queue a mutation record</a> of "<code>childList</code>" for <var>node</var> with removedNodes <var>nodes</var>.

          <p class="note no-backref" role="note">This step intentionally does not pay attention to the <i>suppress observers flag</i>.</p>
        </li>

        <li>
          <p>For each <var>node</var> in <var>nodes</var>, in <a href="https://dom.spec.whatwg.org/#concept-tree-order">tree order</a>, run these substeps:</p>

          <ol>
            <li>
              <p>Insert <var>node</var> into <var>parent</var> before <var>child</var> or at the end of <var>parent</var> if <var>child</var> is null.</p>
            </li>

            <li>
              <p>If <var>parent</var> is a <a href="https://dom.spec.whatwg.org/#element-shadow-host">shadow host</a> and <var>node</var> is a <a href="https://dom.spec.whatwg.org/#concept-slotable">slotable</a>, then <a href="https://dom.spec.whatwg.org/#assign-a-slot">assign a slot</a> for <var>node</var>.</p>
            </li>

            <li>
              <p>If <var>parent</var> is a <a href="https://dom.spec.whatwg.org/#concept-slot">slot</a> whose <a href="https://dom.spec.whatwg.org/#slot-assigned-nodes">assigned nodes</a> is the empty list, then run <a href="https://dom.spec.whatwg.org/#signal-a-slot-change">signal a slot change</a> for <var>parent</var>.</p>
            </li>

            <li>
              <p>Run <a href="https://dom.spec.whatwg.org/#assign-slotables-for-a-tree">assign slotables for a tree</a> with <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree">tree</a> and a set containing each <a href="https://dom.spec.whatwg.org/#concept-tree-inclusive-descendant">inclusive descendant</a> of <var>node</var> that is a <a href="https://dom.spec.whatwg.org/#concept-slot">slot</a>.</p>
            </li>

            <li>
              <p>For each <a href="https://dom.spec.whatwg.org/#concept-shadow-including-inclusive-descendant">shadow-including inclusive descendant</a> <var>inclusiveDescendant</var> of <var>node</var>, in <a href="https://dom.spec.whatwg.org/#concept-shadow-including-tree-order">shadow-including tree order</a>, run these subsubsteps:</p>

              <ol>
                <li>
                  <p>Run the <a href="https://dom.spec.whatwg.org/#concept-node-insert-ext">insertion steps</a> with <var>inclusiveDescendant</var>.</p>
                </li>

                <li>
                  <p>If <var>inclusiveDescendant</var> is <a href="https://dom.spec.whatwg.org/#connected">connected</a>, then:</p>

                  <ol>
                    <li>
                      <p>If <var>inclusiveDescendant</var> is <a href="#concept-element-custom">custom</a>, then <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>inclusiveDescendant</var>, callback name "<code>connectedCallback</code>", and an empty argument list.</p>
                    </li>

                    <li>
                      <p>Otherwise, <a href="#concept-try-upgrade">try to upgrade</a> <var>inclusiveDescendant</var>.</p>

                      <p class="note" role="note">If this successfully upgrades <var>inclusiveDescendant</var>, its <code>connectedCallback</code> will be enqueued automatically during the <a href="#concept-upgrade-an-element">upgrade an element</a> algorithm.</p>
                    </li>
                  </ol>
                </li>
              </ol>
            </li>
          </ol>
        </li>

        <li>If <i>suppress observers flag</i> is unset, <a href="https://dom.spec.whatwg.org/#queue-a-mutation-record">queue a mutation record</a> of "<code>childList</code>" for <var>parent</var> with addedNodes <var>nodes</var>, nextSibling <var>child</var>, and previousSibling <var>child</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-previous-sibling">previous sibling</a> or <var>parent</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-last-child">last child</a> if <var>child</var> is null.
        </li>
      </ol>

      <p>To <dfn id="concept-node-remove">remove</dfn> a <var>node</var> from a <var>parent</var>, with an optional <i>suppress observers flag</i>, run these steps:</p>

      <ol>
        <li>Let <var>index</var> be <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-index">index</a>.
        </li>

        <li>For each <a href="https://dom.spec.whatwg.org/#concept-range">range</a> whose <a href="https://dom.spec.whatwg.org/#concept-range-start-node">start node</a> is an <a href="https://dom.spec.whatwg.org/#concept-tree-inclusive-descendant">inclusive descendant</a> of <var>node</var>, set its <a href="https://dom.spec.whatwg.org/#concept-range-start">start</a> to (<var>parent</var>, <var>index</var>).
        </li>

        <li>For each <a href="https://dom.spec.whatwg.org/#concept-range">range</a> whose <a href="https://dom.spec.whatwg.org/#concept-range-end-node">end node</a> is an <a href="https://dom.spec.whatwg.org/#concept-tree-inclusive-descendant">inclusive descendant</a> of <var>node</var>, set its <a href="https://dom.spec.whatwg.org/#concept-range-end">end</a> to (<var>parent</var>, <var>index</var>).
        </li>

        <li>For each <a href="https://dom.spec.whatwg.org/#concept-range">range</a> whose <a href="https://dom.spec.whatwg.org/#concept-range-start-node">start node</a> is <var>parent</var> and <a href="https://dom.spec.whatwg.org/#concept-range-start-offset">start offset</a> is greater than <var>index</var>, decrease its <a href="https://dom.spec.whatwg.org/#concept-range-start-offset">start offset</a> by one.
        </li>

        <li>For each <a href="https://dom.spec.whatwg.org/#concept-range">range</a> whose <a href="https://dom.spec.whatwg.org/#concept-range-end-node">end node</a> is <var>parent</var> and <a href="https://dom.spec.whatwg.org/#concept-range-end-offset">end offset</a> is greater than <var>index</var>, decrease its <a href="https://dom.spec.whatwg.org/#concept-range-end-offset">end offset</a> by one.
        </li>

        <li>
          <p>For each <code><a href="https://dom.spec.whatwg.org/#nodeiterator">NodeIterator</a></code> object <var>iterator</var> whose <a href="https://dom.spec.whatwg.org/#concept-traversal-root">root</a>’s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> is <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a>, run the <a href="https://dom.spec.whatwg.org/#nodeiterator-pre-removing-steps"><code>NodeIterator</code> pre-removing steps</a> given <var>node</var> and <var>iterator</var>.</p>
        </li>

        <li>Let <var>oldPreviousSibling</var> be <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-previous-sibling">previous sibling</a>.
        </li>

        <li>Let <var>oldNextSibling</var> be <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree-next-sibling">next sibling</a>.
        </li>

        <li>Remove <var>node</var> from its <var>parent</var>.</li>

        <li>
          <p>If <var>node</var> is <a href="https://dom.spec.whatwg.org/#slotable-assigned">assigned</a>, then run <a href="https://dom.spec.whatwg.org/#assign-slotables">assign slotables</a> for <var>node</var>’s <a href="https://dom.spec.whatwg.org/#slotable-assigned-slot">assigned slot</a>.</p>
        </li>

        <li>
          <p>If <var>parent</var> is a <a href="https://dom.spec.whatwg.org/#concept-slot">slot</a> whose <a href="https://dom.spec.whatwg.org/#slot-assigned-nodes">assigned nodes</a> is the empty list, then run <a href="https://dom.spec.whatwg.org/#signal-a-slot-change">signal a slot change</a> for <var>parent</var>.</p>
        </li>

        <li>
          <p>If <var>node</var> has an <a href="https://dom.spec.whatwg.org/#concept-tree-inclusive-descendant">inclusive descendant</a> that is a <a href="https://dom.spec.whatwg.org/#concept-slot">slot</a>, then:</p>

          <ol>
            <li>
              <p>Run <a href="https://dom.spec.whatwg.org/#assign-slotables-for-a-tree">assign slotables for a tree</a> with <var>parent</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree">tree</a>.</p>
            </li>

            <li>
              <p>Run <a href="https://dom.spec.whatwg.org/#assign-slotables-for-a-tree">assign slotables for a tree</a> with <var>node</var>’s <a href="https://dom.spec.whatwg.org/#concept-tree">tree</a> and a set containing each <a href="https://dom.spec.whatwg.org/#concept-tree-inclusive-descendant">inclusive descendant</a> of <var>node</var> that is a <a href="https://dom.spec.whatwg.org/#concept-slot">slot</a>.</p>
            </li>
          </ol>
        </li>

        <li>
          <p>Run the <a href="https://dom.spec.whatwg.org/#concept-node-remove-ext">removing steps</a> with <var>node</var> and <var>parent</var>.</p>
        </li>

        <li>
          <p>If <var>node</var> is <a href="#concept-element-custom">custom</a>, then <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>node</var>, callback name "<code>disconnectedCallback</code>", and an empty argument list.</p>

          <p class="note" role="note">It is intentional for now that <a href="#concept-element-custom">custom</a> <a href="https://dom.spec.whatwg.org/#concept-element">elements</a> do not get <var>parent</var> passed. This might change in the future if there is a need.</p>
        </li>

        <li>
          <p>For each <a href="https://dom.spec.whatwg.org/#concept-shadow-including-descendant">shadow-including descendant</a> <var>descendant</var> of <var>node</var>, in <a href="https://dom.spec.whatwg.org/#concept-shadow-including-tree-order">shadow-including tree order</a>, run these substeps:</p>

          <ol>
            <li>
              <p>Run the <a href="https://dom.spec.whatwg.org/#concept-node-remove-ext">removing steps</a> with <var>descendant</var>.</p>
            </li>

            <li>
              <p>If <var>descendant</var> is <a href="#concept-element-custom">custom</a>, then <a href="#enqueue-a-custom-element-callback-reaction">enqueue a custom element callback reaction</a> with <var>descendant</var>, callback name "<code>disconnectedCallback</code>", and an empty argument list.</p>
            </li>
          </ol>
        </li>

        <li>For each <a href="https://dom.spec.whatwg.org/#concept-tree-inclusive-ancestor">inclusive ancestor</a> <var>inclusiveAncestor</var> of <var>parent</var>, if <var>inclusiveAncestor</var> has any <a href="https://dom.spec.whatwg.org/#registered-observer">registered observers</a> whose <b>options</b>' <code><a href="https://dom.spec.whatwg.org/#dom-mutationobserverinit-subtree">subtree</a></code> is true, then for each such <a href="https://dom.spec.whatwg.org/#registered-observer">registered observer</a> <var>registered</var>, append a <a href="https://dom.spec.whatwg.org/#transient-registered-observer">transient registered observer</a> whose <b>observer</b> and <b>options</b> are identical to those of <var>registered</var> and <b>source</b> which is <var>registered</var> to <var>node</var>’s list of <a href="https://dom.spec.whatwg.org/#registered-observer">registered observers</a>.
        </li>

        <li>If <i>suppress observers flag</i> is unset, <a href="https://dom.spec.whatwg.org/#queue-a-mutation-record">queue a mutation record</a> of "<code>childList</code>" for <var>parent</var> with removedNodes a list solely containing <var>node</var>, nextSibling <var>oldNextSibling</var>, and previousSibling <var>oldPreviousSibling</var>.
        </li>
      </ol>
    </section>

    <section>
      <h2>DOM: Wide-ranging patches</h2>

      <p>All IDL attributes in DOM which could potentially cause DOM mutations have been updated to be annotated with the <code><a href="#cereactions">[CEReactions]</a></code> extended attribute.</p>

      <p>All places in DOM that create elements have been updated to use the new <a href="#concept-create-element">create an element</a> algorithm. At the time of this writing, apart from the above <a href="https://html.spec.whatwg.org/multipage/#dom-document-createelement"><code>createElement()</code></a> and <a href="https://html.spec.whatwg.org/multipage/#dom-document-createelementns"><code>createElementNS()</code></a> definitions, only <a href="https://dom.spec.whatwg.org/#dom-domimplementation-createhtmldocument"><code>createHTMLDocument()</code></a> creates elements.</p>
    </section>
  </section>

  <section id="appendix-a" class="appendix informative">
    <h2>Acknowledgments</h2>

    <p>David Hyatt developed <a href="http://dev.w3.org/2006/xbl2/">XBL 1.0</a>, and Ian Hickson co-wrote <a href="http://dev.w3.org/2006/xbl2/">XBL 2.0</a>. These documents provided tremendous insight into the problem of behavior attachment and greatly influenced this specification.</p>

    <p>Alex Russell and his considerable forethought triggered a new wave of enthusiasm around the subject of behavior attachment and how it can be applied practically on the Web.</p>

    <p>Dominic Cooney, Hajime Morrita, and Roland Steiner worked tirelessly to scope the problem within the confines of the Web platform and provided a solid foundation for this document.</p>

    <p><a href="mailto:sfaulkner@paciellogroup.com">Steve Faulkner</a>, The Paciello Group, for what formed the basis of the introductory examples.</p>

    <div itemscope="" itemtype="http://n.whatwg.org/work">
      <p>The &lt;flag-icon&gt; example was inspired by <a itemprop="work" href="https://customelements.io/stevenrskelton/flag-icon/">a custom element</a> by <a itemprop="https://creativecommons.org/ns#attributionURL" href="http://stevenskelton.ca/">Steven Skelton</a>. (<a itemprop="license" href="https://opensource.org/licenses/MIT">MIT</a>)</p>
    </div>

    <p>The editor would also like to thank Alex Komoroske, Andres Rios, Anne van Kesteren, Boris Zbarsky, Daniel Buchner, Edward O'Connor, Erik Arvidsson, Elliott Sprehn, Hayato Ito, Jan Miksovsky, Jonas Sicking, Koji Ishii, Olli Pettay, Rafael Weinstein, Ryosuke Niwa, Scott Miles, Simon Pieters, Steve Orvell, Tab Atkins, Tim Perry, and William Chen for their comments and contributions to this specification.</p>
  </section>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>HTML Imports</title>
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common' async class='remove'></script>
    <script class='remove'>
      var respecConfig = {
          specStatus: "ED",
          shortName: "html-imports",
          useExperimentalStyles: true,
          editors: [
          { name: "Dimitri Glazkov", url: "mailto:dglazkov@chromium.org", company: "Google, Inc.", w3cid: 40456 },
          { name: "Hajime Morrita", url: "mailto:morrita@chromium.org", company: "Google, Inc.", w3cid: 50024 }],
          wg: "Web Platform Working Group",
          wgURI: "http://www.w3.org/WebPlatform/WG/",
          wgPublicList: "public-webapps",
          subjectPrefix: "[html-imports]",
          wgPatentURI: "http://www.w3.org/2004/01/pp-impl/83482/status",
          license: "w3c-software-doc",
          edDraftURI: "https://w3c.github.io/webcomponents/spec/imports/",
          issueBase: "https://github.com/w3c/webcomponents/issues/",
          otherLinks: [
              {
                  key: "Participate",
                  data: [
                    {value:"We are on Github", href:"https://github.com/w3c/webcomponents/labels/html-imports"},
                    {value:"Discuss on public-webapps@w3.org", href:"http://lists.w3.org/Archives/Public/public-webapps/"},
                    {value:"Web Platform Working Group", href:"http://www.w3.org/WebPlatform/WG/"}
                    ]
              },
              {
                  key: "Revision history",
                  href: "https://github.com/w3c/webcomponents/commits/gh-pages/spec/imports/"
              },
              {
                  key: "Bugs filed",
                  href: "https://github.com/w3c/webcomponents/labels/html-imports"
              },{
                 key: 'Implementation',
                 data: [{
                   value: 'Can I use HTML Imports?',
                   href: 'http://caniuse.com/#feat=imports'
              }, {
                   value: 'Test Suite',
                   href: 'http://w3c-test.org/html-imports/'
              }, {
                   value: 'Test Suite repository',
                   href: 'https://github.com/w3c/web-platform-tests/tree/master/html-imports'
      }]
    }
          ]
      };
    </script>
    <style>
div.algorithm {
    padding: 0 0 0 20px;
    border-left: 5px solid #EAF7F9;
}
var {
    font-size: 0.8em;
    color: #005A9C;
    font-style: normal;
}
</style>
</head>

<body>
<section id='abstract'>
  <p>HTML Imports are a way to include and reuse HTML documents in other HTML documents [[!HTML]].</p>
</section>

<section id='sotd'>
</section>

<section id="conformance">

<p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="https://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence">processing equivalence</dfn> is a constraint imposed on the algorithm implementers, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>
</section>

<section id="terminology">
<h2>Terminology</h2>

<p>HTML Imports, or just <dfn id="dfn-import" data-lt='import'>imports</dfn> from here on, are <a href="https://html.spec.whatwg.org/multipage/syntax.html">HTML documents</a> [[!HTML]] that are <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element">linked</a> as <a href="https://html.spec.whatwg.org/multipage/semantics.html#external-resource-link">external resources</a> from another <a href="https://html.spec.whatwg.org/multipage/syntax.html">HTML document</a>. The document that links to an <a>import</a> is called an <dfn id="dfn-import-referrer">import referrer</dfn>. For any given <a>import</a>, an <dfn id="dfn-import-referrer-ancestor">import referrer ancestor</dfn> is its <a>import referrer</a> or any <a>import referrer ancestor</a> of its <a>import referrer</a>. There are one or more <a data-lt="import referrer">import referrers</a> and <a data-lt="import referrer ancestor">import referrer ancestors</a> for each import because same import can be referred from multiple <a data-lt="import referrer">import referrers</a>.</p>

<p>An <a>import referrer</a> that is not an <a>import</a>, thus is not associated with any <a>import referrer</a>, is called a <dfn id="dfn-master-document">master document</dfn>. Each <a>import</a> is associated with one <a>master document</a>: if the <a data-lt="import referrer">referrer</a> of the <a>import</a> is a <a>master document</a>, it is the <a>master document</a> of the <a>import</a>. Otherwise, the <a>master document</a> of the <a>import referrer</a> is the <a>master document</a> of the <a>import</a>.</p>

<p>The <a href="https://dom.spec.whatwg.org/#concept-document-url">URL</a> of an <a>import</a> is called the <dfn id="dfn-import-location">import location</dfn><!--, and the <a href="https://html.spec.whatwg.org/multipage/origin-0.html#origin">origin</a> of the <a>import location</a> is called <dfn id="dfn-import-origin">import origin</dfn>-->.</p>

<p>In each <a>import referrer</a>, an <a>import</a> is represented as a <a href="https://dom.spec.whatwg.org/#interface-document"><code>Document</code></a> [[!WHATWG-DOM]], called the <dfn id="dfn-imported-document">imported document</dfn>.<p>

<p class='issue' data-number='197'>The <a data-lt="imported document">imported documents</a> don't have <a href="https://html.spec.whatwg.org/multipage/browsers.html#browsing-context">browsing context</a>.</p>

<p>The set of all <a data-lt="import">import</a> associated with the <a>master document</a> forms an <dfn id="dfn-import-map">import map</dfn> of the <a>master document</a>. The maps stores <a data-lt="import">import</a> as its items with their <a data-lt="import location">import locations</a> as keys. The import map is empty at beginning. New items are added to the map as <a data-lt="import fetching">import fetching algorithm</a> specifies.</p>

<section id="import-dependent">
<h3>Import Dependent</h3>

<p>To track <a href="#requesting-import">requested</a> imports, each document has an <dfn id="dfn-import-link-list">import link list</dfn>. Each of its item consists of <dfn id="dfn-import-link-link">link</dfn>, a <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element">link</a></code> element and <dfn id="import-link-list-location">location</dfn>, a URL.
Also, the item is optionally <dfn id="dfn-import-link-list-branch">marked as branch</dfn>.
The list is initially empty, and items are added to it as specified by the <a>import request</a> algorithm.</p>

<p>Each <a>imported document</a> has an <a>import parent</a>: If the <a>import link list</a> of document <var>A</var> contains a <a data-lt='marked as branch'>branch</a> item whose <a>location</a> points document <var>B</var>, <var>A</var> is an <dfn id="dfn-import-parent">import parent</dfn> of <var>B</var>.</a></p>

<p>Each <a>imported document</a> also has one or more <dfn id="dfn-import-ancestor" data-lt='import ancestor'>import ancestors</dfn>: Document <var>A</var> is an <a>import ancestor</a> of another document <var>B</var> if <var>A</var> is <a>import parent</a> of <var>B</var>. Being an <a data-lt="import ancestor">import ancestor</a> is transitive: If <var>A</var> is an <a>import parent</a> of <var>B</var> and <var>B</var> is an <a>import parent</a> of <var>C</var>, <var>A</var> is an <a>import parent</a> of <var>C</var> as well.</p>

<p>An <a>imported document</a> also has one or more <dfn id="dfn-import-predecessor" data-lt='import predecessor'>import predecessors</dfn>. An <a>import predecessor</a> is a document. If the URL of document <var>A</var> is located before the URL of document <var>B</var> in the <a>import link list</a> of <var>B</var>'s <a>import parent</a>, and the located <a>link</a> is marked as a <a data-lt='marked as branch'>branch</a>, then <var>A</var> is <a>import predecessor</a> of <var>B</var>.</p>

<p>The <dfn id="dfn-import-ancestor-predecessor" data-lt='import ancestor predecessor'>import ancestor predecessors</dfn> of document <var>A</var> is defined as follows: If document <var>B</var> is an <a>import predecessor</a> of document <var>C</var>, and <var>C</var> is an <a>import ancestor</a> of <var>A</var>, <var>B</var> is an <a>import ancestor predecessors</a> of <var>A</var>.</p>

<p>The <a href="https://html.spec.whatwg.org/multipage/dom.html#document"><code>Document</code></a> that is in either <a>import ancestor predecessors</a> or <a>import predecessors</a> of document <var>A</var>, or is linked from <a data-lt='marked as branch'>branch</a> item of <var>A</var>'s <a>import link list</a>, is the <dfn id="dfn-import-dependent">import dependent</dfn> of <var>A</var>.</p>

<div class="informative">
<p>The <a>import link list</a> and the <a>import dependent</a> constrains the order of script execution in imports. It is intend to give a deterministic order of script execution which is defined by the order of <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> element in each import. The edges of each node is ordered in terms of <a>import link list</a>. The <a>import predecessors</a> selection is aware of the order.</p>

<p>The linking structure of <a data-lt="import link list">import link lists</a> forms a directed graph. Each node of the graph is a document and its edge is a <a>link</a>. <a data-lt='marked as branch'>Branches</a> are intended to form a spanning tree of the graph. This tree gives the deterministic order of the script execution.</p>

<figure id="fig-import-list">
  <img src="import-link-list.png">
  <figcaption>An example of import link lists</figcaption>
</figure>

<p>
In <a href='#fig-import-list'></a>,
</p>
<ul>
  <li>The document <var>A</var> has an <a>import link list</a> which contains a link to <var>B</var> and another link to <var>C</var>.
  <li>The document <var>D</var> has a couple of <a>import ancestors</a> that are <var>A</var> and <var>B</var>.
  <li>As <var>B</var> is a <a>import ancestor</a> of <var>D</var>, one of <var>D</var>'s list item that points <var>B</var> is not marked as a <a data-lt='marked as branch'>branch</a>.
  <li>Even though the document <var>D</var> is linked from two documents <var>B</var> and <var>C</var>, its <a>import parent</a> is <var>B</var> because <var>B</var> has a <a>link</a> to <var>D</var> which is marked as a <a data-lt='marked as branch'>branch</a>.
  <li>Look at <var>E</var>:
    <ul>
      <li><var>E</var> doesn't have any <a>import predecessors</a>. The link to <var>D</var> from <var>C</var> is not marked as <a data-lt='marked as branch'>branch</a>, and the link to <var>G</var> isn't located before one to <var>E</var>.</li>
      <li><var>E</var>'s <a>import ancestors</a> are <var>A</var> and <var>C</var>.
      <li><var>E</var>'s <a>import ancestor predecessor</a> is <var>B</var> because <a>import predecessors</a> of <var>C</var> is <var>B</var> and <var>A</var> has no <a>import predecessors</a>.
      <li><var>E</var>'s <a>import link list</a> contains <var>H</var> which is marked as a <a data-lt='marked as branch'>branch</a>.</li>
      <li>Thus <var>E</var>'s <a data-lt="import dependent">import dependents</a> are <var>B</var>, an <a>import ancestor predecessor</a>, and <var>H</var>, an item of an <a>import link list</a>.</li>
    </ul>
  </li>
  <li>Look at <var>G</var>:
    <ul>
      <li><var>G</var>'s <a>import predecessors</a> is <var>E</var>.</li>
      <li><var>G</var>'s <a>import ancestor predecessor</a> is same as <var>E</var>'s, which is <var>B</var>.</li>
      <li><var>G</var>'s <a>import link list</a> is empty.</li>
      <li>Thus <var>G</var>'s <a data-lt="import dependent">import dependents</a> are <var>B</var>, an <a>import ancestor predecessor</a>, and <var>E</var>, an <a>import predecessors</a>.</li>
    </ul>
  </li>
</ul>

<p>The difference between the <a>import referrer</a> and the <a>import parent</a> is that <a>import referrer</a> reflects the state of the <a href="http://www.w3.org/TR/dom/#node-tree">node tree</a> and that the <a>import parent</a> is built by the algorithm described in this document.</p>

</div>
</section>
</section>

<section id="link-type-import">
<h2>Link Type "<code>import</code>"</h2>

<p>To enable declaring <a data-lt="import">import</a> in HTML, a new link type is added to <a href="https://html.spec.whatwg.org/multipage/semantics.html#linkTypes">HTML link types</a>:</p>

<section class="monkeypatch">
<p>The <a id="#link-type-import"><code>import</code></a> keyword may be used with <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> elements. This keyword creates an <a href="https://html.spec.whatwg.org/multipage/semantics.html#external-resource-link">external resource link</a> to an <a>import</a>.</p>

<p>The default type for resources given by the <a href="#link-type-import"><code>import</code></a> keyword is <code>text/html</code>.</p>

<p>The <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> element may have an <dfn id="dfn-import-async-attribute">async</dfn> attribute. The <a><code>async</code></a> attribute is a <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#boolean-attributes">boolean attribute</a>.

<p>The appropriate time to <dfn id="dfn-obtaining-import" data-lt="obtaining import">fetch</dfn> the resource is when the <a href="https://html.spec.whatwg.org/multipage/semantics.html#external-resource-link">external resource link</a> is created or when its element is <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#insert-an-element-into-a-document">inserted into a document</a>, whichever happens last.</p>

<p>The import is fetched and applied regardless of the <a href="https://html.spec.whatwg.org/multipage/semantics.html#attr-link-media"><code>media</code></a> attribute of the <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> matches the environment or not.</p>

</section>

<aside class="example" id='hearts-example'>
<p>The following document has one import, located at <code>/imports/heart.html</code>:</p>

<pre class="highlight">
&lt;!DOCTYPE html&gt;
&lt;html lang="en-US"&gt;
    &lt;head&gt;
        &lt;title&gt;Human Being&lt;/title&gt;
        &lt;link rel="import" href="/imports/heart.html"&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;p&gt;What is a body without a heart?&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre>
</aside>
</section>

<section id="interface-import">
<h2>Extensions to <code>HTMLLinkElement</code> Interface</h2>

<pre class="idl">
partial interface HTMLLinkElement {
    readonly attribute Document? import;
};
</pre>

<p>On getting, the <dfn for="HTMLLinkElement">import</dfn> attribute MUST return <strong>null</strong>, if:</p>
<ul>
        <li>The <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> does not <a href="https://html.spec.whatwg.org/multipage/dom.html#represents">represent</a> an <a>import</a></li>
    <li>the <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> element is not <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-a-document">in a <code>Document</code></a></li>
</ul>
<p>Otherwise, the attribute MUST return the <a>imported document</a> for the <a>import</a>, represented by the <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> element.</p>

<p>The same object MUST be returned each time.</p>

<aside class="example" id='import-dom-access'>
<p>Here's how one could access the imported document, mentioned in <a href='#hearts-example'>previous example</a>:</p>
<pre class="highlight">
var link = document.querySelector('link[rel=import]');
var heart = link.import;
// Access DOM of the document in /imports/heart.html
var pulse = heart.querySelector('div.pulse');
</pre>
</aside>

<p>An <a>import</a> in the context of the <a href="https://html.spec.whatwg.org/multipage/dom.html#document"><code>Document</code></a> of an <a href="https://html.spec.whatwg.org/multipage/syntax.html#html-parser">HTML parser</a> or <a href="https://html.spec.whatwg.org/multipage/xhtml.html#xml-parser">XML Parser</a> is said to be <dfn id="dfn-an-import-that-is-blocking-scripts">an import that is blocking scripts</dfn> if the <a href="https://dom.spec.whatwg.org/#concept-element">element</a> was created by that <a href="https://html.spec.whatwg.org/multipage/dom.html#document"><code>Document</code></a>'s parser, or and the <a href="https://dom.spec.whatwg.org/#concept-element">element</a> is a <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> of type <a href="#link-type-import"><code>import</code></a> when the <a href="https://dom.spec.whatwg.org/#concept-element">element</a> was created by the parser, and the <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> is not <a data-lt="async">marked as async</a>, and the the import is yet to be <a href="https://html.spec.whatwg.org/multipage/syntax.html#completely-loaded">completely loaded</a>, and, the last time the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loop">event loop</a> has reached step 1, the <a href="https://dom.spec.whatwg.org/#concept-element">element</a> was <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-a-document">in that <code>Document</code></a>, and the user agent hasn't given up on that <a>import</a> yet. A user agent MAY give up on an <a>import</a> at any time.</p>


<p class='note'>
Giving up an import before it loads, even if the import eventually does still load, means that the script might end up operating with incorrect information. For example, if an import registers a custom element and a script relies on the availability of this element, the script will find that this element is unavailable if the user agent gives up early. Implementers have to balance the likelihood of a script using incorrect information with the performance impact of doing nothing while waiting for a slow network request to finish.
</p>

<p>A <a href="https://html.spec.whatwg.org/multipage/dom.html#document"><code>Document</code></a> <dfn id="dfn-has-an-import-that-is-blocking-scripts">has an import that is blocking scripts</dfn> if there is <a>an import that is blocking scripts</a> in the <a href="https://html.spec.whatwg.org/multipage/dom.html#document"><code>Document</code></a>'s <a>import dependent</a>.
A <a href="https://html.spec.whatwg.org/multipage/dom.html#document"><code>Document</code></a> <dfn id="dfn-has-no-import-that-is-blocking-scripts">has no import that is blocking scripts</dfn> if it does not <a data-lt='has an import that is blocking scripts'>have an import that is blocking scripts</a> as defined in the previous paragraph.</p>

<p class='note'>The state of "<a>has an import that is blocking scripts</a>" can change each time an existing import is completely loaded or new import loading is started. HTML parser has changes to unblock it for each of such timings.</p>
</p>
</section>

<section id="interface-document">
<h2>Extensions to <code>Document</code> Interface</h2>

<section id="additions-to-document-open">
<h3>Additions to <code>document.open()</code> method</h3>

<p>Add following step as the first step of the definition:</p>

<div class="monkeypatch">
<ol>
  <li>Throws an <code><a href="https://html.spec.whatwg.org/multipage/infrastructure.html#invalidstateerror">InvalidStateError</a></code> exception if the <a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a> is an <a>import</a>.</li>
</ol>
</div>
</section>
<section id="additions-to-document-write">
<h3>Additions to <code>document.write()</code> method</h3>

<p>Add following step as the first step of the definition:</p>

<div class="monkeypatch">
<ol>
  <li>Throws an <code><a href="https://html.spec.whatwg.org/multipage/infrastructure.html#invalidstateerror">InvalidStateError</a></code> exception if the <a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a> is an <a>import</a>.</li>
</ol>
</div>
</section>
<section id="additions-to-document-close">
<h3>Additions to <code>document.close()</code> method</h3>

<p>Add following step as the first step of the definition:</p>

<div class="monkeypatch">
<ol>
  <li>Throws an <code><a href="https://html.spec.whatwg.org/multipage/infrastructure.html#invalidstateerror">InvalidStateError</a></code> exception if the <a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a> is an <a>import</a>.</li>
</ol>
</div>

</section>
</section>

<section id="loading-imports">
<h2>Loading Imports</h2>

<section id="updateing-branch">
<h3>Updating Branch</h3>

<p>After a <a>link</a> is added to the <a>import link list</a>, the <dfn id="dfn-update-marking">update marking</dfn> algorithm MUST be run with the <a>master document</a>. which is <a data-lt="processing equivalence">equivalent</a> to running these steps:</p>

<dl>
<dt>Input</dt>
<dd><var>DOCUMENT</var>, the <a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a></dd>
</dl>

<ol>
  <li>If the <var>DOCUMENT</var> is the <a>master document</a>, unmark <a data-lt='marked as branch'>branch</a> of all the <a data-lt="link">links</a> in the <a>import link list</a> of <var>DOCUMENT</var> and every <a data-lt="imported document">import</a> that is associated to <var>DOCUMENT</var>.</li>
  <li>Let <var>LIST</var> be an <a>import link list</a> of <var>DOCUMENT</var>.</li>
  <li>For each <var>ITEM</var> in the <var>LIST</var>:</li>
  <li><ol>
    <li>Let <var>LOCATION</var> be a <a>location</a> of <var>ITEM</var>.</li>
    <li>Let <var>IMPORT</var> be an <a>import</a> whose URL is same as <var>LOCATION</var>.</li>
    <li>If there is no other <a>link</a> whose <a>location</a> is same as <var>LOCATION</var> and which is marked as a <a data-lt='marked as branch'>branch</a>, mark <var>ITEM</var> as a <a data-lt='marked as branch'>branch</a>.</li>
    <li>If <var>ITEM</var> is marked as a <a data-lt='marked as branch'>branch</a> and <var>IMPORT</var> is not <strong>null</strong>, invoke <a>update marking</a> algorithm with <var>IMPORT</var>.</li>
  </ol></li>
</ol>

</section>

<section id="requesting-import">
<h3>Requesting Import</h3>

<p>When user agents attempt to <a data-lt="obtaining import">obtain</a> a linked import, they MUST also run the <dfn id="dfn-import-request">import request</dfn> algorithm, which is <a data-lt="processing equivalence">equivalent</a> to running these steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
<dd><var>LINK</var>, the <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> element that creates an <a href="https://html.spec.whatwg.org/multipage/semantics.html#external-resource-link">external resource link</a> to the import.</dd>
<dd><var>LOCATION</var>, the <a href="https://dom.spec.whatwg.org/#concept-document-url">URL</a> of the linked resource.</dd>
</dl>
<ol class='algorithm'>
  <li>If the <a>async</a> attribute of <var>LINK</var> is true, mark <var>LINK</var> as <a>async</a>.
  <li>Let <var>DOCUMENT</var> be a document of <var>LINK</var>.
  <li>Let <var>LIST</var> be an <a>import link list</a> of <var>DOCUMENT</var>.
  <li>Let <var>ITEM</var> be <var>LINK</var> and <var>LOCATION</var>:</li>
  <li><ol>
    <li>Add <var>ITEM</var> at the end of <var>LIST</var>.
    <li>Invoke <a>update marking</a> algorithm with the <a>master document</a>.
  </ol></li>
</ol>
</div>

</section>

<section id="fetching-import">
<h3>Fetching Import</h3>

<p>All <a data-lt="import">import</a> linked from documents that is the <a>master document</a> or the one in the <a>import map</a> MUST be fetched using the <a data-lt="import fetching">import fetching algorithm</a> described below, instead of the one that HTML specifies to <a href="https://html.spec.whatwg.org/multipage/semantics.html#concept-link-obtain">obtain a linked resouce</a>.</a></p>

<p>The <dfn id="dfn-import-fetching">import fetching</dfn> algorithm MUST be <a data-lt="processing equivalence">equivalent</a> to running these steps:</p>
<div class="algorithm">
<dl>
<dt>Input</dt>
<dd><var>LINK</var>, a <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> element which makes the <a href="https://html.spec.whatwg.org/multipage/semantics.html#external-resource-link">external resource link</a> to the import.</dd>
<dd><var>LOCATION</var>, the <a>import location</a></dd>
<dt>Output</dt>
<dd><var>IMPORT</var>, the <a>imported document</a>.</dd>
</dl>
<ol class='algorithm'>
    <li>If <var>LOCATION</var> is already in the <a>import map</a>:
    <ol>
      <li>Let <var>IMPORT</var> be the <a>imported document</a> for <var>LOCATION</var> and <strong>stop</strong>.</li>
    </ol></li>
    <li><a href="https://fetch.spec.whatwg.org/#concept-fetch">Fetch a resource</a>  [[!Fetch]] from <var>LOCATION</var> with <a href="https://fetch.spec.whatwg.org/#concept-request-origin">request's origin</a> set to the <a href="https://html.spec.whatwg.org/multipage/browsers.html#origin">origin</a> of the <a>master document</a>, the <a href="https://fetch.spec.whatwg.org/#concept-request-mode">mode</a> to <i>CORS</i> and the <a href="https://fetch.spec.whatwg.org/#concept-request-credentials-mode">credentials mode</a> to <i>same-origin</i>.
    <ol>
        <li>If fetched <a href="https://fetch.spec.whatwg.org/#concept-response-type">response type</a> is <i>error</i> or the response has a <a href="https://fetch.spec.whatwg.org/#concept-header">header</a> whose name is <code>Content-Disposition</code>:
        <ul>
          <li>Add <var>LOCATION</var> and <strong>null</strong> to the <a>import map</a> and <strong>stop</strong>.
        </ul></li>
        <li>Let <var>IMPORT</var> be a new <a href="https://dom.spec.whatwg.org/#document"><code>Document</code></a>, <a href="https://html.spec.whatwg.org/multipage/dom.html#the-document's-address">the document's address</a> of which is <var>LOCATION</var></li>
        <li>Let <var>PARSER</var> be a new <a href="https://html.spec.whatwg.org/multipage/syntax.html#html-parser">HTML parser</a>, associated with <var>IMPORT</var></li>
        <li>Add <var>LOCATION</var> and <var>IMPORT</var> to the <a>import map</a>.</li>
        <li>For each <a href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-task">task</a> that the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-task">networking task source</a> places on the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#task-queue">task queue</a> while fetching:
        <ol>
            <li>Fill <var>PARSER</var>'s <a href="https://html.spec.whatwg.org/multipage/syntax.html#the-input-byte-stream">input byte stream</a> with the fetched bytes</li>
            <li>Let <var>PARSER</var> process the <a href="https://html.spec.whatwg.org/multipage/syntax.html#the-input-byte-stream">input byte stream</a> with <a href="https://encoding.spec.whatwg.org/#utf-8">utf-8</a> [[!WHATWG-ENCODING]] as <a href="https://html.spec.whatwg.org/multipage/syntax.html#a-known-definite-encoding">a known definite encoding</a></li>
        </ol></li>
        <li>When no more bytes are available:
        <ol>
            <li><a href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task">Queue a task</a> from the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source">networking task source</a> for <var>PARSER</var> to process implied <code>EOF</code> character</li>
        </ol>
    </ol></li>
</ol>
</div>

<p class="note">
All of loaded imports and imports under loading are in the <a>import link list</a>, thus every <a>import</a> which is linked from imports in the list will also be loaded using the <a>import fetching</a> algorithm, with  <var>LOCATION</var> be the <a>import location</a> of the import.
</p>

<p>
The loading attempt MUST be considered successful if <var>IMPORT</var> is not null on the algorithm completion, and failed otherwise.
</p>

<p>Every import that is not <a data-lt="async">marked as async</a> <a href="https://html.spec.whatwg.org/multipage/syntax.html#delay-the-load-event">delays the load event in the Document</a>.

<div class="note">
<p>The <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> element <a href="https://html.spec.whatwg.org/multipage/webappapis.html#fire-a-simple-event">fires a simple event</a> called <code>load</code>
for successful loading attempt. For failed attempt, it <a href="https://html.spec.whatwg.org/multipage/webappapis.html#fire-a-simple-event">fires a simple event</a> named <code>error</code>.</p>
<p>As an import delays the load event, the <a href="https://dom.spec.whatwg.org/#document"><code>Document</code></a> isn't <a href="https://html.spec.whatwg.org/multipage/syntax.html#completely-loaded">completely loaded</a> until loading attempts of all of its linked imports are finished.</p>
</div>

</section>

<section id="imports-and-csp">
<h3>Imports and Content Security Policy</h3>

<p>
<a href="http://w3c.github.io/webappsec-csp/">Content Security Policy</a> [[!CSP3]] MUST restrict import loading through the <a href="http://w3c.github.io/webappsec-csp/#script-src">script-src</a> directive.
</p>

<p>
Each import MUST be restricted by the Content Security Policy of the <a>master document</a>.
For example, if <a href="http://w3c.github.io/webappsec-csp/#csp-header">Content Security Header Field</a> is sent to an import, the user agent MUST <a href="http://w3c.github.io/webappsec-csp/#enforced">enforce</a> the policy of the <a>master document</a> to the imported document.
</p>

</section>
</section>

<section id="parsing-imports">
<h2>Parsing Imports</h2>

<p>Parsing behaviour of <a data-lt="import">import</a> is defined as a set of changes to the <a href="https://html.spec.whatwg.org/multipage/syntax.html#parsing">HTML Parsing</a>.</p>

<section id="additions-to-prepare-a-script-algorithm">
<h3>Additions to Prepare A Script Algorithm</h3>

<p>In step 15 of <a href="https://html.spec.whatwg.org/multipage/scripting.html#prepare-a-script">prepare a script</a> algorithm, modify the last part of condition which begins with <em>If element does not have a <code>src</code> attribute</em> to read:</p>
<section class="monkeypatch">
<p>... and the <a href="https://html.spec.whatwg.org/multipage/dom.html#document"><code>Document</code></a> of the <a href="https://html.spec.whatwg.org/multipage/syntax.html#html-parser">HTML parser</a> or <a href="https://html.spec.whatwg.org/multipage/xhtml.html#xml-parser">XML parser</a> that created the <a href="https://html.spec.whatwg.org/multipage/scripting.html#the-script-element"><code>script</code></a> element <a href="https://html.spec.whatwg.org/multipage/semantics.html#has-a-style-sheet-that-is-blocking-scripts">has a style sheet that is blocking scripts</a> or <a>has an import that is blocking scripts</a></p>
</section>

</section>

<section id="additions-to-tree-construction-algorithm">
<h3>Additions to Tree Construction Algorithm</h3>

<p>At the DOCTYPE part of section <a href="https://html.spec.whatwg.org/multipage/syntax.html#the-initial-insertion-mode">12.2.5.4.1 The "initial" insertion mode</a>, modify text <q>if the document is not an iframe srcdoc document...</q> as follows</a>

<section class="monkeypatch">
<p>if the document is not an iframe src document nor an <a>import</a>...</p>
</section>

<p>In sub-condition named <em>Otherwise</em> of condition <em>An end tag whose name is "script"</em> in <a href="https://html.spec.whatwg.org/multipage/syntax.html#parsing-main-incdata">"text" insertion mode</a>, modify step 3 to read:</p>
<section class="monkeypatch">
<ol start="3">
    <li>If the parser's <code><a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a></code> <a href="https://html.spec.whatwg.org/multipage/semantics.html#has-a-style-sheet-that-is-blocking-scripts">has a style sheet that is blocking scripts</a> or <a>has an import that is blocking scripts</a> or <em>the script</em>'s <a href="https://html.spec.whatwg.org/multipage/scripting.html#ready-to-be-parser-executed">"ready to be parser-executed"</a> flag is not set: <a href="https://html.spec.whatwg.org/multipage/webappapis.html#spin-the-event-loop">spin the event loop</a> until the parser's <code><a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a></code> <a href="https://html.spec.whatwg.org/multipage/semantics.html#has-no-style-sheet-that-is-blocking-scripts">has no style sheet that is blocking scripts</a> and <a>has no import that is blocking scripts</a> and the script's <a href="https://html.spec.whatwg.org/multipage/scripting.html#ready-to-be-parser-executed">"ready to be parser-executed"</a> flag is set.</li>
</ol>
</section>

</section>

<section id="additions-to-parsing-xhtml-documents">
<h3>Additions to Parsing XHTML Documents</h3>

<p>Modify step 3 of steps that run following <a href="https://html.spec.whatwg.org/multipage/scripting.html#prepare-a-script">preparing</a> the <a href="https://html.spec.whatwg.org/multipage/scripting.html#the-script-element"><code>script</code></a> element to read:</p>
<section class="monkeypatch">
<ol start="3">
    <li><p><a href="https://html.spec.whatwg.org/multipage/webappapis.html#spin-the-event-loop">Spin the event loop</a> until the parser's <code><a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a></code> <a href="https://html.spec.whatwg.org/multipage/semantics.html#has-no-style-sheet-that-is-blocking-scripts">has no style sheet that is blocking scripts</a> and <a>has no import that is blocking scripts</a> and the <a href="https://html.spec.whatwg.org/multipage/scripting.html#pending-parsing-blocking-script">pending parsing-blocking script</a>'s <a href="https://html.spec.whatwg.org/multipage/scripting.html#ready-to-be-parser-executed">"ready to be parser-executed"</a> flag is set.</p></li>
</ol>
</section>

</section>
</section>

<section id="scripts-imports">
<h2>Scripting in Imports</h2>

<section id="additions-to-script-enabling-criteria">
<h3>Additions to Script Enabling Criteria</h3>

<p>Add following condition to the list of <a href="https://html.spec.whatwg.org/multipage/webappapis.html#enabling-and-disabling-scripting">Enabling and disabling scripting</a> criteria:</p>

<section class="monkeypatch">
<ul>
  <li>Scripting is enabled for a <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#node">node</a> if the <a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a> object of the node is in the <a>import map</a>.</li>
</ul>
</section>

</section>

<section id="additions-to-dom-document-currentscript">
<h3>Additions to document.currentScript</h3>

<p>
Modify the definition of <a href="https://html.spec.whatwg.org/multipage/dom.html#dom-document-currentscript"><code>document.currentScript</code></a>
as follows:
</p>
<section class="monkeypatch">
The <dfn id="dom-document-currentscript" data-lt="document.currentScript"><code>currentScript</code></dfn> attribute, on getting,
MUST return the value to which it was most recently initialized in the document or the <a>import map</a> of the document.
When the Document is created, the <code>currentScript</code> MUST be initialized to null.
If the Document is an <a>imported document</a>, its <code>currentScript</code> is always null.
</section>

</section>
</section>

<section id="style-imports">
<h2>Style processing with Imports</h2>

<p>The contents of the <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-style-element">style</a></code> elements and
the external resources of the <code><a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element">link</a></code> elements in <a data-lt="import">import</a> MUST be considered as input sources of the <a href="http://www.w3.org/TR/CSS21/intro.html#processing-model">style processing model</a> [[!CSS2]] of the <a>master document</a>.</p>

<section id="import-link-tree">
<h3>Import Link Tree</h3>

<p>A set of imports that are associated with a <a>master document</a> forms an <dfn id="dfn-import-link-tree">import link tree</dfn>, a <a data-lt="master document">tree</a> structure. Following <dfn id="dfn-import-link-tree-forming">import link tree forming</dfn> algorithm, being applied with <code>null</code> as <var>PARENT</var>, <a>master document</a> as <var>TREE</var> and all of its imports as <var>POOL</var>, defines the <a>import link tree</a>:</p>

<section class="algorithm">
<dl>
<dt>Input</dt>
<dd><var>PARENT</var>, a document tree node</dd>
<dd><var>CURRENT</var>, a document</dd>
<dd><var>POOL</var>, a list of document</dd>
<dt>Output</dt>
<dd><var>TREE</var>, a tree of document</dd>
</dl>

<ol>
  <li>Let <var>TREE</var> be a tree node.</li>
  <li>Let <var>TREE</var>'s value be <var>CURRENT</var>
  <li>Let <var>TREE</var>'s <a href="https://dom.spec.whatwg.org/#concept-tree-parent">parent</a> be <var>PARENT</var>.</li>
  <li>Make <var>TREE</var>'s <a href="https://dom.spec.whatwg.org/#concept-tree-child">child</a> list empty.</li>
  <li>For each <var>LINK</var>, a <code>link</code> element of an import in <var>CURRENT</var>, in document order:
  <ol>
    <li>Let <var>IMPORT</var> be the import of <var>LINK</var>.</li>
    <li>If <var>IMPORT</var> is not in <var>POOL</var>, try next.</li>
    <li>Remove <var>LINK</var> from <var>POOL</var>.</li>
    <li>Invoke the <a>import link tree forming</a> algorithm with <var>TREE</var> as <var>PARENT</var>, <var>IMPORT</var> as <var>CURRENT</var> and <var>POOL</var> as <var>POOL</var>, let the result be <var>CHILD</var>.
    <li>Append <var>CHILD</var> to <var>TREE</var>'s <a href="https://dom.spec.whatwg.org/#concept-tree-child">child</a> list.</li>
  </ol></li>
  <li><strong>stop</strong>.</li>
</ol>
</section>

<p class='note'>
The <a>import link tree</a> algorithm defines a order of imports using a depth first traversal. This <a>import link tree</a> is different from the one formed by <a>import link list</a>. The former is based on the document tree of each import. The later is built through <a href="#loading-imports">import loading process</a> and isn't affected by document tree mutation.
</p>

</section>

<section id="order-of-appearances">
<h3>Order of Appearances and Imports</h3>

<p>The <a href="https://www.w3.org/TR/css3-cascade/#cascade-order">order of appearances</a> of declarations [[!CSS-CASCADE-3]] which come from different documents are determined by the <a>import link tree</a>. If <a href="https://dom.spec.whatwg.org/#concept-node-document">node documents</a> of two declarations differ, compare the <a href="https://dom.spec.whatwg.org/#concept-tree-order">tree order</a> of these documents in the <a>import link tree</a>. The last one wins.</p>

</section>
</section>

<section id="events-imports">
<h2>Events in Imports</h2>

<p>Events in <a data-lt="import">import</a> is defined as a set of changes to the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#events">HTML Events</a>.</p>

<section id="additions-to-event-handlers">
<h3>Additions to Event Handlers</h3>

<p>
Modify the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-content-attributes">event handler content attribute</a>'s
script creation criteria by expanding the first paragraph:

<div class="monkeypatch">
<p>When an event handler content attribute is set, if the element is owned by a <a href="https://html.spec.whatwg.org/multipage/dom.html#document">Document</a> that is in a <a href="https://html.spec.whatwg.org/multipage/browsers.html#browsing-context">browsing context</a> or
in an <a>import map</a>, &hellip;</p>
</div>

</section>
</section>

<section id="custom-elements">
<h2>Custom Element Processing</h2>

<p>This specification redefines <dfn id="dfn-custom-element-order">custom element order</dfn> to be the sum of [[!CUSTOM-ELEMENTS]]'s <a href="https://w3c.github.io/webcomponents/spec/custom/index.html#dfn-custom-element-order">custom element order</a> and <a>import tree order</a>, in which the <a>import tree order</a> is scaled so that its lowest value is always larger than the highest possible value of [[!CUSTOM-ELEMENTS]]'s <a href="https://w3c.github.io/webcomponents/spec/custom/index.html#dfn-custom-element-order">custom element order</a>.</p>

<p>The <dfn id="dfn-import-tree-order">import tree order</dfn> of a given <a href="https://w3c.github.io/webcomponents/spec/custom/index.html#dfn-custom-element">custom element</a> of an <a href="#dfn-import-link-tree">import link tree</a> is determined by <a href="https://dom.spec.whatwg.org/#concept-tree-order">tree order</a> in an <a href="#dfn-import-link-tree">import link tree</a> that was flattened by replacing every <a href="#dfn-import">import</a> <a href="https://html.spec.whatwg.org/multipage/semantics.html#the-link-element"><code>link</code></a> with the content of its <a href="#dfn-imported-document">imported document</a>.</p>

<p>The <dfn id="dfn-highest-stable-order">highest stable order</dfn> is the value that is immediately preceding the <a href="https://w3c.github.io/webcomponents/spec/custom/index.html#dfn-custom-element-order">custom element order</a> of an <a data-lt="custom element">element</a> in the first encountered <a href="#dfn-import">import</a>, in <a href="https://dom.spec.whatwg.org/#concept-tree-order">tree order</a>, that has not yet <a href="https://html.spec.whatwg.org/multipage/syntax.html#completely-loaded">completely loaded</a>. If there is no such <a href="https://w3c.github.io/webcomponents/spec/custom/index.html#dfn-custom-element">element</a>, the <a>highest stable order</a> is the highest custom element order in the flattened <a href="#dfn-import-link-tree">import link tree</a>. When processing the base element queue, user agents should only invoke callbacks up to the <a>highest stable order</a>, inclusively.</p>


<div class="note">
<p>Because imports load asynchronously, we need to divide a sorted element queue into the part where things have settled down (all imports have loaded), and the part where the loading is still happening, and thus the actual sorting order is not yet determined. For example, suppose you have the following document structure:</p>

<div id='document-structure'>
<p>index.html:</p>
<pre class='highlight'>
&lt;link rel="import" href="import.html">
...
&lt;me-second>&lt;/me-second>
...
</pre>

<p>import.html:</p>
<pre class='highlight'>&lt;me-first>&lt;/me-first></pre>
</div>

<p>The order of custom elements in the flattened import link tree is <code>me-first</code> (1), <code>me-second</code> (2). However, it's very likely that the parser will find out about <code>me-second</code> sooner than <code>me-first</code>, since the latter requires loading the <code>import.html</code>. While the network stack is doing its job, the highest stable order stays at the beginning position. When <code>import.html</code> is ready, the order jumps all the way to <code>me-second</code> (2).</p>

</div>

</section>

<section class="appendix">
<h2>Acknowledgments</h2>

<p><span class="vcard">David Hyatt</span> developed <a href="http://dev.w3.org/2006/xbl2/">XBL 1.0</a>, and <span class="vcard">Ian Hickson</span> co-wrote <a href="http://dev.w3.org/2006/xbl2/">XBL 2.0</a>. These documents provided tremendous insight into the problem of behavior attachment and greatly influenced this specification.</p>

<p><span class="vcard">Alex Russell</span> and his considerable forethought triggered a new wave of enthusiasm around the subject of behavior attachment and how it can be applied practically on the Web.</p>

<p><span class="vcard">Dominic Cooney</span> and <span class="vcard">Roland Steiner</span> worked tirelessly to scope the problem within the confines of the Web platform and provided a solid foundation for this document.</p>

<p>The editor would also like to thank <span class="vcard">Alex Komoroske</span>, <span class="vcard">Angelina Fabbro</span>, <span class="vcard">Anne van Kesteren</span>, <span class="vcard">Boris Zbarsky</span>, <span class="vcard">Brian Kardell</span>, <span class="vcard">Daniel Buchner</span>, <span class="vcard">Edward O'Connor</span>, <span class="vcard">Eric Bidelman</span>, <span class="vcard">Erik Arvidsson</span>, <span class="vcard">Elliott Sprehn</span>, <span class="vcard">Gabor Krizsanits</span>, <span class="vcard">Hayato Ito</span>, <span class="vcard">James Simonsen</span>, <span class="vcard">Jonas Sicking</span>, <span class="vcard">Ken Shirriff</span>, <span class="vcard">Neel Goyal</span>, <span class="vcard">Olli Pettay</span>, <span class="vcard">Rafael Weinstein</span>, <span class="vcard">Scott Miles</span>, <span class="vcard">Steve Orvell</span>, <span class="vcard">Tab Atkins</span>, <span class="vcard">William Chan</span>, and <span class="vcard">William Chen</span> for their comments and contributions to this specification.</p>

<p>This list is too short. There's a lot of work left to do. Please contribute by reviewing and filing bugs&mdash;and don't forget to ask the editor to add your name into this section.</p>

</section>
</body>
</html>